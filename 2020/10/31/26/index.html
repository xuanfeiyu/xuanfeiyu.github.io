<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="JavaScipt," />










<meta name="description" content="作者：FY引用请标明出处  Part 1 · 模块一 JavaScript 深度剖析任务一：函数式编程范式1.课程介绍 为什么要学习函数编程以及什么是函数式编程 函数式编程的特性（纯函数、柯里化、函数组合） 函数式编程的应用场景 函数式编程库 Lodash">
<meta property="og:type" content="article">
<meta property="og:title" content="学习笔记 ----- 【JavaScript 深度剖析】函数式编程与 JS 异步编程、手写 Promise">
<meta property="og:url" content="http://yoursite.com/2020/10/31/26/index.html">
<meta property="og:site_name" content="旋の飞羽">
<meta property="og:description" content="作者：FY引用请标明出处  Part 1 · 模块一 JavaScript 深度剖析任务一：函数式编程范式1.课程介绍 为什么要学习函数编程以及什么是函数式编程 函数式编程的特性（纯函数、柯里化、函数组合） 函数式编程的应用场景 函数式编程库 Lodash">
<meta property="og:image" content="http://yoursite.com/2020/10/31/images/26/26-0.png">
<meta property="og:image" content="http://yoursite.com/2020/10/31/images/26/26-1.png">
<meta property="og:image" content="http://yoursite.com/2020/10/31/images/26/26-2.png">
<meta property="article:published_time" content="2020-10-30T16:00:00.000Z">
<meta property="article:modified_time" content="2020-11-22T10:44:39.024Z">
<meta property="article:author" content="FY">
<meta property="article:tag" content="JavaScipt">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/2020/10/31/images/26/26-0.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/10/31/26/"/>





  <title>学习笔记 ----- 【JavaScript 深度剖析】函数式编程与 JS 异步编程、手写 Promise | 旋の飞羽</title>
  








<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">旋の飞羽</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">人间值得，未来可期。</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/31/26/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="FY">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="旋の飞羽">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">学习笔记 ----- 【JavaScript 深度剖析】函数式编程与 JS 异步编程、手写 Promise</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-10-31T00:00:00+08:00">
                2020-10-31
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index">
                    <span itemprop="name">前端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>作者：FY<br>引用请标明出处</p>
</blockquote>
<h1 id="Part-1-·-模块一-JavaScript-深度剖析"><a href="#Part-1-·-模块一-JavaScript-深度剖析" class="headerlink" title="Part 1 · 模块一 JavaScript 深度剖析"></a>Part 1 · 模块一 JavaScript 深度剖析</h1><h2 id="任务一：函数式编程范式"><a href="#任务一：函数式编程范式" class="headerlink" title="任务一：函数式编程范式"></a>任务一：函数式编程范式</h2><h3 id="1-课程介绍"><a href="#1-课程介绍" class="headerlink" title="1.课程介绍"></a>1.课程介绍</h3><ul>
<li>为什么要学习函数编程以及什么是函数式编程</li>
<li>函数式编程的特性（纯函数、柯里化、函数组合）</li>
<li>函数式编程的应用场景</li>
<li>函数式编程库 Lodash</li>
</ul>
<a id="more"></a>

<h3 id="2-为什么要学习函数编程以及什么是函数式编程"><a href="#2-为什么要学习函数编程以及什么是函数式编程" class="headerlink" title="2.为什么要学习函数编程以及什么是函数式编程"></a>2.为什么要学习函数编程以及什么是函数式编程</h3><ul>
<li>函数式编程是随着 React 的流行受到越来越多的关注</li>
<li>Vue3 也开始拥抱函数式编程</li>
<li>函数式编程可以抛弃 this</li>
<li>打包过程中可以更好的利用 tree shaking 过滤无用代码</li>
<li>方便测试 方便并行处理</li>
<li>有很多库可以帮助我们进行函数式开发： lodash、underscpre、ramda</li>
</ul>
<h3 id="3-函数式编程概念"><a href="#3-函数式编程概念" class="headerlink" title="3.函数式编程概念"></a>3.函数式编程概念</h3><p>函数式编程(Functional Programming，FP)，FP 是编程范式之一，我们常听说的编程范式还有面向过程编程、面向对象编程。</p>
<ul>
<li>面向对象编程的思维方式：把现实世界中的事物抽象成程序世界中的类和对象，通过封装、继承和多态来演示事物事件的联系</li>
<li>函数式编程的思维方式：把现实世界的事物和事物之间的<strong>联系</strong>抽象到程序世界（对运算过程进行抽象）<ul>
<li>程序的本质：根据输入通过某种运算获得相应的输出，程序开发过程中会设计很多有输入和输出的函数</li>
<li>x-&gt;f(联系、映射)-&gt;y, y=f(x)</li>
<li><strong>函数式编程中的函数指的不是程序中的函数(方法)</strong>，而是数学中的函数即映射关系，例如：y=sin(x), x和y的关系</li>
<li><strong>相同的输入始终要得到相同的输出</strong>(纯函数)</li>
<li>函数式编程用来描述数据(函数)之间的映射</li>
</ul>
</li>
</ul>
<h3 id="4-函数是一等公民"><a href="#4-函数是一等公民" class="headerlink" title="4.函数是一等公民"></a>4.函数是一等公民</h3><ul>
<li>函数可以存储在变量中</li>
<li>函数作为参数</li>
<li>函数作为返回值</li>
</ul>
<p>在 JavaScipt 中<strong>函数就是一个普通的对象</strong>(可以通过 new Function())，我们可以把函数存储到变量/数组中，它还可以作为另一个函数的参数和返回值，甚至我们可以在程序运行的时候通过 new Function(‘alert(1)’) 来构造一个新的函数</p>
<h3 id="5-高阶函数-函数作为参数"><a href="#5-高阶函数-函数作为参数" class="headerlink" title="5.高阶函数-函数作为参数"></a>5.高阶函数-函数作为参数</h3><p>什么是高阶函数</p>
<ul>
<li>高阶函数<ul>
<li>可以把函数作为参数传递给另一个函数</li>
<li>可以把函数作为另一个函数的返回结果</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">forEach</span>(<span class="params">array, fn</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; array.length; i++) &#123;</span><br><span class="line">        fn(array[i])</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> arr = [<span class="number">1</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">7</span>, <span class="number">8</span>]</span><br><span class="line">forEach(arr, <span class="function"><span class="keyword">function</span>(<span class="params">item</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(item)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="6-高阶函数-函数作为返回值"><a href="#6-高阶函数-函数作为返回值" class="headerlink" title="6.高阶函数-函数作为返回值"></a>6.高阶函数-函数作为返回值</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeFn</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> msg = <span class="string">'Hello function'</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(msg)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> fn = makeFn()</span><br><span class="line">fn()</span><br></pre></td></tr></table></figure>

<h3 id="7-高阶函数的意义"><a href="#7-高阶函数的意义" class="headerlink" title="7.高阶函数的意义"></a>7.高阶函数的意义</h3><ul>
<li>抽象可以帮我们屏蔽细节，只需要关注我们的目标</li>
<li>高阶函数是用来抽象通用的问题</li>
</ul>
<h3 id="8-常用的高阶函数"><a href="#8-常用的高阶函数" class="headerlink" title="8.常用的高阶函数"></a>8.常用的高阶函数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模拟常用的高阶函数： map、every、some</span></span><br><span class="line"><span class="keyword">const</span> map = <span class="function">(<span class="params">array, fn</span>) =&gt;</span> &#123;</span><br><span class="line">   <span class="keyword">let</span> results = []</span><br><span class="line">   <span class="keyword">for</span>(<span class="keyword">let</span> value <span class="keyword">of</span> array) &#123;</span><br><span class="line">       results.push(fn(value))</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> results</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> every = <span class="function">(<span class="params">array, fn</span>) =&gt;</span> &#123;</span><br><span class="line">   <span class="keyword">let</span> result = <span class="literal">true</span></span><br><span class="line">   <span class="keyword">for</span>(<span class="keyword">let</span> value <span class="keyword">of</span> array) &#123;</span><br><span class="line">       result = fn(value)</span><br><span class="line">       <span class="keyword">if</span>(!result) &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> some = <span class="function">(<span class="params">array, fn</span>) =&gt;</span> &#123;</span><br><span class="line">   <span class="keyword">let</span> result = <span class="literal">false</span></span><br><span class="line">   <span class="keyword">for</span>(<span class="keyword">let</span> value <span class="keyword">of</span> array) &#123;</span><br><span class="line">       result = fn(value)</span><br><span class="line">       <span class="keyword">if</span>(result) &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="9-闭包-概念"><a href="#9-闭包-概念" class="headerlink" title="9.闭包-概念"></a>9.闭包-概念</h3><ul>
<li>闭包(Closure)：函数和其周围的状态(词法环境)的引用捆绑在一起形成闭包<ul>
<li>可以在另一个作用域中调用一个函数的内部函数并访问到该函数的作用域的成员</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">once</span>(<span class="params">fn</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> done = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">if</span>(!done) &#123;</span><br><span class="line">        done = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">return</span> fn.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> pay = once(<span class="function"><span class="keyword">function</span>(<span class="params">money</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`支付： <span class="subst">$&#123;money&#125;</span> RMB`</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 只会支付一次</span></span><br><span class="line">pay(<span class="number">5</span>)</span><br><span class="line">pay(<span class="number">5</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>闭包的本质：函数在执行的时候会放到一个执行栈上，当函数执行完毕之后会从执行栈上移除，<strong>但是堆上的作用域成员因为被外部引用不能释放</strong>，因此内部函数依然可以访问外部函数的成员</li>
</ul>
<h3 id="10-闭包-案例"><a href="#10-闭包-案例" class="headerlink" title="10.闭包-案例"></a>10.闭包-案例</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Matn.pow(4, 2)</span></span><br><span class="line"><span class="comment">// Matn.pow(5, 2)</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makePower</span>(<span class="params">power</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">number</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Math</span>.power(number, power)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 求平方</span></span><br><span class="line"><span class="keyword">let</span> power2 = makePower(<span class="number">2</span>)</span><br><span class="line"><span class="keyword">let</span> power3 = makePower(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>

<h3 id="11-纯函数概念"><a href="#11-纯函数概念" class="headerlink" title="11.纯函数概念"></a>11.纯函数概念</h3><ul>
<li>纯函数：<strong>相同的输入永远会得到相同的输出</strong>，而且没有任何可观察的副作用<ul>
<li>纯函数就类似数学中的函数(用来描述输入和输出之前的关系)，y=f(x)</li>
<li>lodash 是一个纯函数的功能库，提供了对数组、数字、对象、字符串、函数等操作的一些方法</li>
<li>数组的 slice 和 splice 分别是：纯函数和不纯的函数<ul>
<li>slice 返回数组中的指定部分，不会改变原数组</li>
<li>splice 对数组进行操作返回该数组，会改变原数组</li>
</ul>
</li>
<li>函数式编程不会保留计算中间的结果，所以变量是不可变的(无状态的)</li>
<li>我们可以把一个函数的执行结果交给另一个函数去处理</li>
</ul>
</li>
</ul>
<h3 id="12-Lodash"><a href="#12-Lodash" class="headerlink" title="12.Lodash"></a>12.Lodash</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 演示 lodash</span></span><br><span class="line"><span class="comment">// fisrt / last / toUpper / reverse / each / includes / find / findIndex</span></span><br><span class="line"><span class="keyword">const</span> _ = <span class="built_in">require</span>(<span class="string">'lodash'</span>)</span><br><span class="line"><span class="keyword">const</span> array = [<span class="string">'jack'</span>, <span class="string">'tom'</span>, <span class="string">'luck'</span>, <span class="string">'kate'</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(_.first(array))</span><br><span class="line"><span class="built_in">console</span>.log(_.last(array))</span><br><span class="line"><span class="built_in">console</span>.log(_.toUpper(_.first(array)))</span><br><span class="line"><span class="built_in">console</span>.log(_.reverse(array))</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> r = _.each(array,(item, index) =&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(item, index)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">console</span>.log(r)</span><br></pre></td></tr></table></figure>

<h3 id="13-纯函数的好处"><a href="#13-纯函数的好处" class="headerlink" title="13.纯函数的好处"></a>13.纯函数的好处</h3><ul>
<li>可缓存<ul>
<li>因为纯函数对相同的输入始终有相同的结果，所以可以把纯函数的结果缓存起来</li>
</ul>
</li>
<li>可测试<ul>
<li>纯函数让测试更方便</li>
</ul>
</li>
<li>并行处理<ul>
<li>在多线程环境下并行操作共享的内容数据很可能会出现意外情况</li>
<li>纯函数不需要访问共享的内存数据，所以在并行环境下可以任意运行纯函数(Web Worker)</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> _ = <span class="built_in">require</span>(<span class="string">'lodash'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getArea</span>(<span class="params">r</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(r)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Math</span>.PI * r * r</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// let getAreaWidthMemory = _memoize(getArea)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// console.log(getAreaWidthMemory(4))</span></span><br><span class="line"><span class="comment">// console.log(getAreaWidthMemory(4))</span></span><br><span class="line"><span class="comment">// console.log(getAreaWidthMemory(4))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 模拟 memoize 方法的实现</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">memoize</span>(<span class="params">f</span>)</span>&#123;</span><br><span class="line">   <span class="keyword">let</span> cache = &#123;&#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">      <span class="keyword">let</span> key = Json.stringify(<span class="built_in">arguments</span>)</span><br><span class="line">      cache[key] = cache[key] || f.apply(f,<span class="built_in">arguments</span>)</span><br><span class="line">      <span class="keyword">return</span> cache[key]</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="14-副作用"><a href="#14-副作用" class="headerlink" title="14.副作用"></a>14.副作用</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不纯的</span></span><br><span class="line"><span class="keyword">let</span> mini = <span class="number">18</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkAge</span>(<span class="params">age</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> age &gt;= mini</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 纯的(有硬编码、后续可以通过柯里化解决)</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkAge</span>(<span class="params">age</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> mini = <span class="number">18</span></span><br><span class="line">    <span class="keyword">return</span> age &gt;= mini</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>副作用让一个函数变的不纯(如上例)，纯函数根据相同的输入返回相同的输出，如果函数依赖于外部的状态就无法保证输出相同，就会带来副作用</p>
<p>副作用来源：</p>
<ul>
<li>配置文件</li>
<li>数据库</li>
<li>获取用户的输入</li>
<li>…</li>
</ul>
<p>所有的外部交互都有可能产生副作用，副作用也使得方法通用性下降，不适合扩展和可重用性，同时副作用会给程序中带来安全隐患和不确定性，但是副作用不可能完全禁止，进可能控制它们在可控范围内发生。</p>
<h3 id="15-柯里化"><a href="#15-柯里化" class="headerlink" title="15.柯里化"></a>15.柯里化</h3><p>柯里化(Curring):</p>
<ul>
<li><p>当一个函数有多个参数的时候先传递一部分参数调用它(这部分参数以后永远不变)</p>
</li>
<li><p>然后返回一个新的函数接收剩余的参数，返回结果</p>
</li>
<li><p>使用柯里化解决上一个案例中的硬编码问题</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkAge</span>(<span class="params">age</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> mini = <span class="number">18</span></span><br><span class="line">    <span class="keyword">return</span> age &gt;= mini</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 普通纯函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkAge</span>(<span class="params">min, age</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> age &gt;= min</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">checkAge(<span class="number">18</span>, <span class="number">24</span>)</span><br><span class="line">checkAge(<span class="number">18</span>, <span class="number">20</span>)</span><br><span class="line">checkAge(<span class="number">20</span>, <span class="number">30</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 柯里化</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkAge</span>(<span class="params">min</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">age</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age &gt;= min</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ES6 写法</span></span><br><span class="line"><span class="keyword">let</span> checkAge = <span class="function"><span class="params">min</span> =&gt;</span> (<span class="function"><span class="params">age</span> =&gt;</span> age &gt;= min)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> checkAge18 = checkAge(<span class="number">18</span>)</span><br><span class="line"><span class="keyword">let</span> checkAge20 = checkAge(<span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">checkAge18(<span class="number">24</span>)</span><br><span class="line">checkAge18(<span class="number">20</span>)</span><br></pre></td></tr></table></figure>

<h3 id="16-Lodash-中的柯里化方法"><a href="#16-Lodash-中的柯里化方法" class="headerlink" title="16.Lodash 中的柯里化方法"></a>16.Lodash 中的柯里化方法</h3><ul>
<li>_curry(func)<ul>
<li>功能：创建一个函数，该函数接收一个或多个 func 的参数，如果 func 所需要的参数都被提供则执行 func 并返回执行的结果。否则继续返回该函数并等待接收剩余的参数。</li>
<li>参数：需要柯里化的参数</li>
<li>返回值：柯里化后的函数</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> _ = <span class="built_in">require</span>(<span class="string">'lodash'</span>)</span><br><span class="line"><span class="comment">// 要柯里化的函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getSum</span>(<span class="params">a, b, c</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b + c</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> curried = _.curry(getSum)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(curried(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>))</span><br><span class="line"><span class="built_in">console</span>.log(curried(<span class="number">1</span>)(<span class="number">2</span>, <span class="number">3</span>))</span><br><span class="line"><span class="built_in">console</span>.log(curried(<span class="number">1</span>, <span class="number">2</span>)(<span class="number">3</span>))</span><br></pre></td></tr></table></figure>

<h3 id="17-柯里化案例"><a href="#17-柯里化案例" class="headerlink" title="17.柯里化案例"></a>17.柯里化案例</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ''.match(/\s+/g)</span></span><br><span class="line"><span class="comment">// ''.match(/\d+/g)</span></span><br><span class="line"><span class="keyword">const</span> _ = <span class="built_in">require</span>(<span class="string">'lodash'</span>)</span><br><span class="line"><span class="keyword">const</span> match = _.curry(<span class="function"><span class="keyword">function</span>(<span class="params">reg, str</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> str.match(reg)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> haveSpace = match(<span class="string">'/\s+/g)</span></span><br><span class="line"><span class="string">const haveNumber = match('</span>/\d+<span class="regexp">/g)</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">console.log(haveSpace('helloworld'))</span></span><br><span class="line"><span class="regexp">console.log(haveNumber('abc'))</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const filter = _.curry(function(func, array)&#123;</span></span><br><span class="line"><span class="regexp">    return array.filter(func)</span></span><br><span class="line"><span class="regexp">&#125;)</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">console.log(filter(haveSpace, ['John Connor', 'John_Done']))</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const findSpace = filter(haveSpace)</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">console.log(findSpace(['John Connor', 'John_Done']))</span></span><br></pre></td></tr></table></figure>

<h3 id="18-柯里化原理模拟"><a href="#18-柯里化原理模拟" class="headerlink" title="18.柯里化原理模拟"></a>18.柯里化原理模拟</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">curry</span>(<span class="params">func</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">curriedFn</span>(<span class="params">...args</span>)</span>&#123;</span><br><span class="line">        <span class="comment">// 判断实参和形参的个数</span></span><br><span class="line">        <span class="keyword">if</span>(args.length &lt; func.length)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="keyword">return</span> curriedFn(...args.concat(<span class="built_in">Array</span>.from(<span class="built_in">arguments</span>)))</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> func(...args)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="19-柯里化总结"><a href="#19-柯里化总结" class="headerlink" title="19.柯里化总结"></a>19.柯里化总结</h3><ul>
<li>柯里化可以让我们给一个函数传递较少的参数得到一个已经记住了某些固定参数的新函数</li>
<li>这是一种对函数参数的’缓存’</li>
<li>让函数变的更灵活， 让函数的粒度更小</li>
<li>可以把多元函数转换成一元函数，可以组合使用函数产生强大的功能</li>
</ul>
<h3 id="20-函数组合概念"><a href="#20-函数组合概念" class="headerlink" title="20.函数组合概念"></a>20.函数组合概念</h3><ul>
<li>纯函数和柯里化很容易写出洋葱代码 h(g(f(x)))<ul>
<li>获取数组的最后一个元素再转换成大写字母，<em>.toUpper(</em>.first(_reverse(array)))</li>
<li>函数组合可以让我们把细粒度的函数重新组合生成一个新的函数</li>
</ul>
</li>
</ul>
<blockquote>
<p>管道</p>
</blockquote>
<p>下面这张图表示程序中使用函数处理数据的过程，给 fn 函数输入参数 a，返回结果 b。可以想象 a 数据通过一个管道得到了 b 数据。</p>
<p><img src="../images/26/26-0.png" alt="图片"></p>
<p>当 fn 函数比较复杂的时候，我们可以把函数 fn 拆分成多个小函数，此时多了中间运算过程产生的 m 和 n。<br>下面这张图中可以想象成把 fn 这个管道拆分成了3个管道 f1,f2,f3,数据 a 通过管道 f3 得到结果 m，m 再通过管道 f2 得到结果 n，n 通过管道 f1 得到最终结果 b。</p>
<p><img src="../images/26/26-1.png" alt="图片"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fn = compose(f1, f2, f3)</span><br><span class="line">b = fn(a)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>函数组合</p>
</blockquote>
<ul>
<li>函数组合(compose)：如果一个函数要经过多个函数处理才能得到最终值，这个时候可以把中间过程的函数合并成一个函数<ul>
<li>函数就像是数据的管道，函数组合就是把这些管道连接起来，让数据穿过多个管道形成最终结果</li>
<li><strong>函数组合默认是从右到左执行</strong></li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 函数组合演示</span></span><br><span class="line">fn = compose(f, g) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> f(g(value))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reverse</span>(<span class="params">array</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> array.reverse()</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">first</span>(<span class="params">array</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> array[<span class="number">0</span>]</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> last = compose(first, reverse)</span><br><span class="line"><span class="built_in">console</span>.log(last([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]))</span><br></pre></td></tr></table></figure>

<h3 id="21-Lodash中的组合函数"><a href="#21-Lodash中的组合函数" class="headerlink" title="21.Lodash中的组合函数"></a>21.Lodash中的组合函数</h3><ul>
<li>lodash 中的组合函数<ul>
<li>lodash 中组合函数 flow() 或者 flowRight(),他们都可以组合多个函数</li>
<li>flow() 是从左到右运行</li>
<li>flowRight() 是从右到左运行，使用的更多一些</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lodash 中的函数组合方法 _flowRight()</span></span><br><span class="line"><span class="keyword">const</span> reverse = <span class="function"><span class="params">arr</span> =&gt;</span> arr.reverse()</span><br><span class="line"><span class="keyword">const</span> first = <span class="function"><span class="params">arr</span> =&gt;</span> arr[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">const</span> toUpper = <span class="function"><span class="params">s</span> =&gt;</span> s.toUpperCase()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> f = _flowRight(toUpper,first,reverse)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(f([<span class="string">'one'</span>, <span class="string">'two'</span>, <span class="string">'three'</span>]))</span><br></pre></td></tr></table></figure>

<h3 id="22-组合函数原理模拟"><a href="#22-组合函数原理模拟" class="headerlink" title="22.组合函数原理模拟"></a>22.组合函数原理模拟</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lodash 中的函数组合方法 _flowRight()</span></span><br><span class="line"><span class="keyword">const</span> reverse = <span class="function"><span class="params">arr</span> =&gt;</span> arr.reverse()</span><br><span class="line"><span class="keyword">const</span> first = <span class="function"><span class="params">arr</span> =&gt;</span> arr[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">const</span> toUpper = <span class="function"><span class="params">s</span> =&gt;</span> s.toUpperCase()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> f = _flowRight(toUpper,first,reverse)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(f([<span class="string">'one'</span>, <span class="string">'two'</span>, <span class="string">'three'</span>]))</span><br><span class="line"></span><br><span class="line"><span class="comment">// function compose(...args) &#123;</span></span><br><span class="line"><span class="comment">//     return function(value)&#123;</span></span><br><span class="line"><span class="comment">//         return args.reverse().reduce(function(acc, fn)&#123;</span></span><br><span class="line"><span class="comment">//             return fn(acc)</span></span><br><span class="line"><span class="comment">//         &#125;,value)</span></span><br><span class="line"><span class="comment">//     &#125;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> compose = <span class="function">(<span class="params">...args</span>) =&gt;</span> <span class="function"><span class="params">value</span> =&gt;</span> args.reverse().reduce(<span class="function">(<span class="params">acc, fn</span>) =&gt;</span> fn(acc),value)</span><br></pre></td></tr></table></figure>

<h3 id="23-函数组合-结合律"><a href="#23-函数组合-结合律" class="headerlink" title="23.函数组合-结合律"></a>23.函数组合-结合律</h3><ul>
<li>函数组合要满足结合律(associativity)：<ul>
<li>我们既可以把 g 和 h 组合，还可以把 f 和 g 组合，结果都是一样的</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 结合律(associativity)</span></span><br><span class="line"><span class="keyword">let</span> f = compose(f, g, h)</span><br><span class="line"><span class="keyword">let</span> associativite = compose(compose(f, g),h) == compose(f, compose(g, h))</span><br></pre></td></tr></table></figure>

<h3 id="24-函数组合-调试"><a href="#24-函数组合-调试" class="headerlink" title="24.函数组合-调试"></a>24.函数组合-调试</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NEVER SAY DIE --&gt; never-say-die</span></span><br><span class="line"><span class="keyword">const</span> _ = <span class="built_in">require</span>(<span class="string">'lodash'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// const log = v =&gt; &#123;</span></span><br><span class="line"><span class="comment">//     console.log(v)</span></span><br><span class="line"><span class="comment">//     return v</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> trace = _.curry(<span class="function">(<span class="params">tag, v</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(tag,v)</span><br><span class="line">    <span class="keyword">return</span> v</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> split = _.curry(<span class="function">(<span class="params">sep, str</span>) =&gt;</span> _.split(str, sep))</span><br><span class="line"><span class="keyword">const</span> join = _.curry(<span class="function">(<span class="params">sep, str</span>) =&gt;</span> _.join(array, sep))</span><br><span class="line"><span class="keyword">const</span> map = _.curry(<span class="function">(<span class="params">fn, array</span>) =&gt;</span> _.map(array, fn))</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> f = _.flowRight(join(<span class="string">'-'</span>), map(_.toLower), split(<span class="string">' '</span>))</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(f(<span class="string">'NEVER SAY DIE'</span>))</span><br></pre></td></tr></table></figure>

<h3 id="25-Lodash-fp-模块"><a href="#25-Lodash-fp-模块" class="headerlink" title="25.Lodash-fp 模块"></a>25.Lodash-fp 模块</h3><ul>
<li>lodash/fp<ul>
<li>lodash 的 fp 模块提供了使用的对<strong>函数式编程友好</strong>的方法</li>
<li>提供了不可变 auto-curried iteratee-first data-last 的方法</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lodash 模块</span></span><br><span class="line"><span class="keyword">const</span> _ = <span class="built_in">require</span>(<span class="string">'lodash'</span>)</span><br><span class="line"></span><br><span class="line">_.map([<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>],_.toUpper)</span><br><span class="line"><span class="comment">// =&gt; ['A', 'B', 'C']</span></span><br><span class="line">_.map([<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>])</span><br><span class="line"><span class="comment">// =&gt; ['a', 'b', 'c']</span></span><br><span class="line"></span><br><span class="line">_.split(<span class="string">'Hello World'</span>, <span class="string">' '</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// lodash/fp 模块</span></span><br><span class="line"><span class="keyword">const</span> fp = <span class="built_in">require</span>(<span class="string">'lodash/fp'</span>)</span><br><span class="line"></span><br><span class="line">fp.map(fp.toUpper,[<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>])</span><br><span class="line">fp.map(fp.toUpper)([<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>])</span><br><span class="line"></span><br><span class="line">fp.split(<span class="string">' '</span>, <span class="string">'Hello World'</span>)</span><br><span class="line">fp.split(<span class="string">' '</span>)(<span class="string">'Hello World'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> f = fp.flowRight(fp.join(<span class="string">'-'</span>), fp.map(fp.toLower), fp.split(<span class="string">' '</span>))</span><br><span class="line"><span class="built_in">console</span>.log(f(<span class="string">'NEVER SAY DIE'</span>))</span><br></pre></td></tr></table></figure>

<h3 id="26-Lodash-map-方法的小问题"><a href="#26-Lodash-map-方法的小问题" class="headerlink" title="26.Lodash-map 方法的小问题"></a>26.Lodash-map 方法的小问题</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// const fp = require('lodash')</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// console.log(_.map(['23', '8', '10'], parseInt))</span></span><br><span class="line"><span class="comment">// // =&gt; [23, NAN, 2]</span></span><br><span class="line"><span class="comment">// parseInt('23', 0, array)</span></span><br><span class="line"><span class="comment">// parseInt('8', 1, array)</span></span><br><span class="line"><span class="comment">// parseInt('10', 2, array)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fp = <span class="built_in">require</span>(<span class="string">'lodash/fp'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(fp.map(<span class="built_in">parseInt</span>, [<span class="string">'23'</span>, <span class="string">'8'</span>, <span class="string">'10'</span>]))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 总结：_.map 传递给 parseInt 参数有三个  fp.map 只有一个</span></span><br></pre></td></tr></table></figure>

<h3 id="27-Pointfree"><a href="#27-Pointfree" class="headerlink" title="27.Pointfree"></a>27.Pointfree</h3><p><strong>Pointfree</strong>：我们可以把数据处理的过程定义成与数据无关的合成运算，不需要用到代表数据的那个参数，只要把简单的运算步骤合成到一起，在使用这种模式之前我们需要定义一些辅助的基本运算函数</p>
<ul>
<li>不需要指明处理的数据</li>
<li><strong>只需要合成运算过程</strong></li>
<li>需要定义一些辅助的基本运算函数</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> f = fp.flowRight(fp.join(<span class="string">'-'</span>), fp.map(fp.toLower), fp.split(<span class="string">' '</span>))</span><br></pre></td></tr></table></figure>

<ul>
<li>案例演示</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 非 Point Free 模式</span></span><br><span class="line"><span class="comment">// Hello World =&gt; hello_world</span></span><br><span class="line">funciton f(word) &#123;</span><br><span class="line">    <span class="keyword">return</span> word.toLowerCase().replace(<span class="regexp">/\s+/g</span>, <span class="string">'_'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Point Free</span></span><br><span class="line"><span class="keyword">const</span> fp = <span class="built_in">require</span>(<span class="string">'lodash/fp'</span>)</span><br><span class="line"><span class="keyword">const</span> f = fp.flowRigth(fp,replace(<span class="regexp">/\s+/g</span>, <span class="string">'_'</span>), fp.toLower)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(f(<span class="string">'Hello World'</span>))</span><br></pre></td></tr></table></figure>

<h3 id="28-Pointfree-案例"><a href="#28-Pointfree-案例" class="headerlink" title="28.Pointfree-案例"></a>28.Pointfree-案例</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 把一个字符串中的首字母提取并转换成大写，使用. 作为分隔符</span></span><br><span class="line"><span class="comment">// world wild web ==&gt; W. W. W</span></span><br><span class="line"><span class="keyword">const</span> fp = <span class="built_in">require</span>(<span class="string">'lodash/fp'</span>)</span><br><span class="line"><span class="comment">// const firstLetterToUpper = fp.flowRight(fp.join('. '), fp.map(fp.first), fp.map(fp.toUpper), fp.split(' '))</span></span><br><span class="line"><span class="keyword">const</span> firstLetterToUpper = fp.flowRight(fp.join(<span class="string">'. '</span>), fp.flowRight(fp.first,fp.toUpper), fp.split(<span class="string">' '</span>))</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(firstLetterToUpper(<span class="string">'world will web'</span>))</span><br></pre></td></tr></table></figure>

<h3 id="29-Functor"><a href="#29-Functor" class="headerlink" title="29.Functor"></a>29.Functor</h3><blockquote>
<p>为什么要学函子</p>
</blockquote>
<p>到目前为止已经学习了函数式编程的一些基础，但是我们还没有演示在函数式编程中如何把副作用控制在可控的范围内、异常处理、异常操作等。</p>
<blockquote>
<p>什么是Functor</p>
</blockquote>
<ul>
<li>容器：包含值和值的变形关系(这个变形关系就是函数)</li>
<li>函子：是一个特殊的容器，通过一个普通的对象来实现，该对象具有 map 方法，map 方法可以运行一个函数对值进行处理(变形关系)</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Container</span> </span>&#123;</span><br><span class="line">   <span class="keyword">static</span> <span class="keyword">of</span>(value) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Container(value)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">constructor</span> (value)&#123;</span><br><span class="line">       <span class="keyword">this</span>._value = value</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   map(fn)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Container(fn(<span class="keyword">this</span>._value))</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> r = Container.of(<span class="number">5</span>).map(<span class="function"><span class="params">x</span> =&gt;</span> x + <span class="number">2</span>).map(<span class="function"><span class="params">x</span> =&gt;</span> x * x)</span><br></pre></td></tr></table></figure>

<h3 id="30-Functor总结"><a href="#30-Functor总结" class="headerlink" title="30.Functor总结"></a>30.Functor总结</h3><ul>
<li>总结<ul>
<li>函数式编程的运算不直接操作值，而是由函子完成</li>
<li>函子就是实现了一个 map 契约的对象</li>
<li>我们可以把函子想象成一个盒子，这个盒子里封装了一个值</li>
<li>想要处理盒子中的值，我们需要给盒子的 map 方法传递一个处理值的函数(纯函数)，这个函数来对值进行处理</li>
<li>最终 map 方法返回一个包含新值的盒子(函子)</li>
</ul>
</li>
</ul>
<h3 id="31-MayBe函子"><a href="#31-MayBe函子" class="headerlink" title="31.MayBe函子"></a>31.MayBe函子</h3><ul>
<li>我们在编程的过程中可能会遇到很多错误，需要这些错误做相应的处理</li>
<li>MayBe 函子的作用就是可以对外部的空值情况做处理(控制副作用在允许的范围)</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MayBe</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">of</span>(value) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> MayBe(value)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">constructor</span> (value) &#123;</span><br><span class="line">       <span class="keyword">this</span>._value = value</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    map(fn)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.isNothing() ? MayBe.of(<span class="literal">null</span>) : MayBe.of(fn(<span class="keyword">this</span>._value))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    isNothing() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>._value === <span class="literal">null</span> || <span class="keyword">this</span>._value === <span class="literal">undefined</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> r = MayBe.of(<span class="string">'hello world'</span>)</span><br><span class="line">          .map(<span class="function"><span class="params">x</span> =&gt;</span> x.toUpperCase())</span><br><span class="line">          .map(<span class="function"><span class="params">x</span> =&gt;</span> <span class="literal">null</span>)</span><br><span class="line">          .map(<span class="function"><span class="params">x</span> =&gt;</span> x.split(<span class="string">' '</span>))</span><br></pre></td></tr></table></figure>

<h3 id="32-Either函子"><a href="#32-Either函子" class="headerlink" title="32.Either函子"></a>32.Either函子</h3><ul>
<li>Either 两者中的任何一个，类似于 if…else… 处理</li>
<li>异常会让函数变的不纯， Either 函子可以用来做异常处理</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Left</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">of</span>(value) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Left(value)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">constructor</span> (value) &#123;</span><br><span class="line">       <span class="keyword">this</span>._value = value</span><br><span class="line">    &#125;</span><br><span class="line">    map(fn) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Right</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">of</span>(value) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Right(value)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">constructor</span> (value) &#123;</span><br><span class="line">       <span class="keyword">this</span>._value = value</span><br><span class="line">    &#125;</span><br><span class="line">    map(fn) &#123;</span><br><span class="line">        <span class="keyword">return</span> Right.of(fn(_this.value))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parseJSON</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> Right.of(<span class="built_in">JSON</span>.parse(str))</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">       <span class="keyword">return</span> Left.of(&#123;<span class="attr">error</span>: e.message&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="33-IO函子"><a href="#33-IO函子" class="headerlink" title="33.IO函子"></a>33.IO函子</h3><ul>
<li>IO 函子中的 _value 是一个函数，这里是把函数作为值来处理</li>
<li>IO 函子可以把不纯的动作存储到 _value 中，延迟执行这个不纯的操作(惰性执行)，包装当前的操作</li>
<li>把不纯的操作交给调用者处理</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fp = <span class="built_in">require</span>(<span class="string">'lodash/fp'</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IO</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">of</span>(x)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> IO(functio()&#123;</span><br><span class="line">            <span class="keyword">return</span> x</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">constructor</span> (fn) &#123;</span><br><span class="line">        <span class="keyword">this</span>._value = fn</span><br><span class="line">    &#125;</span><br><span class="line">    map (fn) &#123;</span><br><span class="line">        <span class="comment">// 把当前的 value 和传入的 fn 组合成一个新的函数</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> IO(fp.flowRight(fn, <span class="keyword">this</span>._value))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> r = IO.of(process).map(<span class="function"><span class="params">p</span> =&gt;</span> p.execPath)</span><br><span class="line"><span class="built_in">console</span>.log(r._value)</span><br></pre></td></tr></table></figure>

<h3 id="34-Folktale"><a href="#34-Folktale" class="headerlink" title="34.Folktale"></a>34.Folktale</h3><blockquote>
<p>Task 异步执行</p>
</blockquote>
<ul>
<li>异步任务的实现过于复杂，我们使用 folktale 中的 Task 来演示</li>
<li>folktale 一个标准的函数式编程库<ul>
<li>和lodash、ramda不同的是，他没有提供很多功能函数</li>
<li>只提供了一些函数式处理的操作，例如：compose、curry等，一些函子 Task、Either、MayBe等</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; compose, curry &#125; = <span class="built_in">require</span>(<span class="string">'folktale./core/lambda'</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; toUpper, first &#125; = <span class="built_in">require</span>(<span class="string">'lodash/fp'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第一个参数是传入函数的参数个数</span></span><br><span class="line"><span class="keyword">let</span> f = curry(<span class="number">2</span>, <span class="function"><span class="keyword">function</span>(<span class="params">x, y</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(x + y)</span><br><span class="line">&#125;)</span><br><span class="line">f(<span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line">f(<span class="number">3</span>)(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 函数组合</span></span><br><span class="line"><span class="keyword">let</span> f = compose(toUpper, first)</span><br><span class="line">f([<span class="string">'one'</span>, <span class="string">'two'</span>])</span><br></pre></td></tr></table></figure>

<h3 id="35-Task-函子"><a href="#35-Task-函子" class="headerlink" title="35.Task 函子"></a>35.Task 函子</h3><ul>
<li>Task 异步执行<ul>
<li>folktale(2.3.2) 2.x中的Task和1.0中的Task区别很大，1.0中的用法更接近我们现在演示的函子</li>
<li>这里以2.3.2来演示</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; task &#125; = <span class="built_in">require</span>(<span class="string">'folktale/concurrency/task'</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; split, find &#125; = <span class="built_in">require</span>(<span class="string">'loadash/fp'</span>)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readFile</span>(<span class="params">filename</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> task(<span class="function"><span class="params">resolver</span> =&gt;</span> &#123;</span><br><span class="line">        fs.readFile(filename, <span class="string">'utf-8'</span>, (err, data) =&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span>(err) resolver.reject(err)</span><br><span class="line">            resolver.resolve(data)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">readFile(<span class="string">'package.json'</span>)</span><br><span class="line">  .map(split(<span class="string">'\n'</span>))</span><br><span class="line">  .map(find(<span class="function"><span class="params">x</span> =&gt;</span> x.includes(<span class="string">'version'</span>)))</span><br><span class="line">  .run()</span><br><span class="line">  .listen(&#123;</span><br><span class="line">     onRjected: <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">         <span class="built_in">console</span>.log(err)</span><br><span class="line">     &#125;,</span><br><span class="line">     onResolved: <span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">         <span class="built_in">console</span>.log(value)</span><br><span class="line">     &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="36-Pointed函子"><a href="#36-Pointed函子" class="headerlink" title="36.Pointed函子"></a>36.Pointed函子</h3><ul>
<li>Pointed 函子是实现了 of 静态方法的函子</li>
<li>of 方法是为了避免使用 new 来创建对象，更深层的含义是 of 方法用来把值放到上下文 Context (把值放到容器中，使用 map 来处理值)</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Container</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">of</span> (value) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Container(value)</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line">Container.of(<span class="number">2</span>)</span><br><span class="line">    .map(<span class="function"><span class="params">x</span> =&gt;</span> x + <span class="number">5</span>)</span><br></pre></td></tr></table></figure>

<h3 id="37-IO函子问题"><a href="#37-IO函子问题" class="headerlink" title="37.IO函子问题"></a>37.IO函子问题</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; split, find &#125; = <span class="built_in">require</span>(<span class="string">'loadash/fp'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IO</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">of</span>(x)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> IO(functio()&#123;</span><br><span class="line">            <span class="keyword">return</span> x</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">constructor</span> (fn) &#123;</span><br><span class="line">        <span class="keyword">this</span>._value = fn</span><br><span class="line">    &#125;</span><br><span class="line">    map (fn) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> IO(fp.flowRight(fn, <span class="keyword">this</span>._value))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> readFile = <span class="function"><span class="keyword">function</span>(<span class="params">filename</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> IO(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> fs.readFileSync(filename, <span class="string">'utf-8'</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> print = <span class="function"><span class="keyword">function</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> IO(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> cat = fp.flowRight(print, readFile)</span><br><span class="line"><span class="keyword">let</span> r = cat(<span class="string">'package.json'</span>)._value()._value()</span><br><span class="line"><span class="built_in">console</span>.log(r)</span><br></pre></td></tr></table></figure>

<h3 id="38-Monad-函子"><a href="#38-Monad-函子" class="headerlink" title="38.Monad 函子"></a>38.Monad 函子</h3><ul>
<li>Monad函子是可以变扁的 Pointed 函子，IO(IO(x))</li>
<li>一个函子如果具有 join 和 of 两个方法并遵守一些定律就是一个 Monad</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; split, find &#125; = <span class="built_in">require</span>(<span class="string">'loadash/fp'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IO</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">of</span>(x)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> IO(functio()&#123;</span><br><span class="line">            <span class="keyword">return</span> x</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">constructor</span> (fn) &#123;</span><br><span class="line">        <span class="keyword">this</span>._value = fn</span><br><span class="line">    &#125;</span><br><span class="line">    map (fn) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> IO(fp.flowRight(fn, <span class="keyword">this</span>._value))</span><br><span class="line">    &#125;</span><br><span class="line">    join() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>._value()</span><br><span class="line">    &#125;</span><br><span class="line">    flatMap(fn) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.map(fn).join()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> readFile = <span class="function"><span class="keyword">function</span>(<span class="params">filename</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> IO(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> fs.readFileSync(filename, <span class="string">'utf-8'</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> print = <span class="function"><span class="keyword">function</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> IO(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> r = readFile(<span class="string">'package.json'</span>)</span><br><span class="line">        <span class="comment">//    .map(x =&gt; x.toUpperCase())</span></span><br><span class="line">           .map(fp.toUpper)</span><br><span class="line">           .flatMap(print)</span><br><span class="line">           .join()</span><br></pre></td></tr></table></figure>

<h3 id="39-总结"><a href="#39-总结" class="headerlink" title="39.总结"></a>39.总结</h3><p>暂略</p>
<h2 id="任务二：JavaScript-异步编程"><a href="#任务二：JavaScript-异步编程" class="headerlink" title="任务二：JavaScript 异步编程"></a>任务二：JavaScript 异步编程</h2><h3 id="1-概述"><a href="#1-概述" class="headerlink" title="1.概述"></a>1.概述</h3><ul>
<li>同步模式与异步模式</li>
<li>事件循环与消息队列</li>
<li>异步编程的几种方式</li>
<li>Promise 异步方案、宏任务/微任务队列</li>
<li>Generator 异步方案、Async/Await 语法糖</li>
</ul>
<h3 id="2-同步模式"><a href="#2-同步模式" class="headerlink" title="2.同步模式"></a>2.同步模式</h3><ul>
<li>代码中的任务依次执行</li>
</ul>
<h3 id="3-异步模式"><a href="#3-异步模式" class="headerlink" title="3.异步模式"></a>3.异步模式</h3><ul>
<li>不会去等待这个任务的结束才开始下一个任务</li>
<li>耗时任务开启过后就立即往后执行下一个任务</li>
<li>后续逻辑一般会通过回到函数的方式定义</li>
</ul>
<h3 id="4-回调函数"><a href="#4-回调函数" class="headerlink" title="4.回调函数"></a>4.回调函数</h3><ul>
<li>所有异步编程方案的根基</li>
<li>回到函数可以理解为一件你想要做的事情</li>
<li>由调用者定义，交给执行者执行的函数</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params">callback</span>) </span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        callback()</span><br><span class="line">    &#125;,<span class="number">3000</span>)</span><br><span class="line">&#125;</span><br><span class="line">foo(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'这就是一个回调函数'</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'调用者定义这个函数，执行者执行这个函数'</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'其实就是调用者告诉执行者异步任务结束后应该做什么'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="5-Promise-概述"><a href="#5-Promise-概述" class="headerlink" title="5.Promise 概述"></a>5.Promise 概述</h3><ul>
<li>一种更优的异步编程统一方案</li>
<li>CommonJs 社区提出了 Promise 的规范</li>
<li>在 ES2015 中被标准化，成为语言规范</li>
</ul>
<p><img src="../images/26/26-2.png" alt="图片"></p>
<h3 id="6-Promise-基本用法"><a href="#6-Promise-基本用法" class="headerlink" title="6.Promise 基本用法"></a>6.Promise 基本用法</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Promise 基本实例</span></span><br><span class="line"><span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="comment">// 这里用于“兑现”承诺</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 承诺达成</span></span><br><span class="line">  resolve(<span class="number">100</span>)</span><br><span class="line">  <span class="comment">// 承诺失败</span></span><br><span class="line">  <span class="comment">// reject(new Error('promise rejected'))</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">promise.then(<span class="function"><span class="keyword">function</span>(<span class="params">value</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'resolved'</span>,value)</span><br><span class="line">&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">error</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'rejected'</span>,error)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="7-Promise-使用案例"><a href="#7-Promise-使用案例" class="headerlink" title="7.Promise 使用案例"></a>7.Promise 使用案例</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Promise 方式的 ajax</span></span><br><span class="line">funtion ajax(url)&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve,reject</span>)</span>&#123;</span><br><span class="line">       <span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest()</span><br><span class="line">       xhr.open(<span class="string">'GET'</span>,url)</span><br><span class="line">       xhr.responseType = <span class="string">'json'</span></span><br><span class="line">       xhr.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">           <span class="keyword">if</span>(<span class="keyword">this</span>.status === <span class="number">200</span>) &#123;</span><br><span class="line">               resolve(<span class="keyword">this</span>.response)</span><br><span class="line">           &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">               reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="keyword">this</span>.statusText))</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       xhr.send()</span><br><span class="line">   &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ajax(<span class="string">'/api/users.json'</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(res)</span><br><span class="line">&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">error</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(error)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="8-Promise-常见误区"><a href="#8-Promise-常见误区" class="headerlink" title="8.Promise 常见误区"></a>8.Promise 常见误区</h3><ul>
<li>Promise 本质上也是使用回调函数定义异步任务结束后所需要执行的任务</li>
<li>嵌套使用的方式是使用 Promise 最常见的误区</li>
<li>正确做法是借助于 promise then 方法链式调用的特点，尽可能保证异步任务扁平化</li>
</ul>
<h3 id="9-Promise-链式调用"><a href="#9-Promise-链式调用" class="headerlink" title="9.Promise 链式调用"></a>9.Promise 链式调用</h3><ul>
<li><strong>每一个 then 方法实际上都是在为上一个 then 返回的 Promise 对象添加状态明确后的回调</strong></li>
<li>Promise 对象的 then 方法会返回一个全新的 Promise 对象</li>
<li>后面的 then 方法就是在为上一个 then 返回的 Promise 注册回调</li>
<li>前面 then 方法中回调函数的返回值会作为后面 then 方法回调的参数</li>
<li>如果回调中返回的是 Promise，那后面 then 方法的回调会等待它的结束</li>
</ul>
<h3 id="10-Promise-异常处理"><a href="#10-Promise-异常处理" class="headerlink" title="10.Promise 异常处理"></a>10.Promise 异常处理</h3><ul>
<li>then 里面注册 onRejected 只能捕获前一个 Promise 对象的异常</li>
<li>catch 里面注册 onRejected，相当于 then(undefined, function onRejected(){}) 更通用</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 全局 不推荐使用</span></span><br><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">'unhandledrejection'</span>,event =&gt;&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;reason, promise&#125; = event</span><br><span class="line">    <span class="built_in">console</span>.log(reason, promise)</span><br><span class="line">    <span class="comment">// reason =&gt; Promie 失败原因， 一般是一个错误对象</span></span><br><span class="line">    <span class="comment">// promise =&gt; 出现异常的 Promise 对象</span></span><br><span class="line">    event.preventDefault()</span><br><span class="line">&#125;, <span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// node</span></span><br><span class="line">process.on(<span class="string">'unhandledrejection'</span>, (reason, promise) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(reason, promise)</span><br><span class="line">    <span class="comment">// reason =&gt; Promie 失败原因， 一般是一个错误对象</span></span><br><span class="line">    <span class="comment">// promise =&gt; 出现异常的 Promise 对象</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="11-Promise-静态方法"><a href="#11-Promise-静态方法" class="headerlink" title="11.Promise 静态方法"></a>11.Promise 静态方法</h3><ul>
<li>Promise.resolve() 把一个值转化为一个 Promise 对象</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.resolve(<span class="string">'foo'</span>)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(value)</span><br><span class="line">    &#125;)</span><br><span class="line"><span class="comment">// 相当于</span></span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve,reject</span>) </span>&#123;</span><br><span class="line">    resolve(<span class="string">'foo'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> promise = ajax(<span class="string">'/api/users.json'</span>)</span><br><span class="line"><span class="keyword">var</span> peomise2 = <span class="built_in">Promise</span>.resolve(promise)</span><br><span class="line"><span class="built_in">console</span>.log(promise === promise2)  <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Promise</span>.resolve(&#123;</span><br><span class="line">    then: <span class="function"><span class="keyword">function</span>(<span class="params">onFulfilled, onRejected</span>) </span>&#123;</span><br><span class="line">        onFulfilled(<span class="string">'foo'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">.then(<span class="function"><span class="keyword">function</span>(<span class="params">value</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(value)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">Promise</span>.reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'rejected'</span>))</span><br><span class="line">    .catch(<span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(error)</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<h3 id="12-Promise-并行执行"><a href="#12-Promise-并行执行" class="headerlink" title="12.Promise 并行执行"></a>12.Promise 并行执行</h3><ul>
<li>Promise.all() 等待所有任务结束</li>
<li>Promise.race() 只会等待第一个结束的任务</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> promise = <span class="built_in">Promise</span>.all([</span><br><span class="line">    ajax(<span class="string">'/api/users.json'</span>)</span><br><span class="line">    ajax(<span class="string">'/api/posts.json'</span>)</span><br><span class="line">])</span><br><span class="line">promise.then(<span class="function"><span class="keyword">function</span>(<span class="params">values</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(values)</span><br><span class="line">&#125;).catch(<span class="function"><span class="keyword">function</span>(<span class="params">error</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(error)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">ajax(<span class="string">'/api/urls.json'</span>)</span><br><span class="line">    .then(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> urls = <span class="built_in">Object</span>.values(value)</span><br><span class="line">        <span class="keyword">const</span> tasks = urls.map(<span class="function"><span class="params">url</span> =&gt;</span> ajax(url))</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Promise</span>.all(tasks)</span><br><span class="line">    &#125;)</span><br><span class="line">    .then(<span class="function"><span class="params">values</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(values)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> request = ajax(<span class="string">'/api/posts.json'</span>)</span><br><span class="line"><span class="keyword">const</span> timeout = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve. reject</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'timeout'</span>)),<span class="number">500</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">Promise</span>.race([</span><br><span class="line">   request,</span><br><span class="line">   timeout</span><br><span class="line">])</span><br><span class="line">.then(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(value)</span><br><span class="line">&#125;)</span><br><span class="line">.catch(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(error)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="13-Promise-执行时序"><a href="#13-Promise-执行时序" class="headerlink" title="13.Promise 执行时序"></a>13.Promise 执行时序</h3><ul>
<li>回调队列中的任务称之为【宏任务】</li>
<li>宏任务执行过程中可以临时加上一些额外需求，可以选择作为一个新的宏任务进到队列中排队，也可以作为当前任务的【微任务】，直接在当前任务结束过后立即执行</li>
<li>Promise 的回调会作为微任务执行</li>
<li>微任务目的是提高整体的响应能力</li>
<li>目前绝大多数异步调用都是作为宏任务执行</li>
<li>微任务：Promise&amp;MutationObserver&amp;process.nextTick</li>
</ul>
<h3 id="14-Generator-异步方案-上"><a href="#14-Generator-异步方案-上" class="headerlink" title="14.Generator 异步方案(上)"></a>14.Generator 异步方案(上)</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> * <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'start'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">yield</span> <span class="string">'foo'</span></span><br><span class="line">        <span class="built_in">console</span>.log(res)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(e)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> generator = foo()</span><br><span class="line"><span class="keyword">const</span> result = generator.next()</span><br><span class="line"><span class="built_in">console</span>.log(result)</span><br><span class="line"><span class="comment">// generator.next('bar')</span></span><br><span class="line">generator.throw(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Generator error'</span>))</span><br></pre></td></tr></table></figure>

<h3 id="15-Generator-异步方案-中"><a href="#15-Generator-异步方案-中" class="headerlink" title="15.Generator 异步方案(中)"></a>15.Generator 异步方案(中)</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> * <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> users = <span class="keyword">yield</span> ajax(<span class="string">'/api/users.json'</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(users)</span><br><span class="line">     <span class="keyword">const</span> posts = <span class="keyword">yield</span> ajax(<span class="string">'/api/posts.json'</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(posts)</span><br><span class="line">&#125;</span><br><span class="line">cosnt g = main()</span><br><span class="line">cosnt result = g.next()</span><br><span class="line">result.value.then(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> result2 = g.next(data)</span><br><span class="line">    <span class="keyword">if</span>(result2.done) <span class="keyword">return</span></span><br><span class="line">    result2.value.then(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> result3 = g.next(data)</span><br><span class="line">        <span class="keyword">if</span>(result3.done) <span class="keyword">return</span></span><br><span class="line">        result.value.then(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">            g.next(data)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="16-Generator-异步方案-下"><a href="#16-Generator-异步方案-下" class="headerlink" title="16.Generator 异步方案(下)"></a>16.Generator 异步方案(下)</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> * <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">try</span>(</span><br><span class="line">        <span class="keyword">const</span> users = <span class="keyword">yield</span> ajax(<span class="string">'/api/users.json'</span>)</span><br><span class="line">        <span class="built_in">console</span>.log(users)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> posts = <span class="keyword">yield</span> ajax(<span class="string">'/api/posts.json'</span>)</span><br><span class="line">        <span class="built_in">console</span>.log(posts)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> urls = <span class="keyword">yield</span> ajax(<span class="string">'/api/urls.json'</span>)</span><br><span class="line">        <span class="built_in">console</span>.log(urls)</span><br><span class="line">    ) <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(e)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">co</span>(<span class="params">generator</span>)</span>&#123;</span><br><span class="line">    cosnt g = generator()</span><br><span class="line">    funtion handleResult(result) &#123;</span><br><span class="line">        <span class="keyword">if</span>(result.done) <span class="keyword">return</span>;</span><br><span class="line">        result.value.then(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">            handleResult(g.next(data))</span><br><span class="line">        &#125;,error =&gt; &#123;</span><br><span class="line">            g.throw(error)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    handleResult(g.next())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">co(main)</span><br></pre></td></tr></table></figure>

<h3 id="16-Async-函数"><a href="#16-Async-函数" class="headerlink" title="16.Async 函数"></a>16.Async 函数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">try</span>(</span><br><span class="line">        <span class="keyword">const</span> users = <span class="keyword">await</span> ajax(<span class="string">'/api/users.json'</span>)</span><br><span class="line">        <span class="built_in">console</span>.log(users)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> posts = <span class="keyword">await</span> ajax(<span class="string">'/api/posts.json'</span>)</span><br><span class="line">        <span class="built_in">console</span>.log(posts)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> urls = <span class="keyword">await</span> ajax(<span class="string">'/api/urls.json'</span>)</span><br><span class="line">        <span class="built_in">console</span>.log(urls)</span><br><span class="line">    ) <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(e)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> promise = main()</span><br><span class="line">promise.then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'all completed'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="任务三：手写Promise源码"><a href="#任务三：手写Promise源码" class="headerlink" title="任务三：手写Promise源码"></a>任务三：手写Promise源码</h2><h3 id="1-Promise-类核心逻辑实现"><a href="#1-Promise-类核心逻辑实现" class="headerlink" title="1.Promise 类核心逻辑实现"></a>1.Promise 类核心逻辑实现</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1.Promise 就是一个类 在执行这个类的时候 需要传递一个执行器进去 执行器会立即执行</span></span><br><span class="line"><span class="comment"> * 2.Promise 中有三种状态 成功 fulfilled 失败 rejected 等待 pending</span></span><br><span class="line"><span class="comment"> *   pending -&gt; fulfilled</span></span><br><span class="line"><span class="comment"> *   pending -&gt; rejected</span></span><br><span class="line"><span class="comment"> * 3.resolve 和 reject 函数是用来更改状态的</span></span><br><span class="line"><span class="comment"> *   resolve：fulfilled</span></span><br><span class="line"><span class="comment"> *   reject：rejected</span></span><br><span class="line"><span class="comment"> * 4.then 方法内部做的事情就是判断状态 如果状态是成功 调用成功的回调函数 如果状态是失败 调用失败的回调函数 then方法是被定义在原型对象中的</span></span><br><span class="line"><span class="comment"> * 5.then 成功回调有一个参数 表示成功之后的值 then 失败回调有一个参数 表示失败后的原因</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">const</span> PENDING = <span class="string">'pending'</span>;</span><br><span class="line"><span class="keyword">const</span> FULFILLED = <span class="string">'fulfilled'</span>;</span><br><span class="line"><span class="keyword">const</span> REJECTED = <span class="string">'rejected'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>(executor) &#123;</span><br><span class="line">        executor(<span class="keyword">this</span>.resolve, <span class="keyword">this</span>.reject);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    status = PENDING;</span><br><span class="line">    value = <span class="literal">undefined</span>;</span><br><span class="line">    reason = <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line">    resolve = <span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.status !== PENDING) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">this</span>.status = FULFILLED;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    reject = <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.status !== PENDING) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">this</span>.status = REJECTED;</span><br><span class="line">        <span class="keyword">this</span>.reason = reason;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    then(successCallback, failCallback)&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.status === FULFILLED)&#123;</span><br><span class="line">            successCallback(<span class="keyword">this</span>.value);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>.status === REJECTED)&#123;</span><br><span class="line">            failCallback(<span class="keyword">this</span>.reason);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = MyPromise</span><br></pre></td></tr></table></figure>

<h3 id="2-在Promise-类中加入异步逻辑"><a href="#2-在Promise-类中加入异步逻辑" class="headerlink" title="2.在Promise 类中加入异步逻辑"></a>2.在Promise 类中加入异步逻辑</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> PENDING = <span class="string">'pending'</span>;</span><br><span class="line"><span class="keyword">const</span> FULFILLED = <span class="string">'fulfilled'</span>;</span><br><span class="line"><span class="keyword">const</span> REJECTED = <span class="string">'rejected'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>(executor) &#123;</span><br><span class="line">        executor(<span class="keyword">this</span>.resolve, <span class="keyword">this</span>.reject);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    status = PENDING;</span><br><span class="line">    value = <span class="literal">undefined</span>;</span><br><span class="line">    reason = <span class="literal">undefined</span>;</span><br><span class="line">    successCallback = <span class="literal">undefined</span>;</span><br><span class="line">    failCallback = <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line">    resolve = <span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.status !== PENDING) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">this</span>.status = FULFILLED;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">        <span class="keyword">this</span>.successCallback &amp;&amp; <span class="keyword">this</span>.successCallback(<span class="keyword">this</span>.value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    reject = <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.status !== PENDING) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">this</span>.status = REJECTED;</span><br><span class="line">        <span class="keyword">this</span>.reason = reason;</span><br><span class="line">        <span class="keyword">this</span>.failCallback &amp;&amp; <span class="keyword">this</span>.failCallback(<span class="keyword">this</span>.reason);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    then(successCallback, failCallback)&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.status === FULFILLED)&#123;</span><br><span class="line">            successCallback(<span class="keyword">this</span>.value);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>.status === REJECTED)&#123;</span><br><span class="line">            failCallback(<span class="keyword">this</span>.reason);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.successCallback = successCallback;</span><br><span class="line">            <span class="keyword">this</span>.failCallback = failCallback;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = MyPromise</span><br></pre></td></tr></table></figure>

<h3 id="3-实现-then-方法多次调用添加多个处理函数"><a href="#3-实现-then-方法多次调用添加多个处理函数" class="headerlink" title="3.实现 then 方法多次调用添加多个处理函数"></a>3.实现 then 方法多次调用添加多个处理函数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> PENDING = <span class="string">'pending'</span>;</span><br><span class="line"><span class="keyword">const</span> FULFILLED = <span class="string">'fulfilled'</span>;</span><br><span class="line"><span class="keyword">const</span> REJECTED = <span class="string">'rejected'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>(executor) &#123;</span><br><span class="line">        executor(<span class="keyword">this</span>.resolve, <span class="keyword">this</span>.reject);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    status = PENDING;</span><br><span class="line">    value = <span class="literal">undefined</span>;</span><br><span class="line">    reason = <span class="literal">undefined</span>;</span><br><span class="line">    successCallback = [];</span><br><span class="line">    failCallback = [];</span><br><span class="line"></span><br><span class="line">    resolve = <span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.status !== PENDING) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">this</span>.status = FULFILLED;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">        <span class="comment">// this.successCallback &amp;&amp; this.successCallback(this.value);</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">this</span>.successCallback.length) <span class="keyword">this</span>.successCallback.shift()(<span class="keyword">this</span>.value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    reject = <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.status !== PENDING) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">this</span>.status = REJECTED;</span><br><span class="line">        <span class="keyword">this</span>.reason = reason;</span><br><span class="line">        <span class="comment">// this.failCallback &amp;&amp; this.failCallback(this.reason);</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">this</span>.failCallback.length) <span class="keyword">this</span>.failCallback.shift()(<span class="keyword">this</span>.reason);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    then(successCallback, failCallback)&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.status === FULFILLED)&#123;</span><br><span class="line">            successCallback(<span class="keyword">this</span>.value);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>.status === REJECTED)&#123;</span><br><span class="line">            failCallback(<span class="keyword">this</span>.reason);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.successCallback.push(successCallback);</span><br><span class="line">            <span class="keyword">this</span>.failCallback.push(failCallback);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = MyPromise</span><br></pre></td></tr></table></figure>

<h3 id="4-实现-then-方法的链式调用-一"><a href="#4-实现-then-方法的链式调用-一" class="headerlink" title="4.实现 then 方法的链式调用(一)"></a>4.实现 then 方法的链式调用(一)</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> PENDING = <span class="string">'pending'</span>;</span><br><span class="line"><span class="keyword">const</span> FULFILLED = <span class="string">'fulfilled'</span>;</span><br><span class="line"><span class="keyword">const</span> REJECTED = <span class="string">'rejected'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>(executor) &#123;</span><br><span class="line">        executor(<span class="keyword">this</span>.resolve, <span class="keyword">this</span>.reject);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    status = PENDING;</span><br><span class="line">    value = <span class="literal">undefined</span>;</span><br><span class="line">    reason = <span class="literal">undefined</span>;</span><br><span class="line">    successCallback = [];</span><br><span class="line">    failCallback = [];</span><br><span class="line"></span><br><span class="line">    resolve = <span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.status !== PENDING) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">this</span>.status = FULFILLED;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">        <span class="comment">// this.successCallback &amp;&amp; this.successCallback(this.value);</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">this</span>.successCallback.length) <span class="keyword">this</span>.successCallback.shift()(<span class="keyword">this</span>.value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    reject = <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.status !== PENDING) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">this</span>.status = REJECTED;</span><br><span class="line">        <span class="keyword">this</span>.reason = reason;</span><br><span class="line">        <span class="comment">// this.failCallback &amp;&amp; this.failCallback(this.reason);</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">this</span>.failCallback.length) <span class="keyword">this</span>.failCallback.shift()(<span class="keyword">this</span>.reason);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    then(successCallback, failCallback)&#123;</span><br><span class="line">        <span class="keyword">let</span> promise2 = <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.status === FULFILLED)&#123;</span><br><span class="line">            <span class="keyword">let</span> x = successCallback(<span class="keyword">this</span>.value);</span><br><span class="line">            resolve(x);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>.status === REJECTED)&#123;</span><br><span class="line">            failCallback(<span class="keyword">this</span>.reason);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.successCallback.push(successCallback);</span><br><span class="line">            <span class="keyword">this</span>.failCallback.push(failCallback);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> promise2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = MyPromise</span><br></pre></td></tr></table></figure>

<h3 id="5-实现-then-方法的链式调用-二"><a href="#5-实现-then-方法的链式调用-二" class="headerlink" title="5.实现 then 方法的链式调用(二)"></a>5.实现 then 方法的链式调用(二)</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> PENDING = <span class="string">'pending'</span>;</span><br><span class="line"><span class="keyword">const</span> FULFILLED = <span class="string">'fulfilled'</span>;</span><br><span class="line"><span class="keyword">const</span> REJECTED = <span class="string">'rejected'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>(executor) &#123;</span><br><span class="line">        executor(<span class="keyword">this</span>.resolve, <span class="keyword">this</span>.reject);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    status = PENDING;</span><br><span class="line">    value = <span class="literal">undefined</span>;</span><br><span class="line">    reason = <span class="literal">undefined</span>;</span><br><span class="line">    successCallback = [];</span><br><span class="line">    failCallback = [];</span><br><span class="line"></span><br><span class="line">    resolve = <span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.status !== PENDING) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">this</span>.status = FULFILLED;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">        <span class="comment">// this.successCallback &amp;&amp; this.successCallback(this.value);</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">this</span>.successCallback.length) <span class="keyword">this</span>.successCallback.shift()(<span class="keyword">this</span>.value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    reject = <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.status !== PENDING) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">this</span>.status = REJECTED;</span><br><span class="line">        <span class="keyword">this</span>.reason = reason;</span><br><span class="line">        <span class="comment">// this.failCallback &amp;&amp; this.failCallback(this.reason);</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">this</span>.failCallback.length) <span class="keyword">this</span>.failCallback.shift()(<span class="keyword">this</span>.reason);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    then(successCallback, failCallback)&#123;</span><br><span class="line">        <span class="keyword">let</span> promise2 = <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.status === FULFILLED)&#123;</span><br><span class="line">            <span class="keyword">let</span> x = successCallback(<span class="keyword">this</span>.value);</span><br><span class="line">            resolvePromise(x, resolve, reject);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>.status === REJECTED)&#123;</span><br><span class="line">            failCallback(<span class="keyword">this</span>.reason);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.successCallback.push(successCallback);</span><br><span class="line">            <span class="keyword">this</span>.failCallback.push(failCallback);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> promise2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolvePromise</span>(<span class="params">x, resolve, reject</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(x instance <span class="keyword">of</span> MyPromise) &#123;</span><br><span class="line">        x.then(resolve, reject);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        resolve(x);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = MyPromise</span><br></pre></td></tr></table></figure>

<h3 id="6-then-方法链式调用识别-Promise-对象自返回"><a href="#6-then-方法链式调用识别-Promise-对象自返回" class="headerlink" title="6.then 方法链式调用识别 Promise 对象自返回"></a>6.then 方法链式调用识别 Promise 对象自返回</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> PENDING = <span class="string">'pending'</span>;</span><br><span class="line"><span class="keyword">const</span> FULFILLED = <span class="string">'fulfilled'</span>;</span><br><span class="line"><span class="keyword">const</span> REJECTED = <span class="string">'rejected'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>(executor) &#123;</span><br><span class="line">        executor(<span class="keyword">this</span>.resolve, <span class="keyword">this</span>.reject);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    status = PENDING;</span><br><span class="line">    value = <span class="literal">undefined</span>;</span><br><span class="line">    reason = <span class="literal">undefined</span>;</span><br><span class="line">    successCallback = [];</span><br><span class="line">    failCallback = [];</span><br><span class="line"></span><br><span class="line">    resolve = <span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.status !== PENDING) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">this</span>.status = FULFILLED;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">        <span class="comment">// this.successCallback &amp;&amp; this.successCallback(this.value);</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">this</span>.successCallback.length) <span class="keyword">this</span>.successCallback.shift()(<span class="keyword">this</span>.value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    reject = <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.status !== PENDING) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">this</span>.status = REJECTED;</span><br><span class="line">        <span class="keyword">this</span>.reason = reason;</span><br><span class="line">        <span class="comment">// this.failCallback &amp;&amp; this.failCallback(this.reason);</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">this</span>.failCallback.length) <span class="keyword">this</span>.failCallback.shift()(<span class="keyword">this</span>.reason);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    then(successCallback, failCallback)&#123;</span><br><span class="line">        <span class="keyword">let</span> promise2 = <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.status === FULFILLED)&#123;</span><br><span class="line">            setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> x = successCallback(<span class="keyword">this</span>.value);</span><br><span class="line">                resolvePromise(promise2， x, resolve, reject);</span><br><span class="line">            &#125;,<span class="number">0</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>.status === REJECTED)&#123;</span><br><span class="line">            failCallback(<span class="keyword">this</span>.reason);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.successCallback.push(successCallback);</span><br><span class="line">            <span class="keyword">this</span>.failCallback.push(failCallback);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> promise2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolvePromise</span>(<span class="params">promise2， x, resolve, reject</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(promise2 === x) &#123;</span><br><span class="line">        <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'Chaining cycle detected for promise #&lt;Promise&gt;'</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(x instance <span class="keyword">of</span> MyPromise) &#123;</span><br><span class="line">        x.then(resolve, reject);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        resolve(x);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = MyPromise</span><br></pre></td></tr></table></figure>

<h3 id="7-捕获错误及-then-链式调用其他状态码补充"><a href="#7-捕获错误及-then-链式调用其他状态码补充" class="headerlink" title="7.捕获错误及 then 链式调用其他状态码补充"></a>7.捕获错误及 then 链式调用其他状态码补充</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> PENDING = <span class="string">'pending'</span>;</span><br><span class="line"><span class="keyword">const</span> FULFILLED = <span class="string">'fulfilled'</span>;</span><br><span class="line"><span class="keyword">const</span> REJECTED = <span class="string">'rejected'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>(executor) &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            executor(<span class="keyword">this</span>.resolve, <span class="keyword">this</span>.reject);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="keyword">this</span>.reject(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    status = PENDING;</span><br><span class="line">    value = <span class="literal">undefined</span>;</span><br><span class="line">    reason = <span class="literal">undefined</span>;</span><br><span class="line">    successCallback = [];</span><br><span class="line">    failCallback = [];</span><br><span class="line"></span><br><span class="line">    resolve = <span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.status !== PENDING) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">this</span>.status = FULFILLED;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">        <span class="comment">// this.successCallback &amp;&amp; this.successCallback(this.value);</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">this</span>.successCallback.length) <span class="keyword">this</span>.successCallback.shift()();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    reject = <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.status !== PENDING) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">this</span>.status = REJECTED;</span><br><span class="line">        <span class="keyword">this</span>.reason = reason;</span><br><span class="line">        <span class="comment">// this.failCallback &amp;&amp; this.failCallback(this.reason);</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">this</span>.failCallback.length) <span class="keyword">this</span>.failCallback.shift()();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    then(successCallback, failCallback)&#123;</span><br><span class="line">        <span class="keyword">let</span> promise2 = <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.status === FULFILLED)&#123;</span><br><span class="line">            setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">let</span> x = successCallback(<span class="keyword">this</span>.value);</span><br><span class="line">                    resolvePromise(promise2， x, resolve, reject);</span><br><span class="line">                &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">                    reject(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,<span class="number">0</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>.status === REJECTED)&#123;</span><br><span class="line">            setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">let</span> x = failCallback(<span class="keyword">this</span>.reason);</span><br><span class="line">                    resolvePromise(promise2， x, resolve, reject);</span><br><span class="line">                &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">                    reject(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,<span class="number">0</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.successCallback.push(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">let</span> x = successCallback(<span class="keyword">this</span>.value);</span><br><span class="line">                        resolvePromise(promise2， x, resolve, reject);</span><br><span class="line">                        &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">                        reject(e);</span><br><span class="line">                       &#125;</span><br><span class="line">                    &#125;,<span class="number">0</span>)</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="keyword">this</span>.failCallback.push(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">let</span> x = failCallback(<span class="keyword">this</span>.reason);</span><br><span class="line">                            resolvePromise(promise2， x, resolve, reject);</span><br><span class="line">                        &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">                            reject(e);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,<span class="number">0</span>)</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> promise2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolvePromise</span>(<span class="params">promise2， x, resolve, reject</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(promise2 === x) &#123;</span><br><span class="line">        <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'Chaining cycle detected for promise #&lt;Promise&gt;'</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(x instance <span class="keyword">of</span> MyPromise) &#123;</span><br><span class="line">        x.then(resolve, reject);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        resolve(x);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = MyPromise</span><br></pre></td></tr></table></figure>

<h3 id="8-将-then-方法的参数变成可选参数"><a href="#8-将-then-方法的参数变成可选参数" class="headerlink" title="8.将 then 方法的参数变成可选参数"></a>8.将 then 方法的参数变成可选参数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> PENDING = <span class="string">'pending'</span>;</span><br><span class="line"><span class="keyword">const</span> FULFILLED = <span class="string">'fulfilled'</span>;</span><br><span class="line"><span class="keyword">const</span> REJECTED = <span class="string">'rejected'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>(executor) &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            executor(<span class="keyword">this</span>.resolve, <span class="keyword">this</span>.reject);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="keyword">this</span>.reject(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    status = PENDING;</span><br><span class="line">    value = <span class="literal">undefined</span>;</span><br><span class="line">    reason = <span class="literal">undefined</span>;</span><br><span class="line">    successCallback = [];</span><br><span class="line">    failCallback = [];</span><br><span class="line"></span><br><span class="line">    resolve = <span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.status !== PENDING) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">this</span>.status = FULFILLED;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">        <span class="comment">// this.successCallback &amp;&amp; this.successCallback(this.value);</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">this</span>.successCallback.length) <span class="keyword">this</span>.successCallback.shift()();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    reject = <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.status !== PENDING) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">this</span>.status = REJECTED;</span><br><span class="line">        <span class="keyword">this</span>.reason = reason;</span><br><span class="line">        <span class="comment">// this.failCallback &amp;&amp; this.failCallback(this.reason);</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">this</span>.failCallback.length) <span class="keyword">this</span>.failCallback.shift()();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    then(successCallback, failCallback)&#123;</span><br><span class="line">        successCallback = successCallback ? successCallback: <span class="function"><span class="params">value</span> =&gt;</span> value;</span><br><span class="line">        failCallback = failCallback ? failCallback: <span class="function"><span class="params">reason</span> =&gt;</span> &#123; <span class="keyword">throw</span> reason &#125;;</span><br><span class="line">        <span class="keyword">let</span> promise2 = <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.status === FULFILLED)&#123;</span><br><span class="line">            setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">let</span> x = successCallback(<span class="keyword">this</span>.value);</span><br><span class="line">                    resolvePromise(promise2， x, resolve, reject);</span><br><span class="line">                &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">                    reject(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,<span class="number">0</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>.status === REJECTED)&#123;</span><br><span class="line">            setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">let</span> x = failCallback(<span class="keyword">this</span>.reason);</span><br><span class="line">                    resolvePromise(promise2， x, resolve, reject);</span><br><span class="line">                &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">                    reject(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,<span class="number">0</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.successCallback.push(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">let</span> x = successCallback(<span class="keyword">this</span>.value);</span><br><span class="line">                        resolvePromise(promise2， x, resolve, reject);</span><br><span class="line">                        &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">                        reject(e);</span><br><span class="line">                       &#125;</span><br><span class="line">                    &#125;,<span class="number">0</span>)</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="keyword">this</span>.failCallback.push(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">let</span> x = failCallback(<span class="keyword">this</span>.reason);</span><br><span class="line">                            resolvePromise(promise2， x, resolve, reject);</span><br><span class="line">                        &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">                            reject(e);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,<span class="number">0</span>)</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> promise2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolvePromise</span>(<span class="params">promise2， x, resolve, reject</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(promise2 === x) &#123;</span><br><span class="line">        <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'Chaining cycle detected for promise #&lt;Promise&gt;'</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(x instance <span class="keyword">of</span> MyPromise) &#123;</span><br><span class="line">        x.then(resolve, reject);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        resolve(x);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = MyPromise</span><br></pre></td></tr></table></figure>

<h3 id="9-Proimise-all-方法的实现"><a href="#9-Proimise-all-方法的实现" class="headerlink" title="9.Proimise.all 方法的实现"></a>9.Proimise.all 方法的实现</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> PENDING = <span class="string">'pending'</span>;</span><br><span class="line"><span class="keyword">const</span> FULFILLED = <span class="string">'fulfilled'</span>;</span><br><span class="line"><span class="keyword">const</span> REJECTED = <span class="string">'rejected'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>(executor) &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            executor(<span class="keyword">this</span>.resolve, <span class="keyword">this</span>.reject);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="keyword">this</span>.reject(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    status = PENDING;</span><br><span class="line">    value = <span class="literal">undefined</span>;</span><br><span class="line">    reason = <span class="literal">undefined</span>;</span><br><span class="line">    successCallback = [];</span><br><span class="line">    failCallback = [];</span><br><span class="line"></span><br><span class="line">    resolve = <span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.status !== PENDING) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">this</span>.status = FULFILLED;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">        <span class="comment">// this.successCallback &amp;&amp; this.successCallback(this.value);</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">this</span>.successCallback.length) <span class="keyword">this</span>.successCallback.shift()();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    reject = <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.status !== PENDING) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">this</span>.status = REJECTED;</span><br><span class="line">        <span class="keyword">this</span>.reason = reason;</span><br><span class="line">        <span class="comment">// this.failCallback &amp;&amp; this.failCallback(this.reason);</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">this</span>.failCallback.length) <span class="keyword">this</span>.failCallback.shift()();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    then(successCallback, failCallback)&#123;</span><br><span class="line">        successCallback = successCallback ? successCallback: <span class="function"><span class="params">value</span> =&gt;</span> value;</span><br><span class="line">        failCallback = failCallback ? failCallback: <span class="function"><span class="params">reason</span> =&gt;</span> &#123; <span class="keyword">throw</span> reason &#125;;</span><br><span class="line">        <span class="keyword">let</span> promise2 = <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.status === FULFILLED)&#123;</span><br><span class="line">            setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">let</span> x = successCallback(<span class="keyword">this</span>.value);</span><br><span class="line">                    resolvePromise(promise2， x, resolve, reject);</span><br><span class="line">                &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">                    reject(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,<span class="number">0</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>.status === REJECTED)&#123;</span><br><span class="line">            setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">let</span> x = failCallback(<span class="keyword">this</span>.reason);</span><br><span class="line">                    resolvePromise(promise2， x, resolve, reject);</span><br><span class="line">                &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">                    reject(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,<span class="number">0</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.successCallback.push(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">let</span> x = successCallback(<span class="keyword">this</span>.value);</span><br><span class="line">                        resolvePromise(promise2， x, resolve, reject);</span><br><span class="line">                        &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">                        reject(e);</span><br><span class="line">                       &#125;</span><br><span class="line">                    &#125;,<span class="number">0</span>)</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="keyword">this</span>.failCallback.push(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">let</span> x = failCallback(<span class="keyword">this</span>.reason);</span><br><span class="line">                            resolvePromise(promise2， x, resolve, reject);</span><br><span class="line">                        &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">                            reject(e);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,<span class="number">0</span>)</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> promise2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> all(array) &#123;</span><br><span class="line">        <span class="keyword">let</span> result = [];</span><br><span class="line">        <span class="keyword">let</span> index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">addData</span>(<span class="params">key, value</span>) </span>&#123;</span><br><span class="line">                result[key] = value;</span><br><span class="line">                index++;</span><br><span class="line">                <span class="keyword">if</span>(index === array.length) &#123;</span><br><span class="line">                    resolve(result);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; array.length; i++) &#123;</span><br><span class="line">                <span class="keyword">let</span> current = array[i];</span><br><span class="line">                <span class="keyword">if</span>(current <span class="keyword">instanceof</span> MyPromise) &#123;</span><br><span class="line">                    current.then(<span class="function"><span class="params">value</span> =&gt;</span> addData(i, value),reason =&gt; reject(reason));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    addData(i, array[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolvePromise</span>(<span class="params">promise2， x, resolve, reject</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(promise2 === x) &#123;</span><br><span class="line">        <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'Chaining cycle detected for promise #&lt;Promise&gt;'</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(x instance <span class="keyword">of</span> MyPromise) &#123;</span><br><span class="line">        x.then(resolve, reject);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        resolve(x);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = MyPromise</span><br></pre></td></tr></table></figure>

<h3 id="10-Proimise-resolve-方法的实现"><a href="#10-Proimise-resolve-方法的实现" class="headerlink" title="10.Proimise.resolve 方法的实现"></a>10.Proimise.resolve 方法的实现</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> PENDING = <span class="string">'pending'</span>;</span><br><span class="line"><span class="keyword">const</span> FULFILLED = <span class="string">'fulfilled'</span>;</span><br><span class="line"><span class="keyword">const</span> REJECTED = <span class="string">'rejected'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>(executor) &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            executor(<span class="keyword">this</span>.resolve, <span class="keyword">this</span>.reject);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="keyword">this</span>.reject(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    status = PENDING;</span><br><span class="line">    value = <span class="literal">undefined</span>;</span><br><span class="line">    reason = <span class="literal">undefined</span>;</span><br><span class="line">    successCallback = [];</span><br><span class="line">    failCallback = [];</span><br><span class="line"></span><br><span class="line">    resolve = <span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.status !== PENDING) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">this</span>.status = FULFILLED;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">        <span class="comment">// this.successCallback &amp;&amp; this.successCallback(this.value);</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">this</span>.successCallback.length) <span class="keyword">this</span>.successCallback.shift()();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    reject = <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.status !== PENDING) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">this</span>.status = REJECTED;</span><br><span class="line">        <span class="keyword">this</span>.reason = reason;</span><br><span class="line">        <span class="comment">// this.failCallback &amp;&amp; this.failCallback(this.reason);</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">this</span>.failCallback.length) <span class="keyword">this</span>.failCallback.shift()();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    then(successCallback, failCallback)&#123;</span><br><span class="line">        successCallback = successCallback ? successCallback: <span class="function"><span class="params">value</span> =&gt;</span> value;</span><br><span class="line">        failCallback = failCallback ? failCallback: <span class="function"><span class="params">reason</span> =&gt;</span> &#123; <span class="keyword">throw</span> reason &#125;;</span><br><span class="line">        <span class="keyword">let</span> promise2 = <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.status === FULFILLED)&#123;</span><br><span class="line">            setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">let</span> x = successCallback(<span class="keyword">this</span>.value);</span><br><span class="line">                    resolvePromise(promise2， x, resolve, reject);</span><br><span class="line">                &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">                    reject(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,<span class="number">0</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>.status === REJECTED)&#123;</span><br><span class="line">            setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">let</span> x = failCallback(<span class="keyword">this</span>.reason);</span><br><span class="line">                    resolvePromise(promise2， x, resolve, reject);</span><br><span class="line">                &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">                    reject(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,<span class="number">0</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.successCallback.push(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">let</span> x = successCallback(<span class="keyword">this</span>.value);</span><br><span class="line">                        resolvePromise(promise2， x, resolve, reject);</span><br><span class="line">                        &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">                        reject(e);</span><br><span class="line">                       &#125;</span><br><span class="line">                    &#125;,<span class="number">0</span>)</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="keyword">this</span>.failCallback.push(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">let</span> x = failCallback(<span class="keyword">this</span>.reason);</span><br><span class="line">                            resolvePromise(promise2， x, resolve, reject);</span><br><span class="line">                        &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">                            reject(e);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,<span class="number">0</span>)</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> promise2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> all(array) &#123;</span><br><span class="line">        <span class="keyword">let</span> result = [];</span><br><span class="line">        <span class="keyword">let</span> index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">addData</span>(<span class="params">key, value</span>) </span>&#123;</span><br><span class="line">                result[key] = value;</span><br><span class="line">                index++;</span><br><span class="line">                <span class="keyword">if</span>(index === array.length) &#123;</span><br><span class="line">                    resolve(result);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; array.length; i++) &#123;</span><br><span class="line">                <span class="keyword">let</span> current = array[i];</span><br><span class="line">                <span class="keyword">if</span>(current <span class="keyword">instanceof</span> MyPromise) &#123;</span><br><span class="line">                    current.then(<span class="function"><span class="params">value</span> =&gt;</span> addData(i, value),reason =&gt; reject(reason));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    addData(i, array[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> resolve(value) &#123;</span><br><span class="line">        <span class="keyword">if</span>(value <span class="keyword">instanceof</span> MyPomise) <span class="keyword">return</span> value;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyPomise(<span class="function"><span class="params">resolve</span> =&gt;</span> resolve(value))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolvePromise</span>(<span class="params">promise2， x, resolve, reject</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(promise2 === x) &#123;</span><br><span class="line">        <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'Chaining cycle detected for promise #&lt;Promise&gt;'</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(x instance <span class="keyword">of</span> MyPromise) &#123;</span><br><span class="line">        x.then(resolve, reject);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        resolve(x);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = MyPromise</span><br></pre></td></tr></table></figure>

<h3 id="11-finally-方法的实现"><a href="#11-finally-方法的实现" class="headerlink" title="11.finally 方法的实现"></a>11.finally 方法的实现</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> PENDING = <span class="string">'pending'</span>;</span><br><span class="line"><span class="keyword">const</span> FULFILLED = <span class="string">'fulfilled'</span>;</span><br><span class="line"><span class="keyword">const</span> REJECTED = <span class="string">'rejected'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>(executor) &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            executor(<span class="keyword">this</span>.resolve, <span class="keyword">this</span>.reject);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="keyword">this</span>.reject(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    status = PENDING;</span><br><span class="line">    value = <span class="literal">undefined</span>;</span><br><span class="line">    reason = <span class="literal">undefined</span>;</span><br><span class="line">    successCallback = [];</span><br><span class="line">    failCallback = [];</span><br><span class="line"></span><br><span class="line">    resolve = <span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.status !== PENDING) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">this</span>.status = FULFILLED;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">        <span class="comment">// this.successCallback &amp;&amp; this.successCallback(this.value);</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">this</span>.successCallback.length) <span class="keyword">this</span>.successCallback.shift()();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    reject = <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.status !== PENDING) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">this</span>.status = REJECTED;</span><br><span class="line">        <span class="keyword">this</span>.reason = reason;</span><br><span class="line">        <span class="comment">// this.failCallback &amp;&amp; this.failCallback(this.reason);</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">this</span>.failCallback.length) <span class="keyword">this</span>.failCallback.shift()();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    then(successCallback, failCallback)&#123;</span><br><span class="line">        successCallback = successCallback ? successCallback: <span class="function"><span class="params">value</span> =&gt;</span> value;</span><br><span class="line">        failCallback = failCallback ? failCallback: <span class="function"><span class="params">reason</span> =&gt;</span> &#123; <span class="keyword">throw</span> reason &#125;;</span><br><span class="line">        <span class="keyword">let</span> promise2 = <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.status === FULFILLED)&#123;</span><br><span class="line">            setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">let</span> x = successCallback(<span class="keyword">this</span>.value);</span><br><span class="line">                    resolvePromise(promise2， x, resolve, reject);</span><br><span class="line">                &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">                    reject(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,<span class="number">0</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>.status === REJECTED)&#123;</span><br><span class="line">            setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">let</span> x = failCallback(<span class="keyword">this</span>.reason);</span><br><span class="line">                    resolvePromise(promise2， x, resolve, reject);</span><br><span class="line">                &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">                    reject(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,<span class="number">0</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.successCallback.push(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">let</span> x = successCallback(<span class="keyword">this</span>.value);</span><br><span class="line">                        resolvePromise(promise2， x, resolve, reject);</span><br><span class="line">                        &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">                        reject(e);</span><br><span class="line">                       &#125;</span><br><span class="line">                    &#125;,<span class="number">0</span>)</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="keyword">this</span>.failCallback.push(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">let</span> x = failCallback(<span class="keyword">this</span>.reason);</span><br><span class="line">                            resolvePromise(promise2， x, resolve, reject);</span><br><span class="line">                        &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">                            reject(e);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,<span class="number">0</span>)</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> promise2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">finally</span>(callback) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.then(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> MyPromise.resolve(callback()).then(<span class="function"><span class="params">()</span> =&gt;</span> value);</span><br><span class="line">            <span class="comment">// callback();</span></span><br><span class="line">            <span class="comment">// return value;</span></span><br><span class="line">        &#125;,reason =&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> MyPromise.resolve(callback()).then(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">throw</span> reason);</span><br><span class="line">            <span class="comment">// callback();</span></span><br><span class="line">            <span class="comment">// throw reason;</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> all(array) &#123;</span><br><span class="line">        <span class="keyword">let</span> result = [];</span><br><span class="line">        <span class="keyword">let</span> index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">addData</span>(<span class="params">key, value</span>) </span>&#123;</span><br><span class="line">                result[key] = value;</span><br><span class="line">                index++;</span><br><span class="line">                <span class="keyword">if</span>(index === array.length) &#123;</span><br><span class="line">                    resolve(result);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; array.length; i++) &#123;</span><br><span class="line">                <span class="keyword">let</span> current = array[i];</span><br><span class="line">                <span class="keyword">if</span>(current <span class="keyword">instanceof</span> MyPromise) &#123;</span><br><span class="line">                    current.then(<span class="function"><span class="params">value</span> =&gt;</span> addData(i, value),reason =&gt; reject(reason));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    addData(i, array[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> resolve(value) &#123;</span><br><span class="line">        <span class="keyword">if</span>(value <span class="keyword">instanceof</span> MyPomise) <span class="keyword">return</span> value;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyPomise(<span class="function"><span class="params">resolve</span> =&gt;</span> resolve(value))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolvePromise</span>(<span class="params">promise2， x, resolve, reject</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(promise2 === x) &#123;</span><br><span class="line">        <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'Chaining cycle detected for promise #&lt;Promise&gt;'</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(x instance <span class="keyword">of</span> MyPromise) &#123;</span><br><span class="line">        x.then(resolve, reject);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        resolve(x);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = MyPromise</span><br></pre></td></tr></table></figure>

<h3 id="12-catch-方法的实现"><a href="#12-catch-方法的实现" class="headerlink" title="12.catch 方法的实现"></a>12.catch 方法的实现</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> PENDING = <span class="string">'pending'</span>;</span><br><span class="line"><span class="keyword">const</span> FULFILLED = <span class="string">'fulfilled'</span>;</span><br><span class="line"><span class="keyword">const</span> REJECTED = <span class="string">'rejected'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>(executor) &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            executor(<span class="keyword">this</span>.resolve, <span class="keyword">this</span>.reject);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="keyword">this</span>.reject(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    status = PENDING;</span><br><span class="line">    value = <span class="literal">undefined</span>;</span><br><span class="line">    reason = <span class="literal">undefined</span>;</span><br><span class="line">    successCallback = [];</span><br><span class="line">    failCallback = [];</span><br><span class="line"></span><br><span class="line">    resolve = <span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.status !== PENDING) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">this</span>.status = FULFILLED;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">        <span class="comment">// this.successCallback &amp;&amp; this.successCallback(this.value);</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">this</span>.successCallback.length) <span class="keyword">this</span>.successCallback.shift()();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    reject = <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.status !== PENDING) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">this</span>.status = REJECTED;</span><br><span class="line">        <span class="keyword">this</span>.reason = reason;</span><br><span class="line">        <span class="comment">// this.failCallback &amp;&amp; this.failCallback(this.reason);</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">this</span>.failCallback.length) <span class="keyword">this</span>.failCallback.shift()();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    then(successCallback, failCallback)&#123;</span><br><span class="line">        successCallback = successCallback ? successCallback: <span class="function"><span class="params">value</span> =&gt;</span> value;</span><br><span class="line">        failCallback = failCallback ? failCallback: <span class="function"><span class="params">reason</span> =&gt;</span> &#123; <span class="keyword">throw</span> reason &#125;;</span><br><span class="line">        <span class="keyword">let</span> promise2 = <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.status === FULFILLED)&#123;</span><br><span class="line">            setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">let</span> x = successCallback(<span class="keyword">this</span>.value);</span><br><span class="line">                    resolvePromise(promise2， x, resolve, reject);</span><br><span class="line">                &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">                    reject(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,<span class="number">0</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>.status === REJECTED)&#123;</span><br><span class="line">            setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">let</span> x = failCallback(<span class="keyword">this</span>.reason);</span><br><span class="line">                    resolvePromise(promise2， x, resolve, reject);</span><br><span class="line">                &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">                    reject(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,<span class="number">0</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.successCallback.push(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">let</span> x = successCallback(<span class="keyword">this</span>.value);</span><br><span class="line">                        resolvePromise(promise2， x, resolve, reject);</span><br><span class="line">                        &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">                        reject(e);</span><br><span class="line">                       &#125;</span><br><span class="line">                    &#125;,<span class="number">0</span>)</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="keyword">this</span>.failCallback.push(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">let</span> x = failCallback(<span class="keyword">this</span>.reason);</span><br><span class="line">                            resolvePromise(promise2， x, resolve, reject);</span><br><span class="line">                        &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">                            reject(e);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,<span class="number">0</span>)</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> promise2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">finally</span>(callback) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.then(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> MyPromise.resolve(callback()).then(<span class="function"><span class="params">()</span> =&gt;</span> value);</span><br><span class="line">            <span class="comment">// callback();</span></span><br><span class="line">            <span class="comment">// return value;</span></span><br><span class="line">        &#125;,reason =&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> MyPromise.resolve(callback()).then(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">throw</span> reason);</span><br><span class="line">            <span class="comment">// callback();</span></span><br><span class="line">            <span class="comment">// throw reason;</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">catch</span>(failCallback) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.then(<span class="literal">undefined</span>, failCallback)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> all(array) &#123;</span><br><span class="line">        <span class="keyword">let</span> result = [];</span><br><span class="line">        <span class="keyword">let</span> index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">addData</span>(<span class="params">key, value</span>) </span>&#123;</span><br><span class="line">                result[key] = value;</span><br><span class="line">                index++;</span><br><span class="line">                <span class="keyword">if</span>(index === array.length) &#123;</span><br><span class="line">                    resolve(result);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; array.length; i++) &#123;</span><br><span class="line">                <span class="keyword">let</span> current = array[i];</span><br><span class="line">                <span class="keyword">if</span>(current <span class="keyword">instanceof</span> MyPromise) &#123;</span><br><span class="line">                    current.then(<span class="function"><span class="params">value</span> =&gt;</span> addData(i, value),reason =&gt; reject(reason));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    addData(i, array[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> resolve(value) &#123;</span><br><span class="line">        <span class="keyword">if</span>(value <span class="keyword">instanceof</span> MyPomise) <span class="keyword">return</span> value;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyPomise(<span class="function"><span class="params">resolve</span> =&gt;</span> resolve(value))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolvePromise</span>(<span class="params">promise2， x, resolve, reject</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(promise2 === x) &#123;</span><br><span class="line">        <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'Chaining cycle detected for promise #&lt;Promise&gt;'</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(x instance <span class="keyword">of</span> MyPromise) &#123;</span><br><span class="line">        x.then(resolve, reject);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        resolve(x);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = MyPromise</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/JavaScipt/" rel="tag"># JavaScipt</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/10/22/25/" rel="next" title="VsCode 自带Emmet语法">
                <i class="fa fa-chevron-left"></i> VsCode 自带Emmet语法
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/11/04/27/" rel="prev" title="学习笔记 ----- 【JavaScript 深度剖析】ES 新特性与 TypeScript、JS 性能优化">
                学习笔记 ----- 【JavaScript 深度剖析】ES 新特性与 TypeScript、JS 性能优化 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="FY" />
            
              <p class="site-author-name" itemprop="name">FY</p>
              <p class="site-description motion-element" itemprop="description">Just Be Yourself</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">48</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">16</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/xuanfeiyu" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Part-1-·-模块一-JavaScript-深度剖析"><span class="nav-number">1.</span> <span class="nav-text">Part 1 · 模块一 JavaScript 深度剖析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#任务一：函数式编程范式"><span class="nav-number">1.1.</span> <span class="nav-text">任务一：函数式编程范式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-课程介绍"><span class="nav-number">1.1.1.</span> <span class="nav-text">1.课程介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-为什么要学习函数编程以及什么是函数式编程"><span class="nav-number">1.1.2.</span> <span class="nav-text">2.为什么要学习函数编程以及什么是函数式编程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-函数式编程概念"><span class="nav-number">1.1.3.</span> <span class="nav-text">3.函数式编程概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-函数是一等公民"><span class="nav-number">1.1.4.</span> <span class="nav-text">4.函数是一等公民</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-高阶函数-函数作为参数"><span class="nav-number">1.1.5.</span> <span class="nav-text">5.高阶函数-函数作为参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-高阶函数-函数作为返回值"><span class="nav-number">1.1.6.</span> <span class="nav-text">6.高阶函数-函数作为返回值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-高阶函数的意义"><span class="nav-number">1.1.7.</span> <span class="nav-text">7.高阶函数的意义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-常用的高阶函数"><span class="nav-number">1.1.8.</span> <span class="nav-text">8.常用的高阶函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-闭包-概念"><span class="nav-number">1.1.9.</span> <span class="nav-text">9.闭包-概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-闭包-案例"><span class="nav-number">1.1.10.</span> <span class="nav-text">10.闭包-案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-纯函数概念"><span class="nav-number">1.1.11.</span> <span class="nav-text">11.纯函数概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-Lodash"><span class="nav-number">1.1.12.</span> <span class="nav-text">12.Lodash</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-纯函数的好处"><span class="nav-number">1.1.13.</span> <span class="nav-text">13.纯函数的好处</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-副作用"><span class="nav-number">1.1.14.</span> <span class="nav-text">14.副作用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#15-柯里化"><span class="nav-number">1.1.15.</span> <span class="nav-text">15.柯里化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#16-Lodash-中的柯里化方法"><span class="nav-number">1.1.16.</span> <span class="nav-text">16.Lodash 中的柯里化方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#17-柯里化案例"><span class="nav-number">1.1.17.</span> <span class="nav-text">17.柯里化案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#18-柯里化原理模拟"><span class="nav-number">1.1.18.</span> <span class="nav-text">18.柯里化原理模拟</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#19-柯里化总结"><span class="nav-number">1.1.19.</span> <span class="nav-text">19.柯里化总结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#20-函数组合概念"><span class="nav-number">1.1.20.</span> <span class="nav-text">20.函数组合概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#21-Lodash中的组合函数"><span class="nav-number">1.1.21.</span> <span class="nav-text">21.Lodash中的组合函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#22-组合函数原理模拟"><span class="nav-number">1.1.22.</span> <span class="nav-text">22.组合函数原理模拟</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#23-函数组合-结合律"><span class="nav-number">1.1.23.</span> <span class="nav-text">23.函数组合-结合律</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#24-函数组合-调试"><span class="nav-number">1.1.24.</span> <span class="nav-text">24.函数组合-调试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#25-Lodash-fp-模块"><span class="nav-number">1.1.25.</span> <span class="nav-text">25.Lodash-fp 模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#26-Lodash-map-方法的小问题"><span class="nav-number">1.1.26.</span> <span class="nav-text">26.Lodash-map 方法的小问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#27-Pointfree"><span class="nav-number">1.1.27.</span> <span class="nav-text">27.Pointfree</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#28-Pointfree-案例"><span class="nav-number">1.1.28.</span> <span class="nav-text">28.Pointfree-案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#29-Functor"><span class="nav-number">1.1.29.</span> <span class="nav-text">29.Functor</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#30-Functor总结"><span class="nav-number">1.1.30.</span> <span class="nav-text">30.Functor总结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#31-MayBe函子"><span class="nav-number">1.1.31.</span> <span class="nav-text">31.MayBe函子</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#32-Either函子"><span class="nav-number">1.1.32.</span> <span class="nav-text">32.Either函子</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#33-IO函子"><span class="nav-number">1.1.33.</span> <span class="nav-text">33.IO函子</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#34-Folktale"><span class="nav-number">1.1.34.</span> <span class="nav-text">34.Folktale</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#35-Task-函子"><span class="nav-number">1.1.35.</span> <span class="nav-text">35.Task 函子</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#36-Pointed函子"><span class="nav-number">1.1.36.</span> <span class="nav-text">36.Pointed函子</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#37-IO函子问题"><span class="nav-number">1.1.37.</span> <span class="nav-text">37.IO函子问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#38-Monad-函子"><span class="nav-number">1.1.38.</span> <span class="nav-text">38.Monad 函子</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#39-总结"><span class="nav-number">1.1.39.</span> <span class="nav-text">39.总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#任务二：JavaScript-异步编程"><span class="nav-number">1.2.</span> <span class="nav-text">任务二：JavaScript 异步编程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-概述"><span class="nav-number">1.2.1.</span> <span class="nav-text">1.概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-同步模式"><span class="nav-number">1.2.2.</span> <span class="nav-text">2.同步模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-异步模式"><span class="nav-number">1.2.3.</span> <span class="nav-text">3.异步模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-回调函数"><span class="nav-number">1.2.4.</span> <span class="nav-text">4.回调函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-Promise-概述"><span class="nav-number">1.2.5.</span> <span class="nav-text">5.Promise 概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-Promise-基本用法"><span class="nav-number">1.2.6.</span> <span class="nav-text">6.Promise 基本用法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-Promise-使用案例"><span class="nav-number">1.2.7.</span> <span class="nav-text">7.Promise 使用案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-Promise-常见误区"><span class="nav-number">1.2.8.</span> <span class="nav-text">8.Promise 常见误区</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-Promise-链式调用"><span class="nav-number">1.2.9.</span> <span class="nav-text">9.Promise 链式调用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-Promise-异常处理"><span class="nav-number">1.2.10.</span> <span class="nav-text">10.Promise 异常处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-Promise-静态方法"><span class="nav-number">1.2.11.</span> <span class="nav-text">11.Promise 静态方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-Promise-并行执行"><span class="nav-number">1.2.12.</span> <span class="nav-text">12.Promise 并行执行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-Promise-执行时序"><span class="nav-number">1.2.13.</span> <span class="nav-text">13.Promise 执行时序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-Generator-异步方案-上"><span class="nav-number">1.2.14.</span> <span class="nav-text">14.Generator 异步方案(上)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#15-Generator-异步方案-中"><span class="nav-number">1.2.15.</span> <span class="nav-text">15.Generator 异步方案(中)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#16-Generator-异步方案-下"><span class="nav-number">1.2.16.</span> <span class="nav-text">16.Generator 异步方案(下)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#16-Async-函数"><span class="nav-number">1.2.17.</span> <span class="nav-text">16.Async 函数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#任务三：手写Promise源码"><span class="nav-number">1.3.</span> <span class="nav-text">任务三：手写Promise源码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Promise-类核心逻辑实现"><span class="nav-number">1.3.1.</span> <span class="nav-text">1.Promise 类核心逻辑实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-在Promise-类中加入异步逻辑"><span class="nav-number">1.3.2.</span> <span class="nav-text">2.在Promise 类中加入异步逻辑</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-实现-then-方法多次调用添加多个处理函数"><span class="nav-number">1.3.3.</span> <span class="nav-text">3.实现 then 方法多次调用添加多个处理函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-实现-then-方法的链式调用-一"><span class="nav-number">1.3.4.</span> <span class="nav-text">4.实现 then 方法的链式调用(一)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-实现-then-方法的链式调用-二"><span class="nav-number">1.3.5.</span> <span class="nav-text">5.实现 then 方法的链式调用(二)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-then-方法链式调用识别-Promise-对象自返回"><span class="nav-number">1.3.6.</span> <span class="nav-text">6.then 方法链式调用识别 Promise 对象自返回</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-捕获错误及-then-链式调用其他状态码补充"><span class="nav-number">1.3.7.</span> <span class="nav-text">7.捕获错误及 then 链式调用其他状态码补充</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-将-then-方法的参数变成可选参数"><span class="nav-number">1.3.8.</span> <span class="nav-text">8.将 then 方法的参数变成可选参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-Proimise-all-方法的实现"><span class="nav-number">1.3.9.</span> <span class="nav-text">9.Proimise.all 方法的实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-Proimise-resolve-方法的实现"><span class="nav-number">1.3.10.</span> <span class="nav-text">10.Proimise.resolve 方法的实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-finally-方法的实现"><span class="nav-number">1.3.11.</span> <span class="nav-text">11.finally 方法的实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-catch-方法的实现"><span class="nav-number">1.3.12.</span> <span class="nav-text">12.catch 方法的实现</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">FY</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
