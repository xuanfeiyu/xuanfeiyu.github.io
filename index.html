<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="Just Be Yourself">
<meta property="og:type" content="website">
<meta property="og:title" content="旋の飞羽">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="旋の飞羽">
<meta property="og:description" content="Just Be Yourself">
<meta property="article:author" content="FY">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>旋の飞羽</title>
  








<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">旋の飞羽</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">人间值得，未来可期。</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/03/29/46/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="FY">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="旋の飞羽">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2022/03/29/46/" itemprop="url">前端知识官网</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2022-03-29T00:00:00+08:00">
                2022-03-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index">
                    <span itemprop="name">前端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>作者：FY<br>引用请标明出处</p>
</blockquote>
<ul>
<li><p>vue2：<a href="https://cn.vuejs.org/index.html" target="_blank" rel="noopener">https://cn.vuejs.org/index.html</a></p>
</li>
<li><p>vue3：<a href="https://v3.cn.vuejs.org/" target="_blank" rel="noopener">https://v3.cn.vuejs.org/</a></p>
</li>
<li><p>vue-cli：<a href="https://cli.vuejs.org/zh/index.html" target="_blank" rel="noopener">https://cli.vuejs.org/zh/index.html</a></p>
</li>
<li><p>react：<a href="https://react.docschina.org/" target="_blank" rel="noopener">https://react.docschina.org/</a></p>
</li>
<li><p>react native：<a href="https://reactnative.cn/" target="_blank" rel="noopener">https://reactnative.cn/</a></p>
</li>
<li><p>webpack：<a href="https://webpack.docschina.org/" target="_blank" rel="noopener">https://webpack.docschina.org/</a></p>
</li>
<li><p>vite：<a href="https://vitejs.cn/" target="_blank" rel="noopener">https://vitejs.cn/</a></p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/08/12/45/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="FY">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="旋の飞羽">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/08/12/45/" itemprop="url">学习笔记 ----- 【Node.js 全栈开发】Node.js 高级编程（核心模块、模块加载机制）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-08-12T00:00:00+08:00">
                2021-08-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index">
                    <span itemprop="name">前端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>作者：FY<br>引用请标明出处</p>
</blockquote>
<h1 id="Part-5-·-Node-js-全栈开发"><a href="#Part-5-·-Node-js-全栈开发" class="headerlink" title="Part 5 · Node.js 全栈开发"></a>Part 5 · Node.js 全栈开发</h1><h2 id="模块一-·-Node-js-高级编程（核心模块、模块加载机制）"><a href="#模块一-·-Node-js-高级编程（核心模块、模块加载机制）" class="headerlink" title="模块一 · Node.js 高级编程（核心模块、模块加载机制）"></a>模块一 · Node.js 高级编程（核心模块、模块加载机制）</h2><h2 id="node-基础"><a href="#node-基础" class="headerlink" title="node 基础"></a>node 基础</h2><h3 id="1-课程概述"><a href="#1-课程概述" class="headerlink" title="1.课程概述"></a>1.课程概述</h3><p>大前端开发的必备技能</p>
<blockquote>
<p>Nodejs 可以做什么？</p>
</blockquote>
<ul>
<li>轻量级、高性能的Web服务</li>
<li>前后端 JavaScript 同构开发</li>
<li>便捷高效的前端工程化</li>
</ul>
<p>Nodejs的架构和运行过程<br>Nodejs异步IO和事件驱动<br>Nodejs单线程<br>Nodejs实现API服务<br>Nodejs核心模块及API使用</p>
<h3 id="2-Nodejs-架构"><a href="#2-Nodejs-架构" class="headerlink" title="2.Nodejs 架构"></a>2.Nodejs 架构</h3><blockquote>
<p>Natives modules</p>
</blockquote>
<ul>
<li>当前层内容由 JS 实现</li>
<li>提供应用程序可直接调用库，例如fs、path、http等</li>
<li>JS 语言无法直接操作底层硬件设置</li>
</ul>
<blockquote>
<p>Bulitin modules “胶水层”</p>
</blockquote>
<blockquote>
<p>底层</p>
</blockquote>
<ul>
<li>v8：执行 JS 代码，提供桥梁接口</li>
<li>Libuv：事件循环、事件队列、异步IO</li>
</ul>
<h3 id="3-为什么是Nodejs"><a href="#3-为什么是Nodejs" class="headerlink" title="3.为什么是Nodejs"></a>3.为什么是Nodejs</h3><p>Reactor模式，单线程完成多线程工作<br>Reactor模式下实现异步IO、事件驱动<br>Nodejs更适用于IO密集型高并发请求</p>
<h3 id="4-Nodejs异步IO"><a href="#4-Nodejs异步IO" class="headerlink" title="4.Nodejs异步IO"></a>4.Nodejs异步IO</h3><p>期望实现无须主动判断的非阻塞IO</p>
<blockquote>
<p>异步IO总结</p>
</blockquote>
<ul>
<li>IO是应用程序的瓶颈所在</li>
<li>异步IO提高性能无须原地等待结果返回</li>
<li>IO操作属于操作系统级别，平台都有对应实现</li>
<li>Nodejs 单线程配合事件驱动架构及libbuv实现了异步IO</li>
</ul>
<h3 id="5-事件驱动架构"><a href="#5-事件驱动架构" class="headerlink" title="5.事件驱动架构"></a>5.事件驱动架构</h3><p>事件驱动架构是软件开发中的通用模式<br>主体发布消息，其它实例接收消息</p>
<h3 id="6-Nodejs单线程"><a href="#6-Nodejs单线程" class="headerlink" title="6.Nodejs单线程"></a>6.Nodejs单线程</h3><blockquote>
<p>单线程如何实现高并发？</p>
</blockquote>
<p>异步非阻塞IO配合事件回调通知</p>
<blockquote>
<p>Nodejs主线程是单线程</p>
</blockquote>
<h3 id="7-Nodejs应用场景"><a href="#7-Nodejs应用场景" class="headerlink" title="7.Nodejs应用场景"></a>7.Nodejs应用场景</h3><ul>
<li>IO密集型高并发请求</li>
<li>操作数据库提供API服务</li>
<li>实时聊天应用程序</li>
<li>Nodejs更加适合IO密集型任务</li>
</ul>
<h3 id="8-Nodejs实现API服务"><a href="#8-Nodejs实现API服务" class="headerlink" title="8.Nodejs实现API服务"></a>8.Nodejs实现API服务</h3><ul>
<li>npm init -y</li>
<li>npm i typescript -g</li>
<li>tsc –init</li>
<li>npm i ts-node</li>
<li>npm i express</li>
<li>npm i @types/express -D</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        'name':'zce',</span><br><span class="line">        'age':'38',</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        'name':'syy',</span><br><span class="line">        'age':'18',</span><br><span class="line">    &#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// data.ts</span></span><br><span class="line"><span class="comment">// tsconfig.json   resolveJsonModule: true</span></span><br><span class="line"><span class="keyword">import</span> list <span class="keyword">from</span> <span class="string">'./list.json'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> DataStore&#123;</span><br><span class="line">    <span class="keyword">static</span> list = list</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// require 在ts不支持</span></span><br><span class="line"><span class="keyword">import</span> express <span class="keyword">from</span> <span class="string">'express'</span></span><br><span class="line"><span class="keyword">import</span> &#123;DataStore&#125; <span class="keyword">from</span> <span class="string">'./data'</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(DataStore.list)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>,<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;</span><br><span class="line"><span class="comment">//   res.end('1122')</span></span><br><span class="line">res.json(DataStore.list)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">8080</span>,<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'服务已经开启了'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="9-Nodejs全局对象"><a href="#9-Nodejs全局对象" class="headerlink" title="9.Nodejs全局对象"></a>9.Nodejs全局对象</h3><blockquote>
<p>Nodejs全局对象</p>
</blockquote>
<ul>
<li>与浏览器平台的 window 不完全相同</li>
<li>Nodejs全局对象上挂载许多属性</li>
</ul>
<p>全局对象是Javascript中的特殊对象，Nodejs 中全局对象是 global。<br>Global的根本作用就是作为宿主。<br>全局对象可以看做是全局变量的宿主。</p>
<blockquote>
<p>Nodejs 常见的全局变量</p>
</blockquote>
<ul>
<li>__filName: 返回正在执行脚本文件的绝对路径</li>
<li>__dirName: 返回正在执行脚本所在目录</li>
<li>timer类函数: 执行顺序与事件循环间的关系</li>
<li>process: 提供与当前进程互动的接口</li>
<li>require: 实现模块的加载</li>
<li>module、exports: 处理模块的导出</li>
</ul>
<p>** 默认情况 this 是空对象，和 global 并不是一样的 **</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="keyword">this</span> == global) <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>==global)  <span class="comment">// true</span></span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<h3 id="10-全局变量-process-1"><a href="#10-全局变量-process-1" class="headerlink" title="10.全局变量-process-1"></a>10.全局变量-process-1</h3><ul>
<li>无须 require 可直接使用</li>
<li>获取进程信息</li>
<li>执行进程操作</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.资源：cpu 内存</span></span><br><span class="line"><span class="comment">// console.log(process.memoryUsage())</span></span><br><span class="line"><span class="comment">// console.log(process.cpuUsage())</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2 运行环境：运行目录、node环境、cpu架构、用户环境、系统平台</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(process.cwd())</span><br><span class="line"><span class="built_in">console</span>.log(process.version)</span><br><span class="line"><span class="built_in">console</span>.log(process.versions)</span><br><span class="line"><span class="built_in">console</span>.log(process.arch)  <span class="comment">// x64</span></span><br><span class="line"><span class="built_in">console</span>.log(process.env.NODE_ENV)</span><br><span class="line"><span class="built_in">console</span>.log(process.env.PATH)</span><br><span class="line"><span class="built_in">console</span>.log(process.env.USERPROFILE) <span class="comment">// 管理员目录 mac =&gt; HOME</span></span><br><span class="line"><span class="built_in">console</span>.log(process.platform) <span class="comment">// win32</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3 运行状态：启动参数、PID、运行时间</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(process.argv)</span><br><span class="line"><span class="built_in">console</span>.log(process.argv0) <span class="comment">// 注意：没有 argv1</span></span><br><span class="line"><span class="built_in">console</span>.log(process.pid)</span><br><span class="line"><span class="built_in">console</span>.log(process.uptime())</span><br></pre></td></tr></table></figure>

<h3 id="11-全局变量-process-2"><a href="#11-全局变量-process-2" class="headerlink" title="11.全局变量-process-2"></a>11.全局变量-process-2</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 4 事件</span></span><br><span class="line">process.on(<span class="string">'exit'</span>,(code)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'exit'</span> + code)</span><br><span class="line">    <span class="comment">// 只能写同步代码</span></span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="number">123</span>)</span><br><span class="line">    &#125;,<span class="number">1000</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">process.on(<span class="string">'beoforeExit'</span>,(code)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'beofore exit'</span> + code)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">process.exit()</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'代码执行完了'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5 标准输出 输入 错误</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log = <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    process.stdout.write(<span class="string">'----'</span> + data + <span class="string">'\n'</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line">fs.createReadStream(<span class="string">'test.txt'</span>).pipe(process.stdout)</span><br><span class="line"></span><br><span class="line">process.stdin.pipe(process.stdout)</span><br><span class="line"></span><br><span class="line">process.stdin.setEncoding(<span class="string">'utf-8'</span>)</span><br><span class="line">process.stdin.on(<span class="string">'readable'</span>,()=&gt;&#123;</span><br><span class="line">    <span class="keyword">let</span> chunk = process.stdin.read()</span><br><span class="line">    <span class="keyword">if</span>(chunk!=<span class="literal">null</span>)&#123;</span><br><span class="line">        process.stdout.write(<span class="string">'data'</span> + chunk)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="模块二-·-核心模块"><a href="#模块二-·-核心模块" class="headerlink" title="模块二 · 核心模块"></a>模块二 · 核心模块</h2><h3 id="1-核心模块-path-1"><a href="#1-核心模块-path-1" class="headerlink" title="1.核心模块-path-1"></a>1.核心模块-path-1</h3><p>内置模块，require 之后直接使用<br>用于处理文件/目录的路径</p>
<blockquote>
<p>path 模块常用 API</p>
</blockquote>
<ul>
<li>basename() 获取路径中基础名称</li>
<li>dirname() 获取路径中目录名称</li>
<li>extname() 获取路径中扩展名称</li>
<li>isAbsolute() 获取路径是否为绝对路径</li>
<li>join() 拼接多个路径片段</li>
<li>resolve() 返回绝对路径</li>
<li>pasre() 解析路径</li>
<li>format() 序列化路径</li>
<li>normalize() 规范化路径</li>
</ul>
<h3 id="2-核心模块-path-2"><a href="#2-核心模块-path-2" class="headerlink" title="2.核心模块-path-2"></a>2.核心模块-path-2</h3><p>略</p>
<h3 id="3-全局变量之Buffer"><a href="#3-全局变量之Buffer" class="headerlink" title="3.全局变量之Buffer"></a>3.全局变量之Buffer</h3><p>Buffer 缓冲区<br>Buffer 让 Javascript 可以操作二进制<br>Javascript 语言起初服务于浏览器平台<br>Nodejs 平台下 Javascript 可实现 IO<br>IO 行为操作的就是二进制数据<br>Stream 流操作并非 Nodejs 独创<br>流操作配合管道实现数据分段传输<br>数据的端到端传输会有生产者和消费者<br>生产和消费的过程往往存在等待<br>产生等待时数据存放在哪？<br>Nodejs 中 Buffer 是一片内存空间</p>
<blockquote>
<p>Buffer 总结</p>
</blockquote>
<ul>
<li>无须 require 的一个全局变量</li>
<li>实现 Nodejs 平台下的二进制数据操作</li>
<li>不占据 V8 堆内存大小的内存空间</li>
<li>内存的使用由 Node 来控制，由 V8 的 GC 回收</li>
<li>一般配合 Stream 流使用，充当数据缓冲区</li>
</ul>
<h3 id="4-创建Buffer"><a href="#4-创建Buffer" class="headerlink" title="4.创建Buffer"></a>4.创建Buffer</h3><p>Buffer 是 Nodejs 的内置类<br>了解如何创建 Buffer 实例</p>
<blockquote>
<p>创建 Buffer 实例</p>
</blockquote>
<ul>
<li>alloc: 创建指定字节大小的 buffer</li>
<li>allocUnsafe: 创建指定大小的 buffer （不安全）</li>
<li>from: 接收数据，创建 buffer</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> b1 = Buffer.alloc(<span class="number">10</span>)</span><br><span class="line"><span class="keyword">const</span> b2 = Buffer.allocUnsafe(<span class="number">10</span>)</span><br><span class="line"><span class="built_in">console</span>.log(b1)</span><br><span class="line"><span class="built_in">console</span>.log(b2)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> b3 = Buffer.from(<span class="string">'1'</span>,<span class="string">'utf-8'</span>)</span><br><span class="line"><span class="built_in">console</span>.log(b3)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> b4 = Buffer.from([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>])</span><br><span class="line"><span class="built_in">console</span>.log(b4)</span><br></pre></td></tr></table></figure>

<h3 id="5-Buffer实例方法"><a href="#5-Buffer实例方法" class="headerlink" title="5.Buffer实例方法"></a>5.Buffer实例方法</h3><ul>
<li>fill: 使用数据填充 buffer</li>
<li>write: 向 buffer 中写入数据</li>
<li>toString: 从 buffer 中提取数据</li>
<li>slice: 截取 buffer</li>
<li>indexOf: 在 buffer 中查找数据</li>
<li>copy: 拷贝 buffer 中的数据</li>
</ul>
<h3 id="6-Buffer静态方法"><a href="#6-Buffer静态方法" class="headerlink" title="6.Buffer静态方法"></a>6.Buffer静态方法</h3><ul>
<li>concat: 将多个 buffer 拼接成一个新的 buffer</li>
<li>isBuffer: 判断当前数据是否为 buffer</li>
</ul>
<h3 id="7-Buffer-split实现"><a href="#7-Buffer-split实现" class="headerlink" title="7.Buffer-split实现"></a>7.Buffer-split实现</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ArrayBuffer</span>.proptoype.split = <span class="function"><span class="keyword">function</span>(<span class="params">sep</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> len = Buffer.from(sep).length</span><br><span class="line">    <span class="keyword">let</span> ret = []</span><br><span class="line">    <span class="keyword">let</span> start = <span class="number">0</span></span><br><span class="line">    <span class="keyword">let</span> offset = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(offset = <span class="keyword">this</span>.indexOf(sep,start)!==<span class="number">-1</span>)&#123;</span><br><span class="line">        ret.push(<span class="keyword">this</span>.slice(start,offset))</span><br><span class="line">        start = offset + len</span><br><span class="line">    &#125;</span><br><span class="line">    ret.push(<span class="keyword">this</span>.slice(start))</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-核心模块之FS"><a href="#8-核心模块之FS" class="headerlink" title="8.核心模块之FS"></a>8.核心模块之FS</h3><p>FS 是内置核心模块，提供文件系统操作的 API</p>
<blockquote>
<p>FS 模块结构</p>
</blockquote>
<ul>
<li>FS 基本操作类</li>
<li>FS 常用API</li>
</ul>
<p>权限位、标识符、文件描述符</p>
<p>用户对于文件所具备的操作权限<br>Nodejs 中 flag 表示对文件操作方式</p>
<blockquote>
<p>常见 flag 操作符</p>
</blockquote>
<ul>
<li>r: 表示可读</li>
<li>w: 表示可写</li>
<li>s: 表示同步</li>
<li>+: 表示执行相反操作</li>
<li>x: 表示排它操作</li>
<li>a: 表示追加操作</li>
</ul>
<p>fd 就是操作系统分配给被打开文件的标识</p>
<h3 id="9-文件操作API"><a href="#9-文件操作API" class="headerlink" title="9.文件操作API"></a>9.文件操作API</h3><ul>
<li>readFile: 从指定文件中读取数据</li>
<li>writeFile: 向指定文件中写入数据</li>
<li>appendFile: 追加的方式向指定文件中写入数据</li>
<li>copyFile: 将谋个文件中的数据拷贝至另一文件</li>
<li>watchFile: 对指定文件进行监控</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>) </span><br><span class="line"><span class="comment">// readFile</span></span><br><span class="line">fs.readFile(path.resolve(<span class="string">'data.txt'</span>),<span class="string">'utf-8'</span>,(err,data)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err)</span><br><span class="line">  <span class="keyword">if</span>(!<span class="literal">null</span>)&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(data)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// writeFile</span></span><br><span class="line">fs.writeFile(<span class="string">'data.txt'</span>, <span class="string">'hello node.js'</span>,&#123;</span><br><span class="line">    mode: <span class="number">438</span>,</span><br><span class="line">    flag: <span class="string">'r+'</span>,</span><br><span class="line">    encoding: <span class="string">'utf-8'</span>,</span><br><span class="line">&#125;,(err)=&gt;&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span>(!err)&#123;</span><br><span class="line">        fs.readFile(<span class="string">'data.txt'</span>,<span class="string">'utf-8'</span>,(err,data)=&gt;&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(data)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// watchFile</span></span><br><span class="line">fs.watchFile(<span class="string">'data.txt'</span>,&#123;<span class="attr">interval</span>: <span class="number">20</span>&#125;,(curr,prev)=&gt;&#123;</span><br><span class="line">    <span class="keyword">if</span>(curr.mtime !=== prev.mtime)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'文件被修改了'</span>)</span><br><span class="line">        fs.unwatchFile(<span class="string">'data.txt'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="10-md转html实现"><a href="#10-md转html实现" class="headerlink" title="10.md转html实现"></a>10.md转html实现</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> marked = <span class="built_in">require</span>(<span class="string">'marked'</span>)</span><br><span class="line"><span class="keyword">const</span> browserSync = <span class="built_in">require</span>(<span class="string">'browser-sync'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*  01 读取 md 和 css 内容</span></span><br><span class="line"><span class="comment">*  02 将上述读取出的内容替换占位符，生成一个最终需要的 Html 字符串</span></span><br><span class="line"><span class="comment">*  03 将上述的 Html 字符写入到指定的 Html 文件中</span></span><br><span class="line"><span class="comment">*  04 监听 md 文档内容的化，然后更新 html 内容</span></span><br><span class="line"><span class="comment">*  05 使用 browser-sync 来实时显示 Html 内容</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> mdPath = path.join(__dirname,process.argv[<span class="number">2</span>])</span><br><span class="line"><span class="keyword">let</span> cssPath = path.resolve(<span class="string">'github.css'</span>)</span><br><span class="line"><span class="keyword">let</span> htmlPath = mdPath.replace(path.extname(mdpath),<span class="string">'.html'</span>)</span><br><span class="line"></span><br><span class="line">fs.watchFile(mdPath,(curr,prev)=&gt;&#123;</span><br><span class="line">    <span class="keyword">if</span>(curr.mtime !=== prev.mtime)&#123;</span><br><span class="line">        fs.readFile(mdPath,<span class="string">'utf-8'</span>,(err,data)=&gt;&#123;</span><br><span class="line">           <span class="keyword">let</span> htmlStr = marked(data)</span><br><span class="line">           fs.readFile(cssPath,<span class="string">'utf-8'</span>,(err,data)=&gt;&#123;</span><br><span class="line">               <span class="keyword">let</span> retHtml = temp.repalce(<span class="string">'&#123;&#123;conteent&#125;&#125;'</span>,htmlStr).replace(<span class="string">'&#123;&#123;style&#125;&#125;'</span>,data)</span><br><span class="line">               fs.writeFile(htmlPath,retHtml,(err)=&gt;&#123;</span><br><span class="line">                   <span class="built_in">console</span>.log(<span class="string">'html 生成成功了'</span>)</span><br><span class="line">               &#125;)</span><br><span class="line">           &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">browserSync.init(&#123;</span><br><span class="line">    browser: <span class="string">''</span>,</span><br><span class="line">    server: __dirname,</span><br><span class="line">    watch: <span class="literal">true</span>,</span><br><span class="line">    index: path.basename(htmlPath)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="11-文件打开与关闭"><a href="#11-文件打开与关闭" class="headerlink" title="11.文件打开与关闭"></a>11.文件打开与关闭</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"></span><br><span class="line">fs.open(path.resolve(<span class="string">'data.txt'</span>),<span class="string">'r'</span>,(err,fd)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'fd'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">fs.open(path.resolve(<span class="string">'data.txt'</span>),<span class="string">'r'</span>,(err,fd) =&gt; &#123;</span><br><span class="line">   <span class="built_in">console</span>.log(<span class="string">'fd'</span>)</span><br><span class="line">   fs.close(fd, err =&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'关闭成功'</span>)</span><br><span class="line">   &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="12-大文件读写操作"><a href="#12-大文件读写操作" class="headerlink" title="12.大文件读写操作"></a>12.大文件读写操作</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// read: 所谓的读操作就是将数据从磁盘文件写入到 buffer 中</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> buf = Buffer.alloc(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* rfd 定位当前被打开的文件</span></span><br><span class="line"><span class="comment">* buf 用于表示当前缓冲区</span></span><br><span class="line"><span class="comment">* offset 表示当前从 buf 的哪个位置开始执行写入</span></span><br><span class="line"><span class="comment">* length 表示当前次写入的长度</span></span><br><span class="line"><span class="comment">* position 表示当前从文件的哪个位置开始读取</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">fs.open(<span class="string">'data.txt'</span>,<span class="string">'r'</span>,(err,rfd)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(rfd)</span><br><span class="line">    fs.read(rfd, buf, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, (err,readBytes,data)=&gt;&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(readBytes)</span><br><span class="line">        <span class="built_in">console</span>.log(data)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// write 将缓冲区里的内容写入到磁盘文件中</span></span><br><span class="line"></span><br><span class="line">buf = Buffer.from(<span class="string">'1234567890'</span>)</span><br><span class="line">fs.open(<span class="string">'b.txt'</span>,<span class="string">'w'</span>,(err,wfd)=&gt;&#123;</span><br><span class="line">    fs.write(wfd, buf, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, (err, written, buffer) =&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(written)</span><br><span class="line">        <span class="built_in">console</span>.log(buffer)</span><br><span class="line">        <span class="built_in">console</span>.log(buffer.toString())</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="13-文件拷贝自定义实现"><a href="#13-文件拷贝自定义实现" class="headerlink" title="13.文件拷贝自定义实现"></a>13.文件拷贝自定义实现</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 01 打开 a 文件，利用 read 将数据保存到 buffer 暂存起来</span></span><br><span class="line"><span class="comment">* 02 打开 b 文件，利用 write 将 buffer 中数据写入到 b 文件中</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> buf = Buffer.alloc(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 01 打开指定的文件</span></span><br><span class="line">fs.open(<span class="string">'a.txt'</span>, <span class="string">'r'</span>, (err,rfd) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 03 打开 b 文件，用于执行数据写入操作</span></span><br><span class="line">    fs.open(<span class="string">'b.txt'</span>, <span class="string">'w'</span>, (err, wfd) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 02 从打开的文件中读取数据</span></span><br><span class="line">        fs.read(rfd, buf, <span class="number">0</span>, <span class="number">10</span>, <span class="number">0</span>, (err, readBytes,buffer) =&gt; &#123;</span><br><span class="line">          <span class="comment">// 04 将 buffer 中的数据写入到 b.txt 当中</span></span><br><span class="line">          fs.write(wfd, buf, <span class="number">0</span>, <span class="number">10</span>, <span class="number">0</span>, (err, written) =&gt; &#123;</span><br><span class="line">              <span class="built_in">console</span>.log(<span class="string">'写入成功'</span>)</span><br><span class="line">          &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 02 数据的完全拷贝</span></span><br><span class="line">fs.open(<span class="string">'a.txt'</span>, <span class="string">'r'</span>, (err,rfd) =&gt; &#123;</span><br><span class="line">    fs.open(<span class="string">'b.txt'</span>, <span class="string">'a+'</span>, (err, wfd) =&gt; &#123;</span><br><span class="line">        fs.read(rfd, buf, <span class="number">0</span>, <span class="number">10</span>, <span class="number">0</span>, (err, readBytes) =&gt; &#123;</span><br><span class="line">           fs.write(wfd, buf, <span class="number">0</span>, <span class="number">10</span>, <span class="number">0</span>, (err, written) =&gt; &#123;</span><br><span class="line">                fs.read(rfd, buf, <span class="number">0</span>, <span class="number">5</span>, <span class="number">0</span>, (err, readBytes) =&gt; &#123;</span><br><span class="line">                    fs.write(wfd, buf, <span class="number">0</span>, <span class="number">5</span>, <span class="number">10</span>, (err, written) =&gt; &#123;</span><br><span class="line">                        <span class="built_in">console</span>.log(<span class="string">'写入成功'</span>)</span><br><span class="line">                   &#125;)</span><br><span class="line">               &#125;)</span><br><span class="line">          &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> BUFFER_SIZE = buf.length</span><br><span class="line"><span class="keyword">let</span> readOffset = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">fs.open(<span class="string">'a.txt'</span>, <span class="string">'r'</span>, (err,rfd) =&gt; &#123;</span><br><span class="line">  fs.open(<span class="string">'b.txt'</span>, <span class="string">'a+'</span>, (err, wfd) =&gt; &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        fs.read(rfd, buf, <span class="number">0</span>, BUFFER_SIZE, readOffset, (err, readBytes) =&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span>(!readBytes)&#123;</span><br><span class="line">                <span class="comment">// 如果条件成立，说明内容已经读取完毕</span></span><br><span class="line">                fs.close(rfd,() =&gt; &#123;&#125;)</span><br><span class="line">                fs.close(wfd,() =&gt; &#123;&#125;)</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">'拷贝完成'</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            readOffset += readBytes</span><br><span class="line">            fs.write(wfd, buf, <span class="number">0</span>, readBytes, (err, written) =&gt; &#123;</span><br><span class="line">                next()</span><br><span class="line">           &#125;)</span><br><span class="line">       &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">     next()</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="14-目录操作API"><a href="#14-目录操作API" class="headerlink" title="14.目录操作API"></a>14.目录操作API</h3><blockquote>
<p>常见目录操作 API</p>
</blockquote>
<ul>
<li>access: 判断文件或目录是否具有操作权限</li>
<li>stat: 获取目录及文件信息</li>
<li>mkdir: 创建目录</li>
<li>rmdir: 删除目录</li>
<li>readdir: 读取目录中内容</li>
<li>unlink: 删除指定而文件</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 01 access</span></span><br><span class="line">fs.access(<span class="string">'a.txt'</span>, (err) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span>(err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'有操作权限'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 02 stat</span></span><br><span class="line">fs.stat(<span class="string">'a.txt'</span>, (err,statObj) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(statObj.size)</span><br><span class="line">    <span class="built_in">console</span>.log(statObj.isFile())</span><br><span class="line">    <span class="built_in">console</span>.log(statObj.isDirectory())</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 03 mkdir</span></span><br><span class="line">fs.mkdir(<span class="string">'a/b/c'</span>, &#123;<span class="attr">recursive</span>: <span class="literal">true</span>&#125;, (err) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span>(!err)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'创建成功'</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 04 rmdir</span></span><br><span class="line">fs.rmdir(<span class="string">'a'</span>, &#123;<span class="attr">recursive</span>: <span class="literal">true</span>&#125;, (err) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span>(!err)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'删除成功'</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 05 readdir</span></span><br><span class="line">fs.readdir(<span class="string">'a'</span>, (err,files) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(files)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 05 unlink</span></span><br><span class="line">fs.unlink(<span class="string">'a/a.txt'</span>, (err) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span>(!err)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'删除成功'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="15-目录创建之同步实现"><a href="#15-目录创建之同步实现" class="headerlink" title="15.目录创建之同步实现"></a>15.目录创建之同步实现</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 01 将来调用需要接收类似于 a/b/c，这样的路径，它们之间是采用 / 进行链接</span></span><br><span class="line"><span class="comment">* 02 利用 / 分割符将路径进行拆分，将每一项放入一个数组中进行管理 ['a','b','c']</span></span><br><span class="line"><span class="comment">* 03 对上述的数组进行遍历，我们需要拿到每一项，然后与前一项进行拼接 /</span></span><br><span class="line"><span class="comment">* 04 判断一个当前对拼接之后的路径是否具有可操作的权限，如果有则证明存在，否则的话就需要执行创建</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeDirSync</span>(<span class="params">dirPath</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> items = dirPath.split(path.sep)</span><br><span class="line">    <span class="built_in">console</span>.log(path.sep)</span><br><span class="line">    <span class="built_in">console</span>.log(items)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">1</span>; i &lt;= items.length; i++)&#123;</span><br><span class="line">        <span class="keyword">let</span> dir = items.slice(<span class="number">0</span>, <span class="number">1</span>).join(path.sep)</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            fs.accessSync(dir)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            fs.mkdirSync(dir)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">makeDirSync(<span class="string">'a\\b\\c'</span>)</span><br></pre></td></tr></table></figure>

<h3 id="16-目录创建之异步实现"><a href="#16-目录创建之异步实现" class="headerlink" title="16.目录创建之异步实现"></a>16.目录创建之异步实现</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mkDir</span>(<span class="params">dirPath, cb</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> parts = dirPath.split(<span class="string">'/'</span>)</span><br><span class="line">    <span class="keyword">let</span> index = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(index &gt; parts.length) <span class="keyword">return</span> cb &amp;&amp; cb()</span><br><span class="line">        <span class="keyword">let</span> current = parts.slice(<span class="number">0</span>, index++).join(<span class="string">'/'</span>)</span><br><span class="line"></span><br><span class="line">        fs.access(current, (err) =&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span>(err) &#123;</span><br><span class="line">                fs.mkdir(current, next)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                next()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    next()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mkDir(<span class="string">'a/b/c'</span>,()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'创建成功'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 将 access 与 mkdir 处理成 async... 风格</span></span><br><span class="line"><span class="keyword">const</span> access = promisify(fs.access)</span><br><span class="line"><span class="keyword">const</span> mkdir = promisify(fs.mkdir)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">myMkdir</span>(<span class="params">dirPath,cb</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> parts = dirPath.split(<span class="string">'/'</span>)</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">let</span> index = <span class="number">1</span>; index &lt;= parts.length; index++) &#123;</span><br><span class="line">     <span class="keyword">let</span> current = parts.slice(<span class="number">0</span>, index).join(<span class="string">'/'</span>)</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="keyword">await</span> acccess(current)</span><br><span class="line">     &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">         <span class="keyword">await</span> mkDir(current)</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  cb &amp;&amp; cb()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="17-目录删除之异步实现"><a href="#17-目录删除之异步实现" class="headerlink" title="17.目录删除之异步实现"></a>17.目录删除之异步实现</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 需求: 自定义一个函数，接收一个路径，然后执行删除</span></span><br><span class="line"><span class="comment">* 01 判断当前传入的路径是否为一个文件，直接删除当前文件即可</span></span><br><span class="line"><span class="comment">* 02 如果当前传入的是一个目录，我们需要继续读取目录中的内容，然后再执行删除操作</span></span><br><span class="line"><span class="comment">* 03 将删除行为定义成一个函数，然后通过递归地方式进行复用</span></span><br><span class="line"><span class="comment">* 04 将当前的名称拼接成在删除时可使用的路径</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myRmdir</span>(<span class="params">dirPath,cb</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 判断当前 dirPath 的类型</span></span><br><span class="line">    fs.stat(dirPath,(err,statObj) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span>(statObj.isDirectory())&#123;</span><br><span class="line">            <span class="comment">// 目录 ---&gt; 继续读取</span></span><br><span class="line">            fs.readdir(dirPath,(err,files) =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> dirs = files.map(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> path.join(dirPath, item)</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="built_in">console</span>.log(dirs)</span><br><span class="line">                <span class="keyword">let</span> index = <span class="number">0</span></span><br><span class="line">                <span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                    <span class="keyword">if</span>(index === dirs.length) <span class="keyword">return</span> fs.rmdir(dirPatn, cb)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">let</span> current = dirs[index++]</span><br><span class="line"></span><br><span class="line">                    myRmdir(current,next)</span><br><span class="line">                &#125;</span><br><span class="line">                next()</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 文件 ---&gt; 直接删除</span></span><br><span class="line">            fs.unlink(dirPath,cb)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">myRmdir(<span class="string">'data1.txt'</span>,() =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'删除成功了'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="18-模块化历程"><a href="#18-模块化历程" class="headerlink" title="18.模块化历程"></a>18.模块化历程</h3><blockquote>
<p>传统开发常见问题</p>
</blockquote>
<ul>
<li>命名冲突和污染</li>
<li>代码冗余，无效请求多</li>
<li>文件间的依赖关系复杂</li>
</ul>
<blockquote>
<p>常见模块化规范</p>
</blockquote>
<ul>
<li>Commonjs 规范</li>
<li>AMD 规范</li>
<li>CMD 规范</li>
<li>ES modules 规范</li>
</ul>
<blockquote>
<p>模块化规范</p>
</blockquote>
<ul>
<li>模块化是前端走向工程化的重要一环</li>
<li>早期 JavaScript 语言层面没有模块化规范</li>
<li>Commonjs、AMD、CMD 都是模块化规范</li>
<li>ES6 中将模块化纳入标准规范</li>
<li>当下常用规范是 Commonjs 与 ESM</li>
</ul>
<h3 id="19-CommonJS规范"><a href="#19-CommonJS规范" class="headerlink" title="19.CommonJS规范"></a>19.CommonJS规范</h3><blockquote>
<p>CommonJs 规范</p>
</blockquote>
<ul>
<li>模块引用</li>
<li>模块定义</li>
<li>模块标识</li>
</ul>
<blockquote>
<p>Nodejs与CommonJs</p>
</blockquote>
<ul>
<li>任意一个文件就是一模块，具有独立作用域</li>
<li>使用 require 导入其它模块</li>
<li>将模块ID传入 require 实现目标模块定位</li>
</ul>
<blockquote>
<p>module 属性</p>
</blockquote>
<ul>
<li>任意js文件就是一个模块，可以直接使用module属性</li>
<li>id: 返回模块标识符，一般是一个绝对路径</li>
<li>filename: 返回文件模块的绝对路径</li>
<li>loaded: 返回布尔值，表示模块是否完成加载</li>
<li>parent: 返回对象存放调用当前模块的模块</li>
<li>children: 返回数组，存放当前模块调用的其它模块</li>
<li>exports: 返回当前模块需要暴露的内容</li>
<li>paths: 返回数组，存放不同目录下的node_modules位置</li>
</ul>
<blockquote>
<p>require 属性</p>
</blockquote>
<ul>
<li>基本功能是读入并且执行一个模块文件</li>
<li>resolve: 返回模块文件绝对路径</li>
<li>extentions: 依据不同后缀名执行解析操作</li>
<li>main: 返回主模块对象</li>
</ul>
<blockquote>
<p>CommonJs 规范</p>
</blockquote>
<ul>
<li>CommonJs 规范起初是为了弥补 JS 语言模块化缺陷</li>
<li>CommonJs 是语言层面的规范，当前主要用于Node.js</li>
<li>CommonJs 规定模块化分为引入、定义、标识符三个部分</li>
<li>Module 在任意模块中可直接使用包含模块信息</li>
<li>Require 接收标识符，加载目标模块</li>
<li>Exports 与 module.exports 都能导出模块数据</li>
<li>CommonJs 规范定义模块的加载是同步完成</li>
</ul>
<h3 id="20-Nodejs与CommonJS"><a href="#20-Nodejs与CommonJS" class="headerlink" title="20.Nodejs与CommonJS"></a>20.Nodejs与CommonJS</h3><ul>
<li>使用 module.exports 与 require 实现模块导入与导出</li>
<li>module 属性及其常见信息获取</li>
<li>exports 导出数据及其与 module.exports 区别</li>
<li>CommonJs 规范下的模块同步加载</li>
</ul>
<h3 id="21-模块分类及加载流程"><a href="#21-模块分类及加载流程" class="headerlink" title="21.模块分类及加载流程"></a>21.模块分类及加载流程</h3><blockquote>
<p>模块分类</p>
</blockquote>
<ul>
<li>内置模块</li>
<li>文件模块</li>
</ul>
<blockquote>
<p>模块加载速度</p>
</blockquote>
<ul>
<li>核心模块: Node 源码编译时写入到二进制文件中</li>
<li>文件模块: 代码运行时，动态加载</li>
</ul>
<blockquote>
<p>加载流程</p>
</blockquote>
<ul>
<li>路径分析: 依据标识符确定模块位置</li>
<li>文件定位: 确定目标模块中具体的文件及文件类型</li>
<li>编译执行: 采用对应的方式完成文件的编译执行</li>
</ul>
<blockquote>
<p>文件定位</p>
</blockquote>
<ul>
<li>项目下存在m1.js模块，导入时使用require(‘m1’)语法</li>
<li>m1.js -&gt; m1.json -&gt; m1.node</li>
<li>查找 pakage.json 文件，使用 JSON.parse() 解析</li>
<li>main.js -&gt; main.json -&gt; main.node</li>
<li>将 index 作为目标模块中的具体文件名称</li>
</ul>
<blockquote>
<p>编译执行</p>
</blockquote>
<ul>
<li>将某个具体类型的文件按照相应的方式进行编译和执行</li>
<li>创建新对象，按路径载入，完成编译执行</li>
</ul>
<blockquote>
<p>JS 文件的编译执行</p>
</blockquote>
<ul>
<li>使用 fs 模块同步读入目标文件内容</li>
<li>对内容进行语法包装，生成可执行 JS 函数</li>
<li>调用函数时传入 exports、module、reuire 等属性值</li>
</ul>
<blockquote>
<p>JSON 文件编译执行</p>
</blockquote>
<ul>
<li>将读取到的内容通过 JSON.parse() 进行解析</li>
</ul>
<blockquote>
<p>缓存化原则</p>
</blockquote>
<ul>
<li>提高模块加载速度</li>
<li>当前模块不存在，则经历一次完整加载流程</li>
<li>模块加载完成后，使用路径作为索引进行缓存</li>
</ul>
<blockquote>
<p>加载流程总结</p>
</blockquote>
<ul>
<li>路径分析: 确实目标模块位置</li>
<li>文件定位: 确定目标模块中的具体文件</li>
<li>编译执行: 对模块内容进行编译，返回可用 exports 对象</li>
</ul>
<h3 id="22-模块加载源码分析"><a href="#22-模块加载源码分析" class="headerlink" title="22.模块加载源码分析"></a>22.模块加载源码分析</h3><p>略</p>
<h3 id="23-VM模块使用"><a href="#23-VM模块使用" class="headerlink" title="23.VM模块使用"></a>23.VM模块使用</h3><p>创建独立运行的沙箱环境</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">'vm'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> age = <span class="number">33</span></span><br><span class="line"><span class="keyword">let</span> content = fs.readFileSync(<span class="string">'test.txt'</span>,<span class="string">'utf-8'</span>)</span><br><span class="line"></span><br><span class="line">vm.runInThisContext(<span class="string">"age += 10"</span>)</span><br><span class="line"><span class="built_in">console</span>.log(age)</span><br></pre></td></tr></table></figure>

<h3 id="24-模块加载模拟实现-1"><a href="#24-模块加载模拟实现-1" class="headerlink" title="24.模块加载模拟实现-1"></a>24.模块加载模拟实现-1</h3><blockquote>
<p>核心逻辑</p>
</blockquote>
<ul>
<li>路径分析</li>
<li>缓存优化</li>
<li>文件定位</li>
<li>编译执行</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span>   = <span class="built_in">require</span>(<span class="string">'vm'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Module</span>(<span class="params">id</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.id = id</span><br><span class="line">    <span class="keyword">this</span>.exports = &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Module._resolveFilename = funciton(filename)&#123;</span><br><span class="line">    <span class="comment">// 利用 Path 将 filename 转为绝对路径</span></span><br><span class="line">    <span class="keyword">let</span> absPath = path.resolve(__dirname,filename)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断当前路径对应的内容是否存在</span></span><br><span class="line">    <span class="keyword">if</span>(fs.existsSync(absPath)) &#123;</span><br><span class="line">        <span class="comment">// 如果条件成立则说明 absPath 对应的内容是存在的</span></span><br><span class="line">        <span class="keyword">return</span> absPath</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 文件定位</span></span><br><span class="line">      <span class="keyword">let</span> suffix = <span class="built_in">Object</span>.keys(Module._extentions)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; suffix.length;i++)&#123;</span><br><span class="line">          <span class="keyword">let</span> newPath = absPath + suffix[i]</span><br><span class="line">          <span class="keyword">if</span>(fs.existsSync(newPath)) &#123;</span><br><span class="line">              <span class="keyword">return</span> newPath</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`<span class="subst">$&#123;filename&#125;</span> is not exists`</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Module._extensions = &#123;</span><br><span class="line">    <span class="string">'.js'</span>(<span class="built_in">module</span>)&#123;</span><br><span class="line">        <span class="comment">// 读取</span></span><br><span class="line">        <span class="keyword">let</span> content = fs.readFileSync(<span class="built_in">module</span>.id,<span class="string">'utf-8'</span>)</span><br><span class="line">        <span class="built_in">console</span>.log(content)</span><br><span class="line">        <span class="comment">// 包装</span></span><br><span class="line">        content = Module.wrapper[<span class="number">0</span>] + content + Module.wrapper[<span class="number">1</span>]</span><br><span class="line">        <span class="built_in">console</span>.log(content)</span><br><span class="line">        <span class="comment">// VM</span></span><br><span class="line">        <span class="keyword">let</span> compileFn = vm.runInThisContext(content)</span><br><span class="line">        <span class="built_in">console</span>.log(compileFn)</span><br><span class="line">        <span class="comment">// 准备参数值</span></span><br><span class="line">        <span class="keyword">let</span> exports = <span class="built_in">module</span>.exports</span><br><span class="line">        <span class="keyword">let</span> dirname = path.dirname(<span class="built_in">module</span>.id)</span><br><span class="line">        <span class="keyword">let</span> filename = <span class="built_in">module</span>.id</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用</span></span><br><span class="line">        compileFn.call(exports,exports,myRequire,<span class="built_in">module</span>,__filename,__dirname)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'.json'</span>(<span class="built_in">module</span>)&#123;</span><br><span class="line">        <span class="keyword">let</span> content = <span class="built_in">JSON</span>.parse(fs.readFileSync(moduleid,<span class="string">'utf-8'</span>))</span><br><span class="line">        <span class="built_in">module</span>.exports = content</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Module.wrapper = [</span><br><span class="line">    <span class="string">"(function(exports,require,module,__filename,__dirname)&#123;"</span>,</span><br><span class="line">    <span class="string">"&#125;)"</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">Module._cache = &#123;&#125;</span><br><span class="line"></span><br><span class="line">Module.prototype.load = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> extname = path.extname(<span class="keyword">this</span>.id)</span><br><span class="line">  <span class="built_in">console</span>.log(extname)</span><br><span class="line">  Module._extensions[extname](<span class="keyword">this</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myRequire</span>(<span class="params">filename</span>) </span>&#123;</span><br><span class="line"><span class="comment">// 1 绝对路径</span></span><br><span class="line"><span class="keyword">let</span> mPath = Module._resolveFilename(filename)</span><br><span class="line"><span class="built_in">console</span>.log(mPath)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2 缓存优先</span></span><br><span class="line"><span class="keyword">let</span> cacheModule = Module._cache[mPath]</span><br><span class="line"><span class="keyword">if</span>(cacheModule) <span class="keyword">return</span> cacheModule.exports</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3 创建空对象加载目录模块</span></span><br><span class="line"><span class="keyword">let</span> <span class="built_in">module</span> = <span class="keyword">new</span> Module(mPath)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4 缓存已加载过的模块</span></span><br><span class="line">Module._cache[mPath] = <span class="built_in">module</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 5 执行加载（编译执行）</span></span><br><span class="line"><span class="built_in">module</span>.load()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6 返回数据</span></span><br><span class="line"><span class="keyword">return</span> <span class="built_in">module</span>.exports</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> obj = myRequire(<span class="string">'./v'</span>)</span><br><span class="line"><span class="built_in">console</span>.log(obj.age)</span><br></pre></td></tr></table></figure>

<h3 id="25-模块加载模拟实现-2"><a href="#25-模块加载模拟实现-2" class="headerlink" title="25.模块加载模拟实现-2"></a>25.模块加载模拟实现-2</h3><p>略</p>
<h3 id="26-事件模块"><a href="#26-事件模块" class="headerlink" title="26.事件模块"></a>26.事件模块</h3><p>通过 EventEmitter 类实现事件统一管理</p>
<blockquote>
<p>events 与 EventEmitter</p>
</blockquote>
<ul>
<li>node.js 是基于事件驱动的异步操作架构，内置 events 模块</li>
<li>events 模块提供了 EventEmitter 类</li>
<li>node.js 中很多内置核心模块继承 EventEmitter</li>
</ul>
<blockquote>
<p>EventEmitter 常见 API</p>
</blockquote>
<ul>
<li>on: 添加当事件被触发时调用的回到函数</li>
<li>emit: 触发事件，按照注册的顺序同步调用每个事件监听器</li>
<li>once: 添加当事件在注册之后首次被触发时调用的回调函数</li>
<li>off: 移除特定的监听器</li>
</ul>
<h3 id="27-发布订阅"><a href="#27-发布订阅" class="headerlink" title="27.发布订阅"></a>27.发布订阅</h3><p>定义对象间一对多的依赖关系</p>
<blockquote>
<p>发布订阅要素</p>
</blockquote>
<ul>
<li>缓存对列，存放订阅者信息</li>
<li>具有增加、删除订阅的能力</li>
<li>状态改变时通知所有订阅者执行监听</li>
</ul>
<p>发布订阅中存在调度中心<br>状态发生改变时，发布订阅无须主动通知</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PubSub</span></span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>()&#123;</span><br><span class="line">        <span class="keyword">this</span>._events = &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册</span></span><br><span class="line">    subscribe(event,callback) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>._events[event]) &#123;</span><br><span class="line">            <span class="keyword">this</span>._events[event].push(callback)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>._event[event] = [callback]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发布</span></span><br><span class="line">    publish(event,...args) &#123;</span><br><span class="line">       <span class="keyword">const</span> items = <span class="keyword">this</span>._events[event]</span><br><span class="line">       <span class="keyword">if</span>(items &amp;&amp; items.length) &#123;</span><br><span class="line">           items.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">callback</span>)</span>&#123;</span><br><span class="line">               callback.call(<span class="keyword">this</span>,...args)</span><br><span class="line">           &#125;)</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> ps = <span class="keyword">new</span> Pubsub()</span><br><span class="line">ps.subscribe(<span class="string">'事件1'</span>,()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'事件1执行了'</span>)</span><br><span class="line">&#125;)</span><br><span class="line">ps.publish(<span class="string">'事件1'</span>)</span><br></pre></td></tr></table></figure>

<h3 id="28-EventEmitter源码调试"><a href="#28-EventEmitter源码调试" class="headerlink" title="28.EventEmitter源码调试"></a>28.EventEmitter源码调试</h3><p>略</p>
<h3 id="29-EventEmitter模拟"><a href="#29-EventEmitter模拟" class="headerlink" title="29.EventEmitter模拟"></a>29.EventEmitter模拟</h3><p>略</p>
<h3 id="30-浏览器中的事件环"><a href="#30-浏览器中的事件环" class="headerlink" title="30.浏览器中的事件环"></a>30.浏览器中的事件环</h3><blockquote>
<p>完整事件环执行顺序</p>
</blockquote>
<ul>
<li>从上至下执行所有的同步代码</li>
<li>执行过程中将遇到的宏任务与微任务添加至相应的队列</li>
<li>同步代码执行完毕后，执行满足条件的微任务回调</li>
<li>微任务队列执行完毕执行所有满足需求的宏任务回调</li>
<li>循环事件环操作</li>
<li>注意: 每执行一个宏任务之后会立刻检查微任务队列</li>
</ul>
<h3 id="31-Nodejs中的事件环"><a href="#31-Nodejs中的事件环" class="headerlink" title="31.Nodejs中的事件环"></a>31.Nodejs中的事件环</h3><blockquote>
<p>对列说明</p>
</blockquote>
<ul>
<li>timers: 执行 setTimeout 与 setInterval 回调</li>
<li>pending callbacks: 执行系统操作的回调，例如 tcp udp</li>
<li>idle，prepare: 只在系统内部进行使用</li>
<li>poll: 执行与 I/O 相关的回调</li>
<li>check: 执行 setImmediate 中的回调</li>
<li>close callbacks: 执行 close 事件的回调</li>
</ul>
<blockquote>
<p>Nodejs 完整事件环</p>
</blockquote>
<ul>
<li>执行同步代码，将不同的任务添加至相应的队列</li>
<li>所有同步代码执行后会去执行满足条件微任务</li>
<li>所有微任务代码执行后会执行 timer 队列中满足的宏任务</li>
<li>timer 中的所有宏任务执行完后就会依次切换队列</li>
<li>注意: 在完成队列切换之前会先清空微任务代码</li>
</ul>
<h3 id="32-Nodejs事件环理解"><a href="#32-Nodejs事件环理解" class="headerlink" title="32.Nodejs事件环理解"></a>32.Nodejs事件环理解</h3><p>** 新版本有变化 **</p>
<h3 id="33-Nodejs与浏览器事件环区别"><a href="#33-Nodejs与浏览器事件环区别" class="headerlink" title="33.Nodejs与浏览器事件环区别"></a>33.Nodejs与浏览器事件环区别</h3><ul>
<li><p>任务队列数不同</p>
<ul>
<li>浏览器中只有两个任务队列</li>
<li>Nodejs 中有6个事件队列</li>
</ul>
</li>
<li><p>Nodejs 微任务执行时机不同</p>
<ul>
<li>两者都会在同步代码执行完毕后执行微任务</li>
<li>浏览器平台下每当一个宏任务执行完毕后就清空微任务</li>
<li>Nodejs 平台在事件队列切换时会去清空微任务</li>
</ul>
</li>
<li><p>微任务优先级不同</p>
<ul>
<li>浏览器事件环中，微任务存放于事件队列，先进先出</li>
<li>Nodejs 中的 process.nextTick 先于 promise.then</li>
</ul>
</li>
</ul>
<h3 id="34-Nodejs事件环常见问题"><a href="#34-Nodejs事件环常见问题" class="headerlink" title="34.Nodejs事件环常见问题"></a>34.Nodejs事件环常见问题</h3><p>默认 setTimeout 和 setImmdieate 顺序是随机的，但在I/O操作里面是 setImmdieate 优先</p>
<h3 id="35-核心模块之stream"><a href="#35-核心模块之stream" class="headerlink" title="35.核心模块之stream"></a>35.核心模块之stream</h3><p>ls|grep*.js</p>
<p>Node.js诞生之初就是为了提高IO性能</p>
<p>文件操作系统和网络模块实现了流接口</p>
<p>Node.js 中的流就是处理流式数据的抽象接口</p>
<p>应用程序中为什么使用流来处理数据？</p>
<blockquote>
<p>常见问题</p>
</blockquote>
<ul>
<li>同步读取资源文件，用户需要等待数据读取完成</li>
<li>资源文件最终一次性加载至内存，开销较大</li>
</ul>
<blockquote>
<p>流处理数据的优势</p>
</blockquote>
<ul>
<li>时间效率: 流的分段处理可以同时操作多个数据 chunk</li>
<li>空间效率: 同一时间流无须占据大内存空间</li>
<li>使用方便: 流配合管理，扩展程序变得简单</li>
</ul>
<p>Node.js 内置了 stream，它实现了流操作对象</p>
<blockquote>
<p>Node.js 中流的分类</p>
</blockquote>
<ul>
<li>Readable: 可读流，能够实现数据的读取</li>
<li>Writeable: 可写流，能够实现数据的写操作</li>
<li>Duplex: 双工流，既可读又可写</li>
<li>Tranform: 转换流，可读可写，还能实现数据转换</li>
</ul>
<blockquote>
<p>Node.js 流特点</p>
</blockquote>
<ul>
<li>Stream 模块实现了四个具体的抽象</li>
<li>所有流都继承自 EventEmitter</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> rs = fs.createReadStream(<span class="string">'./test.txt'</span>)</span><br><span class="line"><span class="keyword">let</span> ws = fs.createWriteStream(<span class="string">'./test1.txt'</span>)</span><br><span class="line"></span><br><span class="line">rs.pipe(ws)</span><br></pre></td></tr></table></figure>

<h3 id="36-stream之可读流"><a href="#36-stream之可读流" class="headerlink" title="36.stream之可读流"></a>36.stream之可读流</h3><p>“生产供程序消费数据的流”</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> rs = fs.createReadStream(<span class="string">'0-node.txt'</span>)</span><br><span class="line"></span><br><span class="line">rs.pipe(process.stdout)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>自定义可读流</p>
</blockquote>
<ul>
<li>继承 stream 里的 Readable</li>
<li>重写 _read 方法调用push产出数据</li>
</ul>
<h3 id="37-stream之可写流"><a href="#37-stream之可写流" class="headerlink" title="37.stream之可写流"></a>37.stream之可写流</h3><p>“用于消费数据的流”</p>
<blockquote>
<p>自定义可写流</p>
</blockquote>
<ul>
<li>继承 stream 模块的 Writeable</li>
<li>重写 _write 方法，调用 write 执行写入</li>
</ul>
<h3 id="38-stream之双工和转换流"><a href="#38-stream之双工和转换流" class="headerlink" title="38.stream之双工和转换流"></a>38.stream之双工和转换流</h3><p>Duplex 是双工流，既能生产又能消费</p>
<blockquote>
<p>自定义双工流</p>
</blockquote>
<ul>
<li>继承 Duplex 类</li>
<li>重写 _read 方法，调用 push 生产数据</li>
<li>重写 _write 方法，调用 write 消费数据</li>
</ul>
<p>Transform 也是一个双工流</p>
<blockquote>
<p>自定义转换流</p>
</blockquote>
<ul>
<li>继承 Transform 类</li>
<li>重写 _transform 方法，调用 push 和 callback</li>
<li>重写 _flush 方法，处理剩余数据</li>
</ul>
<h3 id="39-文件可读流创建和消费"><a href="#39-文件可读流创建和消费" class="headerlink" title="39.文件可读流创建和消费"></a>39.文件可读流创建和消费</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> rs = fs.createReadStream(<span class="string">'test.txt'</span>, &#123;</span><br><span class="line">    flags: <span class="string">'r'</span>,</span><br><span class="line">    encoding: <span class="literal">null</span>,</span><br><span class="line">    fd: <span class="literal">null</span>,</span><br><span class="line">    mode: <span class="number">438</span>, </span><br><span class="line">    autoClose: <span class="literal">true</span>,</span><br><span class="line">    start: <span class="number">0</span>,</span><br><span class="line">    <span class="comment">// end: 3,</span></span><br><span class="line">    highWaterMark: <span class="number">2</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">rs.on(<span class="string">'data'</span>, (chunk) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(chunk.toString())</span><br><span class="line">    rs.pause()</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">        rs.resume()</span><br><span class="line">    &#125;,<span class="number">1000</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">rs.on(<span class="string">'readable'</span>,()=&gt;&#123;</span><br><span class="line">    <span class="keyword">let</span> data</span><br><span class="line">    <span class="keyword">while</span>((data = rs.read(<span class="number">2</span>))!==<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(data.toString())</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'------'</span>,rs._readableState.length)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="40-文件可读流事件与应用"><a href="#40-文件可读流事件与应用" class="headerlink" title="40.文件可读流事件与应用"></a>40.文件可读流事件与应用</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> rs = fs.createReadStream(<span class="string">'test.txt'</span>, &#123;</span><br><span class="line">    flags: <span class="string">'r'</span>,</span><br><span class="line">    encoding: <span class="literal">null</span>,</span><br><span class="line">    fd: <span class="literal">null</span>,</span><br><span class="line">    mode: <span class="number">438</span>, </span><br><span class="line">    autoClose: <span class="literal">true</span>,</span><br><span class="line">    start: <span class="number">0</span>,</span><br><span class="line">    <span class="comment">// end: 3,</span></span><br><span class="line">    highWaterMark: <span class="number">2</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">rs.on(<span class="string">'open'</span>, (fd) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(fd, <span class="string">'文件打开了'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">rs.on(<span class="string">'close'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(fd, <span class="string">'文件关闭了'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">let</span> bufferArr = []</span><br><span class="line">rs.on(<span class="string">'data'</span>, (chunk) =&gt; &#123;</span><br><span class="line">    bufferArr.push(chunk)</span><br><span class="line">    <span class="built_in">console</span>.log(chunk)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">rs.on(<span class="string">'end'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(Buffer.concat(bufferArr).toString)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'当数据被清空之后'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">rs.on(<span class="string">'error'</span>, (err) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'出错了'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="41-文件可写流"><a href="#41-文件可写流" class="headerlink" title="41.文件可写流"></a>41.文件可写流</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ws = fs.createWriteStream(<span class="string">'test.txt'</span>,&#123;</span><br><span class="line">    flags: <span class="string">'w'</span>,</span><br><span class="line">    mode: <span class="number">438</span>,</span><br><span class="line">    fd: <span class="literal">null</span>,</span><br><span class="line">    encoding: <span class="string">'utf-8'</span>,</span><br><span class="line">    start: <span class="number">0</span>,</span><br><span class="line">    highWaterMark: <span class="number">3</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">ws.write(<span class="string">'拉勾教育'</span>,()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'数据写完了'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">ws.on(<span class="string">'open'</span>,(fd)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'open'</span>,fd)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">ws.write(<span class="string">'1'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// close 是在数据写入操作全部完成之后再执行</span></span><br><span class="line">ws.on(<span class="string">'close'</span>,()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'文件关闭了'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// end 执行之后就意味着数据写入操作完成</span></span><br><span class="line">ws.end()</span><br><span class="line"></span><br><span class="line">ws.on(<span class="string">'error'</span>,(err)=&gt;&#123;</span><br><span class="line">   <span class="built_in">console</span>.log(<span class="string">'出错了'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="42-write执行流程"><a href="#42-write执行流程" class="headerlink" title="42.write执行流程"></a>42.write执行流程</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ws = fs.createWriteStream(<span class="string">'test.txt'</span>,&#123;</span><br><span class="line">    highWaterMark: <span class="number">3</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> flag = ws.write(<span class="string">'1'</span>)</span><br><span class="line"><span class="built_in">console</span>.log(flag) <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line">flag = ws.write(<span class="string">'1'</span>)</span><br><span class="line"><span class="built_in">console</span>.log(flag) <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line">flag = ws.write(<span class="string">'1'</span>)</span><br><span class="line"><span class="built_in">console</span>.log(flag) <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line">ws.on(<span class="string">'drain'</span>,()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'11'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 01 第一次调用 write 方法时是将数据直接写入到文件中</span></span><br><span class="line"><span class="comment"> * 02 第二次开始 write 方法就是将数据写入至缓存中</span></span><br><span class="line"><span class="comment"> * 03 生产速度和消费速度是不一样的，一般情况下生产速度要比消费速度快很多</span></span><br><span class="line"><span class="comment"> * 04 当 flag 为 false 之后并不是意味着当前次的数据不能被写入了。但是我们应该告知数据的生产者，当前的消费速度已经跟不上生产速度了，所以这个时候，一般我们会将可读流的模块修改为暂停模式。</span></span><br><span class="line"><span class="comment"> * 05 当数据生产者暂停之后，消费者会慢慢的消化它内部缓存中的数据，直到可以再次被执行写入操作</span></span><br><span class="line"><span class="comment"> * 06 当缓冲区可以继续写入数据时如何让生产者知道？ drain 事件</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="43-控制写入速度"><a href="#43-控制写入速度" class="headerlink" title="43.控制写入速度"></a>43.控制写入速度</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 需求: “拉勾教育”写入指定文件</span></span><br><span class="line"><span class="comment"> * 01 一次写入</span></span><br><span class="line"><span class="comment"> * 02 分批写入</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">let</span> ws = fs.createWriteStream(<span class="string">'test.txt'</span>,&#123;</span><br><span class="line">    highWaterMark: <span class="number">3</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// ws.write('拉勾教育')</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> source = <span class="string">'拉勾教育'</span>.split(<span class="string">''</span>)</span><br><span class="line"><span class="keyword">let</span> num = <span class="number">0</span></span><br><span class="line"><span class="keyword">let</span> flag = <span class="literal">true</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">executeWrite</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    flag = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">while</span>(num !== <span class="number">4</span> &amp;&amp; flag)&#123;</span><br><span class="line">       flag = ws.write(source[num])</span><br><span class="line">       num++</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">executeWrite()</span><br><span class="line"></span><br><span class="line">ws.on(<span class="string">'drain'</span>,()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'drain 执行了'</span>)</span><br><span class="line">    executeWrite()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="44-背压机制"><a href="#44-背压机制" class="headerlink" title="44.背压机制"></a>44.背压机制</h3><p>Node.js 的 stream 已实现了背压机制</p>
<blockquote>
<p>数据读写时可能存在的问题</p>
</blockquote>
<ul>
<li>内存溢出、GC频繁调用、其它进程变慢</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> rs = fs.createReadStream(<span class="string">'test.txt'</span>, &#123;</span><br><span class="line">    highWaterMark: <span class="number">4</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> ws = fs.createWriteStream(<span class="string">'test1.txt'</span>,&#123;</span><br><span class="line">    highWaterMark: <span class="number">1</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// let flag = true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// rs.on('data',(chunk)=&gt;&#123;</span></span><br><span class="line"><span class="comment">//     flag = ws.write(chunk,()=&gt;&#123;</span></span><br><span class="line"><span class="comment">//         console.log('写完了')</span></span><br><span class="line"><span class="comment">//     &#125;)</span></span><br><span class="line"><span class="comment">//     if(!flag)&#123;</span></span><br><span class="line"><span class="comment">//         rs.pause()</span></span><br><span class="line"><span class="comment">//     &#125;</span></span><br><span class="line"><span class="comment">// &#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// rs.on('drain',()=&gt;&#123;</span></span><br><span class="line"><span class="comment">//    rs.resume()</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">rs.pipe(ws)</span><br></pre></td></tr></table></figure>

<h3 id="45-模拟文件可读流01"><a href="#45-模拟文件可读流01" class="headerlink" title="45.模拟文件可读流01"></a>45.模拟文件可读流01</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> EventEmitter = <span class="built_in">require</span>(<span class="string">'events'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyFileReadStream</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;</span><br><span class="line">   <span class="keyword">constructor</span>(path, options = &#123;&#125;) &#123;</span><br><span class="line">       <span class="keyword">super</span>()</span><br><span class="line">       <span class="keyword">this</span>.path = path</span><br><span class="line">       <span class="keyword">this</span>.flags = options.flags || <span class="string">'r'</span></span><br><span class="line">       <span class="keyword">this</span>.mode = options.mode || <span class="number">438</span></span><br><span class="line">       <span class="keyword">this</span>.autoClose = options.autoClose || <span class="literal">true</span></span><br><span class="line">       <span class="keyword">this</span>.start = options.start || <span class="number">0</span></span><br><span class="line">       <span class="keyword">this</span>.end = options.start</span><br><span class="line">       <span class="keyword">this</span>.highWaterMark = options.highWaterMark || <span class="number">64</span>*<span class="number">1024</span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">this</span>.open()</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   open() &#123;</span><br><span class="line">       fs.open(<span class="keyword">this</span>.path,<span class="keyword">this</span>.flags,<span class="keyword">this</span>.mode,(err, fd) =&gt; &#123;</span><br><span class="line">           <span class="keyword">if</span>(err)&#123;</span><br><span class="line">               <span class="keyword">this</span>.emit(<span class="string">'error'</span>, err)</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">this</span>.fd = fd</span><br><span class="line">           <span class="keyword">this</span>.emit(<span class="string">'open'</span>,fd)</span><br><span class="line">       &#125;)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> rs = <span class="keyword">new</span> MyFileReadStream(<span class="string">'test.txt'</span>)</span><br><span class="line"></span><br><span class="line">rs.on(<span class="string">'open'</span>, (fd)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'open'</span>,fd)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">rs.on(<span class="string">'error'</span>, (err)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="46-模拟文件可读流02"><a href="#46-模拟文件可读流02" class="headerlink" title="46.模拟文件可读流02"></a>46.模拟文件可读流02</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> EventEmitter = <span class="built_in">require</span>(<span class="string">'events'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyFileReadStream</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;</span><br><span class="line">   <span class="keyword">constructor</span>(path, options = &#123;&#125;) &#123;</span><br><span class="line">       <span class="keyword">super</span>()</span><br><span class="line">       <span class="keyword">this</span>.path = path</span><br><span class="line">       <span class="keyword">this</span>.flags = options.flags || <span class="string">'r'</span></span><br><span class="line">       <span class="keyword">this</span>.mode = options.mode || <span class="number">438</span></span><br><span class="line">       <span class="keyword">this</span>.autoClose = options.autoClose || <span class="literal">true</span></span><br><span class="line">       <span class="keyword">this</span>.start = options.start || <span class="number">0</span></span><br><span class="line">       <span class="keyword">this</span>.end = options.end</span><br><span class="line">       <span class="keyword">this</span>.highWaterMark = options.highWaterMark || <span class="number">64</span>*<span class="number">1024</span></span><br><span class="line">       <span class="keyword">this</span>.readOffset = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">this</span>.open()</span><br><span class="line">       <span class="keyword">this</span>.on(<span class="string">'newListener'</span>, (type) =&gt; &#123;</span><br><span class="line">           <span class="built_in">console</span>.log(type)</span><br><span class="line">           <span class="keyword">if</span>(type === <span class="string">'data'</span>) &#123;</span><br><span class="line">               <span class="keyword">this</span>.read()</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   open() &#123;</span><br><span class="line">       fs.open(<span class="keyword">this</span>.path,<span class="keyword">this</span>.flags,<span class="keyword">this</span>.mode,(err, fd) =&gt; &#123;</span><br><span class="line">           <span class="keyword">if</span>(err)&#123;</span><br><span class="line">               <span class="keyword">this</span>.emit(<span class="string">'error'</span>, err)</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">this</span>.fd = fd</span><br><span class="line">           <span class="keyword">this</span>.emit(<span class="string">'open'</span>,fd)</span><br><span class="line">       &#125;)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">    read() &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">typeof</span> <span class="keyword">this</span>.fd !== <span class="string">'number'</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.once(<span class="string">'open'</span>,<span class="keyword">this</span>.read)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="keyword">this</span>.fd)</span><br><span class="line">        <span class="keyword">let</span> buf = Buffer.alloc(<span class="keyword">this</span>.highWaterMark)</span><br><span class="line">        fs.read(<span class="keyword">this</span>.fd,buf,<span class="number">0</span>,<span class="keyword">this</span>.highWaterMark,<span class="keyword">this</span>.readOffset,(err,readBytes)=&gt;&#123;</span><br><span class="line">           <span class="keyword">if</span>(readBytes)&#123;</span><br><span class="line">             <span class="keyword">this</span>.readOffset = readBytes</span><br><span class="line">             <span class="keyword">this</span>.emit(<span class="string">'data'</span>,buf)</span><br><span class="line">             <span class="keyword">this</span>.read()</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="keyword">this</span>.emit(<span class="string">'end'</span>)</span><br><span class="line">             <span class="keyword">this</span>.close()</span><br><span class="line">           &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close() &#123;</span><br><span class="line">        fs.close(<span class="keyword">this</span>.fd,()=&gt;&#123;</span><br><span class="line">            <span class="keyword">this</span>.emit(<span class="string">'close'</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> rs = <span class="keyword">new</span> MyFileReadStream(<span class="string">'test.txt'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// rs.on('open', (fd)=&gt;&#123;</span></span><br><span class="line"><span class="comment">//     console.log('open',fd)</span></span><br><span class="line"><span class="comment">// &#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// rs.on('error', (err)=&gt;&#123;</span></span><br><span class="line"><span class="comment">//     console.log(err)</span></span><br><span class="line"><span class="comment">// &#125;)</span></span><br><span class="line"></span><br><span class="line">rs.on(<span class="string">'data'</span>, (chunk)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(chunk)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">rs.on(<span class="string">'end'</span>, ()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'end'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">rs.on(<span class="string">'close'</span>, ()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'close'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="47-模拟文件可读流03"><a href="#47-模拟文件可读流03" class="headerlink" title="47.模拟文件可读流03"></a>47.模拟文件可读流03</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> EventEmitter = <span class="built_in">require</span>(<span class="string">'events'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyFileReadStream</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;</span><br><span class="line">   <span class="keyword">constructor</span>(path, options = &#123;&#125;) &#123;</span><br><span class="line">       <span class="keyword">super</span>()</span><br><span class="line">       <span class="keyword">this</span>.path = path</span><br><span class="line">       <span class="keyword">this</span>.flags = options.flags || <span class="string">'r'</span></span><br><span class="line">       <span class="keyword">this</span>.mode = options.mode || <span class="number">438</span></span><br><span class="line">       <span class="keyword">this</span>.autoClose = options.autoClose || <span class="literal">true</span></span><br><span class="line">       <span class="keyword">this</span>.start = options.start || <span class="number">0</span></span><br><span class="line">       <span class="keyword">this</span>.end = options.end</span><br><span class="line">       <span class="keyword">this</span>.highWaterMark = options.highWaterMark || <span class="number">64</span>*<span class="number">1024</span></span><br><span class="line">       <span class="keyword">this</span>.readOffset = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">this</span>.open()</span><br><span class="line">       <span class="keyword">this</span>.on(<span class="string">'newListener'</span>, (type) =&gt; &#123;</span><br><span class="line">           <span class="built_in">console</span>.log(type)</span><br><span class="line">           <span class="keyword">if</span>(type === <span class="string">'data'</span>) &#123;</span><br><span class="line">               <span class="keyword">this</span>.read()</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   open() &#123;</span><br><span class="line">       fs.open(<span class="keyword">this</span>.path,<span class="keyword">this</span>.flags,<span class="keyword">this</span>.mode,(err, fd) =&gt; &#123;</span><br><span class="line">           <span class="keyword">if</span>(err)&#123;</span><br><span class="line">               <span class="keyword">this</span>.emit(<span class="string">'error'</span>, err)</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">this</span>.fd = fd</span><br><span class="line">           <span class="keyword">this</span>.emit(<span class="string">'open'</span>,fd)</span><br><span class="line">       &#125;)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">    read() &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">typeof</span> <span class="keyword">this</span>.fd !== <span class="string">'number'</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.once(<span class="string">'open'</span>,<span class="keyword">this</span>.read)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="keyword">this</span>.fd)</span><br><span class="line">        <span class="keyword">let</span> buf = Buffer.alloc(<span class="keyword">this</span>.highWaterMark)</span><br><span class="line">        <span class="keyword">let</span> howMuchToRead</span><br><span class="line">        <span class="comment">// if(this.end)&#123;</span></span><br><span class="line">        <span class="comment">//     howMuchToRead = Math.min(this.end-this.readOffset+1,this.highWaterMark)</span></span><br><span class="line">        <span class="comment">// &#125; else &#123;</span></span><br><span class="line">        <span class="comment">//     howMuchToRead = this.highWaterMark</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        howMuchToRead = <span class="keyword">this</span>.end ? <span class="built_in">Math</span>.min(<span class="keyword">this</span>.end-<span class="keyword">this</span>.readOffset+<span class="number">1</span>,<span class="keyword">this</span>.highWaterMark) : <span class="keyword">this</span>.highWaterMark</span><br><span class="line">        fs.read(<span class="keyword">this</span>.fd,buf,<span class="number">0</span>,<span class="keyword">this</span>.howMuchToRead,<span class="keyword">this</span>.readOffset,(err,readBytes)=&gt;&#123;</span><br><span class="line">           <span class="keyword">if</span>(readBytes)&#123;</span><br><span class="line">             <span class="keyword">this</span>.readOffset = readBytes</span><br><span class="line">             <span class="keyword">this</span>.emit(<span class="string">'data'</span>,buf.slice(<span class="number">0</span>, readBytes))</span><br><span class="line">             <span class="keyword">this</span>.read()</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="keyword">this</span>.emit(<span class="string">'end'</span>)</span><br><span class="line">             <span class="keyword">this</span>.close()</span><br><span class="line">           &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close() &#123;</span><br><span class="line">        fs.close(<span class="keyword">this</span>.fd,()=&gt;&#123;</span><br><span class="line">            <span class="keyword">this</span>.emit(<span class="string">'close'</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> rs = <span class="keyword">new</span> MyFileReadStream(<span class="string">'test.txt'</span>,&#123;</span><br><span class="line">    end: <span class="number">7</span>,</span><br><span class="line">    highWaterMark: <span class="number">3</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">rs.on(<span class="string">'data'</span>, (chunk)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(chunk)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="48-链表结构"><a href="#48-链表结构" class="headerlink" title="48.链表结构"></a>48.链表结构</h3><blockquote>
<p>数组缺点</p>
</blockquote>
<ul>
<li>数组存储数据的长度具有上限</li>
<li>数组存在塌陷问题</li>
</ul>
<p>链表是一系列节点的集合<br>每个节点都具有指向下一个节点的属性</p>
<blockquote>
<p>链表分类</p>
</blockquote>
<ul>
<li>双向链表</li>
<li>单向链表</li>
<li>循环链表</li>
</ul>
<h3 id="49-单向链表实现-1"><a href="#49-单向链表实现-1" class="headerlink" title="49.单向链表实现-1"></a>49.单向链表实现-1</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 01 node * head * null</span></span><br><span class="line"><span class="comment"> * 02 head --&gt; null</span></span><br><span class="line"><span class="comment"> * 03 size</span></span><br><span class="line"><span class="comment"> * 04 next element</span></span><br><span class="line"><span class="comment"> * 05 增加 删除 修改 查询 清空</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(element, next) &#123;</span><br><span class="line">        <span class="keyword">this</span>.element = element</span><br><span class="line">        <span class="keyword">this</span>.next = next</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LinkedList</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(head, size) &#123;</span><br><span class="line">        <span class="keyword">this</span>.head = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">this</span>.size = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    add(index, element) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">arguments</span>.length === <span class="number">1</span>) &#123;</span><br><span class="line">            element = index</span><br><span class="line">            index = <span class="keyword">this</span>.size</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(index &lt; <span class="number">0</span> || index &gt; <span class="keyword">this</span>.size) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'cross the border'</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(index===<span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> head = <span class="keyword">this</span>.head</span><br><span class="line">            <span class="keyword">this</span>.head = <span class="keyword">new</span> Node(element, head)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> prevNode = <span class="keyword">this</span>._getNode(index - <span class="number">1</span>)</span><br><span class="line">            prevNode.next = <span class="keyword">new</span> Node(element, prevNode.next)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> l1 = <span class="keyword">new</span> LinkedList()</span><br><span class="line">l1.add(index,<span class="string">'node1'</span>)</span><br><span class="line"><span class="built_in">console</span>.log(l1)</span><br></pre></td></tr></table></figure>

<h3 id="50-单向链表实现-2"><a href="#50-单向链表实现-2" class="headerlink" title="50.单向链表实现-2"></a>50.单向链表实现-2</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 01 node * head * null</span></span><br><span class="line"><span class="comment"> * 02 head --&gt; null</span></span><br><span class="line"><span class="comment"> * 03 size</span></span><br><span class="line"><span class="comment"> * 04 next element</span></span><br><span class="line"><span class="comment"> * 05 增加 删除 修改 查询 清空</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(element, next) &#123;</span><br><span class="line">        <span class="keyword">this</span>.element = element</span><br><span class="line">        <span class="keyword">this</span>.next = next</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LinkedList</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(head, size) &#123;</span><br><span class="line">        <span class="keyword">this</span>.head = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">this</span>.size = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    _getNode(index) &#123;</span><br><span class="line">        <span class="keyword">if</span>(index &lt; <span class="number">0</span> || index &gt;= <span class="keyword">this</span>.size) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'越界了'</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> currentNode = <span class="keyword">this</span>.head</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; index; i++) &#123;</span><br><span class="line">            currentNode = currentNode.next</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> currentNode</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    add(index, element) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">arguments</span>.length === <span class="number">1</span>) &#123;</span><br><span class="line">            element = index</span><br><span class="line">            index = <span class="keyword">this</span>.size</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(index &lt; <span class="number">0</span> || index &gt; <span class="keyword">this</span>.size) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'cross the border'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(index===<span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> head = <span class="keyword">this</span>.head</span><br><span class="line">            <span class="keyword">this</span>.head = <span class="keyword">new</span> Node(element, head)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> prevNode = <span class="keyword">this</span>._getNode(index - <span class="number">1</span>)</span><br><span class="line">            prevNode.next = <span class="keyword">new</span> Node(element, prevNode.next)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    remove(index) &#123;</span><br><span class="line">        <span class="keyword">if</span>(index === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> head = <span class="keyword">this</span>.head</span><br><span class="line">            <span class="keyword">this</span>.head = head.next</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> prevNode = <span class="keyword">this</span>._getNode(index - <span class="number">1</span>)</span><br><span class="line">            prevNode.next = prevNode.next.next</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.size--</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> l1 = <span class="keyword">new</span> LinkedList()</span><br><span class="line">l1.add(<span class="string">'node1'</span>)</span><br><span class="line">l1.add(<span class="string">'node2'</span>)</span><br><span class="line">l1.add(<span class="number">1</span>,<span class="string">'node3'</span>)</span><br><span class="line">l1.remove(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">console</span>.log(l1)</span><br></pre></td></tr></table></figure>

<h3 id="51-单向链表实现-3"><a href="#51-单向链表实现-3" class="headerlink" title="51.单向链表实现-3"></a>51.单向链表实现-3</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 01 node * head * null</span></span><br><span class="line"><span class="comment"> * 02 head --&gt; null</span></span><br><span class="line"><span class="comment"> * 03 size</span></span><br><span class="line"><span class="comment"> * 04 next element</span></span><br><span class="line"><span class="comment"> * 05 增加 删除 修改 查询 清空</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(element, next) &#123;</span><br><span class="line">        <span class="keyword">this</span>.element = element</span><br><span class="line">        <span class="keyword">this</span>.next = next</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LinkedList</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(head, size) &#123;</span><br><span class="line">        <span class="keyword">this</span>.head = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">this</span>.size = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    _getNode(index) &#123;</span><br><span class="line">        <span class="keyword">if</span>(index &lt; <span class="number">0</span> || index &gt;= <span class="keyword">this</span>.size) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'越界了'</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> currentNode = <span class="keyword">this</span>.head</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; index; i++) &#123;</span><br><span class="line">            currentNode = currentNode.next</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> currentNode</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    add(index, element) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">arguments</span>.length === <span class="number">1</span>) &#123;</span><br><span class="line">            element = index</span><br><span class="line">            index = <span class="keyword">this</span>.size</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(index &lt; <span class="number">0</span> || index &gt; <span class="keyword">this</span>.size) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'cross the border'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(index===<span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> head = <span class="keyword">this</span>.head</span><br><span class="line">            <span class="keyword">this</span>.head = <span class="keyword">new</span> Node(element, head)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> prevNode = <span class="keyword">this</span>._getNode(index - <span class="number">1</span>)</span><br><span class="line">            prevNode.next = <span class="keyword">new</span> Node(element, prevNode.next)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    remove(index) &#123;</span><br><span class="line">        <span class="keyword">if</span>(index === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> head = <span class="keyword">this</span>.head</span><br><span class="line">            <span class="keyword">this</span>.head = head.next</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> prevNode = <span class="keyword">this</span>._getNode(index - <span class="number">1</span>)</span><br><span class="line">            prevNode.next = prevNode.next.next</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.size--</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">set</span>(index, element) &#123;</span><br><span class="line">        <span class="keyword">let</span> node = <span class="keyword">this</span>._getNode(index)</span><br><span class="line">        node.element = element</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">get</span>(index) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>._getNode(index)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    clear() &#123;</span><br><span class="line">        <span class="keyword">this</span>.head = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">this</span>.size = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> l1 = <span class="keyword">new</span> LinkedList()</span><br><span class="line">l1.add(<span class="string">'node1'</span>)</span><br><span class="line">l1.add(<span class="string">'node2'</span>)</span><br><span class="line">l1.add(<span class="number">1</span>,<span class="string">'node3'</span>)</span><br><span class="line"><span class="comment">// l1.remove(1)</span></span><br><span class="line">l1.set(<span class="number">1</span>,<span class="string">'node3-3'</span>)</span><br><span class="line"><span class="built_in">console</span>.log(l1)</span><br></pre></td></tr></table></figure>

<h3 id="52-单向链表实现队列"><a href="#52-单向链表实现队列" class="headerlink" title="52.单向链表实现队列"></a>52.单向链表实现队列</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 01 node * head * null</span></span><br><span class="line"><span class="comment"> * 02 head --&gt; null</span></span><br><span class="line"><span class="comment"> * 03 size</span></span><br><span class="line"><span class="comment"> * 04 next element</span></span><br><span class="line"><span class="comment"> * 05 增加 删除 修改 查询 清空</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(element, next) &#123;</span><br><span class="line">        <span class="keyword">this</span>.element = element</span><br><span class="line">        <span class="keyword">this</span>.next = next</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LinkedList</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(head, size) &#123;</span><br><span class="line">        <span class="keyword">this</span>.head = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">this</span>.size = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    _getNode(index) &#123;</span><br><span class="line">        <span class="keyword">if</span>(index &lt; <span class="number">0</span> || index &gt;= <span class="keyword">this</span>.size) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'越界了'</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> currentNode = <span class="keyword">this</span>.head</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; index; i++) &#123;</span><br><span class="line">            currentNode = currentNode.next</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> currentNode</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    add(index, element) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">arguments</span>.length === <span class="number">1</span>) &#123;</span><br><span class="line">            element = index</span><br><span class="line">            index = <span class="keyword">this</span>.size</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(index &lt; <span class="number">0</span> || index &gt; <span class="keyword">this</span>.size) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'cross the border'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(index===<span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> head = <span class="keyword">this</span>.head</span><br><span class="line">            <span class="keyword">this</span>.head = <span class="keyword">new</span> Node(element, head)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> prevNode = <span class="keyword">this</span>._getNode(index - <span class="number">1</span>)</span><br><span class="line">            prevNode.next = <span class="keyword">new</span> Node(element, prevNode.next)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    remove(index) &#123;</span><br><span class="line">        <span class="keyword">let</span> rmNode = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">if</span>(index === <span class="number">0</span>) &#123;</span><br><span class="line">            rmNode = <span class="keyword">this</span>.head</span><br><span class="line">            <span class="keyword">if</span>(!rmNode) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">undefined</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.head = rmNode.next</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> prevNode = <span class="keyword">this</span>._getNode(index - <span class="number">1</span>)</span><br><span class="line">            rmNode = prevNode.next</span><br><span class="line">            prevNode.next = rmNode.next</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.size--</span><br><span class="line">        <span class="keyword">return</span> rmNode</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">set</span>(index, element) &#123;</span><br><span class="line">        <span class="keyword">let</span> node = <span class="keyword">this</span>._getNode(index)</span><br><span class="line">        node.element = element</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">get</span>(index) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>._getNode(index)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    clear() &#123;</span><br><span class="line">        <span class="keyword">this</span>.head = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">this</span>.size = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Queue</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>()&#123;</span><br><span class="line">        <span class="keyword">this</span>.linkedList = <span class="keyword">new</span> LinkedList()</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    enQueue(data) &#123;</span><br><span class="line">        <span class="keyword">this</span>.linkedList.add(data)</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    deQueue() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.LinkedList.remove(<span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> q = <span class="keyword">new</span> Queue()</span><br><span class="line">q.enQueue(<span class="string">'node1'</span>)</span><br><span class="line">q.enQueue(<span class="string">'node2'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(q)</span><br><span class="line"><span class="keyword">let</span> a = q.deQueue()</span><br><span class="line"><span class="built_in">console</span>.log(a)</span><br></pre></td></tr></table></figure>

<h3 id="53-文件可写流实现-1"><a href="#53-文件可写流实现-1" class="headerlink" title="53.文件可写流实现-1"></a>53.文件可写流实现-1</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> EventsEmitter = <span class="built_in">require</span>(<span class="string">'events'</span>)</span><br><span class="line"><span class="keyword">const</span> Queue = <span class="built_in">require</span>(<span class="string">'./linkedList'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyWriteStream</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span></span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(path, options = &#123;&#125;)&#123;</span><br><span class="line">        <span class="keyword">super</span>()</span><br><span class="line">        <span class="keyword">this</span>.path = path</span><br><span class="line">        <span class="keyword">this</span>.flags = options.flags || <span class="string">'w'</span></span><br><span class="line">        <span class="keyword">this</span>.mode = options.mode || <span class="number">438</span></span><br><span class="line">        <span class="keyword">this</span>.autoClose = options.autoClose || <span class="literal">true</span></span><br><span class="line">        <span class="keyword">this</span>.start = options.start || <span class="number">0</span></span><br><span class="line">        <span class="keyword">this</span>.encoding = options.encoding || <span class="string">'utf-8'</span></span><br><span class="line">        <span class="keyword">this</span>.highWaterMark = options.highWaterMark || <span class="number">16</span>*<span class="number">1024</span></span><br><span class="line">        <span class="keyword">this</span>.open()</span><br><span class="line">    &#125;</span><br><span class="line">    open()&#123;</span><br><span class="line">        fs.open(<span class="keyword">this</span>.path,<span class="keyword">this</span>.flags,(err,fd)=&gt;&#123;</span><br><span class="line">            <span class="keyword">if</span>(err) &#123;</span><br><span class="line">                <span class="keyword">this</span>.emit(<span class="string">'error'</span>, err)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.fd = fd</span><br><span class="line">            <span class="keyword">this</span>.emit(<span class="string">'open'</span>, fd)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ws = <span class="keyword">new</span> MyWriteStream(<span class="string">'./f9.txt'</span>,&#123;&#125;)</span><br><span class="line">ws.on(<span class="string">'open'</span>,(fd)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'open----&gt;'</span>, fd)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="54-文件可写流实现-2"><a href="#54-文件可写流实现-2" class="headerlink" title="54.文件可写流实现-2"></a>54.文件可写流实现-2</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> EventsEmitter = <span class="built_in">require</span>(<span class="string">'events'</span>)</span><br><span class="line"><span class="keyword">const</span> Queue = <span class="built_in">require</span>(<span class="string">'./linkedList'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyWriteStream</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span></span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(path, options = &#123;&#125;)&#123;</span><br><span class="line">        <span class="keyword">super</span>()</span><br><span class="line">        <span class="keyword">this</span>.path = path</span><br><span class="line">        <span class="keyword">this</span>.flags = options.flags || <span class="string">'w'</span></span><br><span class="line">        <span class="keyword">this</span>.mode = options.mode || <span class="number">438</span></span><br><span class="line">        <span class="keyword">this</span>.autoClose = options.autoClose || <span class="literal">true</span></span><br><span class="line">        <span class="keyword">this</span>.start = options.start || <span class="number">0</span></span><br><span class="line">        <span class="keyword">this</span>.encoding = options.encoding || <span class="string">'utf-8'</span></span><br><span class="line">        <span class="keyword">this</span>.highWaterMark = options.highWaterMark || <span class="number">16</span>*<span class="number">1024</span></span><br><span class="line">        <span class="keyword">this</span>.open()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.writeoffset = <span class="keyword">this</span>.start</span><br><span class="line">        <span class="keyword">this</span>.writing = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">this</span>.writeLen = <span class="number">0</span></span><br><span class="line">        <span class="keyword">this</span>.needDrain = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">this</span>.cache = <span class="keyword">new</span> Queue()</span><br><span class="line">    &#125;</span><br><span class="line">    open()&#123;</span><br><span class="line">        fs.open(<span class="keyword">this</span>.path,<span class="keyword">this</span>.flags,(err,fd)=&gt;&#123;</span><br><span class="line">            <span class="keyword">if</span>(err) &#123;</span><br><span class="line">                <span class="keyword">this</span>.emit(<span class="string">'error'</span>, err)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.fd = fd</span><br><span class="line">            <span class="keyword">this</span>.emit(<span class="string">'open'</span>, fd)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    write(chunk, encoding, cb)&#123;</span><br><span class="line">       chunk = Buffer.isBuffer(chunk) ? chunk : Buffer.from(chunk)</span><br><span class="line">       <span class="keyword">this</span>.writeLen += chunk.length</span><br><span class="line">       <span class="keyword">let</span> flag = <span class="keyword">this</span>.written &lt; <span class="keyword">this</span>.highWaterMark</span><br><span class="line">       <span class="keyword">this</span>.needDrain = !flag</span><br><span class="line">       <span class="keyword">if</span>(<span class="keyword">this</span>.writing)&#123;</span><br><span class="line">           <span class="comment">// 当前正在执行写入，所以内容应该排队</span></span><br><span class="line">           <span class="comment">// this.cache.enQueue()</span></span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">           <span class="comment">// 当前不是正在写入那么执行写入</span></span><br><span class="line">           <span class="keyword">this</span>._write(chunk, encoding, cb)</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> flag</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _write(chunk, encoding, cb)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'正在执行第一次写入'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ws = <span class="keyword">new</span> MyWriteStream(<span class="string">'./f9.txt'</span>,&#123;&#125;)</span><br><span class="line">ws.on(<span class="string">'open'</span>,(fd)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'open----&gt;'</span>, fd)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">let</span> flag = ws.write(<span class="string">'1'</span>, <span class="string">'utf8'</span>, () =&gt; &#123;</span><br><span class="line">     <span class="built_in">console</span>.log(<span class="string">'ok1'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">console</span>.log(flag)</span><br></pre></td></tr></table></figure>

<h3 id="55-文件可写流实现-3"><a href="#55-文件可写流实现-3" class="headerlink" title="55.文件可写流实现-3"></a>55.文件可写流实现-3</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> EventsEmitter = <span class="built_in">require</span>(<span class="string">'events'</span>)</span><br><span class="line"><span class="keyword">const</span> Queue = <span class="built_in">require</span>(<span class="string">'./linkedList'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyWriteStream</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span></span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(path, options = &#123;&#125;)&#123;</span><br><span class="line">        <span class="keyword">super</span>()</span><br><span class="line">        <span class="keyword">this</span>.path = path</span><br><span class="line">        <span class="keyword">this</span>.flags = options.flags || <span class="string">'w'</span></span><br><span class="line">        <span class="keyword">this</span>.mode = options.mode || <span class="number">438</span></span><br><span class="line">        <span class="keyword">this</span>.autoClose = options.autoClose || <span class="literal">true</span></span><br><span class="line">        <span class="keyword">this</span>.start = options.start || <span class="number">0</span></span><br><span class="line">        <span class="keyword">this</span>.encoding = options.encoding || <span class="string">'utf-8'</span></span><br><span class="line">        <span class="keyword">this</span>.highWaterMark = options.highWaterMark || <span class="number">16</span>*<span class="number">1024</span></span><br><span class="line">        <span class="keyword">this</span>.open()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.writeoffset = <span class="keyword">this</span>.start</span><br><span class="line">        <span class="keyword">this</span>.writing = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">this</span>.writeLen = <span class="number">0</span></span><br><span class="line">        <span class="keyword">this</span>.needDrain = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">this</span>.cache = <span class="keyword">new</span> Queue()</span><br><span class="line">    &#125;</span><br><span class="line">    open()&#123;</span><br><span class="line">        fs.open(<span class="keyword">this</span>.path,<span class="keyword">this</span>.flags,(err,fd)=&gt;&#123;</span><br><span class="line">            <span class="keyword">if</span>(err) &#123;</span><br><span class="line">                <span class="keyword">this</span>.emit(<span class="string">'error'</span>, err)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.fd = fd</span><br><span class="line">            <span class="keyword">this</span>.emit(<span class="string">'open'</span>, fd)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    write(chunk, encoding, cb)&#123;</span><br><span class="line">       chunk = Buffer.isBuffer(chunk) ? chunk : Buffer.from(chunk)</span><br><span class="line">       <span class="keyword">this</span>.writeLen += chunk.length</span><br><span class="line">       <span class="keyword">let</span> flag = <span class="keyword">this</span>.written &lt; <span class="keyword">this</span>.highWaterMark</span><br><span class="line">       <span class="keyword">this</span>.needDrain = !flag</span><br><span class="line">       <span class="keyword">if</span>(<span class="keyword">this</span>.writing)&#123;</span><br><span class="line">           <span class="comment">// 当前正在执行写入，所以内容应该排队</span></span><br><span class="line">           <span class="keyword">this</span>.cache.enQueue(&#123;chunk,encoding,cb&#125;)</span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">           <span class="keyword">this</span>.writing = <span class="literal">true</span></span><br><span class="line">           <span class="comment">// 当前不是正在写入那么执行写入</span></span><br><span class="line">           <span class="keyword">this</span>._write(chunk, encoding, ()=&gt;&#123;</span><br><span class="line">               cb()</span><br><span class="line">               <span class="comment">// 清空排队的内容</span></span><br><span class="line">               <span class="keyword">this</span>._clearBuffer()</span><br><span class="line">           &#125;)</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> flag</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _write(chunk, encoding, cb)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'正在执行第一次写入'</span>)</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">typeof</span> <span class="keyword">this</span>.fd !== <span class="string">'number'</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.once(<span class="string">'open'</span>, ()=&gt;&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>._write(chunk, encoding, cb)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        fs.write(<span class="keyword">this</span>.fd, chunk, <span class="keyword">this</span>.start,chunk.length,<span class="keyword">this</span>.writeoffset, (err, written)=&gt;&#123;</span><br><span class="line">            <span class="keyword">this</span>.writeoffset += written</span><br><span class="line">            <span class="keyword">this</span>.writeLen -= written</span><br><span class="line">            cb &amp;&amp; cb()</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'ok1111111'</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _clearBuffer()&#123;</span><br><span class="line">        <span class="keyword">let</span> data = <span class="keyword">this</span>.cache.deQueue()</span><br><span class="line">        <span class="keyword">if</span>(data)&#123;</span><br><span class="line">            <span class="keyword">this</span>._write(data.element.chunk, data.element.encoding, ()=&gt; &#123;</span><br><span class="line">                data.element.cb &amp;&amp; data.element.cb()</span><br><span class="line">                <span class="keyword">this</span>._clearBuffer()</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">this</span>.needDrain) &#123;</span><br><span class="line">                <span class="keyword">this</span>.needDrain = <span class="literal">false</span></span><br><span class="line">                <span class="keyword">this</span>.emit(<span class="string">'drain'</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">console</span>.log(data)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ws = <span class="keyword">new</span> MyWriteStream(<span class="string">'./f9.txt'</span>,&#123;&#125;)</span><br><span class="line">ws.on(<span class="string">'open'</span>,(fd)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'open----&gt;'</span>, fd)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">let</span> flag = ws.write(<span class="string">'1'</span>, <span class="string">'utf8'</span>, () =&gt; &#123;</span><br><span class="line">     <span class="built_in">console</span>.log(<span class="string">'ok1'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">console</span>.log(flag)</span><br></pre></td></tr></table></figure>

<h3 id="56-pipe方法使用"><a href="#56-pipe方法使用" class="headerlink" title="56.pipe方法使用"></a>56.pipe方法使用</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> EventEmitter = <span class="built_in">require</span>(<span class="string">'events'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyFileReadStream</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;</span><br><span class="line">   <span class="keyword">constructor</span>(path, options = &#123;&#125;) &#123;</span><br><span class="line">       <span class="keyword">super</span>()</span><br><span class="line">       <span class="keyword">this</span>.path = path</span><br><span class="line">       <span class="keyword">this</span>.flags = options.flags || <span class="string">'r'</span></span><br><span class="line">       <span class="keyword">this</span>.mode = options.mode || <span class="number">438</span></span><br><span class="line">       <span class="keyword">this</span>.autoClose = options.autoClose || <span class="literal">true</span></span><br><span class="line">       <span class="keyword">this</span>.start = options.start || <span class="number">0</span></span><br><span class="line">       <span class="keyword">this</span>.end = options.end</span><br><span class="line">       <span class="keyword">this</span>.highWaterMark = options.highWaterMark || <span class="number">64</span>*<span class="number">1024</span></span><br><span class="line">       <span class="keyword">this</span>.readOffset = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">this</span>.open()</span><br><span class="line">       <span class="keyword">this</span>.on(<span class="string">'newListener'</span>, (type) =&gt; &#123;</span><br><span class="line">           <span class="built_in">console</span>.log(type)</span><br><span class="line">           <span class="keyword">if</span>(type === <span class="string">'data'</span>) &#123;</span><br><span class="line">               <span class="keyword">this</span>.read()</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   open() &#123;</span><br><span class="line">       fs.open(<span class="keyword">this</span>.path,<span class="keyword">this</span>.flags,<span class="keyword">this</span>.mode,(err, fd) =&gt; &#123;</span><br><span class="line">           <span class="keyword">if</span>(err)&#123;</span><br><span class="line">               <span class="keyword">this</span>.emit(<span class="string">'error'</span>, err)</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">this</span>.fd = fd</span><br><span class="line">           <span class="keyword">this</span>.emit(<span class="string">'open'</span>,fd)</span><br><span class="line">       &#125;)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">    read() &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">typeof</span> <span class="keyword">this</span>.fd !== <span class="string">'number'</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.once(<span class="string">'open'</span>,<span class="keyword">this</span>.read)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="keyword">this</span>.fd)</span><br><span class="line">        <span class="keyword">let</span> buf = Buffer.alloc(<span class="keyword">this</span>.highWaterMark)</span><br><span class="line">        <span class="keyword">let</span> howMuchToRead</span><br><span class="line">        <span class="comment">// if(this.end)&#123;</span></span><br><span class="line">        <span class="comment">//     howMuchToRead = Math.min(this.end-this.readOffset+1,this.highWaterMark)</span></span><br><span class="line">        <span class="comment">// &#125; else &#123;</span></span><br><span class="line">        <span class="comment">//     howMuchToRead = this.highWaterMark</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        howMuchToRead = <span class="keyword">this</span>.end ? <span class="built_in">Math</span>.min(<span class="keyword">this</span>.end-<span class="keyword">this</span>.readOffset+<span class="number">1</span>,<span class="keyword">this</span>.highWaterMark) : <span class="keyword">this</span>.highWaterMark</span><br><span class="line">        fs.read(<span class="keyword">this</span>.fd,buf,<span class="number">0</span>,<span class="keyword">this</span>.howMuchToRead,<span class="keyword">this</span>.readOffset,(err,readBytes)=&gt;&#123;</span><br><span class="line">           <span class="keyword">if</span>(readBytes)&#123;</span><br><span class="line">             <span class="keyword">this</span>.readOffset = readBytes</span><br><span class="line">             <span class="keyword">this</span>.emit(<span class="string">'data'</span>,buf.slice(<span class="number">0</span>, readBytes))</span><br><span class="line">             <span class="keyword">this</span>.read()</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="keyword">this</span>.emit(<span class="string">'end'</span>)</span><br><span class="line">             <span class="keyword">this</span>.close()</span><br><span class="line">           &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close() &#123;</span><br><span class="line">        fs.close(<span class="keyword">this</span>.fd,()=&gt;&#123;</span><br><span class="line">            <span class="keyword">this</span>.emit(<span class="string">'close'</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pipe(ws) &#123;</span><br><span class="line">        <span class="keyword">this</span>.on(<span class="string">'data'</span>,(data) =&gt; &#123;</span><br><span class="line">            <span class="keyword">let</span> flag = ws.write(data)</span><br><span class="line">            <span class="keyword">if</span>(!flag) &#123;</span><br><span class="line">                <span class="keyword">this</span>.pause()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        ws.on(<span class="string">'drain'</span>,()=&gt;&#123;</span><br><span class="line">            <span class="keyword">this</span>.resume()</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = MyFileReadStream</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> MyFileReadStream = <span class="built_in">require</span>(<span class="string">'./ReadStream'</span>)</span><br><span class="line"><span class="keyword">const</span> rs = <span class="keyword">new</span> MyFileReadStream(<span class="string">'./f9.txt'</span>)</span><br><span class="line"><span class="keyword">const</span> ws = fs.createWriteStream(<span class="string">'./f10.txt'</span>, &#123;</span><br><span class="line">    highWaterStream: <span class="number">1</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">rs.pipe(ws)</span><br></pre></td></tr></table></figure>

<h2 id="模块三-·-通信"><a href="#模块三-·-通信" class="headerlink" title="模块三 · 通信"></a>模块三 · 通信</h2><h3 id="1-通信基本原理"><a href="#1-通信基本原理" class="headerlink" title="1.通信基本原理"></a>1.通信基本原理</h3><blockquote>
<p>通信必要条件</p>
</blockquote>
<ul>
<li>主机之前需要有传输介质</li>
<li>主机上必须有网卡设备</li>
<li>主机之间需要协商网络速率</li>
</ul>
<h3 id="2-网络通讯方式"><a href="#2-网络通讯方式" class="headerlink" title="2.网络通讯方式"></a>2.网络通讯方式</h3><blockquote>
<p>常见通讯方式</p>
</blockquote>
<ul>
<li>交换机通讯</li>
<li>路由器通讯</li>
</ul>
<p>交换机的接口数量有上限<br>局域网存在大量主机会造成广播风暴</p>
<h3 id="3-网络层次模型"><a href="#3-网络层次模型" class="headerlink" title="3.网络层次模型"></a>3.网络层次模型</h3><blockquote>
<p>OSI 七层模型</p>
</blockquote>
<ul>
<li>应用层：用户与网络的接口</li>
<li>表示层：数据加密、转换、压缩</li>
<li>会话层：控制网络连接建立与终止</li>
<li>传输层：控制数据传输可靠性</li>
<li>网络层：确定目标网络</li>
<li>数据链路层：确定目标主机</li>
<li>物理层：各种物理设备和标准</li>
</ul>
<p>数据从A至B，先封装再解封</p>
<h3 id="4-数据封装与解封装"><a href="#4-数据封装与解封装" class="headerlink" title="4.数据封装与解封装"></a>4.数据封装与解封装</h3><p>略</p>
<h3 id="5-TCP三次握手与四次挥手"><a href="#5-TCP三次握手与四次挥手" class="headerlink" title="5.TCP三次握手与四次挥手"></a>5.TCP三次握手与四次挥手</h3><blockquote>
<p>TCP 协议</p>
</blockquote>
<ul>
<li>TCP 属于传输层协议</li>
<li>TCP 是面向连接的协议</li>
<li>TCP 用于处理实时通信</li>
</ul>
<blockquote>
<p>常见控制字段</p>
</blockquote>
<ul>
<li>SYN = 1 表示请求建立连接</li>
<li>FIN = 1 表示请求断开连接</li>
<li>ACK = 1 表示数据信息确认</li>
</ul>
<p>一个服务端会服务于多个客户端</p>
<ul>
<li>TCP 处于传输层，基于端口，面向连接</li>
<li>主机之间要想通信需要先建立双向数据通道</li>
<li>TCP 的握手和挥手本质上都是四次</li>
</ul>
<h3 id="6-创建TCP通信"><a href="#6-创建TCP通信" class="headerlink" title="6.创建TCP通信"></a>6.创建TCP通信</h3><p>Net 模块实现了底层通信接口</p>
<blockquote>
<p>通信过程</p>
</blockquote>
<ul>
<li>创建服务端：接收和回写客户端数据</li>
<li>创建客户端：发送和接收服务端数据</li>
<li>数据传输：内置服务事件和方法读写数据</li>
</ul>
<blockquote>
<p>通信事件</p>
</blockquote>
<ul>
<li>listening 事件：调用 server.listen 方法之后触发</li>
<li>connection 事件：新的连接建立时触发</li>
<li>close 事件：当 server 关闭时触发</li>
<li>error 事件：当错误出现的时候触发</li>
</ul>
<blockquote>
<p>通信事件&amp;方法</p>
</blockquote>
<ul>
<li>data 事件：当接收到数据的时候触发改事件</li>
<li>write 方法：在 socket 上发送数据，默认是UTF8编码</li>
<li>end 操作：当 socket 的一端发送 FIN 包时触发，结束可读端</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server.js</span></span><br><span class="line"><span class="keyword">const</span> net = <span class="built_in">require</span>(<span class="string">'net'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = net.createServer()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> PORT = <span class="number">1234</span></span><br><span class="line"><span class="keyword">const</span> HOST = <span class="string">'localhost'</span></span><br><span class="line"></span><br><span class="line">server.listen(PORT, HOST)</span><br><span class="line"></span><br><span class="line">server.on(<span class="string">'listening'</span>, ()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`服务端已经开启在 <span class="subst">$&#123;HOST&#125;</span>:<span class="subst">$&#123;PORT&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.on(<span class="string">'connection'</span>, (socket) =&gt; &#123;</span><br><span class="line">   socket.on(<span class="string">'data'</span>,(chunk) =&gt; &#123;</span><br><span class="line">       <span class="keyword">const</span> msg = chunk.toString()</span><br><span class="line">       <span class="built_in">console</span>.log(msg)</span><br><span class="line"></span><br><span class="line">       socket.write(Buffer.from(<span class="string">'您好'</span>+msg))</span><br><span class="line">   &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.on(<span class="string">'close'</span>, ()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'服务端关闭了'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.on(<span class="string">'error'</span>, (err)=&gt;&#123;</span><br><span class="line">    <span class="keyword">if</span>(err.code === <span class="string">'EADDRINUSE'</span>)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'地址正在被使用'</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// client.js</span></span><br><span class="line"><span class="keyword">const</span> net = <span class="built_in">require</span>(<span class="string">'net'</span>)</span><br><span class="line"><span class="keyword">const</span> client = net.createConnection(&#123;</span><br><span class="line">    port: <span class="number">1234</span>,</span><br><span class="line">    host: <span class="string">'127.0.0.1'</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">client.on(<span class="string">'connect'</span>, ()=&gt;&#123;</span><br><span class="line">    client.write(<span class="string">'拉勾教育'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">client.on(<span class="string">'data'</span>, (chunk)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(chunk.toString())</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">client.on(<span class="string">'error'</span>, (err)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">client.on(<span class="string">'close'</span>, ()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'客户端断开连接'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="7-TCP粘包及解决"><a href="#7-TCP粘包及解决" class="headerlink" title="7.TCP粘包及解决"></a>7.TCP粘包及解决</h3><p>通信包含数据发送端和接收端<br>发送端累积数据统一发送<br>接收端缓冲数据之后再消费</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server.js</span></span><br><span class="line"><span class="keyword">const</span> net = <span class="built_in">require</span>(<span class="string">'net'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = net.createServer()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> PORT = <span class="number">1234</span></span><br><span class="line"><span class="keyword">const</span> HOST = <span class="string">'localhost'</span></span><br><span class="line"></span><br><span class="line">server.listen(PORT, HOST)</span><br><span class="line"></span><br><span class="line">server.on(<span class="string">'listening'</span>, ()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`服务端已经开启在 <span class="subst">$&#123;HOST&#125;</span>:<span class="subst">$&#123;PORT&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.on(<span class="string">'connection'</span>, (socket) =&gt; &#123;</span><br><span class="line">   socket.on(<span class="string">'data'</span>,(chunk) =&gt; &#123;</span><br><span class="line">       <span class="keyword">const</span> msg = chunk.toString()</span><br><span class="line">       <span class="built_in">console</span>.log(msg)</span><br><span class="line"></span><br><span class="line">       socket.write(Buffer.from(<span class="string">'您好'</span>+msg))</span><br><span class="line">   &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.on(<span class="string">'close'</span>, ()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'服务端关闭了'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.on(<span class="string">'error'</span>, (err)=&gt;&#123;</span><br><span class="line">    <span class="keyword">if</span>(err.code === <span class="string">'EADDRINUSE'</span>)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'地址正在被使用'</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// client.js</span></span><br><span class="line"><span class="keyword">const</span> net = <span class="built_in">require</span>(<span class="string">'net'</span>)</span><br><span class="line"><span class="keyword">const</span> client = net.createConnection(&#123;</span><br><span class="line">    port: <span class="number">1234</span>,</span><br><span class="line">    host: <span class="string">'127.0.0.1'</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> dataArr = [</span><br><span class="line">    <span class="string">'拉勾教育2'</span>,</span><br><span class="line">    <span class="string">'拉勾教育3'</span>,</span><br><span class="line">    <span class="string">'拉勾教育4'</span>,</span><br><span class="line">    <span class="string">'拉勾教育5'</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">client.on(<span class="string">'connect'</span>, ()=&gt;&#123;</span><br><span class="line">    client.write(<span class="string">'拉勾教育1'</span>)</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;dataArr.length;i++)&#123;</span><br><span class="line">        (<span class="function"><span class="keyword">function</span>(<span class="params">val,index</span>)</span>&#123;</span><br><span class="line">            setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">                client.write(val)</span><br><span class="line">            &#125;,<span class="number">1000</span>*(index+<span class="number">1</span>))</span><br><span class="line">        &#125;)(dataArr[i],i)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">client.on(<span class="string">'data'</span>, (chunk)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(chunk.toString())</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">client.on(<span class="string">'error'</span>, (err)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">client.on(<span class="string">'close'</span>, ()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'客户端断开连接'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="8-封包拆包实现"><a href="#8-封包拆包实现" class="headerlink" title="8.封包拆包实现"></a>8.封包拆包实现</h3><blockquote>
<p>数据传输过程</p>
</blockquote>
<ul>
<li>进行数据编码，获取二进制数据包</li>
<li>按规则拆解数据，获取指定长度的数据</li>
</ul>
<p>Buffer 数据读写</p>
<ul>
<li>writeInt16BE：将 value 从指定位置写入</li>
<li>readInt16BE：从指定位置开始读取数据</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTransformCode</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>()&#123;</span><br><span class="line">        <span class="keyword">this</span>.pakageHeaderLen = <span class="number">4</span></span><br><span class="line">        <span class="keyword">this</span>.serialNum = <span class="number">0</span></span><br><span class="line">        <span class="keyword">this</span>.serialLen = <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    encode(data, serialNum) &#123;</span><br><span class="line">        <span class="keyword">const</span> body = Buffer.from(data)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 01 先按照指定的长度来申请一片内存空间作为 header 来使用</span></span><br><span class="line">        <span class="keyword">const</span> headerBuf = Buffer.alloc(<span class="keyword">this</span>.pakageHeaderLen)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 02 </span></span><br><span class="line">        headerBuf.writeInt16EB(serialNum || <span class="keyword">this</span>.serialNum)</span><br><span class="line"></span><br><span class="line">        headerBuf.writeInt16EB(body.length, <span class="keyword">this</span>.serialLen)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(serialNum === <span class="literal">undefined</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.serialNum++</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Buffer.concat([headerBuf,body])</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    decode(buffer) &#123;</span><br><span class="line">       <span class="keyword">const</span> headerBuf = buffer.slice(<span class="number">0</span>,<span class="keyword">this</span>.pakageHeaderLen)</span><br><span class="line">       <span class="keyword">const</span> bodyBuf = buffer.slice(<span class="keyword">this</span>.pakageHeaderLen)</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> &#123;</span><br><span class="line">           serialNum: headerBuf.readInt16EB(),</span><br><span class="line">           bodyLength: headerBuf.readInt16EB(<span class="keyword">this</span>.serialLen),</span><br><span class="line">           body: bodyBuf.toString()</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    getPackageLen(buffer) &#123;</span><br><span class="line">        <span class="keyword">if</span>(buffer.length &lt; <span class="keyword">this</span>.packageHeaderLen) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.packageHeaderLen + buffer.readInt16EB(<span class="keyword">this</span>.seriaLen)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = MyTransformCode</span><br></pre></td></tr></table></figure>

<h3 id="9-封包解决粘包"><a href="#9-封包解决粘包" class="headerlink" title="9.封包解决粘包"></a>9.封包解决粘包</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server.js</span></span><br><span class="line"><span class="keyword">const</span> net = <span class="built_in">require</span>(<span class="string">'net'</span>)</span><br><span class="line"><span class="keyword">const</span> MyTransform = <span class="built_in">require</span>(<span class="string">'./myTransform.js'</span>)</span><br><span class="line"><span class="keyword">const</span> server = net.createServer()</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> overageBuffer = <span class="literal">null</span></span><br><span class="line"><span class="keyword">let</span> ts = <span class="keyword">new</span> MyTransform()</span><br><span class="line"></span><br><span class="line">server.listen(<span class="string">'1234'</span>, <span class="string">'localhost'</span>)</span><br><span class="line"></span><br><span class="line">server.on(<span class="string">'listening'</span>,()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'服务端运行在 localhost:1234'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.on(<span class="string">'connection'</span>, (socket) =&gt; &#123;</span><br><span class="line">    socket.on(<span class="string">'data'</span>, (chunk) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span>(overageBuffer) &#123;</span><br><span class="line">            chunk = Buffer.concat([overageBuffer, chunk])</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> packageLen = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span>(packageLen = ts.getPakageLen(chunk))&#123;</span><br><span class="line">            <span class="keyword">const</span> packageCon = chunk.slice(<span class="number">0</span>, packageLen)</span><br><span class="line">            chunk = chunk.slice(packageLen)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> ret = ts.decode(packageCon)</span><br><span class="line">            <span class="built_in">console</span>.log(ret)</span><br><span class="line"></span><br><span class="line">            socket.write(ts.encode(ret.body, ret.serialNum))</span><br><span class="line">        &#125;</span><br><span class="line">        overageBuffer = chunk</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// client.js</span></span><br><span class="line"><span class="keyword">const</span> net = <span class="built_in">require</span>(<span class="string">'net'</span>)</span><br><span class="line"><span class="keyword">const</span> MyTransform = <span class="built_in">require</span>(<span class="string">'./myTransform.js'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> overageBuffer = <span class="literal">null</span></span><br><span class="line"><span class="keyword">let</span> ts = <span class="keyword">new</span> MyTransform()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> client = net.createConnection(&#123;</span><br><span class="line">    host: <span class="string">'localhost'</span>,</span><br><span class="line">    port: <span class="number">1234</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">client.write(ts.encode(<span class="string">'拉勾教育1'</span>))</span><br><span class="line">client.write(ts.encode(<span class="string">'拉勾教育2'</span>))</span><br><span class="line">client.write(ts.encode(<span class="string">'拉勾教育3'</span>))</span><br><span class="line">client.write(ts.encode(<span class="string">'拉勾教育4'</span>))</span><br><span class="line">client.write(ts.encode(<span class="string">'拉勾教育5'</span>))</span><br><span class="line">client.on(<span class="string">'data'</span>, (chunk) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span>(overageBuffer) &#123;</span><br><span class="line">            chunk = Buffer.concat([overageBuffer, chunk])</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> packageLen = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span>(packageLen = ts.getPakageLen(chunk))&#123;</span><br><span class="line">            <span class="keyword">const</span> packageCon = chunk.slice(<span class="number">0</span>, packageLen)</span><br><span class="line">            chunk = chunk.slice(packageLen)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> ret = ts.decode(packageCon)</span><br><span class="line">            <span class="built_in">console</span>.log(ret)</span><br><span class="line">        &#125;</span><br><span class="line">        overageBuffer = chunk</span><br><span class="line">    <span class="comment">// console.log(chunk.toString())</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="10-http-协议"><a href="#10-http-协议" class="headerlink" title="10.http 协议"></a>10.http 协议</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> net = <span class="built_in">require</span>(<span class="string">'net'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> server = net.createServer()</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">1234</span>, ()=&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'服务端启动了...'</span>)</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.on(<span class="string">'connection'</span>, (socket) =&gt; &#123;</span><br><span class="line">    socket.on(<span class="string">'data'</span>, (data)=&gt;&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(data.toString())</span><br><span class="line">    &#125;)</span><br><span class="line">    socket.end(<span class="string">'test http request'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> server = http.createServer(<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'111'</span>)</span><br><span class="line">&#125;)</span><br><span class="line">server.listen(<span class="number">1234</span>,()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'server is running'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="11-获取-http-请求信息"><a href="#11-获取-http-请求信息" class="headerlink" title="11.获取 http 请求信息"></a>11.获取 http 请求信息</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = requrie(<span class="string">'http'</span>)</span><br><span class="line"><span class="keyword">const</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = http.createServer(<span class="function">(<span class="params">req,res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// console.log('请求进来了')</span></span><br><span class="line">    <span class="keyword">let</span> &#123;pathname, query&#125; = url.parse(req.url, <span class="literal">true</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(pathname,<span class="string">'----'</span>,query)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 请求方式</span></span><br><span class="line">    <span class="built_in">console</span>.log(req.methed)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 版本号</span></span><br><span class="line">    <span class="built_in">console</span>.log(req.httpVersion)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 请求头</span></span><br><span class="line">    <span class="built_in">console</span>.log(req.headers)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 请求体数据获取</span></span><br><span class="line">    <span class="comment">// curl -v -x POST -d "'name':'lg'" http:localhost:1234/</span></span><br><span class="line">    <span class="keyword">let</span> arr =[]</span><br><span class="line">    req.on(<span class="string">'data'</span>, (data) =&gt; &#123;</span><br><span class="line">        arr.push(data)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    req.on(<span class="string">'end'</span>, ()=&gt;&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(Buffer.concat(arr).toString())</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">1234</span>, ()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'server is start...'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="12-设置-http-响应"><a href="#12-设置-http-响应" class="headerlink" title="12.设置 http 响应"></a>12.设置 http 响应</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = requrie(<span class="string">'http'</span>)</span><br><span class="line"><span class="keyword">const</span> server = http.createServer(<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'有请求进来了'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// res.end('test ok')</span></span><br><span class="line">    res.statusCode = <span class="number">302</span></span><br><span class="line">    res.setHeaders(<span class="string">'Content-type'</span>, <span class="string">'text/html;charset=utf-8'</span>)</span><br><span class="line">    res.end(<span class="string">'拉勾教育'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">1234</span>, ()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'server is start...'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="13-代理客户端"><a href="#13-代理客户端" class="headerlink" title="13.代理客户端"></a>13.代理客户端</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"><span class="keyword">const</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>)</span><br><span class="line"><span class="keyword">const</span> querystring = <span class="built_in">require</span>(<span class="string">'querystring'</span>)</span><br><span class="line"><span class="keyword">const</span> server = http.createServer(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// console.log('请求进来了')</span></span><br><span class="line">    <span class="keyword">let</span> &#123;pathname, query&#125; = url.parse(req.url)</span><br><span class="line">    <span class="built_in">console</span>.log(pathname,<span class="string">'-----'</span>,query)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// post</span></span><br><span class="line">    <span class="keyword">let</span> arr = []</span><br><span class="line">    req.on(<span class="string">'data'</span>, (data) =&gt; &#123;</span><br><span class="line">        arr.push(data)</span><br><span class="line">    &#125;)</span><br><span class="line">    req.on(<span class="string">'end'</span>,()=&gt;&#123;</span><br><span class="line">        <span class="keyword">let</span> obj = Buffer.concat(arr).toString()</span><br><span class="line">        <span class="comment">// console.log(Buffer.cancat(arr).toString())</span></span><br><span class="line">        <span class="comment">// console.log(req.headers['content-type'])</span></span><br><span class="line">        <span class="keyword">if</span>(req.headers[<span class="string">'content-type'</span>] === <span class="string">'application/json'</span>)&#123;</span><br><span class="line">            <span class="keyword">let</span> a = <span class="built_in">JSON</span>.parse(obj)</span><br><span class="line">            a.add = <span class="string">'互联网人的大学'</span></span><br><span class="line">            res.end(<span class="built_in">JSON</span>.stringify(a))</span><br><span class="line">            <span class="comment">// console.log(a)</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(req.headers[<span class="string">'content-type'</span>] === <span class="string">'application/x-www-form-urlencoded'</span>)&#123;</span><br><span class="line">            <span class="keyword">let</span> ret = querystring.parse(obj)</span><br><span class="line">            res.end(<span class="built_in">JSON</span>.stringify(ret))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">1234</span>, () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'server is running'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"><span class="keyword">let</span> options = &#123;</span><br><span class="line">    host: <span class="string">'localhost'</span>,</span><br><span class="line">    port: <span class="number">1234</span>,</span><br><span class="line">    path: <span class="string">'/?a=1'</span>,</span><br><span class="line">    method: <span class="string">'POST'</span>,</span><br><span class="line">    headers: &#123;</span><br><span class="line">        <span class="comment">// 'Content-type': 'application/json'</span></span><br><span class="line">        <span class="string">'Content-type'</span>: <span class="string">'application/x-www-form-urlencoded'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> req = http.request(options,()=&gt;&#123;</span><br><span class="line">    <span class="keyword">let</span> arr = []</span><br><span class="line">    res.on(<span class="string">'data'</span>, (data)=&gt;&#123;</span><br><span class="line">        arr.push(data)</span><br><span class="line">    &#125;)</span><br><span class="line">    res.on(<span class="string">'end'</span>, ()=&gt;&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(Buffer.concat(arr).toString())</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// req.end('拉勾教育')</span></span><br><span class="line"><span class="comment">// req.end('&#123;"name":"lg"&#125;')</span></span><br><span class="line">req.end(<span class="string">'a=1&amp;b=2'</span>)</span><br></pre></td></tr></table></figure>

<h3 id="14-代理客户端解决跨域"><a href="#14-代理客户端解决跨域" class="headerlink" title="14.代理客户端解决跨域"></a>14.代理客户端解决跨域</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = http.createServer(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// console.log('请求进来了')</span></span><br><span class="line">    <span class="keyword">let</span> arr = []</span><br><span class="line">    req.on(<span class="string">'data'</span>, (data)=&gt;&#123;</span><br><span class="line">        arr.push(data)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    req.on(<span class="string">'end'</span>, ()=&gt;&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(Buffer.concat(arr).toString())</span><br><span class="line">        res.end(<span class="string">'拿到了客户端的数据'</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">1234</span>, () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'server is start'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"><span class="keyword">let</span> options = &#123;</span><br><span class="line">    host: <span class="string">'localhost'</span>,</span><br><span class="line">    port: <span class="number">1234</span>,</span><br><span class="line">    path: <span class="string">'/'</span>,</span><br><span class="line">    method: <span class="string">'POST'</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> server = http.createServer(<span class="function">(<span class="params">request, reaponse</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> req = http.request(options,()=&gt;&#123;</span><br><span class="line">    <span class="keyword">let</span> arr = []</span><br><span class="line">    res.on(<span class="string">'data'</span>, (data)=&gt;&#123;</span><br><span class="line">        arr.push(data)</span><br><span class="line">    &#125;)</span><br><span class="line">    res.on(<span class="string">'end'</span>, ()=&gt;&#123;</span><br><span class="line">        <span class="comment">// console.log(Buffer.concat(arr).toString())</span></span><br><span class="line">        <span class="keyword">let</span> ret = Buffer.concat(arr).toString()</span><br><span class="line">        response.setHeaders(<span class="string">'Content-type'</span>,<span class="string">'text/html;charset=utf-8'</span>)</span><br><span class="line">        response.end(ret)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line">req.end(<span class="string">'拉勾教育'</span>)</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">2345</span>,()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'本地的服务器启动了'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="15-Http-静态服务"><a href="#15-Http-静态服务" class="headerlink" title="15.Http 静态服务"></a>15.Http 静态服务</h3><ul>
<li>npm install mime</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"><span class="keyword">const</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> mime = <span class="built_in">require</span>(<span class="string">'mime'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = http.createServer(<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> &#123;pathname,query&#125; = url.parse(req.url)</span><br><span class="line">    pathname = <span class="built_in">decodeURIComponent</span>(pathname)</span><br><span class="line">    <span class="keyword">let</span> absPath = path.join(_dirname,pathname)</span><br><span class="line">    fs.stat(absPath,(err,statObj)=&gt;&#123;</span><br><span class="line">        <span class="keyword">if</span>(err) &#123;</span><br><span class="line">            res.statusCode = <span class="number">404</span></span><br><span class="line">            res.end(<span class="string">'Not Found'</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(statObj.isFile()) &#123;</span><br><span class="line">            fs.readFile(absPath, (err, data) =&gt; &#123;</span><br><span class="line">                res.setHeaders(<span class="string">'Content-type'</span>,mime.getType(absPath)+<span class="string">';charset=utf-8'</span>)</span><br><span class="line">                res.end(data)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            fs.readFile(path.join(absPath,<span class="string">'index.html'</span>),(err,data)=&gt;&#123;</span><br><span class="line">                res.setHeaders(<span class="string">'Content-type'</span>,mime.getType(absPath)+<span class="string">';charset=utf-8'</span>)</span><br><span class="line">                res.end(data)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">1234</span>, ()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'server is start...'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="16-lgserve-命令行配置"><a href="#16-lgserve-命令行配置" class="headerlink" title="16.lgserve 命令行配置"></a>16.lgserve 命令行配置</h3><p>|-bin<br>  |-<a href="http://www.js" target="_blank" rel="noopener">www.js</a><br>|-main.js<br>|-package.json</p>
<ul>
<li>npm install commander</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// www.js</span></span><br><span class="line"><span class="keyword">const</span> &#123;program&#125; = <span class="built_in">require</span>(<span class="string">'commmander'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// program.option(-p --port, 'set server port')</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> options = &#123;</span><br><span class="line">    <span class="string">'-p --port &lt;dir&gt;'</span>: &#123;</span><br><span class="line">        <span class="string">'description'</span>: <span class="string">'init server port'</span>,</span><br><span class="line">        <span class="string">'example'</span>: <span class="string">'lgserve -p 3306'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'-d --directory &lt;dir&gt;'</span>: &#123;</span><br><span class="line">        <span class="string">'description'</span>: <span class="string">'init server directory'</span>,</span><br><span class="line">        <span class="string">'example'</span>: <span class="string">'lgserve -d c:'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">formatConfig</span>(<span class="params">configs, cb</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">Object</span>.entries(configs).forEach(<span class="function">(<span class="params">[key,val]</span>)=&gt;</span>&#123;</span><br><span class="line">        cb(key, val)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">formatConfig(options, (cmd,val) =&gt; &#123;</span><br><span class="line">    program.option(cmd,val,description)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">program.on(<span class="string">'--help'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Examples:'</span>)</span><br><span class="line">    formatConfig(options, (cmd, val) =&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(val.example)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">program.name(<span class="string">'lgserve'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> version = <span class="built_in">require</span>(<span class="string">'../package.json'</span>).version</span><br><span class="line">program.version(version)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> cmdConfig = program.parse(process.argv)</span><br><span class="line"><span class="built_in">console</span>.log(cmdConfig)</span><br></pre></td></tr></table></figure>

<h3 id="17-lgserve-启动web服务"><a href="#17-lgserve-启动web服务" class="headerlink" title="17.lgserve 启动web服务"></a>17.lgserve 启动web服务</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// www.js</span></span><br><span class="line"><span class="keyword">const</span> &#123;program&#125; = <span class="built_in">require</span>(<span class="string">'commmander'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// program.option(-p --port, 'set server port')</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> options = &#123;</span><br><span class="line">    <span class="string">'-p --port &lt;dir&gt;'</span>: &#123;</span><br><span class="line">        <span class="string">'description'</span>: <span class="string">'init server port'</span>,</span><br><span class="line">        <span class="string">'example'</span>: <span class="string">'lgserve -p 3306'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'-d --directory &lt;dir&gt;'</span>: &#123;</span><br><span class="line">        <span class="string">'description'</span>: <span class="string">'init server directory'</span>,</span><br><span class="line">        <span class="string">'example'</span>: <span class="string">'lgserve -d c:'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">formatConfig</span>(<span class="params">configs, cb</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">Object</span>.entries(configs).forEach(<span class="function">(<span class="params">[key,val]</span>)=&gt;</span>&#123;</span><br><span class="line">        cb(key, val)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">formatConfig(options, (cmd,val) =&gt; &#123;</span><br><span class="line">    program.option(cmd,val,description)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">program.on(<span class="string">'--help'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Examples:'</span>)</span><br><span class="line">    formatConfig(options, (cmd, val) =&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(val.example)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">program.name(<span class="string">'lgserve'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> version = <span class="built_in">require</span>(<span class="string">'../package.json'</span>).version</span><br><span class="line">program.version(version)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> cmdConfig = program.parse(process.argv)</span><br><span class="line"><span class="built_in">console</span>.log(cmdConfig)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> Server = rerquire(<span class="string">'../main.js'</span>)</span><br><span class="line"><span class="keyword">new</span> Serever(cmdConfig).start()</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.js</span></span><br><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mergeConfig</span>(<span class="params">config</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        port: <span class="number">1234</span>,</span><br><span class="line">        directory: process.cwd(),</span><br><span class="line">        ...config</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(config)&#123;</span><br><span class="line">       <span class="keyword">this</span>.config = mergeConfig(config)</span><br><span class="line">    &#125;</span><br><span class="line">    start()&#123;</span><br><span class="line">        <span class="keyword">let</span> server = http.createServer(<span class="keyword">this</span>.serverHandle.bind(<span class="keyword">this</span>))</span><br><span class="line">        server.listen(<span class="keyword">this</span>.config.port,()=&gt;&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'服务端已经启动了...'</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    serverHandle(req,res) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'有请求进来了'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = Server</span><br></pre></td></tr></table></figure>

<h3 id="18-lgserve-处理文件资源"><a href="#18-lgserve-处理文件资源" class="headerlink" title="18.lgserve 处理文件资源"></a>18.lgserve 处理文件资源</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.js</span></span><br><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"><span class="keyword">const</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>).promise</span><br><span class="line"><span class="keyword">const</span> &#123;createReadStream&#125; = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> mime = requrie(<span class="string">'mime'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mergeConfig</span>(<span class="params">config</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        port: <span class="number">1234</span>,</span><br><span class="line">        directory: process.cwd(),</span><br><span class="line">        ...config</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(config)&#123;</span><br><span class="line">       <span class="keyword">this</span>.config = mergeConfig(config)</span><br><span class="line">    &#125;</span><br><span class="line">    start()&#123;</span><br><span class="line">        <span class="keyword">let</span> server = http.createServer(<span class="keyword">this</span>.serverHandle.bind(<span class="keyword">this</span>))</span><br><span class="line">        server.listen(<span class="keyword">this</span>.config.port,()=&gt;&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'服务端已经启动了...'</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">async</span> serverHandle(req,res) &#123;</span><br><span class="line">        <span class="keyword">let</span> pathname = url.parse(req.url)</span><br><span class="line">        pathname = <span class="built_in">decodeURIComponent</span>(pathname)</span><br><span class="line">        <span class="keyword">let</span> abspath = path.join(<span class="keyword">this</span>.config.directory, pathname)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> statObj = <span class="keyword">await</span> fs.stat(abspath)</span><br><span class="line">            <span class="keyword">if</span>(statObj.isFile())&#123;</span><br><span class="line">                <span class="keyword">this</span>.fileHandle(req,res,abspath)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">            <span class="keyword">this</span>.errorHandle(req, res, err)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    errorHandle(req, res, err)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err)</span><br><span class="line">        res.statusCode = <span class="number">404</span></span><br><span class="line">        res.setHeader(<span class="string">'Content-type'</span>,<span class="string">'text/html;charset=utf-8'</span>)</span><br><span class="line">        res.end(<span class="string">'Not Found'</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fileHandle(req,res,abspath)&#123;</span><br><span class="line">        res.statusCode = <span class="number">200</span></span><br><span class="line">        res.setHeader(<span class="string">'Content-type'</span>,mime.getType(abspath) + <span class="string">';charset=utf-8'</span>)</span><br><span class="line">        createReadStream(abspath).pipe(res)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = Server</span><br></pre></td></tr></table></figure>

<h3 id="19-lgserve-处理目录资源"><a href="#19-lgserve-处理目录资源" class="headerlink" title="19.lgserve 处理目录资源"></a>19.lgserve 处理目录资源</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.js</span></span><br><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"><span class="keyword">const</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>).promise</span><br><span class="line"><span class="keyword">const</span> &#123;createReadStream&#125; = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> mime = requrie(<span class="string">'mime'</span>)</span><br><span class="line"><span class="keyword">const</span> ejs = <span class="built_in">require</span>(<span class="string">'ejs'</span>)</span><br><span class="line"><span class="keyword">const</span> &#123;promisify&#125; = <span class="built_in">require</span>(<span class="string">'url'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mergeConfig</span>(<span class="params">config</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        port: <span class="number">1234</span>,</span><br><span class="line">        directory: process.cwd(),</span><br><span class="line">        ...config</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(config)&#123;</span><br><span class="line">       <span class="keyword">this</span>.config = mergeConfig(config)</span><br><span class="line">    &#125;</span><br><span class="line">    start()&#123;</span><br><span class="line">        <span class="keyword">let</span> server = http.createServer(<span class="keyword">this</span>.serverHandle.bind(<span class="keyword">this</span>))</span><br><span class="line">        server.listen(<span class="keyword">this</span>.config.port,()=&gt;&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'服务端已经启动了...'</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">async</span> serverHandle(req,res) &#123;</span><br><span class="line">        <span class="keyword">let</span> pathname = url.parse(req.url)</span><br><span class="line">        pathname = <span class="built_in">decodeURIComponent</span>(pathname)</span><br><span class="line">        <span class="keyword">let</span> abspath = path.join(<span class="keyword">this</span>.config.directory, pathname)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> statObj = <span class="keyword">await</span> fs.stat(abspath)</span><br><span class="line">            <span class="keyword">if</span>(statObj.isFile())&#123;</span><br><span class="line">                <span class="keyword">this</span>.fileHandle(req,res,abspath)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> dirs = <span class="keyword">await</span> fs.readdir(abspath)</span><br><span class="line">                <span class="comment">// console.log(dirs)</span></span><br><span class="line">                <span class="keyword">let</span> renderFile = promisify(ejs.renderFile)</span><br><span class="line">                <span class="keyword">let</span> ret = <span class="keyword">await</span> renderFile(path.resolve(__dirname, <span class="string">'template.html'</span>),&#123;<span class="attr">arr</span>:dirs&#125;)</span><br><span class="line">                res.end(ret)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">            <span class="keyword">this</span>.errorHandle(req, res, err)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    errorHandle(req, res, err)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err)</span><br><span class="line">        res.statusCode = <span class="number">404</span></span><br><span class="line">        res.setHeader(<span class="string">'Content-type'</span>,<span class="string">'text/html;charset=utf-8'</span>)</span><br><span class="line">        res.end(<span class="string">'Not Found'</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fileHandle(req,res,abspath)&#123;</span><br><span class="line">        res.statusCode = <span class="number">200</span></span><br><span class="line">        res.setHeader(<span class="string">'Content-type'</span>,mime.getType(abspath) + <span class="string">';charset=utf-8'</span>)</span><br><span class="line">        createReadStream(abspath).pipe(res)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = Server</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    &lt;%for(let i = 0; i &lt; arr.length; i++)&#123;%&gt;</span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span><span class="tag">&lt;<span class="name">%=arr[i]%</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">%&#125;%</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="20-lgserve-模板数据渲染"><a href="#20-lgserve-模板数据渲染" class="headerlink" title="20.lgserve 模板数据渲染"></a>20.lgserve 模板数据渲染</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>IndexOf <span class="tag">&lt;<span class="name">%=title%</span>&gt;</span><span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">%if(parent)&#123;%</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&lt;%=parentpath%&gt;"</span>&gt;</span>上一层<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">%&#125;%</span>&gt;</span><span class="tag">&lt;<span class="name">%=arr[i].path%</span>&gt;</span></span><br><span class="line">    &lt;%for(let i = 0; i &lt; arr.length; i++)&#123;%&gt;</span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span><span class="tag">&lt;<span class="name">%=arr[i]%</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">%&#125;%</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.js</span></span><br><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"><span class="keyword">const</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>).promise</span><br><span class="line"><span class="keyword">const</span> &#123;createReadStream&#125; = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> mime = requrie(<span class="string">'mime'</span>)</span><br><span class="line"><span class="keyword">const</span> ejs = <span class="built_in">require</span>(<span class="string">'ejs'</span>)</span><br><span class="line"><span class="keyword">const</span> &#123;promisify&#125; = <span class="built_in">require</span>(<span class="string">'url'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mergeConfig</span>(<span class="params">config</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        port: <span class="number">1234</span>,</span><br><span class="line">        directory: process.cwd(),</span><br><span class="line">        ...config</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(config)&#123;</span><br><span class="line">       <span class="keyword">this</span>.config = mergeConfig(config)</span><br><span class="line">    &#125;</span><br><span class="line">    start()&#123;</span><br><span class="line">        <span class="keyword">let</span> server = http.createServer(<span class="keyword">this</span>.serverHandle.bind(<span class="keyword">this</span>))</span><br><span class="line">        server.listen(<span class="keyword">this</span>.config.port,()=&gt;&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'服务端已经启动了...'</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">async</span> serverHandle(req,res) &#123;</span><br><span class="line">        <span class="keyword">let</span> pathname = url.parse(req.url)</span><br><span class="line">        pathname = <span class="built_in">decodeURIComponent</span>(pathname)</span><br><span class="line">        <span class="keyword">let</span> abspath = path.join(<span class="keyword">this</span>.config.directory, pathname)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> statObj = <span class="keyword">await</span> fs.stat(abspath)</span><br><span class="line">            <span class="keyword">if</span>(statObj.isFile())&#123;</span><br><span class="line">                <span class="keyword">this</span>.fileHandle(req,res,abspath)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> dirs = <span class="keyword">await</span> fs.readdir(abspath)</span><br><span class="line">                <span class="comment">// console.log(dirs)</span></span><br><span class="line">                dirs = dirs.map(<span class="function">(<span class="params">item</span>)=&gt;</span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> &#123;</span><br><span class="line">                        path: path.join(pathname,item),</span><br><span class="line">                        dirs: item</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="keyword">let</span> renderFile = promisify(ejs.renderFile)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">let</span> parentpath = path.dirname(pathname)</span><br><span class="line">                <span class="keyword">let</span> ret = <span class="keyword">await</span> renderFile(path.resolve(__dirname, <span class="string">'template.html'</span>),</span><br><span class="line">                &#123;</span><br><span class="line">                    arr:dirs,</span><br><span class="line">                    parent: pathname === <span class="string">'/'</span> ? <span class="literal">false</span> : <span class="literal">true</span>,</span><br><span class="line">                    parentpath: parentpath,</span><br><span class="line">                    title: path.basename(abspath)</span><br><span class="line">                &#125;)</span><br><span class="line">                res.end(ret)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">            <span class="keyword">this</span>.errorHandle(req, res, err)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    errorHandle(req, res, err)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err)</span><br><span class="line">        res.statusCode = <span class="number">404</span></span><br><span class="line">        res.setHeader(<span class="string">'Content-type'</span>,<span class="string">'text/html;charset=utf-8'</span>)</span><br><span class="line">        res.end(<span class="string">'Not Found'</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fileHandle(req,res,abspath)&#123;</span><br><span class="line">        res.statusCode = <span class="number">200</span></span><br><span class="line">        res.setHeader(<span class="string">'Content-type'</span>,mime.getType(abspath) + <span class="string">';charset=utf-8'</span>)</span><br><span class="line">        createReadStream(abspath).pipe(res)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = Server</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/07/20/44/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="FY">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="旋の飞羽">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/07/20/44/" itemprop="url">表达一些观点</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-07-20T00:00:00+08:00">
                2021-07-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%9D%82%E8%AE%B0/" itemprop="url" rel="index">
                    <span itemprop="name">杂记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>作者：FY<br>引用请标明出处</p>
</blockquote>
<p>相信沉默的力量。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/05/10/43/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="FY">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="旋の飞羽">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/10/43/" itemprop="url">学习笔记 ----- 【React 框架原理与实战】Angular 企业实战开发</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-10T00:00:00+08:00">
                2021-05-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index">
                    <span itemprop="name">前端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>作者：FY<br>引用请标明出处</p>
</blockquote>
<h1 id="Part-4-·-React-框架原理与实战"><a href="#Part-4-·-React-框架原理与实战" class="headerlink" title="Part 4 · React 框架原理与实战"></a>Part 4 · React 框架原理与实战</h1><h2 id="模块六-·-Angular-企业实战开发"><a href="#模块六-·-Angular-企业实战开发" class="headerlink" title="模块六 · Angular 企业实战开发"></a>模块六 · Angular 企业实战开发</h2><h2 id="任务一：Angular-基础"><a href="#任务一：Angular-基础" class="headerlink" title="任务一：Angular 基础"></a>任务一：Angular 基础</h2><h3 id="1-Angular-框架介绍"><a href="#1-Angular-框架介绍" class="headerlink" title="1.Angular 框架介绍"></a>1.Angular 框架介绍</h3><ul>
<li>Angular 是一个使用 HTML、CSS、TypeScript 构建客户端应用的框架，用来构建单页应用程序。</li>
<li>Angular 是一个重量级的框架，内部集成了大量开箱即用的功能模块。</li>
<li>Angular 为大型应用开发而设计，提供了干净且松耦合的代码组织方式，使应用程序整洁更易于维护。</li>
</ul>
<h3 id="2-Angular架构-模块"><a href="#2-Angular架构-模块" class="headerlink" title="2.Angular架构-模块"></a>2.Angular架构-模块</h3><p>Angular 应用是由一个个模块组成的，此模块指的不是ESModule，而是 NgModule 即 Angular 模块。</p>
<p>NgModule 是一组相关功能的集合，专注于某个应用领域，可以将组件和一组相关代码关联起来，是应用组织代码结构的一种方式。</p>
<p>在 Angular 应用中至少要有一个根模块，用于启动应用程序。</p>
<p>NgModule 可以从其它 NgModule 中导入功能，前提是目标 NgModule 导出了该功能。</p>
<p>NgModule 是由 NgModule 装饰器函数装饰的类。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; BrowserModule &#125; <span class="keyword">from</span> <span class="string">'@angular/platform-browser'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; NgModule &#125; <span class="keyword">from</span> <span class="string">'@angular/core'</span>;</span><br><span class="line"></span><br><span class="line">@NgModule(&#123;</span><br><span class="line">  imports: [</span><br><span class="line">    BrowserModule</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> </span>&#123; &#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-Angular架构-组件"><a href="#3-Angular架构-组件" class="headerlink" title="3.Angular架构-组件"></a>3.Angular架构-组件</h3><p>组件用来描述用户界面，它由三部分组成，组件类、组件模板、组件样式，它们可以被集成在组件类文件中，也可以是三个不同的文件。</p>
<ul>
<li>组件类用来编写和组件直接相关的界面逻辑，在组件类中要关联该组件的组件模板和组件样式。</li>
<li>组件模板用来编写组件的 HTML 结构，通过数据绑定标记将应用中数据和 DOM 进行关联。</li>
<li>组件样式用来编写组件的组件的外观，组件样式可以采用 CSS、LESS、SCSS、Stylus</li>
</ul>
<p>在 Angular 应用中至少要有一个根组件，用于应用程序的启动。</p>
<p>组件类是由 Component 装饰器函数装饰的类。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component &#125; <span class="keyword">from</span> <span class="string">"@angular/core"</span></span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">"app-root"</span>,</span><br><span class="line">  templateUrl: <span class="string">"./app.component.html"</span>,</span><br><span class="line">  styleUrls: [<span class="string">"./app.component.css"</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  title = <span class="string">"angular-test"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NgModule 为组件提供了编译的上下文环境。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; NgModule &#125; <span class="keyword">from</span> <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppComponent &#125; <span class="keyword">from</span> <span class="string">'./app.component'</span>;</span><br><span class="line"></span><br><span class="line">@NgModule(&#123;</span><br><span class="line">  declarations: [</span><br><span class="line">    AppComponent</span><br><span class="line">  ],</span><br><span class="line">  bootstrap: [AppComponent]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> </span>&#123; &#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-Angular架构-服务"><a href="#4-Angular架构-服务" class="headerlink" title="4.Angular架构-服务"></a>4.Angular架构-服务</h3><ul>
<li>服务用于放置和特定组件无关并希望跨组件共享的数据或逻辑。</li>
<li>服务出现的目的在于解耦组件类中的代码，是组件类中的代码干净整洁。</li>
<li>服务是由 Injectable 装饰器装饰的类。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@angular/core'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable(&#123;&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppService</span> </span>&#123; &#125;</span><br></pre></td></tr></table></figure>

<p>在使用服务时不需要在组件类中通过 new 的方式创建服务实例对象获取服务中提供的方法，以下写法错误，切记切记！！！</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; AppService &#125; <span class="keyword">from</span> <span class="string">"./AppService"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> appService = <span class="keyword">new</span> AppService()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务的实例对象由 Angular 框架中内置的依赖注入系统创建和维护。服务是依赖需要被注入到组件中。</p>
<p>在组件中需要通过 constructor 构造函数的参数来获取服务的实例对象。</p>
<p>涉及参数就需要考虑参数的顺序问题，因为在 Angular 应用中会有很多服务，一个组件又不可能会使用到所有服务，如果组件要使用到最后一个服务实例对象，难道要将前面的所有参数都写上吗 ? 这显然不合理。</p>
<p>在组件中获取服务实例对象要结合 TypeScript 类型，写法如下。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; AppService &#125; <span class="keyword">from</span> <span class="string">"./AppService"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span> (</span><br><span class="line">  	private appService: AppService</span><br><span class="line">  ) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Angular 会根据你指定的服务的类型来传递你想要使用的服务实例对象，这样就解决了参数的顺序问题。</p>
<p>在 Angular 中服务被设计为单例模式，这也正是为什么服务可以被用来在组件之间共享数据和逻辑的原因。</p>
<h3 id="5-Angular架构-总结"><a href="#5-Angular架构-总结" class="headerlink" title="5.Angular架构-总结"></a>5.Angular架构-总结</h3><p>略</p>
<h3 id="6-使用AngularCLI创建应用"><a href="#6-使用AngularCLI创建应用" class="headerlink" title="6.使用AngularCLI创建应用"></a>6.使用AngularCLI创建应用</h3><ol>
<li><p>安装 angular-cli：<code>npm install @angular/cli -g</code></p>
</li>
<li><p>创建应用：<code>ng new angular-test --minimal --inlineTemplate false</code></p>
<ol>
<li>–skipGit=true</li>
<li>–minimal=true</li>
<li>–skip-install</li>
<li>–style=css</li>
<li>–routing=false</li>
<li>–inlineTemplate</li>
<li>–inlineStyle</li>
<li>–prefix</li>
</ol>
</li>
<li><p>运行应用：<code>ng serve</code></p>
<ol>
<li>–open=true 应用构建完成后在浏览器中运行</li>
<li>–hmr=true 开启热更新</li>
<li>hmrWarning=false 禁用热更新警告</li>
<li>–port 更改应用运行端口</li>
</ol>
</li>
<li><p>访问应用：<code>localhost:4200</code></p>
</li>
</ol>
<h3 id="7-Angular应用默认代码解析及应用启动过程"><a href="#7-Angular应用默认代码解析及应用启动过程" class="headerlink" title="7.Angular应用默认代码解析及应用启动过程"></a>7.Angular应用默认代码解析及应用启动过程</h3><blockquote>
<p>main.ts</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// enableProdMode 方法调用后将会开启生产模式</span></span><br><span class="line"><span class="keyword">import</span> &#123; enableProdMode &#125; <span class="keyword">from</span> <span class="string">"@angular/core"</span></span><br><span class="line"><span class="comment">// Angular 应用程序的启动在不同的平台上是不一样的</span></span><br><span class="line"><span class="comment">// 在浏览器中启动时需要用到 platformBrowserDynamic 方法, 该方法返回平台实例对象</span></span><br><span class="line"><span class="keyword">import</span> &#123; platformBrowserDynamic &#125; <span class="keyword">from</span> <span class="string">"@angular/platform-browser-dynamic"</span></span><br><span class="line"><span class="comment">// 引入根模块 用于启动应用程序</span></span><br><span class="line"><span class="keyword">import</span> &#123; AppModule &#125; <span class="keyword">from</span> <span class="string">"./app/app.module"</span></span><br><span class="line"><span class="comment">// 引入环境变量对象 &#123; production: false &#125;</span></span><br><span class="line"><span class="keyword">import</span> &#123; environment &#125; <span class="keyword">from</span> <span class="string">"./environments/environment"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果当前为生产环境</span></span><br><span class="line"><span class="keyword">if</span> (environment.production) &#123;</span><br><span class="line">  <span class="comment">// 开启生产模式</span></span><br><span class="line">  enableProdMode()</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 启动应用程序</span></span><br><span class="line">platformBrowserDynamic()</span><br><span class="line">  .bootstrapModule(AppModule)</span><br><span class="line">  .catch(<span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.error(err))</span><br></pre></td></tr></table></figure>

<h3 id="8-共享模块"><a href="#8-共享模块" class="headerlink" title="8.共享模块"></a>8.共享模块</h3><p>共享模块当中放置的是 Angular 应用中模块级别的需要共享的组件或逻辑。</p>
<ol>
<li><p>创建共享模块： <code>ng g m shared</code> </p>
</li>
<li><p>创建共享组件：<code>ng g c shared/components/Layout</code></p>
</li>
<li><p>在共享模块中导出共享组件 </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@NgModule(&#123;</span><br><span class="line">  declarations: [LayoutComponent],</span><br><span class="line">  exports: [LayoutComponent]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">SharedModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在根模块中导入共享模块</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@NgModule(&#123;</span><br><span class="line">  declarations: [AppComponent],</span><br><span class="line">  imports: [SharedModule],</span><br><span class="line">  bootstrap: [AppComponent]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在根组件中使用 Layout 组件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">"app-root"</span>,</span><br><span class="line">  template: <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;div&gt;App works&lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;app-layout&gt;&lt;/app-layout&gt;</span></span><br><span class="line"><span class="string">  `</span>,</span><br><span class="line">  styles: []</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123; &#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="9-数据绑定"><a href="#9-数据绑定" class="headerlink" title="9.数据绑定"></a>9.数据绑定</h3><p>数据绑定就是将组件类中的数据显示在组件模板中，当组件类中的数据发生变化时会自动被同步到组件模板中（数据驱动 DOM ）。</p>
<p>在 Angular 中使用差值表达式进行数据绑定，即大胡子语法。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>&#123;&#123;message&#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>&#123;&#123;getInfo()&#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>&#123;&#123;a == b ? '相等': '不等'&#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>&#123;&#123;'Hello Angular'&#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span> [<span class="attr">innerHTML</span>]=<span class="string">"htmlSnippet"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span> <span class="comment">&lt;!-- 对数据中的代码进行转义 --&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="10-DOM对象的属性绑定和HTML标记的属性绑定"><a href="#10-DOM对象的属性绑定和HTML标记的属性绑定" class="headerlink" title="10.DOM对象的属性绑定和HTML标记的属性绑定"></a>10.DOM对象的属性绑定和HTML标记的属性绑定</h3><p>属性绑定分为两种情况，绑定 DOM 对象属性和绑定HTML标记属性。</p>
<ol>
<li>使用 [属性名称] 为元素绑定 DOM 对象属性。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> [<span class="attr">src</span>]=<span class="string">"imgUrl"</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>使用 [attr.属性名称] 为元素绑定 HTML 标记属性</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">td</span> [<span class="attr">attr.colspan</span>]=<span class="string">"colSpan"</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在大多数情况下，DOM 对象属性和 HTML 标记属性是对应的关系，所以使用第一种情况。但是某些属性只有 HTML 标记存在，DOM 对象中不存在，此时需要使用第二种情况，比如 colspan 属性，在 DOM 对象中就没有，或者自定义 HTML 属性也需要使用第二种情况。</p>
<h3 id="11-动态为元素添加类名及行内样式"><a href="#11-动态为元素添加类名及行内样式" class="headerlink" title="11.动态为元素添加类名及行内样式"></a>11.动态为元素添加类名及行内样式</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn btn-primary"</span> [<span class="attr">class.active</span>]=<span class="string">"isActive"</span>&gt;</span>按钮<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> [<span class="attr">ngClass</span>]=<span class="string">"&#123;'active': true, 'error': true&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> [<span class="attr">style.backgroundColor</span>]=<span class="string">"isActive ? 'blue': 'red'"</span>&gt;</span>按钮<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> [<span class="attr">ngStyle</span>]=<span class="string">"&#123;'backgroundColor': 'red'&#125;"</span>&gt;</span>按钮<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="12-事件绑定"><a href="#12-事件绑定" class="headerlink" title="12.事件绑定"></a>12.事件绑定</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> (<span class="attr">click</span>)=<span class="string">"onSave($event)"</span>&gt;</span>按钮<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 当按下回车键抬起的时候执行函数 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> (<span class="attr">keyup.enter</span>)=<span class="string">"onKeyUp()"</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  title = <span class="string">"test"</span></span><br><span class="line">  onSave(event: Event) &#123;</span><br><span class="line">    <span class="comment">// this 指向组件类的实例对象</span></span><br><span class="line">    <span class="keyword">this</span>.title <span class="comment">// "test"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="13-获取原生-DOM-对象"><a href="#13-获取原生-DOM-对象" class="headerlink" title="13.获取原生 DOM 对象"></a>13.获取原生 DOM 对象</h3><blockquote>
<p>在组件模板中获取</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> (<span class="attr">keyup.enter</span>)=<span class="string">"onKeyUp(username.value)"</span> #<span class="attr">username</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>在组件类中获取</p>
</blockquote>
<p>使用 ViewChild 装饰器获取一个元素</p>
 <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span> #<span class="attr">paragraph</span>&gt;</span>home works!<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; AfterViewInit, ElementRef, ViewChild &#125; <span class="keyword">from</span> <span class="string">"@angular/core"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeComponent</span> <span class="title">implements</span> <span class="title">AfterViewInit</span> </span>&#123;</span><br><span class="line">  @ViewChild(<span class="string">"paragraph"</span>) paragraph: ElementRef&lt;HTMLParagraphElement&gt; | <span class="literal">undefined</span></span><br><span class="line">  ngAfterViewInit() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.paragraph?.nativeElement)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 ViewChildren 获取一组元素</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span> #<span class="attr">items</span>&gt;</span>a<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span> #<span class="attr">items</span>&gt;</span>b<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span> #<span class="attr">items</span>&gt;</span>c<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; AfterViewInit, QueryList, ViewChildren &#125; <span class="keyword">from</span> <span class="string">"@angular/core"</span></span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">"app-home"</span>,</span><br><span class="line">  templateUrl: <span class="string">"./home.component.html"</span>,</span><br><span class="line">  styles: []</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeComponent</span> <span class="title">implements</span> <span class="title">AfterViewInit</span> </span>&#123;</span><br><span class="line">  @ViewChildren(<span class="string">"items"</span>) items: QueryList&lt;HTMLLIElement&gt; | <span class="literal">undefined</span></span><br><span class="line">  ngAfterViewInit() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.items?.toArray())</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="14-双向数据绑定"><a href="#14-双向数据绑定" class="headerlink" title="14.双向数据绑定"></a>14.双向数据绑定</h3><p>数据在组件类和组件模板中双向同步。</p>
<p>Angular 将双向数据绑定功能放在了 @angular/forms 模块中，所以要实现双向数据绑定需要依赖该模块。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; FormsModule &#125; <span class="keyword">from</span> <span class="string">"@angular/forms"</span></span><br><span class="line"></span><br><span class="line">@NgModule(&#123;</span><br><span class="line">  imports: [FormsModule],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> [(<span class="attr">ngModel</span>)]=<span class="string">"username"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> (<span class="attr">click</span>)=<span class="string">"change()"</span>&gt;</span>在组件类中更改 username<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>username: &#123;&#123; username &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  username: string = <span class="string">""</span></span><br><span class="line">  change() &#123;</span><br><span class="line">    <span class="keyword">this</span>.username = <span class="string">"hello Angular"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="15-内容投影"><a href="#15-内容投影" class="headerlink" title="15.内容投影"></a>15.内容投影</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- app.component.html --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bootstrap-panel</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"heading"</span>&gt;</span></span><br><span class="line">        Heading</span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"body"</span>&gt;</span></span><br><span class="line">        Body</span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bootstrap-panel</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- panel.component.html --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel panel-default"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-heading"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ng-content</span> <span class="attr">select</span>=<span class="string">".heading"</span>&gt;</span><span class="tag">&lt;/<span class="name">ng-content</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ng-content</span> <span class="attr">select</span>=<span class="string">".body"</span>&gt;</span><span class="tag">&lt;/<span class="name">ng-content</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果只有一个ng-content，不需要select属性。</p>
<p>ng-content在浏览器中会被 &lt;div class=”heading”&gt;&lt;/div&gt; 替代，如果不想要这个额外的div，可以使用ng-container替代这个div。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- app.component.html --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bootstrap-panel</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">ng-container</span> <span class="attr">class</span>=<span class="string">"heading"</span>&gt;</span></span><br><span class="line">        Heading</span><br><span class="line">    <span class="tag">&lt;/<span class="name">ng-container</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ng-container</span> <span class="attr">class</span>=<span class="string">"body"</span>&gt;</span></span><br><span class="line">        Body</span><br><span class="line">    <span class="tag">&lt;/<span class="name">ng-container</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bootstrap-panel</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="16-数据绑定的容错处理"><a href="#16-数据绑定的容错处理" class="headerlink" title="16.数据绑定的容错处理"></a>16.数据绑定的容错处理</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.component.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">    task = &#123;</span><br><span class="line">        person: &#123;</span><br><span class="line">            name: <span class="string">'张三'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 方式一 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">span</span> *<span class="attr">ngIf</span>=<span class="string">"task.person"</span>&gt;</span>&#123;&#123; task.person.name &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 方式二 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;&#123; task.person?.name &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="17-引入全局样式的三种方式"><a href="#17-引入全局样式的三种方式" class="headerlink" title="17.引入全局样式的三种方式"></a>17.引入全局样式的三种方式</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 第一种方式 在 styles.css 文件中 */</span></span><br><span class="line"><span class="keyword">@import</span> <span class="string">"~bootstrap/dist/css/bootstrap.css"</span>;</span><br><span class="line"><span class="comment">/* ~ 相对node_modules文件夹 */</span></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 第二种方式 在 index.html 文件中  --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 第三种方式 在 angular.json 文件中</span></span><br><span class="line"><span class="string">"styles"</span>: [</span><br><span class="line">  <span class="string">"./node_modules/bootstrap/dist/css/bootstrap.min.css"</span>,</span><br><span class="line">  <span class="string">"src/styles.css"</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h3 id="18-指令介绍及结构指令ngIf的两种使用方式"><a href="#18-指令介绍及结构指令ngIf的两种使用方式" class="headerlink" title="18.指令介绍及结构指令ngIf的两种使用方式"></a>18.指令介绍及结构指令ngIf的两种使用方式</h3><p>指令是 Angular 提供的操作 DOM 的途径。指令分为属性指令和结构指令。</p>
<p>属性指令：修改现有元素的外观或行为，使用 [] 包裹。</p>
<p>结构指令：增加、删除 DOM 节点以修改布局，使用*作为指令前缀</p>
<blockquote>
<p>内置指令</p>
</blockquote>
<ul>
<li>*ngIf </li>
</ul>
<p>根据条件渲染 DOM 节点或移除 DOM 节点。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> *<span class="attr">ngIf</span>=<span class="string">"data.length == 0"</span>&gt;</span>没有更多数据<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> *<span class="attr">ngIf</span>=<span class="string">"data.length &gt; 0; then dataList else noData"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ng-template</span> #<span class="attr">dataList</span>&gt;</span>课程列表<span class="tag">&lt;/<span class="name">ng-template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ng-template</span> #<span class="attr">noData</span>&gt;</span>没有更多数据<span class="tag">&lt;/<span class="name">ng-template</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="19-属性指令hidden"><a href="#19-属性指令hidden" class="headerlink" title="19.属性指令hidden"></a>19.属性指令hidden</h3><p>根据条件显示 DOM 节点或隐藏 DOM 节点 (display)。 </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> [<span class="attr">hidden</span>]=<span class="string">"data.length == 0"</span>&gt;</span>课程列表<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> [<span class="attr">hidden</span>]=<span class="string">"data.length &gt; 0"</span>&gt;</span>没有更多数据<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="20-结构指令ngFor的使用方式"><a href="#20-结构指令ngFor的使用方式" class="headerlink" title="20.结构指令ngFor的使用方式"></a>20.结构指令ngFor的使用方式</h3><p>遍历数据生成HTML结构</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">interface List &#123;</span><br><span class="line">  id: number</span><br><span class="line">  name: string</span><br><span class="line">  age: number</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">list: List[] = [</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="string">"张三"</span>, <span class="attr">age</span>: <span class="number">20</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">2</span>, <span class="attr">name</span>: <span class="string">"李四"</span>, <span class="attr">age</span>: <span class="number">30</span> &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">li</span></span></span><br><span class="line"><span class="tag">    *<span class="attr">ngFor</span>=<span class="string">"</span></span></span><br><span class="line"><span class="tag"><span class="string">      let item of list;</span></span></span><br><span class="line"><span class="tag"><span class="string">      let i = index;</span></span></span><br><span class="line"><span class="tag"><span class="string">      let isEven = even;</span></span></span><br><span class="line"><span class="tag"><span class="string">      let isOdd = odd;</span></span></span><br><span class="line"><span class="tag"><span class="string">      let isFirst = first;</span></span></span><br><span class="line"><span class="tag"><span class="string">      let isLast = last;</span></span></span><br><span class="line"><span class="tag"><span class="string">    "</span></span></span><br><span class="line"><span class="tag">  &gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">li</span> *<span class="attr">ngFor</span>=<span class="string">"let item of list; trackBy: identify"</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">identify(index, item)&#123;</span><br><span class="line">  <span class="keyword">return</span> item.id; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="21-自定义指令用法"><a href="#21-自定义指令用法" class="headerlink" title="21.自定义指令用法"></a>21.自定义指令用法</h3><p>需求：为元素设置默认背景颜色，鼠标移入时的背景颜色以及移出时的背景颜色。</p>
 <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> [<span class="attr">appHover</span>]=<span class="string">"&#123; bgColor: 'skyblue' &#125;"</span>&gt;</span>Hello Angular<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; AfterViewInit, Directive, ElementRef, HostListener, Input &#125; <span class="keyword">from</span> <span class="string">"@angular/core"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 接收参的数类型</span></span><br><span class="line">interface Options &#123;</span><br><span class="line">  bgColor?: string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Directive(&#123;</span><br><span class="line">  selector: <span class="string">"[appHover]"</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">HoverDirective</span> <span class="title">implements</span> <span class="title">AfterViewInit</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 接收参数</span></span><br><span class="line">  @Input(<span class="string">"appHover"</span>) appHover: Options = &#123;&#125;</span><br><span class="line">  <span class="comment">// 要操作的 DOM 节点</span></span><br><span class="line">  element: HTMLElement</span><br><span class="line">	<span class="comment">// 获取要操作的 DOM 节点</span></span><br><span class="line">  <span class="keyword">constructor</span>(private elementRef: ElementRef) &#123;</span><br><span class="line">    <span class="keyword">this</span>.element = <span class="keyword">this</span>.elementRef.nativeElement</span><br><span class="line">  &#125;</span><br><span class="line">	<span class="comment">// 组件模板初始完成后设置元素的背景颜色</span></span><br><span class="line">  ngAfterViewInit() &#123;</span><br><span class="line">    <span class="keyword">this</span>.element.style.backgroundColor = <span class="keyword">this</span>.appHover.bgColor || <span class="string">"skyblue"</span></span><br><span class="line">  &#125;</span><br><span class="line">	<span class="comment">// 为元素添加鼠标移入事件</span></span><br><span class="line">  @HostListener(<span class="string">"mouseenter"</span>) enter() &#123;</span><br><span class="line">    <span class="keyword">this</span>.element.style.backgroundColor = <span class="string">"pink"</span></span><br><span class="line">  &#125;</span><br><span class="line">	<span class="comment">// 为元素添加鼠标移出事件</span></span><br><span class="line">  @HostListener(<span class="string">"mouseleave"</span>) leave() &#123;</span><br><span class="line">    <span class="keyword">this</span>.element.style.backgroundColor = <span class="string">"skyblue"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="任务二：Angular-深入学习"><a href="#任务二：Angular-深入学习" class="headerlink" title="任务二：Angular 深入学习"></a>任务二：Angular 深入学习</h2><h3 id="1-管道"><a href="#1-管道" class="headerlink" title="1.管道"></a>1.管道</h3><p>管道的作用是格式化组件模板数据。</p>
<blockquote>
<p>内置管道</p>
</blockquote>
<ol>
<li>date 日期格式化</li>
<li>currency 货币格式化</li>
<li>uppercase 转大写</li>
<li>lowercase 转小写</li>
<li>json 格式化json 数据</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; date | date: "yyyy-MM-dd" &#125;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-自定义管道"><a href="#2-自定义管道" class="headerlink" title="2.自定义管道"></a>2.自定义管道</h3><p>需求：指定字符串不能超过规定的长度</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// summary.pipe.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Pipe, PipeTransform &#125; <span class="keyword">from</span> <span class="string">'@angular/core'</span>;</span><br><span class="line"></span><br><span class="line">@Pipe(&#123;</span><br><span class="line">   name: <span class="string">'summary'</span> </span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">SummaryPipe</span> <span class="title">implements</span> <span class="title">PipeTransform</span> </span>&#123;</span><br><span class="line">    transform (value: string, limit?: number) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!value) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">let</span> actualLimit = (limit) ? limit : <span class="number">50</span>;</span><br><span class="line">        <span class="keyword">return</span> value.substr(<span class="number">0</span>, actualLimit) + <span class="string">'...'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.module.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; SummaryPipe &#125; <span class="keyword">from</span> <span class="string">'./summary.pipe'</span></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">    declarations: [</span><br><span class="line">      SummaryPipe</span><br><span class="line">    ] </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="3-组件通讯之向组件内部传递数据"><a href="#3-组件通讯之向组件内部传递数据" class="headerlink" title="3.组件通讯之向组件内部传递数据"></a>3.组件通讯之向组件内部传递数据</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">app-favorite</span> [<span class="attr">isFavorite</span>]=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">app-favorite</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// favorite.component.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Input &#125; <span class="keyword">from</span> <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">FavoriteComponent</span> </span>&#123;</span><br><span class="line">    @Input() isFavorite: boolean = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：在属性的外面加 [] 表示绑定动态值，在组件内接收后是布尔类型，不加 [] 表示绑定普通值，在组件内接收后是字符串类型。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">app-favorite</span> [<span class="attr">is-Favorite</span>]=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">app-favorite</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Input &#125; <span class="keyword">from</span> <span class="string">'@angular/core'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">FavoriteComponent</span> </span>&#123;</span><br><span class="line">  @Input(<span class="string">"is-Favorite"</span>) isFavorite: boolean = <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="4-组件通讯之组件向外部传递数据"><a href="#4-组件通讯之组件向外部传递数据" class="headerlink" title="4.组件通讯之组件向外部传递数据"></a>4.组件通讯之组件向外部传递数据</h3><p>需求：在子组件中通过点击按钮将数据传递给父组件</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 子组件模板 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> (<span class="attr">click</span>)=<span class="string">"onClick()"</span>&gt;</span>click<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 子组件类</span></span><br><span class="line"><span class="keyword">import</span> &#123; EventEmitter, Output &#125; <span class="keyword">from</span> <span class="string">"@angular/core"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">FavoriteComponent</span> </span>&#123;</span><br><span class="line">  @Output() change = <span class="keyword">new</span> EventEmitter()</span><br><span class="line">  onClick() &#123;</span><br><span class="line">    <span class="keyword">this</span>.change.emit(&#123; <span class="attr">name</span>: <span class="string">"张三"</span> &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 父组件模板 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">app-favorite</span> (<span class="attr">change</span>)=<span class="string">"onChange($event)"</span>&gt;</span><span class="tag">&lt;/<span class="name">app-favorite</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 父组件类</span></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  onChange(event: &#123; <span class="attr">name</span>: string &#125;) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(event)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-生命周期函数之挂载阶段"><a href="#5-生命周期函数之挂载阶段" class="headerlink" title="5.生命周期函数之挂载阶段"></a>5.生命周期函数之挂载阶段</h3><blockquote>
<p>挂载阶段</p>
</blockquote>
<p>挂载阶段的生命周期函数只在挂载阶段执行一次，数据更新时不再执行。</p>
<ol>
<li><p>constructor</p>
<p>Angular 在实例化组件类时执行,  可以用来接收 Angular 注入的服务实例对象。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ChildComponent</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span> (private test: TestService) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.test) <span class="comment">// "test"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ngOnInit</p>
<p>在首次接收到输入属性值后执行，在此处可以执行请求操作。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">app-child</span> <span class="attr">name</span>=<span class="string">"张三"</span>&gt;</span><span class="tag">&lt;/<span class="name">app-child</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ChildComponent</span> <span class="title">implements</span> <span class="title">OnInit</span> </span>&#123;</span><br><span class="line">  @Input(<span class="string">"name"</span>) name: string = <span class="string">""</span></span><br><span class="line">  ngOnInit() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.name) <span class="comment">// "张三"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ngAfterContentInit</p>
<p>当内容投影初始渲染完成后调用。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">app-child</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> #<span class="attr">box</span>&gt;</span>Hello Angular<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">app-child</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ChildComponent</span> <span class="title">implements</span> <span class="title">AfterContentInit</span> </span>&#123;</span><br><span class="line">  @ContentChild(<span class="string">"box"</span>) box: ElementRef&lt;HTMLDivElement&gt; | <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">  ngAfterContentInit() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.box) <span class="comment">// &lt;div&gt;Hello Angular&lt;/div&gt;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ngAfterViewInit</p>
<p>当组件视图渲染完成后调用。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- app-child 组件模板 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span> #<span class="attr">p</span>&gt;</span>app-child works<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ChildComponent</span> <span class="title">implements</span> <span class="title">AfterViewInit</span> </span>&#123;</span><br><span class="line">  @ViewChild(<span class="string">"p"</span>) p: ElementRef&lt;HTMLParagraphElement&gt; | <span class="literal">undefined</span></span><br><span class="line">  ngAfterViewInit () &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.p) <span class="comment">// &lt;p&gt;app-child works&lt;/p&gt;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="6-生命周期函数之更新阶段"><a href="#6-生命周期函数之更新阶段" class="headerlink" title="6.生命周期函数之更新阶段"></a>6.生命周期函数之更新阶段</h3><ol>
<li><p>ngOnChanges</p>
<ol>
<li>当输入属性值发生变化时执行，初始设置时也会执行一次，顺序优于 ngOnInit</li>
<li>不论多少输入属性同时变化，钩子函数只会执行一次，变化的值会同时存储在参数中</li>
<li>参数类型为 SimpleChanges，子属性类型为 SimpleChange</li>
<li>对于基本数据类型来说, 只要值发生变化就可以被检测到</li>
<li>对于引用数据类型来说, 可以检测从一个对象变成另一个对象, 但是检测不到同一个对象中属性值的变化，但是不影响组件模板更新数据。</li>
</ol>
<p><strong>基本数据类型值变化</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">app-child</span> [<span class="attr">name</span>]=<span class="string">"name"</span> [<span class="attr">age</span>]=<span class="string">"age"</span>&gt;</span><span class="tag">&lt;/<span class="name">app-child</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> (<span class="attr">click</span>)=<span class="string">"change()"</span>&gt;</span>change<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  name: string = <span class="string">"张三"</span>;</span><br><span class="line">	age: number = <span class="number">20</span></span><br><span class="line">  change() &#123;</span><br><span class="line">    <span class="keyword">this</span>.name = <span class="string">"李四"</span></span><br><span class="line">    <span class="keyword">this</span>.age = <span class="number">30</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ChildComponent</span> <span class="title">implements</span> <span class="title">OnChanges</span> </span>&#123;</span><br><span class="line">  @Input(<span class="string">"name"</span>) name: string = <span class="string">""</span></span><br><span class="line">	@Input(<span class="string">"age"</span>) age: number = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  ngOnChanges(changes: SimpleChanges) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"基本数据类型值变化可以被检测到"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>引用数据类型变化</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">app-child</span> [<span class="attr">person</span>]=<span class="string">"person"</span>&gt;</span><span class="tag">&lt;/<span class="name">app-child</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> (<span class="attr">click</span>)=<span class="string">"change()"</span>&gt;</span>change<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  person = &#123; <span class="attr">name</span>: <span class="string">"张三"</span>, <span class="attr">age</span>: <span class="number">20</span> &#125;</span><br><span class="line">  change() &#123;</span><br><span class="line">    <span class="keyword">this</span>.person = &#123; <span class="attr">name</span>: <span class="string">"李四"</span>, <span class="attr">age</span>: <span class="number">30</span> &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ChildComponent</span> <span class="title">implements</span> <span class="title">OnChanges</span> </span>&#123;</span><br><span class="line">  @Input(<span class="string">"person"</span>) person = &#123; <span class="attr">name</span>: <span class="string">""</span>, <span class="attr">age</span>: <span class="number">0</span> &#125;</span><br><span class="line"></span><br><span class="line">  ngOnChanges(changes: SimpleChanges) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"对于引用数据类型, 只能检测到引用地址发生变化, 对象属性变化不能被检测到"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ngDoCheck：主要用于调试，只要输入属性发生变化，不论是基本数据类型还是引用数据类型还是引用数据类型中的属性变化，都会执行。</p>
</li>
<li><p>ngAfterContentChecked：内容投影更新完成后执行。</p>
</li>
<li><p>ngAfterViewChecked：组件视图更新完成后执行。</p>
</li>
</ol>
<h3 id="7-组件生命周期函数之卸载阶段"><a href="#7-组件生命周期函数之卸载阶段" class="headerlink" title="7.组件生命周期函数之卸载阶段"></a>7.组件生命周期函数之卸载阶段</h3><ol>
<li><p>ngOnDestroy</p>
<p>当组件被销毁之前调用, 用于清理操作。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeComponent</span> <span class="title">implements</span> <span class="title">OnDestroy</span> </span>&#123;</span><br><span class="line">  ngOnDestroy() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"组件被卸载"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="8-理解什么是依赖注入"><a href="#8-理解什么是依赖注入" class="headerlink" title="8.理解什么是依赖注入"></a>8.理解什么是依赖注入</h3><blockquote>
<p>概述</p>
</blockquote>
<p>依赖注入 ( Dependency Injection ) 简称DI，是面向对象编程中的一种设计原则，用来减少代码之间的<strong>耦合度</strong>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MailService</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(APIKEY) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmailSender</span> </span>&#123;</span><br><span class="line">  mailService: MailService</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">this</span>.mailService = <span class="keyword">new</span> MailService(<span class="string">"APIKEY1234567890"</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  sendMail(mail) &#123;</span><br><span class="line">    <span class="keyword">this</span>.mailService.sendMail(mail)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> emailSender = <span class="keyword">new</span> EmailSender()</span><br><span class="line">emailSender.sendMail(mail)</span><br></pre></td></tr></table></figure>

<p>EmailSender 类运行时要使用 MailService 类，EmailSender 类依赖 MailService 类，MailService 类是 EmailSender 类的依赖项。</p>
<p>以上写法的耦合度太高，代码并不健壮。如果 MailService 类改变了参数的传递方式，在 EmailSender 类中的写法也要跟着改变。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmailSender</span> </span>&#123;</span><br><span class="line">  mailService: MailService</span><br><span class="line">  <span class="keyword">constructor</span>(mailService: MailService) &#123;</span><br><span class="line">    <span class="keyword">this</span>.mailService = mailService;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> mailService = <span class="keyword">new</span> MailService(<span class="string">"APIKEY1234567890"</span>)</span><br><span class="line"><span class="keyword">const</span> emailSender = <span class="keyword">new</span> EmailSender(mailService)</span><br></pre></td></tr></table></figure>

<p>在实例化 EmailSender 类时将它的依赖项通过 constructor 构造函数参数的形式注入到类的内部，这种写法就是依赖注入。</p>
<p>通过依赖注入降了代码之间的耦合度，增加了代码的可维护性。MailService 类中代码的更改再也不会影响 EmailSender 类。</p>
<h3 id="9-Injector-的创建和使用"><a href="#9-Injector-的创建和使用" class="headerlink" title="9.Injector 的创建和使用"></a>9.Injector 的创建和使用</h3><blockquote>
<p>DI 框架</p>
</blockquote>
<p>Angular 有自己的 DI 框架，它将实现依赖注入的过程隐藏了，对于开发者来说只需使用很简单的代码就可以使用复杂的依赖注入功能。</p>
<p>在 Angular 的 DI 框架中有四个核心概念：</p>
<ol>
<li>Dependency：组件要依赖的实例对象，服务实例对象</li>
<li>Token：获取服务实例对象的标识</li>
<li>Injector：注入器，负责创建维护服务类的实例对象并向组件中注入服务实例对象。</li>
<li>Provider：配置注入器的对象，指定创建服务实例对象的服务类和获取实例对象的标识。</li>
</ol>
<blockquote>
<p>注入器 Injectors</p>
</blockquote>
<p>注入器负责创建服务类实例对象，并将服务类实例对象注入到需要的组件中。</p>
<ol>
<li><p>创建注入器</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ReflectiveInjector &#125; <span class="keyword">from</span> <span class="string">"@angular/core"</span></span><br><span class="line"><span class="comment">// 服务类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MailService</span> </span>&#123;&#125;</span><br><span class="line"><span class="comment">// 创建注入器并传入服务类</span></span><br><span class="line"><span class="keyword">const</span> injector = ReflectiveInjector.resolveAndCreate([MailService])</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取注入器中的服务类实例对象</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mailService = injector.get(MailService)</span><br></pre></td></tr></table></figure>
</li>
<li><p>服务实例对象为单例模式，注入器在创建服务实例后会对其进行缓存</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mailService1 = injector.get(MailService)</span><br><span class="line"><span class="keyword">const</span> mailService2 = injector.get(MailService)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(mailService1 === mailService2) <span class="comment">// true</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>不同的注入器返回不同的服务实例对象</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> injector = ReflectiveInjector.resolveAndCreate([MailService])</span><br><span class="line"><span class="keyword">const</span> childInjector = injector.resolveAndCreateChild([MailService])</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mailService1 = injector.get(MailService)</span><br><span class="line"><span class="keyword">const</span> mailService2 = childInjector.get(MailService)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(mailService1 === mailService2)</span><br></pre></td></tr></table></figure>
</li>
<li><p>服务实例的查找类似函数作用域链，当前级别可以找到就使用当前级别，当前级别找不到去父级中查找</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> injector = ReflectiveInjector.resolveAndCreate([MailService])</span><br><span class="line"><span class="keyword">const</span> childInjector = injector.resolveAndCreateChild([])</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mailService1 = injector.get(MailService)</span><br><span class="line"><span class="keyword">const</span> mailService2 = childInjector.get(MailService)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(mailService1 === mailService2)</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="10-Provider-的使用"><a href="#10-Provider-的使用" class="headerlink" title="10.Provider 的使用"></a>10.Provider 的使用</h3><ol>
<li><p>配置注入器的对象，指定了创建实例对象的服务类和访问服务实例对象的标识。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> injector = ReflectiveInjector.resolveAndCreate([</span><br><span class="line">  &#123; <span class="attr">provide</span>: MailService, <span class="attr">useClass</span>: MailService &#125;</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
</li>
<li><p>访问依赖对象的标识也可以是字符串类型</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> injector = ReflectiveInjector.resolveAndCreate([</span><br><span class="line">  &#123; <span class="attr">provide</span>: <span class="string">"mail"</span>, <span class="attr">useClass</span>: MailService &#125;</span><br><span class="line">])</span><br><span class="line"><span class="keyword">const</span> mailService = injector.get(<span class="string">"mail"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>useValue</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> injector = ReflectiveInjector.resolveAndCreate([</span><br><span class="line">  &#123;</span><br><span class="line">    provide: <span class="string">"Config"</span>,</span><br><span class="line">    useValue: <span class="built_in">Object</span>.freeze(&#123;</span><br><span class="line">      APIKEY: <span class="string">"API1234567890"</span>,</span><br><span class="line">      APISCRET: <span class="string">"500-400-300"</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">])</span><br><span class="line"><span class="keyword">const</span> Config = injector.get(<span class="string">"Config"</span>)</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>将实例对象和外部的引用建立了松耦合关系，外部通过标识获取实例对象，只要标识保持不变，内部代码怎么变都不会影响到外部。</p>
<h3 id="11-服务的创建与注入"><a href="#11-服务的创建与注入" class="headerlink" title="11.服务的创建与注入"></a>11.服务的创建与注入</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@angular/core'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable(&#123;</span><br><span class="line">  providedIn: <span class="string">'root'</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">TestService</span> </span>&#123; &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line"> 	<span class="keyword">constructor</span> (private testService: TestService) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="12-服务的作用域"><a href="#12-服务的作用域" class="headerlink" title="12.服务的作用域"></a>12.服务的作用域</h3><p>使用服务可以轻松实现跨模块跨组件共享数据，这取决于服务的作用域。</p>
<ol>
<li><p>在根注入器中注册服务，所有模块使用同一个服务实例对象。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@angular/core'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable(&#123;</span><br><span class="line">  providedIn: <span class="string">'root'</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">CarListService</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在模块级别注册服务，该模块中的所有组件使用同一个服务实例对象。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CarModule &#125; <span class="keyword">from</span> <span class="string">'./car.module'</span>;</span><br><span class="line"></span><br><span class="line">@Injectable(&#123;</span><br><span class="line">  providedIn: CarModule,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">CarListService</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; CarListService &#125; <span class="keyword">from</span> <span class="string">'./car-list.service'</span>;</span><br><span class="line"></span><br><span class="line">@NgModule(&#123;</span><br><span class="line">  providers: [CarListService],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">CarModule</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在组件级别注册服务，该组件及其子组件使用同一个服务实例对象。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component &#125; <span class="keyword">from</span> <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CarListService &#125; <span class="keyword">from</span> <span class="string">'../car-list.service.ts'</span></span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector:    <span class="string">'app-car-list'</span>,</span><br><span class="line">  templateUrl: <span class="string">'./car-list.component.html'</span>,</span><br><span class="line">  providers:  [ CarListService ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="13-模板驱动表单用法-删-dirty"><a href="#13-模板驱动表单用法-删-dirty" class="headerlink" title="13.模板驱动表单用法 (删 dirty)"></a>13.模板驱动表单用法 (删 dirty)</h3><p>在 Angular 中，表单有两种类型，分别为模板驱动和模型驱动。</p>
<h4 id="11-1-模板驱动"><a href="#11-1-模板驱动" class="headerlink" title="11.1 模板驱动"></a>11.1 模板驱动</h4><h5 id="11-1-1-概述"><a href="#11-1-1-概述" class="headerlink" title="11.1.1 概述"></a>11.1.1 概述</h5><p>表单的控制逻辑写在组件模板中，适合简单的表单类型。</p>
<h5 id="11-1-2-快速上手"><a href="#11-1-2-快速上手" class="headerlink" title="11.1.2 快速上手"></a>11.1.2 快速上手</h5><ol>
<li><p>引入依赖模块 FormsModule </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; FormsModule &#125; <span class="keyword">from</span> <span class="string">"@angular/forms"</span></span><br><span class="line"></span><br><span class="line">@NgModule(&#123;</span><br><span class="line">  imports: [FormsModule],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>将 DOM 表单转换为 ngForm</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> #<span class="attr">f</span>=<span class="string">"ngForm"</span> (<span class="attr">submit</span>)=<span class="string">"onSubmit(f)"</span>&gt;</span><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>声明表单字段为 ngModel</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> #<span class="attr">f</span>=<span class="string">"ngForm"</span> (<span class="attr">submit</span>)=<span class="string">"onSubmit(f)"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">ngModel</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span>&gt;</span>提交<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>获取表单字段值</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; NgForm &#125; <span class="keyword">from</span> <span class="string">"@angular/forms"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  onSubmit(form: NgForm) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(form.value)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="14-模板驱动表单中的表单分组"><a href="#14-模板驱动表单中的表单分组" class="headerlink" title="14.模板驱动表单中的表单分组"></a>14.模板驱动表单中的表单分组</h3><ol start="5">
<li><p>表单分组</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> #<span class="attr">f</span>=<span class="string">"ngForm"</span> (<span class="attr">submit</span>)=<span class="string">"onSubmit(f)"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">ngModelGroup</span>=<span class="string">"user"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">ngModel</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">ngModelGroup</span>=<span class="string">"contact"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"phone"</span> <span class="attr">ngModel</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span>&gt;</span>提交<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="15-模板驱动型表单的验证方式"><a href="#15-模板驱动型表单的验证方式" class="headerlink" title="15.模板驱动型表单的验证方式"></a>15.模板驱动型表单的验证方式</h3><ul>
<li>required 必填字段</li>
<li>minlength 字段最小长度</li>
<li>maxlength 字段最大长度</li>
<li>pattern 验证正则 例如：pattern=”\d” 匹配一个数值</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> #<span class="attr">f</span>=<span class="string">"ngForm"</span> (<span class="attr">submit</span>)=<span class="string">"onSubmit(f)"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">ngModel</span> <span class="attr">required</span> <span class="attr">pattern</span>=<span class="string">"\d"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span>&gt;</span>提交<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  onSubmit(form: NgForm) &#123;</span><br><span class="line">    <span class="comment">// 查看表单整体是否验证通过</span></span><br><span class="line">    <span class="built_in">console</span>.log(form.valid)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 表单整体未通过验证时禁用提交表单 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span> [<span class="attr">disabled</span>]=<span class="string">"f.invalid"</span>&gt;</span>提交<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在组件模板中显示表单项未通过时的错误信息。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> #<span class="attr">f</span>=<span class="string">"ngForm"</span> (<span class="attr">submit</span>)=<span class="string">"onSubmit(f)"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> #<span class="attr">username</span>=<span class="string">"ngModel"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> *<span class="attr">ngIf</span>=<span class="string">"username.touched &amp;&amp; !username.valid &amp;&amp; username.errors"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> *<span class="attr">ngIf</span>=<span class="string">"username.errors.required"</span>&gt;</span>请填写用户名<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> *<span class="attr">ngIf</span>=<span class="string">"username.errors.pattern"</span>&gt;</span>不符合正则规则<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>指定表单项未通过验证时的样式。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">input</span><span class="selector-class">.ng-touched</span><span class="selector-class">.ng-invalid</span> &#123;</span><br><span class="line">  <span class="attribute">border</span>: <span class="number">2px</span> solid red;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="16-模型驱动表单的基本用法"><a href="#16-模型驱动表单的基本用法" class="headerlink" title="16.模型驱动表单的基本用法"></a>16.模型驱动表单的基本用法</h3><p>表单的控制逻辑写在组件类中，对验证逻辑拥有更多的控制权，适合复杂的表单的类型。</p>
<p>在模型驱动表单中，表单字段需要是 FormControl 类的实例，实例对象可以验证表单字段中的值，值是否被修改过等等。</p>
<p>一组表单字段构成整个表单，整个表单需要是 FormGroup 类的实例，它可以对表单进行整体验证。</p>
<ol>
<li>FormControl：表单组中的一个表单项</li>
<li>FormGroup：表单组，表单至少是一个 FormGroup</li>
<li>FormArray：用于复杂表单，可以动态添加表单项或表单组，在表单验证时，FormArray 中有一项没通过，整体没通过。</li>
</ol>
<h5 id="11-2-2-快速上手"><a href="#11-2-2-快速上手" class="headerlink" title="11.2.2 快速上手"></a>11.2.2 快速上手</h5><ol>
<li><p>引入 ReactiveFormsModule</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ReactiveFormsModule &#125; <span class="keyword">from</span> <span class="string">"@angular/forms"</span></span><br><span class="line"></span><br><span class="line">@NgModule(&#123;</span><br><span class="line">  imports: [ReactiveFormsModule]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在组件类中创建 FormGroup 表单控制对象</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; FormControl, FormGroup &#125; <span class="keyword">from</span> <span class="string">"@angular/forms"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  contactForm: FormGroup = <span class="keyword">new</span> FormGroup(&#123;</span><br><span class="line">    name: <span class="keyword">new</span> FormControl(),</span><br><span class="line">    phone: <span class="keyword">new</span> FormControl()</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>关联组件模板中的表单</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> [<span class="attr">formGroup</span>]=<span class="string">"contactForm"</span> (<span class="attr">submit</span>)=<span class="string">"onSubmit()"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">formControlName</span>=<span class="string">"name"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">formControlName</span>=<span class="string">"phone"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span>&gt;</span>提交<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>获取表单值</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  onSubmit() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.contactForm.value)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置表单默认值</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">   contactForm: FormGroup = <span class="keyword">new</span> FormGroup(&#123;</span><br><span class="line">     name: <span class="keyword">new</span> FormControl(<span class="string">"默认值"</span>),</span><br><span class="line">     phone: <span class="keyword">new</span> FormControl(<span class="number">15888888888</span>)</span><br><span class="line">   &#125;)</span><br><span class="line">   <span class="string">``</span></span><br><span class="line"></span><br><span class="line">### 17.模型驱动表单中实现表单分组</span><br><span class="line"></span><br><span class="line"><span class="number">6.</span> 表单分组</span><br><span class="line"></span><br><span class="line">   <span class="string">``</span><span class="string">`javascript</span></span><br><span class="line"><span class="string">   contactForm: FormGroup = new FormGroup(&#123;</span></span><br><span class="line"><span class="string">     fullName: new FormGroup(&#123;</span></span><br><span class="line"><span class="string">       firstName: new FormControl(),</span></span><br><span class="line"><span class="string">       lastName: new FormControl()</span></span><br><span class="line"><span class="string">     &#125;),</span></span><br><span class="line"><span class="string">     phone: new FormControl()</span></span><br><span class="line"><span class="string">   &#125;)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> [<span class="attr">formGroup</span>]=<span class="string">"contactForm"</span> (<span class="attr">submit</span>)=<span class="string">"onSubmit()"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">formGroupName</span>=<span class="string">"fullName"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">formControlName</span>=<span class="string">"firstName"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">formControlName</span>=<span class="string">"lastName"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">formControlName</span>=<span class="string">"phone"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span>&gt;</span>提交<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">onSubmit() &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="keyword">this</span>.contactForm.value.name.username)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="keyword">this</span>.contactForm.get([<span class="string">"name"</span>, <span class="string">"username"</span>])?.value)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="18-使用formArray动态创建表单"><a href="#18-使用formArray动态创建表单" class="headerlink" title="18.使用formArray动态创建表单"></a>18.使用formArray动态创建表单</h3><p>需求：在页面中默认显示一组联系方式，通过点击按钮可以添加更多联系方式组。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component, OnInit &#125; <span class="keyword">from</span> <span class="string">"@angular/core"</span></span><br><span class="line"><span class="keyword">import</span> &#123; FormArray, FormControl, FormGroup &#125; <span class="keyword">from</span> <span class="string">"@angular/forms"</span></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">"app-root"</span>,</span><br><span class="line">  templateUrl: <span class="string">"./app.component.html"</span>,</span><br><span class="line">  styles: []</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> <span class="title">implements</span> <span class="title">OnInit</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 表单</span></span><br><span class="line">  contactForm: FormGroup = <span class="keyword">new</span> FormGroup(&#123;</span><br><span class="line">    contacts: <span class="keyword">new</span> FormArray([])</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">get</span> contacts() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.contactForm.get(<span class="string">"contacts"</span>) <span class="keyword">as</span> FormArray</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加联系方式</span></span><br><span class="line">  addContact() &#123;</span><br><span class="line">    <span class="comment">// 联系方式</span></span><br><span class="line">    <span class="keyword">const</span> myContact: FormGroup = <span class="keyword">new</span> FormGroup(&#123;</span><br><span class="line">      name: <span class="keyword">new</span> FormControl(),</span><br><span class="line">      address: <span class="keyword">new</span> FormControl(),</span><br><span class="line">      phone: <span class="keyword">new</span> FormControl()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// 向联系方式数组中添加联系方式</span></span><br><span class="line">    <span class="keyword">this</span>.contacts.push(myContact)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 删除联系方式</span></span><br><span class="line">  removeContact(i: number) &#123;</span><br><span class="line">    <span class="keyword">this</span>.contacts.removeAt(i)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ngOnInit() &#123;</span><br><span class="line">    <span class="comment">// 添加默认的联系方式</span></span><br><span class="line">    <span class="keyword">this</span>.addContact()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onSubmit() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.contactForm.value)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> [<span class="attr">formGroup</span>]=<span class="string">"contactForm"</span> (<span class="attr">submit</span>)=<span class="string">"onSubmit()"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">formArrayName</span>=<span class="string">"contacts"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span></span></span><br><span class="line"><span class="tag">      *<span class="attr">ngFor</span>=<span class="string">"let contact of contacts.controls; let i = index"</span></span></span><br><span class="line"><span class="tag">      [<span class="attr">formGroupName</span>]=<span class="string">"i"</span></span></span><br><span class="line"><span class="tag">    &gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">formControlName</span>=<span class="string">"name"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">formControlName</span>=<span class="string">"address"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">formControlName</span>=<span class="string">"phone"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> (<span class="attr">click</span>)=<span class="string">"removeContact(i)"</span>&gt;</span>删除联系方式<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> (<span class="attr">click</span>)=<span class="string">"addContact()"</span>&gt;</span>添加联系方式<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span>&gt;</span>提交<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="19-模型驱动表单内置验证规则的使用"><a href="#19-模型驱动表单内置验证规则的使用" class="headerlink" title="19.模型驱动表单内置验证规则的使用"></a>19.模型驱动表单内置验证规则的使用</h3><ol>
<li><p>使用内置验证器提供的验证规则验证表单字段</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; FormControl, FormGroup, Validators &#125; <span class="keyword">from</span> <span class="string">"@angular/forms"</span></span><br><span class="line"></span><br><span class="line">contactForm: FormGroup = <span class="keyword">new</span> FormGroup(&#123;</span><br><span class="line">  name: <span class="keyword">new</span> FormControl(<span class="string">"默认值"</span>, [</span><br><span class="line">    Validators.required,</span><br><span class="line">    Validators.minLength(<span class="number">2</span>)</span><br><span class="line">  ])</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取整体表单是否验证通过</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">onSubmit() &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="keyword">this</span>.contactForm.valid)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 表单整体未验证通过时禁用表单按钮 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> [<span class="attr">disabled</span>]=<span class="string">"contactForm.invalid"</span>&gt;</span>提交<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在组件模板中显示为验证通过时的错误信息</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">get</span> name() &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.contactForm.get(<span class="string">"name"</span>)!</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> [<span class="attr">formGroup</span>]=<span class="string">"contactForm"</span> (<span class="attr">submit</span>)=<span class="string">"onSubmit()"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">formControlName</span>=<span class="string">"name"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> *<span class="attr">ngIf</span>=<span class="string">"name.touched &amp;&amp; name.invalid &amp;&amp; name.errors"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> *<span class="attr">ngIf</span>=<span class="string">"name.errors.required"</span>&gt;</span>请填写姓名<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> *<span class="attr">ngIf</span>=<span class="string">"name.errors.maxlength"</span>&gt;</span></span><br><span class="line">      姓名长度不能大于</span><br><span class="line">      &#123;&#123; name.errors.maxlength.requiredLength &#125;&#125; 实际填写长度为</span><br><span class="line">      &#123;&#123; name.errors.maxlength.actualLength &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="20-模型驱动表单同步类型的自定义验证器（一）"><a href="#20-模型驱动表单同步类型的自定义验证器（一）" class="headerlink" title="20.模型驱动表单同步类型的自定义验证器（一）"></a>20.模型驱动表单同步类型的自定义验证器（一）</h3><ol>
<li>自定义验证器的类型是 TypeScript 类</li>
<li>类中包含具体的验证方法，验证方法必须为静态方法</li>
<li>验证方法有一个参数 control，类型为 AbstractControl。其实就是 FormControl 类的实例对象的类型</li>
<li>如果验证成功，返回 null</li>
<li>如果验证失败，返回对象，对象中的属性即为验证标识，值为 true，标识该项验证失败</li>
<li>验证方法的返回值为 ValidationErrors | null</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; AbstractControl, ValidationErrors &#125; <span class="keyword">from</span> <span class="string">"@angular/forms"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">NameValidators</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 字段值中不能包含空格</span></span><br><span class="line">  <span class="keyword">static</span> cannotContainSpace(control: AbstractControl): ValidationErrors | <span class="literal">null</span> &#123;</span><br><span class="line">    <span class="comment">// 验证未通过</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="regexp">/\s/</span>.test(control.value)) <span class="keyword">return</span> &#123; <span class="attr">cannotContainSpace</span>: <span class="literal">true</span> &#125;</span><br><span class="line">    <span class="comment">// 验证通过</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; NameValidators &#125; <span class="keyword">from</span> <span class="string">"./Name.validators"</span></span><br><span class="line"></span><br><span class="line">contactForm: FormGroup = <span class="keyword">new</span> FormGroup(&#123;</span><br><span class="line">  name: <span class="keyword">new</span> FormControl(<span class="string">""</span>, [</span><br><span class="line">    Validators.required,</span><br><span class="line">    NameValidators.cannotContainSpace</span><br><span class="line">  ])</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> *<span class="attr">ngIf</span>=<span class="string">"name.touched &amp;&amp; name.invalid &amp;&amp; name.errors"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> *<span class="attr">ngIf</span>=<span class="string">"name.errors.cannotContainSpace"</span>&gt;</span>姓名中不能包含空格<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="21-模型驱动表单异步类型的自定义验证器（二）"><a href="#21-模型驱动表单异步类型的自定义验证器（二）" class="headerlink" title="21.模型驱动表单异步类型的自定义验证器（二）"></a>21.模型驱动表单异步类型的自定义验证器（二）</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; AbstractControl, ValidationErrors &#125; <span class="keyword">from</span> <span class="string">"@angular/forms"</span></span><br><span class="line"><span class="keyword">import</span> &#123; Observable &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">NameValidators</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> shouldBeUnique(control: AbstractControl): <span class="built_in">Promise</span>&lt;ValidationErrors | <span class="literal">null</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (control.value == <span class="string">"admin"</span>) &#123;</span><br><span class="line">         resolve(&#123; <span class="attr">shouldBeUnique</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         resolve(<span class="literal">null</span>)</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">contactForm: FormGroup = <span class="keyword">new</span> FormGroup(&#123;</span><br><span class="line">    name: <span class="keyword">new</span> FormControl(</span><br><span class="line">      <span class="string">""</span>,</span><br><span class="line">      [</span><br><span class="line">        Validators.required</span><br><span class="line">      ],</span><br><span class="line">      NameValidators.shouldBeUnique</span><br><span class="line">    )</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> *<span class="attr">ngIf</span>=<span class="string">"name.touched &amp;&amp; name.invalid &amp;&amp; name.errors"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> *<span class="attr">ngIf</span>=<span class="string">"name.errors.shouldBeUnique"</span>&gt;</span>用户名重复<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> *<span class="attr">ngIf</span>=<span class="string">"name.pending"</span>&gt;</span>正在检测姓名是否重复<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="22-FormBuild-创建模型表单的快捷方式"><a href="#22-FormBuild-创建模型表单的快捷方式" class="headerlink" title="22.FormBuild 创建模型表单的快捷方式"></a>22.FormBuild 创建模型表单的快捷方式</h3><p>创建表单的快捷方式。</p>
<ol>
<li><code>this.fb.control</code>：表单项</li>
<li><code>this.fb.group</code>：表单组，表单至少是一个 FormGroup</li>
<li><code>this.fb.array</code>：用于复杂表单，可以动态添加表单项或表单组，在表单验证时，FormArray 中有一项没通过，整体没通过。</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; FormBuilder, FormGroup, Validators &#125; <span class="keyword">from</span> <span class="string">"@angular/forms"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  contactForm: FormGroup</span><br><span class="line">  <span class="keyword">constructor</span>(private fb: FormBuilder) &#123;</span><br><span class="line">    <span class="keyword">this</span>.contactForm = <span class="keyword">this</span>.fb.group(&#123;</span><br><span class="line">      fullName: <span class="keyword">this</span>.fb.group(&#123;</span><br><span class="line">        firstName: [<span class="string">"😝"</span>, [Validators.required]],</span><br><span class="line">        lastName: [<span class="string">""</span>]</span><br><span class="line">      &#125;),</span><br><span class="line">      phone: []</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="23-模型驱动表单练习之复选框"><a href="#23-模型驱动表单练习之复选框" class="headerlink" title="23.模型驱动表单练习之复选框"></a>23.模型驱动表单练习之复选框</h3><ol>
<li><p>获取一组复选框中选中的值</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> [<span class="attr">formGroup</span>]=<span class="string">"form"</span> (<span class="attr">submit</span>)=<span class="string">"onSubmit()"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">label</span> *<span class="attr">ngFor</span>=<span class="string">"let item of Data"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> [<span class="attr">value</span>]=<span class="string">"item.value"</span> (<span class="attr">change</span>)=<span class="string">"onChange($event)"</span> /&gt;</span></span><br><span class="line">    &#123;&#123; item.name &#125;&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span>&gt;</span>提交<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component &#125; <span class="keyword">from</span> <span class="string">"@angular/core"</span></span><br><span class="line"><span class="keyword">import</span> &#123; FormArray, FormBuilder, FormGroup &#125; <span class="keyword">from</span> <span class="string">"@angular/forms"</span></span><br><span class="line">interface Data &#123;</span><br><span class="line">  name: string</span><br><span class="line">  value: string</span><br><span class="line">&#125;</span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">"app-checkbox"</span>,</span><br><span class="line">  templateUrl: <span class="string">"./checkbox.component.html"</span>,</span><br><span class="line">  styles: []</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">CheckboxComponent</span> </span>&#123;</span><br><span class="line">  Data: <span class="built_in">Array</span>&lt;Data&gt; = [</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">"Pear"</span>, <span class="attr">value</span>: <span class="string">"pear"</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">"Plum"</span>, <span class="attr">value</span>: <span class="string">"plum"</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">"Kiwi"</span>, <span class="attr">value</span>: <span class="string">"kiwi"</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">"Apple"</span>, <span class="attr">value</span>: <span class="string">"apple"</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">"Lime"</span>, <span class="attr">value</span>: <span class="string">"lime"</span> &#125;</span><br><span class="line">  ]</span><br><span class="line">  form: FormGroup</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(private fb: FormBuilder) &#123;</span><br><span class="line">    <span class="keyword">this</span>.form = <span class="keyword">this</span>.fb.group(&#123;</span><br><span class="line">      checkArray: <span class="keyword">this</span>.fb.array([])</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onChange(event: Event) &#123;</span><br><span class="line">    <span class="keyword">const</span> target = event.target <span class="keyword">as</span> HTMLInputElement</span><br><span class="line">    <span class="keyword">const</span> checked = target.checked</span><br><span class="line">    <span class="keyword">const</span> value = target.value</span><br><span class="line">    <span class="keyword">const</span> checkArray = <span class="keyword">this</span>.form.get(<span class="string">"checkArray"</span>) <span class="keyword">as</span> FormArray</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (checked) &#123;</span><br><span class="line">      checkArray.push(<span class="keyword">this</span>.fb.control(value))</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> index = checkArray.controls.findIndex(</span><br><span class="line">        control =&gt; control.value === value</span><br><span class="line">      )</span><br><span class="line">      checkArray.removeAt(index)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onSubmit() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.form.value)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="24-模型驱动表单练习之单选框"><a href="#24-模型驱动表单练习之单选框" class="headerlink" title="24.模型驱动表单练习之单选框"></a>24.模型驱动表单练习之单选框</h3><ol start="2">
<li><p>获取单选框中选中的值</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  form: FormGroup</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(public fb: FormBuilder) &#123;</span><br><span class="line">    <span class="keyword">this</span>.form = <span class="keyword">this</span>.fb.group(&#123; <span class="attr">gender</span>: <span class="string">""</span> &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onSubmit() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.form.value)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> [<span class="attr">formGroup</span>]=<span class="string">"form"</span> (<span class="attr">submit</span>)=<span class="string">"onSubmit()"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"radio"</span> <span class="attr">value</span>=<span class="string">"male"</span> <span class="attr">formControlName</span>=<span class="string">"gender"</span> /&gt;</span> Male</span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"radio"</span> <span class="attr">value</span>=<span class="string">"female"</span> <span class="attr">formControlName</span>=<span class="string">"gender"</span> /&gt;</span> Female</span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span>Submit<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="25-模型驱动表单常用方法介绍"><a href="#25-模型驱动表单常用方法介绍" class="headerlink" title="25.模型驱动表单常用方法介绍"></a>25.模型驱动表单常用方法介绍</h3></li>
<li><p>patchValue：设置表单控件的值（可以设置全部，也可以设置其中某一个，其他不受影响）</p>
</li>
<li><p>setValue：设置表单控件的值 (设置全部，不能排除任何一个)</p>
</li>
<li><p>valueChanges：当表单控件的值发生变化时被触发的事件</p>
</li>
<li><p>reset：表单内容置空</p>
</li>
</ol>
<h3 id="26-路由的基本使用"><a href="#26-路由的基本使用" class="headerlink" title="26.路由的基本使用"></a>26.路由的基本使用</h3><blockquote>
<p>概述</p>
</blockquote>
<p>在 Angular 中，路由是以模块为单位的，每个模块都可以有自己的路由。</p>
<blockquote>
<p>快速上手</p>
</blockquote>
<ol>
<li><p>创建页面组件、Layout 组件以及 Navigation 组件，供路由使用</p>
<ol>
<li>创建<strong>首页</strong>页面组件<code>ng g c pages/home</code></li>
<li>创建<strong>关于我们</strong>页面组件<code>ng g c pages/about</code></li>
<li>创建<strong>布局</strong>组件<code>ng g c pages/layout</code></li>
<li>创建<strong>导航</strong>组件<code>ng g c pages/navigation</code></li>
</ol>
</li>
<li><p>创建路由规则</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.module.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Routes &#125; <span class="keyword">from</span> <span class="string">"@angular/router"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> routes: Routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"home"</span>,</span><br><span class="line">    component: HomeComponent</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"about"</span>,</span><br><span class="line">    component: AboutComponent</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>引入路由模块并启动</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.module.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; RouterModule, Routes &#125; <span class="keyword">from</span> <span class="string">"@angular/router"</span></span><br><span class="line"></span><br><span class="line">@NgModule(&#123;</span><br><span class="line">  imports: [RouterModule.forRoot(routes, &#123; <span class="attr">useHash</span>: <span class="literal">true</span> &#125;)],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加路由插座</p>
 <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 路由插座即占位组件 匹配到的路由组件将会显示在这个地方 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">router-outlet</span>&gt;</span><span class="tag">&lt;/<span class="name">router-outlet</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在导航组件中定义链接</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">routerLink</span>=<span class="string">"/home"</span>&gt;</span>首页<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">routerLink</span>=<span class="string">"/about"</span>&gt;</span>关于我们<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<blockquote>
<p>匹配规则</p>
</blockquote>
<ul>
<li>重定向</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> routes: Routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"home"</span>,</span><br><span class="line">    component: HomeComponent</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"about"</span>,</span><br><span class="line">    component: AboutComponent</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">""</span>,</span><br><span class="line">    <span class="comment">// 重定向</span></span><br><span class="line">    redirectTo: <span class="string">"home"</span>,</span><br><span class="line">    <span class="comment">// 完全匹配</span></span><br><span class="line">    pathMatch: <span class="string">"full"</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<ul>
<li>404 页面</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> routes: Routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"home"</span>,</span><br><span class="line">    component: HomeComponent</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"about"</span>,</span><br><span class="line">    component: AboutComponent</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"**"</span>,</span><br><span class="line">    component: NotFoundComponent</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h3 id="27-路由传递参数的两种方式"><a href="#27-路由传递参数的两种方式" class="headerlink" title="27.路由传递参数的两种方式"></a>27.路由传递参数的两种方式</h3><blockquote>
<p>查询参数</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">routerLink</span>=<span class="string">"/about"</span> [<span class="attr">queryParams</span>]=<span class="string">"&#123; name: 'kitty' &#125;"</span>&gt;</span>关于我们<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ActivatedRoute &#125; <span class="keyword">from</span> <span class="string">"@angular/router"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AboutComponent</span> <span class="title">implements</span> <span class="title">OnInit</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(private route: ActivatedRoute) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  ngOnInit(): <span class="keyword">void</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.route.queryParamMap.subscribe(<span class="function"><span class="params">query</span> =&gt;</span> &#123;</span><br><span class="line">      query.get(<span class="string">"name"</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>动态参数</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> routes: Routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"home"</span>,</span><br><span class="line">    component: HomeComponent</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"about/:name"</span>,</span><br><span class="line">    component: AboutComponent</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> [<span class="attr">routerLink</span>]=<span class="string">"['/about', 'zhangsan']"</span>&gt;</span>关于我们<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ActivatedRoute &#125; <span class="keyword">from</span> <span class="string">"@angular/router"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AboutComponent</span> <span class="title">implements</span> <span class="title">OnInit</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(private route: ActivatedRoute) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  ngOnInit(): <span class="keyword">void</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.route.paramMap.subscribe(<span class="function"><span class="params">params</span> =&gt;</span> &#123;</span><br><span class="line">      params.get(<span class="string">"name"</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="28-定义子孙级路由"><a href="#28-定义子孙级路由" class="headerlink" title="28.定义子孙级路由"></a>28.定义子孙级路由</h3><p>路由嵌套指的是如何定义子级路由。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> routes: Routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"about"</span>,</span><br><span class="line">    component: AboutComponent,</span><br><span class="line">    children: [</span><br><span class="line">      &#123;</span><br><span class="line">        path: <span class="string">"introduce"</span>,</span><br><span class="line">        component: IntroduceComponent</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        path: <span class="string">"history"</span>,</span><br><span class="line">        component: HistoryComponent</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- about.component.html --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">app-layout</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>about works!<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">routerLink</span>=<span class="string">"/about/introduce"</span>&gt;</span>公司简介<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">routerLink</span>=<span class="string">"/about/history"</span>&gt;</span>发展历史<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">router-outlet</span>&gt;</span><span class="tag">&lt;/<span class="name">router-outlet</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">app-layout</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="29-路由命名插座"><a href="#29-路由命名插座" class="headerlink" title="29.路由命名插座"></a>29.路由命名插座</h3><p>将子级路由组件显示到不同的路由插座中。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  path: <span class="string">"about"</span>,</span><br><span class="line">  component: AboutComponent,</span><br><span class="line">  children: [</span><br><span class="line">    &#123;</span><br><span class="line">      path: <span class="string">"introduce"</span>,</span><br><span class="line">      component: IntroduceComponent,</span><br><span class="line">      outlet: <span class="string">"left"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      path: <span class="string">"history"</span>,</span><br><span class="line">      component: HistoryComponent,</span><br><span class="line">      outlet: <span class="string">"right"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- about.component.html --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">app-layout</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>about works!<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">router-outlet</span> <span class="attr">name</span>=<span class="string">"left"</span>&gt;</span><span class="tag">&lt;/<span class="name">router-outlet</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">router-outlet</span> <span class="attr">name</span>=<span class="string">"right"</span>&gt;</span><span class="tag">&lt;/<span class="name">router-outlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">app-layout</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span></span></span><br><span class="line"><span class="tag">    [<span class="attr">routerLink</span>]=<span class="string">"[</span></span></span><br><span class="line"><span class="tag"><span class="string">      '/about',</span></span></span><br><span class="line"><span class="tag"><span class="string">      &#123;</span></span></span><br><span class="line"><span class="tag"><span class="string">        outlets: &#123;</span></span></span><br><span class="line"><span class="tag"><span class="string">          left: ['introduce'],</span></span></span><br><span class="line"><span class="tag"><span class="string">          right: ['history']</span></span></span><br><span class="line"><span class="tag"><span class="string">        &#125;</span></span></span><br><span class="line"><span class="tag"><span class="string">      &#125;</span></span></span><br><span class="line"><span class="tag"><span class="string">    ]"</span></span></span><br><span class="line"><span class="tag">    &gt;</span>关于我们</span><br><span class="line"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="30-导航路由"><a href="#30-导航路由" class="headerlink" title="30.导航路由"></a>30.导航路由</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- app.component.html --&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">button</span> (<span class="attr">click</span>)=<span class="string">"jump()"</span>&gt;</span>跳转到发展历史<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.component.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Router &#125; <span class="keyword">from</span> <span class="string">"@angular/router"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeComponent</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(private router: Router) &#123;&#125;</span><br><span class="line">  jump() &#123;</span><br><span class="line">    <span class="keyword">this</span>.router.navigate([<span class="string">"/about/history"</span>], &#123;</span><br><span class="line">      queryParams: &#123;</span><br><span class="line">        name: <span class="string">"Kitty"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="31-创建路由模块独立路由规则"><a href="#31-创建路由模块独立路由规则" class="headerlink" title="31.创建路由模块独立路由规则"></a>31.创建路由模块独立路由规则</h3><p>将根模块中的路由配置抽象成一个单独的路由模块，称之为根路由模块，然后在根模块中引入根路由模块。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; NgModule &#125; <span class="keyword">from</span> <span class="string">"@angular/core"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; HomeComponent &#125; <span class="keyword">from</span> <span class="string">"./pages/home/home.component"</span></span><br><span class="line"><span class="keyword">import</span> &#123; NotFoundComponent &#125; <span class="keyword">from</span> <span class="string">"./pages/not-found/not-found.component"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> routes: Routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">""</span>,</span><br><span class="line">    component: HomeComponent</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"**"</span>,</span><br><span class="line">    component: NotFoundComponent</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">@NgModule(&#123;</span><br><span class="line">  declarations: [],</span><br><span class="line">  imports: [RouterModule.forRoot(routes, &#123; <span class="attr">useHash</span>: <span class="literal">true</span> &#125;)],</span><br><span class="line">  <span class="comment">// 导出 Angular 路由功能模块，因为在根模块的根组件中使用了 RouterModule 模块中提供的路由插座组件</span></span><br><span class="line">  exports: [RouterModule]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppRoutingModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; BrowserModule &#125; <span class="keyword">from</span> <span class="string">"@angular/platform-browser"</span></span><br><span class="line"><span class="keyword">import</span> &#123; NgModule &#125; <span class="keyword">from</span> <span class="string">"@angular/core"</span></span><br><span class="line"><span class="keyword">import</span> &#123; AppComponent &#125; <span class="keyword">from</span> <span class="string">"./app.component"</span></span><br><span class="line"><span class="keyword">import</span> &#123; AppRoutingModule &#125; <span class="keyword">from</span> <span class="string">"./app-routing.module"</span></span><br><span class="line"><span class="keyword">import</span> &#123; HomeComponent &#125; <span class="keyword">from</span> <span class="string">"./pages/home/home.component"</span></span><br><span class="line"><span class="keyword">import</span> &#123; NotFoundComponent &#125; <span class="keyword">from</span> <span class="string">"./pages/not-found/not-found.component"</span></span><br><span class="line"></span><br><span class="line">@NgModule(&#123;</span><br><span class="line">  declarations: [AppComponent，HomeComponent, NotFoundComponent],</span><br><span class="line">  imports: [BrowserModule, AppRoutingModule],</span><br><span class="line">  providers: [],</span><br><span class="line">  bootstrap: [AppComponent]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="32-实现路由模块懒加载"><a href="#32-实现路由模块懒加载" class="headerlink" title="32.实现路由模块懒加载"></a>32.实现路由模块懒加载</h3><p>路由懒加载是以模块为单位的。</p>
<ol>
<li><p>创建用户模块 <code>ng g m user --routing=true</code> 一并创建该模块的路由模块</p>
</li>
<li><p>创建登录页面组件 <code>ng g c user/pages/login</code></p>
</li>
<li><p>创建注册页面组件 <code>ng g c user/pages/register</code></p>
</li>
<li><p>配置用户模块的路由规则</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; NgModule &#125; <span class="keyword">from</span> <span class="string">"@angular/core"</span></span><br><span class="line"><span class="keyword">import</span> &#123; Routes, RouterModule &#125; <span class="keyword">from</span> <span class="string">"@angular/router"</span></span><br><span class="line"><span class="keyword">import</span> &#123; LoginComponent &#125; <span class="keyword">from</span> <span class="string">"./pages/login/login.component"</span></span><br><span class="line"><span class="keyword">import</span> &#123; RegisterComponent &#125; <span class="keyword">from</span> <span class="string">"./pages/register/register.component"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> routes: Routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"login"</span>,</span><br><span class="line">    component: LoginComponent</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"register"</span>,</span><br><span class="line">    component: RegisterComponent</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">@NgModule(&#123;</span><br><span class="line">  imports: [RouterModule.forChild(routes)],</span><br><span class="line">  exports: [RouterModule]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRoutingModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>将用户路由模块关联到主路由模块</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app-routing.module.ts</span></span><br><span class="line"><span class="keyword">const</span> routes: Routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"user"</span>,</span><br><span class="line">    loadChildren: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">"./user/user.module"</span>).then(<span class="function"><span class="params">m</span> =&gt;</span> m.UserModule)</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>在导航组件中添加访问链接</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">routerLink</span>=<span class="string">"/user/login"</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">routerLink</span>=<span class="string">"/user/register"</span>&gt;</span>注册<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="33-路由守卫-CanActivate"><a href="#33-路由守卫-CanActivate" class="headerlink" title="33.路由守卫 CanActivate"></a>33.路由守卫 CanActivate</h3><p>路由守卫会告诉路由是否允许导航到请求的路由。</p>
<p>路由守方法可以返回 boolean 或 Observable &lt;boolean&gt; 或 Promise &lt;boolean&gt;，它们在将来的某个时间点解析为布尔值。</p>
<blockquote>
<p>CanActivate</p>
</blockquote>
<p>检查用户是否可以访问某一个路由。</p>
<p>CanActivate 为接口，路由守卫类要实现该接口，该接口规定类中需要有 canActivate 方法，方法决定是否允许访问目标路由。</p>
<p>路由可以应用多个守卫，所有守卫方法都允许，路由才被允许访问，有一个守卫方法不允许，则路由不允许被访问。</p>
<p>创建路由守卫：<code>ng g guard guards/auth</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">"@angular/core"</span></span><br><span class="line"><span class="keyword">import</span> &#123; CanActivate, ActivatedRouteSnapshot, RouterStateSnapshot, UrlTree, Router &#125; <span class="keyword">from</span> <span class="string">"@angular/router"</span></span><br><span class="line"><span class="keyword">import</span> &#123; Observable &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"></span><br><span class="line">@Injectable(&#123;</span><br><span class="line">  providedIn: <span class="string">"root"</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthGuard</span> <span class="title">implements</span> <span class="title">CanActivate</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(private router: Router) &#123;&#125;</span><br><span class="line">  canActivate(): boolean | UrlTree &#123;</span><br><span class="line">    <span class="comment">// 用于实现跳转</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.router.createUrlTree([<span class="string">"/user/login"</span>])</span><br><span class="line">    <span class="comment">// 禁止访问目标路由</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment">// 允许访问目标路由</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  path: <span class="string">"about"</span>,</span><br><span class="line">  component: AboutComponent,</span><br><span class="line">  canActivate: [AuthGuard]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="34-路由守卫-CanActiveChild"><a href="#34-路由守卫-CanActiveChild" class="headerlink" title="34.路由守卫 CanActiveChild"></a>34.路由守卫 CanActiveChild</h3><p>检查用户是否方可访问某个子路由。</p>
<p>创建路由守卫：<code>ng g guard guards/admin</code> 注意：选择 CanActivateChild，需要将箭头移动到这个选项并且敲击空格确认选择。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">"@angular/core"</span></span><br><span class="line"><span class="keyword">import</span> &#123; CanActivateChild, ActivatedRouteSnapshot, RouterStateSnapshot, UrlTree &#125; <span class="keyword">from</span> <span class="string">"@angular/router"</span></span><br><span class="line"><span class="keyword">import</span> &#123; Observable &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"></span><br><span class="line">@Injectable(&#123;</span><br><span class="line">  providedIn: <span class="string">"root"</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AdminGuard</span> <span class="title">implements</span> <span class="title">CanActivateChild</span> </span>&#123;</span><br><span class="line">  canActivateChild(): boolean | UrlTree &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  path: <span class="string">"about"</span>,</span><br><span class="line">  component: AboutComponent,</span><br><span class="line">  canActivateChild: [AdminGuard],</span><br><span class="line">  children: [</span><br><span class="line">    &#123;</span><br><span class="line">      path: <span class="string">"introduce"</span>,</span><br><span class="line">      component: IntroduceComponent</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="35-路由守卫-CanDeactivate"><a href="#35-路由守卫-CanDeactivate" class="headerlink" title="35.路由守卫 CanDeactivate"></a>35.路由守卫 CanDeactivate</h3><p>检查用户是否可以退出路由。比如用户在表单中输入的内容没有保存，用户又要离开路由，此时可以调用该守卫提示用户。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">"@angular/core"</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  CanDeactivate,</span><br><span class="line">  ActivatedRouteSnapshot,</span><br><span class="line">  RouterStateSnapshot,</span><br><span class="line">  UrlTree</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">"@angular/router"</span></span><br><span class="line"><span class="keyword">import</span> &#123; Observable &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> interface CanComponentLeave &#123;</span><br><span class="line">  canLeave: <span class="function"><span class="params">()</span> =&gt;</span> boolean</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Injectable(&#123;</span><br><span class="line">  providedIn: <span class="string">"root"</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UnsaveGuard</span> <span class="title">implements</span> <span class="title">CanDeactivate</span>&lt;<span class="title">CanComponentLeave</span>&gt; </span>&#123;</span><br><span class="line">  canDeactivate(component: CanComponentLeave): boolean &#123;</span><br><span class="line">    <span class="keyword">if</span> (component.canLeave()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  path: <span class="string">""</span>,</span><br><span class="line">  component: HomeComponent,</span><br><span class="line">  canDeactivate: [UnsaveGuard]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; CanComponentLeave &#125; <span class="keyword">from</span> <span class="string">"src/app/guards/unsave.guard"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeComponent</span> <span class="title">implements</span> <span class="title">CanComponentLeave</span> </span>&#123;</span><br><span class="line">  myForm: FormGroup = <span class="keyword">new</span> FormGroup(&#123;</span><br><span class="line">    username: <span class="keyword">new</span> FormControl()</span><br><span class="line">  &#125;)</span><br><span class="line">  canLeave(): boolean &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.myForm.dirty) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">window</span>.confirm(<span class="string">"有数据未保存, 确定要离开吗"</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="36-路由守卫-Resolve"><a href="#36-路由守卫-Resolve" class="headerlink" title="36.路由守卫 Resolve"></a>36.路由守卫 Resolve</h3><p>允许在进入路由之前先获取数据，待数据获取完成之后再进入路由。</p>
<p><code>ng g resolver &lt;name&gt;</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">"@angular/core"</span></span><br><span class="line"><span class="keyword">import</span> &#123; Resolve &#125; <span class="keyword">from</span> <span class="string">"@angular/router"</span></span><br><span class="line"></span><br><span class="line">type returnType = <span class="built_in">Promise</span>&lt;&#123; <span class="attr">name</span>: string &#125;&gt;</span><br><span class="line"></span><br><span class="line">@Injectable(&#123;</span><br><span class="line">  providedIn: <span class="string">"root"</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ResolveGuard</span> <span class="title">implements</span> <span class="title">Resolve</span>&lt;<span class="title">returnType</span>&gt; </span>&#123;</span><br><span class="line">  resolve(): returnType &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve</span>) </span>&#123;</span><br><span class="line">      setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        resolve(&#123; <span class="attr">name</span>: <span class="string">"张三"</span> &#125;)</span><br><span class="line">      &#125;, <span class="number">2000</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   path: <span class="string">""</span>,</span><br><span class="line">   component: HomeComponent,</span><br><span class="line">   resolve: &#123;</span><br><span class="line">     user: ResolveGuard</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeComponent</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(private route: ActivatedRoute) &#123;&#125;</span><br><span class="line">  ngOnInit(): <span class="keyword">void</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.route.snapshot.data.user)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="任务三：Angular-高级"><a href="#任务三：Angular-高级" class="headerlink" title="任务三：Angular 高级"></a>任务三：Angular 高级</h2><h3 id="1-RxJS快速入门"><a href="#1-RxJS快速入门" class="headerlink" title="1.RxJS快速入门"></a>1.RxJS快速入门</h3><blockquote>
<p>概述</p>
</blockquote>
<img src="./images/65.png" align="left" width="120"/>

<blockquote>
<p>什么是 RxJS ?</p>
</blockquote>
<p>RxJS 是一个用于处理异步编程的  JavaScript 库，目标是使编写异步和基于回调的代码更容易。</p>
<blockquote>
<p>为什么要学习 RxJS ?</p>
</blockquote>
<p>就像 Angular 深度集成 TypeScript 一样，Angular 也深度集成了 RxJS。</p>
<p>服务、表单、事件、全局状态管理、异步请求 …</p>
<blockquote>
<p>快速入门</p>
</blockquote>
<ol>
<li><p>可观察对象  ( Observable ) ：类比 Promise 对象，内部可以用于执行异步代码，通过调用内部提供的方法将异步代码执行的结果传递到可观察对象外部。</p>
</li>
<li><p>观察者 ( Observer )：类比 then 方法中的回调函数，用于接收可观察对象中传递出来数据。</p>
</li>
<li><p>订阅 ( subscribe )：类比 then 方法，通过订阅将可观察对象和观察者连接起来，当可观察对象发出数据时，订阅者可以接收到数据。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Observable &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> observable = <span class="keyword">new</span> Observable(<span class="function"><span class="keyword">function</span> (<span class="params">observer</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    observer.next(&#123;</span><br><span class="line">      name: <span class="string">"张三"</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;, <span class="number">2000</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> observer = &#123;</span><br><span class="line">  next: <span class="function"><span class="keyword">function</span> (<span class="params">value</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(value)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">observable.subscribe(observer)</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="2-可观察对象特性介绍"><a href="#2-可观察对象特性介绍" class="headerlink" title="2.可观察对象特性介绍"></a>2.可观察对象特性介绍</h3><ol>
<li><p>在 Observable 对象内部可以多次调用 next 方法向外发送数据。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> observable = <span class="keyword">new</span> Observable(<span class="function"><span class="keyword">function</span> (<span class="params">observer</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> index = <span class="number">0</span></span><br><span class="line">  setInterval(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    observer.next(index++)</span><br><span class="line">  &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> observer = &#123;</span><br><span class="line">  next: <span class="function"><span class="keyword">function</span> (<span class="params">value</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(value)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">observable.subscribe(observer)</span><br></pre></td></tr></table></figure>
</li>
<li><p>当所有数据发送完成以后，可以调用 complete 方法终止数据发送。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> observable = <span class="keyword">new</span> Observable(<span class="function"><span class="keyword">function</span> (<span class="params">observer</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> index = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> timer = setInterval(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    observer.next(index++)</span><br><span class="line">    <span class="keyword">if</span> (index === <span class="number">3</span>) &#123;</span><br><span class="line">      observer.complete()</span><br><span class="line">      clearInterval(timer)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> observer = &#123;</span><br><span class="line">  next: <span class="function"><span class="keyword">function</span> (<span class="params">value</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(value)</span><br><span class="line">  &#125;,</span><br><span class="line">  complete: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"数据发送完成"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">observable.subscribe(observer)</span><br></pre></td></tr></table></figure>
</li>
<li><p>当 Observable 内部逻辑发生错误时，可以调用 error 方法将失败信息发送给订阅者，Observable 终止。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Observable &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> observable = <span class="keyword">new</span> Observable(<span class="function"><span class="keyword">function</span> (<span class="params">observer</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> index = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> timer = setInterval(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    observer.next(index++)</span><br><span class="line">    <span class="keyword">if</span> (index === <span class="number">3</span>) &#123;</span><br><span class="line">      observer.error(<span class="string">"发生错误"</span>)</span><br><span class="line">      clearInterval(timer)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> observer = &#123;</span><br><span class="line">  next: <span class="function"><span class="keyword">function</span> (<span class="params">value</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(value)</span><br><span class="line">  &#125;,</span><br><span class="line">  error: <span class="function"><span class="keyword">function</span> (<span class="params">error</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(error)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">observable.subscribe(observer)</span><br></pre></td></tr></table></figure>
</li>
<li><p>可观察对象是惰性的，只有被订阅后才会执行</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> observable = <span class="keyword">new</span> Observable(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"Hello RxJS"</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// observable.subscribe()</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>可观察对象可以有 n 多订阅者，每次被订阅时都会得到执行</p>
<img src="./images/64.png" align="left"/>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> observable = <span class="keyword">new</span> Observable(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"Hello RxJS"</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">observable.subscribe()</span><br><span class="line">observable.subscribe()</span><br><span class="line">observable.subscribe()</span><br><span class="line">observable.subscribe()</span><br><span class="line">observable.subscribe()</span><br></pre></td></tr></table></figure>
</li>
<li><p>取消订阅</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> obs = interval(<span class="number">1000</span>)</span><br><span class="line"><span class="keyword">const</span> subscription = obs.subscribe(<span class="built_in">console</span>.log)</span><br><span class="line"></span><br><span class="line">setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  subscription.unsubscribe()</span><br><span class="line">&#125;, <span class="number">2000</span>)</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="3-使用Subject构造函数创建可观察对象"><a href="#3-使用Subject构造函数创建可观察对象" class="headerlink" title="3.使用Subject构造函数创建可观察对象"></a>3.使用Subject构造函数创建可观察对象</h3><ol>
<li><p>用于创建空的可观察对象，在订阅后不会立即执行，next 方法可以在可观察对象外部调用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Subject &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> demoSubject = <span class="keyword">new</span> Subject()</span><br><span class="line"></span><br><span class="line">demoSubject.subscribe(&#123;<span class="attr">next</span>: <span class="function"><span class="keyword">function</span> (<span class="params">value</span>) </span>&#123;<span class="built_in">console</span>.log(value)&#125;&#125;)</span><br><span class="line">demoSubject.subscribe(&#123;<span class="attr">next</span>: <span class="function"><span class="keyword">function</span> (<span class="params">value</span>) </span>&#123;<span class="built_in">console</span>.log(value)&#125;&#125;)</span><br><span class="line"></span><br><span class="line">setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  demoSubject.next(<span class="string">"hahaha"</span>)</span><br><span class="line">&#125;, <span class="number">3000</span>)</span><br></pre></td></tr></table></figure>
<h3 id="4-使用BehaviorSubject创建可观察对象"><a href="#4-使用BehaviorSubject创建可观察对象" class="headerlink" title="4.使用BehaviorSubject创建可观察对象"></a>4.使用BehaviorSubject创建可观察对象</h3></li>
</ol>
<p>拥有 Subject 全部功能，但是在创建 Obervable 对象时可以传入默认值，观察者订阅后可以直接拿到默认值。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; BehaviorSubject &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> demoBehavior = <span class="keyword">new</span> BehaviorSubject(<span class="string">"默认值"</span>)</span><br><span class="line">demoBehavior.subscribe(&#123;<span class="attr">next</span>: <span class="function"><span class="keyword">function</span> (<span class="params">value</span>) </span>&#123;<span class="built_in">console</span>.log(value)&#125;&#125;)</span><br><span class="line">demoBehavior.next(<span class="string">"Hello"</span>)</span><br></pre></td></tr></table></figure>

<h3 id="5-使用ReplaySubject创建可观察对象"><a href="#5-使用ReplaySubject创建可观察对象" class="headerlink" title="5.使用ReplaySubject创建可观察对象"></a>5.使用ReplaySubject创建可观察对象</h3><p>功能类似 Subject，但有新订阅者时两者处理方式不同，Subject 不会广播历史结果，而 ReplaySubject 会广播所有历史结果。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ReplaySubject &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> rSubject = <span class="keyword">new</span> ReplaySubject()</span><br><span class="line"></span><br><span class="line">rSubject.subscribe(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(value)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">rSubject.next(<span class="string">"Hello 1"</span>)</span><br><span class="line">rSubject.next(<span class="string">"Hello 2"</span>)</span><br><span class="line"></span><br><span class="line">setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  rSubject.subscribe(&#123;<span class="attr">next</span>: <span class="function"><span class="keyword">function</span> (<span class="params">value</span>) </span>&#123;<span class="built_in">console</span>.log(value)&#125;&#125;)</span><br><span class="line">&#125;, <span class="number">3000</span>)</span><br></pre></td></tr></table></figure>

<h3 id="6-数据流、操作符介绍"><a href="#6-数据流、操作符介绍" class="headerlink" title="6.数据流、操作符介绍"></a>6.数据流、操作符介绍</h3><blockquote>
<p>操作符</p>
</blockquote>
<ul>
<li>数据流：从可观察对象内部输出的数据就是数据流，可观察对象内部可以向外部源源不断的输出数据。</li>
<li>操作符：用于操作数据流，可以对象数据流进行转换，过滤等等操作。</li>
</ul>
<ol>
<li>map、mapTo</li>
</ol>
<p><strong>map：</strong>对数据流进行转换，基于原有值进行转换。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"><span class="keyword">import</span> &#123; map &#125; <span class="keyword">from</span> <span class="string">"rxjs/operators"</span></span><br><span class="line"></span><br><span class="line">interval(<span class="number">1000</span>)</span><br><span class="line">  .pipe(map(<span class="function"><span class="params">n</span> =&gt;</span> n * <span class="number">2</span>))</span><br><span class="line">  .subscribe(<span class="function"><span class="params">n</span> =&gt;</span> <span class="built_in">console</span>.log(n))</span><br></pre></td></tr></table></figure>

<p><strong>mapTo：</strong>对数据流进行转换，不关心原有值，可以直接传入要转换后的值。</p>
<img src="./images/14.png" width="80%" align="left"/>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"><span class="keyword">import</span> &#123; mapTo &#125; <span class="keyword">from</span> <span class="string">"rxjs/operators"</span></span><br><span class="line"></span><br><span class="line">interval(<span class="number">1000</span>)</span><br><span class="line">  .pipe(mapTo(&#123; <span class="attr">msg</span>: <span class="string">"接收到了数据流"</span> &#125;))</span><br><span class="line">  .subscribe(<span class="function"><span class="params">msg</span> =&gt;</span> <span class="built_in">console</span>.log(msg))</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>filter</li>
</ol>
<p>对数据流进行过滤。</p>
<img src="./images/15.png" width="80%" align="left"/>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; range &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"><span class="keyword">import</span> &#123; filter &#125; <span class="keyword">from</span> <span class="string">"rxjs/operators"</span></span><br><span class="line"></span><br><span class="line">range(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line">  .pipe(filter(<span class="function"><span class="params">n</span> =&gt;</span> n % <span class="number">2</span> === <span class="number">0</span>))</span><br><span class="line">  .subscribe(<span class="function"><span class="params">even</span> =&gt;</span> <span class="built_in">console</span>.log(even))</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>pluck</li>
</ol>
<p>获取数据流对象中的属性值。</p>
<img src="./images/16.png" width="80%" align="left"/>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"><span class="keyword">import</span> &#123; pluck, mapTo &#125; <span class="keyword">from</span> <span class="string">"rxjs/operators"</span></span><br><span class="line"></span><br><span class="line">interval(<span class="number">1000</span>)</span><br><span class="line">  .pipe(</span><br><span class="line">  	mapTo(&#123; <span class="attr">name</span>: <span class="string">"张三"</span>, <span class="attr">a</span>: &#123; <span class="attr">b</span>: <span class="string">"c"</span> &#125; &#125;), </span><br><span class="line">  	pluck(<span class="string">"a"</span>, <span class="string">"b"</span>)</span><br><span class="line">	)</span><br><span class="line">  .subscribe(<span class="function"><span class="params">n</span> =&gt;</span> <span class="built_in">console</span>.log(n))</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>first</li>
</ol>
<p>获取数据流中的第一个值或者查找数据流中第一个符合条件的值，类似数组中的 find 方法。获取到值以后终止行为。</p>
<img src="./images/17.png" width="80%" align="left"/>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"><span class="keyword">import</span> &#123; first &#125; <span class="keyword">from</span> <span class="string">"rxjs/operators"</span></span><br><span class="line"></span><br><span class="line">interval(<span class="number">1000</span>)</span><br><span class="line">  .pipe(first())</span><br><span class="line">  .subscribe(<span class="function"><span class="params">n</span> =&gt;</span> <span class="built_in">console</span>.log(n))</span><br><span class="line"></span><br><span class="line">interval(<span class="number">1000</span>)</span><br><span class="line">  .pipe(first(<span class="function"><span class="params">n</span> =&gt;</span> n === <span class="number">3</span>))</span><br><span class="line">  .subscribe(<span class="function"><span class="params">n</span> =&gt;</span> <span class="built_in">console</span>.log(n))</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>startWith</li>
</ol>
<p>创建一个新的 observable 对象并将参数值发送出去，然后再发送源 observable 对象发出的值。</p>
<p>在异步编程中提供默认值的时候非常有用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"><span class="keyword">import</span> &#123; map, startWith &#125; <span class="keyword">from</span> <span class="string">"rxjs/operators"</span></span><br><span class="line"></span><br><span class="line">interval(<span class="number">1000</span>)</span><br><span class="line">  .pipe(</span><br><span class="line">    map(<span class="function"><span class="params">n</span> =&gt;</span> n + <span class="number">100</span>),</span><br><span class="line">    startWith(<span class="number">505</span>)</span><br><span class="line">  )</span><br><span class="line">  .subscribe(<span class="function"><span class="params">n</span> =&gt;</span> <span class="built_in">console</span>.log(n))</span><br><span class="line"><span class="comment">// 505</span></span><br><span class="line"><span class="comment">// 100</span></span><br><span class="line"><span class="comment">// 101</span></span><br><span class="line"><span class="comment">// 102</span></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<ol start="6">
<li>every</li>
</ol>
<p>查看数据流中的每个值是否都符合条件，返回布尔值。类似数组中的 every 方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; range &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"><span class="keyword">import</span> &#123; every, map &#125; <span class="keyword">from</span> <span class="string">"rxjs/operators"</span></span><br><span class="line"></span><br><span class="line">range(<span class="number">1</span>, <span class="number">9</span>)</span><br><span class="line">  .pipe(</span><br><span class="line">    map(<span class="function"><span class="params">n</span> =&gt;</span> n * <span class="number">2</span>),</span><br><span class="line">    every(<span class="function"><span class="params">n</span> =&gt;</span> n % <span class="number">2</span> === <span class="number">0</span>)</span><br><span class="line">  )</span><br><span class="line">  .subscribe(<span class="function"><span class="params">b</span> =&gt;</span> <span class="built_in">console</span>.log(b))</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>delay、delayWhen</li>
</ol>
<p><strong>delay：</strong>对上一环节的操作整体进行延迟，只执行一次。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"><span class="keyword">import</span> &#123; delay, map, tap &#125; <span class="keyword">from</span> <span class="string">"rxjs/operators"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</span><br><span class="line">  .pipe(</span><br><span class="line">    delay(<span class="number">1000</span>),</span><br><span class="line">    tap(<span class="function"><span class="params">n</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"已经延迟 1s"</span>, n)),</span><br><span class="line">    map(<span class="function"><span class="params">n</span> =&gt;</span> n * <span class="number">2</span>),</span><br><span class="line">    delay(<span class="number">1000</span>),</span><br><span class="line">    tap(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"又延迟了 1s"</span>))</span><br><span class="line">  )</span><br><span class="line">  .subscribe(<span class="built_in">console</span>.log)</span><br><span class="line"></span><br><span class="line"><span class="comment">// tap 操作符不会对数据流造成影响, 它被用来执行简单的副作用, 比如输出, 但是复杂的副作用不要在这执行, 比如 Ajax</span></span><br></pre></td></tr></table></figure>

<p><strong>delayWhen：</strong>对上一环节的操作进行延迟，上一环节发出多少数据流，传入的回调函数就会执行多次。</p>
<img src="./images/20.png" width="80%" align="left"/>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; range, timer &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"><span class="keyword">import</span> &#123; delayWhen &#125; <span class="keyword">from</span> <span class="string">"rxjs/operators"</span></span><br><span class="line"></span><br><span class="line">range(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line">  .pipe(</span><br><span class="line">    delayWhen(<span class="function"><span class="params">n</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(n)</span><br><span class="line">      <span class="keyword">return</span> timer(n * <span class="number">1000</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  )</span><br><span class="line">  .subscribe(<span class="built_in">console</span>.log)</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>take、takeWhile、takeUtil</li>
</ol>
<p><strong>take</strong>：获取数据流中的前几个</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; range &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"><span class="keyword">import</span> &#123; take &#125; <span class="keyword">from</span> <span class="string">"rxjs/operators"</span></span><br><span class="line"></span><br><span class="line">range(<span class="number">1</span>, <span class="number">10</span>).pipe(take(<span class="number">5</span>)).subscribe(<span class="built_in">console</span>.log)</span><br></pre></td></tr></table></figure>

<p><strong>takeWhile：</strong>根据条件从数据源前面开始获取。</p>
<img src="./images/22.png" width="80%" align="left"/>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; range &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"><span class="keyword">import</span> &#123; takeWhile &#125; <span class="keyword">from</span> <span class="string">"rxjs/operators"</span></span><br><span class="line"></span><br><span class="line">range(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line">  .pipe(takeWhile(<span class="function"><span class="params">n</span> =&gt;</span> n &lt; <span class="number">8</span>))</span><br><span class="line">  .subscribe(<span class="built_in">console</span>.log)</span><br></pre></td></tr></table></figure>

<p><strong>takeUntil：</strong>接收可观察对象，当可观察对象发出值时，终止主数据源。</p>
<img src="./images/23.png" width="80%" align="left"/>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, timer &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"><span class="keyword">import</span> &#123; takeUntil &#125; <span class="keyword">from</span> <span class="string">"rxjs/operators"</span></span><br><span class="line"></span><br><span class="line">interval(<span class="number">100</span>)</span><br><span class="line">  .pipe(takeUntil(timer(<span class="number">2000</span>)))</span><br><span class="line">  .subscribe(<span class="built_in">console</span>.log)</span><br><span class="line"><span class="comment">// 结果少两个数据流的原因：第一次和最后一次，都需要延迟 100 毫秒。</span></span><br></pre></td></tr></table></figure>

<ol start="9">
<li>skip、skipWhile、skipUntil</li>
</ol>
<p><strong>skip：</strong>跳过前几个数据流。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; range &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"><span class="keyword">import</span> &#123; skip &#125; <span class="keyword">from</span> <span class="string">"rxjs/operators"</span></span><br><span class="line"></span><br><span class="line">range(<span class="number">1</span>, <span class="number">10</span>).pipe(skip(<span class="number">5</span>)).subscribe(<span class="built_in">console</span>.log)</span><br></pre></td></tr></table></figure>

<p><strong>skipWhile：</strong>根据条件进行数据流的跳过。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; range &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"><span class="keyword">import</span> &#123; skipWhile &#125; <span class="keyword">from</span> <span class="string">"rxjs/operators"</span></span><br><span class="line"></span><br><span class="line">range(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line">  .pipe(skipWhile(<span class="function"><span class="params">n</span> =&gt;</span> n &lt; <span class="number">5</span>))</span><br><span class="line">  .subscribe(<span class="built_in">console</span>.log)</span><br></pre></td></tr></table></figure>

<p><strong>skipUntil：</strong>跳过数据源中前多少时间发出的数据流，发送从这个时间以后数据源中发送的数据流。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; timer, interval &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"><span class="keyword">import</span> &#123; skipUntil &#125; <span class="keyword">from</span> <span class="string">"rxjs/operators"</span></span><br><span class="line"></span><br><span class="line">interval(<span class="number">100</span>)</span><br><span class="line">  .pipe(skipUntil(timer(<span class="number">2000</span>)))</span><br><span class="line">  .subscribe(<span class="built_in">console</span>.log)</span><br></pre></td></tr></table></figure>

<ol start="10">
<li>last</li>
</ol>
<p>获取数据流中的最后一个。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; range &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"><span class="keyword">import</span> &#123; last &#125; <span class="keyword">from</span> <span class="string">"rxjs/operators"</span></span><br><span class="line"></span><br><span class="line">range(<span class="number">1</span>, <span class="number">10</span>).pipe(last()).subscribe(<span class="built_in">console</span>.log)</span><br></pre></td></tr></table></figure>

<p>如果数据源不变成完成状态，则没有最后一个。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"><span class="keyword">import</span> &#123; last, take &#125; <span class="keyword">from</span> <span class="string">"rxjs/operators"</span></span><br><span class="line"></span><br><span class="line">interval(<span class="number">1000</span>).pipe(take(<span class="number">5</span>), last()).subscribe(<span class="built_in">console</span>.log)</span><br></pre></td></tr></table></figure>

<ol start="11">
<li>concatAll、concatMap</li>
</ol>
<p><strong>concatAll：</strong>有时 Observable 发出的又是一个 Obervable，concatAll 的作用就是将新的可观察对象和数据源进行合并。</p>
<p>Observable =&gt; [1, 2, 3]</p>
<p>Observable =&gt; [Observable, Observable]</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, interval &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"><span class="keyword">import</span> &#123; map, take, concatAll &#125; <span class="keyword">from</span> <span class="string">"rxjs/operators"</span></span><br><span class="line"></span><br><span class="line">fromEvent(<span class="built_in">document</span>, <span class="string">"click"</span>)</span><br><span class="line">  .pipe(</span><br><span class="line">    map(<span class="function"><span class="params">event</span> =&gt;</span> interval(<span class="number">1000</span>).pipe(take(<span class="number">2</span>))),</span><br><span class="line">    concatAll()</span><br><span class="line">  )</span><br><span class="line">  .subscribe(<span class="built_in">console</span>.log)</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; map, concatAll &#125; <span class="keyword">from</span> <span class="string">"rxjs/operators"</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">of</span>, interval &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"></span><br><span class="line">interval(<span class="number">1000</span>)</span><br><span class="line">  .pipe(</span><br><span class="line">    map(<span class="function"><span class="params">val</span> =&gt;</span> <span class="keyword">of</span>(val + <span class="number">10</span>)),</span><br><span class="line">    concatAll()</span><br><span class="line">  )</span><br><span class="line">  .subscribe(<span class="built_in">console</span>.log)</span><br></pre></td></tr></table></figure>

<p><strong>concatMap：</strong>合并可观察对象并处理其发出的数据流。</p>
<ol start="12">
<li>reduce、scan</li>
</ol>
<p><strong>reduce</strong>: 类似 JavaScript 数组中的 reduce，对数数据进行累计操作。reduce 会等待数据源中的数据流发送完成后再执行，执行时 reduce 内部遍历每一个数据流进行累计操作，操作完成得到结果将结果作为数据流发出。</p>
<img src="./images/31.png" width="80%" align="left"/>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"><span class="keyword">import</span> &#123; take, reduce &#125; <span class="keyword">from</span> <span class="string">"rxjs/operators"</span></span><br><span class="line"></span><br><span class="line">interval(<span class="number">500</span>)</span><br><span class="line">  .pipe(</span><br><span class="line">    take(<span class="number">5</span>),</span><br><span class="line">    reduce(<span class="function">(<span class="params">acc, value</span>) =&gt;</span> acc += value, <span class="number">0</span>)</span><br><span class="line">  )</span><br><span class="line">  .subscribe(<span class="function"><span class="params">v</span> =&gt;</span> <span class="built_in">console</span>.log())</span><br></pre></td></tr></table></figure>

<p><strong>scan</strong>：类似 reduce，进行累计操作，但执行时机不同，数据源每次发出数据流 scan 都会执行。reduce 是发送出最终计算的结果，而 scan 是发出每次计算的结果。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"><span class="keyword">import</span> &#123; take, scan &#125; <span class="keyword">from</span> <span class="string">"rxjs/operators"</span></span><br><span class="line"></span><br><span class="line">interval(<span class="number">500</span>)</span><br><span class="line">  .pipe(</span><br><span class="line">    take(<span class="number">5</span>),</span><br><span class="line">    scan(<span class="function">(<span class="params">acc, value</span>) =&gt;</span> acc += value, <span class="number">0</span>)</span><br><span class="line">  )</span><br><span class="line">  .subscribe(<span class="function"><span class="params">v</span> =&gt;</span> <span class="built_in">console</span>.log())</span><br></pre></td></tr></table></figure>

<ol start="13">
<li>mergeAll、mergeMap</li>
</ol>
<p><strong>mergeAll：</strong>交叉合并可观察对象。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, interval &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"><span class="keyword">import</span> &#123; map, mergeAll &#125; <span class="keyword">from</span> <span class="string">"rxjs/operators"</span></span><br><span class="line"></span><br><span class="line">fromEvent(<span class="built_in">document</span>, <span class="string">"click"</span>)</span><br><span class="line">  .pipe(</span><br><span class="line">    map(<span class="function"><span class="params">()</span> =&gt;</span> interval(<span class="number">1000</span>)),</span><br><span class="line">    mergeAll()</span><br><span class="line">  )</span><br><span class="line">  .subscribe(<span class="built_in">console</span>.log)</span><br></pre></td></tr></table></figure>

<p><strong>mergeMap</strong>：交叉合并可观察对象以后对可观察对象发出的数据流进行转换。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">of</span>, interval &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"><span class="keyword">import</span> &#123; mergeMap, map &#125; <span class="keyword">from</span> <span class="string">"rxjs/operators"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">of</span>(<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>)</span><br><span class="line">  .pipe(mergeMap(<span class="function"><span class="params">x</span> =&gt;</span> interval(<span class="number">1000</span>).pipe(map(<span class="function"><span class="params">i</span> =&gt;</span> x + i))))</span><br><span class="line">  .subscribe(<span class="function"><span class="params">x</span> =&gt;</span> <span class="built_in">console</span>.log(x))</span><br></pre></td></tr></table></figure>

<ol start="14">
<li>throttleTime</li>
</ol>
<p>节流，可观察对象高频次向外部发出数据流，通过 throttleTime 限制在规定时间内每次只向订阅者传递一次数据流。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"><span class="keyword">import</span> &#123; throttleTime &#125; <span class="keyword">from</span> <span class="string">"rxjs/operators"</span></span><br><span class="line"></span><br><span class="line">fromEvent(<span class="built_in">document</span>, <span class="string">"click"</span>)</span><br><span class="line">  .pipe(throttleTime(<span class="number">2000</span>))</span><br><span class="line">  .subscribe(<span class="function"><span class="params">x</span> =&gt;</span> <span class="built_in">console</span>.log(x))</span><br></pre></td></tr></table></figure>

<ol start="15">
<li>debounceTime</li>
</ol>
<p>防抖，触发高频事件，只响应最后一次。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"><span class="keyword">import</span> &#123; debounceTime &#125; <span class="keyword">from</span> <span class="string">"rxjs/operators"</span></span><br><span class="line"></span><br><span class="line">fromEvent(<span class="built_in">document</span>, <span class="string">"click"</span>)</span><br><span class="line">  .pipe(debounceTime(<span class="number">1000</span>))</span><br><span class="line">  .subscribe(<span class="function"><span class="params">x</span> =&gt;</span> <span class="built_in">console</span>.log(x))</span><br></pre></td></tr></table></figure>

<ol start="16">
<li>distinctUntilChanged</li>
</ol>
<p>检测数据源当前发出的数据流是否和上次发出的相同，如相同，跳过，不相同，发出。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">of</span> &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"><span class="keyword">import</span> &#123; distinctUntilChanged &#125; <span class="keyword">from</span> <span class="string">"rxjs/operators"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">of</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line">  .pipe(distinctUntilChanged())</span><br><span class="line">  .subscribe(<span class="function"><span class="params">x</span> =&gt;</span> <span class="built_in">console</span>.log(x)) <span class="comment">// 1, 2, 1, 2, 3, 4</span></span><br></pre></td></tr></table></figure>

<ol start="17">
<li>groupBy</li>
</ol>
<p>对数据流进行分组。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">of</span> &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"><span class="keyword">import</span> &#123; mergeMap, groupBy, toArray &#125; <span class="keyword">from</span> <span class="string">"rxjs/operators"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">of</span>(</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">"Sue"</span>, <span class="attr">age</span>: <span class="number">25</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">"Joe"</span>, <span class="attr">age</span>: <span class="number">30</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">"Frank"</span>, <span class="attr">age</span>: <span class="number">25</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">"Sarah"</span>, <span class="attr">age</span>: <span class="number">35</span> &#125;</span><br><span class="line">)</span><br><span class="line">  .pipe(</span><br><span class="line">    groupBy(<span class="function"><span class="params">person</span> =&gt;</span> person.age),</span><br><span class="line">    mergeMap(<span class="function"><span class="params">group</span> =&gt;</span> group.pipe(toArray()))</span><br><span class="line">  )</span><br><span class="line">  .subscribe(<span class="built_in">console</span>.log)</span><br><span class="line"></span><br><span class="line"><span class="comment">// [&#123;name: "Sue", age: 25&#125;, &#123; name: "Frank", age: 25 &#125;]</span></span><br><span class="line"><span class="comment">// [&#123; name: "Joe", age: 30 &#125;]</span></span><br><span class="line"><span class="comment">// [&#123; name: "Sarah", age: 35 &#125;]</span></span><br></pre></td></tr></table></figure>

<ol start="18">
<li>withLatestFrom</li>
</ol>
<p>主数据源发出的数据流总是和支数据源中的最新数据流进行结合，返回数组。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, interval &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"><span class="keyword">import</span> &#123; withLatestFrom &#125; <span class="keyword">from</span> <span class="string">"rxjs/operators"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> clicks = fromEvent(<span class="built_in">document</span>, <span class="string">"click"</span>)</span><br><span class="line"><span class="keyword">const</span> timer = interval(<span class="number">1000</span>)</span><br><span class="line">clicks.pipe(withLatestFrom(timer)).subscribe(<span class="built_in">console</span>.log)</span><br></pre></td></tr></table></figure>

<ol start="19">
<li>switchMap</li>
</ol>
<p>切换可观察对象。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, interval &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"><span class="keyword">import</span> &#123; switchMap &#125; <span class="keyword">from</span> <span class="string">"rxjs/operators"</span></span><br><span class="line"></span><br><span class="line">fromEvent(<span class="built_in">document</span>, <span class="string">"click"</span>)</span><br><span class="line">  .pipe(switchMap(<span class="function"><span class="params">ev</span> =&gt;</span> interval(<span class="number">1000</span>)))</span><br><span class="line">  .subscribe(<span class="function"><span class="params">x</span> =&gt;</span> <span class="built_in">console</span>.log(x))</span><br></pre></td></tr></table></figure>

<h3 id="7-辅助方法from"><a href="#7-辅助方法from" class="headerlink" title="7.辅助方法from"></a>7.辅助方法from</h3><blockquote>
<p>辅助方法</p>
</blockquote>
<ol>
<li>range</li>
</ol>
<p>range(start, length)，调用方法后返回 observable 对象，被订阅后会发出指定范围的数值。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; range &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"></span><br><span class="line">range(<span class="number">0</span>, <span class="number">5</span>).subscribe(<span class="function"><span class="params">n</span> =&gt;</span> <span class="built_in">console</span>.log(n))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 0</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// 4</span></span><br></pre></td></tr></table></figure>

<p>方法内部并不是一次发出 length 个数值，而是发送了 length 次，每次发送一个数值，就是说内部调用了 length 次 next 方法。</p>
<ol start="2">
<li>of</li>
</ol>
<p>将参数列表作为数据流返回。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">of</span>(<span class="string">"a"</span>, <span class="string">"b"</span>, [], &#123;&#125;, <span class="literal">true</span>, <span class="number">20</span>).subscribe(<span class="function"><span class="params">v</span> =&gt;</span> <span class="built_in">console</span>.log(v))</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>from</li>
</ol>
<p>将 Array，Promise, Iterator 转换为 observable 对象。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span>([<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>]).subscribe(<span class="function"><span class="params">v</span> =&gt;</span> <span class="built_in">console</span>.log(v))</span><br><span class="line"><span class="comment">// a</span></span><br><span class="line"><span class="comment">// b</span></span><br><span class="line"><span class="comment">// c</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">p</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve</span>) </span>&#123;</span><br><span class="line">    resolve([<span class="number">100</span>, <span class="number">200</span>])</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span>(p()).subscribe(<span class="function"><span class="params">v</span> =&gt;</span> <span class="built_in">console</span>.log(v))</span><br><span class="line"><span class="comment">// [100, 200]</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>interval、timer</li>
</ol>
<p><strong>Interval：</strong>每隔一段时间发出一个数值，数值递增</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"></span><br><span class="line">interval(<span class="number">1000</span>).subscribe(<span class="function"><span class="params">n</span> =&gt;</span> <span class="built_in">console</span>.log(n))</span><br></pre></td></tr></table></figure>

<p><strong>timer：</strong>间隔时间过去以后发出数值，行为终止，或间隔时间发出数值后，继续按第二个参数的时间间隔继续发出值</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; timer &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"></span><br><span class="line">timer(<span class="number">2000</span>).subscribe(<span class="function"><span class="params">n</span> =&gt;</span> <span class="built_in">console</span>.log(n))</span><br><span class="line">timer(<span class="number">0</span>, <span class="number">1000</span>).subscribe(<span class="function"><span class="params">n</span> =&gt;</span> <span class="built_in">console</span>.log(n))</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>concat</li>
</ol>
<p>合并数据流，先让第一个数据流发出值，结束后再让第二个数据流发出值，进行整体合并。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; concat, range &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"></span><br><span class="line">concat(range(<span class="number">1</span>, <span class="number">5</span>), range(<span class="number">6</span>, <span class="number">5</span>)).subscribe(<span class="built_in">console</span>.log)</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>merge</li>
</ol>
<p>合并数据流，多个参数一起发出数据流，按照时间线进行交叉合并。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; merge, fromEvent, interval &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> clicks = fromEvent(<span class="built_in">document</span>, <span class="string">"click"</span>)</span><br><span class="line"><span class="keyword">const</span> timer = interval(<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">merge(clicks, timer).subscribe(<span class="built_in">console</span>.log)</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>combineLatest</li>
</ol>
<p>将两个 Obserable 中最新发出的数据流进行组合成新的数据流，以数组的形式发出。和当前最新的进行组合。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; combineLatest, timer &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> firstTimer = timer(<span class="number">0</span>, <span class="number">1000</span>) <span class="comment">// emit 0, 1, 2... after every second, starting from now</span></span><br><span class="line"><span class="keyword">const</span> secondTimer = timer(<span class="number">500</span>, <span class="number">1000</span>) <span class="comment">// emit 0, 1, 2... after every second, starting 0,5s from now</span></span><br><span class="line">combineLatest(firstTimer, secondTimer).subscribe(<span class="built_in">console</span>.log)</span><br><span class="line"></span><br><span class="line"><span class="comment">// [0, 0] after 0.5s</span></span><br><span class="line"><span class="comment">// [1, 0] after 1s</span></span><br><span class="line"><span class="comment">// [1, 1] after 1.5s</span></span><br><span class="line"><span class="comment">// [2, 1] after 2s</span></span><br></pre></td></tr></table></figure>

<ol start="8">
<li>zip</li>
</ol>
<p>将多个 Observable 中的数据流进行组合。和将来最新的进行组合。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; zip, <span class="keyword">of</span> &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"><span class="keyword">import</span> &#123; map &#125; <span class="keyword">from</span> <span class="string">"rxjs/operators"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> age = <span class="keyword">of</span>(<span class="number">27</span>, <span class="number">25</span>, <span class="number">29</span>)</span><br><span class="line"><span class="keyword">let</span> name = <span class="keyword">of</span>(<span class="string">"Foo"</span>, <span class="string">"Bar"</span>, <span class="string">"Beer"</span>)</span><br><span class="line"><span class="keyword">let</span> isDev = <span class="keyword">of</span>(<span class="literal">true</span>, <span class="literal">true</span>, <span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line">zip(name, age, isDev)</span><br><span class="line">  .pipe(map(<span class="function">(<span class="params">[name, age, isDev]</span>) =&gt;</span> (&#123; name, age, isDev &#125;)))</span><br><span class="line">  .subscribe(<span class="built_in">console</span>.log)</span><br><span class="line"></span><br><span class="line"><span class="comment">// &#123; name: 'Foo', age: 27, isDev: true &#125;</span></span><br><span class="line"><span class="comment">// &#123; name: 'Bar', age: 25, isDev: true &#125;</span></span><br><span class="line"><span class="comment">// &#123; name: 'Beer', age: 29, isDev: false &#125;</span></span><br></pre></td></tr></table></figure>

<ol start="9">
<li>forkJoin</li>
</ol>
<p>forkJoin 是 Rx 版本的 Promise.all()，即表示等到所有的 Observable 都完成后，才一次性返回值。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">"axios"</span></span><br><span class="line"><span class="keyword">import</span> &#123; forkJoin, <span class="keyword">from</span> &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"></span><br><span class="line">axios.interceptors.response.use(<span class="function"><span class="params">response</span> =&gt;</span> response.data)</span><br><span class="line"></span><br><span class="line">forkJoin(&#123;</span><br><span class="line">  goods: <span class="keyword">from</span>(axios.get(<span class="string">"http://localhost:3005/goods"</span>)),</span><br><span class="line">  category: <span class="keyword">from</span>(axios.get(<span class="string">"http://localhost:3005/category"</span>))</span><br><span class="line">&#125;).subscribe(<span class="built_in">console</span>.log)</span><br></pre></td></tr></table></figure>

<ol start="10">
<li>throwError</li>
</ol>
<p>返回可观察对象并向订阅者抛出错误。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; throwError &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"></span><br><span class="line">throwError(<span class="string">"发生了未知错误"</span>).subscribe(&#123; <span class="attr">error</span>: <span class="built_in">console</span>.log &#125;)</span><br></pre></td></tr></table></figure>

<ol start="11">
<li>retry</li>
</ol>
<p>如果 Observable 对象抛出错误，则该辅助方法会重新订阅 Observable 以获取数据流，参数为重新订阅次数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; interval, <span class="keyword">of</span>, throwError &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"><span class="keyword">import</span> &#123; mergeMap, retry &#125; <span class="keyword">from</span> <span class="string">"rxjs/operators"</span></span><br><span class="line"></span><br><span class="line">interval(<span class="number">1000</span>)</span><br><span class="line">  .pipe(</span><br><span class="line">    mergeMap(<span class="function"><span class="params">val</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (val &gt; <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> throwError(<span class="string">"Error!"</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">of</span>(val)</span><br><span class="line">    &#125;),</span><br><span class="line">    retry(<span class="number">2</span>)</span><br><span class="line">  )</span><br><span class="line">  .subscribe(&#123;</span><br><span class="line">    next: <span class="built_in">console</span>.log,</span><br><span class="line">    error: <span class="built_in">console</span>.log</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>

<ol start="12">
<li>race</li>
</ol>
<p>接收并同时执行多个可观察对象，只将最快发出的数据流传递给订阅者。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; race, timer &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"><span class="keyword">import</span> &#123; mapTo &#125; <span class="keyword">from</span> <span class="string">"rxjs/operators"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> obs1 = timer(<span class="number">1000</span>).pipe(mapTo(<span class="string">"fast one"</span>))</span><br><span class="line"><span class="keyword">const</span> obs2 = timer(<span class="number">3000</span>).pipe(mapTo(<span class="string">"medium one"</span>))</span><br><span class="line"><span class="keyword">const</span> obs3 = timer(<span class="number">5000</span>).pipe(mapTo(<span class="string">"slow one"</span>))</span><br><span class="line"></span><br><span class="line">race(obs3, obs1, obs2).subscribe(<span class="built_in">console</span>.log)</span><br></pre></td></tr></table></figure>

<ol start="13">
<li>fromEvent</li>
</ol>
<p>将事件转换为 Observable。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> btn = <span class="built_in">document</span>.getElementById(<span class="string">"btn"</span>)</span><br><span class="line"><span class="comment">// 可以将 Observer 简写成一个函数，表示 next</span></span><br><span class="line">fromEvent(btn, <span class="string">"click"</span>).subscribe(<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">console</span>.log(e))</span><br></pre></td></tr></table></figure>

<h3 id="8-辅助方法forkJoin"><a href="#8-辅助方法forkJoin" class="headerlink" title="8.辅助方法forkJoin"></a>8.辅助方法forkJoin</h3><p>见上</p>
<h3 id="9-辅助方法fromEvent和操作符pluck"><a href="#9-辅助方法fromEvent和操作符pluck" class="headerlink" title="9.辅助方法fromEvent和操作符pluck"></a>9.辅助方法fromEvent和操作符pluck</h3><p>见上</p>
<h3 id="10-辅助方法interval和操作符switchMap"><a href="#10-辅助方法interval和操作符switchMap" class="headerlink" title="10.辅助方法interval和操作符switchMap"></a>10.辅助方法interval和操作符switchMap</h3><p>见上</p>
<h3 id="11-操作符take、takeWhile、takeUntil"><a href="#11-操作符take、takeWhile、takeUntil" class="headerlink" title="11.操作符take、takeWhile、takeUntil"></a>11.操作符take、takeWhile、takeUntil</h3><p>见上</p>
<h3 id="12-操作符节流和防抖"><a href="#12-操作符节流和防抖" class="headerlink" title="12.操作符节流和防抖"></a>12.操作符节流和防抖</h3><p>见上</p>
<h3 id="13-辅助方法of和操作符distinctUntilChanged"><a href="#13-辅助方法of和操作符distinctUntilChanged" class="headerlink" title="13.辅助方法of和操作符distinctUntilChanged"></a>13.辅助方法of和操作符distinctUntilChanged</h3><p>见上</p>
<h3 id="14-RxJS案例之元素拖拽"><a href="#14-RxJS案例之元素拖拽" class="headerlink" title="14.RxJS案例之元素拖拽"></a>14.RxJS案例之元素拖拽</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">  <span class="selector-id">#box</span> &#123;</span></span><br><span class="line">    width: 200px;</span><br><span class="line">    height: 200px;</span><br><span class="line">    background: skyblue;</span><br><span class="line">    position: absolute;</span><br><span class="line">    left: 0;</span><br><span class="line">    top: 0;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"box"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 原生 JavaScript</span></span><br><span class="line">box.onmousedown = <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> distanceX = event.clientX - event.target.offsetLeft</span><br><span class="line">  <span class="keyword">let</span> distanceY = event.clientY - event.target.offsetTop</span><br><span class="line">  <span class="built_in">document</span>.onmousemove = <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> positionX = event.clientX - distanceX</span><br><span class="line">    <span class="keyword">let</span> positionY = event.clientY - distanceY</span><br><span class="line">    box.style.left = positionX + <span class="string">"px"</span></span><br><span class="line">    box.style.top = positionY + <span class="string">"px"</span></span><br><span class="line">  &#125;</span><br><span class="line">  box.onmouseup = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">document</span>.onmousemove = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RxJS</span></span><br><span class="line"><span class="keyword">import</span> &#123; fromEvent &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"><span class="keyword">import</span> &#123; map, switchMap, takeUntil &#125; <span class="keyword">from</span> <span class="string">"rxjs/operators"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> box = <span class="built_in">document</span>.getElementById(<span class="string">"box"</span>)</span><br><span class="line"></span><br><span class="line">fromEvent(box, <span class="string">"mousedown"</span>)</span><br><span class="line">  .pipe(</span><br><span class="line">    map(<span class="function"><span class="params">event</span> =&gt;</span> (&#123;</span><br><span class="line">      distanceX: event.clientX - event.target.offsetLeft,</span><br><span class="line">      distanceY: event.clientY - event.target.offsetTop</span><br><span class="line">    &#125;)),</span><br><span class="line">    switchMap(<span class="function">(<span class="params">&#123; distanceX, distanceY &#125;</span>) =&gt;</span></span><br><span class="line">      fromEvent(<span class="built_in">document</span>, <span class="string">"mousemove"</span>).pipe(</span><br><span class="line">        map(<span class="function"><span class="params">event</span> =&gt;</span> (&#123;</span><br><span class="line">          positionX: event.clientX - distanceX,</span><br><span class="line">          positionY: event.clientY - distanceY</span><br><span class="line">        &#125;)),</span><br><span class="line">        takeUntil(fromEvent(<span class="built_in">document</span>, <span class="string">"mouseup"</span>))</span><br><span class="line">      )</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line">  .subscribe(<span class="function">(<span class="params">&#123; positionX, positionY &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    box.style.left = positionX + <span class="string">"px"</span></span><br><span class="line">    box.style.top = positionY + <span class="string">"px"</span></span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>

<h3 id="15-搜索案例"><a href="#15-搜索案例" class="headerlink" title="15.搜索案例"></a>15.搜索案例</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"search"</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">placeholder</span>=<span class="string">"请输入搜索内容..."</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, <span class="keyword">from</span>, throwError &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"><span class="keyword">import</span> &#123; debounceTime, distinctUntilChanged, map, switchMap, catchError &#125; <span class="keyword">from</span> <span class="string">"rxjs/operators"</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">"axios"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> search = <span class="built_in">document</span>.getElementById(<span class="string">"search"</span>)</span><br><span class="line"></span><br><span class="line">fromEvent(search, <span class="string">"keyup"</span>)</span><br><span class="line">  .pipe(</span><br><span class="line">    debounceTime(<span class="number">700</span>),</span><br><span class="line">    map(<span class="function"><span class="params">event</span> =&gt;</span> event.target.value),</span><br><span class="line">    distinctUntilChanged(),</span><br><span class="line">    switchMap(<span class="function"><span class="params">keyword</span> =&gt;</span></span><br><span class="line">      <span class="keyword">from</span>(</span><br><span class="line">        axios.get(<span class="string">`https://j1sonplaceholder.typicode.com/posts?q=<span class="subst">$&#123;keyword&#125;</span>`</span>)</span><br><span class="line">      ).pipe(</span><br><span class="line">        map(<span class="function"><span class="params">response</span> =&gt;</span> response.data),</span><br><span class="line">        catchError(<span class="function"><span class="params">error</span> =&gt;</span> throwError(<span class="string">`发生了错误: <span class="subst">$&#123;error.message&#125;</span>`</span>))</span><br><span class="line">      )</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line">  .subscribe(&#123;</span><br><span class="line">    next: <span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(value)</span><br><span class="line">    &#125;,</span><br><span class="line">    error: <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(error)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>

<h3 id="16-案例之串联请求的发送"><a href="#16-案例之串联请求的发送" class="headerlink" title="16.案例之串联请求的发送"></a>16.案例之串联请求的发送</h3><p>先获取token，再根据token获取用户信息</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"btn"</span>&gt;</span>获取用户信息<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">"axios"</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, fromEvent &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"><span class="keyword">import</span> &#123; pluck, concatMap &#125; <span class="keyword">from</span> <span class="string">"rxjs/operators"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> button = <span class="built_in">document</span>.getElementById(<span class="string">"btn"</span>)</span><br><span class="line"></span><br><span class="line">fromEvent(button, <span class="string">"click"</span>)</span><br><span class="line">  .pipe(</span><br><span class="line">    concatMap(<span class="function"><span class="params">event</span> =&gt;</span></span><br><span class="line">      <span class="keyword">from</span>(axios.get(<span class="string">"http://localhost:3005/token"</span>)).pipe(</span><br><span class="line">        pluck(<span class="string">"data"</span>, <span class="string">"token"</span>)</span><br><span class="line">      )</span><br><span class="line">    ),</span><br><span class="line">    concatMap(<span class="function"><span class="params">token</span> =&gt;</span></span><br><span class="line">      <span class="keyword">from</span>(axios.get(<span class="string">"http://localhost:3005/userInfo"</span>)).pipe(pluck(<span class="string">"data"</span>))</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line">  .subscribe(<span class="built_in">console</span>.log)</span><br></pre></td></tr></table></figure>

<h3 id="17-HttpClientModule的基本使用"><a href="#17-HttpClientModule的基本使用" class="headerlink" title="17.HttpClientModule的基本使用"></a>17.HttpClientModule的基本使用</h3><p>该模块用于发送 Http 请求，用于发送请求的方法都返回 Observable 对象。</p>
<h4 id="1-快速开始"><a href="#1-快速开始" class="headerlink" title="1. 快速开始"></a>1. 快速开始</h4><ol>
<li><p>引入 HttpClientModule 模块</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.module.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; httpClientModule &#125; <span class="keyword">from</span> <span class="string">'@angular/common/http'</span>;</span><br><span class="line">imports: [</span><br><span class="line">  httpClientModule</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>注入 HttpClient 服务实例对象，用于发送请求</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.component.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; HttpClient &#125; <span class="keyword">from</span> <span class="string">'@angular/common/http'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">	<span class="keyword">constructor</span>(private http: HttpClient) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>发送请求</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; HttpClient &#125; <span class="keyword">from</span> <span class="string">"@angular/common/http"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> <span class="title">implements</span> <span class="title">OnInit</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(private http: HttpClient) &#123;&#125;</span><br><span class="line">  ngOnInit() &#123;</span><br><span class="line">    <span class="keyword">this</span>.getUsers().subscribe(<span class="built_in">console</span>.log)</span><br><span class="line">  &#125;</span><br><span class="line">  getUsers() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.http.get(<span class="string">"https://jsonplaceholder.typicode.com/users"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h4 id="2-请求方法"><a href="#2-请求方法" class="headerlink" title="2. 请求方法"></a>2. 请求方法</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.http.get(url [, options]);</span><br><span class="line"><span class="keyword">this</span>.http.post(url, data [, options]);</span><br><span class="line"><span class="keyword">this</span>.http.delete(url [, options]);</span><br><span class="line"><span class="keyword">this</span>.http.put(url, data [, options]);</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.http.get&lt;Post[]&gt;(<span class="string">'/getAllPosts'</span>)</span><br><span class="line">  .subscribe(<span class="function"><span class="params">response</span> =&gt;</span> <span class="built_in">console</span>.log(response))</span><br></pre></td></tr></table></figure>

<h3 id="18-HttpParams类的使用"><a href="#18-HttpParams类的使用" class="headerlink" title="18.HttpParams类的使用"></a>18.HttpParams类的使用</h3><ol>
<li><p>HttpParams 类</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> declare <span class="class"><span class="keyword">class</span> <span class="title">HttpParams</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(options?: HttpParamsOptions);</span><br><span class="line">    has(param: string): boolean;</span><br><span class="line">    <span class="keyword">get</span>(param: string): string | null;</span><br><span class="line">    getAll(param: string): string[] | null;</span><br><span class="line">    keys(): string[];</span><br><span class="line">    append(param: string, value: string): HttpParams;</span><br><span class="line">    <span class="keyword">set</span>(param: string, value: string): HttpParams;</span><br><span class="line">    delete(param: string, value?: string): HttpParams;</span><br><span class="line">    toString(): string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>HttpParamsOptions 接口</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">declare interface HttpParamsOptions &#123;</span><br><span class="line">    fromString?: string;</span><br><span class="line">    fromObject?: &#123;</span><br><span class="line">        [param: string]: string | ReadonlyArray&lt;string&gt;;</span><br><span class="line">    &#125;;</span><br><span class="line">    encoder?: HttpParameterCodec;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用示例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; HttpParams &#125; <span class="keyword">from</span> <span class="string">'@angular/common/http'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> params = <span class="keyword">new</span> HttpParams(&#123; <span class="attr">fromObject</span>: &#123;<span class="attr">name</span>: <span class="string">"zhangsan"</span>, <span class="attr">age</span>: <span class="string">"20"</span>&#125;&#125;)</span><br><span class="line">params = params.append(<span class="string">"sex"</span>, <span class="string">"male"</span>)</span><br><span class="line"><span class="keyword">let</span> params = <span class="keyword">new</span> HttpParams(&#123; <span class="attr">fromString</span>: <span class="string">"name=zhangsan&amp;age=20"</span>&#125;)</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="19-HttpHeaders类的使用"><a href="#19-HttpHeaders类的使用" class="headerlink" title="19.HttpHeaders类的使用"></a>19.HttpHeaders类的使用</h3><p>请求头字段的创建需要使用 HttpHeaders 类，在类实例对象下面有各种操作请求头的方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> declare <span class="class"><span class="keyword">class</span> <span class="title">HttpHeaders</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(headers?: string | &#123;</span><br><span class="line">        [name: string]: string | string[];</span><br><span class="line">    &#125;);</span><br><span class="line">    has(name: string): boolean;</span><br><span class="line">    <span class="keyword">get</span>(name: string): string | null;</span><br><span class="line">    keys(): string[];</span><br><span class="line">    getAll(name: string): string[] | null;</span><br><span class="line">    append(name: string, value: string | string[]): HttpHeaders;</span><br><span class="line">    <span class="keyword">set</span>(name: string, value: string | string[]): HttpHeaders;</span><br><span class="line">    delete(name: string, value?: string | string[]): HttpHeaders;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> headers = <span class="keyword">new</span> HttpHeaders(&#123; <span class="attr">test</span>: <span class="string">"Hello"</span> &#125;)</span><br></pre></td></tr></table></figure>

<h3 id="20-设置响应体"><a href="#20-设置响应体" class="headerlink" title="20.设置响应体"></a>20.设置响应体</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">declare type HttpObserve = <span class="string">'body'</span> | <span class="string">'response'</span>;</span><br><span class="line"><span class="comment">// response 读取完整响应体</span></span><br><span class="line"><span class="comment">// body 读取服务器端返回的数据</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.http.get(</span><br><span class="line">  <span class="string">"https://jsonplaceholder.typicode.com/users"</span>, </span><br><span class="line">  &#123; <span class="attr">observe</span>: <span class="string">"body"</span> &#125;</span><br><span class="line">).subscribe(<span class="built_in">console</span>.log)</span><br></pre></td></tr></table></figure>

<h3 id="21-拦截器的使用-一"><a href="#21-拦截器的使用-一" class="headerlink" title="21.拦截器的使用(一)"></a>21.拦截器的使用(一)</h3><p>拦截器是 Angular 应用中全局捕获和修改 HTTP 请求和响应的方式。（Token、Error）<br>拦截器将只拦截使用 HttpClientModule 模块发出的请求。</p>
<p><code>ng g interceptor &lt;name&gt;</code></p>
<ol>
<li>请求拦截</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthInterceptor</span> <span class="title">implements</span> <span class="title">HttpInterceptor</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;&#125;</span><br><span class="line">	<span class="comment">// 拦截方法</span></span><br><span class="line">  intercept(</span><br><span class="line">  	<span class="comment">// unknown 指定请求体 (body) 的类型</span></span><br><span class="line">    request: HttpRequest&lt;unknown&gt;,</span><br><span class="line">    next: HttpHandler</span><br><span class="line">     <span class="comment">// unknown 指定响应内容 (body) 的类型</span></span><br><span class="line">  ): Observable&lt;HttpEvent&lt;unknown&gt;&gt; &#123;</span><br><span class="line">    <span class="comment">// 克隆并修改请求头</span></span><br><span class="line">    <span class="keyword">const</span> req = request.clone(&#123;</span><br><span class="line">      setHeaders: &#123;</span><br><span class="line">        Authorization: <span class="string">"Bearer xxxxxxx"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// 通过回调函数将修改后的请求头回传给应用</span></span><br><span class="line">    <span class="keyword">return</span> next.handle(req)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>响应拦截</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Injectable() </span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthInterceptor</span> <span class="title">implements</span> <span class="title">HttpInterceptor</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;&#125;</span><br><span class="line">	<span class="comment">// 拦截方法</span></span><br><span class="line">  intercept(</span><br><span class="line">    request: HttpRequest&lt;unknown&gt;,</span><br><span class="line">    next: HttpHandler</span><br><span class="line">  ): Observable&lt;any&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> next.handle(request).pipe(</span><br><span class="line">      retry(<span class="number">2</span>),</span><br><span class="line">      catchError(<span class="function">(<span class="params">error: HttpErrorResponse</span>) =&gt;</span> throwError(error))</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="22-拦截器的使用-二"><a href="#22-拦截器的使用-二" class="headerlink" title="22.拦截器的使用(二)"></a>22.拦截器的使用(二)</h3><blockquote>
<p>拦截器注入</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; AuthInterceptor &#125; <span class="keyword">from</span> <span class="string">"./auth.interceptor"</span></span><br><span class="line"><span class="keyword">import</span> &#123; HTTP_INTERCEPTORS &#125; <span class="keyword">from</span> <span class="string">"@angular/common/http"</span></span><br><span class="line"></span><br><span class="line">@NgModule(&#123;</span><br><span class="line">  providers: [</span><br><span class="line">    &#123;</span><br><span class="line">      provide: HTTP_INTERCEPTORS,</span><br><span class="line">      useClass: AuthInterceptor,</span><br><span class="line">      multi: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="23-配置AngularProxy"><a href="#23-配置AngularProxy" class="headerlink" title="23.配置AngularProxy"></a>23.配置AngularProxy</h3><ol>
<li><p>在项目的根目录下创建  proxy.conf.json 文件并加入如下代码</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"> 	<span class="attr">"/api/*"</span>: &#123;</span><br><span class="line">    <span class="attr">"target"</span>: <span class="string">"http://localhost:3070"</span>,</span><br><span class="line">    <span class="attr">"secure"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"changeOrigin"</span>: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>/api/*：在应用中发出的以 /api 开头的请求走此代理</li>
<li>target：服务器端 URL</li>
<li>secure：如果服务器端 URL 的协议是 https，此项需要为 true</li>
<li>changeOrigin：如果服务器端不是 localhost， 此项需要为 true</li>
</ol>
</li>
<li><p>指定 proxy 配置文件 (方式一) </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"scripts"</span>: &#123;</span><br><span class="line">  <span class="string">"start"</span>: <span class="string">"ng serve --proxy-config proxy.conf.json"</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>指定 proxy 配置文件 (方式二)</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">"serve": &#123;</span><br><span class="line">  "options": &#123;</span><br><span class="line">    "proxyConfig": "proxy.conf.json"</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="24-NgRx概述"><a href="#24-NgRx概述" class="headerlink" title="24.NgRx概述"></a>24.NgRx概述</h3><h3 id="25-NgRx基本使用"><a href="#25-NgRx基本使用" class="headerlink" title="25.NgRx基本使用"></a>25.NgRx基本使用</h3><h3 id="26-selector的用法"><a href="#26-selector的用法" class="headerlink" title="26.selector的用法"></a>26.selector的用法</h3><h3 id="27-Action传递参数"><a href="#27-Action传递参数" class="headerlink" title="27.Action传递参数"></a>27.Action传递参数</h3><h3 id="28-metaReducer机制介绍"><a href="#28-metaReducer机制介绍" class="headerlink" title="28.metaReducer机制介绍"></a>28.metaReducer机制介绍</h3><h3 id="29-使用Effect接收Action执行副作用"><a href="#29-使用Effect接收Action执行副作用" class="headerlink" title="29.使用Effect接收Action执行副作用"></a>29.使用Effect接收Action执行副作用</h3><h3 id="30-ngrx案例todo之添加任务"><a href="#30-ngrx案例todo之添加任务" class="headerlink" title="30.ngrx案例todo之添加任务"></a>30.ngrx案例todo之添加任务</h3><h3 id="31-案例todo之展示任务"><a href="#31-案例todo之展示任务" class="headerlink" title="31.案例todo之展示任务"></a>31.案例todo之展示任务</h3><h3 id="32-案例todo之删除任务"><a href="#32-案例todo之删除任务" class="headerlink" title="32.案例todo之删除任务"></a>32.案例todo之删除任务</h3><h3 id="33-在todo案例中加入Entity简化实体操作"><a href="#33-在todo案例中加入Entity简化实体操作" class="headerlink" title="33.在todo案例中加入Entity简化实体操作"></a>33.在todo案例中加入Entity简化实体操作</h3><p>Entity 译为实体，实体就是集合中的一条数据。</p>
<p>NgRx 中提供了实体适配器对象，在实体适配器对象下面提供了各种操作集合中实体的方法，目的就是提高开发者操作实体的效率。</p>
<blockquote>
<p>核心</p>
</blockquote>
<ol>
<li><p>EntityState：实体类型接口</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	&#123;</span></span><br><span class="line"><span class="comment">		ids: [1, 2],</span></span><br><span class="line"><span class="comment">		entities: &#123;</span></span><br><span class="line"><span class="comment">			1: &#123; id: 1, title: "Hello Angular" &#125;,</span></span><br><span class="line"><span class="comment">			2: &#123; id: 2, title: "Hello NgRx" &#125;</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">export</span> interface State extends EntityState&lt;Todo&gt; &#123;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>createEntityAdapter： 创建实体适配器对象</p>
</li>
<li><p>EntityAdapter：实体适配器对象类型接口</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> adapter: EntityAdapter&lt;Todo&gt; = createEntityAdapter&lt;Todo&gt;()</span><br><span class="line"><span class="comment">// 获取初始状态 可以传递对象参数 也可以不传</span></span><br><span class="line"><span class="comment">// &#123;ids: [], entities: &#123;&#125;&#125;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> initialState: State = adapter.getInitialState()</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h5 id="15-6-3-实例方法"><a href="#15-6-3-实例方法" class="headerlink" title="15.6.3 实例方法"></a>15.6.3 实例方法</h5><p><a href="https://ngrx.io/guide/entity/adapter#adapter-collection-methods" target="_blank" rel="noopener">https://ngrx.io/guide/entity/adapter#adapter-collection-methods</a></p>
<h5 id="15-6-4-选择器"><a href="#15-6-4-选择器" class="headerlink" title="15.6.4 选择器"></a>15.6.4 选择器</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// selectTotal 获取数据条数</span></span><br><span class="line"><span class="comment">// selectAll 获取所有数据 以数组形式呈现</span></span><br><span class="line"><span class="comment">// selectEntities 获取实体集合 以字典形式呈现</span></span><br><span class="line"><span class="comment">// selectIds 获取id集合, 以数组形式呈现</span></span><br><span class="line"><span class="keyword">const</span> &#123; selectIds, selectEntities, selectAll, selectTotal &#125; = adapter.getSelectors();</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> selectTodo = createFeatureSelector&lt;AppState, State&gt;(todoFeatureKey)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> selectTodos = createSelector(selectTodo, selectAll)</span><br></pre></td></tr></table></figure>

<h3 id="34-将路由状态同步到Store中"><a href="#34-将路由状态同步到Store中" class="headerlink" title="34.将路由状态同步到Store中"></a>34.将路由状态同步到Store中</h3><ol>
<li><p>引入模块</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; StoreRouterConnectingModule &#125; <span class="keyword">from</span> <span class="string">"@ngrx/router-store"</span></span><br><span class="line"></span><br><span class="line">@NgModule(&#123;</span><br><span class="line">  imports: [</span><br><span class="line">    StoreRouterConnectingModule.forRoot()</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>将路由状态集成到 Store</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> fromRouter <span class="keyword">from</span> <span class="string">"@ngrx/router-store"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> interface AppState &#123;</span><br><span class="line">  router: fromRouter.RouterReducerState</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> reducers: ActionReducerMap&lt;AppState&gt; = &#123;</span><br><span class="line">  router: fromRouter.routerReducer</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<blockquote>
<p>创建获取路由状态的 Selector</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router.selectors.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; createFeatureSelector &#125; <span class="keyword">from</span> <span class="string">"@ngrx/store"</span></span><br><span class="line"><span class="keyword">import</span> &#123; AppState &#125; <span class="keyword">from</span> <span class="string">".."</span></span><br><span class="line"><span class="keyword">import</span> &#123; RouterReducerState, getSelectors &#125; <span class="keyword">from</span> <span class="string">"@ngrx/router-store"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> selectRouter = createFeatureSelector&lt;AppState, RouterReducerState&gt;(</span><br><span class="line">  <span class="string">"router"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> &#123;</span><br><span class="line">  <span class="comment">// 获取和当前路由相关的信息 (路由参数、路由配置等)</span></span><br><span class="line">  selectCurrentRoute,</span><br><span class="line">  <span class="comment">// 获取地址栏中 # 号后面的内容</span></span><br><span class="line">  selectFragment,</span><br><span class="line">  <span class="comment">// 获取路由查询参数</span></span><br><span class="line">  selectQueryParams,</span><br><span class="line">  <span class="comment">// 获取具体的某一个查询参数 selectQueryParam('name')</span></span><br><span class="line">  selectQueryParam,</span><br><span class="line">  <span class="comment">// 获取动态路由参数</span></span><br><span class="line">  selectRouteParams,</span><br><span class="line"> 	<span class="comment">// 获取某一个具体的动态路由参数 selectRouteParam('name')</span></span><br><span class="line">  selectRouteParam,</span><br><span class="line">  <span class="comment">// 获取路由自定义数据</span></span><br><span class="line">  selectRouteData,</span><br><span class="line">  <span class="comment">// 获取路由的实际访问地址</span></span><br><span class="line">  selectUrl</span><br><span class="line">&#125; = getSelectors(selectRouter)</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// home.component.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; select, Store &#125; <span class="keyword">from</span> <span class="string">"@ngrx/store"</span></span><br><span class="line"><span class="keyword">import</span> &#123; AppState &#125; <span class="keyword">from</span> <span class="string">"src/app/store"</span></span><br><span class="line"><span class="keyword">import</span> &#123; selectQueryParams &#125; <span class="keyword">from</span> <span class="string">"src/app/store/selectors/router.selectors"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AboutComponent</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(private store: Store&lt;AppState&gt;) &#123;</span><br><span class="line">    <span class="keyword">this</span>.store.pipe(select(selectQueryParams)).subscribe(<span class="built_in">console</span>.log)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="35-和状态相关的概念"><a href="#35-和状态相关的概念" class="headerlink" title="35.和状态相关的概念"></a>35.和状态相关的概念</h3><blockquote>
<p>什么是状态</p>
</blockquote>
<p>状态表示的是要进行运动的元素在运动的不同时期所呈现的样式。</p>
<blockquote>
<p>状态的种类</p>
</blockquote>
<p>在 Angular 中，有三种类型的状态，分别为：<code>void</code>、<code>*</code>、<code>custom</code></p>
<p>void：当元素在内存中创建好但尚未被添加到 DOM 中或将元素从 DOM 中删除时会发生此状态</p>
<p>*：元素被插入到 DOM 树之后的状态，或者是已经在DOM树中的元素的状态，也叫默认状态</p>
<p>custom：自定义状态，元素默认就在页面之中，从一个状态运动到另一个状态，比如面板的折叠和展开。</p>
<blockquote>
<p>为todo案例添加进场动画和出场动画</p>
</blockquote>
<ul>
<li>进场动画是指元素被创建后以动画的形式出现在用户面前，进场动画的状态用 <code>void =&gt; *</code> 表示，别名为 <code>:enter</code></li>
<li>出场动画是指元素在被删除前执行的一段告别动画，出场动画的状态用 <code>* =&gt; void</code>，别名为 <code>:leave</code></li>
</ul>
<blockquote>
<p>快速上手</p>
</blockquote>
<ol>
<li><p>在使用动画功能之前，需要引入动画模块，即 <code>BrowserAnimationsModule</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; BrowserAnimationsModule &#125; <span class="keyword">from</span> <span class="string">"@angular/platform-browser/animations"</span></span><br><span class="line"></span><br><span class="line">@NgModule(&#123;</span><br><span class="line">  imports: [BrowserAnimationsModule],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>默认代码解析，todo 之删除任务和添加任务</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 在 index.html 文件中引入 bootstrap.min.css --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Todos<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> (<span class="attr">keyup.enter</span>)=<span class="string">"addItem(input)"</span> #<span class="attr">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">placeholder</span>=<span class="string">"add todos"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"list-group"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> (<span class="attr">click</span>)=<span class="string">"removeItem(i)"</span> *<span class="attr">ngFor</span>=<span class="string">"let item of todos; let i = index"</span> <span class="attr">class</span>=<span class="string">"list-group-item"</span>&gt;</span></span><br><span class="line">      &#123;&#123; item &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component &#125; <span class="keyword">from</span> <span class="string">"@angular/core"</span></span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">"app-root"</span>,</span><br><span class="line">  templateUrl: <span class="string">"./app.component.html"</span>,</span><br><span class="line">  styles: []</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  <span class="comment">// todo 列表</span></span><br><span class="line">  todos: string[] = [<span class="string">"Learn Angular"</span>, <span class="string">"Learn RxJS"</span>, <span class="string">"Learn NgRx"</span>]</span><br><span class="line">	<span class="comment">// 添加 todo</span></span><br><span class="line">  addItem(input: HTMLInputElement) &#123;</span><br><span class="line">    <span class="keyword">this</span>.todos.push(input.value)</span><br><span class="line">    input.value = <span class="string">""</span></span><br><span class="line">  &#125;</span><br><span class="line">	<span class="comment">// 删除 todo</span></span><br><span class="line">  removeItem(index: number) &#123;</span><br><span class="line">    <span class="keyword">this</span>.todos.splice(index, <span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建动画</p>
<ol>
<li>trigger 方法用于创建动画，指定动画名称</li>
<li>transition 方法用于指定动画的运动状态，出场动画或者入场动画，或者自定义状态动画。</li>
<li>style 方法用于设置元素在不同的状态下所对应的样式</li>
<li>animate 方法用于设置运动参数，比如动画运动时间，延迟事件，运动形式</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">@Component(&#123;</span><br><span class="line">  animations: [</span><br><span class="line">    <span class="comment">// 创建动画, 动画名称为 slide</span></span><br><span class="line">    trigger(<span class="string">"slide"</span>, [</span><br><span class="line">      <span class="comment">// 指定入场动画 注意: 字符串两边不能有空格, 箭头两边可以有也可以没有空格</span></span><br><span class="line">      <span class="comment">// void =&gt; * 可以替换为 :enter</span></span><br><span class="line">      transition(<span class="string">"void =&gt; *"</span>, [</span><br><span class="line">        <span class="comment">// 指定元素未入场前的样式</span></span><br><span class="line">        style(&#123; <span class="attr">opacity</span>: <span class="number">0</span>, <span class="attr">transform</span>: <span class="string">"translateY(40px)"</span> &#125;),</span><br><span class="line">        <span class="comment">// 指定元素入场后的样式及运动参数</span></span><br><span class="line">        animate(<span class="number">250</span>, style(&#123; <span class="attr">opacity</span>: <span class="number">1</span>, <span class="attr">transform</span>: <span class="string">"translateY(0)"</span> &#125;))</span><br><span class="line">      ]),</span><br><span class="line">      <span class="comment">// 指定出场动画</span></span><br><span class="line">      <span class="comment">// * =&gt; void 可以替换为 :leave</span></span><br><span class="line">      transition(<span class="string">"* =&gt; void"</span>, [</span><br><span class="line">        <span class="comment">// 指定元素出场后的样式和运动参数</span></span><br><span class="line">        animate(<span class="number">600</span>, style(&#123; <span class="attr">opacity</span>: <span class="number">0</span>, <span class="attr">transform</span>: <span class="string">"translateX(100%)"</span> &#125;))</span><br><span class="line">      ])</span><br><span class="line">    ])</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">li</span> @<span class="attr">slide</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="37-创建动画时的两个注意事项"><a href="#37-创建动画时的两个注意事项" class="headerlink" title="37.创建动画时的两个注意事项"></a>37.创建动画时的两个注意事项</h3><p>   注意：入场动画中可以不指定元素的默认状态，Angular 会将 void 状态清空作为默认状态</p>
   <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">   trigger(<span class="string">"slide"</span>, [</span><br><span class="line">     transition(<span class="string">":enter"</span>, [</span><br><span class="line">       style(&#123; <span class="attr">opacity</span>: <span class="number">0</span>, <span class="attr">transform</span>: <span class="string">"translateY(40px)"</span> &#125;),</span><br><span class="line">       animate(<span class="number">250</span>)</span><br><span class="line">     ]),</span><br><span class="line">     transition(<span class="string">":leave"</span>, [</span><br><span class="line">    		animate(<span class="number">600</span>, style(&#123; <span class="attr">opacity</span>: <span class="number">0</span>, <span class="attr">transform</span>: <span class="string">"translateX(100%)"</span> &#125;))</span><br><span class="line">     ])</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<p>   注意：要设置动画的运动参数，需要将 animate 方法的一个参数更改为字符串类型</p>
   <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 动画执行总时间 延迟时间 (可选) 运动形式 (可选)</span></span><br><span class="line">animate(<span class="string">"600ms 1s ease-out"</span>, style(&#123; <span class="attr">opacity</span>: <span class="number">0</span>, <span class="attr">transform</span>: <span class="string">"translateX(100%)"</span> &#125;))</span><br></pre></td></tr></table></figure>

<h3 id="38-定义关键帧动画"><a href="#38-定义关键帧动画" class="headerlink" title="38.定义关键帧动画"></a>38.定义关键帧动画</h3><p>关键帧动画使用 <code>keyframes</code> 方法定义</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">transition(<span class="string">":leave"</span>, [</span><br><span class="line">  animate(</span><br><span class="line">    <span class="number">600</span>,</span><br><span class="line">    keyframes([</span><br><span class="line">      style(&#123; <span class="attr">offset</span>: <span class="number">0.3</span>, <span class="attr">transform</span>: <span class="string">"translateX(-80px)"</span> &#125;),</span><br><span class="line">      style(&#123; <span class="attr">offset</span>: <span class="number">1</span>, <span class="attr">transform</span>: <span class="string">"translateX(100%)"</span> &#125;)</span><br><span class="line">    ])</span><br><span class="line">  )</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<h3 id="39-指定动画的回调函数"><a href="#39-指定动画的回调函数" class="headerlink" title="39.指定动画的回调函数"></a>39.指定动画的回调函数</h3><p>Angular 提供了和动画相关的两个回调函数，分别为动画开始执行时和动画执行完成后</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">li</span> @<span class="attr">slide</span> (@<span class="attr">slide.start</span>)=<span class="string">"start($event)"</span> (@<span class="attr">slide.done</span>)=<span class="string">"done($event)"</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; AnimationEvent &#125; <span class="keyword">from</span> <span class="string">"@angular/animations"</span></span><br><span class="line"></span><br><span class="line">start(event: AnimationEvent) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(event)</span><br><span class="line">&#125;</span><br><span class="line">done(event: AnimationEvent) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(event)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="40-创建可重用动画"><a href="#40-创建可重用动画" class="headerlink" title="40.创建可重用动画"></a>40.创建可重用动画</h3><ol>
<li><p>将动画的定义放置在单独的文件中，方便多组件调用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; animate, keyframes, style, transition, trigger &#125; <span class="keyword">from</span> <span class="string">"@angular/animations"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> slide = trigger(<span class="string">"slide"</span>, [</span><br><span class="line">  transition(<span class="string">":enter"</span>, [</span><br><span class="line">    style(&#123; <span class="attr">opacity</span>: <span class="number">0</span>, <span class="attr">transform</span>: <span class="string">"translateY(40px)"</span> &#125;),</span><br><span class="line">    animate(<span class="number">250</span>)</span><br><span class="line">  ]),</span><br><span class="line">  transition(<span class="string">":leave"</span>, [</span><br><span class="line">    animate(</span><br><span class="line">      <span class="number">600</span>,</span><br><span class="line">      keyframes([</span><br><span class="line">        style(&#123; <span class="attr">offset</span>: <span class="number">0.3</span>, <span class="attr">transform</span>: <span class="string">"translateX(-80px)"</span> &#125;),</span><br><span class="line">        style(&#123; <span class="attr">offset</span>: <span class="number">1</span>, <span class="attr">transform</span>: <span class="string">"translateX(100%)"</span> &#125;)</span><br><span class="line">      ])</span><br><span class="line">    )</span><br><span class="line">  ])</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; slide &#125; <span class="keyword">from</span> <span class="string">"./animations"</span></span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  animations: [slide]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>抽取具体的动画定义，方便多动画调用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;animate, animation, keyframes, style, transition, trigger, useAnimation&#125; <span class="keyword">from</span> <span class="string">"@angular/animations"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> slideInUp = animation([</span><br><span class="line">  style(&#123; <span class="attr">opacity</span>: <span class="number">0</span>, <span class="attr">transform</span>: <span class="string">"translateY(40px)"</span> &#125;),</span><br><span class="line">  animate(<span class="number">250</span>)</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> slideOutLeft = animation([</span><br><span class="line">  animate(</span><br><span class="line">    <span class="number">600</span>,</span><br><span class="line">    keyframes([</span><br><span class="line">      style(&#123; <span class="attr">offset</span>: <span class="number">0.3</span>, <span class="attr">transform</span>: <span class="string">"translateX(-80px)"</span> &#125;),</span><br><span class="line">      style(&#123; <span class="attr">offset</span>: <span class="number">1</span>, <span class="attr">transform</span>: <span class="string">"translateX(100%)"</span> &#125;)</span><br><span class="line">    ])</span><br><span class="line">  )</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> slide = trigger(<span class="string">"slide"</span>, [</span><br><span class="line">  transition(<span class="string">":enter"</span>, useAnimation(slideInUp)),</span><br><span class="line">  transition(<span class="string">":leave"</span>, useAnimation(slideOutLeft))</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
</li>
<li><p>调用动画时传递运动总时间，延迟时间，运动形式</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> slideInUp = animation(</span><br><span class="line">  [</span><br><span class="line">    style(&#123; <span class="attr">opacity</span>: <span class="number">0</span>, <span class="attr">transform</span>: <span class="string">"translateY(40px)"</span> &#125;),</span><br><span class="line">    animate(<span class="string">"&#123;&#123; duration &#125;&#125; &#123;&#123; delay &#125;&#125; &#123;&#123; easing &#125;&#125;"</span>)</span><br><span class="line">  ],</span><br><span class="line">  &#123;</span><br><span class="line">    params: &#123;</span><br><span class="line">      duration: <span class="string">"400ms"</span>,</span><br><span class="line">      delay: <span class="string">"0s"</span>,</span><br><span class="line">      easing: <span class="string">"ease-out"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">transition(<span class="string">":enter"</span>, useAnimation(slideInUp, &#123;<span class="attr">params</span>: &#123;<span class="attr">delay</span>: <span class="string">"1s"</span>&#125;&#125;))</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="41-query方法的使用"><a href="#41-query方法的使用" class="headerlink" title="41.query方法的使用"></a>41.query方法的使用</h3><p>Angular 中提供了 <code>query</code> 方法查找元素并为元素创建动画</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; slide &#125; <span class="keyword">from</span> <span class="string">"./animations"</span></span><br><span class="line"></span><br><span class="line">animations: [</span><br><span class="line">  slide,</span><br><span class="line">  trigger(<span class="string">"todoAnimations"</span>, [</span><br><span class="line">    transition(<span class="string">":enter"</span>, [</span><br><span class="line">      query(<span class="string">"h2"</span>, [</span><br><span class="line">        style(&#123; <span class="attr">transform</span>: <span class="string">"translateY(-30px)"</span> &#125;),</span><br><span class="line">        animate(<span class="number">300</span>)</span><br><span class="line">      ]),</span><br><span class="line">      <span class="comment">// 查询子级动画 使其执行</span></span><br><span class="line">      query(<span class="string">"@slide"</span>, animateChild())</span><br><span class="line">    ])</span><br><span class="line">  ])</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span> @<span class="attr">todoAnimations</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Todos<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"list-group"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span></span></span><br><span class="line"><span class="tag">      @<span class="attr">slide</span></span></span><br><span class="line"><span class="tag">      (<span class="attr">click</span>)=<span class="string">"removeItem(i)"</span></span></span><br><span class="line"><span class="tag">      *<span class="attr">ngFor</span>=<span class="string">"let item of todos; let i = index"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"list-group-item"</span></span></span><br><span class="line"><span class="tag">    &gt;</span></span><br><span class="line">      &#123;&#123; item &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="42-group方法的使用"><a href="#42-group方法的使用" class="headerlink" title="42.group方法的使用"></a>42.group方法的使用</h3><p>默认情况下，父级动画和子级动画按照顺序执行，先执行父级动画，再执行子级动画，可以使用  <code>group</code> 方法让其并行</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">trigger(<span class="string">"todoAnimations"</span>, [</span><br><span class="line">  transition(<span class="string">":enter"</span>, [</span><br><span class="line">    group([</span><br><span class="line">      query(<span class="string">"h2"</span>, [</span><br><span class="line">        style(&#123; <span class="attr">transform</span>: <span class="string">"translateY(-30px)"</span> &#125;),</span><br><span class="line">        animate(<span class="number">300</span>)</span><br><span class="line">      ]),</span><br><span class="line">      query(<span class="string">"@slide"</span>, animateChild())</span><br><span class="line">    ])</span><br><span class="line">  ])</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
<h3 id="43-使用stagger方法实现交错动画"><a href="#43-使用stagger方法实现交错动画" class="headerlink" title="43.使用stagger方法实现交错动画"></a>43.使用stagger方法实现交错动画</h3><p>Angular 提供了 stagger 方法，在多个元素同时执行同一个动画时，让每个元素动画的执行依次延迟。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">transition(<span class="string">":enter"</span>, [</span><br><span class="line">  group([</span><br><span class="line">    query(<span class="string">"h2"</span>, [</span><br><span class="line">      style(&#123; <span class="attr">transform</span>: <span class="string">"translateY(-30px)"</span> &#125;),</span><br><span class="line">      animate(<span class="number">300</span>)</span><br><span class="line">    ]),</span><br><span class="line">    query(<span class="string">"@slide"</span>, stagger(<span class="number">200</span>, animateChild()))</span><br><span class="line">  ])</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<p>注意：stagger 方法只能在 query 方法内部使用</p>
<h3 id="44-创建自定义状态动画"><a href="#44-创建自定义状态动画" class="headerlink" title="44.创建自定义状态动画"></a>44.创建自定义状态动画</h3><p>Angular 提供了 <code>state</code> 方法用于定义状态。</p>
<ol>
<li><p>默认代码解析</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel panel-default"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-heading"</span> (<span class="attr">click</span>)=<span class="string">"toggle()"</span>&gt;</span></span><br><span class="line">      一套框架, 多种平台, 移动端 &amp; 桌面端</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">        使用简单的声明式模板，快速实现各种特性。使用自定义组件和大量现有组件，扩展模板语言。在几乎所有的</span><br><span class="line">        IDE 中获得针对 Angular</span><br><span class="line">        的即时帮助和反馈。所有这一切，都是为了帮助你编写漂亮的应用，而不是绞尽脑汁的让代码“能用”。</span><br><span class="line">      <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">        从原型到全球部署，Angular 都能带给你支撑 Google</span><br><span class="line">        大型应用的那些高延展性基础设施与技术。</span><br><span class="line">      <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">        通过 Web Worker 和服务端渲染，达到在如今(以及未来）的 Web</span><br><span class="line">        平台上所能达到的最高速度。 Angular 让你有效掌控可伸缩性。基于</span><br><span class="line">        RxJS、Immutable.js 和其它推送模型，能适应海量数据需求。</span><br><span class="line">      <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">        学会用 Angular</span><br><span class="line">        构建应用，然后把这些代码和能力复用在多种多种不同平台的应用上 ——</span><br><span class="line">        Web、移动 Web、移动应用、原生应用和桌面原生应用。</span><br><span class="line">      <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">  <span class="selector-class">.container</span> &#123;</span></span><br><span class="line">    margin-top: 100px;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="css">  <span class="selector-class">.panel-heading</span> &#123;</span></span><br><span class="line">    cursor: pointer;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component &#125; <span class="keyword">from</span> <span class="string">"@angular/core"</span></span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">"app-root"</span>,</span><br><span class="line">  templateUrl: <span class="string">"./app.component.html"</span>,</span><br><span class="line">  styles: []</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  isExpended: boolean = <span class="literal">false</span></span><br><span class="line">  toggle() &#123;</span><br><span class="line">    <span class="keyword">this</span>.isExpended = !<span class="keyword">this</span>.isExpended</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建动画</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">trigger(<span class="string">"expandCollapse"</span>, [</span><br><span class="line">  <span class="comment">// 使用 state 方法定义折叠状态元素对应的样式</span></span><br><span class="line">  state(</span><br><span class="line">    <span class="string">"collapsed"</span>,</span><br><span class="line">    style(&#123;</span><br><span class="line">      height: <span class="number">0</span>,</span><br><span class="line">      overflow: <span class="string">"hidden"</span>,</span><br><span class="line">      paddingTop: <span class="number">0</span>,</span><br><span class="line">      paddingBottom: <span class="number">0</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ),</span><br><span class="line">  <span class="comment">// 使用 state 方法定义展开状态元素对应的样式</span></span><br><span class="line">  state(<span class="string">"expanded"</span>, style(&#123; <span class="attr">height</span>: <span class="string">"*"</span>, <span class="attr">overflow</span>: <span class="string">"auto"</span> &#125;)),</span><br><span class="line">  <span class="comment">// 定义展开动画</span></span><br><span class="line">  transition(<span class="string">"collapsed =&gt; expanded"</span>, animate(<span class="string">"400ms ease-out"</span>)),</span><br><span class="line">  <span class="comment">// 定义折叠动画</span></span><br><span class="line">  transition(<span class="string">"expanded =&gt; collapsed"</span>, animate(<span class="string">"400ms ease-in"</span>))</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span> [@<span class="attr">expandCollapse</span>]=<span class="string">"isExpended ? 'expanded' : 'collapsed'"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="45-实现路由动画"><a href="#45-实现路由动画" class="headerlink" title="45.实现路由动画"></a>45.实现路由动画</h3><ol>
<li><p>为路由添加状态标识，此标识即为路由执行动画时的自定义状态</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> routes: Routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">""</span>,</span><br><span class="line">    component: HomeComponent,</span><br><span class="line">    pathMatch: <span class="string">"full"</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"one"</span> </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"about"</span>,</span><br><span class="line">    component: AboutComponent,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"two"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"news"</span>,</span><br><span class="line">    component: NewsComponent,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"three"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过路由插座对象获取路由状态标识，并将标识传递给动画的调用者，让动画执行当前要执行的状态是什么</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"routerContainer"</span> [@<span class="attr">routerAnimations</span>]=<span class="string">"prepareRoute(outlet)"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">router-outlet</span> #<span class="attr">outlet</span>=<span class="string">"outlet"</span>&gt;</span><span class="tag">&lt;/<span class="name">router-outlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; RouterOutlet &#125; <span class="keyword">from</span> <span class="string">"@angular/router"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  prepareRoute(outlet: RouterOutlet) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      outlet &amp;&amp;</span><br><span class="line">      outlet.activatedRouteData &amp;&amp;</span><br><span class="line">      outlet.activatedRouteData.animation</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>将 routerContainer 设置为相对定位，将它的直接一级子元素设置成绝对定位</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* styles.css */</span></span><br><span class="line"><span class="selector-class">.routerContainer</span> &#123;</span><br><span class="line">  <span class="attribute">position</span>: relative;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.routerContainer</span> &gt; * &#123;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建动画</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">trigger(<span class="string">"routerAnimations"</span>, [</span><br><span class="line">  transition(<span class="string">"one =&gt; two, one =&gt; three, two =&gt; three"</span>, [</span><br><span class="line">    query(<span class="string">":enter"</span>, style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(100%)"</span>, <span class="attr">opacity</span>: <span class="number">0</span> &#125;)),</span><br><span class="line">    group([</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":enter"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-in"</span>,</span><br><span class="line">          style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(0)"</span>, <span class="attr">opacity</span>: <span class="number">1</span> &#125;)</span><br><span class="line">        )</span><br><span class="line">      ),</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":leave"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-out"</span>,</span><br><span class="line">          style(&#123;</span><br><span class="line">            transform: <span class="string">"translateX(-100%)"</span>,</span><br><span class="line">            opacity: <span class="number">0</span></span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    ])</span><br><span class="line">  ]),</span><br><span class="line">  transition(<span class="string">"three =&gt; two, three =&gt; one, two =&gt; one"</span>, [</span><br><span class="line">    query(</span><br><span class="line">      <span class="string">":enter"</span>,</span><br><span class="line">      style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(-100%)"</span>, <span class="attr">opacity</span>: <span class="number">0</span> &#125;)</span><br><span class="line">    ),</span><br><span class="line">    group([</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":enter"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-in"</span>,</span><br><span class="line">          style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(0)"</span>, <span class="attr">opacity</span>: <span class="number">1</span> &#125;)</span><br><span class="line">        )</span><br><span class="line">      ),</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":leave"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-out"</span>,</span><br><span class="line">          style(&#123;</span><br><span class="line">            transform: <span class="string">"translateX(100%)"</span>,</span><br><span class="line">            opacity: <span class="number">0</span></span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    ])</span><br><span class="line">  ])</span><br><span class="line">])</span><br><span class="line"><span class="string">``</span><span class="string">`     .container &#123;</span></span><br><span class="line"><span class="string">    margin-top: 100px;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  .panel-heading &#123;</span></span><br><span class="line"><span class="string">    cursor: pointer;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&lt;/style&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component &#125; <span class="keyword">from</span> <span class="string">"@angular/core"</span></span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">"app-root"</span>,</span><br><span class="line">  templateUrl: <span class="string">"./app.component.html"</span>,</span><br><span class="line">  styles: []</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  isExpended: boolean = <span class="literal">false</span></span><br><span class="line">  toggle() &#123;</span><br><span class="line">    <span class="keyword">this</span>.isExpended = !<span class="keyword">this</span>.isExpended</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建动画</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">trigger(<span class="string">"expandCollapse"</span>, [</span><br><span class="line">  <span class="comment">// 使用 state 方法定义折叠状态元素对应的样式</span></span><br><span class="line">  state(</span><br><span class="line">    <span class="string">"collapsed"</span>,</span><br><span class="line">    style(&#123;</span><br><span class="line">      height: <span class="number">0</span>,</span><br><span class="line">      overflow: <span class="string">"hidden"</span>,</span><br><span class="line">      paddingTop: <span class="number">0</span>,</span><br><span class="line">      paddingBottom: <span class="number">0</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ),</span><br><span class="line">  <span class="comment">// 使用 state 方法定义展开状态元素对应的样式</span></span><br><span class="line">  state(<span class="string">"expanded"</span>, style(&#123; <span class="attr">height</span>: <span class="string">"*"</span>, <span class="attr">overflow</span>: <span class="string">"auto"</span> &#125;)),</span><br><span class="line">  <span class="comment">// 定义展开动画</span></span><br><span class="line">  transition(<span class="string">"collapsed =&gt; expanded"</span>, animate(<span class="string">"400ms ease-out"</span>)),</span><br><span class="line">  <span class="comment">// 定义折叠动画</span></span><br><span class="line">  transition(<span class="string">"expanded =&gt; collapsed"</span>, animate(<span class="string">"400ms ease-in"</span>))</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span> [@<span class="attr">expandCollapse</span>]=<span class="string">"isExpended ? 'expanded' : 'collapsed'"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="45-实现路由动画-1"><a href="#45-实现路由动画-1" class="headerlink" title="45.实现路由动画"></a>45.实现路由动画</h3><ol>
<li><p>为路由添加状态标识，此标识即为路由执行动画时的自定义状态</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> routes: Routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">""</span>,</span><br><span class="line">    component: HomeComponent,</span><br><span class="line">    pathMatch: <span class="string">"full"</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"one"</span> </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"about"</span>,</span><br><span class="line">    component: AboutComponent,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"two"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"news"</span>,</span><br><span class="line">    component: NewsComponent,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"three"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过路由插座对象获取路由状态标识，并将标识传递给动画的调用者，让动画执行当前要执行的状态是什么</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"routerContainer"</span> [@<span class="attr">routerAnimations</span>]=<span class="string">"prepareRoute(outlet)"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">router-outlet</span> #<span class="attr">outlet</span>=<span class="string">"outlet"</span>&gt;</span><span class="tag">&lt;/<span class="name">router-outlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; RouterOutlet &#125; <span class="keyword">from</span> <span class="string">"@angular/router"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  prepareRoute(outlet: RouterOutlet) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      outlet &amp;&amp;</span><br><span class="line">      outlet.activatedRouteData &amp;&amp;</span><br><span class="line">      outlet.activatedRouteData.animation</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>将 routerContainer 设置为相对定位，将它的直接一级子元素设置成绝对定位</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* styles.css */</span></span><br><span class="line"><span class="selector-class">.routerContainer</span> &#123;</span><br><span class="line">  <span class="attribute">position</span>: relative;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.routerContainer</span> &gt; * &#123;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建动画</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">trigger(<span class="string">"routerAnimations"</span>, [</span><br><span class="line">  transition(<span class="string">"one =&gt; two, one =&gt; three, two =&gt; three"</span>, [</span><br><span class="line">    query(<span class="string">":enter"</span>, style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(100%)"</span>, <span class="attr">opacity</span>: <span class="number">0</span> &#125;)),</span><br><span class="line">    group([</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":enter"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-in"</span>,</span><br><span class="line">          style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(0)"</span>, <span class="attr">opacity</span>: <span class="number">1</span> &#125;)</span><br><span class="line">        )</span><br><span class="line">      ),</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":leave"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-out"</span>,</span><br><span class="line">          style(&#123;</span><br><span class="line">            transform: <span class="string">"translateX(-100%)"</span>,</span><br><span class="line">            opacity: <span class="number">0</span></span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    ])</span><br><span class="line">  ]),</span><br><span class="line">  transition(<span class="string">"three =&gt; two, three =&gt; one, two =&gt; one"</span>, [</span><br><span class="line">    query(</span><br><span class="line">      <span class="string">":enter"</span>,</span><br><span class="line">      style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(-100%)"</span>, <span class="attr">opacity</span>: <span class="number">0</span> &#125;)</span><br><span class="line">    ),</span><br><span class="line">    group([</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":enter"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-in"</span>,</span><br><span class="line">          style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(0)"</span>, <span class="attr">opacity</span>: <span class="number">1</span> &#125;)</span><br><span class="line">        )</span><br><span class="line">      ),</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":leave"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-out"</span>,</span><br><span class="line">          style(&#123;</span><br><span class="line">            transform: <span class="string">"translateX(100%)"</span>,</span><br><span class="line">            opacity: <span class="number">0</span></span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    ])</span><br><span class="line">  ])</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
<p>  .container {</p>
<pre><code>margin-top: 100px;</code></pre><p>  }<br>  .panel-heading {</p>
<pre><code>cursor: pointer;</code></pre><p>  }<br></style></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#96;&#96;&#96;javascript</span><br><span class="line">import &#123; Component &#125; from &quot;@angular&#x2F;core&quot;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: &quot;app-root&quot;,</span><br><span class="line">  templateUrl: &quot;.&#x2F;app.component.html&quot;,</span><br><span class="line">  styles: []</span><br><span class="line">&#125;)</span><br><span class="line">export class AppComponent &#123;</span><br><span class="line">  isExpended: boolean &#x3D; false</span><br><span class="line">  toggle() &#123;</span><br><span class="line">    this.isExpended &#x3D; !this.isExpended</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建动画</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">trigger(<span class="string">"expandCollapse"</span>, [</span><br><span class="line">  <span class="comment">// 使用 state 方法定义折叠状态元素对应的样式</span></span><br><span class="line">  state(</span><br><span class="line">    <span class="string">"collapsed"</span>,</span><br><span class="line">    style(&#123;</span><br><span class="line">      height: <span class="number">0</span>,</span><br><span class="line">      overflow: <span class="string">"hidden"</span>,</span><br><span class="line">      paddingTop: <span class="number">0</span>,</span><br><span class="line">      paddingBottom: <span class="number">0</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ),</span><br><span class="line">  <span class="comment">// 使用 state 方法定义展开状态元素对应的样式</span></span><br><span class="line">  state(<span class="string">"expanded"</span>, style(&#123; <span class="attr">height</span>: <span class="string">"*"</span>, <span class="attr">overflow</span>: <span class="string">"auto"</span> &#125;)),</span><br><span class="line">  <span class="comment">// 定义展开动画</span></span><br><span class="line">  transition(<span class="string">"collapsed =&gt; expanded"</span>, animate(<span class="string">"400ms ease-out"</span>)),</span><br><span class="line">  <span class="comment">// 定义折叠动画</span></span><br><span class="line">  transition(<span class="string">"expanded =&gt; collapsed"</span>, animate(<span class="string">"400ms ease-in"</span>))</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span> [@<span class="attr">expandCollapse</span>]=<span class="string">"isExpended ? 'expanded' : 'collapsed'"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="45-实现路由动画-2"><a href="#45-实现路由动画-2" class="headerlink" title="45.实现路由动画"></a>45.实现路由动画</h3><ol>
<li><p>为路由添加状态标识，此标识即为路由执行动画时的自定义状态</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> routes: Routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">""</span>,</span><br><span class="line">    component: HomeComponent,</span><br><span class="line">    pathMatch: <span class="string">"full"</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"one"</span> </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"about"</span>,</span><br><span class="line">    component: AboutComponent,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"two"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"news"</span>,</span><br><span class="line">    component: NewsComponent,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"three"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过路由插座对象获取路由状态标识，并将标识传递给动画的调用者，让动画执行当前要执行的状态是什么</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"routerContainer"</span> [@<span class="attr">routerAnimations</span>]=<span class="string">"prepareRoute(outlet)"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">router-outlet</span> #<span class="attr">outlet</span>=<span class="string">"outlet"</span>&gt;</span><span class="tag">&lt;/<span class="name">router-outlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; RouterOutlet &#125; <span class="keyword">from</span> <span class="string">"@angular/router"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  prepareRoute(outlet: RouterOutlet) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      outlet &amp;&amp;</span><br><span class="line">      outlet.activatedRouteData &amp;&amp;</span><br><span class="line">      outlet.activatedRouteData.animation</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>将 routerContainer 设置为相对定位，将它的直接一级子元素设置成绝对定位</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* styles.css */</span></span><br><span class="line"><span class="selector-class">.routerContainer</span> &#123;</span><br><span class="line">  <span class="attribute">position</span>: relative;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.routerContainer</span> &gt; * &#123;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建动画</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">trigger(<span class="string">"routerAnimations"</span>, [</span><br><span class="line">  transition(<span class="string">"one =&gt; two, one =&gt; three, two =&gt; three"</span>, [</span><br><span class="line">    query(<span class="string">":enter"</span>, style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(100%)"</span>, <span class="attr">opacity</span>: <span class="number">0</span> &#125;)),</span><br><span class="line">    group([</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":enter"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-in"</span>,</span><br><span class="line">          style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(0)"</span>, <span class="attr">opacity</span>: <span class="number">1</span> &#125;)</span><br><span class="line">        )</span><br><span class="line">      ),</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":leave"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-out"</span>,</span><br><span class="line">          style(&#123;</span><br><span class="line">            transform: <span class="string">"translateX(-100%)"</span>,</span><br><span class="line">            opacity: <span class="number">0</span></span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    ])</span><br><span class="line">  ]),</span><br><span class="line">  transition(<span class="string">"three =&gt; two, three =&gt; one, two =&gt; one"</span>, [</span><br><span class="line">    query(</span><br><span class="line">      <span class="string">":enter"</span>,</span><br><span class="line">      style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(-100%)"</span>, <span class="attr">opacity</span>: <span class="number">0</span> &#125;)</span><br><span class="line">    ),</span><br><span class="line">    group([</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":enter"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-in"</span>,</span><br><span class="line">          style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(0)"</span>, <span class="attr">opacity</span>: <span class="number">1</span> &#125;)</span><br><span class="line">        )</span><br><span class="line">      ),</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":leave"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-out"</span>,</span><br><span class="line">          style(&#123;</span><br><span class="line">            transform: <span class="string">"translateX(100%)"</span>,</span><br><span class="line">            opacity: <span class="number">0</span></span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    ])</span><br><span class="line">  ])</span><br><span class="line">])</span><br><span class="line"><span class="string">``</span><span class="string">`     .container &#123;</span></span><br><span class="line"><span class="string">    margin-top: 100px;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  .panel-heading &#123;</span></span><br><span class="line"><span class="string">    cursor: pointer;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&lt;/style&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component &#125; <span class="keyword">from</span> <span class="string">"@angular/core"</span></span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">"app-root"</span>,</span><br><span class="line">  templateUrl: <span class="string">"./app.component.html"</span>,</span><br><span class="line">  styles: []</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  isExpended: boolean = <span class="literal">false</span></span><br><span class="line">  toggle() &#123;</span><br><span class="line">    <span class="keyword">this</span>.isExpended = !<span class="keyword">this</span>.isExpended</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建动画</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">trigger(<span class="string">"expandCollapse"</span>, [</span><br><span class="line">  <span class="comment">// 使用 state 方法定义折叠状态元素对应的样式</span></span><br><span class="line">  state(</span><br><span class="line">    <span class="string">"collapsed"</span>,</span><br><span class="line">    style(&#123;</span><br><span class="line">      height: <span class="number">0</span>,</span><br><span class="line">      overflow: <span class="string">"hidden"</span>,</span><br><span class="line">      paddingTop: <span class="number">0</span>,</span><br><span class="line">      paddingBottom: <span class="number">0</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ),</span><br><span class="line">  <span class="comment">// 使用 state 方法定义展开状态元素对应的样式</span></span><br><span class="line">  state(<span class="string">"expanded"</span>, style(&#123; <span class="attr">height</span>: <span class="string">"*"</span>, <span class="attr">overflow</span>: <span class="string">"auto"</span> &#125;)),</span><br><span class="line">  <span class="comment">// 定义展开动画</span></span><br><span class="line">  transition(<span class="string">"collapsed =&gt; expanded"</span>, animate(<span class="string">"400ms ease-out"</span>)),</span><br><span class="line">  <span class="comment">// 定义折叠动画</span></span><br><span class="line">  transition(<span class="string">"expanded =&gt; collapsed"</span>, animate(<span class="string">"400ms ease-in"</span>))</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span> [@<span class="attr">expandCollapse</span>]=<span class="string">"isExpended ? 'expanded' : 'collapsed'"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="45-实现路由动画-3"><a href="#45-实现路由动画-3" class="headerlink" title="45.实现路由动画"></a>45.实现路由动画</h3><ol>
<li><p>为路由添加状态标识，此标识即为路由执行动画时的自定义状态</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> routes: Routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">""</span>,</span><br><span class="line">    component: HomeComponent,</span><br><span class="line">    pathMatch: <span class="string">"full"</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"one"</span> </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"about"</span>,</span><br><span class="line">    component: AboutComponent,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"two"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"news"</span>,</span><br><span class="line">    component: NewsComponent,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"three"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过路由插座对象获取路由状态标识，并将标识传递给动画的调用者，让动画执行当前要执行的状态是什么</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"routerContainer"</span> [@<span class="attr">routerAnimations</span>]=<span class="string">"prepareRoute(outlet)"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">router-outlet</span> #<span class="attr">outlet</span>=<span class="string">"outlet"</span>&gt;</span><span class="tag">&lt;/<span class="name">router-outlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; RouterOutlet &#125; <span class="keyword">from</span> <span class="string">"@angular/router"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  prepareRoute(outlet: RouterOutlet) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      outlet &amp;&amp;</span><br><span class="line">      outlet.activatedRouteData &amp;&amp;</span><br><span class="line">      outlet.activatedRouteData.animation</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>将 routerContainer 设置为相对定位，将它的直接一级子元素设置成绝对定位</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* styles.css */</span></span><br><span class="line"><span class="selector-class">.routerContainer</span> &#123;</span><br><span class="line">  <span class="attribute">position</span>: relative;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.routerContainer</span> &gt; * &#123;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建动画</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">trigger(<span class="string">"routerAnimations"</span>, [</span><br><span class="line">  transition(<span class="string">"one =&gt; two, one =&gt; three, two =&gt; three"</span>, [</span><br><span class="line">    query(<span class="string">":enter"</span>, style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(100%)"</span>, <span class="attr">opacity</span>: <span class="number">0</span> &#125;)),</span><br><span class="line">    group([</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":enter"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-in"</span>,</span><br><span class="line">          style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(0)"</span>, <span class="attr">opacity</span>: <span class="number">1</span> &#125;)</span><br><span class="line">        )</span><br><span class="line">      ),</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":leave"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-out"</span>,</span><br><span class="line">          style(&#123;</span><br><span class="line">            transform: <span class="string">"translateX(-100%)"</span>,</span><br><span class="line">            opacity: <span class="number">0</span></span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    ])</span><br><span class="line">  ]),</span><br><span class="line">  transition(<span class="string">"three =&gt; two, three =&gt; one, two =&gt; one"</span>, [</span><br><span class="line">    query(</span><br><span class="line">      <span class="string">":enter"</span>,</span><br><span class="line">      style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(-100%)"</span>, <span class="attr">opacity</span>: <span class="number">0</span> &#125;)</span><br><span class="line">    ),</span><br><span class="line">    group([</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":enter"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-in"</span>,</span><br><span class="line">          style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(0)"</span>, <span class="attr">opacity</span>: <span class="number">1</span> &#125;)</span><br><span class="line">        )</span><br><span class="line">      ),</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":leave"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-out"</span>,</span><br><span class="line">          style(&#123;</span><br><span class="line">            transform: <span class="string">"translateX(100%)"</span>,</span><br><span class="line">            opacity: <span class="number">0</span></span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    ])</span><br><span class="line">  ])</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<p>  .container {</p>
<pre><code>margin-top: 100px;</code></pre><p>  }<br>  .panel-heading {</p>
<pre><code>cursor: pointer;</code></pre><p>  }<br></style></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#96;&#96;&#96;javascript</span><br><span class="line">import &#123; Component &#125; from &quot;@angular&#x2F;core&quot;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: &quot;app-root&quot;,</span><br><span class="line">  templateUrl: &quot;.&#x2F;app.component.html&quot;,</span><br><span class="line">  styles: []</span><br><span class="line">&#125;)</span><br><span class="line">export class AppComponent &#123;</span><br><span class="line">  isExpended: boolean &#x3D; false</span><br><span class="line">  toggle() &#123;</span><br><span class="line">    this.isExpended &#x3D; !this.isExpended</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建动画</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">trigger(<span class="string">"expandCollapse"</span>, [</span><br><span class="line">  <span class="comment">// 使用 state 方法定义折叠状态元素对应的样式</span></span><br><span class="line">  state(</span><br><span class="line">    <span class="string">"collapsed"</span>,</span><br><span class="line">    style(&#123;</span><br><span class="line">      height: <span class="number">0</span>,</span><br><span class="line">      overflow: <span class="string">"hidden"</span>,</span><br><span class="line">      paddingTop: <span class="number">0</span>,</span><br><span class="line">      paddingBottom: <span class="number">0</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ),</span><br><span class="line">  <span class="comment">// 使用 state 方法定义展开状态元素对应的样式</span></span><br><span class="line">  state(<span class="string">"expanded"</span>, style(&#123; <span class="attr">height</span>: <span class="string">"*"</span>, <span class="attr">overflow</span>: <span class="string">"auto"</span> &#125;)),</span><br><span class="line">  <span class="comment">// 定义展开动画</span></span><br><span class="line">  transition(<span class="string">"collapsed =&gt; expanded"</span>, animate(<span class="string">"400ms ease-out"</span>)),</span><br><span class="line">  <span class="comment">// 定义折叠动画</span></span><br><span class="line">  transition(<span class="string">"expanded =&gt; collapsed"</span>, animate(<span class="string">"400ms ease-in"</span>))</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span> [@<span class="attr">expandCollapse</span>]=<span class="string">"isExpended ? 'expanded' : 'collapsed'"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="45-实现路由动画-4"><a href="#45-实现路由动画-4" class="headerlink" title="45.实现路由动画"></a>45.实现路由动画</h3><ol>
<li><p>为路由添加状态标识，此标识即为路由执行动画时的自定义状态</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> routes: Routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">""</span>,</span><br><span class="line">    component: HomeComponent,</span><br><span class="line">    pathMatch: <span class="string">"full"</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"one"</span> </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"about"</span>,</span><br><span class="line">    component: AboutComponent,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"two"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"news"</span>,</span><br><span class="line">    component: NewsComponent,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"three"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过路由插座对象获取路由状态标识，并将标识传递给动画的调用者，让动画执行当前要执行的状态是什么</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"routerContainer"</span> [@<span class="attr">routerAnimations</span>]=<span class="string">"prepareRoute(outlet)"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">router-outlet</span> #<span class="attr">outlet</span>=<span class="string">"outlet"</span>&gt;</span><span class="tag">&lt;/<span class="name">router-outlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; RouterOutlet &#125; <span class="keyword">from</span> <span class="string">"@angular/router"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  prepareRoute(outlet: RouterOutlet) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      outlet &amp;&amp;</span><br><span class="line">      outlet.activatedRouteData &amp;&amp;</span><br><span class="line">      outlet.activatedRouteData.animation</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>将 routerContainer 设置为相对定位，将它的直接一级子元素设置成绝对定位</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* styles.css */</span></span><br><span class="line"><span class="selector-class">.routerContainer</span> &#123;</span><br><span class="line">  <span class="attribute">position</span>: relative;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.routerContainer</span> &gt; * &#123;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建动画</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">trigger(<span class="string">"routerAnimations"</span>, [</span><br><span class="line">  transition(<span class="string">"one =&gt; two, one =&gt; three, two =&gt; three"</span>, [</span><br><span class="line">    query(<span class="string">":enter"</span>, style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(100%)"</span>, <span class="attr">opacity</span>: <span class="number">0</span> &#125;)),</span><br><span class="line">    group([</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":enter"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-in"</span>,</span><br><span class="line">          style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(0)"</span>, <span class="attr">opacity</span>: <span class="number">1</span> &#125;)</span><br><span class="line">        )</span><br><span class="line">      ),</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":leave"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-out"</span>,</span><br><span class="line">          style(&#123;</span><br><span class="line">            transform: <span class="string">"translateX(-100%)"</span>,</span><br><span class="line">            opacity: <span class="number">0</span></span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    ])</span><br><span class="line">  ]),</span><br><span class="line">  transition(<span class="string">"three =&gt; two, three =&gt; one, two =&gt; one"</span>, [</span><br><span class="line">    query(</span><br><span class="line">      <span class="string">":enter"</span>,</span><br><span class="line">      style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(-100%)"</span>, <span class="attr">opacity</span>: <span class="number">0</span> &#125;)</span><br><span class="line">    ),</span><br><span class="line">    group([</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":enter"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-in"</span>,</span><br><span class="line">          style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(0)"</span>, <span class="attr">opacity</span>: <span class="number">1</span> &#125;)</span><br><span class="line">        )</span><br><span class="line">      ),</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":leave"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-out"</span>,</span><br><span class="line">          style(&#123;</span><br><span class="line">            transform: <span class="string">"translateX(100%)"</span>,</span><br><span class="line">            opacity: <span class="number">0</span></span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    ])</span><br><span class="line">  ])</span><br><span class="line">])</span><br><span class="line"><span class="string">``</span><span class="string">`     .container &#123;</span></span><br><span class="line"><span class="string">    margin-top: 100px;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  .panel-heading &#123;</span></span><br><span class="line"><span class="string">    cursor: pointer;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&lt;/style&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component &#125; <span class="keyword">from</span> <span class="string">"@angular/core"</span></span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">"app-root"</span>,</span><br><span class="line">  templateUrl: <span class="string">"./app.component.html"</span>,</span><br><span class="line">  styles: []</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  isExpended: boolean = <span class="literal">false</span></span><br><span class="line">  toggle() &#123;</span><br><span class="line">    <span class="keyword">this</span>.isExpended = !<span class="keyword">this</span>.isExpended</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建动画</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">trigger(<span class="string">"expandCollapse"</span>, [</span><br><span class="line">  <span class="comment">// 使用 state 方法定义折叠状态元素对应的样式</span></span><br><span class="line">  state(</span><br><span class="line">    <span class="string">"collapsed"</span>,</span><br><span class="line">    style(&#123;</span><br><span class="line">      height: <span class="number">0</span>,</span><br><span class="line">      overflow: <span class="string">"hidden"</span>,</span><br><span class="line">      paddingTop: <span class="number">0</span>,</span><br><span class="line">      paddingBottom: <span class="number">0</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ),</span><br><span class="line">  <span class="comment">// 使用 state 方法定义展开状态元素对应的样式</span></span><br><span class="line">  state(<span class="string">"expanded"</span>, style(&#123; <span class="attr">height</span>: <span class="string">"*"</span>, <span class="attr">overflow</span>: <span class="string">"auto"</span> &#125;)),</span><br><span class="line">  <span class="comment">// 定义展开动画</span></span><br><span class="line">  transition(<span class="string">"collapsed =&gt; expanded"</span>, animate(<span class="string">"400ms ease-out"</span>)),</span><br><span class="line">  <span class="comment">// 定义折叠动画</span></span><br><span class="line">  transition(<span class="string">"expanded =&gt; collapsed"</span>, animate(<span class="string">"400ms ease-in"</span>))</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span> [@<span class="attr">expandCollapse</span>]=<span class="string">"isExpended ? 'expanded' : 'collapsed'"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="45-实现路由动画-5"><a href="#45-实现路由动画-5" class="headerlink" title="45.实现路由动画"></a>45.实现路由动画</h3><ol>
<li><p>为路由添加状态标识，此标识即为路由执行动画时的自定义状态</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> routes: Routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">""</span>,</span><br><span class="line">    component: HomeComponent,</span><br><span class="line">    pathMatch: <span class="string">"full"</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"one"</span> </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"about"</span>,</span><br><span class="line">    component: AboutComponent,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"two"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"news"</span>,</span><br><span class="line">    component: NewsComponent,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"three"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过路由插座对象获取路由状态标识，并将标识传递给动画的调用者，让动画执行当前要执行的状态是什么</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"routerContainer"</span> [@<span class="attr">routerAnimations</span>]=<span class="string">"prepareRoute(outlet)"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">router-outlet</span> #<span class="attr">outlet</span>=<span class="string">"outlet"</span>&gt;</span><span class="tag">&lt;/<span class="name">router-outlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; RouterOutlet &#125; <span class="keyword">from</span> <span class="string">"@angular/router"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  prepareRoute(outlet: RouterOutlet) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      outlet &amp;&amp;</span><br><span class="line">      outlet.activatedRouteData &amp;&amp;</span><br><span class="line">      outlet.activatedRouteData.animation</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>将 routerContainer 设置为相对定位，将它的直接一级子元素设置成绝对定位</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* styles.css */</span></span><br><span class="line"><span class="selector-class">.routerContainer</span> &#123;</span><br><span class="line">  <span class="attribute">position</span>: relative;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.routerContainer</span> &gt; * &#123;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建动画</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">trigger(<span class="string">"routerAnimations"</span>, [</span><br><span class="line">  transition(<span class="string">"one =&gt; two, one =&gt; three, two =&gt; three"</span>, [</span><br><span class="line">    query(<span class="string">":enter"</span>, style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(100%)"</span>, <span class="attr">opacity</span>: <span class="number">0</span> &#125;)),</span><br><span class="line">    group([</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":enter"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-in"</span>,</span><br><span class="line">          style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(0)"</span>, <span class="attr">opacity</span>: <span class="number">1</span> &#125;)</span><br><span class="line">        )</span><br><span class="line">      ),</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":leave"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-out"</span>,</span><br><span class="line">          style(&#123;</span><br><span class="line">            transform: <span class="string">"translateX(-100%)"</span>,</span><br><span class="line">            opacity: <span class="number">0</span></span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    ])</span><br><span class="line">  ]),</span><br><span class="line">  transition(<span class="string">"three =&gt; two, three =&gt; one, two =&gt; one"</span>, [</span><br><span class="line">    query(</span><br><span class="line">      <span class="string">":enter"</span>,</span><br><span class="line">      style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(-100%)"</span>, <span class="attr">opacity</span>: <span class="number">0</span> &#125;)</span><br><span class="line">    ),</span><br><span class="line">    group([</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":enter"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-in"</span>,</span><br><span class="line">          style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(0)"</span>, <span class="attr">opacity</span>: <span class="number">1</span> &#125;)</span><br><span class="line">        )</span><br><span class="line">      ),</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":leave"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-out"</span>,</span><br><span class="line">          style(&#123;</span><br><span class="line">            transform: <span class="string">"translateX(100%)"</span>,</span><br><span class="line">            opacity: <span class="number">0</span></span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    ])</span><br><span class="line">  ])</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
<p>  .container {</p>
<pre><code>margin-top: 100px;</code></pre><p>  }<br>  .panel-heading {</p>
<pre><code>cursor: pointer;</code></pre><p>  }<br></style></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#96;&#96;&#96;javascript</span><br><span class="line">import &#123; Component &#125; from &quot;@angular&#x2F;core&quot;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: &quot;app-root&quot;,</span><br><span class="line">  templateUrl: &quot;.&#x2F;app.component.html&quot;,</span><br><span class="line">  styles: []</span><br><span class="line">&#125;)</span><br><span class="line">export class AppComponent &#123;</span><br><span class="line">  isExpended: boolean &#x3D; false</span><br><span class="line">  toggle() &#123;</span><br><span class="line">    this.isExpended &#x3D; !this.isExpended</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建动画</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">trigger(<span class="string">"expandCollapse"</span>, [</span><br><span class="line">  <span class="comment">// 使用 state 方法定义折叠状态元素对应的样式</span></span><br><span class="line">  state(</span><br><span class="line">    <span class="string">"collapsed"</span>,</span><br><span class="line">    style(&#123;</span><br><span class="line">      height: <span class="number">0</span>,</span><br><span class="line">      overflow: <span class="string">"hidden"</span>,</span><br><span class="line">      paddingTop: <span class="number">0</span>,</span><br><span class="line">      paddingBottom: <span class="number">0</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ),</span><br><span class="line">  <span class="comment">// 使用 state 方法定义展开状态元素对应的样式</span></span><br><span class="line">  state(<span class="string">"expanded"</span>, style(&#123; <span class="attr">height</span>: <span class="string">"*"</span>, <span class="attr">overflow</span>: <span class="string">"auto"</span> &#125;)),</span><br><span class="line">  <span class="comment">// 定义展开动画</span></span><br><span class="line">  transition(<span class="string">"collapsed =&gt; expanded"</span>, animate(<span class="string">"400ms ease-out"</span>)),</span><br><span class="line">  <span class="comment">// 定义折叠动画</span></span><br><span class="line">  transition(<span class="string">"expanded =&gt; collapsed"</span>, animate(<span class="string">"400ms ease-in"</span>))</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span> [@<span class="attr">expandCollapse</span>]=<span class="string">"isExpended ? 'expanded' : 'collapsed'"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="45-实现路由动画-6"><a href="#45-实现路由动画-6" class="headerlink" title="45.实现路由动画"></a>45.实现路由动画</h3><ol>
<li><p>为路由添加状态标识，此标识即为路由执行动画时的自定义状态</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> routes: Routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">""</span>,</span><br><span class="line">    component: HomeComponent,</span><br><span class="line">    pathMatch: <span class="string">"full"</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"one"</span> </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"about"</span>,</span><br><span class="line">    component: AboutComponent,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"two"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"news"</span>,</span><br><span class="line">    component: NewsComponent,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"three"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过路由插座对象获取路由状态标识，并将标识传递给动画的调用者，让动画执行当前要执行的状态是什么</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"routerContainer"</span> [@<span class="attr">routerAnimations</span>]=<span class="string">"prepareRoute(outlet)"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">router-outlet</span> #<span class="attr">outlet</span>=<span class="string">"outlet"</span>&gt;</span><span class="tag">&lt;/<span class="name">router-outlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; RouterOutlet &#125; <span class="keyword">from</span> <span class="string">"@angular/router"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  prepareRoute(outlet: RouterOutlet) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      outlet &amp;&amp;</span><br><span class="line">      outlet.activatedRouteData &amp;&amp;</span><br><span class="line">      outlet.activatedRouteData.animation</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>将 routerContainer 设置为相对定位，将它的直接一级子元素设置成绝对定位</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* styles.css */</span></span><br><span class="line"><span class="selector-class">.routerContainer</span> &#123;</span><br><span class="line">  <span class="attribute">position</span>: relative;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.routerContainer</span> &gt; * &#123;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建动画</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">trigger(<span class="string">"routerAnimations"</span>, [</span><br><span class="line">  transition(<span class="string">"one =&gt; two, one =&gt; three, two =&gt; three"</span>, [</span><br><span class="line">    query(<span class="string">":enter"</span>, style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(100%)"</span>, <span class="attr">opacity</span>: <span class="number">0</span> &#125;)),</span><br><span class="line">    group([</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":enter"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-in"</span>,</span><br><span class="line">          style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(0)"</span>, <span class="attr">opacity</span>: <span class="number">1</span> &#125;)</span><br><span class="line">        )</span><br><span class="line">      ),</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":leave"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-out"</span>,</span><br><span class="line">          style(&#123;</span><br><span class="line">            transform: <span class="string">"translateX(-100%)"</span>,</span><br><span class="line">            opacity: <span class="number">0</span></span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    ])</span><br><span class="line">  ]),</span><br><span class="line">  transition(<span class="string">"three =&gt; two, three =&gt; one, two =&gt; one"</span>, [</span><br><span class="line">    query(</span><br><span class="line">      <span class="string">":enter"</span>,</span><br><span class="line">      style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(-100%)"</span>, <span class="attr">opacity</span>: <span class="number">0</span> &#125;)</span><br><span class="line">    ),</span><br><span class="line">    group([</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":enter"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-in"</span>,</span><br><span class="line">          style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(0)"</span>, <span class="attr">opacity</span>: <span class="number">1</span> &#125;)</span><br><span class="line">        )</span><br><span class="line">      ),</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":leave"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-out"</span>,</span><br><span class="line">          style(&#123;</span><br><span class="line">            transform: <span class="string">"translateX(100%)"</span>,</span><br><span class="line">            opacity: <span class="number">0</span></span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    ])</span><br><span class="line">  ])</span><br><span class="line">])</span><br><span class="line"><span class="string">``</span><span class="string">`     .container &#123;</span></span><br><span class="line"><span class="string">    margin-top: 100px;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  .panel-heading &#123;</span></span><br><span class="line"><span class="string">    cursor: pointer;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&lt;/style&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component &#125; <span class="keyword">from</span> <span class="string">"@angular/core"</span></span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">"app-root"</span>,</span><br><span class="line">  templateUrl: <span class="string">"./app.component.html"</span>,</span><br><span class="line">  styles: []</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  isExpended: boolean = <span class="literal">false</span></span><br><span class="line">  toggle() &#123;</span><br><span class="line">    <span class="keyword">this</span>.isExpended = !<span class="keyword">this</span>.isExpended</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建动画</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">trigger(<span class="string">"expandCollapse"</span>, [</span><br><span class="line">  <span class="comment">// 使用 state 方法定义折叠状态元素对应的样式</span></span><br><span class="line">  state(</span><br><span class="line">    <span class="string">"collapsed"</span>,</span><br><span class="line">    style(&#123;</span><br><span class="line">      height: <span class="number">0</span>,</span><br><span class="line">      overflow: <span class="string">"hidden"</span>,</span><br><span class="line">      paddingTop: <span class="number">0</span>,</span><br><span class="line">      paddingBottom: <span class="number">0</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ),</span><br><span class="line">  <span class="comment">// 使用 state 方法定义展开状态元素对应的样式</span></span><br><span class="line">  state(<span class="string">"expanded"</span>, style(&#123; <span class="attr">height</span>: <span class="string">"*"</span>, <span class="attr">overflow</span>: <span class="string">"auto"</span> &#125;)),</span><br><span class="line">  <span class="comment">// 定义展开动画</span></span><br><span class="line">  transition(<span class="string">"collapsed =&gt; expanded"</span>, animate(<span class="string">"400ms ease-out"</span>)),</span><br><span class="line">  <span class="comment">// 定义折叠动画</span></span><br><span class="line">  transition(<span class="string">"expanded =&gt; collapsed"</span>, animate(<span class="string">"400ms ease-in"</span>))</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span> [@<span class="attr">expandCollapse</span>]=<span class="string">"isExpended ? 'expanded' : 'collapsed'"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="45-实现路由动画-7"><a href="#45-实现路由动画-7" class="headerlink" title="45.实现路由动画"></a>45.实现路由动画</h3><ol>
<li><p>为路由添加状态标识，此标识即为路由执行动画时的自定义状态</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> routes: Routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">""</span>,</span><br><span class="line">    component: HomeComponent,</span><br><span class="line">    pathMatch: <span class="string">"full"</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"one"</span> </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"about"</span>,</span><br><span class="line">    component: AboutComponent,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"two"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"news"</span>,</span><br><span class="line">    component: NewsComponent,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"three"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过路由插座对象获取路由状态标识，并将标识传递给动画的调用者，让动画执行当前要执行的状态是什么</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"routerContainer"</span> [@<span class="attr">routerAnimations</span>]=<span class="string">"prepareRoute(outlet)"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">router-outlet</span> #<span class="attr">outlet</span>=<span class="string">"outlet"</span>&gt;</span><span class="tag">&lt;/<span class="name">router-outlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; RouterOutlet &#125; <span class="keyword">from</span> <span class="string">"@angular/router"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  prepareRoute(outlet: RouterOutlet) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      outlet &amp;&amp;</span><br><span class="line">      outlet.activatedRouteData &amp;&amp;</span><br><span class="line">      outlet.activatedRouteData.animation</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>将 routerContainer 设置为相对定位，将它的直接一级子元素设置成绝对定位</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* styles.css */</span></span><br><span class="line"><span class="selector-class">.routerContainer</span> &#123;</span><br><span class="line">  <span class="attribute">position</span>: relative;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.routerContainer</span> &gt; * &#123;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建动画</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">trigger(<span class="string">"routerAnimations"</span>, [</span><br><span class="line">  transition(<span class="string">"one =&gt; two, one =&gt; three, two =&gt; three"</span>, [</span><br><span class="line">    query(<span class="string">":enter"</span>, style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(100%)"</span>, <span class="attr">opacity</span>: <span class="number">0</span> &#125;)),</span><br><span class="line">    group([</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":enter"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-in"</span>,</span><br><span class="line">          style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(0)"</span>, <span class="attr">opacity</span>: <span class="number">1</span> &#125;)</span><br><span class="line">        )</span><br><span class="line">      ),</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":leave"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-out"</span>,</span><br><span class="line">          style(&#123;</span><br><span class="line">            transform: <span class="string">"translateX(-100%)"</span>,</span><br><span class="line">            opacity: <span class="number">0</span></span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    ])</span><br><span class="line">  ]),</span><br><span class="line">  transition(<span class="string">"three =&gt; two, three =&gt; one, two =&gt; one"</span>, [</span><br><span class="line">    query(</span><br><span class="line">      <span class="string">":enter"</span>,</span><br><span class="line">      style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(-100%)"</span>, <span class="attr">opacity</span>: <span class="number">0</span> &#125;)</span><br><span class="line">    ),</span><br><span class="line">    group([</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":enter"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-in"</span>,</span><br><span class="line">          style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(0)"</span>, <span class="attr">opacity</span>: <span class="number">1</span> &#125;)</span><br><span class="line">        )</span><br><span class="line">      ),</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":leave"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-out"</span>,</span><br><span class="line">          style(&#123;</span><br><span class="line">            transform: <span class="string">"translateX(100%)"</span>,</span><br><span class="line">            opacity: <span class="number">0</span></span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    ])</span><br><span class="line">  ])</span><br><span class="line">])</span><br></pre></td></tr></table></figure>


</li>
</ol>
<p>  #box {<br>    width: 200px;<br>    height: 200px;<br>    background: skyblue;<br>    position: absolute;<br>    left: 0;<br>    top: 0;<br>  }<br></style></p>
<div id="box"></div>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#96;&#96;&#96;javascript</span><br><span class="line">&#x2F;&#x2F; 原生 JavaScript</span><br><span class="line">box.onmousedown &#x3D; function (event) &#123;</span><br><span class="line">  let distanceX &#x3D; event.clientX - event.target.offsetLeft</span><br><span class="line">  let distanceY &#x3D; event.clientY - event.target.offsetTop</span><br><span class="line">  document.onmousemove &#x3D; function (event) &#123;</span><br><span class="line">    let positionX &#x3D; event.clientX - distanceX</span><br><span class="line">    let positionY &#x3D; event.clientY - distanceY</span><br><span class="line">    box.style.left &#x3D; positionX + &quot;px&quot;</span><br><span class="line">    box.style.top &#x3D; positionY + &quot;px&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  box.onmouseup &#x3D; function () &#123;</span><br><span class="line">    document.onmousemove &#x3D; null</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RxJS</span></span><br><span class="line"><span class="keyword">import</span> &#123; fromEvent &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"><span class="keyword">import</span> &#123; map, switchMap, takeUntil &#125; <span class="keyword">from</span> <span class="string">"rxjs/operators"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> box = <span class="built_in">document</span>.getElementById(<span class="string">"box"</span>)</span><br><span class="line"></span><br><span class="line">fromEvent(box, <span class="string">"mousedown"</span>)</span><br><span class="line">  .pipe(</span><br><span class="line">    map(<span class="function"><span class="params">event</span> =&gt;</span> (&#123;</span><br><span class="line">      distanceX: event.clientX - event.target.offsetLeft,</span><br><span class="line">      distanceY: event.clientY - event.target.offsetTop</span><br><span class="line">    &#125;)),</span><br><span class="line">    switchMap(<span class="function">(<span class="params">&#123; distanceX, distanceY &#125;</span>) =&gt;</span></span><br><span class="line">      fromEvent(<span class="built_in">document</span>, <span class="string">"mousemove"</span>).pipe(</span><br><span class="line">        map(<span class="function"><span class="params">event</span> =&gt;</span> (&#123;</span><br><span class="line">          positionX: event.clientX - distanceX,</span><br><span class="line">          positionY: event.clientY - distanceY</span><br><span class="line">        &#125;)),</span><br><span class="line">        takeUntil(fromEvent(<span class="built_in">document</span>, <span class="string">"mouseup"</span>))</span><br><span class="line">      )</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line">  .subscribe(<span class="function">(<span class="params">&#123; positionX, positionY &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    box.style.left = positionX + <span class="string">"px"</span></span><br><span class="line">    box.style.top = positionY + <span class="string">"px"</span></span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>

<h3 id="15-搜索案例-1"><a href="#15-搜索案例-1" class="headerlink" title="15.搜索案例"></a>15.搜索案例</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"search"</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">placeholder</span>=<span class="string">"请输入搜索内容..."</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fromEvent, <span class="keyword">from</span>, throwError &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"><span class="keyword">import</span> &#123; debounceTime, distinctUntilChanged, map, switchMap, catchError &#125; <span class="keyword">from</span> <span class="string">"rxjs/operators"</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">"axios"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> search = <span class="built_in">document</span>.getElementById(<span class="string">"search"</span>)</span><br><span class="line"></span><br><span class="line">fromEvent(search, <span class="string">"keyup"</span>)</span><br><span class="line">  .pipe(</span><br><span class="line">    debounceTime(<span class="number">700</span>),</span><br><span class="line">    map(<span class="function"><span class="params">event</span> =&gt;</span> event.target.value),</span><br><span class="line">    distinctUntilChanged(),</span><br><span class="line">    switchMap(<span class="function"><span class="params">keyword</span> =&gt;</span></span><br><span class="line">      <span class="keyword">from</span>(</span><br><span class="line">        axios.get(<span class="string">`https://j1sonplaceholder.typicode.com/posts?q=<span class="subst">$&#123;keyword&#125;</span>`</span>)</span><br><span class="line">      ).pipe(</span><br><span class="line">        map(<span class="function"><span class="params">response</span> =&gt;</span> response.data),</span><br><span class="line">        catchError(<span class="function"><span class="params">error</span> =&gt;</span> throwError(<span class="string">`发生了错误: <span class="subst">$&#123;error.message&#125;</span>`</span>))</span><br><span class="line">      )</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line">  .subscribe(&#123;</span><br><span class="line">    next: <span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(value)</span><br><span class="line">    &#125;,</span><br><span class="line">    error: <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(error)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>

<h3 id="16-案例之串联请求的发送-1"><a href="#16-案例之串联请求的发送-1" class="headerlink" title="16.案例之串联请求的发送"></a>16.案例之串联请求的发送</h3><p>先获取token，再根据token获取用户信息</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"btn"</span>&gt;</span>获取用户信息<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">"axios"</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">from</span>, fromEvent &#125; <span class="keyword">from</span> <span class="string">"rxjs"</span></span><br><span class="line"><span class="keyword">import</span> &#123; pluck, concatMap &#125; <span class="keyword">from</span> <span class="string">"rxjs/operators"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> button = <span class="built_in">document</span>.getElementById(<span class="string">"btn"</span>)</span><br><span class="line"></span><br><span class="line">fromEvent(button, <span class="string">"click"</span>)</span><br><span class="line">  .pipe(</span><br><span class="line">    concatMap(<span class="function"><span class="params">event</span> =&gt;</span></span><br><span class="line">      <span class="keyword">from</span>(axios.get(<span class="string">"http://localhost:3005/token"</span>)).pipe(</span><br><span class="line">        pluck(<span class="string">"data"</span>, <span class="string">"token"</span>)</span><br><span class="line">      )</span><br><span class="line">    ),</span><br><span class="line">    concatMap(<span class="function"><span class="params">token</span> =&gt;</span></span><br><span class="line">      <span class="keyword">from</span>(axios.get(<span class="string">"http://localhost:3005/userInfo"</span>)).pipe(pluck(<span class="string">"data"</span>))</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line">  .subscribe(<span class="built_in">console</span>.log)</span><br></pre></td></tr></table></figure>

<h3 id="17-HttpClientModule的基本使用-1"><a href="#17-HttpClientModule的基本使用-1" class="headerlink" title="17.HttpClientModule的基本使用"></a>17.HttpClientModule的基本使用</h3><p>该模块用于发送 Http 请求，用于发送请求的方法都返回 Observable 对象。</p>
<h4 id="1-快速开始-1"><a href="#1-快速开始-1" class="headerlink" title="1. 快速开始"></a>1. 快速开始</h4><ol>
<li><p>引入 HttpClientModule 模块</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.module.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; httpClientModule &#125; <span class="keyword">from</span> <span class="string">'@angular/common/http'</span>;</span><br><span class="line">imports: [</span><br><span class="line">  httpClientModule</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>注入 HttpClient 服务实例对象，用于发送请求</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.component.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; HttpClient &#125; <span class="keyword">from</span> <span class="string">'@angular/common/http'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">	<span class="keyword">constructor</span>(private http: HttpClient) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>发送请求</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; HttpClient &#125; <span class="keyword">from</span> <span class="string">"@angular/common/http"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> <span class="title">implements</span> <span class="title">OnInit</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(private http: HttpClient) &#123;&#125;</span><br><span class="line">  ngOnInit() &#123;</span><br><span class="line">    <span class="keyword">this</span>.getUsers().subscribe(<span class="built_in">console</span>.log)</span><br><span class="line">  &#125;</span><br><span class="line">  getUsers() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.http.get(<span class="string">"https://jsonplaceholder.typicode.com/users"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h4 id="2-请求方法-1"><a href="#2-请求方法-1" class="headerlink" title="2. 请求方法"></a>2. 请求方法</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.http.get(url [, options]);</span><br><span class="line"><span class="keyword">this</span>.http.post(url, data [, options]);</span><br><span class="line"><span class="keyword">this</span>.http.delete(url [, options]);</span><br><span class="line"><span class="keyword">this</span>.http.put(url, data [, options]);</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.http.get&lt;Post[]&gt;(<span class="string">'/getAllPosts'</span>)</span><br><span class="line">  .subscribe(<span class="function"><span class="params">response</span> =&gt;</span> <span class="built_in">console</span>.log(response))</span><br></pre></td></tr></table></figure>

<h3 id="18-HttpParams类的使用-1"><a href="#18-HttpParams类的使用-1" class="headerlink" title="18.HttpParams类的使用"></a>18.HttpParams类的使用</h3><ol>
<li><p>HttpParams 类</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> declare <span class="class"><span class="keyword">class</span> <span class="title">HttpParams</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(options?: HttpParamsOptions);</span><br><span class="line">    has(param: string): boolean;</span><br><span class="line">    <span class="keyword">get</span>(param: string): string | null;</span><br><span class="line">    getAll(param: string): string[] | null;</span><br><span class="line">    keys(): string[];</span><br><span class="line">    append(param: string, value: string): HttpParams;</span><br><span class="line">    <span class="keyword">set</span>(param: string, value: string): HttpParams;</span><br><span class="line">    delete(param: string, value?: string): HttpParams;</span><br><span class="line">    toString(): string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>HttpParamsOptions 接口</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">declare interface HttpParamsOptions &#123;</span><br><span class="line">    fromString?: string;</span><br><span class="line">    fromObject?: &#123;</span><br><span class="line">        [param: string]: string | ReadonlyArray&lt;string&gt;;</span><br><span class="line">    &#125;;</span><br><span class="line">    encoder?: HttpParameterCodec;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用示例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; HttpParams &#125; <span class="keyword">from</span> <span class="string">'@angular/common/http'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> params = <span class="keyword">new</span> HttpParams(&#123; <span class="attr">fromObject</span>: &#123;<span class="attr">name</span>: <span class="string">"zhangsan"</span>, <span class="attr">age</span>: <span class="string">"20"</span>&#125;&#125;)</span><br><span class="line">params = params.append(<span class="string">"sex"</span>, <span class="string">"male"</span>)</span><br><span class="line"><span class="keyword">let</span> params = <span class="keyword">new</span> HttpParams(&#123; <span class="attr">fromString</span>: <span class="string">"name=zhangsan&amp;age=20"</span>&#125;)</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="19-HttpHeaders类的使用-1"><a href="#19-HttpHeaders类的使用-1" class="headerlink" title="19.HttpHeaders类的使用"></a>19.HttpHeaders类的使用</h3><p>请求头字段的创建需要使用 HttpHeaders 类，在类实例对象下面有各种操作请求头的方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> declare <span class="class"><span class="keyword">class</span> <span class="title">HttpHeaders</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(headers?: string | &#123;</span><br><span class="line">        [name: string]: string | string[];</span><br><span class="line">    &#125;);</span><br><span class="line">    has(name: string): boolean;</span><br><span class="line">    <span class="keyword">get</span>(name: string): string | null;</span><br><span class="line">    keys(): string[];</span><br><span class="line">    getAll(name: string): string[] | null;</span><br><span class="line">    append(name: string, value: string | string[]): HttpHeaders;</span><br><span class="line">    <span class="keyword">set</span>(name: string, value: string | string[]): HttpHeaders;</span><br><span class="line">    delete(name: string, value?: string | string[]): HttpHeaders;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> headers = <span class="keyword">new</span> HttpHeaders(&#123; <span class="attr">test</span>: <span class="string">"Hello"</span> &#125;)</span><br></pre></td></tr></table></figure>

<h3 id="20-设置响应体-1"><a href="#20-设置响应体-1" class="headerlink" title="20.设置响应体"></a>20.设置响应体</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">declare type HttpObserve = <span class="string">'body'</span> | <span class="string">'response'</span>;</span><br><span class="line"><span class="comment">// response 读取完整响应体</span></span><br><span class="line"><span class="comment">// body 读取服务器端返回的数据</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.http.get(</span><br><span class="line">  <span class="string">"https://jsonplaceholder.typicode.com/users"</span>, </span><br><span class="line">  &#123; <span class="attr">observe</span>: <span class="string">"body"</span> &#125;</span><br><span class="line">).subscribe(<span class="built_in">console</span>.log)</span><br></pre></td></tr></table></figure>

<h3 id="21-拦截器的使用-一-1"><a href="#21-拦截器的使用-一-1" class="headerlink" title="21.拦截器的使用(一)"></a>21.拦截器的使用(一)</h3><p>拦截器是 Angular 应用中全局捕获和修改 HTTP 请求和响应的方式。（Token、Error）<br>拦截器将只拦截使用 HttpClientModule 模块发出的请求。</p>
<p><code>ng g interceptor &lt;name&gt;</code></p>
<ol>
<li>请求拦截</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Injectable()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthInterceptor</span> <span class="title">implements</span> <span class="title">HttpInterceptor</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;&#125;</span><br><span class="line">	<span class="comment">// 拦截方法</span></span><br><span class="line">  intercept(</span><br><span class="line">  	<span class="comment">// unknown 指定请求体 (body) 的类型</span></span><br><span class="line">    request: HttpRequest&lt;unknown&gt;,</span><br><span class="line">    next: HttpHandler</span><br><span class="line">     <span class="comment">// unknown 指定响应内容 (body) 的类型</span></span><br><span class="line">  ): Observable&lt;HttpEvent&lt;unknown&gt;&gt; &#123;</span><br><span class="line">    <span class="comment">// 克隆并修改请求头</span></span><br><span class="line">    <span class="keyword">const</span> req = request.clone(&#123;</span><br><span class="line">      setHeaders: &#123;</span><br><span class="line">        Authorization: <span class="string">"Bearer xxxxxxx"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// 通过回调函数将修改后的请求头回传给应用</span></span><br><span class="line">    <span class="keyword">return</span> next.handle(req)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>响应拦截</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Injectable() </span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthInterceptor</span> <span class="title">implements</span> <span class="title">HttpInterceptor</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;&#125;</span><br><span class="line">	<span class="comment">// 拦截方法</span></span><br><span class="line">  intercept(</span><br><span class="line">    request: HttpRequest&lt;unknown&gt;,</span><br><span class="line">    next: HttpHandler</span><br><span class="line">  ): Observable&lt;any&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> next.handle(request).pipe(</span><br><span class="line">      retry(<span class="number">2</span>),</span><br><span class="line">      catchError(<span class="function">(<span class="params">error: HttpErrorResponse</span>) =&gt;</span> throwError(error))</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="22-拦截器的使用-二-1"><a href="#22-拦截器的使用-二-1" class="headerlink" title="22.拦截器的使用(二)"></a>22.拦截器的使用(二)</h3><blockquote>
<p>拦截器注入</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; AuthInterceptor &#125; <span class="keyword">from</span> <span class="string">"./auth.interceptor"</span></span><br><span class="line"><span class="keyword">import</span> &#123; HTTP_INTERCEPTORS &#125; <span class="keyword">from</span> <span class="string">"@angular/common/http"</span></span><br><span class="line"></span><br><span class="line">@NgModule(&#123;</span><br><span class="line">  providers: [</span><br><span class="line">    &#123;</span><br><span class="line">      provide: HTTP_INTERCEPTORS,</span><br><span class="line">      useClass: AuthInterceptor,</span><br><span class="line">      multi: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="23-配置AngularProxy-1"><a href="#23-配置AngularProxy-1" class="headerlink" title="23.配置AngularProxy"></a>23.配置AngularProxy</h3><ol>
<li><p>在项目的根目录下创建  proxy.conf.json 文件并加入如下代码</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"> 	<span class="attr">"/api/*"</span>: &#123;</span><br><span class="line">    <span class="attr">"target"</span>: <span class="string">"http://localhost:3070"</span>,</span><br><span class="line">    <span class="attr">"secure"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"changeOrigin"</span>: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>/api/*：在应用中发出的以 /api 开头的请求走此代理</li>
<li>target：服务器端 URL</li>
<li>secure：如果服务器端 URL 的协议是 https，此项需要为 true</li>
<li>changeOrigin：如果服务器端不是 localhost， 此项需要为 true</li>
</ol>
</li>
<li><p>指定 proxy 配置文件 (方式一) </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"scripts"</span>: &#123;</span><br><span class="line">  <span class="string">"start"</span>: <span class="string">"ng serve --proxy-config proxy.conf.json"</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>指定 proxy 配置文件 (方式二)</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">"serve": &#123;</span><br><span class="line">  "options": &#123;</span><br><span class="line">    "proxyConfig": "proxy.conf.json"</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="24-NgRx概述-1"><a href="#24-NgRx概述-1" class="headerlink" title="24.NgRx概述"></a>24.NgRx概述</h3><h3 id="25-NgRx基本使用-1"><a href="#25-NgRx基本使用-1" class="headerlink" title="25.NgRx基本使用"></a>25.NgRx基本使用</h3><h3 id="26-selector的用法-1"><a href="#26-selector的用法-1" class="headerlink" title="26.selector的用法"></a>26.selector的用法</h3><h3 id="27-Action传递参数-1"><a href="#27-Action传递参数-1" class="headerlink" title="27.Action传递参数"></a>27.Action传递参数</h3><h3 id="28-metaReducer机制介绍-1"><a href="#28-metaReducer机制介绍-1" class="headerlink" title="28.metaReducer机制介绍"></a>28.metaReducer机制介绍</h3><h3 id="29-使用Effect接收Action执行副作用-1"><a href="#29-使用Effect接收Action执行副作用-1" class="headerlink" title="29.使用Effect接收Action执行副作用"></a>29.使用Effect接收Action执行副作用</h3><h3 id="30-ngrx案例todo之添加任务-1"><a href="#30-ngrx案例todo之添加任务-1" class="headerlink" title="30.ngrx案例todo之添加任务"></a>30.ngrx案例todo之添加任务</h3><h3 id="31-案例todo之展示任务-1"><a href="#31-案例todo之展示任务-1" class="headerlink" title="31.案例todo之展示任务"></a>31.案例todo之展示任务</h3><h3 id="32-案例todo之删除任务-1"><a href="#32-案例todo之删除任务-1" class="headerlink" title="32.案例todo之删除任务"></a>32.案例todo之删除任务</h3><h3 id="33-在todo案例中加入Entity简化实体操作-1"><a href="#33-在todo案例中加入Entity简化实体操作-1" class="headerlink" title="33.在todo案例中加入Entity简化实体操作"></a>33.在todo案例中加入Entity简化实体操作</h3><p>Entity 译为实体，实体就是集合中的一条数据。</p>
<p>NgRx 中提供了实体适配器对象，在实体适配器对象下面提供了各种操作集合中实体的方法，目的就是提高开发者操作实体的效率。</p>
<blockquote>
<p>核心</p>
</blockquote>
<ol>
<li><p>EntityState：实体类型接口</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	&#123;</span></span><br><span class="line"><span class="comment">		ids: [1, 2],</span></span><br><span class="line"><span class="comment">		entities: &#123;</span></span><br><span class="line"><span class="comment">			1: &#123; id: 1, title: "Hello Angular" &#125;,</span></span><br><span class="line"><span class="comment">			2: &#123; id: 2, title: "Hello NgRx" &#125;</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">export</span> interface State extends EntityState&lt;Todo&gt; &#123;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>createEntityAdapter： 创建实体适配器对象</p>
</li>
<li><p>EntityAdapter：实体适配器对象类型接口</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> adapter: EntityAdapter&lt;Todo&gt; = createEntityAdapter&lt;Todo&gt;()</span><br><span class="line"><span class="comment">// 获取初始状态 可以传递对象参数 也可以不传</span></span><br><span class="line"><span class="comment">// &#123;ids: [], entities: &#123;&#125;&#125;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> initialState: State = adapter.getInitialState()</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h5 id="15-6-3-实例方法-1"><a href="#15-6-3-实例方法-1" class="headerlink" title="15.6.3 实例方法"></a>15.6.3 实例方法</h5><p><a href="https://ngrx.io/guide/entity/adapter#adapter-collection-methods" target="_blank" rel="noopener">https://ngrx.io/guide/entity/adapter#adapter-collection-methods</a></p>
<h5 id="15-6-4-选择器-1"><a href="#15-6-4-选择器-1" class="headerlink" title="15.6.4 选择器"></a>15.6.4 选择器</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// selectTotal 获取数据条数</span></span><br><span class="line"><span class="comment">// selectAll 获取所有数据 以数组形式呈现</span></span><br><span class="line"><span class="comment">// selectEntities 获取实体集合 以字典形式呈现</span></span><br><span class="line"><span class="comment">// selectIds 获取id集合, 以数组形式呈现</span></span><br><span class="line"><span class="keyword">const</span> &#123; selectIds, selectEntities, selectAll, selectTotal &#125; = adapter.getSelectors();</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> selectTodo = createFeatureSelector&lt;AppState, State&gt;(todoFeatureKey)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> selectTodos = createSelector(selectTodo, selectAll)</span><br></pre></td></tr></table></figure>

<h3 id="34-将路由状态同步到Store中-1"><a href="#34-将路由状态同步到Store中-1" class="headerlink" title="34.将路由状态同步到Store中"></a>34.将路由状态同步到Store中</h3><ol>
<li><p>引入模块</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; StoreRouterConnectingModule &#125; <span class="keyword">from</span> <span class="string">"@ngrx/router-store"</span></span><br><span class="line"></span><br><span class="line">@NgModule(&#123;</span><br><span class="line">  imports: [</span><br><span class="line">    StoreRouterConnectingModule.forRoot()</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>将路由状态集成到 Store</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> fromRouter <span class="keyword">from</span> <span class="string">"@ngrx/router-store"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> interface AppState &#123;</span><br><span class="line">  router: fromRouter.RouterReducerState</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> reducers: ActionReducerMap&lt;AppState&gt; = &#123;</span><br><span class="line">  router: fromRouter.routerReducer</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<blockquote>
<p>创建获取路由状态的 Selector</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router.selectors.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; createFeatureSelector &#125; <span class="keyword">from</span> <span class="string">"@ngrx/store"</span></span><br><span class="line"><span class="keyword">import</span> &#123; AppState &#125; <span class="keyword">from</span> <span class="string">".."</span></span><br><span class="line"><span class="keyword">import</span> &#123; RouterReducerState, getSelectors &#125; <span class="keyword">from</span> <span class="string">"@ngrx/router-store"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> selectRouter = createFeatureSelector&lt;AppState, RouterReducerState&gt;(</span><br><span class="line">  <span class="string">"router"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> &#123;</span><br><span class="line">  <span class="comment">// 获取和当前路由相关的信息 (路由参数、路由配置等)</span></span><br><span class="line">  selectCurrentRoute,</span><br><span class="line">  <span class="comment">// 获取地址栏中 # 号后面的内容</span></span><br><span class="line">  selectFragment,</span><br><span class="line">  <span class="comment">// 获取路由查询参数</span></span><br><span class="line">  selectQueryParams,</span><br><span class="line">  <span class="comment">// 获取具体的某一个查询参数 selectQueryParam('name')</span></span><br><span class="line">  selectQueryParam,</span><br><span class="line">  <span class="comment">// 获取动态路由参数</span></span><br><span class="line">  selectRouteParams,</span><br><span class="line"> 	<span class="comment">// 获取某一个具体的动态路由参数 selectRouteParam('name')</span></span><br><span class="line">  selectRouteParam,</span><br><span class="line">  <span class="comment">// 获取路由自定义数据</span></span><br><span class="line">  selectRouteData,</span><br><span class="line">  <span class="comment">// 获取路由的实际访问地址</span></span><br><span class="line">  selectUrl</span><br><span class="line">&#125; = getSelectors(selectRouter)</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// home.component.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; select, Store &#125; <span class="keyword">from</span> <span class="string">"@ngrx/store"</span></span><br><span class="line"><span class="keyword">import</span> &#123; AppState &#125; <span class="keyword">from</span> <span class="string">"src/app/store"</span></span><br><span class="line"><span class="keyword">import</span> &#123; selectQueryParams &#125; <span class="keyword">from</span> <span class="string">"src/app/store/selectors/router.selectors"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AboutComponent</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(private store: Store&lt;AppState&gt;) &#123;</span><br><span class="line">    <span class="keyword">this</span>.store.pipe(select(selectQueryParams)).subscribe(<span class="built_in">console</span>.log)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="35-和状态相关的概念-1"><a href="#35-和状态相关的概念-1" class="headerlink" title="35.和状态相关的概念"></a>35.和状态相关的概念</h3><blockquote>
<p>什么是状态</p>
</blockquote>
<p>状态表示的是要进行运动的元素在运动的不同时期所呈现的样式。</p>
<blockquote>
<p>状态的种类</p>
</blockquote>
<p>在 Angular 中，有三种类型的状态，分别为：<code>void</code>、<code>*</code>、<code>custom</code></p>
<p>void：当元素在内存中创建好但尚未被添加到 DOM 中或将元素从 DOM 中删除时会发生此状态</p>
<p>*：元素被插入到 DOM 树之后的状态，或者是已经在DOM树中的元素的状态，也叫默认状态</p>
<p>custom：自定义状态，元素默认就在页面之中，从一个状态运动到另一个状态，比如面板的折叠和展开。</p>
<blockquote>
<p>为todo案例添加进场动画和出场动画</p>
</blockquote>
<ul>
<li>进场动画是指元素被创建后以动画的形式出现在用户面前，进场动画的状态用 <code>void =&gt; *</code> 表示，别名为 <code>:enter</code></li>
<li>出场动画是指元素在被删除前执行的一段告别动画，出场动画的状态用 <code>* =&gt; void</code>，别名为 <code>:leave</code></li>
</ul>
<blockquote>
<p>快速上手</p>
</blockquote>
<ol>
<li><p>在使用动画功能之前，需要引入动画模块，即 <code>BrowserAnimationsModule</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; BrowserAnimationsModule &#125; <span class="keyword">from</span> <span class="string">"@angular/platform-browser/animations"</span></span><br><span class="line"></span><br><span class="line">@NgModule(&#123;</span><br><span class="line">  imports: [BrowserAnimationsModule],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>默认代码解析，todo 之删除任务和添加任务</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 在 index.html 文件中引入 bootstrap.min.css --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Todos<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> (<span class="attr">keyup.enter</span>)=<span class="string">"addItem(input)"</span> #<span class="attr">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">placeholder</span>=<span class="string">"add todos"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"list-group"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> (<span class="attr">click</span>)=<span class="string">"removeItem(i)"</span> *<span class="attr">ngFor</span>=<span class="string">"let item of todos; let i = index"</span> <span class="attr">class</span>=<span class="string">"list-group-item"</span>&gt;</span></span><br><span class="line">      &#123;&#123; item &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component &#125; <span class="keyword">from</span> <span class="string">"@angular/core"</span></span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">"app-root"</span>,</span><br><span class="line">  templateUrl: <span class="string">"./app.component.html"</span>,</span><br><span class="line">  styles: []</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  <span class="comment">// todo 列表</span></span><br><span class="line">  todos: string[] = [<span class="string">"Learn Angular"</span>, <span class="string">"Learn RxJS"</span>, <span class="string">"Learn NgRx"</span>]</span><br><span class="line">	<span class="comment">// 添加 todo</span></span><br><span class="line">  addItem(input: HTMLInputElement) &#123;</span><br><span class="line">    <span class="keyword">this</span>.todos.push(input.value)</span><br><span class="line">    input.value = <span class="string">""</span></span><br><span class="line">  &#125;</span><br><span class="line">	<span class="comment">// 删除 todo</span></span><br><span class="line">  removeItem(index: number) &#123;</span><br><span class="line">    <span class="keyword">this</span>.todos.splice(index, <span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建动画</p>
<ol>
<li>trigger 方法用于创建动画，指定动画名称</li>
<li>transition 方法用于指定动画的运动状态，出场动画或者入场动画，或者自定义状态动画。</li>
<li>style 方法用于设置元素在不同的状态下所对应的样式</li>
<li>animate 方法用于设置运动参数，比如动画运动时间，延迟事件，运动形式</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">@Component(&#123;</span><br><span class="line">  animations: [</span><br><span class="line">    <span class="comment">// 创建动画, 动画名称为 slide</span></span><br><span class="line">    trigger(<span class="string">"slide"</span>, [</span><br><span class="line">      <span class="comment">// 指定入场动画 注意: 字符串两边不能有空格, 箭头两边可以有也可以没有空格</span></span><br><span class="line">      <span class="comment">// void =&gt; * 可以替换为 :enter</span></span><br><span class="line">      transition(<span class="string">"void =&gt; *"</span>, [</span><br><span class="line">        <span class="comment">// 指定元素未入场前的样式</span></span><br><span class="line">        style(&#123; <span class="attr">opacity</span>: <span class="number">0</span>, <span class="attr">transform</span>: <span class="string">"translateY(40px)"</span> &#125;),</span><br><span class="line">        <span class="comment">// 指定元素入场后的样式及运动参数</span></span><br><span class="line">        animate(<span class="number">250</span>, style(&#123; <span class="attr">opacity</span>: <span class="number">1</span>, <span class="attr">transform</span>: <span class="string">"translateY(0)"</span> &#125;))</span><br><span class="line">      ]),</span><br><span class="line">      <span class="comment">// 指定出场动画</span></span><br><span class="line">      <span class="comment">// * =&gt; void 可以替换为 :leave</span></span><br><span class="line">      transition(<span class="string">"* =&gt; void"</span>, [</span><br><span class="line">        <span class="comment">// 指定元素出场后的样式和运动参数</span></span><br><span class="line">        animate(<span class="number">600</span>, style(&#123; <span class="attr">opacity</span>: <span class="number">0</span>, <span class="attr">transform</span>: <span class="string">"translateX(100%)"</span> &#125;))</span><br><span class="line">      ])</span><br><span class="line">    ])</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">li</span> @<span class="attr">slide</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="37-创建动画时的两个注意事项-1"><a href="#37-创建动画时的两个注意事项-1" class="headerlink" title="37.创建动画时的两个注意事项"></a>37.创建动画时的两个注意事项</h3><p>   注意：入场动画中可以不指定元素的默认状态，Angular 会将 void 状态清空作为默认状态</p>
   <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">   trigger(<span class="string">"slide"</span>, [</span><br><span class="line">     transition(<span class="string">":enter"</span>, [</span><br><span class="line">       style(&#123; <span class="attr">opacity</span>: <span class="number">0</span>, <span class="attr">transform</span>: <span class="string">"translateY(40px)"</span> &#125;),</span><br><span class="line">       animate(<span class="number">250</span>)</span><br><span class="line">     ]),</span><br><span class="line">     transition(<span class="string">":leave"</span>, [</span><br><span class="line">    		animate(<span class="number">600</span>, style(&#123; <span class="attr">opacity</span>: <span class="number">0</span>, <span class="attr">transform</span>: <span class="string">"translateX(100%)"</span> &#125;))</span><br><span class="line">     ])</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<p>   注意：要设置动画的运动参数，需要将 animate 方法的一个参数更改为字符串类型</p>
   <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 动画执行总时间 延迟时间 (可选) 运动形式 (可选)</span></span><br><span class="line">animate(<span class="string">"600ms 1s ease-out"</span>, style(&#123; <span class="attr">opacity</span>: <span class="number">0</span>, <span class="attr">transform</span>: <span class="string">"translateX(100%)"</span> &#125;))</span><br></pre></td></tr></table></figure>

<h3 id="38-定义关键帧动画-1"><a href="#38-定义关键帧动画-1" class="headerlink" title="38.定义关键帧动画"></a>38.定义关键帧动画</h3><p>关键帧动画使用 <code>keyframes</code> 方法定义</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">transition(<span class="string">":leave"</span>, [</span><br><span class="line">  animate(</span><br><span class="line">    <span class="number">600</span>,</span><br><span class="line">    keyframes([</span><br><span class="line">      style(&#123; <span class="attr">offset</span>: <span class="number">0.3</span>, <span class="attr">transform</span>: <span class="string">"translateX(-80px)"</span> &#125;),</span><br><span class="line">      style(&#123; <span class="attr">offset</span>: <span class="number">1</span>, <span class="attr">transform</span>: <span class="string">"translateX(100%)"</span> &#125;)</span><br><span class="line">    ])</span><br><span class="line">  )</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<h3 id="39-指定动画的回调函数-1"><a href="#39-指定动画的回调函数-1" class="headerlink" title="39.指定动画的回调函数"></a>39.指定动画的回调函数</h3><p>Angular 提供了和动画相关的两个回调函数，分别为动画开始执行时和动画执行完成后</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">li</span> @<span class="attr">slide</span> (@<span class="attr">slide.start</span>)=<span class="string">"start($event)"</span> (@<span class="attr">slide.done</span>)=<span class="string">"done($event)"</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; AnimationEvent &#125; <span class="keyword">from</span> <span class="string">"@angular/animations"</span></span><br><span class="line"></span><br><span class="line">start(event: AnimationEvent) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(event)</span><br><span class="line">&#125;</span><br><span class="line">done(event: AnimationEvent) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(event)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="40-创建可重用动画-1"><a href="#40-创建可重用动画-1" class="headerlink" title="40.创建可重用动画"></a>40.创建可重用动画</h3><ol>
<li><p>将动画的定义放置在单独的文件中，方便多组件调用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; animate, keyframes, style, transition, trigger &#125; <span class="keyword">from</span> <span class="string">"@angular/animations"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> slide = trigger(<span class="string">"slide"</span>, [</span><br><span class="line">  transition(<span class="string">":enter"</span>, [</span><br><span class="line">    style(&#123; <span class="attr">opacity</span>: <span class="number">0</span>, <span class="attr">transform</span>: <span class="string">"translateY(40px)"</span> &#125;),</span><br><span class="line">    animate(<span class="number">250</span>)</span><br><span class="line">  ]),</span><br><span class="line">  transition(<span class="string">":leave"</span>, [</span><br><span class="line">    animate(</span><br><span class="line">      <span class="number">600</span>,</span><br><span class="line">      keyframes([</span><br><span class="line">        style(&#123; <span class="attr">offset</span>: <span class="number">0.3</span>, <span class="attr">transform</span>: <span class="string">"translateX(-80px)"</span> &#125;),</span><br><span class="line">        style(&#123; <span class="attr">offset</span>: <span class="number">1</span>, <span class="attr">transform</span>: <span class="string">"translateX(100%)"</span> &#125;)</span><br><span class="line">      ])</span><br><span class="line">    )</span><br><span class="line">  ])</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; slide &#125; <span class="keyword">from</span> <span class="string">"./animations"</span></span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  animations: [slide]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>抽取具体的动画定义，方便多动画调用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;animate, animation, keyframes, style, transition, trigger, useAnimation&#125; <span class="keyword">from</span> <span class="string">"@angular/animations"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> slideInUp = animation([</span><br><span class="line">  style(&#123; <span class="attr">opacity</span>: <span class="number">0</span>, <span class="attr">transform</span>: <span class="string">"translateY(40px)"</span> &#125;),</span><br><span class="line">  animate(<span class="number">250</span>)</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> slideOutLeft = animation([</span><br><span class="line">  animate(</span><br><span class="line">    <span class="number">600</span>,</span><br><span class="line">    keyframes([</span><br><span class="line">      style(&#123; <span class="attr">offset</span>: <span class="number">0.3</span>, <span class="attr">transform</span>: <span class="string">"translateX(-80px)"</span> &#125;),</span><br><span class="line">      style(&#123; <span class="attr">offset</span>: <span class="number">1</span>, <span class="attr">transform</span>: <span class="string">"translateX(100%)"</span> &#125;)</span><br><span class="line">    ])</span><br><span class="line">  )</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> slide = trigger(<span class="string">"slide"</span>, [</span><br><span class="line">  transition(<span class="string">":enter"</span>, useAnimation(slideInUp)),</span><br><span class="line">  transition(<span class="string">":leave"</span>, useAnimation(slideOutLeft))</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
</li>
<li><p>调用动画时传递运动总时间，延迟时间，运动形式</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> slideInUp = animation(</span><br><span class="line">  [</span><br><span class="line">    style(&#123; <span class="attr">opacity</span>: <span class="number">0</span>, <span class="attr">transform</span>: <span class="string">"translateY(40px)"</span> &#125;),</span><br><span class="line">    animate(<span class="string">"&#123;&#123; duration &#125;&#125; &#123;&#123; delay &#125;&#125; &#123;&#123; easing &#125;&#125;"</span>)</span><br><span class="line">  ],</span><br><span class="line">  &#123;</span><br><span class="line">    params: &#123;</span><br><span class="line">      duration: <span class="string">"400ms"</span>,</span><br><span class="line">      delay: <span class="string">"0s"</span>,</span><br><span class="line">      easing: <span class="string">"ease-out"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">transition(<span class="string">":enter"</span>, useAnimation(slideInUp, &#123;<span class="attr">params</span>: &#123;<span class="attr">delay</span>: <span class="string">"1s"</span>&#125;&#125;))</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="41-query方法的使用-1"><a href="#41-query方法的使用-1" class="headerlink" title="41.query方法的使用"></a>41.query方法的使用</h3><p>Angular 中提供了 <code>query</code> 方法查找元素并为元素创建动画</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; slide &#125; <span class="keyword">from</span> <span class="string">"./animations"</span></span><br><span class="line"></span><br><span class="line">animations: [</span><br><span class="line">  slide,</span><br><span class="line">  trigger(<span class="string">"todoAnimations"</span>, [</span><br><span class="line">    transition(<span class="string">":enter"</span>, [</span><br><span class="line">      query(<span class="string">"h2"</span>, [</span><br><span class="line">        style(&#123; <span class="attr">transform</span>: <span class="string">"translateY(-30px)"</span> &#125;),</span><br><span class="line">        animate(<span class="number">300</span>)</span><br><span class="line">      ]),</span><br><span class="line">      <span class="comment">// 查询子级动画 使其执行</span></span><br><span class="line">      query(<span class="string">"@slide"</span>, animateChild())</span><br><span class="line">    ])</span><br><span class="line">  ])</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span> @<span class="attr">todoAnimations</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Todos<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"list-group"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span></span></span><br><span class="line"><span class="tag">      @<span class="attr">slide</span></span></span><br><span class="line"><span class="tag">      (<span class="attr">click</span>)=<span class="string">"removeItem(i)"</span></span></span><br><span class="line"><span class="tag">      *<span class="attr">ngFor</span>=<span class="string">"let item of todos; let i = index"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"list-group-item"</span></span></span><br><span class="line"><span class="tag">    &gt;</span></span><br><span class="line">      &#123;&#123; item &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="42-group方法的使用-1"><a href="#42-group方法的使用-1" class="headerlink" title="42.group方法的使用"></a>42.group方法的使用</h3><p>默认情况下，父级动画和子级动画按照顺序执行，先执行父级动画，再执行子级动画，可以使用  <code>group</code> 方法让其并行</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">trigger(<span class="string">"todoAnimations"</span>, [</span><br><span class="line">  transition(<span class="string">":enter"</span>, [</span><br><span class="line">    group([</span><br><span class="line">      query(<span class="string">"h2"</span>, [</span><br><span class="line">        style(&#123; <span class="attr">transform</span>: <span class="string">"translateY(-30px)"</span> &#125;),</span><br><span class="line">        animate(<span class="number">300</span>)</span><br><span class="line">      ]),</span><br><span class="line">      query(<span class="string">"@slide"</span>, animateChild())</span><br><span class="line">    ])</span><br><span class="line">  ])</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
<h3 id="43-使用stagger方法实现交错动画-1"><a href="#43-使用stagger方法实现交错动画-1" class="headerlink" title="43.使用stagger方法实现交错动画"></a>43.使用stagger方法实现交错动画</h3><p>Angular 提供了 stagger 方法，在多个元素同时执行同一个动画时，让每个元素动画的执行依次延迟。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">transition(<span class="string">":enter"</span>, [</span><br><span class="line">  group([</span><br><span class="line">    query(<span class="string">"h2"</span>, [</span><br><span class="line">      style(&#123; <span class="attr">transform</span>: <span class="string">"translateY(-30px)"</span> &#125;),</span><br><span class="line">      animate(<span class="number">300</span>)</span><br><span class="line">    ]),</span><br><span class="line">    query(<span class="string">"@slide"</span>, stagger(<span class="number">200</span>, animateChild()))</span><br><span class="line">  ])</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<p>注意：stagger 方法只能在 query 方法内部使用</p>
<h3 id="44-创建自定义状态动画-1"><a href="#44-创建自定义状态动画-1" class="headerlink" title="44.创建自定义状态动画"></a>44.创建自定义状态动画</h3><p>Angular 提供了 <code>state</code> 方法用于定义状态。</p>
<ol>
<li><p>默认代码解析</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel panel-default"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-heading"</span> (<span class="attr">click</span>)=<span class="string">"toggle()"</span>&gt;</span></span><br><span class="line">      一套框架, 多种平台, 移动端 &amp; 桌面端</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">        使用简单的声明式模板，快速实现各种特性。使用自定义组件和大量现有组件，扩展模板语言。在几乎所有的</span><br><span class="line">        IDE 中获得针对 Angular</span><br><span class="line">        的即时帮助和反馈。所有这一切，都是为了帮助你编写漂亮的应用，而不是绞尽脑汁的让代码“能用”。</span><br><span class="line">      <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">        从原型到全球部署，Angular 都能带给你支撑 Google</span><br><span class="line">        大型应用的那些高延展性基础设施与技术。</span><br><span class="line">      <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">        通过 Web Worker 和服务端渲染，达到在如今(以及未来）的 Web</span><br><span class="line">        平台上所能达到的最高速度。 Angular 让你有效掌控可伸缩性。基于</span><br><span class="line">        RxJS、Immutable.js 和其它推送模型，能适应海量数据需求。</span><br><span class="line">      <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">        学会用 Angular</span><br><span class="line">        构建应用，然后把这些代码和能力复用在多种多种不同平台的应用上 ——</span><br><span class="line">        Web、移动 Web、移动应用、原生应用和桌面原生应用。</span><br><span class="line">      <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">  <span class="selector-class">.container</span> &#123;</span></span><br><span class="line">    margin-top: 100px;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="css">  <span class="selector-class">.panel-heading</span> &#123;</span></span><br><span class="line">    cursor: pointer;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component &#125; <span class="keyword">from</span> <span class="string">"@angular/core"</span></span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">"app-root"</span>,</span><br><span class="line">  templateUrl: <span class="string">"./app.component.html"</span>,</span><br><span class="line">  styles: []</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  isExpended: boolean = <span class="literal">false</span></span><br><span class="line">  toggle() &#123;</span><br><span class="line">    <span class="keyword">this</span>.isExpended = !<span class="keyword">this</span>.isExpended</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建动画</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">trigger(<span class="string">"expandCollapse"</span>, [</span><br><span class="line">  <span class="comment">// 使用 state 方法定义折叠状态元素对应的样式</span></span><br><span class="line">  state(</span><br><span class="line">    <span class="string">"collapsed"</span>,</span><br><span class="line">    style(&#123;</span><br><span class="line">      height: <span class="number">0</span>,</span><br><span class="line">      overflow: <span class="string">"hidden"</span>,</span><br><span class="line">      paddingTop: <span class="number">0</span>,</span><br><span class="line">      paddingBottom: <span class="number">0</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ),</span><br><span class="line">  <span class="comment">// 使用 state 方法定义展开状态元素对应的样式</span></span><br><span class="line">  state(<span class="string">"expanded"</span>, style(&#123; <span class="attr">height</span>: <span class="string">"*"</span>, <span class="attr">overflow</span>: <span class="string">"auto"</span> &#125;)),</span><br><span class="line">  <span class="comment">// 定义展开动画</span></span><br><span class="line">  transition(<span class="string">"collapsed =&gt; expanded"</span>, animate(<span class="string">"400ms ease-out"</span>)),</span><br><span class="line">  <span class="comment">// 定义折叠动画</span></span><br><span class="line">  transition(<span class="string">"expanded =&gt; collapsed"</span>, animate(<span class="string">"400ms ease-in"</span>))</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span> [@<span class="attr">expandCollapse</span>]=<span class="string">"isExpended ? 'expanded' : 'collapsed'"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="45-实现路由动画-8"><a href="#45-实现路由动画-8" class="headerlink" title="45.实现路由动画"></a>45.实现路由动画</h3><ol>
<li><p>为路由添加状态标识，此标识即为路由执行动画时的自定义状态</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> routes: Routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">""</span>,</span><br><span class="line">    component: HomeComponent,</span><br><span class="line">    pathMatch: <span class="string">"full"</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"one"</span> </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"about"</span>,</span><br><span class="line">    component: AboutComponent,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"two"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"news"</span>,</span><br><span class="line">    component: NewsComponent,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"three"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过路由插座对象获取路由状态标识，并将标识传递给动画的调用者，让动画执行当前要执行的状态是什么</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"routerContainer"</span> [@<span class="attr">routerAnimations</span>]=<span class="string">"prepareRoute(outlet)"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">router-outlet</span> #<span class="attr">outlet</span>=<span class="string">"outlet"</span>&gt;</span><span class="tag">&lt;/<span class="name">router-outlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; RouterOutlet &#125; <span class="keyword">from</span> <span class="string">"@angular/router"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  prepareRoute(outlet: RouterOutlet) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      outlet &amp;&amp;</span><br><span class="line">      outlet.activatedRouteData &amp;&amp;</span><br><span class="line">      outlet.activatedRouteData.animation</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>将 routerContainer 设置为相对定位，将它的直接一级子元素设置成绝对定位</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* styles.css */</span></span><br><span class="line"><span class="selector-class">.routerContainer</span> &#123;</span><br><span class="line">  <span class="attribute">position</span>: relative;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.routerContainer</span> &gt; * &#123;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建动画</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">trigger(<span class="string">"routerAnimations"</span>, [</span><br><span class="line">  transition(<span class="string">"one =&gt; two, one =&gt; three, two =&gt; three"</span>, [</span><br><span class="line">    query(<span class="string">":enter"</span>, style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(100%)"</span>, <span class="attr">opacity</span>: <span class="number">0</span> &#125;)),</span><br><span class="line">    group([</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":enter"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-in"</span>,</span><br><span class="line">          style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(0)"</span>, <span class="attr">opacity</span>: <span class="number">1</span> &#125;)</span><br><span class="line">        )</span><br><span class="line">      ),</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":leave"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-out"</span>,</span><br><span class="line">          style(&#123;</span><br><span class="line">            transform: <span class="string">"translateX(-100%)"</span>,</span><br><span class="line">            opacity: <span class="number">0</span></span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    ])</span><br><span class="line">  ]),</span><br><span class="line">  transition(<span class="string">"three =&gt; two, three =&gt; one, two =&gt; one"</span>, [</span><br><span class="line">    query(</span><br><span class="line">      <span class="string">":enter"</span>,</span><br><span class="line">      style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(-100%)"</span>, <span class="attr">opacity</span>: <span class="number">0</span> &#125;)</span><br><span class="line">    ),</span><br><span class="line">    group([</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":enter"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-in"</span>,</span><br><span class="line">          style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(0)"</span>, <span class="attr">opacity</span>: <span class="number">1</span> &#125;)</span><br><span class="line">        )</span><br><span class="line">      ),</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":leave"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-out"</span>,</span><br><span class="line">          style(&#123;</span><br><span class="line">            transform: <span class="string">"translateX(100%)"</span>,</span><br><span class="line">            opacity: <span class="number">0</span></span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    ])</span><br><span class="line">  ])</span><br><span class="line">])</span><br><span class="line"><span class="string">``</span><span class="string">`     .container &#123;</span></span><br><span class="line"><span class="string">    margin-top: 100px;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  .panel-heading &#123;</span></span><br><span class="line"><span class="string">    cursor: pointer;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&lt;/style&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component &#125; <span class="keyword">from</span> <span class="string">"@angular/core"</span></span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">"app-root"</span>,</span><br><span class="line">  templateUrl: <span class="string">"./app.component.html"</span>,</span><br><span class="line">  styles: []</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  isExpended: boolean = <span class="literal">false</span></span><br><span class="line">  toggle() &#123;</span><br><span class="line">    <span class="keyword">this</span>.isExpended = !<span class="keyword">this</span>.isExpended</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建动画</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">trigger(<span class="string">"expandCollapse"</span>, [</span><br><span class="line">  <span class="comment">// 使用 state 方法定义折叠状态元素对应的样式</span></span><br><span class="line">  state(</span><br><span class="line">    <span class="string">"collapsed"</span>,</span><br><span class="line">    style(&#123;</span><br><span class="line">      height: <span class="number">0</span>,</span><br><span class="line">      overflow: <span class="string">"hidden"</span>,</span><br><span class="line">      paddingTop: <span class="number">0</span>,</span><br><span class="line">      paddingBottom: <span class="number">0</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ),</span><br><span class="line">  <span class="comment">// 使用 state 方法定义展开状态元素对应的样式</span></span><br><span class="line">  state(<span class="string">"expanded"</span>, style(&#123; <span class="attr">height</span>: <span class="string">"*"</span>, <span class="attr">overflow</span>: <span class="string">"auto"</span> &#125;)),</span><br><span class="line">  <span class="comment">// 定义展开动画</span></span><br><span class="line">  transition(<span class="string">"collapsed =&gt; expanded"</span>, animate(<span class="string">"400ms ease-out"</span>)),</span><br><span class="line">  <span class="comment">// 定义折叠动画</span></span><br><span class="line">  transition(<span class="string">"expanded =&gt; collapsed"</span>, animate(<span class="string">"400ms ease-in"</span>))</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span> [@<span class="attr">expandCollapse</span>]=<span class="string">"isExpended ? 'expanded' : 'collapsed'"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="45-实现路由动画-9"><a href="#45-实现路由动画-9" class="headerlink" title="45.实现路由动画"></a>45.实现路由动画</h3><ol>
<li><p>为路由添加状态标识，此标识即为路由执行动画时的自定义状态</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> routes: Routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">""</span>,</span><br><span class="line">    component: HomeComponent,</span><br><span class="line">    pathMatch: <span class="string">"full"</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"one"</span> </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"about"</span>,</span><br><span class="line">    component: AboutComponent,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"two"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"news"</span>,</span><br><span class="line">    component: NewsComponent,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"three"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过路由插座对象获取路由状态标识，并将标识传递给动画的调用者，让动画执行当前要执行的状态是什么</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"routerContainer"</span> [@<span class="attr">routerAnimations</span>]=<span class="string">"prepareRoute(outlet)"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">router-outlet</span> #<span class="attr">outlet</span>=<span class="string">"outlet"</span>&gt;</span><span class="tag">&lt;/<span class="name">router-outlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; RouterOutlet &#125; <span class="keyword">from</span> <span class="string">"@angular/router"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  prepareRoute(outlet: RouterOutlet) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      outlet &amp;&amp;</span><br><span class="line">      outlet.activatedRouteData &amp;&amp;</span><br><span class="line">      outlet.activatedRouteData.animation</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>将 routerContainer 设置为相对定位，将它的直接一级子元素设置成绝对定位</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* styles.css */</span></span><br><span class="line"><span class="selector-class">.routerContainer</span> &#123;</span><br><span class="line">  <span class="attribute">position</span>: relative;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.routerContainer</span> &gt; * &#123;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建动画</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">trigger(<span class="string">"routerAnimations"</span>, [</span><br><span class="line">  transition(<span class="string">"one =&gt; two, one =&gt; three, two =&gt; three"</span>, [</span><br><span class="line">    query(<span class="string">":enter"</span>, style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(100%)"</span>, <span class="attr">opacity</span>: <span class="number">0</span> &#125;)),</span><br><span class="line">    group([</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":enter"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-in"</span>,</span><br><span class="line">          style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(0)"</span>, <span class="attr">opacity</span>: <span class="number">1</span> &#125;)</span><br><span class="line">        )</span><br><span class="line">      ),</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":leave"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-out"</span>,</span><br><span class="line">          style(&#123;</span><br><span class="line">            transform: <span class="string">"translateX(-100%)"</span>,</span><br><span class="line">            opacity: <span class="number">0</span></span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    ])</span><br><span class="line">  ]),</span><br><span class="line">  transition(<span class="string">"three =&gt; two, three =&gt; one, two =&gt; one"</span>, [</span><br><span class="line">    query(</span><br><span class="line">      <span class="string">":enter"</span>,</span><br><span class="line">      style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(-100%)"</span>, <span class="attr">opacity</span>: <span class="number">0</span> &#125;)</span><br><span class="line">    ),</span><br><span class="line">    group([</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":enter"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-in"</span>,</span><br><span class="line">          style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(0)"</span>, <span class="attr">opacity</span>: <span class="number">1</span> &#125;)</span><br><span class="line">        )</span><br><span class="line">      ),</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":leave"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-out"</span>,</span><br><span class="line">          style(&#123;</span><br><span class="line">            transform: <span class="string">"translateX(100%)"</span>,</span><br><span class="line">            opacity: <span class="number">0</span></span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    ])</span><br><span class="line">  ])</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
<p>  .container {</p>
<pre><code>margin-top: 100px;</code></pre><p>  }<br>  .panel-heading {</p>
<pre><code>cursor: pointer;</code></pre><p>  }<br></style></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#96;&#96;&#96;javascript</span><br><span class="line">import &#123; Component &#125; from &quot;@angular&#x2F;core&quot;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: &quot;app-root&quot;,</span><br><span class="line">  templateUrl: &quot;.&#x2F;app.component.html&quot;,</span><br><span class="line">  styles: []</span><br><span class="line">&#125;)</span><br><span class="line">export class AppComponent &#123;</span><br><span class="line">  isExpended: boolean &#x3D; false</span><br><span class="line">  toggle() &#123;</span><br><span class="line">    this.isExpended &#x3D; !this.isExpended</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建动画</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">trigger(<span class="string">"expandCollapse"</span>, [</span><br><span class="line">  <span class="comment">// 使用 state 方法定义折叠状态元素对应的样式</span></span><br><span class="line">  state(</span><br><span class="line">    <span class="string">"collapsed"</span>,</span><br><span class="line">    style(&#123;</span><br><span class="line">      height: <span class="number">0</span>,</span><br><span class="line">      overflow: <span class="string">"hidden"</span>,</span><br><span class="line">      paddingTop: <span class="number">0</span>,</span><br><span class="line">      paddingBottom: <span class="number">0</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ),</span><br><span class="line">  <span class="comment">// 使用 state 方法定义展开状态元素对应的样式</span></span><br><span class="line">  state(<span class="string">"expanded"</span>, style(&#123; <span class="attr">height</span>: <span class="string">"*"</span>, <span class="attr">overflow</span>: <span class="string">"auto"</span> &#125;)),</span><br><span class="line">  <span class="comment">// 定义展开动画</span></span><br><span class="line">  transition(<span class="string">"collapsed =&gt; expanded"</span>, animate(<span class="string">"400ms ease-out"</span>)),</span><br><span class="line">  <span class="comment">// 定义折叠动画</span></span><br><span class="line">  transition(<span class="string">"expanded =&gt; collapsed"</span>, animate(<span class="string">"400ms ease-in"</span>))</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span> [@<span class="attr">expandCollapse</span>]=<span class="string">"isExpended ? 'expanded' : 'collapsed'"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="45-实现路由动画-10"><a href="#45-实现路由动画-10" class="headerlink" title="45.实现路由动画"></a>45.实现路由动画</h3><ol>
<li><p>为路由添加状态标识，此标识即为路由执行动画时的自定义状态</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> routes: Routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">""</span>,</span><br><span class="line">    component: HomeComponent,</span><br><span class="line">    pathMatch: <span class="string">"full"</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"one"</span> </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"about"</span>,</span><br><span class="line">    component: AboutComponent,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"two"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"news"</span>,</span><br><span class="line">    component: NewsComponent,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"three"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过路由插座对象获取路由状态标识，并将标识传递给动画的调用者，让动画执行当前要执行的状态是什么</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"routerContainer"</span> [@<span class="attr">routerAnimations</span>]=<span class="string">"prepareRoute(outlet)"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">router-outlet</span> #<span class="attr">outlet</span>=<span class="string">"outlet"</span>&gt;</span><span class="tag">&lt;/<span class="name">router-outlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; RouterOutlet &#125; <span class="keyword">from</span> <span class="string">"@angular/router"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  prepareRoute(outlet: RouterOutlet) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      outlet &amp;&amp;</span><br><span class="line">      outlet.activatedRouteData &amp;&amp;</span><br><span class="line">      outlet.activatedRouteData.animation</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>将 routerContainer 设置为相对定位，将它的直接一级子元素设置成绝对定位</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* styles.css */</span></span><br><span class="line"><span class="selector-class">.routerContainer</span> &#123;</span><br><span class="line">  <span class="attribute">position</span>: relative;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.routerContainer</span> &gt; * &#123;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建动画</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">trigger(<span class="string">"routerAnimations"</span>, [</span><br><span class="line">  transition(<span class="string">"one =&gt; two, one =&gt; three, two =&gt; three"</span>, [</span><br><span class="line">    query(<span class="string">":enter"</span>, style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(100%)"</span>, <span class="attr">opacity</span>: <span class="number">0</span> &#125;)),</span><br><span class="line">    group([</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":enter"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-in"</span>,</span><br><span class="line">          style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(0)"</span>, <span class="attr">opacity</span>: <span class="number">1</span> &#125;)</span><br><span class="line">        )</span><br><span class="line">      ),</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":leave"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-out"</span>,</span><br><span class="line">          style(&#123;</span><br><span class="line">            transform: <span class="string">"translateX(-100%)"</span>,</span><br><span class="line">            opacity: <span class="number">0</span></span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    ])</span><br><span class="line">  ]),</span><br><span class="line">  transition(<span class="string">"three =&gt; two, three =&gt; one, two =&gt; one"</span>, [</span><br><span class="line">    query(</span><br><span class="line">      <span class="string">":enter"</span>,</span><br><span class="line">      style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(-100%)"</span>, <span class="attr">opacity</span>: <span class="number">0</span> &#125;)</span><br><span class="line">    ),</span><br><span class="line">    group([</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":enter"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-in"</span>,</span><br><span class="line">          style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(0)"</span>, <span class="attr">opacity</span>: <span class="number">1</span> &#125;)</span><br><span class="line">        )</span><br><span class="line">      ),</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":leave"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-out"</span>,</span><br><span class="line">          style(&#123;</span><br><span class="line">            transform: <span class="string">"translateX(100%)"</span>,</span><br><span class="line">            opacity: <span class="number">0</span></span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    ])</span><br><span class="line">  ])</span><br><span class="line">])</span><br><span class="line"><span class="string">``</span><span class="string">`     .container &#123;</span></span><br><span class="line"><span class="string">    margin-top: 100px;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  .panel-heading &#123;</span></span><br><span class="line"><span class="string">    cursor: pointer;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&lt;/style&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component &#125; <span class="keyword">from</span> <span class="string">"@angular/core"</span></span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">"app-root"</span>,</span><br><span class="line">  templateUrl: <span class="string">"./app.component.html"</span>,</span><br><span class="line">  styles: []</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  isExpended: boolean = <span class="literal">false</span></span><br><span class="line">  toggle() &#123;</span><br><span class="line">    <span class="keyword">this</span>.isExpended = !<span class="keyword">this</span>.isExpended</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建动画</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">trigger(<span class="string">"expandCollapse"</span>, [</span><br><span class="line">  <span class="comment">// 使用 state 方法定义折叠状态元素对应的样式</span></span><br><span class="line">  state(</span><br><span class="line">    <span class="string">"collapsed"</span>,</span><br><span class="line">    style(&#123;</span><br><span class="line">      height: <span class="number">0</span>,</span><br><span class="line">      overflow: <span class="string">"hidden"</span>,</span><br><span class="line">      paddingTop: <span class="number">0</span>,</span><br><span class="line">      paddingBottom: <span class="number">0</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ),</span><br><span class="line">  <span class="comment">// 使用 state 方法定义展开状态元素对应的样式</span></span><br><span class="line">  state(<span class="string">"expanded"</span>, style(&#123; <span class="attr">height</span>: <span class="string">"*"</span>, <span class="attr">overflow</span>: <span class="string">"auto"</span> &#125;)),</span><br><span class="line">  <span class="comment">// 定义展开动画</span></span><br><span class="line">  transition(<span class="string">"collapsed =&gt; expanded"</span>, animate(<span class="string">"400ms ease-out"</span>)),</span><br><span class="line">  <span class="comment">// 定义折叠动画</span></span><br><span class="line">  transition(<span class="string">"expanded =&gt; collapsed"</span>, animate(<span class="string">"400ms ease-in"</span>))</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span> [@<span class="attr">expandCollapse</span>]=<span class="string">"isExpended ? 'expanded' : 'collapsed'"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="45-实现路由动画-11"><a href="#45-实现路由动画-11" class="headerlink" title="45.实现路由动画"></a>45.实现路由动画</h3><ol>
<li><p>为路由添加状态标识，此标识即为路由执行动画时的自定义状态</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> routes: Routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">""</span>,</span><br><span class="line">    component: HomeComponent,</span><br><span class="line">    pathMatch: <span class="string">"full"</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"one"</span> </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"about"</span>,</span><br><span class="line">    component: AboutComponent,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"two"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"news"</span>,</span><br><span class="line">    component: NewsComponent,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"three"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过路由插座对象获取路由状态标识，并将标识传递给动画的调用者，让动画执行当前要执行的状态是什么</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"routerContainer"</span> [@<span class="attr">routerAnimations</span>]=<span class="string">"prepareRoute(outlet)"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">router-outlet</span> #<span class="attr">outlet</span>=<span class="string">"outlet"</span>&gt;</span><span class="tag">&lt;/<span class="name">router-outlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; RouterOutlet &#125; <span class="keyword">from</span> <span class="string">"@angular/router"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  prepareRoute(outlet: RouterOutlet) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      outlet &amp;&amp;</span><br><span class="line">      outlet.activatedRouteData &amp;&amp;</span><br><span class="line">      outlet.activatedRouteData.animation</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>将 routerContainer 设置为相对定位，将它的直接一级子元素设置成绝对定位</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* styles.css */</span></span><br><span class="line"><span class="selector-class">.routerContainer</span> &#123;</span><br><span class="line">  <span class="attribute">position</span>: relative;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.routerContainer</span> &gt; * &#123;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建动画</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">trigger(<span class="string">"routerAnimations"</span>, [</span><br><span class="line">  transition(<span class="string">"one =&gt; two, one =&gt; three, two =&gt; three"</span>, [</span><br><span class="line">    query(<span class="string">":enter"</span>, style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(100%)"</span>, <span class="attr">opacity</span>: <span class="number">0</span> &#125;)),</span><br><span class="line">    group([</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":enter"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-in"</span>,</span><br><span class="line">          style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(0)"</span>, <span class="attr">opacity</span>: <span class="number">1</span> &#125;)</span><br><span class="line">        )</span><br><span class="line">      ),</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":leave"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-out"</span>,</span><br><span class="line">          style(&#123;</span><br><span class="line">            transform: <span class="string">"translateX(-100%)"</span>,</span><br><span class="line">            opacity: <span class="number">0</span></span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    ])</span><br><span class="line">  ]),</span><br><span class="line">  transition(<span class="string">"three =&gt; two, three =&gt; one, two =&gt; one"</span>, [</span><br><span class="line">    query(</span><br><span class="line">      <span class="string">":enter"</span>,</span><br><span class="line">      style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(-100%)"</span>, <span class="attr">opacity</span>: <span class="number">0</span> &#125;)</span><br><span class="line">    ),</span><br><span class="line">    group([</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":enter"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-in"</span>,</span><br><span class="line">          style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(0)"</span>, <span class="attr">opacity</span>: <span class="number">1</span> &#125;)</span><br><span class="line">        )</span><br><span class="line">      ),</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":leave"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-out"</span>,</span><br><span class="line">          style(&#123;</span><br><span class="line">            transform: <span class="string">"translateX(100%)"</span>,</span><br><span class="line">            opacity: <span class="number">0</span></span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    ])</span><br><span class="line">  ])</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<p>  .container {</p>
<pre><code>margin-top: 100px;</code></pre><p>  }<br>  .panel-heading {</p>
<pre><code>cursor: pointer;</code></pre><p>  }<br></style></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#96;&#96;&#96;javascript</span><br><span class="line">import &#123; Component &#125; from &quot;@angular&#x2F;core&quot;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: &quot;app-root&quot;,</span><br><span class="line">  templateUrl: &quot;.&#x2F;app.component.html&quot;,</span><br><span class="line">  styles: []</span><br><span class="line">&#125;)</span><br><span class="line">export class AppComponent &#123;</span><br><span class="line">  isExpended: boolean &#x3D; false</span><br><span class="line">  toggle() &#123;</span><br><span class="line">    this.isExpended &#x3D; !this.isExpended</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建动画</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">trigger(<span class="string">"expandCollapse"</span>, [</span><br><span class="line">  <span class="comment">// 使用 state 方法定义折叠状态元素对应的样式</span></span><br><span class="line">  state(</span><br><span class="line">    <span class="string">"collapsed"</span>,</span><br><span class="line">    style(&#123;</span><br><span class="line">      height: <span class="number">0</span>,</span><br><span class="line">      overflow: <span class="string">"hidden"</span>,</span><br><span class="line">      paddingTop: <span class="number">0</span>,</span><br><span class="line">      paddingBottom: <span class="number">0</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ),</span><br><span class="line">  <span class="comment">// 使用 state 方法定义展开状态元素对应的样式</span></span><br><span class="line">  state(<span class="string">"expanded"</span>, style(&#123; <span class="attr">height</span>: <span class="string">"*"</span>, <span class="attr">overflow</span>: <span class="string">"auto"</span> &#125;)),</span><br><span class="line">  <span class="comment">// 定义展开动画</span></span><br><span class="line">  transition(<span class="string">"collapsed =&gt; expanded"</span>, animate(<span class="string">"400ms ease-out"</span>)),</span><br><span class="line">  <span class="comment">// 定义折叠动画</span></span><br><span class="line">  transition(<span class="string">"expanded =&gt; collapsed"</span>, animate(<span class="string">"400ms ease-in"</span>))</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span> [@<span class="attr">expandCollapse</span>]=<span class="string">"isExpended ? 'expanded' : 'collapsed'"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="45-实现路由动画-12"><a href="#45-实现路由动画-12" class="headerlink" title="45.实现路由动画"></a>45.实现路由动画</h3><ol>
<li><p>为路由添加状态标识，此标识即为路由执行动画时的自定义状态</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> routes: Routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">""</span>,</span><br><span class="line">    component: HomeComponent,</span><br><span class="line">    pathMatch: <span class="string">"full"</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"one"</span> </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"about"</span>,</span><br><span class="line">    component: AboutComponent,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"two"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"news"</span>,</span><br><span class="line">    component: NewsComponent,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"three"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过路由插座对象获取路由状态标识，并将标识传递给动画的调用者，让动画执行当前要执行的状态是什么</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"routerContainer"</span> [@<span class="attr">routerAnimations</span>]=<span class="string">"prepareRoute(outlet)"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">router-outlet</span> #<span class="attr">outlet</span>=<span class="string">"outlet"</span>&gt;</span><span class="tag">&lt;/<span class="name">router-outlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; RouterOutlet &#125; <span class="keyword">from</span> <span class="string">"@angular/router"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  prepareRoute(outlet: RouterOutlet) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      outlet &amp;&amp;</span><br><span class="line">      outlet.activatedRouteData &amp;&amp;</span><br><span class="line">      outlet.activatedRouteData.animation</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>将 routerContainer 设置为相对定位，将它的直接一级子元素设置成绝对定位</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* styles.css */</span></span><br><span class="line"><span class="selector-class">.routerContainer</span> &#123;</span><br><span class="line">  <span class="attribute">position</span>: relative;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.routerContainer</span> &gt; * &#123;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建动画</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">trigger(<span class="string">"routerAnimations"</span>, [</span><br><span class="line">  transition(<span class="string">"one =&gt; two, one =&gt; three, two =&gt; three"</span>, [</span><br><span class="line">    query(<span class="string">":enter"</span>, style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(100%)"</span>, <span class="attr">opacity</span>: <span class="number">0</span> &#125;)),</span><br><span class="line">    group([</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":enter"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-in"</span>,</span><br><span class="line">          style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(0)"</span>, <span class="attr">opacity</span>: <span class="number">1</span> &#125;)</span><br><span class="line">        )</span><br><span class="line">      ),</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":leave"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-out"</span>,</span><br><span class="line">          style(&#123;</span><br><span class="line">            transform: <span class="string">"translateX(-100%)"</span>,</span><br><span class="line">            opacity: <span class="number">0</span></span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    ])</span><br><span class="line">  ]),</span><br><span class="line">  transition(<span class="string">"three =&gt; two, three =&gt; one, two =&gt; one"</span>, [</span><br><span class="line">    query(</span><br><span class="line">      <span class="string">":enter"</span>,</span><br><span class="line">      style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(-100%)"</span>, <span class="attr">opacity</span>: <span class="number">0</span> &#125;)</span><br><span class="line">    ),</span><br><span class="line">    group([</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":enter"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-in"</span>,</span><br><span class="line">          style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(0)"</span>, <span class="attr">opacity</span>: <span class="number">1</span> &#125;)</span><br><span class="line">        )</span><br><span class="line">      ),</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":leave"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-out"</span>,</span><br><span class="line">          style(&#123;</span><br><span class="line">            transform: <span class="string">"translateX(100%)"</span>,</span><br><span class="line">            opacity: <span class="number">0</span></span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    ])</span><br><span class="line">  ])</span><br><span class="line">])</span><br><span class="line"><span class="string">``</span><span class="string">`     .container &#123;</span></span><br><span class="line"><span class="string">    margin-top: 100px;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  .panel-heading &#123;</span></span><br><span class="line"><span class="string">    cursor: pointer;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&lt;/style&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component &#125; <span class="keyword">from</span> <span class="string">"@angular/core"</span></span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">"app-root"</span>,</span><br><span class="line">  templateUrl: <span class="string">"./app.component.html"</span>,</span><br><span class="line">  styles: []</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  isExpended: boolean = <span class="literal">false</span></span><br><span class="line">  toggle() &#123;</span><br><span class="line">    <span class="keyword">this</span>.isExpended = !<span class="keyword">this</span>.isExpended</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建动画</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">trigger(<span class="string">"expandCollapse"</span>, [</span><br><span class="line">  <span class="comment">// 使用 state 方法定义折叠状态元素对应的样式</span></span><br><span class="line">  state(</span><br><span class="line">    <span class="string">"collapsed"</span>,</span><br><span class="line">    style(&#123;</span><br><span class="line">      height: <span class="number">0</span>,</span><br><span class="line">      overflow: <span class="string">"hidden"</span>,</span><br><span class="line">      paddingTop: <span class="number">0</span>,</span><br><span class="line">      paddingBottom: <span class="number">0</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ),</span><br><span class="line">  <span class="comment">// 使用 state 方法定义展开状态元素对应的样式</span></span><br><span class="line">  state(<span class="string">"expanded"</span>, style(&#123; <span class="attr">height</span>: <span class="string">"*"</span>, <span class="attr">overflow</span>: <span class="string">"auto"</span> &#125;)),</span><br><span class="line">  <span class="comment">// 定义展开动画</span></span><br><span class="line">  transition(<span class="string">"collapsed =&gt; expanded"</span>, animate(<span class="string">"400ms ease-out"</span>)),</span><br><span class="line">  <span class="comment">// 定义折叠动画</span></span><br><span class="line">  transition(<span class="string">"expanded =&gt; collapsed"</span>, animate(<span class="string">"400ms ease-in"</span>))</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span> [@<span class="attr">expandCollapse</span>]=<span class="string">"isExpended ? 'expanded' : 'collapsed'"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="45-实现路由动画-13"><a href="#45-实现路由动画-13" class="headerlink" title="45.实现路由动画"></a>45.实现路由动画</h3><ol>
<li><p>为路由添加状态标识，此标识即为路由执行动画时的自定义状态</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> routes: Routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">""</span>,</span><br><span class="line">    component: HomeComponent,</span><br><span class="line">    pathMatch: <span class="string">"full"</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"one"</span> </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"about"</span>,</span><br><span class="line">    component: AboutComponent,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"two"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"news"</span>,</span><br><span class="line">    component: NewsComponent,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"three"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过路由插座对象获取路由状态标识，并将标识传递给动画的调用者，让动画执行当前要执行的状态是什么</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"routerContainer"</span> [@<span class="attr">routerAnimations</span>]=<span class="string">"prepareRoute(outlet)"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">router-outlet</span> #<span class="attr">outlet</span>=<span class="string">"outlet"</span>&gt;</span><span class="tag">&lt;/<span class="name">router-outlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; RouterOutlet &#125; <span class="keyword">from</span> <span class="string">"@angular/router"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  prepareRoute(outlet: RouterOutlet) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      outlet &amp;&amp;</span><br><span class="line">      outlet.activatedRouteData &amp;&amp;</span><br><span class="line">      outlet.activatedRouteData.animation</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>将 routerContainer 设置为相对定位，将它的直接一级子元素设置成绝对定位</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* styles.css */</span></span><br><span class="line"><span class="selector-class">.routerContainer</span> &#123;</span><br><span class="line">  <span class="attribute">position</span>: relative;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.routerContainer</span> &gt; * &#123;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建动画</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">trigger(<span class="string">"routerAnimations"</span>, [</span><br><span class="line">  transition(<span class="string">"one =&gt; two, one =&gt; three, two =&gt; three"</span>, [</span><br><span class="line">    query(<span class="string">":enter"</span>, style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(100%)"</span>, <span class="attr">opacity</span>: <span class="number">0</span> &#125;)),</span><br><span class="line">    group([</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":enter"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-in"</span>,</span><br><span class="line">          style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(0)"</span>, <span class="attr">opacity</span>: <span class="number">1</span> &#125;)</span><br><span class="line">        )</span><br><span class="line">      ),</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":leave"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-out"</span>,</span><br><span class="line">          style(&#123;</span><br><span class="line">            transform: <span class="string">"translateX(-100%)"</span>,</span><br><span class="line">            opacity: <span class="number">0</span></span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    ])</span><br><span class="line">  ]),</span><br><span class="line">  transition(<span class="string">"three =&gt; two, three =&gt; one, two =&gt; one"</span>, [</span><br><span class="line">    query(</span><br><span class="line">      <span class="string">":enter"</span>,</span><br><span class="line">      style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(-100%)"</span>, <span class="attr">opacity</span>: <span class="number">0</span> &#125;)</span><br><span class="line">    ),</span><br><span class="line">    group([</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":enter"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-in"</span>,</span><br><span class="line">          style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(0)"</span>, <span class="attr">opacity</span>: <span class="number">1</span> &#125;)</span><br><span class="line">        )</span><br><span class="line">      ),</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":leave"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-out"</span>,</span><br><span class="line">          style(&#123;</span><br><span class="line">            transform: <span class="string">"translateX(100%)"</span>,</span><br><span class="line">            opacity: <span class="number">0</span></span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    ])</span><br><span class="line">  ])</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
<p>  .container {</p>
<pre><code>margin-top: 100px;</code></pre><p>  }<br>  .panel-heading {</p>
<pre><code>cursor: pointer;</code></pre><p>  }<br></style></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#96;&#96;&#96;javascript</span><br><span class="line">import &#123; Component &#125; from &quot;@angular&#x2F;core&quot;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: &quot;app-root&quot;,</span><br><span class="line">  templateUrl: &quot;.&#x2F;app.component.html&quot;,</span><br><span class="line">  styles: []</span><br><span class="line">&#125;)</span><br><span class="line">export class AppComponent &#123;</span><br><span class="line">  isExpended: boolean &#x3D; false</span><br><span class="line">  toggle() &#123;</span><br><span class="line">    this.isExpended &#x3D; !this.isExpended</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建动画</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">trigger(<span class="string">"expandCollapse"</span>, [</span><br><span class="line">  <span class="comment">// 使用 state 方法定义折叠状态元素对应的样式</span></span><br><span class="line">  state(</span><br><span class="line">    <span class="string">"collapsed"</span>,</span><br><span class="line">    style(&#123;</span><br><span class="line">      height: <span class="number">0</span>,</span><br><span class="line">      overflow: <span class="string">"hidden"</span>,</span><br><span class="line">      paddingTop: <span class="number">0</span>,</span><br><span class="line">      paddingBottom: <span class="number">0</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ),</span><br><span class="line">  <span class="comment">// 使用 state 方法定义展开状态元素对应的样式</span></span><br><span class="line">  state(<span class="string">"expanded"</span>, style(&#123; <span class="attr">height</span>: <span class="string">"*"</span>, <span class="attr">overflow</span>: <span class="string">"auto"</span> &#125;)),</span><br><span class="line">  <span class="comment">// 定义展开动画</span></span><br><span class="line">  transition(<span class="string">"collapsed =&gt; expanded"</span>, animate(<span class="string">"400ms ease-out"</span>)),</span><br><span class="line">  <span class="comment">// 定义折叠动画</span></span><br><span class="line">  transition(<span class="string">"expanded =&gt; collapsed"</span>, animate(<span class="string">"400ms ease-in"</span>))</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span> [@<span class="attr">expandCollapse</span>]=<span class="string">"isExpended ? 'expanded' : 'collapsed'"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="45-实现路由动画-14"><a href="#45-实现路由动画-14" class="headerlink" title="45.实现路由动画"></a>45.实现路由动画</h3><ol>
<li><p>为路由添加状态标识，此标识即为路由执行动画时的自定义状态</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> routes: Routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">""</span>,</span><br><span class="line">    component: HomeComponent,</span><br><span class="line">    pathMatch: <span class="string">"full"</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"one"</span> </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"about"</span>,</span><br><span class="line">    component: AboutComponent,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"two"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"news"</span>,</span><br><span class="line">    component: NewsComponent,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"three"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过路由插座对象获取路由状态标识，并将标识传递给动画的调用者，让动画执行当前要执行的状态是什么</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"routerContainer"</span> [@<span class="attr">routerAnimations</span>]=<span class="string">"prepareRoute(outlet)"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">router-outlet</span> #<span class="attr">outlet</span>=<span class="string">"outlet"</span>&gt;</span><span class="tag">&lt;/<span class="name">router-outlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; RouterOutlet &#125; <span class="keyword">from</span> <span class="string">"@angular/router"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  prepareRoute(outlet: RouterOutlet) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      outlet &amp;&amp;</span><br><span class="line">      outlet.activatedRouteData &amp;&amp;</span><br><span class="line">      outlet.activatedRouteData.animation</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>将 routerContainer 设置为相对定位，将它的直接一级子元素设置成绝对定位</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* styles.css */</span></span><br><span class="line"><span class="selector-class">.routerContainer</span> &#123;</span><br><span class="line">  <span class="attribute">position</span>: relative;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.routerContainer</span> &gt; * &#123;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建动画</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">trigger(<span class="string">"routerAnimations"</span>, [</span><br><span class="line">  transition(<span class="string">"one =&gt; two, one =&gt; three, two =&gt; three"</span>, [</span><br><span class="line">    query(<span class="string">":enter"</span>, style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(100%)"</span>, <span class="attr">opacity</span>: <span class="number">0</span> &#125;)),</span><br><span class="line">    group([</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":enter"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-in"</span>,</span><br><span class="line">          style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(0)"</span>, <span class="attr">opacity</span>: <span class="number">1</span> &#125;)</span><br><span class="line">        )</span><br><span class="line">      ),</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":leave"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-out"</span>,</span><br><span class="line">          style(&#123;</span><br><span class="line">            transform: <span class="string">"translateX(-100%)"</span>,</span><br><span class="line">            opacity: <span class="number">0</span></span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    ])</span><br><span class="line">  ]),</span><br><span class="line">  transition(<span class="string">"three =&gt; two, three =&gt; one, two =&gt; one"</span>, [</span><br><span class="line">    query(</span><br><span class="line">      <span class="string">":enter"</span>,</span><br><span class="line">      style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(-100%)"</span>, <span class="attr">opacity</span>: <span class="number">0</span> &#125;)</span><br><span class="line">    ),</span><br><span class="line">    group([</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":enter"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-in"</span>,</span><br><span class="line">          style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(0)"</span>, <span class="attr">opacity</span>: <span class="number">1</span> &#125;)</span><br><span class="line">        )</span><br><span class="line">      ),</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":leave"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-out"</span>,</span><br><span class="line">          style(&#123;</span><br><span class="line">            transform: <span class="string">"translateX(100%)"</span>,</span><br><span class="line">            opacity: <span class="number">0</span></span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    ])</span><br><span class="line">  ])</span><br><span class="line">])</span><br><span class="line"><span class="string">``</span><span class="string">`     .container &#123;</span></span><br><span class="line"><span class="string">    margin-top: 100px;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  .panel-heading &#123;</span></span><br><span class="line"><span class="string">    cursor: pointer;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&lt;/style&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component &#125; <span class="keyword">from</span> <span class="string">"@angular/core"</span></span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">"app-root"</span>,</span><br><span class="line">  templateUrl: <span class="string">"./app.component.html"</span>,</span><br><span class="line">  styles: []</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  isExpended: boolean = <span class="literal">false</span></span><br><span class="line">  toggle() &#123;</span><br><span class="line">    <span class="keyword">this</span>.isExpended = !<span class="keyword">this</span>.isExpended</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建动画</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">trigger(<span class="string">"expandCollapse"</span>, [</span><br><span class="line">  <span class="comment">// 使用 state 方法定义折叠状态元素对应的样式</span></span><br><span class="line">  state(</span><br><span class="line">    <span class="string">"collapsed"</span>,</span><br><span class="line">    style(&#123;</span><br><span class="line">      height: <span class="number">0</span>,</span><br><span class="line">      overflow: <span class="string">"hidden"</span>,</span><br><span class="line">      paddingTop: <span class="number">0</span>,</span><br><span class="line">      paddingBottom: <span class="number">0</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ),</span><br><span class="line">  <span class="comment">// 使用 state 方法定义展开状态元素对应的样式</span></span><br><span class="line">  state(<span class="string">"expanded"</span>, style(&#123; <span class="attr">height</span>: <span class="string">"*"</span>, <span class="attr">overflow</span>: <span class="string">"auto"</span> &#125;)),</span><br><span class="line">  <span class="comment">// 定义展开动画</span></span><br><span class="line">  transition(<span class="string">"collapsed =&gt; expanded"</span>, animate(<span class="string">"400ms ease-out"</span>)),</span><br><span class="line">  <span class="comment">// 定义折叠动画</span></span><br><span class="line">  transition(<span class="string">"expanded =&gt; collapsed"</span>, animate(<span class="string">"400ms ease-in"</span>))</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span> [@<span class="attr">expandCollapse</span>]=<span class="string">"isExpended ? 'expanded' : 'collapsed'"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="45-实现路由动画-15"><a href="#45-实现路由动画-15" class="headerlink" title="45.实现路由动画"></a>45.实现路由动画</h3><ol>
<li><p>为路由添加状态标识，此标识即为路由执行动画时的自定义状态</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> routes: Routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">""</span>,</span><br><span class="line">    component: HomeComponent,</span><br><span class="line">    pathMatch: <span class="string">"full"</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"one"</span> </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"about"</span>,</span><br><span class="line">    component: AboutComponent,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"two"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"news"</span>,</span><br><span class="line">    component: NewsComponent,</span><br><span class="line">    data: &#123;</span><br><span class="line">      animation: <span class="string">"three"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过路由插座对象获取路由状态标识，并将标识传递给动画的调用者，让动画执行当前要执行的状态是什么</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"routerContainer"</span> [@<span class="attr">routerAnimations</span>]=<span class="string">"prepareRoute(outlet)"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">router-outlet</span> #<span class="attr">outlet</span>=<span class="string">"outlet"</span>&gt;</span><span class="tag">&lt;/<span class="name">router-outlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; RouterOutlet &#125; <span class="keyword">from</span> <span class="string">"@angular/router"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  prepareRoute(outlet: RouterOutlet) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      outlet &amp;&amp;</span><br><span class="line">      outlet.activatedRouteData &amp;&amp;</span><br><span class="line">      outlet.activatedRouteData.animation</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>将 routerContainer 设置为相对定位，将它的直接一级子元素设置成绝对定位</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* styles.css */</span></span><br><span class="line"><span class="selector-class">.routerContainer</span> &#123;</span><br><span class="line">  <span class="attribute">position</span>: relative;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.routerContainer</span> &gt; * &#123;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建动画</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">trigger(<span class="string">"routerAnimations"</span>, [</span><br><span class="line">  transition(<span class="string">"one =&gt; two, one =&gt; three, two =&gt; three"</span>, [</span><br><span class="line">    query(<span class="string">":enter"</span>, style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(100%)"</span>, <span class="attr">opacity</span>: <span class="number">0</span> &#125;)),</span><br><span class="line">    group([</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":enter"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-in"</span>,</span><br><span class="line">          style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(0)"</span>, <span class="attr">opacity</span>: <span class="number">1</span> &#125;)</span><br><span class="line">        )</span><br><span class="line">      ),</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":leave"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-out"</span>,</span><br><span class="line">          style(&#123;</span><br><span class="line">            transform: <span class="string">"translateX(-100%)"</span>,</span><br><span class="line">            opacity: <span class="number">0</span></span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    ])</span><br><span class="line">  ]),</span><br><span class="line">  transition(<span class="string">"three =&gt; two, three =&gt; one, two =&gt; one"</span>, [</span><br><span class="line">    query(</span><br><span class="line">      <span class="string">":enter"</span>,</span><br><span class="line">      style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(-100%)"</span>, <span class="attr">opacity</span>: <span class="number">0</span> &#125;)</span><br><span class="line">    ),</span><br><span class="line">    group([</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":enter"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-in"</span>,</span><br><span class="line">          style(&#123; <span class="attr">transform</span>: <span class="string">"translateX(0)"</span>, <span class="attr">opacity</span>: <span class="number">1</span> &#125;)</span><br><span class="line">        )</span><br><span class="line">      ),</span><br><span class="line">      query(</span><br><span class="line">        <span class="string">":leave"</span>,</span><br><span class="line">        animate(</span><br><span class="line">          <span class="string">"0.4s ease-out"</span>,</span><br><span class="line">          style(&#123;</span><br><span class="line">            transform: <span class="string">"translateX(100%)"</span>,</span><br><span class="line">            opacity: <span class="number">0</span></span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    ])</span><br><span class="line">  ])</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/04/11/42/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="FY">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="旋の飞羽">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/04/11/42/" itemprop="url">学习笔记 ----- 【React 框架原理与实战】React + Redux + Ant Design + TypeScript 实战</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-04-11T00:00:00+08:00">
                2021-04-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index">
                    <span itemprop="name">前端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>作者：FY<br>引用请标明出处</p>
</blockquote>
<h1 id="Part-4-·-React-框架原理与实战"><a href="#Part-4-·-React-框架原理与实战" class="headerlink" title="Part 4 · React 框架原理与实战"></a>Part 4 · React 框架原理与实战</h1><h2 id="模块五-·-React-Redux-Ant-Design-TypeScript-实战"><a href="#模块五-·-React-Redux-Ant-Design-TypeScript-实战" class="headerlink" title="模块五 · React + Redux + Ant Design + TypeScript 实战"></a>模块五 · React + Redux + Ant Design + TypeScript 实战</h2><h2 id="任务一：基础配置"><a href="#任务一：基础配置" class="headerlink" title="任务一：基础配置"></a>任务一：基础配置</h2><h3 id="1-项目介绍"><a href="#1-项目介绍" class="headerlink" title="1.项目介绍"></a>1.项目介绍</h3><p>略</p>
<h3 id="2-技术栈介绍"><a href="#2-技术栈介绍" class="headerlink" title="2.技术栈介绍"></a>2.技术栈介绍</h3><blockquote>
<p>客户端</p>
</blockquote>
<ul>
<li>脚本：TypeScript</li>
<li>前端框架：React</li>
<li>路由管理：React-router-dom</li>
<li>用户界面：Antd</li>
<li>全局状态管理：Redux</li>
<li>异步状态更新：redux-saga</li>
<li>路由状态同步：connected-react-router</li>
<li>网络请求：Axios</li>
<li>调试工具：redux-devtools-extension</li>
</ul>
<blockquote>
<p>服务端</p>
</blockquote>
<ul>
<li>脚本：Node.js</li>
<li>数据库：Mongodb</li>
<li>数据库可视化：Robo 3T</li>
</ul>
<h3 id="3-安装mongodb数据库软件"><a href="#3-安装mongodb数据库软件" class="headerlink" title="3.安装mongodb数据库软件"></a>3.安装mongodb数据库软件</h3><blockquote>
<p>安装 mongodb 数据库 (Mac)</p>
</blockquote>
<ol>
<li><p>安装 <a href="https://brew.sh/index_zh-cn" target="_blank" rel="noopener">homebrew</a></p>
<p>Homebrew 是mac系统中的软件包管理器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/bin/bash -c <span class="string">"<span class="variable">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)</span>"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>添加 mongodb 仓库源</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew tap mongodb/brew</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装 mongodb</p>
<p>安装前确保系统已经安装 xcode 命令行编译开发工具</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xcode-select --install</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install mongodb-community</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动 mongodb</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew services run mongodb-community</span><br></pre></td></tr></table></figure>
</li>
<li><p>停止 mongodb</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew services stop mongodb-community</span><br></pre></td></tr></table></figure>
</li>
<li><p>文件位置</p>
<ol>
<li>数据库配置文件：/usr/local/etc/mongod.conf</li>
<li>数据库文件默认存放位置：/usr/local/var/mongodb</li>
<li>日志存放位置：/usr/local/var/log/mongodb/mongo.log</li>
</ol>
</li>
</ol>
<blockquote>
<p>安装 mongodb 数据库 (Windows)</p>
</blockquote>
<p>略</p>
<ul>
<li>mongo</li>
<li>net stop mongodb</li>
<li>net start mongodb</li>
</ul>
<p><strong>管理员运行</strong></p>
<blockquote>
<p>数据库可视化 Robo 3T</p>
</blockquote>
<p><a href="https://robomongo.org/download" target="_blank" rel="noopener">下载地址</a></p>
<blockquote>
<p>启动服务器端应用程序</p>
</blockquote>
<ol>
<li>Mac 用户将服务器端应用程序文件夹拖拽到终端中，windows 用户打开服务器端应用程序文件夹，按住 shift 同时单击鼠标右键，选择在此处打开命令行工具 (cmd 或者 powershell)</li>
<li>执行 <code>npm install</code> 命令安装程序依赖文件</li>
<li>执行 <code>npm start</code> 命令启动服务器端应用程序，服务器端应用程序默认监听 80 端口</li>
</ol>
<h3 id="4-创建Ecommerce项目"><a href="#4-创建Ecommerce项目" class="headerlink" title="4.创建Ecommerce项目"></a>4.创建Ecommerce项目</h3><ol>
<li><p>使用 create-react-app 脚手架创建 react 项目</p>
<p><code>npx create-react-app ecommerce-front --template typescript</code></p>
</li>
<li><p>安装项目依赖</p>
<p><code>npm install antd axios moment redux react-redux react-router-dom redux-saga connected-react-router redux-devtools-extension @types/react-redux @types/react-router-dom</code></p>
</li>
<li><p>antd CSS 使用 CDN</p>
<p><a href="https://cdn.bootcdn.net/ajax/libs/antd/4.8.3/antd.min.css" target="_blank" rel="noopener">https://cdn.bootcdn.net/ajax/libs/antd/4.8.3/antd.min.css</a></p>
</li>
</ol>
<h3 id="5-根据环境切换服务器端API接口地址"><a href="#5-根据环境切换服务器端API接口地址" class="headerlink" title="5.根据环境切换服务器端API接口地址"></a>5.根据环境切换服务器端API接口地址</h3><p>在项目的根目录下新建 .env 文件，并在文件中添加以下内容：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">REACT_APP_PRODUCTION_API_URL=http://fullstack.net.cn/api</span><br><span class="line">REACT_APP_DEVLOPMENT_API_URL=http://localhost/api</span><br></pre></td></tr></table></figure>

<p>create-react-app 脚手架中内置了 dotenv，允许我们在 React 项目中配置环境变量，但环境变量的名字必须以 REACT_APP_ 开头。</p>
<p>REACT_APP_PRODUCTION_API_URL： 生产环境的服务器端 API 地址</p>
<p>REACT_APP_DEVLOPMENT_API_URL：开发环境的服务器端 API 地址</p>
<p>在项目中可以通过 <code>process.env.REACT_APP_DEVLOPMENT_API_URL</code> 方式进行访问，但是这样会有弊端，其一是代码过长写起来不方便，其二是如果在代码中将环境写死，当切换环境时改起来也不方便。</p>
<p>解决方案就是将 API 地址写入配置中，根据环境决定使用哪个 API 地址</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">let</span> API: string</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV === <span class="string">"development"</span>) &#123;</span><br><span class="line">  API = process.env.REACT_APP_DEVLOPMENT_API_URL!</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  API = process.env.REACT_APP_PRODUCTION_API_URL!</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-安装Chrome扩展插件"><a href="#6-安装Chrome扩展插件" class="headerlink" title="6.安装Chrome扩展插件"></a>6.安装Chrome扩展插件</h3><ul>
<li>React Developer Tools：检查React组件层次结构，在页面上显示React组件</li>
<li>Redux DevTools：监测 Store 中状态的变化</li>
</ul>
<h3 id="7-页面组件初始化和路由初始化"><a href="#7-页面组件初始化和路由初始化" class="headerlink" title="7.页面组件初始化和路由初始化"></a>7.页面组件初始化和路由初始化</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/Routes.tsx</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; HashRouter, Route, Switch &#125; <span class="keyword">from</span> <span class="string">'react-router-dom'</span></span><br><span class="line"><span class="keyword">import</span> Home <span class="keyword">from</span> <span class="string">'./components/core/Home'</span></span><br><span class="line"><span class="keyword">import</span> Shop <span class="keyword">from</span> <span class="string">'./components/core/Shop'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Routes = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">HashRouter</span>&gt;</span></span></span><br><span class="line">        &lt;Switch&gt;</span><br><span class="line">            &lt;Route path="/" component=&#123;Home&#125; exact /&gt;</span><br><span class="line">            &lt;Route path="/shop" component=&#123;Shop&#125; /&gt;</span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">Switch</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">HashRouter</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Routes</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\components\core\Layout.tsx</span></span><br><span class="line"><span class="keyword">import</span> React, &#123; FC &#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"></span><br><span class="line">interface Props &#123;</span><br><span class="line">    children: React.ReactNode</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Layout: FC&lt;Props&gt; = <span class="function">(<span class="params">&#123; children &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>Layout&#123;children&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Layout</span><br></pre></td></tr></table></figure>

<h3 id="8-全局store初始化"><a href="#8-全局store初始化" class="headerlink" title="8.全局store初始化"></a>8.全局store初始化</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\store\reducers\index.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; combineReducers &#125; <span class="keyword">from</span> <span class="string">"redux"</span>;</span><br><span class="line"><span class="keyword">import</span> testReducer <span class="keyword">from</span> <span class="string">"./test.reducer"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> rootReducer = combineReducers(&#123;</span><br><span class="line">    test: testReducer</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> rootReducer</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\store\reducers\test.reducer.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">testReducer</span>(<span class="params">state: number = <span class="number">0</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> state</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\store\index.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; createStore &#125; <span class="keyword">from</span> <span class="string">"redux"</span>;</span><br><span class="line"><span class="keyword">import</span> rootReducer <span class="keyword">from</span> <span class="string">"./reducers"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = createStore(rootReducer)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> store</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\components\core\Home.tsx</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; useSelector &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span></span><br><span class="line"><span class="keyword">import</span> Layout <span class="keyword">from</span> <span class="string">'./Layout'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Home = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> state = useSelector(<span class="function"><span class="params">state</span> =&gt;</span> state)</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">Layout</span>&gt;</span>Home &#123;JSON.stringify(state)&#125;<span class="tag">&lt;/<span class="name">Layout</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Home</span><br></pre></td></tr></table></figure>

<h3 id="9-将路由状态同步到全局store"><a href="#9-将路由状态同步到全局store" class="headerlink" title="9.将路由状态同步到全局store"></a>9.将路由状态同步到全局store</h3><ul>
<li><a href="https://www.npmjs.com/package/connected-react-router" target="_blank" rel="noopener">https://www.npmjs.com/package/connected-react-router</a></li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\store\reducers\index.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; connectRouter &#125; <span class="keyword">from</span> <span class="string">"connected-react-router"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; combineReducers &#125; <span class="keyword">from</span> <span class="string">"redux"</span>;</span><br><span class="line"><span class="keyword">import</span> testReducer <span class="keyword">from</span> <span class="string">"./test.reducer"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; History &#125; <span class="keyword">from</span> <span class="string">'history'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> createRootReducer = <span class="function">(<span class="params">history: History</span>) =&gt;</span></span><br><span class="line">    combineReducers(&#123;</span><br><span class="line">        test: testReducer,</span><br><span class="line">        router: connectRouter(history)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> createRootReducer</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\store\index.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; applyMiddleware, createStore &#125; <span class="keyword">from</span> <span class="string">"redux"</span>;</span><br><span class="line"><span class="keyword">import</span> createRootReducer <span class="keyword">from</span> <span class="string">"./reducers"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createHashHistory &#125; <span class="keyword">from</span> <span class="string">'history'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; routerMiddleware &#125; <span class="keyword">from</span> <span class="string">"connected-react-router"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> history = createHashHistory()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = createStore(</span><br><span class="line">    createRootReducer(history),</span><br><span class="line">    applyMiddleware(routerMiddleware(history))</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> store</span><br></pre></td></tr></table></figure>

<h2 id="任务二：登录注册及首页"><a href="#任务二：登录注册及首页" class="headerlink" title="任务二：登录注册及首页"></a>任务二：登录注册及首页</h2><h3 id="1-创建导航菜单"><a href="#1-创建导航菜单" class="headerlink" title="1.创建导航菜单"></a>1.创建导航菜单</h3><h3 id="2-创建页头"><a href="#2-创建页头" class="headerlink" title="2.创建页头"></a>2.创建页头</h3><h3 id="3-构建注册和登录表单"><a href="#3-构建注册和登录表单" class="headerlink" title="3.构建注册和登录表单"></a>3.构建注册和登录表单</h3><h3 id="4-实现注册的Redux流程"><a href="#4-实现注册的Redux流程" class="headerlink" title="4.实现注册的Redux流程"></a>4.实现注册的Redux流程</h3><h3 id="5-处理注册结果"><a href="#5-处理注册结果" class="headerlink" title="5.处理注册结果"></a>5.处理注册结果</h3><h3 id="6-重置注册状态"><a href="#6-重置注册状态" class="headerlink" title="6.重置注册状态"></a>6.重置注册状态</h3><h3 id="7-实现登录redux流程"><a href="#7-实现登录redux流程" class="headerlink" title="7.实现登录redux流程"></a>7.实现登录redux流程</h3><h3 id="8-处理登录结果"><a href="#8-处理登录结果" class="headerlink" title="8.处理登录结果"></a>8.处理登录结果</h3><h3 id="9-创建受保护的Dashboard组件"><a href="#9-创建受保护的Dashboard组件" class="headerlink" title="9.创建受保护的Dashboard组件"></a>9.创建受保护的Dashboard组件</h3><h3 id="10-管理员Dashbaord组件添加链接和管理员信息"><a href="#10-管理员Dashbaord组件添加链接和管理员信息" class="headerlink" title="10.管理员Dashbaord组件添加链接和管理员信息"></a>10.管理员Dashbaord组件添加链接和管理员信息</h3><h3 id="11-创建添加分类组件"><a href="#11-创建添加分类组件" class="headerlink" title="11.创建添加分类组件"></a>11.创建添加分类组件</h3><h3 id="12-实现添加分类功能"><a href="#12-实现添加分类功能" class="headerlink" title="12.实现添加分类功能"></a>12.实现添加分类功能</h3><h3 id="13-创建添加商品组件"><a href="#13-创建添加商品组件" class="headerlink" title="13.创建添加商品组件"></a>13.创建添加商品组件</h3><h3 id="14-获取分类列表"><a href="#14-获取分类列表" class="headerlink" title="14.获取分类列表"></a>14.获取分类列表</h3><h3 id="15-实现添加商品功能"><a href="#15-实现添加商品功能" class="headerlink" title="15.实现添加商品功能"></a>15.实现添加商品功能</h3><h3 id="16-构建Home组件布局"><a href="#16-构建Home组件布局" class="headerlink" title="16.构建Home组件布局"></a>16.构建Home组件布局</h3><h3 id="17-完成首页获取商品列表的redux流程"><a href="#17-完成首页获取商品列表的redux流程" class="headerlink" title="17.完成首页获取商品列表的redux流程"></a>17.完成首页获取商品列表的redux流程</h3><h3 id="18-首页商品列表数据展示"><a href="#18-首页商品列表数据展示" class="headerlink" title="18.首页商品列表数据展示"></a>18.首页商品列表数据展示</h3><h3 id="19-加载商品封面"><a href="#19-加载商品封面" class="headerlink" title="19.加载商品封面"></a>19.加载商品封面</h3><h2 id="任务三：搜索和筛选"><a href="#任务三：搜索和筛选" class="headerlink" title="任务三：搜索和筛选"></a>任务三：搜索和筛选</h2><h3 id="1-实现搜索功能"><a href="#1-实现搜索功能" class="headerlink" title="1.实现搜索功能"></a>1.实现搜索功能</h3><h3 id="2-展示搜索结果"><a href="#2-展示搜索结果" class="headerlink" title="2.展示搜索结果"></a>2.展示搜索结果</h3><h3 id="3-构建商城页面布局"><a href="#3-构建商城页面布局" class="headerlink" title="3.构建商城页面布局"></a>3.构建商城页面布局</h3><h3 id="4-收集用户的筛选条件"><a href="#4-收集用户的筛选条件" class="headerlink" title="4.收集用户的筛选条件"></a>4.收集用户的筛选条件</h3><h3 id="5-实现商品筛选的redux流程"><a href="#5-实现商品筛选的redux流程" class="headerlink" title="5.实现商品筛选的redux流程"></a>5.实现商品筛选的redux流程</h3><h3 id="6-显示筛选结果"><a href="#6-显示筛选结果" class="headerlink" title="6.显示筛选结果"></a>6.显示筛选结果</h3><h3 id="7-加载更多数据"><a href="#7-加载更多数据" class="headerlink" title="7.加载更多数据"></a>7.加载更多数据</h3><h3 id="8-构建商品详情组件布局"><a href="#8-构建商品详情组件布局" class="headerlink" title="8.构建商品详情组件布局"></a>8.构建商品详情组件布局</h3><h3 id="9-完成根据产品ID获取产品详情redux流程"><a href="#9-完成根据产品ID获取产品详情redux流程" class="headerlink" title="9.完成根据产品ID获取产品详情redux流程"></a>9.完成根据产品ID获取产品详情redux流程</h3><h3 id="10-展示商品详情"><a href="#10-展示商品详情" class="headerlink" title="10.展示商品详情"></a>10.展示商品详情</h3><h2 id="任务三：购物车"><a href="#任务三：购物车" class="headerlink" title="任务三：购物车"></a>任务三：购物车</h2><h3 id="1-将商品添加到购物车中"><a href="#1-将商品添加到购物车中" class="headerlink" title="1.将商品添加到购物车中"></a>1.将商品添加到购物车中</h3><h3 id="2-构建购物车组件布局"><a href="#2-构建购物车组件布局" class="headerlink" title="2.构建购物车组件布局"></a>2.构建购物车组件布局</h3><h3 id="3-更改购物车中的商品数量"><a href="#3-更改购物车中的商品数量" class="headerlink" title="3.更改购物车中的商品数量"></a>3.更改购物车中的商品数量</h3><h3 id="4-删除购物车中的商品"><a href="#4-删除购物车中的商品" class="headerlink" title="4.删除购物车中的商品"></a>4.删除购物车中的商品</h3><h3 id="5-计算商品总价"><a href="#5-计算商品总价" class="headerlink" title="5.计算商品总价"></a>5.计算商品总价</h3><h3 id="6-增加支付按钮或登录按钮"><a href="#6-增加支付按钮或登录按钮" class="headerlink" title="6.增加支付按钮或登录按钮"></a>6.增加支付按钮或登录按钮</h3><h3 id="7-支付"><a href="#7-支付" class="headerlink" title="7.支付"></a>7.支付</h3><h3 id="8-创建支付成功后的提示页面组件"><a href="#8-创建支付成功后的提示页面组件" class="headerlink" title="8.创建支付成功后的提示页面组件"></a>8.创建支付成功后的提示页面组件</h3><h3 id="9-存储共享状态的另一种方案"><a href="#9-存储共享状态的另一种方案" class="headerlink" title="9.存储共享状态的另一种方案"></a>9.存储共享状态的另一种方案</h3><h3 id="10-获取订单数据"><a href="#10-获取订单数据" class="headerlink" title="10.获取订单数据"></a>10.获取订单数据</h3><h3 id="11-更改订单状态"><a href="#11-更改订单状态" class="headerlink" title="11.更改订单状态"></a>11.更改订单状态</h3>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/04/04/41/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="FY">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="旋の飞羽">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/04/04/41/" itemprop="url">学习笔记 ----- 【React 框架原理与实战】React 服务端渲染专题（原生实现、Next.js 集成框架、Gatsby）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-04-04T00:00:00+08:00">
                2021-04-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index">
                    <span itemprop="name">前端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>作者：FY<br>引用请标明出处</p>
</blockquote>
<h1 id="Part-4-·-React-框架原理与实战"><a href="#Part-4-·-React-框架原理与实战" class="headerlink" title="Part 4 · React 框架原理与实战"></a>Part 4 · React 框架原理与实战</h1><h2 id="模块四-·-React-服务端渲染专题（原生实现、Next-js-集成框架、Gatsby）"><a href="#模块四-·-React-服务端渲染专题（原生实现、Next-js-集成框架、Gatsby）" class="headerlink" title="模块四 · React 服务端渲染专题（原生实现、Next.js 集成框架、Gatsby）"></a>模块四 · React 服务端渲染专题（原生实现、Next.js 集成框架、Gatsby）</h2><h2 id="任务一：ReactSSR"><a href="#任务一：ReactSSR" class="headerlink" title="任务一：ReactSSR"></a>任务一：ReactSSR</h2><h3 id="1-ReactSSR相关观念回顾"><a href="#1-ReactSSR相关观念回顾" class="headerlink" title="1.ReactSSR相关观念回顾"></a>1.ReactSSR相关观念回顾</h3><blockquote>
<p>什么是客户端渲染</p>
</blockquote>
<p>CSR：Client Side Rendering</p>
<p>服务端仅返回 JSON 数据，DATA 和 HTML 在客户端进行渲染.</p>
<blockquote>
<p>什么是服务器端渲染</p>
</blockquote>
<p>SSR：Server Side Rendering</p>
<p>服务器端返回 HTML，DATA和HTML在服务器端进行渲染.</p>
<blockquote>
<p>客户端渲染存在的问题</p>
</blockquote>
<p>1.首屏等待时间长，用户体验差<br>2.页面结构为空，不利于SEO</p>
<blockquote>
<p>React SSR 同构</p>
</blockquote>
<p>同构指的是代码复用，即实现客户端和服务端最大程度的代码复用.</p>
<h3 id="2-项目结构初始化"><a href="#2-项目结构初始化" class="headerlink" title="2.项目结构初始化"></a>2.项目结构初始化</h3><ul>
<li>react-ssr<ul>
<li>src 源代码文件夹<ul>
<li>client 客户端代码</li>
<li>server 服务端代码</li>
<li>share 同构代码</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="3-实现ReactSSR雏形"><a href="#3-实现ReactSSR雏形" class="headerlink" title="3.实现ReactSSR雏形"></a>3.实现ReactSSR雏形</h3><blockquote>
<p>创建 Node 服务器</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> express <span class="keyword">from</span> <span class="string">'express'</span>;</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line">app.use(express.static(<span class="string">'public'</span>));</span><br><span class="line">app.listen(<span class="number">3000</span>,()=&gt;<span class="built_in">console</span>.log(<span class="string">"server is listening on 3000 port"</span>));</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> app;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>实现 React SSR</p>
</blockquote>
<p>1.引入要渲染的 React 组件<br>2.通过 renderToString 方法将 React 组件转换为 HTML 字符串<br>3.将结果HTML字符串响应到客户端</p>
<p>renderToString 方法用于将 React 组件转换为 HTML 字符串，通过 react-dom/server 导入</p>
<h3 id="4-服务器端程序webpack打包配置"><a href="#4-服务器端程序webpack打包配置" class="headerlink" title="4.服务器端程序webpack打包配置"></a>4.服务器端程序webpack打包配置</h3><blockquote>
<p>webpack 打包配置</p>
</blockquote>
<p>问题：Node 环境不支持 ESModule 模块系统，不支持 JSX 语法.</p>
<blockquote>
<p>项目启动命令配置</p>
</blockquote>
<p>1.配置服务端打包命令：”dev:server-build”:”webpack –config webpack.server.js –watch”<br>2.配置服务端启动命令：”dev:server-run”:”nodemon –watch build –exec&quot;node build/bundle.js&quot;“</p>
<h3 id="5-为组件元素附加事件的方式"><a href="#5-为组件元素附加事件的方式" class="headerlink" title="5.为组件元素附加事件的方式"></a>5.为组件元素附加事件的方式</h3><blockquote>
<p>实现思路分析</p>
</blockquote>
<p>在客户端对组件进行二次“渲染”，为组件元素附加事件。</p>
<blockquote>
<p>客户端二次“渲染”hydrate</p>
</blockquote>
<p>使用 hydrate 方法对组件进行渲染，为组件元素附加事件.<br>hydrate 方法在实现渲染的时候，会复用原本已经存在的DOM节点，减少重新生成节点以及删除原本DOM节点的开销.<br>通过 react-dom 导入 hydrate.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ReactDOM.hydrate(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span></span>,<span class="built_in">document</span>.QuerySelector(<span class="string">"#root"</span>))</span><br></pre></td></tr></table></figure>

<blockquote>
<p>客户端 React 打包配置</p>
</blockquote>
<p>1.webpack 配置</p>
<p>打包目的：转换 JSX 语法，转换浏览器不识别的高级 JavaScript 语法<br>打包目标位置：public 文件夹</p>
<p>2.打包启动命令配置</p>
<p>“dev:client-build”:”webpack –config webpack.client.js –watch”</p>
<blockquote>
<p>添加客户端包文件请求链接</p>
</blockquote>
<p>在响应给客户端的 HTML 代码中添加 script 标签，请求客户端 JavaScript 打包文件.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">htmL</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>React SSR<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"root"</span>&gt;</span>$&#123;content&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"bundle.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>服务端实现静态资源访问</p>
</blockquote>
<p>服务端程序实现静态资源访问功能，客户端 JavaScript 打包文件会被作为静态资源使用.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.use(express.static(<span class="string">'public'</span>));</span><br></pre></td></tr></table></figure>

<h3 id="6-优化：合并webpack配置"><a href="#6-优化：合并webpack配置" class="headerlink" title="6.优化：合并webpack配置"></a>6.优化：合并webpack配置</h3><p>服务端 webpack 配置和客户端 webpack 配置存在重复，将重复配置抽象到 webpack.base.js 配置文件中.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> merge = <span class="built_in">require</span>(<span class="string">'webpack-merge'</span>);</span><br><span class="line"><span class="keyword">const</span> baseConfig = <span class="built_in">require</span>(<span class="string">'./webpack.base'</span>);</span><br><span class="line"><span class="keyword">const</span> config = &#123; ... &#125;</span><br><span class="line"><span class="built_in">module</span>.exporets = merge(baseConfig,config);</span><br></pre></td></tr></table></figure>

<h3 id="7-优化：合并项目启动命令"><a href="#7-优化：合并项目启动命令" class="headerlink" title="7.优化：合并项目启动命令"></a>7.优化：合并项目启动命令</h3><p>目的：使用一个命令启动项目，解决多个命令启动的繁琐问题，通过 npm-run-all 工具实现.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"dev"</span>: <span class="string">"npm-run-all --parallel dev:*"</span></span><br></pre></td></tr></table></figure>

<h3 id="8-优化：服务器端打包文件体积优化"><a href="#8-优化：服务器端打包文件体积优化" class="headerlink" title="8.优化：服务器端打包文件体积优化"></a>8.优化：服务器端打包文件体积优化</h3><p>问题：在服务端打包文件中，包含了 Node 系统模块，导致打包文件本身体积庞大.<br>解决：通过 webpack 配置剔除打包文件中的 Node 模块.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.server.js</span></span><br><span class="line"><span class="keyword">const</span> nodeExternals = <span class="built_in">require</span>(<span class="string">'webpack-node-exteernals'</span>);</span><br><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">    externals: [nodeExternals()]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="9-优化：代码拆分"><a href="#9-优化：代码拆分" class="headerlink" title="9.优化：代码拆分"></a>9.优化：代码拆分</h3><blockquote>
<p>将启动服务器代码和渲染代码进行模块化拆分</p>
</blockquote>
<p>优化代码组织方式，渲染 React 组件代码是独立功能，所以把它从服务器端入口文件中进行抽离.</p>
<h3 id="10-实现服务器端路由"><a href="#10-实现服务器端路由" class="headerlink" title="10.实现服务器端路由"></a>10.实现服务器端路由</h3><blockquote>
<p>实现思路分析</p>
</blockquote>
<p>在 React SSR 项目中需要实现两端路由.<br>客户端路由是用于支持用户通过点击链接的形式跳转页面.<br>服务端路由是用于支持用户直接从浏览器地址栏中访问页面.<br>客户端和服务端公用一套路由规则.</p>
<blockquote>
<p>编写路由规则</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> HomePage <span class="keyword">from</span> <span class="string">'./pages/HomePage'</span>;</span><br><span class="line"><span class="keyword">import</span> ListPage <span class="keyword">from</span> <span class="string">'./pages/ListPage'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> [&#123;</span><br><span class="line">    path: <span class="string">'/'</span>,</span><br><span class="line">    component: HomePage,</span><br><span class="line">    exact: <span class="literal">true</span></span><br><span class="line">&#125;,&#123;</span><br><span class="line">    path: <span class="string">'/list'</span>,</span><br><span class="line">    ...ListPage</span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>实现服务端路由</p>
</blockquote>
<p>1.Express 路由接收任何请求</p>
<p>Express 路由接收所有 GET 请求，服务端 React 路由通过请求路径匹配要进行渲染的组件.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">"*“， async(req, res) =&gt; &#123;&#125;);</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>实现服务端路由</p>
</blockquote>
<p>2.服务端路由配置</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; StaticRouter &#125; <span class="keyword">from</span> <span class="string">"react-router-dom"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; renderRoutes &#125; <span class="keyword">from</span> <span class="string">"react-router-config"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> req = &#123;</span><br><span class="line">    <span class="keyword">const</span> content = renderToString(</span><br><span class="line">        &lt;StaticRouter location=&#123;req.path&#125;&gt;</span><br><span class="line">          &#123;renderRoutes(routes)&#125;</span><br><span class="line">        &lt;<span class="regexp">/StaticRouter&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="11-实现客户端路由"><a href="#11-实现客户端路由" class="headerlink" title="11.实现客户端路由"></a>11.实现客户端路由</h3><p>2.添加客户端路由配置</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; BrowserRouter &#125; <span class="keyword">from</span> <span class="string">"react-router-dom"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; renderRoutes &#125; <span class="keyword">from</span> <span class="string">"react-router-config"</span>;</span><br><span class="line"><span class="keyword">import</span> routes <span class="keyword">from</span> <span class="string">"../share/routes"</span>;</span><br><span class="line"></span><br><span class="line">ReactDOM.hydrate(</span><br><span class="line">    &lt;BrowsRouter&gt;&#123;renderRoutes(routes)&#125;&lt;<span class="regexp">/BrowsRouter&gt;,</span></span><br><span class="line"><span class="regexp">    document.querySelector('#root')</span></span><br><span class="line"><span class="regexp">)</span></span><br></pre></td></tr></table></figure>

<h3 id="12-实现客户端Redux"><a href="#12-实现客户端Redux" class="headerlink" title="12.实现客户端Redux"></a>12.实现客户端Redux</h3><blockquote>
<p>实现思路分析</p>
</blockquote>
<p>在实现了 React SSR 的项目中需要实现两端 Redux.<br>客户端 Redux 就是通过客户端 JavaScript 管理 Store 中的数据.<br>服务器端 Redux 就是在服务器端搭建一套 Redux 代码，用于管理组件中的数据.<br>客户端和服务器端共用一套 Reducer 代码.<br>创建 Store 的代码由于参数传递不同所以不可以共用.</p>
<h3 id="13-实现服务器端Redux-一"><a href="#13-实现服务器端Redux-一" class="headerlink" title="13.实现服务器端Redux(一)"></a>13.实现服务器端Redux(一)</h3><p>1.创建 Store</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createStore, applyMiddleware &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</span><br><span class="line"><span class="keyword">import</span> thunk <span class="keyword">from</span> <span class="string">'redux-thunk'</span>;</span><br><span class="line"><span class="keyword">import</span> reducers <span class="keyword">from</span> <span class="string">'../share/store/reducers'</span>;</span><br><span class="line"></span><br><span class="line">expport <span class="keyword">default</span> () =&gt; createStore(reducers, &#123;&#125;, apllyMiddleware(thunk));</span><br></pre></td></tr></table></figure>

<p>2.配置 Store</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">"*"</span>, <span class="keyword">async</span>(req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> store = createStore();</span><br><span class="line">    res.send(renderer(req,store))</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Provider &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (req, store) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> content = renderToString(</span><br><span class="line">      &lt;Provider store=&#123;store&#125;&gt;</span><br><span class="line">        &lt;StaticRouter location=&#123;req.path&#125;&gt;</span><br><span class="line">          &#123;renderRoutes(routes)&#125;</span><br><span class="line">        &lt;<span class="regexp">/StaticRouter&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>Provider&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="14-实现服务器端Redux-二"><a href="#14-实现服务器端Redux-二" class="headerlink" title="14.实现服务器端Redux(二)"></a>14.实现服务器端Redux(二)</h3><blockquote>
<p>服务器端 store 数据填充</p>
</blockquote>
<p>问题：服务器端创建的 store 是空的，组件并不能从 Store 中获取到任何数据.<br>解决：服务器端在渲染组件之前获取到组件所需要的数据.</p>
<p>1.在组件中添加 loadData 方法，此方法用于获取组件所需数据，方法被服务器端调用.<br>2.将 loadData 方法保存在当前组件的路由信息对象中.<br>3.服务器端在接收到请求后，根据请求地址匹配出要渲染的组件的路由信息.<br>4.从路由信息中获取组件中的 loadData 方法并调用方法获取组件所需数据.<br>5.当数据获取完成以后再渲染组件并将结果响应到客户端.</p>
<h3 id="15-实现服务器端Redux-三"><a href="#15-实现服务器端Redux-三" class="headerlink" title="15.实现服务器端Redux(三)"></a>15.实现服务器端Redux(三)</h3><blockquote>
<p>React 警告消除</p>
</blockquote>
<p>警告原因：客户端 Store 在初始状态下是没有数据的，在渲染组件的时候生成的是空 ul，但是服务器端是先获取数据再进行组件渲染，所以生成的是有子元素的ul，hydrate 方法在对比的时候发现两者不一致，所以报了警告.<br>解决思路：将服务器端获取到的数据回填给客户端，让客户端拥有初始数据.</p>
<p>1.服务器响应 Store 初始状态</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> initialState = store.getState();</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;div id=<span class="string">"root"</span>&gt;$&#123;content&#125;&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  &lt;script&gt;window.INITIAL_STATE = $&#123;initialState&#125;&lt;/</span>script&gt;</span><br><span class="line">  &lt;script src=<span class="string">"bundle.js"</span>&gt;&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>body&gt;</span><br></pre></td></tr></table></figure>

<p>2.客户端设置 Store 初始状态</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = createStore(</span><br><span class="line">    reducers,</span><br><span class="line">    <span class="built_in">window</span>.INITIAL_STATE,</span><br><span class="line">    applyMiddleware(thunk)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="16-防止XSS攻击"><a href="#16-防止XSS攻击" class="headerlink" title="16.防止XSS攻击"></a>16.防止XSS攻击</h3><p>转义状态的恶意代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> reaponse = &#123;</span><br><span class="line">    data: [&#123;<span class="attr">id</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="string">"&lt;/script&gt;&lt;script&gt;alert(1)&lt;/script&gt;"</span>&#125;]</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">import</span> serialize <span class="keyword">from</span> <span class="string">'serialaze-javascript'</span>;</span><br><span class="line"><span class="keyword">const</span> initialState = serialize(store.getState());</span><br></pre></td></tr></table></figure>

<h2 id="任务二：Next"><a href="#任务二：Next" class="headerlink" title="任务二：Next"></a>任务二：Next</h2><h3 id="1-Next-js整体介绍"><a href="#1-Next-js整体介绍" class="headerlink" title="1.Next.js整体介绍"></a>1.Next.js整体介绍</h3><p>Next.js 是 React 服务端渲染应用框架，用于构建 SEO 友好的 SPA 应用.</p>
<p>1.支持两种预渲染方式，静态生成和服务端渲染.<br>2.基于页面的路由系统，路由零配置.<br>3.自动代码拆分，优化页面加载速度.<br>4.支持静态导出，可将应用导出为静态网站.<br>5.内置CSS-in-JS库styled-jsx.<br>6.方案成熟，可用于生产环境，世界许多公司都在使用.<br>7.应用部署简单，拥有专属部署环境 Vercel，也可以部署在其他环境.</p>
<h3 id="2-创建Next项目"><a href="#2-创建Next项目" class="headerlink" title="2.创建Next项目"></a>2.创建Next项目</h3><p>创建：npm init next-app next-guide<br>运行：npm run dev<br>访问：localhost:3000</p>
<p>临时安装 create-next-app 用于创建 Next.js 项目</p>
<h3 id="3-基于页面的路由系统-创建页面"><a href="#3-基于页面的路由系统-创建页面" class="headerlink" title="3.基于页面的路由系统-创建页面"></a>3.基于页面的路由系统-创建页面</h3><p>在 Next.js 中，页面是被放置在 pages 文件夹中的 React 组件.<br>组件需要被默认导出.<br>组件文件中不需要引入 React.<br>页面地址与文件地址是对应的关系.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pages/list.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">List</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>List page works<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>pages/index.js       /<br>pages/list.js        /list<br>pages/post/first.js  /post/first</p>
<h3 id="4-基于页面的路由系统-页面跳转"><a href="#4-基于页面的路由系统-页面跳转" class="headerlink" title="4.基于页面的路由系统-页面跳转"></a>4.基于页面的路由系统-页面跳转</h3><blockquote>
<p>页面跳转</p>
</blockquote>
<p>Link 组件默认使用 JavaScript 进行页面跳转，既 SPA 形式的跳转.<br>如果浏览器中 JavaScript 被禁用，则使用链接跳转.<br>Link 组件中不应该添加出 href 属性以外的属性，其余属性添加到a标签上.<br>Link 组件通过预取（在生产中）功能自动优化应用程序以获得最佳性能.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Link <span class="keyword">from</span> <span class="string">'next/link'</span>;</span><br><span class="line">&lt;Link href=<span class="string">"/list"</span>&gt;<span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">title</span>=<span class="string">"list page"</span>&gt;</span>list page<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span>&lt;<span class="regexp">/Link&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="5-Next应用中的静态资源访问"><a href="#5-Next应用中的静态资源访问" class="headerlink" title="5.Next应用中的静态资源访问"></a>5.Next应用中的静态资源访问</h3><blockquote>
<p>静态资源</p>
</blockquote>
<p>应用程序根目录中的 public 文件夹用于提供静态资源.</p>
<p>通过以下形式进行访问.<br>public/images/1.jpg -&gt; /images/1.jpg<br>public/css/base.css -&gt; /css/base.css</p>
<h3 id="6-修改页面中的元数据"><a href="#6-修改页面中的元数据" class="headerlink" title="6.修改页面中的元数据"></a>6.修改页面中的元数据</h3><p>通过 Head 组件修改元数据.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Head <span class="keyword">from</span> <span class="string">'next/head'</span>;</span><br><span class="line">&lt;&gt;</span><br><span class="line">  &lt;Head&gt;</span><br><span class="line">    &lt;title&gt;Index Page&lt;<span class="regexp">/title&gt;</span></span><br><span class="line"><span class="regexp">  &lt;/</span>Head&gt;</span><br><span class="line">&lt;<span class="regexp">/&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="7-Next应用中添加样式的方式"><a href="#7-Next应用中添加样式的方式" class="headerlink" title="7.Next应用中添加样式的方式"></a>7.Next应用中添加样式的方式</h3><blockquote>
<p>内置 style-jsx</p>
</blockquote>
<p>在 Next.js 中内置了 style-jsx,它是一个 CSS-in-JS，允许在 React 组件中编写CSS，CSS仅作用于组件内部.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;Link href=<span class="string">"/list"</span>&gt;</span><br><span class="line">  &lt;a className=<span class="string">"Demo"</span>&gt;jump to list page&lt;<span class="regexp">/a&gt;</span></span><br><span class="line"><span class="regexp">&lt;Link&gt;</span></span><br><span class="line"><span class="regexp">&lt;style jsx&gt;&#123;`</span></span><br><span class="line"><span class="regexp">.demo &#123;</span></span><br><span class="line"><span class="regexp">    color: red;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">`&#125;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>CSS 模块</p>
</blockquote>
<p>通过使用 CSS 模块功能，允许将组件的 CSS 样式编写在单独的 CSS 文件中.<br>CSS 模块约定样式文件的名称必须为“组件文件名称.module.css”</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.module.css</span></span><br><span class="line">.p &#123; <span class="attr">color</span>: green &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">import</span> styles <span class="keyword">from</span> <span class="string">'./index.module.css'</span>;</span><br><span class="line">&lt;div className=&#123;styles.p&#125;&gt;&lt;<span class="regexp">/div&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>全局样式文件</p>
</blockquote>
<p>1.在pages文件夹中新建_app.js文件并加入如下代码<br>2.在项目根目录下创建styles文件夹，并在其中创建global.css<br>3.在_app.js中通过import引入global.css.<br>4.重新启动开发服务器</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params">&#123; Component, pageProps &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">Component</span> &#123; <span class="attr">...pageProps</span> &#125; /&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-预渲染介绍"><a href="#8-预渲染介绍" class="headerlink" title="8.预渲染介绍"></a>8.预渲染介绍</h3><blockquote>
<p>预渲染概述</p>
</blockquote>
<p>预渲染是指数据和HTML的拼接在服务器端提前完成.<br>预渲染可以使 SEO 更加友好.<br>预渲染会带来更好的用户体验，可以无需运行 JavaScript 即可查看应用程序 UI.</p>
<blockquote>
<p>预渲染的两种形式</p>
</blockquote>
<p>在 Next.js 中支持两种形式的预渲染：静态生成和服务器端渲染.<br>静态生成和服务器端渲染是生成 HTML 的时机不同.<br>静态生成：静态生成是在构建时生成 HTML.以后的每个请求都共用构建时生成好的 HTML.<br>服务器端渲染：服务器端渲染是在请求时生成 HTML。每个请求都会重新生成 HTML.</p>
<blockquote>
<p>两种预渲染方式的选择</p>
</blockquote>
<p>Next.js 允许开发者为每个页面选择不同的预渲染方式，不同的预渲染方式拥有不同的特点.应根据场景进行渲染.<br>但大多数页面建议使用静态生成.<br>静态生成一次构建，反复使用，访问速度快.因为页面都是事先生成好的.<br>使用场景：营销页面、博客文章、电子商务产品列表、帮助和文档.<br>服务器端渲染访问速度不如静态生成快，但是由于每次请求都会重新渲染，所以使用数据频繁更新的页面或页面内容随请求变化而变化的页面.</p>
<h3 id="9-实现静态生成"><a href="#9-实现静态生成" class="headerlink" title="9.实现静态生成"></a>9.实现静态生成</h3><blockquote>
<p>无数据和有数据的静态生成</p>
</blockquote>
<p>如果组件不需要在其他地方获取数据，直接进行静态生成.<br>如果组件需要在其他地方获取数据，在构建时 Next.js 会预先获取组件需要的数据，然后再对组件进行静态生成.</p>
<blockquote>
<p>静态生成 getStaticProps</p>
</blockquote>
<p>getStaticProps 方法的作用是获取组件静态生成需要的数据.并通过 props 的方式将数据传递给组件.<br>该方法是一个异步函数，需要在组件内部进行导出.<br>在开发模式下，getStaticProps 改为在每个请求上运行.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getStaticProps</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 从文件系统，API，数据库中获取的数据</span></span><br><span class="line">  <span class="keyword">const</span> data = ...</span><br><span class="line">  <span class="comment">// props 属性的值将会传递给组件</span></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    props: ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="10-实现服务器端渲染"><a href="#10-实现服务器端渲染" class="headerlink" title="10.实现服务器端渲染"></a>10.实现服务器端渲染</h3><blockquote>
<p>服务器端渲染 getServerSideProps</p>
</blockquote>
<p>如果采用服务器端渲染，需要在组件中导出 getServerSideProps 方法.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getServerSideProps</span>(<span class="params">context</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// context 中包含特定的请求参数</span></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    props: &#123;</span><br><span class="line">      <span class="comment">// props for your component</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="11-实现基于动态路由的静态生成"><a href="#11-实现基于动态路由的静态生成" class="headerlink" title="11.实现基于动态路由的静态生成"></a>11.实现基于动态路由的静态生成</h3><blockquote>
<p>基于动态路由的静态生成</p>
</blockquote>
<p>基于参数为页面组件生成 HTML 页面，有多少参数就生成多少 HTML 页面<br>在构建应用时，先获取用户可以访问的所有路由参数，再根据路由参数获取具体数据，然后根据数据生成静态 HTML</p>
<blockquote>
<p>实现基于动态路由的静态生成</p>
</blockquote>
<p>1.创建基于动态路由的页面组件文件，命名时在文件名称外面加上[]，比如[id].js<br>2.导出异步函数 getStaticPaths，用于获取所有用户可以访问的路由参数.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getStaticPaths</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="comment">// 此处获取所有用户可以访问的路由参数</span></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="comment">// 返回固定格式的路由参数</span></span><br><span class="line">    paths: [&#123;<span class="attr">params</span>:&#123;<span class="attr">id</span>:<span class="number">1</span>&#125;&#125;, &#123;<span class="attr">params</span>:&#123;<span class="attr">id</span>:<span class="number">2</span>&#125;&#125;],</span><br><span class="line">    当用户访问的路由参数没有在当前函数中返回时，是否显示<span class="number">404</span>页面 <span class="literal">false</span>：显示 <span class="literal">true</span> 不显示</span><br><span class="line">    fallback: <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注：getStaticPaths 和 getStaticProps 只运行在服务器端，永远不会运行在客户端，甚至不会被打包到客户端 JavaScript 中，意味着这里可以随意写服务端代码，比如查询数据库.</p>
<h3 id="12-fallback选项的作用"><a href="#12-fallback选项的作用" class="headerlink" title="12.fallback选项的作用"></a>12.fallback选项的作用</h3><p>略</p>
<h3 id="13-自定义404页面"><a href="#13-自定义404页面" class="headerlink" title="13.自定义404页面"></a>13.自定义404页面</h3><p>要创建自定义 404 页面，需要在 pages 文件夹中创建 404.js 文件.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">Custom404</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>404 - Page Not Found<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="14-API-Routes"><a href="#14-API-Routes" class="headerlink" title="14.API Routes"></a>14.API Routes</h3><blockquote>
<p>什么是 API Routes</p>
</blockquote>
<p>API Routes 可以理解为接口，客户端向服务器端发送请求获取数据的接口.<br>Next.js 应用允许 React 开发者编写服务器端代码创建数据接口.</p>
<blockquote>
<p>如何实现 API Routes</p>
</blockquote>
<p>1.在 pages/api 文件夹中创建 API Routes 文件，比如 user.js<br>2.在文件中默认导出请求处理数据，函数有两个参数，req为请求对象，res为响应对象.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  res.status(<span class="number">200</span>).send(&#123;<span class="attr">id</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="string">'Tom'</span>&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注：当前 API Routes 可以接收任何 Http 请求方法.</p>
<p>3.访问 API Routes：localhost:3000/api/user</p>
<p>不要在 getStaticPaths 或 getStaticProps 函数中访问 API Routes，因为这两个函数就是在服务器端运行的，可以直接写服务器端代码.</p>
<h3 id="15-案例代码初始化配置"><a href="#15-案例代码初始化配置" class="headerlink" title="15.案例代码初始化配置"></a>15.案例代码初始化配置</h3><ul>
<li>npm init next-app movie</li>
<li>npm install @chakra-ui/core@next</li>
<li>npx chakra-cli init –theme</li>
<li>npm install @emotion/babel-preset-css-prop –save</li>
</ul>
<h3 id="16-实现头部组件布局"><a href="#16-实现头部组件布局" class="headerlink" title="16.实现头部组件布局"></a>16.实现头部组件布局</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// components/Header.js</span></span><br><span class="line"><span class="keyword">import</span> &#123;Box, Container, Button, Image &#125; <span class="keyword">from</span> <span class="string">'@chakra-ui/core'</span>; leftIcon=&#123;&lt;<span class="regexp">/&gt;&#125;</span></span><br><span class="line"><span class="regexp">import styled from "@emotion/</span>styled<span class="string">";</span></span><br><span class="line"><span class="string">import &#123; css &#125; from "</span>@emotion/core<span class="string">";</span></span><br><span class="line"><span class="string">import &#123; FaSignInAlt, FaSearch &#125; from "</span>react-icons/fa<span class="string">";</span></span><br><span class="line"><span class="string">import &#123; BsFillPersonFill &#125; from "</span>react-icons/bs<span class="string">";</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">const log = css`</span></span><br><span class="line"><span class="string">  position: absolute;</span></span><br><span class="line"><span class="string">  left: 50%;</span></span><br><span class="line"><span class="string">  top: 50%;</span></span><br><span class="line"><span class="string">  transform: translate(-50%, -50%);</span></span><br><span class="line"><span class="string">  width: 140px;</span></span><br><span class="line"><span class="string">`;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">const SignInAndJoin = styled.div`</span></span><br><span class="line"><span class="string">  height: 52px;</span></span><br><span class="line"><span class="string">  line-height: 52px;</span></span><br><span class="line"><span class="string">  border-left: 1px solid #393939;</span></span><br><span class="line"><span class="string">  border-right: 1px solid #393939;</span></span><br><span class="line"><span class="string">  padding: 0 6px;</span></span><br><span class="line"><span class="string">  float: left;</span></span><br><span class="line"><span class="string">  color: #fff;</span></span><br><span class="line"><span class="string">  &amp; &gt; button &#123;</span></span><br><span class="line"><span class="string">    padding: 0 10px;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  &amp; &gt; button: nth-of-type(1):after &#123;</span></span><br><span class="line"><span class="string">    content: "</span><span class="string">";</span></span><br><span class="line"><span class="string">    width: 1px;</span></span><br><span class="line"><span class="string">    height: 10px;</span></span><br><span class="line"><span class="string">    background: #fff;</span></span><br><span class="line"><span class="string">    position: absolute;</span></span><br><span class="line"><span class="string">    right: 0;</span></span><br><span class="line"><span class="string">    top: 21px;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">`;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">const Search = styled.a`</span></span><br><span class="line"><span class="string">  float: right;</span></span><br><span class="line"><span class="string">  height: 52px;</span></span><br><span class="line"><span class="string">  border-left: 1px solid #393939;</span></span><br><span class="line"><span class="string">  border-right: 1px solid #393939;</span></span><br><span class="line"><span class="string">  color: #FFF;</span></span><br><span class="line"><span class="string">  font-size: 20px;</span></span><br><span class="line"><span class="string">  padding: 0 10px;</span></span><br><span class="line"><span class="string">  display: flex;</span></span><br><span class="line"><span class="string">  align-items: center;</span></span><br><span class="line"><span class="string">`;</span></span><br><span class="line"><span class="string">export default function Header() &#123;</span></span><br><span class="line">  return &lt;Box h=&#123;52&#125; bgColor="#202020" borderBottom="1px solid #393939"&gt;</span><br><span class="line">    &lt;Container h=&#123;<span class="number">52</span>&#125; maxW=&#123;<span class="number">1200</span>&#125; pos=<span class="string">"realtive"</span>&gt;</span><br><span class="line">      &lt;SignInAndJoin&gt;</span><br><span class="line">        &lt;Button leftIcon=&#123;&lt;FaSignInAlt/&gt;&#125;&gt;登录&lt;<span class="regexp">/Button&gt;</span></span><br><span class="line"><span class="regexp">        &lt;Button leftIcon=&#123;&lt;BsFillPersonFill/</span>&gt;&#125;&gt;注册&lt;<span class="regexp">/Button&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>SignInAndJoin&gt;</span><br><span class="line">      &lt;Image css=&#123;logo&#125; src=<span class="string">"/images/logo.png"</span>/&gt;</span><br><span class="line">      &lt;Search&gt;</span><br><span class="line">        &lt;FaSearch/&gt;</span><br><span class="line">      &lt;<span class="regexp">/Search&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>Container&gt;</span><br><span class="line">  &lt;<span class="regexp">/Box&gt;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="17-实现导航组件布局"><a href="#17-实现导航组件布局" class="headerlink" title="17.实现导航组件布局"></a>17.实现导航组件布局</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// components/Navigation.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; Box, HStack &#125; <span class="keyword">from</span> <span class="string">'@chakra-ui/core'</span>;</span><br><span class="line"><span class="keyword">import</span> Link <span class="keyword">from</span> <span class="string">'next/link'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">Navigation</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">Box</span> <span class="attr">h</span>=<span class="string">&#123;52&#125;</span> <span class="attr">bgColor</span>=<span class="string">"#202020"</span> <span class="attr">color</span>=<span class="string">"#FFF"</span>&gt;</span></span></span><br><span class="line">    &lt;HStack h=&#123;52&#125; spacing=&#123;3&#125; justifyContent="center" alignItems="center"&gt;</span><br><span class="line">      &lt;Link href="#"&gt;&lt;a&gt;影片&lt;/a&gt;&lt;/Link&gt;</span><br><span class="line">      &lt;Link href="#"&gt;&lt;a&gt;漫画&lt;/a&gt;&lt;/Link&gt;</span><br><span class="line">      &lt;Link href="#"&gt;&lt;a&gt;电影&lt;/a&gt;&lt;/Link&gt;</span><br><span class="line">      &lt;Link href="#"&gt;&lt;a&gt;电视&lt;/a&gt;&lt;/Link&gt;</span><br><span class="line">      &lt;Link href="#"&gt;&lt;a&gt;新闻&lt;/a&gt;&lt;/Link&gt;</span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">HStack</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">Box</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="18-实现轮播图组件布局"><a href="#18-实现轮播图组件布局" class="headerlink" title="18.实现轮播图组件布局"></a>18.实现轮播图组件布局</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// components/Swiper.js</span></span><br><span class="line"><span class="comment">// import "react-reaponsive-carousel/lib/styles/carousel.min.css";</span></span><br><span class="line"><span class="keyword">import</span> &#123; Carousel &#125; <span class="keyword">from</span> <span class="string">"react-reaponsive-carousel"</span>;</span><br><span class="line"><span class="keyword">import</span> Head <span class="keyword">from</span> <span class="string">'next/head'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; css &#125; <span class="keyword">from</span> <span class="string">'@emotion/core'</span>;</span><br><span class="line"><span class="keyword">import</span> styled <span class="keyword">from</span> <span class="string">'@emotion/styled'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Box, Heading, Text, Button &#125; <span class="keyword">from</span> <span class="string">'@chakra-ui/core'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> CarouselItem = styled.div<span class="string">`</span></span><br><span class="line"><span class="string">  position: relative;</span></span><br><span class="line"><span class="string">  &amp; &gt; div &#123;</span></span><br><span class="line"><span class="string">    position: absolute;</span></span><br><span class="line"><span class="string">    left: 50%;</span></span><br><span class="line"><span class="string">    top: 0;</span></span><br><span class="line"><span class="string">    transform: translateX(-50%);</span></span><br><span class="line"><span class="string">    color: #FFF;</span></span><br><span class="line"><span class="string">    padding-top: 180px;</span></span><br><span class="line"><span class="string">    text-align: left;</span></span><br><span class="line"><span class="string">    width: 100%;</span></span><br><span class="line"><span class="string">    max-width: 12500px;</span></span><br><span class="line"><span class="string">    &amp; &gt; p &#123;</span></span><br><span class="line"><span class="string">      margin: 15px 0;</span></span><br><span class="line"><span class="string">      font-size: 14px;</span></span><br><span class="line"><span class="string">      width: 450px;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  &amp; &gt; img &#123;</span></span><br><span class="line"><span class="string">    filter: brightness(50%);</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> swiperContainer = css`</span><br><span class="line"><span class="css">  <span class="selector-tag">postition</span>: <span class="selector-tag">relative</span>;</span></span><br><span class="line"><span class="css">  &amp; &gt; <span class="selector-class">.carousel</span>: <span class="selector-tag">last-child</span> &#123;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">position</span>: <span class="selector-tag">absolute</span>;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">left</span>: 0;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">bottom</span>: 0;</span></span><br><span class="line"><span class="css">    &amp; &gt; <span class="selector-class">.thumbs-wrapper</span> &gt; <span class="selector-class">.thumbs</span> &#123;</span></span><br><span class="line"><span class="css">      <span class="selector-tag">display</span>: <span class="selector-tag">flex</span>;</span></span><br><span class="line"><span class="css">      <span class="selector-tag">justify-content</span>: <span class="selector-tag">center</span>;</span></span><br><span class="line"><span class="css">    &#125;</span></span><br><span class="line"><span class="css">  &#125;</span></span><br><span class="line"><span class="css">`</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">Swiper</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &lt;Head&gt;</span><br><span class="line">        &lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"/css/carousel.min.css"</span> /&gt;</span><br><span class="line">      &lt;<span class="regexp">/Head&gt;</span></span><br><span class="line"><span class="regexp">      &lt;Carousel css=&#123;swiperContainer&#125; showArrows=&#123;false&#125; showIndicators=&#123;false&#125; showStatus=&#123;false&#125;&gt;</span></span><br><span class="line"><span class="regexp">        &lt;CarouselItem&gt;</span></span><br><span class="line"><span class="regexp">          &lt;img src="/im</span>ages/<span class="number">1.</span>jpeg<span class="string">" /&gt;</span></span><br><span class="line"><span class="string">          &lt;Box&gt;</span></span><br><span class="line"><span class="string">            &lt;Heading as="</span>h2<span class="string">" size="</span>lg<span class="string">"&gt;KING IN BLACK&lt;/Heading&gt;</span></span><br><span class="line"><span class="string">            &lt;Text&gt;The next shocking chapter in Donny Cates and Ryan Stegman's Venom Saga is revealed!&lt;/Text&gt;</span></span><br><span class="line"><span class="string">            &lt;Button colorScheme="</span>red<span class="string">"&gt;CHECK DETAIL&lt;/Button&gt;</span></span><br><span class="line"><span class="string">          &lt;/Box&gt;</span></span><br><span class="line"><span class="string">        &lt;/CarouselItem&gt;</span></span><br><span class="line"><span class="string">        &lt;CarouselItem&gt;</span></span><br><span class="line"><span class="string">          &lt;img src="</span>/images/<span class="number">2.</span>jpeg<span class="string">" /&gt;</span></span><br><span class="line"><span class="string">        &lt;/CarouselItem&gt;</span></span><br><span class="line"><span class="string">        &lt;CarouselItem&gt;</span></span><br><span class="line"><span class="string">          &lt;img src="</span>/images/<span class="number">3.</span>jpeg<span class="string">" /&gt;</span></span><br><span class="line"><span class="string">        &lt;/CarouselItem&gt;</span></span><br><span class="line"><span class="string">      &lt;/Carousel&gt;</span></span><br><span class="line"><span class="string">    &lt;/&gt;</span></span><br><span class="line"><span class="string">  )</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="19-电影列表布局"><a href="#19-电影列表布局" class="headerlink" title="19.电影列表布局"></a>19.电影列表布局</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// components/Movie.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; Box, Heading, HStack, Image, Text &#125; <span class="keyword">from</span> <span class="string">'@chakra-ui/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; MdMovie &#125; <span class="keyword">from</span> <span class="string">"react-icons/md"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">Movie</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">Box</span> <span class="attr">maxW</span>=<span class="string">&#123;1200&#125;</span> <span class="attr">mx</span>=<span class="string">"auto"</span> <span class="attr">mt</span>=<span class="string">"20px"</span>&gt;</span></span></span><br><span class="line">    &lt;HStack fontSize="24px"&gt;</span><br><span class="line">      &lt;MdMovie /&gt;</span><br><span class="line">      &lt;Heading as="h3" fontSize="24px"&gt;电影&lt;/Heading&gt;</span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">HStack</span>&gt;</span></span></span><br><span class="line">    &lt;HStack mt="20px"&gt;</span><br><span class="line">      &lt;Box w=&#123;290&#125;&gt;</span><br><span class="line">        &lt;Image src="/images/item_1.jpg" /&gt;</span><br><span class="line">        &lt;Text mt="10px"&gt;Marvel Mission Recap: captain Marvel's Star of Hala&lt;/Text&gt;</span><br><span class="line">      &lt;/Box&gt;</span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">HStack</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">Box</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="20-电影详情页面布局"><a href="#20-电影详情页面布局" class="headerlink" title="20.电影详情页面布局"></a>20.电影详情页面布局</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// components/Layout.js</span></span><br><span class="line"><span class="keyword">import</span> Header <span class="keyword">from</span> <span class="string">'./Header'</span>;</span><br><span class="line"><span class="keyword">import</span> Navigation <span class="keyword">from</span> <span class="string">'./Navigation'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">Layout</span>(<span class="params">&#123;children&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">Header</span> /&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">Navigation</span> /&gt;</span></span></span><br><span class="line"><span class="xml">    &#123;children&#125;</span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pages/detail/[id].js</span></span><br><span class="line"><span class="keyword">import</span> Layout <span class="keyword">from</span> <span class="string">"../../components/Layout"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Box, Heading, Divider, Text &#125; <span class="keyword">from</span> <span class="string">"@chakra-ui/core"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; css &#125; <span class="keyword">from</span> <span class="string">'@emotion/core'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> DetailContainer = css`</span><br><span class="line"><span class="css">  <span class="selector-tag">padding</span>: 10<span class="selector-tag">px</span> 0;</span></span><br><span class="line"><span class="css">  &amp; &gt; <span class="selector-tag">p</span> &#123;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">font-size</span>: 14<span class="selector-tag">px</span>;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">margin-bottom</span>: 10<span class="selector-tag">px</span>;</span></span><br><span class="line"><span class="css">  &#125;</span></span><br><span class="line"><span class="css">  &amp; &gt; <span class="selector-tag">img</span> &#123;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">margin-bottom</span>: 10<span class="selector-tag">px</span>;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">display</span>: <span class="selector-tag">block</span>;</span></span><br><span class="line"><span class="css">  &#125;</span></span><br><span class="line"><span class="css">`</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> funciton Detail() &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Layout&gt;</span><br><span class="line">      &lt;Box maxW=&#123;<span class="number">1200</span>&#125; mx=<span class="string">"auto"</span> mt=<span class="string">"70px"</span>&gt;</span><br><span class="line">        &lt;Heading <span class="keyword">as</span>=<span class="string">"h2"</span> mx=<span class="string">"auto"</span> mt=<span class="string">"70px"</span>&gt;</span><br><span class="line">          Marvel Mission Recap: Captain Marvel<span class="string">'s Star of Hala</span></span><br><span class="line"><span class="string">        &lt;/Heading&gt;</span></span><br><span class="line"><span class="string">        &lt;Heading mt="" as="h4" size="lg" color="gray.500" fontWeight="light"&gt;</span></span><br><span class="line"><span class="string">          The results are out of this world!`</span></span><br><span class="line"><span class="string">        &lt;/Heading&gt;</span></span><br><span class="line"><span class="string">        &lt;Divider mt="10px" /&gt;</span></span><br><span class="line"><span class="string">        &lt;Box overflow="hidden" mt="10px"&gt;</span></span><br><span class="line"><span class="string">          &lt;Text float="left"&gt;作者：Tomas&lt;/Text&gt;</span></span><br><span class="line"><span class="string">          &lt;Text float="right"&gt;发布时间： 2045-05-25&lt;/Text&gt;</span></span><br><span class="line"><span class="string">        &lt;/Box&gt;</span></span><br><span class="line"><span class="string">        &lt;Divider mt="10px" /&gt;</span></span><br><span class="line"><span class="string">        &lt;Box css=&#123;DetailContainer&#125;&gt;</span></span><br><span class="line"><span class="string">          &lt;p&gt;Congrats agents - it appears that many of you successfully completed the latest Marvel Mission&lt;/p&gt;</span></span><br><span class="line"><span class="string">          &lt;p&gt;Congrats agents - it appears that many of you successfully completed the latest Marvel Mission&lt;/p&gt;</span></span><br><span class="line"><span class="string">          &lt;p&gt;Congrats agents - it appears that many of you successfully completed the latest Marvel Mission&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;/Box&gt;</span></span><br><span class="line"><span class="string">      &lt;/Box&gt;</span></span><br><span class="line"><span class="string">    &lt;/Layout&gt;</span></span><br><span class="line"><span class="string">  )</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="21-实现首页组件的静态生成：轮播图数据获取与展示"><a href="#21-实现首页组件的静态生成：轮播图数据获取与展示" class="headerlink" title="21.实现首页组件的静态生成：轮播图数据获取与展示"></a>21.实现首页组件的静态生成：轮播图数据获取与展示</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Layout <span class="keyword">from</span> <span class="string">'../components/Layout'</span>;</span><br><span class="line"><span class="keyword">import</span> Swiper, &#123; loadSwiper &#125; <span class="keyword">from</span> <span class="string">'../components/Swiper'</span>;</span><br><span class="line"><span class="keyword">import</span> Movie <span class="keyword">from</span> <span class="string">'../components/Movie'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">Home</span>(<span class="params">&#123;swiper&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Layout&gt;</span><br><span class="line">      &lt;Swiper data=&#123;swiper&#125;/&gt;</span><br><span class="line">      &lt;Movie /&gt;</span><br><span class="line">    &lt;<span class="regexp">/Layout&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">export async function getStaticProps() &#123;</span></span><br><span class="line"><span class="regexp">  let &#123;data: swiper&#125; = await loadSwiper();</span></span><br><span class="line"><span class="regexp">  return &#123;</span></span><br><span class="line"><span class="regexp">    props: &#123;</span></span><br><span class="line"><span class="regexp">      swiper</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="22-实现首页组件的静态生成：电影列表数据的获取与展示"><a href="#22-实现首页组件的静态生成：电影列表数据的获取与展示" class="headerlink" title="22.实现首页组件的静态生成：电影列表数据的获取与展示"></a>22.实现首页组件的静态生成：电影列表数据的获取与展示</h3><p>略</p>
<h3 id="23-实现详情页基于动态路由的静态生成"><a href="#23-实现详情页基于动态路由的静态生成" class="headerlink" title="23.实现详情页基于动态路由的静态生成"></a>23.实现详情页基于动态路由的静态生成</h3><p>略</p>
<h3 id="24-导出静态网站"><a href="#24-导出静态网站" class="headerlink" title="24.导出静态网站"></a>24.导出静态网站</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"scripts"</span>: &#123;</span><br><span class="line">  <span class="string">"export"</span>: <span class="string">"next build &amp;&amp; next export"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="25-自定义Next应用服务器"><a href="#25-自定义Next应用服务器" class="headerlink" title="25.自定义Next应用服务器"></a>25.自定义Next应用服务器</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server/index.js</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> next = <span class="built_in">require</span>(<span class="string">'next'</span>);</span><br><span class="line"><span class="keyword">const</span> dev = process.env.NODE_ENV!==<span class="string">'production'</span>;</span><br><span class="line"><span class="keyword">const</span> app = next(&#123;dev&#125;);</span><br><span class="line"><span class="keyword">const</span> handler = app.getRequestHandler();</span><br><span class="line">app.prepare().then(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">  <span class="keyword">const</span> server = express();</span><br><span class="line">  server.get(<span class="string">'*'</span>, (req, res) =&gt; &#123;</span><br><span class="line">    handler(req, res)</span><br><span class="line">  &#125;);</span><br><span class="line">  server.listen(<span class="number">3000</span>,()=&gt;<span class="built_in">console</span>.log(<span class="string">'服务器启动成功'</span>))</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"scripts"</span>: &#123;</span><br><span class="line">  <span class="string">"dev"</span>: <span class="string">"nodemon server/index.js"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="26-部署Next应用到Vercel平台"><a href="#26-部署Next应用到Vercel平台" class="headerlink" title="26.部署Next应用到Vercel平台"></a>26.部署Next应用到Vercel平台</h3><ul>
<li>vercel.com</li>
</ul>
<h2 id="任务三：Gatsby"><a href="#任务三：Gatsby" class="headerlink" title="任务三：Gatsby"></a>任务三：Gatsby</h2><h3 id="1-什么是Gatsby以及静态应用的优势"><a href="#1-什么是Gatsby以及静态应用的优势" class="headerlink" title="1.什么是Gatsby以及静态应用的优势"></a>1.什么是Gatsby以及静态应用的优势</h3><p>Gatsby 是一个静态站点生成器.<br>官网：<a href="https://www.gatsbyjs.org/" target="_blank" rel="noopener">https://www.gatsbyjs.org/</a></p>
<blockquote>
<p>静态应用的优势</p>
</blockquote>
<p>1.访问速度快<br>2.更利于 SEO 搜索引擎的内容抓取<br>3.部署简单</p>
<h3 id="2-Gatsby工作流程与框架特性"><a href="#2-Gatsby工作流程与框架特性" class="headerlink" title="2.Gatsby工作流程与框架特性"></a>2.Gatsby工作流程与框架特性</h3><blockquote>
<p>Gatsby 总览</p>
</blockquote>
<p>1.基于 React 和 GraphQL.结合了 webpack，babel，react-router等前端领域中最先进工具.开发人员开发体验好<br>2.采用数据层和 UI 分离而不失 SEO 的现代前端开发模式.对 SEO 非常友好<br>3.数据预读取，在浏览器空闲的时候预先读取链接对应的页面内容.使静态页面拥有 SPA 应用的用户体验，用户体验好<br>4.数据来源多样化：Headless CMS，markdown，API.<br>5.功能插件化，Gatsby 中提供了丰富且功能强大的各种类型的插件，用什么装什么.</p>
<h3 id="3-创建Gatsby项目"><a href="#3-创建Gatsby项目" class="headerlink" title="3.创建Gatsby项目"></a>3.创建Gatsby项目</h3><blockquote>
<p>1.全局安装脚手架工具</p>
</blockquote>
<ul>
<li>npm install gatsby-cli -g</li>
</ul>
<blockquote>
<p>2.创建项目</p>
</blockquote>
<p>创建：gatsby new project-name <a href="https://github.com/gatsbyjs/gatsby-starter-hello-world" target="_blank" rel="noopener">https://github.com/gatsbyjs/gatsby-starter-hello-world</a><br>启动：gatsby develop 或 npm start<br>访问：localhost:8000</p>
<h3 id="4-基于文件的路由系统"><a href="#4-基于文件的路由系统" class="headerlink" title="4.基于文件的路由系统"></a>4.基于文件的路由系统</h3><p>Gatsby框架内置基于文件的路由系统，页面组件被放置在 src/pages 文件夹中.</p>
<h3 id="5-以编程的方式创建页面"><a href="#5-以编程的方式创建页面" class="headerlink" title="5.以编程的方式创建页面"></a>5.以编程的方式创建页面</h3><p>基于一个模板创建多个HTML页面，有多少数据就创建多少页面<br>比如商品详情页面，有多少商品就生成多少商品详情展示页面.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// createPages 方法用于创建页面</span></span><br><span class="line"><span class="comment">// Gatsby 在构建应用时会调用该方法</span></span><br><span class="line"><span class="comment">// 该方法需要在 gatsby-node.js 文件中定义</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createPages</span>(<span class="params">&#123;actions&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;createPage&#125; = actions;</span><br><span class="line">  <span class="comment">// 获取模板绝对路径</span></span><br><span class="line">  <span class="comment">// 获取组件所需数据</span></span><br><span class="line">  <span class="comment">// 根据模板和数据创建页面</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;createPages&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-Link组件的使用"><a href="#6-Link组件的使用" class="headerlink" title="6.Link组件的使用"></a>6.Link组件的使用</h3><p>在 Gatsby 框架中页面跳转通过 Link 组件实现.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;Link&#125; <span class="keyword">from</span> <span class="string">'gatsby'</span>;</span><br><span class="line">&lt;Link to=<span class="string">"/list"</span>&gt;jump to list page&lt;<span class="regexp">/Link&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="7-GraphQL数据层介绍"><a href="#7-GraphQL数据层介绍" class="headerlink" title="7.GraphQL数据层介绍"></a>7.GraphQL数据层介绍</h3><p>在 Gatsby 框架中提供了一个统一的存储数据的地方，叫做数据层》<br>在应用构建时，Gatsby 会从外部获取数据并将数据放入数据层，组件可以直接从数据层查询数据.<br>数据层使用 GraphQL 构建.<br>调试工具：localhot:8000/___graphql</p>
<h3 id="8-在组件中从数据层中查询数据"><a href="#8-在组件中从数据层中查询数据" class="headerlink" title="8.在组件中从数据层中查询数据"></a>8.在组件中从数据层中查询数据</h3><blockquote>
<p>页面组件</p>
</blockquote>
<p>在组件文件中导出查询命令，框架执行查询并将结果传递给组件的prop对象.存储在props对象的data属性中.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;graphql&#125; <span class="keyword">from</span> <span class="string">"gatsby"</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">PageComponent</span>(<span class="params">&#123;data&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;data.site.siteMetadata.title&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> query = graphql<span class="string">`</span></span><br><span class="line"><span class="string">  query &#123;</span></span><br><span class="line"><span class="string">    site &#123;</span></span><br><span class="line"><span class="string">      siteMetadata &#123;</span></span><br><span class="line"><span class="string">        title</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">`</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>非页面组件</p>
</blockquote>
<p>通过钩子函数 useStaticQuery 进行手动查询.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;graphql,useStaticQuery&#125; <span class="keyword">from</span> <span class="string">"gatsby"</span>;</span><br><span class="line"><span class="keyword">const</span> data = useStaticQuery(graphql<span class="string">`</span></span><br><span class="line"><span class="string">  query &#123;</span></span><br><span class="line"><span class="string">    site &#123;</span></span><br><span class="line"><span class="string">      siteMetadata &#123;</span></span><br><span class="line"><span class="string">        title</span></span><br><span class="line"><span class="string">        description</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">`</span>)</span><br></pre></td></tr></table></figure>

<h3 id="9-Gatsby-框架中和插件相关的一些概念"><a href="#9-Gatsby-框架中和插件相关的一些概念" class="headerlink" title="9.Gatsby 框架中和插件相关的一些概念"></a>9.Gatsby 框架中和插件相关的一些概念</h3><p>Gatsby 框架内置插件系统，插件是为应用添加功能的最好的方式.</p>
<p>在 Gatsby 中有三种类型的插件：分别为数据源插件（source），数据转换插件（tansformer），功能插件（plugin）<br>数据源插件：负责从应用外部获取数据，将数据统一放在 Gatsby 的数据层中<br>数据转换插件：负责转换特定类型的数据的格式，比如将 markdown 文件中的内容转换为对象形式<br>功能插件：为应用提供功能，比如通过插件让应用支持 Less 或者TypeScript.</p>
<p><a href="https://www.gatsbyjs.org/plugins/" target="_blank" rel="noopener">https://www.gatsbyjs.org/plugins/</a></p>
<h3 id="10-将本地JSON文件数据添加到数据层中"><a href="#10-将本地JSON文件数据添加到数据层中" class="headerlink" title="10.将本地JSON文件数据添加到数据层中"></a>10.将本地JSON文件数据添加到数据层中</h3><p>要将本地 JSON 文件中的数据放入数据层需要用到两个插件.<br>gatsby-source-filesystem: 用于将本地文件中的数据添加至数据层.<br>gatsby-transformer-json: 将原始 JSON 字符串转换为 JavaScript 对象.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    plugins: [</span><br><span class="line">        &#123;</span><br><span class="line">            resolve: <span class="string">"gatsby-source-filesystem"</span>,</span><br><span class="line">            options: &#123;</span><br><span class="line">                name: <span class="string">"data"</span>,</span><br><span class="line">                path: <span class="string">`<span class="subst">$&#123;__dirname&#125;</span>/data/`</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"gatsby-transformer-json"</span>,</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="11-图像优化"><a href="#11-图像优化" class="headerlink" title="11.图像优化"></a>11.图像优化</h3><p>1.图像文件和数据文件不在源代码中的同一位置<br>2.图像路径基于构建站点的绝对路径，而不是相对于数据的路径，难以分析出图片的真实位置<br>3.图像没有经过任何优化操作</p>
<blockquote>
<p>图像优化</p>
</blockquote>
<p>gatsby-source-filesystem: 用于将本地文件信息添加至数据层<br>gatsby-plugin-sharp: 提供本地图像的处理功能（调整图像尺寸，压缩图像体积等等）<br>gatsby-transformer-sharp: 将 gatsby-plugin-sharp 插件处理后的图像信息添加到数据层<br>gatsby-image: React 组件，优化图像显示，基于 gatsby-transformer-sharp 插件转化后的数据</p>
<p>1.生成多个具有不同宽度的图像版本，为图像设置 srcset 和 sizes 属性，因此无论您的设备是什么宽度都可以加载到合适大小的图片<br>2.使用“模糊处理”技术，其中将一个20px宽的小图像显示为占位符直到实际图像下载完成为止</p>
<ul>
<li>npm install gatsby-plugin-shap gatsby-transformer-sharp gatsby-image</li>
</ul>
<h3 id="12-将本地markdown文件作为数据源构建文章列表"><a href="#12-将本地markdown文件作为数据源构建文章列表" class="headerlink" title="12.将本地markdown文件作为数据源构建文章列表"></a>12.将本地markdown文件作为数据源构建文章列表</h3><blockquote>
<p>构建文章列表</p>
</blockquote>
<p>1.通过 gatsby-source-filesystem 将 markdown 文件数据放入数据层</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">resolve: <span class="string">`gatsby-source-filesystem`</span>,</span><br><span class="line">options: &#123;</span><br><span class="line">    name:<span class="string">`posts`</span>,</span><br><span class="line">    path:<span class="string">`<span class="subst">$&#123;__dirname&#125;</span>/src/posts`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.通过 gatsby-transformer-remark 将数据层中的原始 markdown 数据转换为对象形式</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    plugins: [<span class="string">`gatsby-transformer-remark`</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="13-以编程方式为所有md数据节点添加slug属性"><a href="#13-以编程方式为所有md数据节点添加slug属性" class="headerlink" title="13.以编程方式为所有md数据节点添加slug属性"></a>13.以编程方式为所有md数据节点添加slug属性</h3><blockquote>
<p>构建文章详情</p>
</blockquote>
<p>1.重新构建查询数据，添加 slug 作为请求标识，slug值为文件名称</p>
<p>gatsby.md -&gt; /posts/gatsby<br>react.md -&gt; /post/react</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> onCreateNode = <span class="function">(<span class="params">&#123;node,actions&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;createNodeField&#125; = actions;</span><br><span class="line">    <span class="keyword">if</span>(node.internal.type === <span class="string">'MarkdownRemark'</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> slug = path.basename(node.fileAbsollutePath, <span class="string">'.md'</span>);</span><br><span class="line">        createNodeField(&#123;</span><br><span class="line">            node,</span><br><span class="line">            name: <span class="string">'slug'</span>,</span><br><span class="line">            value: slug</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="14-根据slug构建文章详情页"><a href="#14-根据slug构建文章详情页" class="headerlink" title="14.根据slug构建文章详情页"></a>14.根据slug构建文章详情页</h3><p>2.根据 slug 标识构建页面</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> createPages = <span class="keyword">async</span>(&#123;graphql, actions&#125;) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;createPage&#125; = actions;</span><br><span class="line">    <span class="keyword">const</span> template = path.resolve(<span class="string">'./src/tempalte/blog.js'</span>);</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> graphql(<span class="string">``</span>);</span><br><span class="line">    res.data.allMarkdownRemark.edges.forEach(<span class="function"><span class="params">edge</span> =&gt;</span> &#123;</span><br><span class="line">    createPage(&#123;</span><br><span class="line">        component: template,</span><br><span class="line">        path: <span class="string">`/blog/<span class="subst">$&#123;edge.node.fileds.slug&#125;</span>`</span>,</span><br><span class="line">        context: &#123;<span class="attr">slug</span>:edge.node.fileds.slug&#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="15-解决markdown文件中的图片显示优化问题"><a href="#15-解决markdown文件中的图片显示优化问题" class="headerlink" title="15.解决markdown文件中的图片显示优化问题"></a>15.解决markdown文件中的图片显示优化问题</h3><p>4.处理 markdown 文件中图片</p>
<p>gatsby-remark-images: 处理 markdown 中的图片，以便可以在生产环境中使用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    resolve: <span class="string">"gatsby-transformer-remark"</span>,</span><br><span class="line">    options: &#123;</span><br><span class="line">        plugins: [<span class="string">"gatsby-remark-images"</span>],</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="16-将CMS作为Gatsby应用程序的外部数据源"><a href="#16-将CMS作为Gatsby应用程序的外部数据源" class="headerlink" title="16.将CMS作为Gatsby应用程序的外部数据源"></a>16.将CMS作为Gatsby应用程序的外部数据源</h3><blockquote>
<p>从 Strapi 中获取数据</p>
</blockquote>
<p>创建项目：npx create-strapi-app 项目名称<br><a href="https://github.com/strapi/strapi" target="_blank" rel="noopener">https://github.com/strapi/strapi</a></p>
<p><a href="https://www.gatsbyjs.org/packages/gatsby-source-strapi/?=strapi" target="_blank" rel="noopener">https://www.gatsbyjs.org/packages/gatsby-source-strapi/?=strapi</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    resolve: <span class="string">`gatsby-source-strapi`</span>,</span><br><span class="line">    options: &#123;</span><br><span class="line">        apiURL: <span class="string">`http://localhost:1337`</span>,</span><br><span class="line">        contentTypes: [<span class="string">`posts`</span>]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="17-开发数据源插件-获取外部数据"><a href="#17-开发数据源插件-获取外部数据" class="headerlink" title="17.开发数据源插件-获取外部数据"></a>17.开发数据源插件-获取外部数据</h3><p>数据源插件负责从 Gatsby 应用外部获取数据，创建数据查询节点供开发者使用</p>
<p>1.gatsby clean 清除上一次的构建内容<br>2.在项目根目录下创建 plugins 文件夹，在此文件夹中继续创建具体的插件文件夹，比如 gatsby-source-mystrapi 文件夹<br>3.在插件文件夹中创建 gatsby-node.js 文件<br>4.插件实际上就是 npm 包<br>5.导出 sourceNodes 方法用于获取外部数据，创建数据查询节点<br>6.在 gatsby-config.js 文件中配置插件，并传递插件所需的配置参数<br>7.重新运行应用</p>
<h3 id="18-开发数据源插件-添加数据至数据层"><a href="#18-开发数据源插件-添加数据至数据层" class="headerlink" title="18.开发数据源插件-添加数据至数据层"></a>18.开发数据源插件-添加数据至数据层</h3><p>略</p>
<h3 id="19-开发数据转换插件"><a href="#19-开发数据转换插件" class="headerlink" title="19.开发数据转换插件"></a>19.开发数据转换插件</h3><p>transformer 插件将 source 插件提供的数据转换为新的数据</p>
<p>1.在 plugins 文件夹中创建 gatsby-transformer-xml 文件夹<br>2.在插件文件夹中创建 gatsby-node.js 文件<br>3.在文件夹中导出 onCreateNode 方法用于构建 Gatsby 查询节点<br>4.根据节点类型筛选 xml 节点 node.nternal.medidaType -&gt; application/xml<br>5.通过 loadNodeContent 方法读取节点中的数据<br>6.通过 xml2js 将 xml 数据转换为对象<br>7.将对象转换为 Gatsby 查询节点</p>
<h3 id="20-SEO优化"><a href="#20-SEO优化" class="headerlink" title="20.SEO优化"></a>20.SEO优化</h3><p>gatsby-plugin-react-helmet</p>
<p>react-helmet 是一个组件，用于控制页面元数据，这对于 SEO 非常重要.<br>此插件用于将页面元数据添加到 Gatsby 构建的静态 HTML 页面中.</p>
<ul>
<li>npm install gatsby-plugin-react-helmet react-helmet</li>
</ul>
<h3 id="21-让Gatsby应用支持less"><a href="#21-让Gatsby应用支持less" class="headerlink" title="21.让Gatsby应用支持less"></a>21.让Gatsby应用支持less</h3><blockquote>
<p>在 gatsby 应用中使用 less</p>
</blockquote>
<p>下载插件：npm install –save gatsby-plugin-less<br>配置插件：plugins:[<code>gatsby-plugin-less</code>]<br>创建样式：index.module.less<br>引入样式：import styles from ‘./index.module.less’</p>
<h3 id="22-案例实现方式介绍"><a href="#22-案例实现方式介绍" class="headerlink" title="22.案例实现方式介绍"></a>22.案例实现方式介绍</h3><p>略</p>
<h3 id="23-创建realworld项目"><a href="#23-创建realworld项目" class="headerlink" title="23.创建realworld项目"></a>23.创建realworld项目</h3><ul>
<li>gatsby new realworld <a href="https://github.com/gatsbyjs/gatsby-starter-hello-world" target="_blank" rel="noopener">https://github.com/gatsbyjs/gatsby-starter-hello-world</a></li>
<li>rm package-lock.json</li>
<li>rm -rf node_modules</li>
</ul>
<h3 id="24-构建案例所需组件"><a href="#24-构建案例所需组件" class="headerlink" title="24.构建案例所需组件"></a>24.构建案例所需组件</h3><p>略</p>
<h3 id="25-在案例中配置Redux"><a href="#25-在案例中配置Redux" class="headerlink" title="25.在案例中配置Redux"></a>25.在案例中配置Redux</h3><ul>
<li>npm install redux react-redux</li>
</ul>
<h3 id="26-实现登录（一）"><a href="#26-实现登录（一）" class="headerlink" title="26.实现登录（一）"></a>26.实现登录（一）</h3><h3 id="27-实现登录（二）"><a href="#27-实现登录（二）" class="headerlink" title="27.实现登录（二）"></a>27.实现登录（二）</h3><h3 id="28-同步用户状态"><a href="#28-同步用户状态" class="headerlink" title="28.同步用户状态"></a>28.同步用户状态</h3><h3 id="29-实现客户端路由"><a href="#29-实现客户端路由" class="headerlink" title="29.实现客户端路由"></a>29.实现客户端路由</h3><h3 id="30-受保护的客户端路由"><a href="#30-受保护的客户端路由" class="headerlink" title="30.受保护的客户端路由"></a>30.受保护的客户端路由</h3><h3 id="31-文章列表实现思路分析"><a href="#31-文章列表实现思路分析" class="headerlink" title="31.文章列表实现思路分析"></a>31.文章列表实现思路分析</h3><h3 id="32-通过数据源插件获取外部文章列表数据"><a href="#32-通过数据源插件获取外部文章列表数据" class="headerlink" title="32.通过数据源插件获取外部文章列表数据"></a>32.通过数据源插件获取外部文章列表数据</h3><h3 id="33-将文章列表数据添加至数据层"><a href="#33-将文章列表数据添加至数据层" class="headerlink" title="33.将文章列表数据添加至数据层"></a>33.将文章列表数据添加至数据层</h3><h3 id="34-根据文章列表数据创建带分页的文章列表页面"><a href="#34-根据文章列表数据创建带分页的文章列表页面" class="headerlink" title="34.根据文章列表数据创建带分页的文章列表页面"></a>34.根据文章列表数据创建带分页的文章列表页面</h3><h3 id="35-组件查询数据显示数据-1"><a href="#35-组件查询数据显示数据-1" class="headerlink" title="35.组件查询数据显示数据-1"></a>35.组件查询数据显示数据-1</h3><h3 id="36-动态获取文章列表数据"><a href="#36-动态获取文章列表数据" class="headerlink" title="36.动态获取文章列表数据"></a>36.动态获取文章列表数据</h3><h3 id="37-创建文章详情页面"><a href="#37-创建文章详情页面" class="headerlink" title="37.创建文章详情页面"></a>37.创建文章详情页面</h3><h3 id="38-创建动态文章详情页面"><a href="#38-创建动态文章详情页面" class="headerlink" title="38.创建动态文章详情页面"></a>38.创建动态文章详情页面</h3>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/03/23/40/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="FY">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="旋の飞羽">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/03/23/40/" itemprop="url">学习笔记 ----- 【React 框架原理与实战】React Hooks、Chakra-UI、组件性能优化、封装组件库</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-03-23T00:00:00+08:00">
                2021-03-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index">
                    <span itemprop="name">前端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>作者：FY<br>引用请标明出处</p>
</blockquote>
<h1 id="Part-4-·-React-框架原理与实战"><a href="#Part-4-·-React-框架原理与实战" class="headerlink" title="Part 4 · React 框架原理与实战"></a>Part 4 · React 框架原理与实战</h1><h2 id="模块三-·-React-Hooks、Chakra-UI、组件性能优化、封装组件库"><a href="#模块三-·-React-Hooks、Chakra-UI、组件性能优化、封装组件库" class="headerlink" title="模块三 · React Hooks、Chakra-UI、组件性能优化、封装组件库"></a>模块三 · React Hooks、Chakra-UI、组件性能优化、封装组件库</h2><h2 id="任务一：Hooks"><a href="#任务一：Hooks" class="headerlink" title="任务一：Hooks"></a>任务一：Hooks</h2><h3 id="1-ReactHooks-专题内容介绍"><a href="#1-ReactHooks-专题内容介绍" class="headerlink" title="1.ReactHooks 专题内容介绍"></a>1.ReactHooks 专题内容介绍</h3><ul>
<li>1.React Hooks 介绍</li>
<li>2.React Hooks 使用</li>
<li>3.自定义 Hook</li>
</ul>
<h3 id="2-ReactHooks-功能介绍"><a href="#2-ReactHooks-功能介绍" class="headerlink" title="2.ReactHooks 功能介绍"></a>2.ReactHooks 功能介绍</h3><blockquote>
<p>React Hooks 是用来做什么的</p>
</blockquote>
<p>对函数型组件进行增强，让函数型组件可以存储状态，可以拥有处理副作用的能力。<br>让开发者在不使用类组件的情况下，实现相同的功能。</p>
<h3 id="3-类组件的不足（ReactHooks-要解决的问题）"><a href="#3-类组件的不足（ReactHooks-要解决的问题）" class="headerlink" title="3.类组件的不足（ReactHooks 要解决的问题）"></a>3.类组件的不足（ReactHooks 要解决的问题）</h3><ul>
<li>1.缺少逻辑复用机制</li>
</ul>
<p>为了复用逻辑加无实际渲染效果的组件，增加了组件层级，显示十分臃肿<br>增加了调试的难度以及运行效率的降低</p>
<ul>
<li>2.类组件经常会变得很复杂难以维护</li>
</ul>
<p>将一组相干的业务逻辑拆分到了多个生命周期函数中<br>在一个生命周期函数内存在多个不相干的业务逻辑</p>
<ul>
<li>3.类成员方法不能保证this指向的正确性</li>
</ul>
<h3 id="4-使用useState让函数组件保存状态"><a href="#4-使用useState让函数组件保存状态" class="headerlink" title="4.使用useState让函数组件保存状态"></a>4.使用useState让函数组件保存状态</h3><blockquote>
<p>Hooks 意为钩子，React Hooks 就是一堆钩子函数，React 通过这些钩子函数对函数型组件进行增强，不同的钩子函数提供了不同功能。</p>
</blockquote>
<ul>
<li>useState()</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用于为函数组件引入状态</span></span><br><span class="line"><span class="keyword">import</span> React,&#123;useState&#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> [count,setCount] = useState(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;count&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span>setCount(count+1)&#125;&gt;+1<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>useEffects()</li>
<li>useReducer()</li>
<li>useRef()</li>
<li>useCallback()</li>
<li>useContext()</li>
<li>useMemo()</li>
</ul>
<h3 id="5-useState方法的使用细节"><a href="#5-useState方法的使用细节" class="headerlink" title="5.useState方法的使用细节"></a>5.useState方法的使用细节</h3><ul>
<li>1.接收唯一的参数即状态初始值，初始值可以是任意数据类型。</li>
<li>2.返回值为数组，数组中存储状态值和更改状态值的方法，方法名称约定以set开头，后面加上状态名称。</li>
<li>3.方法可以被调用多次，用以保存不同状态值。</li>
<li>4.参数可以是一个函数，函数返回什么，初始状态就是什么，函数只会被调用一次，用在初始值是动态值得情况。</li>
</ul>
<h3 id="6-设置状态值方法的使用细节"><a href="#6-设置状态值方法的使用细节" class="headerlink" title="6.设置状态值方法的使用细节"></a>6.设置状态值方法的使用细节</h3><ul>
<li>设置状态值的方法的参数可以是一个值也可以是一个函数</li>
<li>设置状态值方法的方法本身是异步的</li>
</ul>
<h3 id="7-钩子函数useReducer"><a href="#7-钩子函数useReducer" class="headerlink" title="7.钩子函数useReducer"></a>7.钩子函数useReducer</h3><ul>
<li>useReducer是另一种让函数组件保存状态的方式</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React,&#123;useReact&#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reducer</span>(<span class="params">state,action</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span>(action.type) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'increment'</span>:</span><br><span class="line">        <span class="keyword">return</span> state + <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> [count,dispatch] = useReducer(reducer,<span class="number">0</span>)</span><br><span class="line">    retrun &lt;div&gt;</span><br><span class="line">    &lt;span&gt;&#123;count&#125;&lt;<span class="regexp">/span&gt;</span></span><br><span class="line"><span class="regexp">    &lt;button onClick=&#123;()=&gt;dispatch(&#123;type:'increment'&#125;)&#125;&gt;+1&lt;/</span>button&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="8-钩子函数useContext"><a href="#8-钩子函数useContext" class="headerlink" title="8.钩子函数useContext"></a>8.钩子函数useContext</h3><ul>
<li>在跨组件层级获取数据时简化获取数据的代码</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createContext, useContext &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">const</span> countContext = createContext();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">countContext.Provider</span> <span class="attr">value</span>=<span class="string">&#123;100&#125;</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">Foo</span>/&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">countContext.Provider</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> count = useContext(countContext);</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;count&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="9-useEffect钩子函数执行时机分析"><a href="#9-useEffect钩子函数执行时机分析" class="headerlink" title="9.useEffect钩子函数执行时机分析"></a>9.useEffect钩子函数执行时机分析</h3><ul>
<li>让函数型组件拥有处理副作用的能力，类似生命周期函数</li>
</ul>
<blockquote>
<p>useEffect 执行时机</p>
</blockquote>
<p>可以把 useEffect 看做 componentDidMount，componentUpdate 和 componentWillUnmount 这三个函数的组合</p>
<ul>
<li>useEffect(()=&gt;{}) –&gt; componentDidMount，componentUpdate</li>
<li>useEffect(()=&gt;{},[]) –&gt; componentDidMount</li>
<li>useEffect(()=&gt;()=&gt;{}) –&gt; componentWillUnmount</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState, useEffect &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 组件挂载完成之后执行 组件数据更新完成之后执行</span></span><br><span class="line">    useEffect(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'123'</span>);</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 组件挂载完成之后执行</span></span><br><span class="line">    useEffect(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'123'</span>)</span><br><span class="line">    &#125;,[])</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 组件被卸载之前执行</span></span><br><span class="line">    useEffect(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'组件被卸载了'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        &lt;div&gt;</span><br><span class="line">          &lt;span&gt;&#123;count&#125;&lt;<span class="regexp">/span&gt;</span></span><br><span class="line"><span class="regexp">          &lt;button onClick=&#123;()=&gt;setCount(count+1)&#125;&gt;+1&lt;/</span>button&gt;</span><br><span class="line">          &lt;button onClick=&#123;()=&gt;ReactDOM.unmountComponentAtNode(<span class="built_in">document</span>.getElementById(<span class="string">'root'</span>))&#125;&gt;卸载组件&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>div&gt;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="10-useEffect使用方式"><a href="#10-useEffect使用方式" class="headerlink" title="10.useEffect使用方式"></a>10.useEffect使用方式</h3><ul>
<li>1.为window对象添加滚动事件</li>
<li>2.设置定时器让count数值每隔一秒加1</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123;useEffect, useState&#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">onScroll</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'页面发生滚动了'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    useEffect(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">        <span class="built_in">window</span>.addEventListener(<span class="string">'scroll'</span>, onScroll)</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">           <span class="built_in">window</span>.removeEventListener(<span class="string">'scroll'</span>, onScroll);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,[])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    useEffect(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">const</span> timerId = setInterval(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">            setCount(<span class="function"><span class="params">count</span>=&gt;</span>&#123;</span><br><span class="line">                <span class="built_in">document</span>.title = count + <span class="number">1</span>;</span><br><span class="line">               <span class="keyword">return</span> count+<span class="number">1</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;,<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">            clearInterval(timerId)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,[])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;count&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span>ReactDOM.unmountComponentAtNode(document.getElementById('root'))&#125;&gt;卸载组件<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> App;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>useEffect 解决的问题</p>
</blockquote>
<ul>
<li>1.按照用途将代码进行分类（将一组相干的业务逻辑归置到了同一个副作用函数中）</li>
<li>2.简化重复代码，使组件内部代码更加清晰</li>
</ul>
<h3 id="11-useEffect钩子函数的第二个参数"><a href="#11-useEffect钩子函数的第二个参数" class="headerlink" title="11.useEffect钩子函数的第二个参数"></a>11.useEffect钩子函数的第二个参数</h3><ul>
<li>只有指定数据发生变化时触发effect</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">useEffect(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">document</span>.title = count;</span><br><span class="line">&#125;,[count])</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123;useEffect,useState&#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">const</span> [person, setPerson] = useState(&#123;<span class="attr">name</span>:<span class="string">'张三'</span>&#125;)</span><br><span class="line">    useEffect(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">        <span class="built_in">document</span>.title = count;</span><br><span class="line">    &#125;,[count])</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;count&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span>setCount(count+1)&#125;&gt;+1<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span>ssetPerson(&#123;name:'李四'&#125;)&#125;&gt;setPerson<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="12-useEffect钩子函数结合异步函数"><a href="#12-useEffect钩子函数结合异步函数" class="headerlink" title="12.useEffect钩子函数结合异步函数"></a>12.useEffect钩子函数结合异步函数</h3><ul>
<li>useEffect中的参数函数不能是异步函数，因为useEffect函数要返回清理资源的函数，如果是异步函数就变成了返回Promise</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">useEffect(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">    (<span class="keyword">async</span> ()=&gt;&#123;</span><br><span class="line">        <span class="keyword">await</span> axios.get()</span><br><span class="line">    &#125;)()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123;useEffect&#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        (<span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">let</span> response = <span class="keyword">await</span> getData();</span><br><span class="line">            <span class="built_in">console</span>.log(response)</span><br><span class="line">        &#125;)()</span><br><span class="line">    &#125;,[])</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>App works<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getData</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span>=&gt;</span>&#123;</span><br><span class="line">        resolve(&#123;<span class="attr">msg</span>:<span class="string">'Hello'</span>&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> App;</span><br></pre></td></tr></table></figure>

<h3 id="13-钩子函数useMemo"><a href="#13-钩子函数useMemo" class="headerlink" title="13.钩子函数useMemo"></a>13.钩子函数useMemo</h3><ul>
<li>useMemo 的行为类似Vue中的计算属性，可以监测某个值的变化，根据变化值计算新值</li>
<li>useMemo 会缓存计算结果，如果检测值没有发生变化，即使组件重新渲染，也不会重新计算，此行为可以有助于避免在每个渲染上进行昂贵的计算</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;useMemo&#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">const</span> result = useMemo(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;,[count])</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useSate, useMeno &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">const</span> [bool, setBool] = useState(<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">const</span> result = useMemo(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> count*<span class="number">2</span></span><br><span class="line">    &#125;,[count])</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;count&#125; &#123;result&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span>setCount(count+1)&#125;&gt;+1<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span>setBool(!bool)&#125;&gt;setBool<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> App;</span><br></pre></td></tr></table></figure>

<h3 id="14-使用memo方法提高组件性能"><a href="#14-使用memo方法提高组件性能" class="headerlink" title="14.使用memo方法提高组件性能"></a>14.使用memo方法提高组件性能</h3><ul>
<li>性能优化，如果本组件中的数据没有发生变化，阻止组件更新，类似类组件中的PureComponent和shouldComponentUpdata</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; memo &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Counter</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> memo(Counter);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState, memo &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;count&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span>setCount(count+1)&#125;&gt;+1<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">Foo</span>/&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> Foo = memo(<span class="function"><span class="keyword">function</span> <span class="title">Foo</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Foo组件重新渲染了'</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>我是Foo组件<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> App;</span><br></pre></td></tr></table></figure>

<h3 id="15-useCallback钩子函数"><a href="#15-useCallback钩子函数" class="headerlink" title="15.useCallback钩子函数"></a>15.useCallback钩子函数</h3><ul>
<li>性能优化，缓存函数，使组件重新渲染时得到相同的函数实例</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useCallback &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Counter</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">const</span> resetCount = useCallback(<span class="function"><span class="params">()</span>=&gt;</span>setCount(<span class="number">0</span>),[setCount]);</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;count&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span>setCount(count+1)&#125;&gt;+1<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">Test</span> <span class="attr">resetCount</span>=<span class="string">&#123;resetCount&#125;/</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState, memo &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">// const resetCount = () =&gt; &#123;</span></span><br><span class="line">    <span class="comment">//     setCount(0);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="keyword">const</span> resetCount = useCallback(<span class="function"><span class="params">()</span>=&gt;</span>setCount(<span class="number">0</span>),[setCount])</span><br><span class="line">    <span class="keyword">return</span> (<span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;count&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span>setCount(count+1)&#125;&gt;+1<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">Foo</span> <span class="attr">resetCount</span>=<span class="string">&#123;resetCount&#125;/</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> Foo = memo(<span class="function"><span class="keyword">function</span> <span class="title">Foo</span>(<span class="params">props</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Foo组件重新渲染了'</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>我是Foo组件</span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;props.resetCount&#125;</span>&gt;</span>resetCount<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> App;</span><br></pre></td></tr></table></figure>

<h3 id="16-使用useRef钩子函数获取DOM元素"><a href="#16-使用useRef钩子函数获取DOM元素" class="headerlink" title="16.使用useRef钩子函数获取DOM元素"></a>16.使用useRef钩子函数获取DOM元素</h3><ul>
<li>获取DOM元素对象</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useRef &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> usename = useRef();</span><br><span class="line">    <span class="keyword">const</span> handler = <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(username);</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">ref</span>=<span class="string">&#123;username&#125;</span> <span class="attr">onChange</span>=<span class="string">&#123;handler&#125;</span> /&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="17-使用useRef钩子函数保存数据（跨组件周期）"><a href="#17-使用useRef钩子函数保存数据（跨组件周期）" class="headerlink" title="17.使用useRef钩子函数保存数据（跨组件周期）"></a>17.使用useRef钩子函数保存数据（跨组件周期）</h3><ul>
<li>即使组件重新渲染，保存的数据仍然还在，保存的数据被更改不会触发组件重新渲染</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123;useState,useEffect,useRef&#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> [count,setCount] = useState(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">let</span> timerId = useRef();</span><br><span class="line">    useEffect(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">        timerId.current = setInterval(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">            setCount(<span class="function"><span class="params">count</span> =&gt;</span> count +<span class="number">1</span>)</span><br><span class="line">        &#125;,<span class="number">1000</span>)</span><br><span class="line">    &#125;,[])</span><br><span class="line">    <span class="keyword">const</span> stopCount = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(timerId)</span><br><span class="line">        clearInterval(timerId.current)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    &#123;count&#125;</span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;stopCount&#125;</span>&gt;</span>停止<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> APP;</span><br></pre></td></tr></table></figure>

<h3 id="18-自定义hook函数（一）"><a href="#18-自定义hook函数（一）" class="headerlink" title="18.自定义hook函数（一）"></a>18.自定义hook函数（一）</h3><ul>
<li>自定义 Hook 是标准的封装和共享逻辑的方式</li>
<li>自定义 Hook 是一个函数，其名称以use开头</li>
<li>自定义 Hook 其实就是逻辑和内置 Hook 的组合</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123;useState, useEffect&#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">'axios'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useGetPost</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> [post, setPost] = useState(&#123;&#125;);</span><br><span class="line">    useEffect(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">        axios.get(<span class="string">'https://jsonplaceholder.typicode.com/posts/1'</span>)</span><br><span class="line">        .then(<span class="function"><span class="params">response</span>=&gt;</span>setPost(response.data));</span><br><span class="line">    &#125;,[])</span><br><span class="line">    <span class="keyword">return</span> [post,setPost]</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> [post, setPost] = useGetPost()</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;post.title&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;post.body&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> APP;</span><br></pre></td></tr></table></figure>

<h3 id="19-自定义hook函数（二）"><a href="#19-自定义hook函数（二）" class="headerlink" title="19.自定义hook函数（二）"></a>19.自定义hook函数（二）</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useUpdateInput</span>(<span class="params">initialValue</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> [value, setValue] = useState(initialValue);</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        value,</span><br><span class="line">        onChange: <span class="function"><span class="params">event</span> =&gt;</span> setValue(event.target.value)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> usernameInput = useUpdateInput(<span class="string">''</span>);</span><br><span class="line">  <span class="keyword">const</span> passwordInput = useUpdateInput(<span class="string">''</span>);</span><br><span class="line">  <span class="keyword">const</span> submitForm = <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">      event.preventDefault();</span><br><span class="line">      <span class="built_in">console</span>.log(usernameInput.value);</span><br><span class="line">      <span class="built_in">console</span>.log(passwordInput.value);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">form</span> <span class="attr">onSubmit</span>=<span class="string">&#123;submitForm&#125;</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"username"</span> &#123;<span class="attr">...usernameInput</span>&#125;/&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span> &#123;<span class="attr">...passwordInput</span>&#125;/&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> App;</span><br></pre></td></tr></table></figure>

<h3 id="20-路由钩子函数的使用"><a href="#20-路由钩子函数的使用" class="headerlink" title="20.路由钩子函数的使用"></a>20.路由钩子函数的使用</h3><ul>
<li>react-router-dom 路由提供的钩子函数</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useHistory, useLocation, useRouteMatch, useParams &#125; <span class="keyword">from</span> <span class="string">'react-router-dom'</span>;</span><br></pre></td></tr></table></figure>

<h3 id="21-useState钩子函数的实现原理"><a href="#21-useState钩子函数的实现原理" class="headerlink" title="21.useState钩子函数的实现原理"></a>21.useState钩子函数的实现原理</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line"><span class="keyword">let</span> state = [];</span><br><span class="line"><span class="keyword">let</span> setters = [];</span><br><span class="line"><span class="keyword">let</span> stateIndex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createSetter</span>(<span class="params">index</span>)</span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">newState</span>)</span>&#123;</span><br><span class="line">       state[index] = newState;</span><br><span class="line">       render();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useState</span>(<span class="params">initialState</span>) </span>&#123;</span><br><span class="line">    state[stateIndex] = state[stateIndex] ? state[stateIndex] : initialState;</span><br><span class="line">    setters.push(createSetter(stateIndex));</span><br><span class="line">    <span class="keyword">let</span> value = state[stateIndex];</span><br><span class="line">    <span class="keyword">let</span> setter = setters[stateIndex]</span><br><span class="line">    stateIndex++;</span><br><span class="line">    <span class="keyword">return</span> [value, setter];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    stateIndex = <span class="number">0</span>;</span><br><span class="line">    ReactDOM.render(<span class="xml"><span class="tag">&lt;<span class="name">App</span>/&gt;</span></span>, <span class="built_in">document</span>.getElementById(<span class="string">'root'</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">const</span> [name, setName] = useState(<span class="string">'张三'</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    &#123;count&#125;</span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span>setCount(count+1)&#125;&gt;setCount<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">    &#123;name&#125;</span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span>setName('李四')&#125;&gt;setName<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> App;</span><br></pre></td></tr></table></figure>

<h3 id="22-useEffect钩子函数的实现原理"><a href="#22-useEffect钩子函数的实现原理" class="headerlink" title="22.useEffect钩子函数的实现原理"></a>22.useEffect钩子函数的实现原理</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    stateIndex = <span class="number">0</span>;</span><br><span class="line">    effectIndex = <span class="number">0</span>;</span><br><span class="line">    ReactDOM.render(<span class="xml"><span class="tag">&lt;<span class="name">App</span>/&gt;</span></span>, <span class="built_in">document</span>.getElementById(<span class="string">'root'</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> prevDepsAry = [];</span><br><span class="line"><span class="keyword">let</span> effectIndex = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useEffect</span>(<span class="params">callback, depsAry</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 判断callback是不是函数</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">Object</span>.proptype.toString.call(callback)!==<span class="string">'[object Function]'</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'useEffect函数的第一个参数必须是函数'</span>)</span><br><span class="line">    <span class="comment">// 判断depsAry有没有被传递</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> depsAry === <span class="string">'undefined'</span>) &#123;</span><br><span class="line">        callback();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">Object</span>.proptype.toString.call(depsAry)!==<span class="string">'[object Array]'</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'useEffect函数的第二个参数必须是数组'</span>)</span><br><span class="line">        <span class="keyword">let</span> prevDeps = prevDepsAry[effectIndex];</span><br><span class="line">        <span class="comment">// 将当前的依赖值和上一次的依赖值做对比 如果有变化 调用 callback</span></span><br><span class="line">        <span class="keyword">let</span> hasChanged = prevDeps ? depsAry.every(<span class="function">(<span class="params">dep,index</span>)=&gt;</span>dep===prevDepsAry[index]) === <span class="literal">false</span> : <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">// 判断值是否变化</span></span><br><span class="line">        <span class="keyword">if</span>(hasChanged) &#123;</span><br><span class="line">           callback();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 同步依赖值</span></span><br><span class="line">        prevDepsAry[effectIndex] = depsAry;</span><br><span class="line">        effectIndex++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="23-useReducer-钩子函数的实现原理"><a href="#23-useReducer-钩子函数的实现原理" class="headerlink" title="23.useReducer 钩子函数的实现原理"></a>23.useReducer 钩子函数的实现原理</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useReducer</span>(<span class="params">reducer,initialState</span>) </span>&#123;</span><br><span class="line"> <span class="keyword">const</span> [state, setState] = useState(initialState);</span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params">action</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> newState = reducer(state, caction);</span><br><span class="line">    setState(newState)</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> [state, dispatch]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="任务二：Formik"><a href="#任务二：Formik" class="headerlink" title="任务二：Formik"></a>任务二：Formik</h2><h3 id="1-formik介绍及基本使用"><a href="#1-formik介绍及基本使用" class="headerlink" title="1.formik介绍及基本使用"></a>1.formik介绍及基本使用</h3><blockquote>
<p>Formik 介绍</p>
</blockquote>
<p>增强表单处理能力，简化表单处理流程<br><a href="https://jaredpalmer.com/formik/" target="_blank" rel="noopener">官网</a></p>
<ul>
<li>npm install formik</li>
</ul>
<blockquote>
<p>Formik 基本使用</p>
</blockquote>
<p>使用 formik 进行表单数据绑定以及表单提交处理</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useFormik &#125; <span class="keyword">from</span> <span class="string">'formik'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> formik = useFormik(&#123;<span class="attr">initialValues</span>:&#123;<span class="attr">username</span>:<span class="string">'张三'</span>&#125;,<span class="attr">onSubmit</span>:<span class="function"><span class="params">values</span>=&gt;</span>&#123;&#125;&#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">form</span> <span class="attr">onSubmit</span>=<span class="string">&#123;formik.handleSubmit&#125;</span>&gt;</span></span></span><br><span class="line"><span class="xml">           <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">&#123;formik.values.username&#125;</span> <span class="attr">onChange</span>=<span class="string">&#123;formik.handleChange&#125;/</span>&gt;</span></span></span><br><span class="line"><span class="xml">           <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-formik表单验证（一）"><a href="#2-formik表单验证（一）" class="headerlink" title="2.formik表单验证（一）"></a>2.formik表单验证（一）</h3><p>初始验证方式</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> formik = useFormik(&#123;</span><br><span class="line">    validate: <span class="function"><span class="params">values</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> errors = &#123;&#125;;</span><br><span class="line">        <span class="keyword">if</span>(!value.username) errors.username = <span class="string">'请输入用户名'</span>;</span><br><span class="line">        <span class="keyword">return</span> errors;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">form</span>&gt;</span>&#123;formik.errors.username?<span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;formik.errors.username&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span>:null&#125;<span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<h3 id="3-formik表单验证（二）"><a href="#3-formik表单验证（二）" class="headerlink" title="3.formik表单验证（二）"></a>3.formik表单验证（二）</h3><p>完善错误信息提示的用户体验</p>
<p>1.开启离开焦点时触发验证</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">onBlur = &#123;formik.handleBlur&#125;</span><br></pre></td></tr></table></figure>

<p>2.提示信息时检查表单元素的值是否被改动过</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;formik.touched.username &amp;&amp; formik.errors.username ? <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;formik.errors.username&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span> : <span class="literal">null</span>&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-formik配合yup进行表单验证"><a href="#4-formik配合yup进行表单验证" class="headerlink" title="4.formik配合yup进行表单验证"></a>4.formik配合yup进行表单验证</h3><blockquote>
<p>下载 yup</p>
</blockquote>
<ul>
<li>npm install yup</li>
</ul>
<blockquote>
<p>引入 yup</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> Yup <span class="keyword">from</span> <span class="string">'yup'</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>定义验证规则</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">validationSchema: Yup.object(&#123;</span><br><span class="line">    username: Yup.string()</span><br><span class="line">    .max(<span class="number">15</span>, <span class="string">'用户名的长度不能大于15'</span>)</span><br><span class="line">    .required(<span class="string">'请输入用户名'</span>),</span><br><span class="line">    password: Yup.string()</span><br><span class="line">    .max(<span class="number">20</span>, <span class="string">'密码的长度不能大于20'</span>)</span><br><span class="line">    .required(<span class="string">'请输入密码'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="5-使用getFieldProps方法简化表单代码"><a href="#5-使用getFieldProps方法简化表单代码" class="headerlink" title="5.使用getFieldProps方法简化表单代码"></a>5.使用getFieldProps方法简化表单代码</h3><blockquote>
<p>减少样板代码</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;...formik.getFieldProps(<span class="string">'username'</span>)&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-使用组件的方式构建表单"><a href="#6-使用组件的方式构建表单" class="headerlink" title="6.使用组件的方式构建表单"></a>6.使用组件的方式构建表单</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;Formik,Form,Filed,ErrorMessage&#125; <span class="keyword">from</span> <span class="string">'formik'</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span>(</span><br><span class="line">        &lt;Formik</span><br><span class="line">        initialValues=&#123;initialValues&#125;</span><br><span class="line">        onSubmit=&#123;handleSubmit&#125;</span><br><span class="line">        validationSchema=&#123;schema&#125;&gt;</span><br><span class="line">          &lt;Form&gt;</span><br><span class="line">            &lt;Field name=<span class="string">"usename"</span>/&gt;</span><br><span class="line">            &lt;ErrorMessage name=<span class="string">"usename"</span>/&gt;</span><br><span class="line">            &lt;button type=<span class="string">"submit"</span>&gt;提交&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">          &lt;/</span>Form&gt;</span><br><span class="line">        &lt;<span class="regexp">/Formik&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="7-field组件as属性的用法"><a href="#7-field组件as属性的用法" class="headerlink" title="7.field组件as属性的用法"></a>7.field组件as属性的用法</h3><blockquote>
<p>默认情况下，Field组件渲染的是文本框，如果生成其他表单元素可以使用以下语法</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;Field name=<span class="string">"content"</span> <span class="keyword">as</span>=<span class="string">"textarea"</span> /&gt;</span><br><span class="line">&lt;Field name=<span class="string">"content"</span> <span class="keyword">as</span>=<span class="string">"select"</span>&gt;</span><br><span class="line">  &lt;option value=<span class="string">"前端"</span>&gt;前端&lt;<span class="regexp">/option&gt;</span></span><br><span class="line"><span class="regexp">  &lt;option value="Java"&gt;Java&lt;/</span>option&gt;</span><br><span class="line">  &lt;option value=<span class="string">"python"</span>&gt;python&lt;<span class="regexp">/option&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>Field&gt;</span><br></pre></td></tr></table></figure>

<h3 id="8-构建自定义表单组件"><a href="#8-构建自定义表单组件" class="headerlink" title="8.构建自定义表单组件"></a>8.构建自定义表单组件</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;useField&#125; <span class="keyword">from</span> <span class="string">'formik'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyInputField</span>(<span class="params">&#123;label,...props&#125;</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> [field,meta] = useField(props)</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">htmlFor</span>=<span class="string">&#123;props.id&#125;</span>&gt;</span>&#123;label&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">input</span> &#123;<span class="attr">...field</span>&#125; &#123;<span class="attr">...props</span>&#125;/&gt;</span></span></span><br><span class="line"><span class="xml">        &#123;meta.touched &amp;&amp; meta.error ? <span class="tag">&lt;<span class="name">div</span>&gt;</span>meta.error<span class="tag">&lt;/<span class="name">div</span>&gt;</span> : null&#125;</span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line">&lt;MyInputField label=<span class="string">"密码"</span> type=<span class="string">"password"</span> name=<span class="string">"password"</span> placeholder=<span class="string">"请输入密码"</span>/&gt;</span><br></pre></td></tr></table></figure>

<h3 id="9-构建自定义表单控件复选框"><a href="#9-构建自定义表单控件复选框" class="headerlink" title="9.构建自定义表单控件复选框"></a>9.构建自定义表单控件复选框</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Checkbox</span>(<span class="params">&#123;label,...props&#125;</span>) </span>&#123;</span><br><span class="line"><span class="keyword">const</span> [field,meta,helper] = useField(props);</span><br><span class="line"><span class="keyword">const</span> &#123;value&#125; = meta;</span><br><span class="line"><span class="keyword">const</span> &#123;setValue&#125; = helper;</span><br><span class="line"><span class="keyword">const</span> handleChange = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">set</span> = new Set(value);</span><br><span class="line">    if(<span class="keyword">set</span>.has(props.value))&#123;</span><br><span class="line">        <span class="keyword">set</span>.delete(props.value)</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        <span class="keyword">set</span>.add(props.value)</span><br><span class="line">    &#125;</span><br><span class="line">    setValue([..<span class="keyword">set</span>])</span><br><span class="line">&#125;</span><br><span class="line">return &lt;div&gt;</span><br><span class="line">  &lt;label htmlFor=""&gt;</span><br><span class="line">    &lt;input checked=&#123;value.includes(props.value)&#125; type=<span class="string">"checkbox"</span> &#123;...props&#125; onChange=&#123;handleChange&#125;/&gt;&#123;label&#125;</span><br><span class="line">  &lt;<span class="regexp">/label&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>div&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="任务三：Component"><a href="#任务三：Component" class="headerlink" title="任务三：Component"></a>任务三：Component</h2><h3 id="1-受控组件与非受控组件的选用标准"><a href="#1-受控组件与非受控组件的选用标准" class="headerlink" title="1.受控组件与非受控组件的选用标准"></a>1.受控组件与非受控组件的选用标准</h3><blockquote>
<p>非受控组件</p>
</blockquote>
<ul>
<li>表单数据交由DOM节点管理，特点是表单数据在需要时进行获取，代码实现相对简单</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> userInput = useRef();</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">handleSubmit</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> username = userInput.current.value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">form</span> <span class="attr">onSubmit</span>=<span class="string">&#123;handleSubmit&#125;</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">ref</span>=<span class="string">&#123;userInput&#125;/</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>受控组件</p>
</blockquote>
<ul>
<li>表单数据交由state对象管理，特点是可以实时得到表单数据，代码相对复杂</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    state = &#123;<span class="attr">username</span>:<span class="string">''</span>&#125;;</span><br><span class="line">    handleChange(event) &#123; <span class="keyword">this</span>.setState(&#123;<span class="attr">username</span>:event.target.value&#125;)&#125;</span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">form</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">value</span>=<span class="string">&#123;this.state.username&#125;</span> <span class="attr">onChange</span>=<span class="string">&#123;this.handleChange.bind(this)&#125;/</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;this.state.username&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>选用标准</p>
</blockquote>
<p>总结：受控组件和非受控组件都有其特点，应该根据需求场景进行选择。在大多数情况下，推荐使用受控组件处理表单数据。<br>如果表单数据交互方面比较简单，使用非受控表单，否则使用受控表单。</p>
<table>
<thead>
<tr>
<th>场景</th>
<th>非受控</th>
<th>受控</th>
</tr>
</thead>
<tbody><tr>
<td>表单提交时取值</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>表单提交时验证</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>表单项元素实时验证</td>
<td>×</td>
<td>√</td>
</tr>
<tr>
<td>根据条件禁用提交按钮</td>
<td>×</td>
<td>√</td>
</tr>
<tr>
<td>强制输入内容的格式</td>
<td>×</td>
<td>√</td>
</tr>
<tr>
<td>一个数据的多个输入</td>
<td>×</td>
<td>√</td>
</tr>
</tbody></table>
<h2 id="任务四：CSS-IN-JS"><a href="#任务四：CSS-IN-JS" class="headerlink" title="任务四：CSS-IN-JS"></a>任务四：CSS-IN-JS</h2><h3 id="1-专题内容介绍"><a href="#1-专题内容介绍" class="headerlink" title="1.专题内容介绍"></a>1.专题内容介绍</h3><ul>
<li>为什么会有 CSS-IN-JS</li>
<li>CSS-IN-JS 介绍</li>
<li>Emotion 库</li>
</ul>
<h3 id="2-为什么会有CSS-IN-JS这种解决方案"><a href="#2-为什么会有CSS-IN-JS这种解决方案" class="headerlink" title="2.为什么会有CSS-IN-JS这种解决方案"></a>2.为什么会有CSS-IN-JS这种解决方案</h3><p>CSS-IN-JS 是 WEB 项目中将 CSS 代码捆绑在 JavaScript 代码中的解决方案。<br>这种方案旨在解决 CSS 的局限性，例如缺乏动态功能，作用域和可移植性。</p>
<h3 id="3-CSS-IN-JS解决方案的优缺点"><a href="#3-CSS-IN-JS解决方案的优缺点" class="headerlink" title="3.CSS-IN-JS解决方案的优缺点"></a>3.CSS-IN-JS解决方案的优缺点</h3><blockquote>
<p>CSS-IN-JS 方案的优点</p>
</blockquote>
<ul>
<li>1.让 CSS 代码拥有独立的作用域，阻止 CSS 代码泄露到组件外部，防止样式冲突</li>
<li>2.让组件更具有可移植性，实现开箱即用，轻松创建松耦合的应用程序</li>
<li>3.让组件更具可重用性，只需编写一次即可，可以在任何地方运行，不仅可以在同一应用程序中重用组件，而且可以在使用相同框架构建的其他应用程序中重用组件</li>
<li>4.让样式具有动态功能，可以将复杂的逻辑应用于样式规则，如果要创建需要动态功能的复杂UI，它是理想的解决方案</li>
</ul>
<blockquote>
<p>CSS-IN-JS 方案的缺点</p>
</blockquote>
<ul>
<li>1.为项目增加了额外的复杂性</li>
<li>2.自动生成的选择器大大降低了代码的可读性</li>
</ul>
<h3 id="4-babel配置以支持css属性的两种方式"><a href="#4-babel配置以支持css属性的两种方式" class="headerlink" title="4.babel配置以支持css属性的两种方式"></a>4.babel配置以支持css属性的两种方式</h3><blockquote>
<p>Emotion 介绍</p>
</blockquote>
<p>Emotion 是一个旨在使用 JavaScript 编写的 CSS 样式的库<br>npm install @emotion/core @emotion/styled</p>
<blockquote>
<p>1.JSX 属性支持</p>
</blockquote>
<p>通知 babel，不再需要将 jsx 语法转换为 React.createElement 方法，而是需要转换为 jsx 方法</p>
<table>
<thead>
<tr>
<th></th>
<th>INPUT</th>
<th>OUPUT</th>
</tr>
</thead>
<tbody><tr>
<td>Before</td>
<td><code>&lt;img src=&quot;avatar.png&quot; /&gt;</code></td>
<td>React.createElement(‘img’,{src:’avatar.png’})</td>
</tr>
<tr>
<td>After</td>
<td><code>&lt;img src=&quot;avatar.png&quot; /&gt;</code></td>
<td>jsx(‘img’,{src:’avatar.png’})</td>
</tr>
</tbody></table>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@jsx </span>jsx */</span></span><br><span class="line"><span class="keyword">import</span> &#123; jsx &#125; <span class="keyword">from</span> <span class="string">'@emotion/core'</span>;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>2.Babel Preset</p>
</blockquote>
<ul>
<li>1.npm run eject</li>
<li>2.在package.json文件中找到babel属性，加入如下内容</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"presets"</span>: [</span><br><span class="line">    <span class="string">"react-app"</span>,</span><br><span class="line">    <span class="string">"@emotion/babel-preset-css-prop"</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h3 id="5-css方法的使用方式"><a href="#5-css方法的使用方式" class="headerlink" title="5.css方法的使用方式"></a>5.css方法的使用方式</h3><blockquote>
<p>String Styles</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> style = css`</span><br><span class="line"><span class="css">    <span class="selector-tag">width</span>: 100<span class="selector-tag">x</span>;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">height</span>: 100<span class="selector-tag">px</span>;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">background</span>: <span class="selector-tag">skyblue</span>;</span></span><br><span class="line"><span class="css">    `</span>;</span><br><span class="line">    &lt;div css=&#123;style&#125;&gt;App works ...&lt;<span class="regexp">/div&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Object Styles</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> style = css(&#123;</span><br><span class="line">    width: <span class="number">200</span>,</span><br><span class="line">    height: <span class="number">200</span>,</span><br><span class="line">    background: <span class="string">'red'</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">css</span>=<span class="string">&#123;style&#125;</span>&gt;</span>App works<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-emotion中css属性优先级"><a href="#6-emotion中css属性优先级" class="headerlink" title="6.emotion中css属性优先级"></a>6.emotion中css属性优先级</h3><blockquote>
<p>css 属性优先级</p>
</blockquote>
<p>props 对象中的css属性优先级高于组件内部的css属性。<br>在调用组件时可以覆盖组件默认样式。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Css <span class="keyword">from</span> <span class="string">'./Css'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; css &#125; <span class="keyword">from</span> <span class="string">'@emotion/core'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> style = css`</span><br><span class="line"><span class="css"><span class="selector-tag">background</span><span class="selector-pseudo">:pink</span>;</span></span><br><span class="line"><span class="css">`</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">Css</span> <span class="attr">css</span>=<span class="string">&#123;style&#125;/</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> App;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; css &#125; <span class="keyword">from</span> <span class="string">'@emotion/core'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> style = css`</span><br><span class="line"><span class="css"><span class="selector-tag">width</span>: 200<span class="selector-tag">px</span>;</span></span><br><span class="line"><span class="css"><span class="selector-tag">height</span>: 200<span class="selector-tag">px</span>;</span></span><br><span class="line"><span class="css"><span class="selector-tag">background</span>: <span class="selector-tag">skyblue</span>;</span></span><br><span class="line"><span class="css">`</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Css</span> (<span class="params">props</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">css</span>=<span class="string">&#123;style&#125;&#123;...props&#125;</span>&gt;</span>Css<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Css;</span><br></pre></td></tr></table></figure>

<h3 id="7-创建样式化组件"><a href="#7-创建样式化组件" class="headerlink" title="7.创建样式化组件"></a>7.创建样式化组件</h3><blockquote>
<p>Styled Components 样式化组件</p>
</blockquote>
<p>样式化组件就是用来构建用户界面的，是 emotion 库提供的另一种为元素添加样式的方式。</p>
<ul>
<li>创建样式化组件</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> styled <span class="keyword">from</span> <span class="string">'@emotion/styled'</span>;</span><br><span class="line"><span class="keyword">const</span> Button = styled.button<span class="string">`</span></span><br><span class="line"><span class="string">color: red</span></span><br><span class="line"><span class="string">`</span>;</span><br></pre></td></tr></table></figure>

<h3 id="8-样式化组件默认样式的覆盖方式"><a href="#8-样式化组件默认样式的覆盖方式" class="headerlink" title="8.样式化组件默认样式的覆盖方式"></a>8.样式化组件默认样式的覆盖方式</h3><blockquote>
<p>根据 props 属性覆盖样式</p>
</blockquote>
<ul>
<li>String Styles</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Button = styled.button<span class="string">`</span></span><br><span class="line"><span class="string">width: 100px;</span></span><br><span class="line"><span class="string">height: 30px;</span></span><br><span class="line"><span class="string">background: <span class="subst">$&#123;props =&gt; props.bgColor || <span class="string">'skyblue'</span>&#125;</span>;</span></span><br><span class="line"><span class="string">`</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>Object Styles</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Container = styled.div(<span class="function"><span class="params">props</span> =&gt;</span> (&#123;</span><br><span class="line">    width: props.w || <span class="number">1000</span>,</span><br><span class="line">    background: <span class="string">'pink'</span>,</span><br><span class="line">    margin: <span class="string">'0 auto'</span></span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Button = styled.button(&#123;</span><br><span class="line">    color: <span class="string">'red'</span></span><br><span class="line">&#125;,props =&gt; (&#123;</span><br><span class="line">    color: props.color</span><br><span class="line">&#125;))</span><br></pre></td></tr></table></figure>

<h3 id="9-为任何组件添加样式"><a href="#9-为任何组件添加样式" class="headerlink" title="9.为任何组件添加样式"></a>9.为任何组件添加样式</h3><ul>
<li>String Styles</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Demo = (&#123;className&#125; =&gt; <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#123;className&#125;</span>&gt;</span>Demo<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>)</span><br><span class="line"><span class="keyword">const</span> Fancy = styled(Demo)<span class="string">`</span></span><br><span class="line"><span class="string">color: red;</span></span><br><span class="line"><span class="string">`</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>Object Styles</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Demo = (&#123;className&#125; =&gt; <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#123;className&#125;</span>&gt;</span>Demo<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>)</span><br><span class="line"><span class="keyword">const</span> Fancy = styled(Demo)(&#123;</span><br><span class="line">  color: <span class="string">'green'</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="10-为特定父级下的子组件添加样式"><a href="#10-为特定父级下的子组件添加样式" class="headerlink" title="10.为特定父级下的子组件添加样式"></a>10.为特定父级下的子组件添加样式</h3><blockquote>
<p>通过父组件设置子组件的样式</p>
</blockquote>
<ul>
<li>String Styles</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Child = styled.div<span class="string">`</span></span><br><span class="line"><span class="string">color: red;</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"><span class="keyword">const</span> Parent = styled.div<span class="string">`</span></span><br><span class="line"><span class="string"><span class="subst">$&#123;Child&#125;</span> &#123;</span></span><br><span class="line"><span class="string">    color: green;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Object Styles</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Child = styled.div(&#123;</span><br><span class="line">    color: <span class="string">'red'</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">const</span> Parent = styled.div(&#123;</span><br><span class="line">    [Child]: &#123;</span><br><span class="line">        color: <span class="string">'green'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="11-css选择器-amp"><a href="#11-css选择器-amp" class="headerlink" title="11.css选择器&amp;"></a>11.css选择器&amp;</h3><blockquote>
<p>嵌套选择器</p>
</blockquote>
<ul>
<li>&amp; 表示组件本身</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Container = styled.div<span class="string">`</span></span><br><span class="line"><span class="string">color: red;</span></span><br><span class="line"><span class="string">&amp; &gt; a &#123;</span></span><br><span class="line"><span class="string">    color: pink;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">`</span>;</span><br></pre></td></tr></table></figure>

<h3 id="12-样式化组件属性as的用法"><a href="#12-样式化组件属性as的用法" class="headerlink" title="12.样式化组件属性as的用法"></a>12.样式化组件属性as的用法</h3><p>要使用组件中的样式，但要更改呈现的元素，可以使用 as 属性。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Button = styled.button<span class="string">`</span></span><br><span class="line"><span class="string">color: red</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line">&lt;Button <span class="keyword">as</span>=<span class="string">"a"</span> href=<span class="string">"#"</span>&gt;button&lt;<span class="regexp">/Button&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="13-样式组合"><a href="#13-样式组合" class="headerlink" title="13.样式组合"></a>13.样式组合</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> base = css`</span><br><span class="line"><span class="css"><span class="selector-tag">color</span><span class="selector-pseudo">:yellow</span></span></span><br><span class="line"><span class="css">`</span>;</span><br><span class="line"><span class="keyword">const</span> danger = css`</span><br><span class="line"><span class="css"><span class="selector-tag">color</span>: <span class="selector-tag">red</span>;</span></span><br><span class="line"><span class="css">`</span>;</span><br><span class="line">&lt;button css=&#123;[base, danger]&#125;&gt;button&lt;<span class="regexp">/button&gt;</span></span><br></pre></td></tr></table></figure>
<p>在样式组合中，后调用的样式优先级高于先调用的样式。</p>
<h3 id="14-Global组件"><a href="#14-Global组件" class="headerlink" title="14.Global组件"></a>14.Global组件</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; css, Global &#125; <span class="keyword">from</span> <span class="string">'@emotion/core'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> styles = css`</span><br><span class="line"><span class="css"><span class="selector-tag">body</span> &#123; <span class="attribute">margin</span>: <span class="number">0</span>; &#125;</span></span><br><span class="line"><span class="css">`</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">Global</span> <span class="attr">styles</span>=<span class="string">&#123;styles&#125;/</span>&gt;</span></span></span><br><span class="line"><span class="xml">    App works ...</span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="15-使用keyframes方法定义关键帧动画"><a href="#15-使用keyframes方法定义关键帧动画" class="headerlink" title="15.使用keyframes方法定义关键帧动画"></a>15.使用keyframes方法定义关键帧动画</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> move = keyframes<span class="string">`</span></span><br><span class="line"><span class="string">0% &#123; left: 0;top:0;background:pink;&#125;</span></span><br><span class="line"><span class="string">100% &#123; top: 300px; left: 600px; background: skyblue;&#125;</span></span><br><span class="line"><span class="string">`</span>;</span><br></pre></td></tr></table></figure>

<p>const box = css<code>width: 100px;
height: 100px;
position: absolute;
animation: ${move} 2s ease infinite alternate;</code>;</p>
<p>function App() {<br>    return <div css={box}><br>    App works …<br>    </div>;<br>}</p>
<h3 id="16-创建主题"><a href="#16-创建主题" class="headerlink" title="16.创建主题"></a>16.创建主题</h3><blockquote>
<p>1.下载主题模块</p>
</blockquote>
<ul>
<li>npm install emotion-theming</li>
</ul>
<blockquote>
<p>2.引入 ThemeProvider 组件</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ThemeProvider &#125; <span class="keyword">from</span> <span class="string">'emotion-theming'</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>3.将 ThemeProvider 放置在视图最外层</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">ThemeProvider</span>&gt;</span><span class="tag">&lt;/<span class="name">ThemeProvider</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>4.添加主题内容</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> theme = &#123;</span><br><span class="line">    colors: &#123;</span><br><span class="line">        primary: <span class="string">'hotpink'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;ThemeProvider theme=&#123;theme&#125;&gt;&lt;<span class="regexp">/ThemeProvider&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>5.获取主题内容</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> getPrimaryColor = <span class="function"><span class="params">props</span> =&gt;</span> css`</span><br><span class="line"><span class="css"><span class="selector-tag">color</span>: </span><span class="subst">$&#123;props.colors.primary&#125;</span></span><br><span class="line"><span class="css">`</span>;</span><br><span class="line">&lt;div css=&#123;getPrimaryColor&#125;&gt;&lt;<span class="regexp">/div&gt;</span></span><br></pre></td></tr></table></figure>

 <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useTheme &#125; <span class="keyword">from</span> <span class="string">'emotion-theming'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Demo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> theme = useTheme();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="任务五：ChakraUI"><a href="#任务五：ChakraUI" class="headerlink" title="任务五：ChakraUI"></a>任务五：ChakraUI</h2><h3 id="1-Chakra-ui组件库介绍"><a href="#1-Chakra-ui组件库介绍" class="headerlink" title="1.Chakra-ui组件库介绍"></a>1.Chakra-ui组件库介绍</h3><p>Chakra UI 是一个简单的，模块化的易于理解的 UI 组件库，提供了丰富的构建 React 应用所需的 UI 组件。<br>文档：<a href="https://next.chakra-ui.cm/docs/getting-started" target="_blank" rel="noopener">https://next.chakra-ui.cm/docs/getting-started</a></p>
<ul>
<li>1.Chakra UI 内置 Emotion，是 CSS-IN-JS 解决方案的集大成者</li>
<li>2.基于 Styled-Systems <a href="https://styled-system.com/" target="_blank" rel="noopener">https://styled-system.com/</a></li>
<li>3.支持开箱即用的主题功能</li>
<li>4.默认支持白天和黑夜两种模式</li>
<li>5.拥有大量功能丰富且非常有用的组件</li>
<li>6.使响应式设计变得轻而易举</li>
<li>7.文档清晰而全面，查找 API 更加容易</li>
<li>8.适用于构建用于展示给用户的界面</li>
<li>9.框架正在变得越来越完善</li>
</ul>
<h3 id="2-Chakra-ui快速开始"><a href="#2-Chakra-ui快速开始" class="headerlink" title="2.Chakra-ui快速开始"></a>2.Chakra-ui快速开始</h3><blockquote>
<p>下载 chakra-ui</p>
</blockquote>
<ul>
<li>npm install @chakra-ui/core@1.0.0-next.2</li>
</ul>
<blockquote>
<p>克隆默认主题</p>
</blockquote>
<p>Chakra-UI 提供的组件是建立在主题基础之上的，只有先引入了主题组件才能够使用其他组件。</p>
<ul>
<li>npm install @chakra-ui/theme</li>
</ul>
<blockquote>
<p>引入主题</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;ChakraProvider&#125; <span class="keyword">from</span> <span class="string">'@chakra-ui/core'</span>;</span><br><span class="line"><span class="keyword">import</span> theme <span class="keyword">from</span> <span class="string">'@chakra-ui/theme'</span>;</span><br><span class="line"></span><br><span class="line">&lt;ChakraProvider theme=&#123;theme&#125;&gt;</span><br><span class="line">   &lt;App/&gt;</span><br><span class="line">&lt;<span class="regexp">/ChakraProvider&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>引入 CSS 重置组件</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;CSSReset&#125; <span class="keyword">from</span> <span class="string">'@chakra-ui/core'</span>;</span><br><span class="line">&lt;ChakraProvider theme=&#123;theme&#125;&gt;</span><br><span class="line">  &lt;CSSReset/&gt;</span><br><span class="line">  &lt;App/&gt;</span><br><span class="line">&lt;<span class="regexp">/ChakraProvider&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-样式属性"><a href="#3-样式属性" class="headerlink" title="3.样式属性"></a>3.样式属性</h3><p>Style Props 是用来更改组件样式的，通过为组件传递属性的方式实现，通过传递简化的样式属性以达到提升开发效率的目的。</p>
<h3 id="4-实现暗色和浅色两种模式的切换"><a href="#4-实现暗色和浅色两种模式的切换" class="headerlink" title="4.实现暗色和浅色两种模式的切换"></a>4.实现暗色和浅色两种模式的切换</h3><blockquote>
<p>颜色模式（color mode）</p>
</blockquote>
<p>chakra-ui 提供的组件都支持两种颜色模式，浅色模式（light）和暗色模式（dark）。<br>可以通过 useColorMode 进行颜色模式的更改。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;useColorMode&#125; <span class="keyword">from</span> <span class="string">'@chakra-ui/core'</span>;</span><br><span class="line"><span class="keyword">const</span> [colorMode, toggleColorMode] = useColorMode();</span><br><span class="line"></span><br><span class="line">&lt;Text&gt;当前的颜色模式为&#123;colorMode&#125;&lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">&lt;Button onClick=&#123;toggleColorMode&#125;&gt;切换颜色模式&lt;/</span>Button&gt;</span><br></pre></td></tr></table></figure>
<p>Chakra 将颜色模式存储在 localStorage 中，并使用类名策略来确保颜色模式是持久的。</p>
<h3 id="5-useColorModelValue-钩子函数"><a href="#5-useColorModelValue-钩子函数" class="headerlink" title="5.useColorModelValue 钩子函数"></a>5.useColorModelValue 钩子函数</h3><blockquote>
<p>根据颜色模式设置样式</p>
</blockquote>
<p>chakra 允许在为元素设置样式时根据颜色模式产生不同值，通过 useColorModelValue 钩子函数实现。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bgColor = useColorModeValue(lightModeValue,darkModeValue);</span><br><span class="line">&lt;Box bgColor=&#123;bgColor&#125;&gt;&lt;<span class="regexp">/Box&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="6-强制组件的颜色模式"><a href="#6-强制组件的颜色模式" class="headerlink" title="6.强制组件的颜色模式"></a>6.强制组件的颜色模式</h3><p>使组件不受颜色模式的影响，始终保持在某个颜色模式下的样式。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;lightMode,DarkMode&#125; <span class="keyword">from</span> <span class="string">'@chakra-ui/core'</span>;</span><br><span class="line"></span><br><span class="line">&lt;LightMode&gt;</span><br><span class="line">  &lt;Button onClick=&#123;toggleColorMode&#125;&gt;按钮&lt;<span class="regexp">/Button&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>LightMode&gt;</span><br></pre></td></tr></table></figure>

<h3 id="7-颜色模式通用设置"><a href="#7-颜色模式通用设置" class="headerlink" title="7.颜色模式通用设置"></a>7.颜色模式通用设置</h3><ul>
<li>1.设置默认颜色模式</li>
</ul>
<p>通过 theme.config.initialColorMode 可以设置应用使用的默认主题</p>
<ul>
<li>2.使用操作系统所使用的颜色模式</li>
</ul>
<p>通过 theme.config.useSystemColorMode 可以设置将应用的颜色模式设置为操作系统所使用的颜色模式。</p>
<h3 id="8-主题对象-颜色"><a href="#8-主题对象-颜色" class="headerlink" title="8.主题对象-颜色"></a>8.主题对象-颜色</h3><ul>
<li>1.Colors</li>
</ul>
<p>在设置颜色时，可以但不限于取主题中提供的颜色值。</p>
<h3 id="9-主题对象–间距-amp-大小"><a href="#9-主题对象–间距-amp-大小" class="headerlink" title="9.主题对象–间距&amp;大小"></a>9.主题对象–间距&amp;大小</h3><ul>
<li>2.Space</li>
</ul>
<p>使用 space 可以自定义项目间距，这些间距值可以由 padding，margin 和 top，left，right，bottom样式引用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Box mb=<span class="string">"5"</span>&gt;&lt;<span class="regexp">/Box&gt; &lt;!-- 5 =&gt; 1.25rem --&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>3.Sizes</li>
</ul>
<p>使用 size 可以自定义元素大小，这些值可以由 width，height和maxWidth，minWidth等样式引用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Box w=<span class="string">"lg"</span>&gt;&lt;<span class="regexp">/Box&gt; &lt;!-- lg =&gt; 32rem --&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="10-主题对象-响应式断点"><a href="#10-主题对象-响应式断点" class="headerlink" title="10.主题对象-响应式断点"></a>10.主题对象-响应式断点</h3><p>4.Breakpoints</p>
<p>配置响应数组值中使用的默认断点，这些值将用于生成移动优先（即最小宽度）的媒体查询。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// theme.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    breakpoints: [<span class="string">"30em"</span>,<span class="string">"48em"</span>,<span class="string">"62em"</span>,<span class="string">"80em"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Box fontSize=&#123;[<span class="string">"12px"</span>,<span class="string">"14px"</span>,<span class="string">"16px"</span>,<span class="string">"18px"</span>,<span class="string">"20px"</span>]&#125;&gt;&lt;<span class="regexp">/Box&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="11-创建标准的chakra-ui组件"><a href="#11-创建标准的chakra-ui组件" class="headerlink" title="11.创建标准的chakra-ui组件"></a>11.创建标准的chakra-ui组件</h3><ul>
<li>创建 Chakra-UI 组件</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> laGouButton = chakra(<span class="string">"button"</span>,&#123;</span><br><span class="line">    baseStyle: &#123;&#125;,</span><br><span class="line">    sizes: &#123;&#125;,</span><br><span class="line">    variants: &#123;&#125;</span><br><span class="line">&#125;)</span><br><span class="line">LagouButton.defaultProps = &#123;&#125;;</span><br><span class="line">&lt;LagouButton&gt;按钮&lt;<span class="regexp">/LagouButton&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="12-全局化charkra-ui组件样式"><a href="#12-全局化charkra-ui组件样式" class="headerlink" title="12.全局化charkra-ui组件样式"></a>12.全局化charkra-ui组件样式</h3><ul>
<li>全局化 Chakra-UI 组件样式</li>
</ul>
<p>a.在 src 文件夹中创建 lagou 文件夹用于放置自定义 Chakra-UI 组件<br>b.在 lagou 文件夹中创建 button.js 文件并将组件样式放置于当前文件中并进行默认导出。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> LaGouButton = &#123;</span><br><span class="line">    baseStyle:&#123;&#125;,</span><br><span class="line">    sizes: &#123;&#125;,</span><br><span class="line">    variants: &#123;&#125;,</span><br><span class="line">    defaultProps: &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> LaGouButton;</span><br></pre></td></tr></table></figure>

<p>c.在lagou文件夹中创建index.js文件用于导入导出所有的自定义组件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> LaGouButton <span class="keyword">from</span> <span class="string">'./button'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    LaGouButton</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>d.在 src 文件夹中的 index.js 文件中导入自定义 Chakra-UI 组件并和components属性进行合并</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> LaGouComponents <span class="keyword">from</span> <span class="string">'./Lagou'</span>;</span><br><span class="line"><span class="keyword">const</span> myTheme = &#123;</span><br><span class="line">    ...theme,</span><br><span class="line">    components: &#123;</span><br><span class="line">        ...theme.components,</span><br><span class="line">        ...LaGouComponents</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="13-构建注册表单"><a href="#13-构建注册表单" class="headerlink" title="13.构建注册表单"></a>13.构建注册表单</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Input, InputGroup, Stack, InputLeftAddon, InputRightAddon, FormHelperText, RadioGroup, Radio, Select, Switch, Formlabel, Flex, Button, FormControl &#125; <span class="keyword">from</span> <span class="string">'@chakra-ui/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; FaUserAlt, FaLock, FaCheck &#125; <span class="keyword">from</span> <span class="string">'react-icons/fa'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">Form</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;form&gt;</span><br><span class="line">        &lt;Stack spacing=<span class="string">"2"</span>&gt;</span><br><span class="line">        &lt;FormControl isDisabled isInvalid&gt;</span><br><span class="line">         &lt;InputGroup&gt;</span><br><span class="line">           &lt;InputLeftAddon children=&#123;&lt;FaUserAlt /&gt;&#125;/&gt;</span><br><span class="line">           &lt;Input placeholder=<span class="string">"请输入用户名"</span> /&gt;</span><br><span class="line">         &lt;<span class="regexp">/InputGroup&gt;</span></span><br><span class="line"><span class="regexp">         &lt;FormHelperText&gt;用户名是必填项&lt;/</span>FormHelperText&gt;</span><br><span class="line">         &lt;<span class="regexp">/FormControl&gt;</span></span><br><span class="line"><span class="regexp">         &lt;InputGroup&gt;</span></span><br><span class="line"><span class="regexp">           &lt;InputLeftAddon children=&#123;&lt;FaLock /</span>&gt;&#125;/&gt;</span><br><span class="line">           &lt;Input type=<span class="string">"password"</span> placeholder=<span class="string">"请输入密码"</span>/&gt;</span><br><span class="line">           &lt;InputRightAddon children=&#123;&lt;FaCheck /&gt;&#125;/&gt;</span><br><span class="line">         &lt;<span class="regexp">/InputGroup&gt;</span></span><br><span class="line"><span class="regexp">         &lt;RadioGroup defaultValue="0"&gt;</span></span><br><span class="line"><span class="regexp">           &lt;Stack spacing=&#123;4&#125; direction="horizontal"&gt;</span></span><br><span class="line"><span class="regexp">             &lt;Radio value="0"&gt;男&lt;/</span>Radio&gt;</span><br><span class="line">             &lt;Radio value=<span class="string">"1"</span>&gt;女&lt;<span class="regexp">/Radio&gt;</span></span><br><span class="line"><span class="regexp">           &lt;/</span>Stack&gt;</span><br><span class="line">         &lt;<span class="regexp">/RadioGroup&gt;</span></span><br><span class="line"><span class="regexp">         &lt;Select appearance="none" placeholder="请选择学科"&gt;</span></span><br><span class="line"><span class="regexp">           &lt;option value="Java"&gt;Java&lt;/</span>option&gt;</span><br><span class="line">           &lt;option value=<span class="string">"大前端"</span>&gt;大前端&lt;<span class="regexp">/option&gt;</span></span><br><span class="line"><span class="regexp">         &lt;/</span>Select&gt;</span><br><span class="line">         &lt;Flex&gt;</span><br><span class="line">           &lt;Switch id=<span class="string">"deal"</span> mr=<span class="string">"3"</span> /&gt;</span><br><span class="line">           &lt;Formlabel htmlFor=<span class="string">"deal"</span>&gt;是否同意协议&lt;<span class="regexp">/Formlabel&gt;</span></span><br><span class="line"><span class="regexp">         &lt;/</span>Flex&gt;</span><br><span class="line">         &lt;Button _hover=&#123;&#123;<span class="attr">bgColor</span>:<span class="string">'tomato'</span>&#125;&#125; w=<span class="string">"100%"</span> colorScheme=<span class="string">"teal"</span>&gt;注册&lt;<span class="regexp">/Button&gt;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>Stack&gt;</span><br><span class="line">      &lt;<span class="regexp">/form&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="14-选项卡组件的使用方式"><a href="#14-选项卡组件的使用方式" class="headerlink" title="14.选项卡组件的使用方式"></a>14.选项卡组件的使用方式</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SignUp.js</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Input, InputGroup, Stack, InputLeftAddon, InputRightAddon, FormHelperText, RadioGroup, Radio, Select, Switch, Formlabel, Flex, Button, FormControl &#125; <span class="keyword">from</span> <span class="string">'@chakra-ui/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; FaUserAlt, FaLock, FaCheck &#125; <span class="keyword">from</span> <span class="string">'react-icons/fa'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">SignUp</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;form&gt;</span><br><span class="line">        &lt;Stack spacing=<span class="string">"2"</span>&gt;</span><br><span class="line">        &lt;FormControl isDisabled isInvalid&gt;</span><br><span class="line">         &lt;InputGroup&gt;</span><br><span class="line">           &lt;InputLeftAddon children=&#123;&lt;FaUserAlt /&gt;&#125;/&gt;</span><br><span class="line">           &lt;Input placeholder=<span class="string">"请输入用户名"</span> /&gt;</span><br><span class="line">         &lt;<span class="regexp">/InputGroup&gt;</span></span><br><span class="line"><span class="regexp">         &lt;FormHelperText&gt;用户名是必填项&lt;/</span>FormHelperText&gt;</span><br><span class="line">         &lt;<span class="regexp">/FormControl&gt;</span></span><br><span class="line"><span class="regexp">         &lt;InputGroup&gt;</span></span><br><span class="line"><span class="regexp">           &lt;InputLeftAddon children=&#123;&lt;FaLock /</span>&gt;&#125;/&gt;</span><br><span class="line">           &lt;Input type=<span class="string">"password"</span> placeholder=<span class="string">"请输入密码"</span>/&gt;</span><br><span class="line">           &lt;InputRightAddon children=&#123;&lt;FaCheck /&gt;&#125;/&gt;</span><br><span class="line">         &lt;<span class="regexp">/InputGroup&gt;</span></span><br><span class="line"><span class="regexp">         &lt;RadioGroup defaultValue="0"&gt;</span></span><br><span class="line"><span class="regexp">           &lt;Stack spacing=&#123;4&#125; direction="horizontal"&gt;</span></span><br><span class="line"><span class="regexp">             &lt;Radio value="0"&gt;男&lt;/</span>Radio&gt;</span><br><span class="line">             &lt;Radio value=<span class="string">"1"</span>&gt;女&lt;<span class="regexp">/Radio&gt;</span></span><br><span class="line"><span class="regexp">           &lt;/</span>Stack&gt;</span><br><span class="line">         &lt;<span class="regexp">/RadioGroup&gt;</span></span><br><span class="line"><span class="regexp">         &lt;Select appearance="none" placeholder="请选择学科"&gt;</span></span><br><span class="line"><span class="regexp">           &lt;option value="Java"&gt;Java&lt;/</span>option&gt;</span><br><span class="line">           &lt;option value=<span class="string">"大前端"</span>&gt;大前端&lt;<span class="regexp">/option&gt;</span></span><br><span class="line"><span class="regexp">         &lt;/</span>Select&gt;</span><br><span class="line">         &lt;Flex&gt;</span><br><span class="line">           &lt;Switch id=<span class="string">"deal"</span> mr=<span class="string">"3"</span> /&gt;</span><br><span class="line">           &lt;Formlabel htmlFor=<span class="string">"deal"</span>&gt;是否同意协议&lt;<span class="regexp">/Formlabel&gt;</span></span><br><span class="line"><span class="regexp">         &lt;/</span>Flex&gt;</span><br><span class="line">         &lt;Button _hover=&#123;&#123;<span class="attr">bgColor</span>:<span class="string">'tomato'</span>&#125;&#125; w=<span class="string">"100%"</span> colorScheme=<span class="string">"teal"</span>&gt;注册&lt;<span class="regexp">/Button&gt;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>Stack&gt;</span><br><span class="line">      &lt;<span class="regexp">/form&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SignIn.js</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Input, InputGroup, Stack, InputLeftAddon, InputRightAddon, FormHelperText, Button, FormControl &#125; <span class="keyword">from</span> <span class="string">'@chakra-ui/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; FaUserAlt, FaLock, FaCheck &#125; <span class="keyword">from</span> <span class="string">'react-icons/fa'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">SignIn</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;form&gt;</span><br><span class="line">        &lt;Stack spacing=<span class="string">"2"</span>&gt;</span><br><span class="line">        &lt;FormControl isDisabled isInvalid&gt;</span><br><span class="line">         &lt;InputGroup&gt;</span><br><span class="line">           &lt;InputLeftAddon children=&#123;&lt;FaUserAlt /&gt;&#125;/&gt;</span><br><span class="line">           &lt;Input placeholder=<span class="string">"请输入用户名"</span> /&gt;</span><br><span class="line">         &lt;<span class="regexp">/InputGroup&gt;</span></span><br><span class="line"><span class="regexp">         &lt;FormHelperText&gt;用户名是必填项&lt;/</span>FormHelperText&gt;</span><br><span class="line">         &lt;<span class="regexp">/FormControl&gt;</span></span><br><span class="line"><span class="regexp">         &lt;InputGroup&gt;</span></span><br><span class="line"><span class="regexp">           &lt;InputLeftAddon children=&#123;&lt;FaLock /</span>&gt;&#125;/&gt;</span><br><span class="line">           &lt;Input type=<span class="string">"password"</span> placeholder=<span class="string">"请输入密码"</span>/&gt;</span><br><span class="line">           &lt;InputRightAddon children=&#123;&lt;FaCheck /&gt;&#125;/&gt;</span><br><span class="line">         &lt;<span class="regexp">/InputGroup&gt;</span></span><br><span class="line"><span class="regexp">         </span></span><br><span class="line"><span class="regexp">         &lt;Button _hover=&#123;&#123;bgColor:'tomato'&#125;&#125; w="100%" colorScheme="teal"&gt;登录&lt;/</span>Button&gt;</span><br><span class="line">        &lt;<span class="regexp">/Stack&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>form&gt;</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Form.js</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Tabs, TabList, Tab, TabPanel, Tabpanels, Box, Image &#125; <span class="keyword">from</span> <span class="string">'@chakra-ui/core'</span>;</span><br><span class="line"><span class="keyword">import</span> SignUp <span class="keyword">from</span> <span class="string">'./SignUp'</span>;</span><br><span class="line"><span class="keyword">import</span> SignIn <span class="keyword">from</span> <span class="string">'./SignIn'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> chakraUILight <span class="keyword">from</span> <span class="string">'../assets/images/chakra-ui-light.png'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">Form</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">Box</span> <span class="attr">bgColor</span>=<span class="string">"gray.200"</span> <span class="attr">p</span>=<span class="string">&#123;3&#125;</span> <span class="attr">w</span>=<span class="string">"100%"</span> <span class="attr">boxShadow</span>=<span class="string">"lg"</span> <span class="attr">borderRadius</span>=<span class="string">"lg"</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">Image</span> <span class="attr">w</span>=<span class="string">"250px"</span> <span class="attr">mx</span>=<span class="string">"auto"</span> <span class="attr">mt</span>=<span class="string">"2"</span> <span class="attr">mb</span>=<span class="string">"6"</span> <span class="attr">src</span>=<span class="string">&#123;chakraUILight&#125;</span> /&gt;</span></span></span><br><span class="line">      &lt;Tabs isFitted&gt;</span><br><span class="line">        &lt;TabList&gt;</span><br><span class="line">          &lt;Tab _focus=&#123;&#123;boxShadow:"none"&#125;&#125;&gt;注册&lt;/Tab&gt;</span><br><span class="line">          &lt;Tab _focus=&#123;&#123;boxShadow:"none"&#125;&#125;&gt;登录&lt;/Tab&gt;</span><br><span class="line">        &lt;/TabList&gt;</span><br><span class="line">        &lt;Tabpanels&gt;</span><br><span class="line">          &lt;Tabpanel&gt;</span><br><span class="line">            &lt;SignUp/&gt;</span><br><span class="line">          &lt;/Tabpanel&gt;</span><br><span class="line">          &lt;Tabpanel&gt;</span><br><span class="line">            &lt;SignIn/&gt;</span><br><span class="line">          &lt;/Tabpanel&gt;</span><br><span class="line">        &lt;/Tabpanels&gt;</span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">Tabs</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">Box</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="15-布局组件板式组件的使用"><a href="#15-布局组件板式组件的使用" class="headerlink" title="15.布局组件板式组件的使用"></a>15.布局组件板式组件的使用</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Box, Image, Badge, Text, Stack, Flex, Button, useColorModeValue, useColorMode &#125; <span class="keyword">from</span> <span class="string">"@chakra-ui/core"</span>;</span><br><span class="line"><span class="keyword">import</span> chakraUI <span class="keyword">from</span> <span class="string">"../assets/images/chakra-ui.png"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AiFillStar &#125; <span class="keyword">from</span> <span class="string">"react-icons/ai"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">Card</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> bgColor = useColorModeValue(<span class="string">'gray.200'</span>, <span class="string">'gray.700'</span>);</span><br><span class="line">  <span class="keyword">const</span> textColor = useColorModeValue(<span class="string">'gray.700'</span>, <span class="string">'gray.100'</span>);</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Box</span><br><span class="line">      bgColor=&#123;bgColor&#125;</span><br><span class="line">      w=&#123;<span class="number">1</span> / <span class="number">2</span>&#125;</span><br><span class="line">      borderRadius=<span class="string">"lg"</span></span><br><span class="line">      boxShadow=<span class="string">"lg"</span></span><br><span class="line">      overflow=<span class="string">"hidden"</span></span><br><span class="line">    &gt;</span><br><span class="line">      &lt;Image src=&#123;chakraUI&#125; /&gt;</span><br><span class="line">      &lt;Box p=&#123;<span class="number">3</span>&#125;&gt;</span><br><span class="line">        &lt;Stack direction=<span class="string">"horizontal"</span> align=<span class="string">"center"</span>&gt;</span><br><span class="line">          &lt;Badge variant=<span class="string">"solid"</span> colorScheme=<span class="string">"teal"</span> borderRadius=<span class="string">"full"</span> px=<span class="string">"2"</span>&gt;</span><br><span class="line">            New</span><br><span class="line">          &lt;<span class="regexp">/Badge&gt;</span></span><br><span class="line"><span class="regexp">          &lt;Badge variant="solid" colorScheme="teal" borderRadius="full" px="2"&gt;</span></span><br><span class="line"><span class="regexp">            React</span></span><br><span class="line"><span class="regexp">          &lt;/</span>Badge&gt;</span><br><span class="line">          &lt;Badge variant=<span class="string">"solid"</span> colorScheme=<span class="string">"teal"</span> borderRadius=<span class="string">"full"</span> px=<span class="string">"2"</span>&gt;</span><br><span class="line">            Chakra-UI</span><br><span class="line">          &lt;<span class="regexp">/Badge&gt;</span></span><br><span class="line"><span class="regexp">          &lt;Text color=&#123;textColor&#125;&gt;拉钩出品 必属精品&lt;/</span>Text&gt;</span><br><span class="line">        &lt;<span class="regexp">/Stack&gt;</span></span><br><span class="line"><span class="regexp">        &lt;Text</span></span><br><span class="line"><span class="regexp">          fontSize="xl"</span></span><br><span class="line"><span class="regexp">          pt=&#123;3&#125;</span></span><br><span class="line"><span class="regexp">          pb=&#123;2&#125;</span></span><br><span class="line"><span class="regexp">          color=&#123;textColor&#125;</span></span><br><span class="line"><span class="regexp">          as="h3"</span></span><br><span class="line"><span class="regexp">          fontWeight="semibold"</span></span><br><span class="line"><span class="regexp">        &gt;</span></span><br><span class="line"><span class="regexp">          Chakra-UI 框架专题课程</span></span><br><span class="line"><span class="regexp">        &lt;/</span>Text&gt;</span><br><span class="line">        &lt;Text fontWeight=<span class="string">"light"</span> fontSize=<span class="string">"sm"</span> lineHeight=<span class="string">"tall"</span>&gt;</span><br><span class="line">          Chakra UI 是一个简单的, 模块化的易于理解的 UI 组件库. 提供了丰富的构建</span><br><span class="line">          React 应用所需的UI组件.</span><br><span class="line">          在整个应用程序中，在任何组件上快速、轻松地引用主题中的值。组件的构建考虑到了组合。你可以利用任何组件来创造新事物。Chakra-UI</span><br><span class="line">          严格遵循WAI-ARIA标准。所有组件都有适当的属性和现成的键盘交互。Chakra</span><br><span class="line">          UI 是一个简单的, 模块化的易于理解的 UI 组件库. 提供了丰富的构建 React</span><br><span class="line">          应用所需的UI组件.</span><br><span class="line">        &lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">        &lt;Flex align="center" mt=&#123;2&#125;&gt;</span></span><br><span class="line"><span class="regexp">          &lt;Flex color="teal.500"&gt;</span></span><br><span class="line"><span class="regexp">            &lt;AiFillStar /</span>&gt;</span><br><span class="line">            &lt;AiFillStar /&gt;</span><br><span class="line">            &lt;AiFillStar /&gt;</span><br><span class="line">            &lt;AiFillStar /&gt;</span><br><span class="line">          &lt;<span class="regexp">/Flex&gt;</span></span><br><span class="line"><span class="regexp">          &lt;AiFillStar /</span>&gt;</span><br><span class="line">          &lt;Text ml=&#123;<span class="number">1</span>&#125;&gt;<span class="number">100</span> 评论&lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>Flex&gt;</span><br><span class="line">      &lt;<span class="regexp">/Box&gt;</span></span><br><span class="line"><span class="regexp">      &lt;Button w="100%" colorScheme="teal"&gt;登录&lt;/</span>Button&gt;</span><br><span class="line">    &lt;<span class="regexp">/Box&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="16-表单和卡片的颜色兼容"><a href="#16-表单和卡片的颜色兼容" class="headerlink" title="16.表单和卡片的颜色兼容"></a>16.表单和卡片的颜色兼容</h3><p>见上节</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/03/10/39/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="FY">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="旋の飞羽">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/03/10/39/" itemprop="url">学习笔记 ----- 【React 框架原理与实战】React 数据流方案专题（Redux、MobX）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-03-10T00:00:00+08:00">
                2021-03-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index">
                    <span itemprop="name">前端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>作者：FY<br>引用请标明出处</p>
</blockquote>
<h1 id="Part-4-·-React-框架原理与实战"><a href="#Part-4-·-React-框架原理与实战" class="headerlink" title="Part 4 · React 框架原理与实战"></a>Part 4 · React 框架原理与实战</h1><h2 id="模块二-·-React-数据流方案专题（Redux、MobX）"><a href="#模块二-·-React-数据流方案专题（Redux、MobX）" class="headerlink" title="模块二 · React 数据流方案专题（Redux、MobX）"></a>模块二 · React 数据流方案专题（Redux、MobX）</h2><h2 id="任务一：Redux"><a href="#任务一：Redux" class="headerlink" title="任务一：Redux"></a>任务一：Redux</h2><h3 id="1-【课程资料】课程资料购物车代码shooping-serve"><a href="#1-【课程资料】课程资料购物车代码shooping-serve" class="headerlink" title="1.【课程资料】课程资料购物车代码shooping_serve"></a>1.【课程资料】课程资料购物车代码shooping_serve</h3><h3 id="2-【课程资料】课程资料"><a href="#2-【课程资料】课程资料" class="headerlink" title="2.【课程资料】课程资料"></a>2.【课程资料】课程资料</h3><h3 id="3-Redux专题内容介绍"><a href="#3-Redux专题内容介绍" class="headerlink" title="3.Redux专题内容介绍"></a>3.Redux专题内容介绍</h3><ul>
<li>Redux 核心</li>
<li>React + Redux</li>
<li>Redux 中间件</li>
<li>开发 Redux 中间件</li>
<li>Redux 综合案例</li>
</ul>
<h3 id="4-Redux简介"><a href="#4-Redux简介" class="headerlink" title="4.Redux简介"></a>4.Redux简介</h3><blockquote>
<p>Redux 介绍</p>
</blockquote>
<ul>
<li>JavaScript 状态对象，提供可预测化的状态管理</li>
</ul>
<h3 id="5-Redux核心概念及工作流程"><a href="#5-Redux核心概念及工作流程" class="headerlink" title="5.Redux核心概念及工作流程"></a>5.Redux核心概念及工作流程</h3><ul>
<li>Store：存储状态的容器，JavaScript 对象</li>
<li>View：视图，HTML页面</li>
<li>Actions：对象，描述状态进行怎样的操作</li>
<li>Reducers：函数，操作状态并返回新的状态</li>
</ul>
<h3 id="6-Redux计数器案例"><a href="#6-Redux计数器案例" class="headerlink" title="6.Redux计数器案例"></a>6.Redux计数器案例</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"plus"</span>&gt;</span>+<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"count"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"minus"</span>&gt;</span>-<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"redux.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 3. 存储默认状态</span></span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> initialState = &#123;</span></span><br><span class="line">      count: 0</span><br><span class="line">    &#125;</span><br><span class="line"><span class="actionscript">    <span class="comment">// 2. 创建 reducer 函数</span></span></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">reducer</span> <span class="params">(state = initialState, action)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">switch</span> (action.type) &#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">case</span> <span class="string">'increment'</span>:</span></span><br><span class="line"><span class="actionscript">          <span class="keyword">return</span> &#123;count: state.count + <span class="number">1</span>&#125;;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">case</span> <span class="string">'decrement'</span>:</span></span><br><span class="line"><span class="actionscript">          <span class="keyword">return</span> &#123;count: state.count - <span class="number">1</span>&#125;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">default</span>:</span></span><br><span class="line"><span class="actionscript">          <span class="keyword">return</span> state;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="actionscript">    <span class="comment">// 1. 创建 store 对象</span></span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> store = Redux.createStore(reducer);</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="comment">// 4. 定义 action</span></span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> increment = &#123; type: <span class="string">'increment'</span> &#125;;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> decrement = &#123; type: <span class="string">'decrement'</span> &#125;;</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="comment">// 5. 获取按钮 给按钮添加点击事件</span></span></span><br><span class="line"><span class="javascript">    <span class="built_in">document</span>.getElementById(<span class="string">'plus'</span>).onclick = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="actionscript">      <span class="comment">// 6. 触发action</span></span></span><br><span class="line">      store.dispatch(increment);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="built_in">document</span>.getElementById(<span class="string">'minus'</span>).onclick = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="actionscript">      <span class="comment">// 6. 触发action</span></span></span><br><span class="line">      store.dispatch(decrement);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="comment">// 7. 订阅 store</span></span></span><br><span class="line"><span class="javascript">    store.subscribe(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="actionscript">      <span class="comment">// 获取store对象中存储的状态</span></span></span><br><span class="line"><span class="actionscript">      <span class="comment">// console.log(store.getState());</span></span></span><br><span class="line"><span class="javascript">      <span class="built_in">document</span>.getElementById(<span class="string">'count'</span>).innerHTML = store.getState().count;</span></span><br><span class="line">    &#125;)</span><br><span class="line">  <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="7-Redux核心API总结"><a href="#7-Redux核心API总结" class="headerlink" title="7.Redux核心API总结"></a>7.Redux核心API总结</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建 Store 状态容器</span></span><br><span class="line"><span class="keyword">const</span> store = Redux.createStore(reducer)</span><br><span class="line"><span class="comment">// 创建用于处理状态的 reducer 函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reducer</span> (<span class="params">state = initialState, action</span>) </span>&#123;&#125;</span><br><span class="line"><span class="comment">// 获取状态</span></span><br><span class="line">store.getState();</span><br><span class="line"><span class="comment">// 订阅状态</span></span><br><span class="line">store.subscribe(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;);</span><br><span class="line"><span class="comment">// 触发 Action</span></span><br><span class="line">store.dispatch(&#123;<span class="attr">type</span>:<span class="string">'description...'</span>&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="8-在React中使用Redux解决的问题"><a href="#8-在React中使用Redux解决的问题" class="headerlink" title="8.在React中使用Redux解决的问题"></a>8.在React中使用Redux解决的问题</h3><blockquote>
<p>在 React 中不使用 Redux 时遇到的问题</p>
</blockquote>
<p>在 React 在组件通信的数据流是单向的，顶层组件可以通过 props 属性向下层组件传递数据，而下层组件不能向上层组件传递数据，要实现下层组件修改数据，需要上层组件传递修改数据的方法到下层组件，当项目越来越大的时候，组件之间传递数据变得越来越困难。</p>
<blockquote>
<p>在 React 项目中加入 Redux 的好处</p>
</blockquote>
<p>使用 Redux 管理数据，由于 Store 独立于组件，使得数据管理独立于组件，解决了组件与组件之间传递数据困难的问题。</p>
<h3 id="9-React-计数器"><a href="#9-React-计数器" class="headerlink" title="9.React 计数器"></a>9.React 计数器</h3><blockquote>
<p>下载 Redux</p>
</blockquote>
<ul>
<li>npm install redux react-redux</li>
</ul>
<blockquote>
<p>Redux 工作流程</p>
</blockquote>
<ul>
<li>1.组件通过 dispatch 方法触发 Action</li>
<li>2.Store 接收 Action 并将 Action 分发给 Reducer</li>
<li>3.Reducer 根据 Action 类型对状态进行更改并将更改后的状态返回给 Store</li>
<li>4.组件订阅了 Store 中的状态，Store中的状态更新会同步到组件</li>
</ul>
<h3 id="10-Provider组件与connect方法"><a href="#10-Provider组件与connect方法" class="headerlink" title="10.Provider组件与connect方法"></a>10.Provider组件与connect方法</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* index.js */</span></span><br><span class="line">    <span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line">    <span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span></span><br><span class="line">    <span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./App'</span></span><br><span class="line">    <span class="keyword">import</span> &#123; createStore &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</span><br><span class="line">    <span class="keyword">import</span> Counter <span class="keyword">from</span> <span class="string">'./components/Counter'</span>;</span><br><span class="line">    <span class="keyword">import</span> &#123; Provider &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span>;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> initialState = &#123;</span><br><span class="line">      count: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">reducer</span> (<span class="params">state = initialState, action</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'increment'</span>:</span><br><span class="line">          <span class="keyword">return</span> &#123;<span class="attr">count</span>: state.count + <span class="number">1</span>&#125;;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'decrement'</span>:</span><br><span class="line">          <span class="keyword">return</span> &#123;<span class="attr">count</span>: state.count - <span class="number">1</span>&#125;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">          <span class="keyword">return</span> state;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> store = Redux.createStore(reducer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// const increment = &#123; type: 'increment' &#125;;</span></span><br><span class="line">    <span class="comment">// const decrement = &#123; type: 'decrement' &#125;;</span></span><br><span class="line"></span><br><span class="line">    ReactDOM.render(</span><br><span class="line">        &lt;Provider store=&#123;store&#125;&gt;<span class="xml"><span class="tag">&lt;<span class="name">Counter</span> /&gt;</span></span>&lt;<span class="regexp">/Provider&gt;,</span></span><br><span class="line"><span class="regexp">        document.getElementById('root')</span></span><br><span class="line"><span class="regexp">    )</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Counter.js */</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Counter</span> (<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> props.dispatch(&#123; type: 'increment' &#125;)&#125;&gt;+<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;props.count&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> props.dispatch(&#123; type: 'decrement' &#125;)&#125;&gt;-<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. connect 方法会帮助我们订阅store 当store中的状态发生更改的时候 会帮助我们重新渲染组件</span></span><br><span class="line"><span class="comment">// 2. connect 方法可以让我们获取store中的状态 将状态通过组件的props属性映射给组件</span></span><br><span class="line"><span class="comment">// 3. connect 方法可以让我们获取 dispatch 方法</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapStateToProps = <span class="function"><span class="params">state</span> =&gt;</span> (&#123;</span><br><span class="line">  count: state.count</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(mapStateToProps)(Counter);</span><br></pre></td></tr></table></figure>

<h3 id="11-使用connect方法的第二个参数简化组件视图"><a href="#11-使用connect方法的第二个参数简化组件视图" class="headerlink" title="11.使用connect方法的第二个参数简化组件视图"></a>11.使用connect方法的第二个参数简化组件视图</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Counter.js */</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Counter</span> (<span class="params">&#123;count, increment, decrement&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;increment&#125;</span>&gt;</span>+<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;count&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;decrement&#125;</span>&gt;</span>-<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. connect 方法会帮助我们订阅store 当store中的状态发生更改的时候 会帮助我们重新渲染组件</span></span><br><span class="line"><span class="comment">// 2. connect 方法可以让我们获取store中的状态 将状态通过组件的props属性映射给组件</span></span><br><span class="line"><span class="comment">// 3. connect 方法可以让我们获取 dispatch 方法</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapStateToProps = <span class="function"><span class="params">state</span> =&gt;</span> (&#123;</span><br><span class="line">  count: state.count</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapDispatchToProps = <span class="function"><span class="params">dispatch</span> =&gt;</span> (&#123;</span><br><span class="line">    increment() &#123;</span><br><span class="line">        dispatch(&#123; <span class="attr">type</span>: <span class="string">'increment'</span> &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    decrement() &#123;</span><br><span class="line">        dispatch(&#123; <span class="attr">type</span>: <span class="string">'decrement'</span> &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(mapStateToProps, mapDispatchToProps)(Counter);</span><br></pre></td></tr></table></figure>

<h3 id="12-bindActionsCreators方法的使用"><a href="#12-bindActionsCreators方法的使用" class="headerlink" title="12.bindActionsCreators方法的使用"></a>12.bindActionsCreators方法的使用</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Counter.js */</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; bindActionCreators &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> counterActions <span class="keyword">from</span> <span class="string">'../store/actions/counter.actions'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Counter</span> (<span class="params">&#123;count, increment, decrement&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;increment&#125;</span>&gt;</span>+<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;count&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;decrement&#125;</span>&gt;</span>-<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. connect 方法会帮助我们订阅store 当store中的状态发生更改的时候 会帮助我们重新渲染组件</span></span><br><span class="line"><span class="comment">// 2. connect 方法可以让我们获取store中的状态 将状态通过组件的props属性映射给组件</span></span><br><span class="line"><span class="comment">// 3. connect 方法可以让我们获取 dispatch 方法</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapStateToProps = <span class="function"><span class="params">state</span> =&gt;</span> (&#123;</span><br><span class="line">  count: state.count</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapDispatchToProps = <span class="function"><span class="params">dispatch</span> =&gt;</span> bindActionCreators(counterActions, dispatch)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(mapStateToProps, mapDispatchToProps)(Counter);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// store/actions/counter.action.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> increment = <span class="function"><span class="params">()</span> =&gt;</span> (&#123; <span class="attr">type</span>: <span class="string">'increment'</span> &#125;);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> decrement = <span class="function"><span class="params">()</span> =&gt;</span> (&#123; <span class="attr">type</span>: <span class="string">'decrement'</span> &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="13-代码重构"><a href="#13-代码重构" class="headerlink" title="13.代码重构"></a>13.代码重构</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* index.js */</span></span><br><span class="line">    <span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line">    <span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span></span><br><span class="line">    <span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./App'</span></span><br><span class="line">    <span class="keyword">import</span> Counter <span class="keyword">from</span> <span class="string">'./components/Counter'</span>;</span><br><span class="line">    <span class="keyword">import</span> &#123; Provider &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span>;</span><br><span class="line">    <span class="keyword">import</span> &#123; store &#125; <span class="keyword">from</span> <span class="string">'./store/index'</span>;</span><br><span class="line">    </span><br><span class="line">    ReactDOM.render(</span><br><span class="line">        &lt;Provider store=&#123;store&#125;&gt;<span class="xml"><span class="tag">&lt;<span class="name">Counter</span> /&gt;</span></span>&lt;<span class="regexp">/Provider&gt;,</span></span><br><span class="line"><span class="regexp">        document.getElementById('root')</span></span><br><span class="line"><span class="regexp">    )</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// store/index.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; createStore &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</span><br><span class="line"><span class="keyword">import</span> reducer <span class="keyword">from</span> <span class="string">'./reducers/counter.reducer'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> store = Redux.createStore(reducer);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// store/reducers/counter.reducer.js</span></span><br><span class="line"><span class="keyword">import</span> &#123;INCREMENT,DECREMENT&#125; <span class="keyword">from</span> <span class="string">'../const/counter.const'</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> initialState = &#123;</span><br><span class="line">      count: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (state = initialState, action) =&gt; &#123;</span><br><span class="line">      <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">        <span class="keyword">case</span> INCREMENT:</span><br><span class="line">          <span class="keyword">return</span> &#123;<span class="attr">count</span>: state.count + <span class="number">1</span>&#125;;</span><br><span class="line">        <span class="keyword">case</span> DECREMENT:</span><br><span class="line">          <span class="keyword">return</span> &#123;<span class="attr">count</span>: state.count - <span class="number">1</span>&#125;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">          <span class="keyword">return</span> state;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// store/const/counter.const.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> INCREMENT = <span class="string">'increment'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> DECREMENT = <span class="string">'decrement'</span>;</span><br></pre></td></tr></table></figure>



<h3 id="14-Action-js"><a href="#14-Action-js" class="headerlink" title="14.Action```js"></a>14.Action```js</h3><p>// store/actions/counter.action.js<br>import {INCREMENT,DECREMENT} from ‘../const/counter.const’<br>export const increment = () =&gt; ({ type: INCREMENT });<br>export const decrement = () =&gt; ({ type: DECREMENT });</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#96;&#96;&#96;js</span><br><span class="line">&#x2F;&#x2F; 传递参数</span><br><span class="line">&lt;button onClick&#x3D;&#123;()&#x3D;&gt;increment(5)&#125;&gt;+1&lt;&#x2F;button&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 接收参数，传递 reducer</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> increment = <span class="function"><span class="params">payload</span> =&gt;</span> (&#123;<span class="attr">type</span>: INCREMENT, payload&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="15-redux实现弹出框案例"><a href="#15-redux实现弹出框案例" class="headerlink" title="15.redux实现弹出框案例"></a>15.redux实现弹出框案例</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// modal.js</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; bindActionCreators &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> modalActions <span class="keyword">from</span> <span class="string">'../store/actions/modal.actions'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Modal</span>(<span class="params">&#123;showStatus,show,hide&#125;</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> styles = &#123;</span><br><span class="line">        width: <span class="number">200</span>,</span><br><span class="line">        height: <span class="number">200</span>,</span><br><span class="line">        position: <span class="string">'absolute'</span>,</span><br><span class="line">        left: <span class="string">'50%'</span>,</span><br><span class="line">        top: <span class="string">'50%'</span>,</span><br><span class="line">        marginLeft: <span class="number">-100</span>,</span><br><span class="line">        marginTop: <span class="number">-100</span>,</span><br><span class="line">        backgroundColor: <span class="string">'skyblue'</span>,</span><br><span class="line">        display: showStatus ? <span class="string">'block'</span>:<span class="string">'none'</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;show&#125;</span>&gt;</span>显示<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;hide&#125;</span>&gt;</span>隐藏<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;styles&#125;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapStateToProps = <span class="function"><span class="params">state</span> =&gt;</span> (&#123;</span><br><span class="line">    showStatus: state.show</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapDispatchToProps = <span class="function"><span class="params">dispatch</span> =&gt;</span> bindActionCreators(modalActions,dispatch)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(mapStateToProps, mapDispatchToProps)(Modal);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* index.js */</span></span><br><span class="line">    <span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line">    <span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line">    <span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./App'</span>;</span><br><span class="line">    <span class="keyword">import</span> &#123; Provider &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span>;</span><br><span class="line">    <span class="keyword">import</span> &#123; store &#125; <span class="keyword">from</span> <span class="string">'./store/index'</span>;</span><br><span class="line">    </span><br><span class="line">    ReactDOM.render(</span><br><span class="line">        &lt;Provider store=&#123;store&#125;&gt;<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span></span>&lt;<span class="regexp">/Provider&gt;,</span></span><br><span class="line"><span class="regexp">        document.getElementById('root')</span></span><br><span class="line"><span class="regexp">    )</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// App.js</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> Counter <span class="keyword">from</span> <span class="string">'./components/Counter'</span>;</span><br><span class="line"><span class="keyword">import</span> Modal <span class="keyword">from</span> <span class="string">'./components/modal'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">Counter</span> /&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">Modal</span> /&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> App;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// store/reducers/counter.reducer.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; INCREMENT,DECREMENT &#125; <span class="keyword">from</span> <span class="string">'../const/counter.const'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; SHOWMODAL, HIDEMODAL &#125; <span class="keyword">from</span> <span class="string">'../const/modal.const'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> initialState = &#123;</span><br><span class="line">      count: <span class="number">0</span>,</span><br><span class="line">      show: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (state = initialState, action) =&gt; &#123;</span><br><span class="line">      <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">        <span class="keyword">case</span> INCREMENT:</span><br><span class="line">          <span class="keyword">return</span> &#123;</span><br><span class="line">              ...state,</span><br><span class="line">                count: state.count + <span class="number">1</span></span><br><span class="line">              &#125;</span><br><span class="line">        <span class="keyword">case</span> DECREMENT:</span><br><span class="line">          <span class="keyword">return</span> &#123;</span><br><span class="line">              ...state,</span><br><span class="line">                count: state.count - <span class="number">1</span></span><br><span class="line">              &#125;</span><br><span class="line">        <span class="keyword">case</span> SHOWMODAL:</span><br><span class="line">          <span class="keyword">return</span> &#123;</span><br><span class="line">              ...state,</span><br><span class="line">              show: <span class="literal">true</span></span><br><span class="line">          &#125;  </span><br><span class="line">        <span class="keyword">case</span> HIDEMODAL:</span><br><span class="line">          <span class="keyword">return</span> &#123;</span><br><span class="line">              ...state,</span><br><span class="line">              show: <span class="literal">false</span></span><br><span class="line">          &#125; </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">          <span class="keyword">return</span> state;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// modal.actions.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; SHOWMODAL, HIDEMODAL &#125; <span class="keyword">from</span> <span class="string">'../const/modal.const'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> show = <span class="function"><span class="params">()</span> =&gt;</span> (&#123; <span class="attr">type</span>: SHOWMODAL &#125;);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> hide = <span class="function"><span class="params">()</span> =&gt;</span> (&#123; <span class="attr">type</span>: HIDEMODAL &#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// modal.const.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> SHOWMODAL = <span class="string">'showModal'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> HIDEMODAL = <span class="string">'hideModal'</span>;</span><br></pre></td></tr></table></figure>
<h3 id="16-拆分合并reducer"><a href="#16-拆分合并reducer" class="headerlink" title="16.拆分合并reducer"></a>16.拆分合并reducer</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// modal.reducer.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; SHOWMODAL, HIDEMODAL &#125; <span class="keyword">from</span> <span class="string">'../const/modal.const'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> initialState = &#123;</span><br><span class="line">      show: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (state = initialState, action) =&gt; &#123;</span><br><span class="line">      <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">        <span class="keyword">case</span> SHOWMODAL:</span><br><span class="line">          <span class="keyword">return</span> &#123;</span><br><span class="line">              ...state,</span><br><span class="line">              show: <span class="literal">true</span></span><br><span class="line">          &#125;  </span><br><span class="line">        <span class="keyword">case</span> HIDEMODAL:</span><br><span class="line">          <span class="keyword">return</span> &#123;</span><br><span class="line">              ...state,</span><br><span class="line">              show: <span class="literal">false</span></span><br><span class="line">          &#125; </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">          <span class="keyword">return</span> state;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// root.reducer.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; combineReducers &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</span><br><span class="line"><span class="keyword">import</span> CounterReducer <span class="keyword">from</span> <span class="string">'./counter.reducer'</span>;</span><br><span class="line"><span class="keyword">import</span> ModalReducer <span class="keyword">from</span> <span class="string">'./modal.reducer'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> combineReducers(&#123;</span><br><span class="line">    counter: CounterReducer,</span><br><span class="line">    modal: ModalReducer</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; createStore &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</span><br><span class="line"><span class="keyword">import</span> RootReducer <span class="keyword">from</span> <span class="string">'./reducers/root.reducer'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> store = createStore(RootReducer);</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// modal.js</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; bindActionCreators &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> modalActions <span class="keyword">from</span> <span class="string">'../store/actions/modal.actions'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Modal</span>(<span class="params">&#123;showStatus,show,hide&#125;</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> styles = &#123;</span><br><span class="line">        width: <span class="number">200</span>,</span><br><span class="line">        height: <span class="number">200</span>,</span><br><span class="line">        position: <span class="string">'absolute'</span>,</span><br><span class="line">        left: <span class="string">'50%'</span>,</span><br><span class="line">        top: <span class="string">'50%'</span>,</span><br><span class="line">        marginLeft: <span class="number">-100</span>,</span><br><span class="line">        marginTop: <span class="number">-100</span>,</span><br><span class="line">        backgroundColor: <span class="string">'skyblue'</span>,</span><br><span class="line">        display: showStatus ? <span class="string">'block'</span>:<span class="string">'none'</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;show&#125;</span>&gt;</span>显示<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;hide&#125;</span>&gt;</span>隐藏<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;styles&#125;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapStateToProps = <span class="function"><span class="params">state</span> =&gt;</span> (&#123;</span><br><span class="line">    showStatus: state.modal.show</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapDispatchToProps = <span class="function"><span class="params">dispatch</span> =&gt;</span> bindActionCreators(modalActions,dispatch)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(mapStateToProps, mapDispatchToProps)(Modal);</span><br></pre></td></tr></table></figure>
<h3 id="17-中间件概念介绍"><a href="#17-中间件概念介绍" class="headerlink" title="17.中间件概念介绍"></a>17.中间件概念介绍</h3><blockquote>
<p>什么是中间件</p>
</blockquote>
<p>中间件允许我们扩展 redux 应用程序</p>
<h3 id="18-开发Redux中间件"><a href="#18-开发Redux中间件" class="headerlink" title="18.开发Redux中间件"></a>18.开发Redux中间件</h3><blockquote>
<p>开发 Redux 中间件</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 开发中间件的模板代码</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> store =&gt; <span class="function"><span class="params">next</span> =&gt;</span> <span class="function"><span class="params">action</span> =&gt;</span> &#123; &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注册中间件</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 中间件在开发完成以后只有被注册才能在 Redux 的工作流程中生效</span></span><br><span class="line"><span class="keyword">import</span> &#123; createStore, applyMiddleware &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</span><br><span class="line"><span class="keyword">import</span> logger <span class="keyword">from</span> <span class="string">'./middlewares/logger'</span>;</span><br><span class="line"></span><br><span class="line">createStore(reducer, applyMiddleware(logger))</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// logger.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> store =&gt; <span class="function"><span class="params">next</span> =&gt;</span> <span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">   <span class="built_in">console</span>.log(store)</span><br><span class="line">   <span class="built_in">console</span>.log(action)</span><br><span class="line">   next()</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> store =&gt; <span class="function"><span class="params">next</span> =&gt;</span> <span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">   <span class="built_in">console</span>.log(<span class="string">'test中间件被执行了~'</span>)</span><br><span class="line">   next()</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; createStore, applyMiddleware &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</span><br><span class="line"><span class="keyword">import</span> RootReducer <span class="keyword">from</span> <span class="string">'./reducers/root.reducer'</span>;</span><br><span class="line"><span class="keyword">import</span> logger <span class="keyword">from</span> <span class="string">'./middlewares/logger'</span>;</span><br><span class="line"><span class="keyword">import</span> test <span class="keyword">from</span> <span class="string">'./middlewares/test'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> store = createStore(RootReducer,applyMiddleware(logger, test));</span><br></pre></td></tr></table></figure>
<h3 id="19-Redux中间件开发实例thunk"><a href="#19-Redux中间件开发实例thunk" class="headerlink" title="19.Redux中间件开发实例thunk"></a>19.Redux中间件开发实例thunk</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// thunk.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (&#123;dispatch&#125;) =&gt; <span class="function"><span class="params">next</span> =&gt;</span> <span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 1.当前这个中间件函数不关心你想执行什么样的异步操作，只关心你执行的是不是异步操作</span></span><br><span class="line">    <span class="comment">// 2.如果你执行的是异步操作，你在触发 action 的时候，给我传递一个函数，如果执行的是同步操作，就传递 action 对象</span></span><br><span class="line">    <span class="comment">// 3.异步操作代码要写在你传递进来的函数中</span></span><br><span class="line">    <span class="comment">// 4.当前这个中间件函数在调用你传递进来的函数时，要将 dispatch 方法传递过去</span></span><br><span class="line">    <span class="keyword">if</span>(type action === <span class="string">'function'</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> action(dispatch)</span><br><span class="line">    &#125;</span><br><span class="line">    next(action)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; createStore, applyMiddleware &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</span><br><span class="line"><span class="keyword">import</span> RootReducer <span class="keyword">from</span> <span class="string">'./reducers/root.reducer'</span>;</span><br><span class="line"><span class="keyword">import</span> logger <span class="keyword">from</span> <span class="string">'./middlewares/logger'</span>;</span><br><span class="line"><span class="keyword">import</span> test <span class="keyword">from</span> <span class="string">'./middlewares/test'</span>;</span><br><span class="line"><span class="keyword">import</span> thunk <span class="keyword">from</span> <span class="string">'./middlewares/thunk'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> store = createStore(RootReducer,applyMiddleware(logger, test, thunk));</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// store/actions/counter.action.js</span></span><br><span class="line"><span class="keyword">import</span> &#123;INCREMENT,DECREMENT&#125; <span class="keyword">from</span> <span class="string">'../const/counter.const'</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> increment = <span class="function"><span class="params">payload</span> =&gt;</span> (&#123; <span class="attr">type</span>: INCREMENT &#125;);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> decrement = <span class="function"><span class="params">payload</span> =&gt;</span> (&#123; <span class="attr">type</span>: DECREMENT &#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> increment_async = <span class="function"><span class="params">payload</span> =&gt;</span> <span class="function"><span class="params">dispatch</span> =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        dispatch(increment(payload))</span><br><span class="line">    &#125;,<span class="number">2000</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Counter.js */</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; bindActionCreators &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> counterActions <span class="keyword">from</span> <span class="string">'../store/actions/counter.actions'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Counter</span> (<span class="params">&#123;count, increment, decrement, increment_async&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> increment_async(5)&#125;&gt;+<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;count&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> decrement(5)&#125;&gt;-<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. connect 方法会帮助我们订阅store 当store中的状态发生更改的时候 会帮助我们重新渲染组件</span></span><br><span class="line"><span class="comment">// 2. connect 方法可以让我们获取store中的状态 将状态通过组件的props属性映射给组件</span></span><br><span class="line"><span class="comment">// 3. connect 方法可以让我们获取 dispatch 方法</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapStateToProps = <span class="function"><span class="params">state</span> =&gt;</span> (&#123;</span><br><span class="line">  count: state.count</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapDispatchToProps = <span class="function"><span class="params">dispatch</span> =&gt;</span> bindActionCreators(counterActions, dispatch)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(mapStateToProps, mapDispatchToProps)(Counter);</span><br></pre></td></tr></table></figure>

<h3 id="20-Redux-thunk中间件的使用"><a href="#20-Redux-thunk中间件的使用" class="headerlink" title="20.Redux-thunk中间件的使用"></a>20.Redux-thunk中间件的使用</h3><blockquote>
<p>Redux 常用中间件</p>
</blockquote>
<ul>
<li>下载 redux-thunk  </li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install redux-thunk</span><br></pre></td></tr></table></figure>

<ul>
<li>引入 redux-thunk  </li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> thunk <span class="keyword">from</span> <span class="string">'redux-thunk'</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>注册 redux-thunk</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; applyMiddleware &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</span><br><span class="line">createStore(rootReducer, applyMiddleware(thunk));</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 redux-thunk 中间件</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> loadPosts = <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">async</span> dispatch =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> posts = <span class="keyword">await</span> axios.get(<span class="string">'./api/posts'</span>).then(response.data);</span><br><span class="line">    dispatch(&#123;<span class="attr">type</span>: LOADPOSTSSUCCESS, <span class="attr">payload</span>: posts&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="21-Redux-saga中间件的使用"><a href="#21-Redux-saga中间件的使用" class="headerlink" title="21.Redux-saga中间件的使用"></a>21.Redux-saga中间件的使用</h3><blockquote>
<p>redux-saga 解决的问题</p>
</blockquote>
<ul>
<li>redux-saga 可以将异步操作从 Action Creator 文件中抽离出来，放在一个单独的文件中</li>
</ul>
<blockquote>
<p>redux-saga 下载</p>
</blockquote>
<ul>
<li>npm install redux-saga</li>
</ul>
<blockquote>
<p>创建 redux-saga 中间件</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> createSagaMiddleware <span class="keyword">from</span> <span class="string">'redux-saga'</span>;</span><br><span class="line"><span class="keyword">const</span> sagaMiddleware = createSagaMiddleware();</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注册 sagaMiddleware</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">createStore(reducer,applyMiddleware(sagaMiddleware))</span><br></pre></td></tr></table></figure>

<blockquote>
<p>使用 saga 接收 action 执行异步操作</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; takeEvery, put &#125; <span class="keyword">from</span> <span class="string">'redux-saga/effects'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">load_posts</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; data &#125; = <span class="keyword">yield</span> axios.get(<span class="string">'/api/posts.json'</span>);</span><br><span class="line">    <span class="keyword">yield</span> put(load_posts_success(data));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span>* <span class="title">postSaga</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">yield</span> takeEvery(LOAD_POSTS, load_posts)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>启动 saga</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> postSaga <span class="keyword">from</span> <span class="string">'./store/sagas/post.saga'</span>;</span><br><span class="line">sagaMiddleware.run(postSaga);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; createStore, applyMiddleware &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</span><br><span class="line"><span class="keyword">import</span> RootReducer <span class="keyword">from</span> <span class="string">'./reduers/root.reducer'</span>;</span><br><span class="line"><span class="keyword">import</span> createSagaMiddleware <span class="keyword">from</span> <span class="string">'redux-saga'</span>;</span><br><span class="line"><span class="keyword">import</span> counterSaga <span class="keyword">from</span> <span class="string">'./sagas/counter.saga'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> sagaMiddleware = createSagaMiddleware();</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> store = createStore(RootReducer, applyMiddleware(sagaMiddleware))</span><br><span class="line"></span><br><span class="line">sagaMiddleware.run(counterSaga)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// counter.saga.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; takeEvery, put, delay &#125; <span class="keyword">from</span> <span class="string">'redux-saga/effects'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; increment &#125; <span class="keyword">from</span> <span class="string">'../actions/counter.actions'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; INCREMENT_ASYNC &#125; <span class="keyword">from</span> <span class="string">'../const/counter.const'</span>;</span><br><span class="line"><span class="comment">// takeEvery 接收 action</span></span><br><span class="line"><span class="comment">// put 触发 action</span></span><br><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">increment_async_fn</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">yield</span> delay(<span class="number">2000</span>);</span><br><span class="line">    <span class="keyword">yield</span> put(increment(<span class="number">10</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span>* <span class="title">counterSaga</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">yield</span> takeEvery(INCREMENT_ASYNC, increment_async_fn)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// counter.action.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; INCREMENT, DECREMENT, INCREMENT_ASYNC &#125; <span class="keyword">from</span> <span class="string">'../const/counter.const'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> increment = <span class="function"><span class="params">payload</span> =&gt;</span> (&#123;<span class="attr">type</span>: INCREMENT, payload&#125;);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> decrement = <span class="function"><span class="params">payload</span> =&gt;</span> (&#123;<span class="attr">type</span>: DECREMENT, payload&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> increment_async = <span class="function"><span class="params">()</span> =&gt;</span> (&#123;<span class="attr">type</span>: INCREMENT_ASYNC&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="22-Redux-saga中的action传参"><a href="#22-Redux-saga中的action传参" class="headerlink" title="22.Redux-saga中的action传参"></a>22.Redux-saga中的action传参</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// counter.action.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; INCREMENT, DECREMENT, INCREMENT_ASYNC &#125; <span class="keyword">from</span> <span class="string">'../const/counter.const'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> increment = <span class="function"><span class="params">payload</span> =&gt;</span> (&#123;<span class="attr">type</span>: INCREMENT, payload&#125;);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> decrement = <span class="function"><span class="params">payload</span> =&gt;</span> (&#123;<span class="attr">type</span>: DECREMENT, payload&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> increment_async = <span class="function"><span class="params">payload</span> =&gt;</span> (&#123;<span class="attr">type</span>: INCREMENT_ASYNC, payload&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// counter.saga.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; takeEvery, put, delay &#125; <span class="keyword">from</span> <span class="string">'redux-saga/effects'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; increment &#125; <span class="keyword">from</span> <span class="string">'../actions/counter.actions'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; INCREMENT_ASYNC &#125; <span class="keyword">from</span> <span class="string">'../const/counter.const'</span>;</span><br><span class="line"><span class="comment">// takeEvery 接收 action</span></span><br><span class="line"><span class="comment">// put 触发 action</span></span><br><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">increment_async_fn</span>(<span class="params">action</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">yield</span> delay(<span class="number">2000</span>);</span><br><span class="line">    <span class="keyword">yield</span> put(increment(action.payload))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span>* <span class="title">counterSaga</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">yield</span> takeEvery(INCREMENT_ASYNC, increment_async_fn)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="23-saga文件的拆分与合并"><a href="#23-saga文件的拆分与合并" class="headerlink" title="23.saga文件的拆分与合并"></a>23.saga文件的拆分与合并</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// root.saga.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; all &#125; <span class="keyword">from</span> <span class="string">'redux-saga/effects'</span>;</span><br><span class="line"><span class="keyword">import</span> counterSaga <span class="keyword">from</span> <span class="string">'./counter.saga'</span>;</span><br><span class="line"><span class="keyword">import</span> modalSaga <span class="keyword">from</span> <span class="string">'./modal.saga'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span>* <span class="title">rootSaga</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">yield</span> all([</span><br><span class="line">        counterSaga(),</span><br><span class="line">        modalSaga()</span><br><span class="line">    ])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="24-redux-actions中间件的使用"><a href="#24-redux-actions中间件的使用" class="headerlink" title="24.redux-actions中间件的使用"></a>24.redux-actions中间件的使用</h3><blockquote>
<p>redux-actions 解决的问题</p>
</blockquote>
<p>redux 流程中大量的样板代码读写很痛苦，使用 redux-actions 可以简化 Action 和 Reducer 的处理。</p>
<blockquote>
<p>redux-actions 下载</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install redux-actions</span><br></pre></td></tr></table></figure>
<blockquote>
<p>创建 Action</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createAction &#125; <span class="keyword">from</span> <span class="string">'redux-actions'</span>;</span><br><span class="line"><span class="keyword">const</span> increment_action = createAction(<span class="string">'increment'</span>);</span><br><span class="line"><span class="keyword">const</span> decrement_action = createAction(<span class="string">'decrement'</span>);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>创建 Reducer</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; handleActions <span class="keyword">as</span> createReducer &#125; <span class="keyword">from</span> <span class="string">'redux-actions'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; increment_action, decrement_action &#125; <span class="keyword">from</span> <span class="string">'../actions/counter.action'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> initialState = &#123; <span class="attr">count</span>: <span class="number">0</span> &#125;;</span><br><span class="line"><span class="keyword">const</span> counterReducer = createReducer(&#123;</span><br><span class="line">    [increment_action]:<span class="function">(<span class="params">state,action</span>) =&gt;</span> (&#123;<span class="attr">count</span>: state.count + <span class="number">1</span>&#125;),</span><br><span class="line">    [decrement_action]:<span class="function">(<span class="params">state,action</span>) =&gt;</span> (&#123;<span class="attr">count</span>: state.count - <span class="number">1</span>&#125;)</span><br><span class="line">&#125;,initialState);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> counterReducer;</span><br></pre></td></tr></table></figure>

<h3 id="25-shopping项目初始化"><a href="#25-shopping项目初始化" class="headerlink" title="25.shopping项目初始化"></a>25.shopping项目初始化</h3><ul>
<li>create-react-app shopping</li>
</ul>
<h3 id="26-shopping项目搭建redux工作流"><a href="#26-shopping项目搭建redux工作流" class="headerlink" title="26.shopping项目搭建redux工作流"></a>26.shopping项目搭建redux工作流</h3><ul>
<li>npm install redux react-redux redux-saga redux-actions</li>
</ul>
<h3 id="27-实现商品列表数据展示"><a href="#27-实现商品列表数据展示" class="headerlink" title="27.实现商品列表数据展示"></a>27.实现商品列表数据展示</h3><h3 id="28-将商品加入到购物车中"><a href="#28-将商品加入到购物车中" class="headerlink" title="28.将商品加入到购物车中"></a>28.将商品加入到购物车中</h3><h3 id="29-购物车列表数据展示"><a href="#29-购物车列表数据展示" class="headerlink" title="29.购物车列表数据展示"></a>29.购物车列表数据展示</h3><h3 id="30-从购物车中删除商品"><a href="#30-从购物车中删除商品" class="headerlink" title="30.从购物车中删除商品"></a>30.从购物车中删除商品</h3><h3 id="31-更改购物车中商品的数量"><a href="#31-更改购物车中商品的数量" class="headerlink" title="31.更改购物车中商品的数量"></a>31.更改购物车中商品的数量</h3><h3 id="32-更正视图图片显示错误问题"><a href="#32-更正视图图片显示错误问题" class="headerlink" title="32.更正视图图片显示错误问题"></a>32.更正视图图片显示错误问题</h3><h3 id="33-计算商品总价"><a href="#33-计算商品总价" class="headerlink" title="33.计算商品总价"></a>33.计算商品总价</h3><h3 id="34-Redux源码实现：核心逻辑"><a href="#34-Redux源码实现：核心逻辑" class="headerlink" title="34.Redux源码实现：核心逻辑"></a>34.Redux源码实现：核心逻辑</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// myRedux.js</span></span><br><span class="line"><span class="comment">/* createStore(reducer, preloadedState, enhancer)</span></span><br><span class="line"><span class="comment">&#123; getState, dispatch, subscribe &#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createStore</span>(<span class="params">reducer,preloadedState</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// store 对象中存储的状态</span></span><br><span class="line">    <span class="keyword">var</span> currentState = preloadedState;</span><br><span class="line">    <span class="comment">// 存放订阅者函数</span></span><br><span class="line">    <span class="keyword">var</span> currentListeners = [];</span><br><span class="line">    <span class="comment">// 获取状态</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getState</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> currentState;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 触发 action</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params">action</span>) </span>&#123;</span><br><span class="line">        currentState = reducer(currentState, action);</span><br><span class="line">        <span class="comment">// 循环数组 调用订阅者</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; currentListeners.length; i++) &#123;</span><br><span class="line">            <span class="comment">// 获取订阅者</span></span><br><span class="line">            <span class="keyword">var</span> listener = currentListeners[i];</span><br><span class="line">            listener();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 订阅状态</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">subscribe</span>(<span class="params">listener</span>)</span>&#123;</span><br><span class="line">        currentListeners.push(listener);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        getState,</span><br><span class="line">        dispatch,</span><br><span class="line">        subscribe</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="35-Redux源码实现：参数类型约束"><a href="#35-Redux源码实现：参数类型约束" class="headerlink" title="35.Redux源码实现：参数类型约束"></a>35.Redux源码实现：参数类型约束</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// myRedux.js</span></span><br><span class="line"><span class="comment">/* createStore(reducer, preloadedState, enhancer)</span></span><br><span class="line"><span class="comment">&#123; getState, dispatch, subscribe &#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createStore</span>(<span class="params">reducer,preloadedState</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 约束 reducer 参数类型</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> reducer !== <span class="string">'function'</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'reducer必须是函数'</span>);</span><br><span class="line">    <span class="comment">// store 对象中存储的状态</span></span><br><span class="line">    <span class="keyword">var</span> currentState = preloadedState;</span><br><span class="line">    <span class="comment">// 存放订阅者函数</span></span><br><span class="line">    <span class="keyword">var</span> currentListeners = [];</span><br><span class="line">    <span class="comment">// 获取状态</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getState</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> currentState;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 触发 action</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params">action</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 判断 action 是否是对象</span></span><br><span class="line">        <span class="keyword">if</span>(!isPlainObject(action)) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'action必须是对象'</span>);</span><br><span class="line">        <span class="comment">// 判断对象中是否具有 type 属性</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">typeof</span> action.type === <span class="string">'undefined'</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'action对象中必须要有type属性'</span>)</span><br><span class="line">        currentState = reducer(currentState, action);</span><br><span class="line">        <span class="comment">// 循环数组 调用订阅者</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; currentListeners.length; i++) &#123;</span><br><span class="line">            <span class="comment">// 获取订阅者</span></span><br><span class="line">            <span class="keyword">var</span> listener = currentListeners[i];</span><br><span class="line">            listener();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 订阅状态</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">subscribe</span>(<span class="params">listener</span>)</span>&#123;</span><br><span class="line">        currentListeners.push(listener);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        getState,</span><br><span class="line">        dispatch,</span><br><span class="line">        subscribe</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断obj参数是否是对象</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isPlainObject</span>(<span class="params">obj</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 排除基本数据类型和null</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> obj !==<span class="string">'object'</span> || obj === <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// 区分数组和对象 原型对象对比的方式</span></span><br><span class="line">    <span class="keyword">var</span> proto = obj;</span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">Object</span>.getPrototypeOf(proto)!==<span class="literal">null</span>)&#123;</span><br><span class="line">        proto = <span class="built_in">Object</span>.getPrototypeOf(proto)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Object</span>.getPrototypeOf(obj) === proto</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="36-Redux源码实现：Enhancer"><a href="#36-Redux源码实现：Enhancer" class="headerlink" title="36.Redux源码实现：Enhancer"></a>36.Redux源码实现：Enhancer</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// myRedux.js</span></span><br><span class="line"><span class="comment">/* createStore(reducer, preloadedState, enhancer)</span></span><br><span class="line"><span class="comment">&#123; getState, dispatch, subscribe &#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createStore</span>(<span class="params">reducer,preloadedState,enhancer</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 约束 reducer 参数类型</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> reducer !== <span class="string">'function'</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'reducer必须是函数'</span>);</span><br><span class="line">    <span class="comment">// 判断 enhancer 参数有没有传递</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> enhancer !== <span class="string">'undifined'</span>) &#123;</span><br><span class="line">    <span class="comment">// 判断 enhancer 是不是一个函数</span></span><br><span class="line">      <span class="keyword">if</span>(<span class="keyword">typeof</span> enhancer !== <span class="string">'function'</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'enhancer 必须是函数'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> enhancer(createStore)(reducer,preloadedState)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// store 对象中存储的状态</span></span><br><span class="line">    <span class="keyword">var</span> currentState = preloadedState;</span><br><span class="line">    <span class="comment">// 存放订阅者函数</span></span><br><span class="line">    <span class="keyword">var</span> currentListeners = [];</span><br><span class="line">    <span class="comment">// 获取状态</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getState</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> currentState;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 触发 action</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params">action</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 判断 action 是否是对象</span></span><br><span class="line">        <span class="keyword">if</span>(!isPlainObject(action)) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'action必须是对象'</span>);</span><br><span class="line">        <span class="comment">// 判断对象中是否具有 type 属性</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">typeof</span> action.type === <span class="string">'undefined'</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'action对象中必须要有type属性'</span>)</span><br><span class="line">        currentState = reducer(currentState, action);</span><br><span class="line">        <span class="comment">// 循环数组 调用订阅者</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; currentListeners.length; i++) &#123;</span><br><span class="line">            <span class="comment">// 获取订阅者</span></span><br><span class="line">            <span class="keyword">var</span> listener = currentListeners[i];</span><br><span class="line">            listener();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 订阅状态</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">subscribe</span>(<span class="params">listener</span>)</span>&#123;</span><br><span class="line">        currentListeners.push(listener);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        getState,</span><br><span class="line">        dispatch,</span><br><span class="line">        subscribe</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断obj参数是否是对象</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isPlainObject</span>(<span class="params">obj</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 排除基本数据类型和null</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> obj !==<span class="string">'object'</span> || obj === <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// 区分数组和对象 原型对象对比的方式</span></span><br><span class="line">    <span class="keyword">var</span> proto = obj;</span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">Object</span>.getPrototypeOf(proto)!==<span class="literal">null</span>)&#123;</span><br><span class="line">        proto = <span class="built_in">Object</span>.getPrototypeOf(proto)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Object</span>.getPrototypeOf(obj) === proto</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="37-Redux源码实现：applyMiddleware"><a href="#37-Redux源码实现：applyMiddleware" class="headerlink" title="37.Redux源码实现：applyMiddleware"></a>37.Redux源码实现：applyMiddleware</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">applyMiddleware</span>(<span class="params">...middlewares</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">createStore</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">reducer,preloadedState</span>)</span>&#123;</span><br><span class="line">      <span class="comment">// 创建 store</span></span><br><span class="line">      <span class="keyword">var</span> store = createStore(reducer, preloadedState) &#123;</span><br><span class="line">        <span class="comment">// 阉割版的 store</span></span><br><span class="line">      <span class="keyword">var</span> middlewareAPI = &#123;</span><br><span class="line">          getSttate: store.getState,</span><br><span class="line">          dispatch: store.dispatch</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 调用中间件的第一层函数 产地阉割版的 store 对象</span></span><br><span class="line">        <span class="keyword">var</span> chain = middlewares.map(<span class="function"><span class="params">middleware</span> =&gt;</span> middleware(middlewareAPI))</span><br><span class="line">        <span class="keyword">var</span> dispatch = compose(...chain)(store.dispatch)</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">          ...store,</span><br><span class="line">          dispatch</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compose</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> funcs = [...arguments];</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">dispatch</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = funcs.length <span class="number">-1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">      dispatch = funcs[i](dispatch)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dispatch</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="38-Redux源码实现：bindActionCreators"><a href="#38-Redux源码实现：bindActionCreators" class="headerlink" title="38.Redux源码实现：bindActionCreators"></a>38.Redux源码实现：bindActionCreators</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bindActionCreators</span>(<span class="params">actionCreators, dispatch</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> boundActionCreators = &#123;&#125;;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> key <span class="keyword">in</span> actionCreators) &#123;</span><br><span class="line">    (<span class="function"><span class="keyword">function</span> (<span class="params">key</span>)</span>&#123;</span><br><span class="line">      boundActionCreators[key] = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        dispatch(actionCreators[key]())</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)(key)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="39-Redux源码实现：combineReducers"><a href="#39-Redux源码实现：combineReducers" class="headerlink" title="39.Redux源码实现：combineReducers"></a>39.Redux源码实现：combineReducers</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">combineReducers</span>(<span class="params">reducers</span>)</span>&#123;</span><br><span class="line">  <span class="comment">// 1.检查 reducer 类型 它必须是函数</span></span><br><span class="line">  <span class="keyword">var</span> reducerKeys = <span class="built_in">Object</span>.key(reducers);</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>;i&lt;reducerKeys.length;i++)&#123;</span><br><span class="line">    <span class="keyword">var</span> key = reducerKeys[i];</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> reducers[key] !== <span class="string">'function'</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">''</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 2.调用一个一个的小的 reducer 将每一个小的 reducer 中返回的状态存储在一个新的大的对象中</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">state,action</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> nextState = &#123;&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; reduceKeys.length; i++) &#123;</span><br><span class="line">      <span class="keyword">var</span> key = reduceKeys[i];</span><br><span class="line">      <span class="keyword">var</span> reducer = reducers[key];</span><br><span class="line">      <span class="keyword">var</span> previousStateForKey = state[key];</span><br><span class="line">      nextState[key] = reducer(previousStateForKey, action)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> nextState</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="任务二：MobX"><a href="#任务二：MobX" class="headerlink" title="任务二：MobX"></a>任务二：MobX</h2><h3 id="1-【课程资料】课程资料"><a href="#1-【课程资料】课程资料" class="headerlink" title="1.【课程资料】课程资料"></a>1.【课程资料】课程资料</h3><h3 id="2-MobX专题内容介绍"><a href="#2-MobX专题内容介绍" class="headerlink" title="2.MobX专题内容介绍"></a>2.MobX专题内容介绍</h3><ul>
<li>MobX 简介</li>
<li>开发前的准备</li>
<li>MobX + React</li>
<li>MobX 异步</li>
<li>MobX 数据监测</li>
<li>综合案例</li>
</ul>
<h3 id="3-MobX简介"><a href="#3-MobX简介" class="headerlink" title="3.MobX简介"></a>3.MobX简介</h3><blockquote>
<p>MobX 介绍</p>
</blockquote>
<ul>
<li>简单、可扩展的状态管理库</li>
<li>MobX 是由 Mendix，Coinbasa。Facebook 开源和众多个人赞助商所赞助的</li>
<li>React 和 MobX 是一对强力组合，React 负责渲染应用的状态，MobX 负责管理应用状态供 React 使用</li>
</ul>
<blockquote>
<p>MobX 浏览器支持</p>
</blockquote>
<ul>
<li>MobX 5 版本运行在任何支持 ES6 proxy 的浏览器，不支持 IE11，Node.js 6</li>
<li>MobX 4 可以运行在任何支持 ES5 的浏览器上</li>
<li>MobX 4 和 5 的 API 是相同的</li>
</ul>
<h3 id="4-开发前的准备工作"><a href="#4-开发前的准备工作" class="headerlink" title="4.开发前的准备工作"></a>4.开发前的准备工作</h3><blockquote>
<p>启用装饰器语法支持（方式一）</p>
</blockquote>
<ul>
<li>1.弹射项目底层配置：npm run eject</li>
<li>2.下载装饰器语法 babel 插件：npm install @babel/plugin-proposal-decorators</li>
<li>3.在 pacakage.json 文件中加入配置</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"babel"</span>: &#123;</span><br><span class="line">    <span class="string">"plugins"</span>: [</span><br><span class="line">        [</span><br><span class="line">            <span class="string">"@babel/plugin-roposal-decorators"</span>,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"legacy"</span>: <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>启用装饰器语法支持（方式二）</p>
</blockquote>
<ul>
<li><ol>
<li>npm install react-app-rewired customize-cra @babel/plugin-proposal-decorators</li>
</ol>
</li>
<li>2.在项目根目录下创建 config-overrides.js 并加入配置</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; override, assDecoratorsLegacy &#125; = <span class="built_in">require</span>(<span class="string">"customize-cra"</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = override(addDecoratorsLegacy());</span><br></pre></td></tr></table></figure>
<blockquote>
<p>解决 vscode 编辑器关于装饰器语法的警告</p>
</blockquote>
<ul>
<li>修改配置：”javascript.implivitProjectConfig.experimentalDecorators”:true</li>
</ul>
<h3 id="5-mobx使用-一"><a href="#5-mobx使用-一" class="headerlink" title="5.mobx使用(一)"></a>5.mobx使用(一)</h3><blockquote>
<p>下载 MboX</p>
</blockquote>
<ul>
<li>npm install mobx mobx-react</li>
</ul>
<blockquote>
<p>MobX 工作流程</p>
</blockquote>
<ul>
<li>Action =&gt; state =&gt; views</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/stores/counterStore.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.创建 store 对象 存储默认状态</span></span><br><span class="line"><span class="comment">// 2.将 store 对象放在一个全局的 组件可以够得到的地方</span></span><br><span class="line"><span class="comment">// 3.让组件获取 store 对象中的状态 并将状态显示在组件中</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CounterStore</span> </span>&#123;</span><br><span class="line">    count = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> counter = <span class="keyword">new</span> CounterStore();</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> counter;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// App.js</span></span><br><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; inject &#125; <span class="keyword">from</span> <span class="string">'mobx-react'</span>;</span><br><span class="line"></span><br><span class="line">@inject(<span class="string">'counter'</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; counter &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">        <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;counter.count&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> App;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Provider &#125; <span class="keyword">from</span> <span class="string">'mobx-react'</span>;</span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./App'</span>;</span><br><span class="line"><span class="keyword">import</span> counter <span class="keyword">from</span> <span class="string">'./stores/counterStore'</span>;</span><br><span class="line"></span><br><span class="line">ReactDOM.render(</span><br><span class="line">    &lt;Provider counter = &#123;counter&#125;&gt;<span class="xml"><span class="tag">&lt;<span class="name">App</span>/&gt;</span></span>&lt;<span class="regexp">/Provider&gt;,</span></span><br><span class="line"><span class="regexp">    document.getElementById('root')</span></span><br><span class="line"><span class="regexp">);</span></span><br></pre></td></tr></table></figure>
<h3 id="6-mobx使用-二"><a href="#6-mobx使用-二" class="headerlink" title="6.mobx使用(二)"></a>6.mobx使用(二)</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// App.js</span></span><br><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; inject, observer &#125; <span class="keyword">from</span> <span class="string">'mobx-react'</span>;</span><br><span class="line"></span><br><span class="line">@inject(<span class="string">'counter'</span>)</span><br><span class="line">@observer</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; counter &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">        <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;counter.increment&#125;</span>&gt;</span>+<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;counter.count&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;counter.decrement&#125;</span>&gt;</span>_<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> App;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/stores/counterStore.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.创建 store 对象 存储默认状态</span></span><br><span class="line"><span class="comment">// 2.将 store 对象放在一个全局的 组件可以够得到的地方</span></span><br><span class="line"><span class="comment">// 3.让组件获取 store 对象中的状态 并将状态显示在组件中</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; observable &#125; <span class="keyword">from</span> <span class="string">'mobx'</span> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CounterStore</span> </span>&#123;</span><br><span class="line">    @observable count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    increment = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.count = <span class="keyword">this</span>.count + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    decrement = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.count = <span class="keyword">this</span>.count - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> counter = <span class="keyword">new</span> CounterStore();</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> counter;</span><br></pre></td></tr></table></figure>

<h3 id="7-更正类中的普通函数的this指向"><a href="#7-更正类中的普通函数的this指向" class="headerlink" title="7.更正类中的普通函数的this指向"></a>7.更正类中的普通函数的this指向</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/stores/counterStore.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.创建 store 对象 存储默认状态</span></span><br><span class="line"><span class="comment">// 2.将 store 对象放在一个全局的 组件可以够得到的地方</span></span><br><span class="line"><span class="comment">// 3.让组件获取 store 对象中的状态 并将状态显示在组件中</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; observable, configure, action &#125; <span class="keyword">from</span> <span class="string">'mobx'</span> </span><br><span class="line">configure(&#123;<span class="attr">enforceActions</span>: <span class="string">'observed'</span>&#125;);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CounterStore</span> </span>&#123;</span><br><span class="line">    @observable count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    @action.bound increment() &#123;</span><br><span class="line">        <span class="keyword">this</span>.count = <span class="keyword">this</span>.count + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @action.bound decrement() &#123;</span><br><span class="line">        <span class="keyword">this</span>.count = <span class="keyword">this</span>.count - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> counter = <span class="keyword">new</span> CounterStore();</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> counter;</span><br></pre></td></tr></table></figure>

<h3 id="8-异步更新状态方式一"><a href="#8-异步更新状态方式一" class="headerlink" title="8.异步更新状态方式一"></a>8.异步更新状态方式一</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/stores/counterStore.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.创建 store 对象 存储默认状态</span></span><br><span class="line"><span class="comment">// 2.将 store 对象放在一个全局的 组件可以够得到的地方</span></span><br><span class="line"><span class="comment">// 3.让组件获取 store 对象中的状态 并将状态显示在组件中</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; observable, configure, action, runInAction &#125; <span class="keyword">from</span> <span class="string">'mobx'</span> </span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">'axios'</span></span><br><span class="line"></span><br><span class="line">configure(&#123;<span class="attr">enforceActions</span>: <span class="string">'observed'</span>&#125;);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CounterStore</span> </span>&#123;</span><br><span class="line">    @observable count = <span class="number">0</span>;</span><br><span class="line">    @observable users = [];</span><br><span class="line"></span><br><span class="line">    @action.bound increment() &#123;</span><br><span class="line">        <span class="keyword">this</span>.count = <span class="keyword">this</span>.count + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @action.bound decrement() &#123;</span><br><span class="line">        <span class="keyword">this</span>.count = <span class="keyword">this</span>.count - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @action.bound <span class="keyword">async</span> getDada() &#123;</span><br><span class="line">      <span class="keyword">let</span> &#123; data &#125; = <span class="keyword">await</span> axios.get(<span class="string">'https://api.github.com/users'</span>)</span><br><span class="line">      runInAction(<span class="function"><span class="params">()</span>=&gt;</span><span class="keyword">this</span>.users = data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> counter = <span class="keyword">new</span> CounterStore();</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> counter;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// App.js</span></span><br><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; inject, observer &#125; <span class="keyword">from</span> <span class="string">'mobx-react'</span>;</span><br><span class="line"></span><br><span class="line">@inject(<span class="string">'counter'</span>)</span><br><span class="line">@observer</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    componentDidMount() &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; getData &#125; = <span class="keyword">this</span>.props.counter;</span><br><span class="line">        getData()</span><br><span class="line">    &#125;</span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; counter &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">        <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;counter.increment&#125;</span>&gt;</span>+<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;counter.count&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;counter.decrement&#125;</span>&gt;</span>_<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">          &lt;div&gt;</span><br><span class="line">          &#123;counter.users.map(user =&gt;(</span><br><span class="line">              &lt;div&gt;</span><br><span class="line">                &lt;span&gt;&#123;user.id&#125;&lt;/span&gt;</span><br><span class="line">                &lt;span&gt;&#123;user.login&#125;&lt;/span&gt;</span><br><span class="line">              &lt;/div&gt;</span><br><span class="line">          ))&#125;</span><br><span class="line"><span class="xml">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> App;</span><br></pre></td></tr></table></figure>
<h3 id="9-异步更新状态方式二"><a href="#9-异步更新状态方式二" class="headerlink" title="9.异步更新状态方式二"></a>9.异步更新状态方式二</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/stores/counterStore.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.创建 store 对象 存储默认状态</span></span><br><span class="line"><span class="comment">// 2.将 store 对象放在一个全局的 组件可以够得到的地方</span></span><br><span class="line"><span class="comment">// 3.让组件获取 store 对象中的状态 并将状态显示在组件中</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; observable, configure, action, runInAction, flow &#125; <span class="keyword">from</span> <span class="string">'mobx'</span> </span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">'axios'</span></span><br><span class="line"><span class="comment">// 通过配置强制程序使用action函数更改应用程序中的状态</span></span><br><span class="line">configure(&#123;<span class="attr">enforceActions</span>: <span class="string">'observed'</span>&#125;);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CounterStore</span> </span>&#123;</span><br><span class="line">    @observable count = <span class="number">0</span>;</span><br><span class="line">    @observable users = [];</span><br><span class="line"></span><br><span class="line">    @action.bound increment() &#123;</span><br><span class="line">        <span class="keyword">this</span>.count = <span class="keyword">this</span>.count + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @action.bound decrement() &#123;</span><br><span class="line">        <span class="keyword">this</span>.count = <span class="keyword">this</span>.count - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @action.bound async getDada() &#123;</span></span><br><span class="line">    <span class="comment">//   let &#123; data &#125; = await axios.get('https://api.github.com/users')</span></span><br><span class="line">    <span class="comment">//   runInAction(()=&gt;this.users = data);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    getData = flow(<span class="function"><span class="keyword">function</span>*(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> &#123; data &#125; = <span class="keyword">yield</span> axios.get(<span class="string">'https://api.github.com/users'</span>)</span><br><span class="line">        <span class="keyword">this</span>.users = data</span><br><span class="line">    &#125;).bind(<span class="keyword">this</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> counter = <span class="keyword">new</span> CounterStore();</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> counter;</span><br></pre></td></tr></table></figure>
<h3 id="10-数据监测computed"><a href="#10-数据监测computed" class="headerlink" title="10.数据监测computed"></a>10.数据监测computed</h3><blockquote>
<p>什么是计算值</p>
</blockquote>
<ul>
<li>计算值是可以根据现有的状态或其它计算值衍生出的值</li>
</ul>
<blockquote>
<p>什么时候使用计算值</p>
</blockquote>
<ul>
<li>将复杂的业务逻辑从模板中进行抽离</li>
</ul>
<blockquote>
<p>计算值示例</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; observable, action, computed &#125; <span class="keyword">from</span> <span class="string">'mobx'</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BirdStore</span> </span>&#123;</span><br><span class="line">    @observable count = <span class="number">10</span>;</span><br><span class="line">    @observable price = <span class="number">25</span>;</span><br><span class="line"></span><br><span class="line">    @computed <span class="keyword">get</span> totalPrice() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.count * <span class="keyword">this</span>.price;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="11-禁止普通函数更改程序状态并引入action装饰器"><a href="#11-禁止普通函数更改程序状态并引入action装饰器" class="headerlink" title="11.禁止普通函数更改程序状态并引入action装饰器"></a>11.禁止普通函数更改程序状态并引入action装饰器</h3><p>见 9</p>
<h3 id="12-数据监测autorun"><a href="#12-数据监测autorun" class="headerlink" title="12.数据监测autorun"></a>12.数据监测autorun</h3><blockquote>
<p>autorun 方法</p>
</blockquote>
<p>当监测的状态发生变化时，你想根据状态产生“效果”，请使用 autorun。<br>autorun 会在初始化的时候执行一次，会在每次状态发生变化时执行。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">autorun(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> response = <span class="keyword">await</span> uniqueUsername(<span class="keyword">this</span>.username);</span><br><span class="line">&#125;,&#123;<span class="attr">delay</span>:<span class="number">1500</span>&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="13-todo案例构建项目组件"><a href="#13-todo案例构建项目组件" class="headerlink" title="13.todo案例构建项目组件"></a>13.todo案例构建项目组件</h3><h3 id="14-构建mobx工作流"><a href="#14-构建mobx工作流" class="headerlink" title="14.构建mobx工作流"></a>14.构建mobx工作流</h3><h3 id="15-实现添加任务功能"><a href="#15-实现添加任务功能" class="headerlink" title="15.实现添加任务功能"></a>15.实现添加任务功能</h3><h3 id="16-实现任务列表数据展示功能"><a href="#16-实现任务列表数据展示功能" class="headerlink" title="16.实现任务列表数据展示功能"></a>16.实现任务列表数据展示功能</h3><h3 id="17-实现任务删除功能"><a href="#17-实现任务删除功能" class="headerlink" title="17.实现任务删除功能"></a>17.实现任务删除功能</h3><h3 id="18-更改任务的是否完成状态"><a href="#18-更改任务的是否完成状态" class="headerlink" title="18.更改任务的是否完成状态"></a>18.更改任务的是否完成状态</h3><h3 id="19-计算未完成任务的数量"><a href="#19-计算未完成任务的数量" class="headerlink" title="19.计算未完成任务的数量"></a>19.计算未完成任务的数量</h3><h3 id="20-实现任务筛选功能"><a href="#20-实现任务筛选功能" class="headerlink" title="20.实现任务筛选功能"></a>20.实现任务筛选功能</h3>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/02/22/37/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="FY">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="旋の飞羽">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/02/22/37/" itemprop="url">nrm报错 [ERR_INVALID_ARG_TYPE] 解决方法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-02-22T00:00:00+08:00">
                2021-02-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index">
                    <span itemprop="name">前端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>作者：FY<br>引用请标明出处</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[TypeError [ERR_INVALID_ARG_TYPE]: The "path" argument must be of type string. Received undefined</span><br><span class="line">  at validateString (internal/validators.js:122:11)</span><br><span class="line">  at Object.join (path.js:375:7)</span><br><span class="line">  at Object.&lt;anonymous&gt; (C:\Users\liyin\AppData\Roaming\npm\node_modules\nrm\cli.js:17:20)</span><br><span class="line">  at Module._compile (internal/modules/cjs/loader.js:1076:30)</span><br><span class="line">  at Object.Module._extensions..js (internal/modules/cjs/loader.js:1097:10)</span><br><span class="line">  at Module.load (internal/modules/cjs/loader.js:941:32)</span><br><span class="line">  at Function.Module._load (internal/modules/cjs/loader.js:782:14)</span><br><span class="line">  at Function.executeUserEntryPoint [as runMain] (internal/modules/run_main.js:72:12)</span><br><span class="line">  at internal/main/run_main_module.js:17:47</span><br><span class="line">] &#123;</span><br><span class="line">  code: 'ERR_INVALID_ARG_TYPE'</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>找到nrm目录</p>
<p>C:\Users\liyin\AppData\Roaming\npm\node_modules\nrm\cli.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//const NRMRC = path.join(process.env.HOME, '.nrmrc'); (删除)</span></span><br><span class="line"><span class="keyword">const</span> NRMRC = path.join(process.env[(process.platform == <span class="string">'win32'</span>) ? <span class="string">'USERPROFILE'</span> : <span class="string">'HOME'</span>], <span class="string">'.nrmrc'</span>);</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/02/22/38/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="FY">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="旋の飞羽">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/02/22/38/" itemprop="url">学习笔记 ----- 【React 框架原理与实战】React 设计原理解密及核心源码解读</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-02-22T00:00:00+08:00">
                2021-02-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index">
                    <span itemprop="name">前端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>作者：FY<br>引用请标明出处</p>
</blockquote>
<h1 id="Part-4-·-React-框架原理与实战"><a href="#Part-4-·-React-框架原理与实战" class="headerlink" title="Part 4 · React 框架原理与实战"></a>Part 4 · React 框架原理与实战</h1><h2 id="模块一-·-React-设计原理解密及核心源码解读"><a href="#模块一-·-React-设计原理解密及核心源码解读" class="headerlink" title="模块一 · React 设计原理解密及核心源码解读"></a>模块一 · React 设计原理解密及核心源码解读</h2><h2 id="任务一：React-基础回顾"><a href="#任务一：React-基础回顾" class="headerlink" title="任务一：React 基础回顾"></a>任务一：React 基础回顾</h2><h3 id="1-React-介绍"><a href="#1-React-介绍" class="headerlink" title="1.React 介绍"></a>1.React 介绍</h3><ul>
<li>React 是一个用于构建用户界面的 Javascript 库，它只负责应用的视图层，帮助开发人员构架快速且交互式的 web 应用程序。React 使用组件的方式构建用户界面。</li>
</ul>
<h3 id="2-JSX-语法回顾-一"><a href="#2-JSX-语法回顾-一" class="headerlink" title="2.JSX 语法回顾(一)"></a>2.JSX 语法回顾(一)</h3><blockquote>
<p>JSX 语法</p>
</blockquote>
<ul>
<li>在 React 中使用JSX 语法描述用户界面，它是一种 JavaScript 语法扩展。</li>
<li>在 React 代码执行之前，Babel 会将 JSX 语法转换为标准的 JavaScript API。</li>
<li>JSX 语法就是一种语法糖，让开发人员使用更加舒服的代码构建用户界面。</li>
</ul>
<blockquote>
<p>在 JSX 中使用表达式</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> user = &#123;</span><br><span class="line">    firstName: <span class="string">'Harper'</span>,</span><br><span class="line">    lastName: <span class="string">'Perez'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">formatName</span>(<span class="params">user</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> user.firstName + <span class="string">' '</span> + user.lastName;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> element = <span class="xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello,&#123;formatName(user)&#125;!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>;</span><br></pre></td></tr></table></figure>

<p>JSX 本身其实也是一种表达式，将它赋值给变量，当做参数传入，作为返回值都可以。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getGreeting</span>(<span class="params">user</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(user) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello,&#123;formatName(user)&#125;!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello,Stranger.<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>属性</p>
</blockquote>
<p>如果属性值为 JavaScript 表达式，需要加引号，属性名称推荐采用驼峰式命名法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> element = <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">greeting</span>=<span class="string">"hello"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>如果属性值为 JavaScript 表达式，属性值外面加大括号。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> element = <span class="xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#123;user.avatarUrl&#125;/</span>&gt;</span></span></span><br><span class="line"><span class="comment">// 注意大括号外面不能加引号，JSX 会将引号中的内容识别为字符串而不是表达式</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>JSX 单标记必须闭合</p>
</blockquote>
<p>如果是 JSX 是单标记，必须闭合，否则报错。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> element = <span class="xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#123;user.avatarUrl&#125;/</span>&gt;</span></span></span><br><span class="line"><span class="keyword">const</span> element = <span class="xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span>/&gt;</span></span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>className</p>
</blockquote>
<p>为 JSX 标记添加类名需要使用 className，而不是 class</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> element = <span class="xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#123;user.avatarUrl&#125;</span> <span class="attr">className</span>=<span class="string">"rounded"</span>/&gt;</span></span>;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>JSX 自动展开数组</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">const ary &#x3D; [&lt;p&gt;哈哈&lt;&#x2F;p&gt;, &lt;p&gt;呵呵&lt;&#x2F;p&gt;, &lt;p&gt;嘿嘿&lt;&#x2F;p&gt;];</span><br><span class="line">const element &#x3D; (</span><br><span class="line">	&lt;div&gt;&#123;ary&#125;&lt;&#x2F;div&gt;</span><br><span class="line">);</span><br><span class="line">&#x2F;&#x2F; 解析后</span><br><span class="line">&#x2F;*</span><br><span class="line">	&lt;div&gt;</span><br><span class="line">		&lt;p&gt;哈哈&lt;&#x2F;p&gt;</span><br><span class="line">		&lt;p&gt;呵呵&lt;&#x2F;p&gt;</span><br><span class="line">		&lt;p&gt;嘿嘿&lt;&#x2F;p&gt;</span><br><span class="line">	&lt;&#x2F;div&gt;</span><br><span class="line">*&#x2F;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>三元运算</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123; boolean ? &lt;div&gt;Hello React&lt;&#x2F;div&gt; : null &#125;</span><br><span class="line">&#123; boolean &amp;&amp; &lt;div&gt;Hello React&lt;&#x2F;div&gt; &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>循环</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">const persons &#x3D; [&#123;</span><br><span class="line">  id: 1,</span><br><span class="line">  name: &#39;张三&#39;,</span><br><span class="line">  age: 20</span><br><span class="line">&#125;, &#123;</span><br><span class="line">  id: 2,</span><br><span class="line">  name: &#39;李四&#39;,</span><br><span class="line">  age: 15</span><br><span class="line">&#125;, &#123;</span><br><span class="line">  id: 3,</span><br><span class="line">  name: &#39;王五&#39;,</span><br><span class="line">  age: 22</span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;ul&gt;</span><br><span class="line">  &#123; persons.map(person &#x3D;&gt; &lt;li key&#x3D;&#123;person.id&#125;&gt; &#123;person.name&#125; &#123;person.age&#125; &lt;&#x2F;li&gt;) &#125;</span><br><span class="line">&lt;&#x2F;ul&gt;</span><br></pre></td></tr></table></figure>

<h3 id="3-JSX-语法回顾-二"><a href="#3-JSX-语法回顾-二" class="headerlink" title="3.JSX 语法回顾(二)"></a>3.JSX 语法回顾(二)</h3><blockquote>
<p>事件</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#x2F;* 第一个参数即是事件对象 不需传递 *&#x2F;&#125;</span><br><span class="line">&lt;button onClick&#x3D;&#123;this.eventHandler&#125;&gt;按钮&lt;&#x2F;button&gt;</span><br><span class="line">&#123;&#x2F;* 需要传递事件对象 *&#x2F;&#125;</span><br><span class="line">&lt;button onClick&#x3D;&#123;e&#x3D;&gt;this.eventHandler(&#39;arg&#39;,e)&#125;&gt;按钮&lt;&#x2F;button&gt;</span><br><span class="line">&#123;&#x2F;* 最后一个参数即是事件对象 不需传递 *&#x2F;&#125;</span><br><span class="line">&lt;button onClick&#x3D;&#123;this.eventHandler.bind(null, &#39;arg&#39;)&#125;&gt;按钮&lt;&#x2F;button&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">constructor () &#123;</span><br><span class="line">  this.eventHandler &#x3D; this.eventHandler.bind(this)</span><br><span class="line">&#125;</span><br><span class="line">eventHandler () &#123;&#125;</span><br><span class="line">&lt;button onClick&#x3D;&#123;this.eventHandler&#125;&gt;按钮&lt;&#x2F;button&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>样式</p>
</blockquote>
<ul>
<li>行内样式</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class App extends Component &#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    const style &#x3D; &#123;width: 200, height: 200, backgroundColor: &#39;red&#39;&#125;;</span><br><span class="line">    return &lt;div style&#x3D;&#123;style&#125;&gt;&lt;&#x2F;div&gt;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>外链样式</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Button.js</span><br><span class="line">import styles from &#39;.&#x2F;Button.module.css&#39;;</span><br><span class="line">class Button extends Component &#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    return &lt;button className&#x3D;&#123;styles.error&#125;&gt;Error Button&lt;&#x2F;button&gt;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>全局样式</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import &#39;.&#x2F;styles.css&#39;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ref 属性</p>
</blockquote>
<ul>
<li>createRef</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">class Input extends Component &#123;</span><br><span class="line">  constructor() &#123;</span><br><span class="line">    super()</span><br><span class="line">    this.inputRef &#x3D; React.createRef()</span><br><span class="line">  &#125;</span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;input type&#x3D;&quot;text&quot; ref&#x3D;&#123;this.inputRef&#125; &#x2F;&gt;</span><br><span class="line">        &lt;button onClick&#x3D;&#123;() &#x3D;&gt; console.log(this.inputRef.current)&#125;&gt; button &lt;&#x2F;button&gt;</span><br><span class="line">      &lt;&#x2F;div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>函数参数</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">class Input extends Component &#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;input type&#x3D;&quot;text&quot; ref&#x3D;&#123;input &#x3D;&gt; (this.input &#x3D; input)&#125; &#x2F;&gt;</span><br><span class="line">        &lt;button onClick&#x3D;&#123;() &#x3D;&gt; console.log(this.input)&#125;&gt;button&lt;&#x2F;button&gt;</span><br><span class="line">      &lt;&#x2F;div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ref 字符串</li>
</ul>
<p>不推荐使用，在严格模式下报错。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">class Input extends Component &#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;input type&#x3D;&quot;text&quot; ref&#x3D;&quot;username&quot; &#x2F;&gt;</span><br><span class="line">        &lt;button onClick&#x3D;&#123;() &#x3D;&gt; console.log(this.refs.username)&#125;&gt;button&lt;&#x2F;button&gt;</span><br><span class="line">      &lt;&#x2F;div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>获取组件实例</p>
</blockquote>
<p>点击按钮让 input 文本框获取焦点。</p>
<p>input 文本框以及让文本框获取焦点的方法定义在 Input 组件中，在 App 组件中引入 Input 组件，按钮定义在 App 组件中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Input.js</span><br><span class="line">class Input extends Component &#123;</span><br><span class="line">  constructor() &#123;</span><br><span class="line">    super()</span><br><span class="line">    this.inputRef &#x3D; React.createRef()</span><br><span class="line">    this.focusInput &#x3D; this.focusInput.bind(this)</span><br><span class="line">  &#125;</span><br><span class="line">  focusInput() &#123;</span><br><span class="line">    this.inputRef.current.focus()</span><br><span class="line">  &#125;</span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;input type&#x3D;&quot;text&quot; ref&#x3D;&#123;this.inputRef&#125; &#x2F;&gt;</span><br><span class="line">      &lt;&#x2F;div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; App.js</span><br><span class="line">class App extends Component &#123;</span><br><span class="line">  constructor() &#123;</span><br><span class="line">    super()</span><br><span class="line">    this.InputComponentRef &#x3D; React.createRef()</span><br><span class="line">  &#125;</span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div className&#x3D;&quot;App&quot;&gt;</span><br><span class="line">        &lt;Input ref&#x3D;&#123;this.InputComponentRef&#125; &#x2F;&gt;</span><br><span class="line">        &lt;button onClick&#x3D;&#123;() &#x3D;&gt; this.InputComponentRef.current.focusInput()&#125;&gt;button&lt;&#x2F;button&gt;</span><br><span class="line">      &lt;&#x2F;div&gt;</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-组件回顾-一"><a href="#4-组件回顾-一" class="headerlink" title="4.组件回顾(一)"></a>4.组件回顾(一)</h3><blockquote>
<p>什么是组件</p>
</blockquote>
<p>React 是基于组件的方式进行用户界面开发的. 组件可以理解为对页面中某一块区域的封装。</p>
<blockquote>
<p>创建组件</p>
</blockquote>
<ul>
<li>创建类组件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">import React, &#123; Component &#125; from &#39;react&#39;;</span><br><span class="line">class App extends Component &#123;</span><br><span class="line">    render () &#123;</span><br><span class="line">        return &lt;div&gt;Hello, 我是类组件&lt;&#x2F;div&gt;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建函数组件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">const Person &#x3D; () &#x3D;&gt; &#123;</span><br><span class="line">     return &lt;div&gt;Hello, 我是函数型组件&lt;&#x2F;div&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意事项</strong></p>
<ol>
<li>组件名称首字母必须大写，用以区分组件和普通标签。</li>
<li>jsx语法外层必须有一个根元素</li>
</ol>
<blockquote>
<p>组件 props</p>
</blockquote>
<ul>
<li>props 传递数据</li>
</ul>
<p>在调用组件时可以向组件内部传递数据，在组件中可以通过 props 对象获取外部传递进来的数据。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;Person name&#x3D;&quot;乔治&quot; age&#x3D;&quot;20&quot;&#x2F;&gt;</span><br><span class="line">&lt;Person name&#x3D;&quot;玛丽&quot; age&#x3D;&quot;10&quot;&#x2F;&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 类组件</span><br><span class="line">class Person extends Component &#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h3&gt;姓名：&#123;this.props.name&#125;&lt;&#x2F;h3&gt;</span><br><span class="line">        &lt;h4&gt;年龄：&#123;this.props.age&#125;&lt;&#x2F;h4&gt;</span><br><span class="line">      &lt;&#x2F;div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 函数组件</span><br><span class="line">const Person &#x3D; props &#x3D;&gt; &#123;</span><br><span class="line">  return (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h3&gt;姓名：&#123;props.name&#125;&lt;&#x2F;h3&gt;</span><br><span class="line">      &lt;h4&gt;年龄：&#123;props.age&#125;&lt;&#x2F;h4&gt;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong></p>
<ol>
<li>props 对象中存储的数据是只读的，不能在组件内部被修改。</li>
<li>当 props 数据源中的数据被修改后，组件中的接收到的 props 数据会被同步更新。( 数据驱动DOM )</li>
</ol>
<blockquote>
<p>设置 props 默认值</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class App extends Component &#123;</span><br><span class="line">    static defaultProps &#x3D; &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">function ThemedButton(props) &#123;</span><br><span class="line">&#125;</span><br><span class="line">ThemedButton.defaultProps &#x3D; &#123;</span><br><span class="line">  theme: &quot;secondary&quot;,</span><br><span class="line">  label: &quot;Button Text&quot;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>组件 children</p>
</blockquote>
<p>通过 props.children 属性可以获取到在调用组件时填充到组件标签内部的内容。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Person&gt;组件内部的内容&lt;&#x2F;Person&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">const Person &#x3D; (props) &#x3D;&gt; &#123;</span><br><span class="line">    return (</span><br><span class="line">    	&lt;div&gt;&#123;props.children&#125;&lt;&#x2F;div&gt;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>单向数据流</p>
</blockquote>
<ol>
<li><p>在React中, 关于数据流动有一条原则, 就是单向数据流动, 自顶向下, 从父组件到子组件.</p>
</li>
<li><p>单向数据流特性要求我们共享数据要放置在上层组件中.</p>
</li>
<li><p>子组件通过调用父组件传递过来的方法更改数据.</p>
</li>
<li><p>当数据发生更改时, React会重新渲染组件树.</p>
</li>
<li><p>单向数据流使组件之间的数据流动变得可预测. 使得定位程序错误变得简单.</p>
</li>
</ol>
<blockquote>
<p>类组件状态 state</p>
</blockquote>
<ul>
<li>定义组件状态</li>
</ul>
<p>类组件除了能够从外部 (props) 接收状态数据以外还可以拥有自己的状态 (state)，此状态在组件内部可以被更新，状态更新 DOM 更新。</p>
<p>组件内部的状态数据被存储在组件类中的 state 属性中，state 属性值为对象类型，属性名称固定不可更改。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">class App extends Component &#123;</span><br><span class="line">  constructor () &#123;</span><br><span class="line">    super()</span><br><span class="line">    this.state &#x3D; &#123;</span><br><span class="line">      person: &#123; name: &#39;张三&#39;, age: 20 &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  render () &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &#123;this.state.person.name&#125;</span><br><span class="line">        &#123;this.state.person.age&#125;</span><br><span class="line">      &lt;&#x2F;div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>更改组件状态</li>
</ul>
<p>state 状态对象中的数据不可直接更改，如果直接更改 DOM 不会被更新，要更改 state 状态数据需要使用 setState方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">class App extends Component &#123;</span><br><span class="line">  constructor () &#123;</span><br><span class="line">    this.state &#x3D; &#123;</span><br><span class="line">      person: &#123; name: &#39;张三&#39;, age: 20 &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    this.changePerson &#x3D; this.changePerson.bind(this)</span><br><span class="line">  &#125;</span><br><span class="line">	changePerson () &#123;</span><br><span class="line">    this.setState(&#123;</span><br><span class="line">      person: &#123;</span><br><span class="line">        name: &#39;李四&#39;,</span><br><span class="line">        age: 15</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &#123;this.state.person.name&#125;</span><br><span class="line">        &#123;this.state.person.age&#125;</span><br><span class="line">        &lt;button onClick&#x3D;&#123;this.changePerson&#125;&gt;按钮&lt;&#x2F;button&gt;</span><br><span class="line">      &lt;&#x2F;div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>双向数据绑定</li>
</ul>
<p>双向数据绑定是指，组件类中更新了状态，DOM 状态同步更新，DOM 更改了状态，组件类中同步更新。组件 &lt;=&gt; 视图。</p>
<p>要实现双向数据绑定需要用到表单元素和 state 状态对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">class App extends Component &#123;</span><br><span class="line">  constructor () &#123;</span><br><span class="line">    this.state &#x3D; &#123;</span><br><span class="line">      name: &quot;张三&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    this.nameChanged &#x3D; this.nameChanged.bind(this)</span><br><span class="line">  &#125;</span><br><span class="line">  nameChanged (event) &#123;</span><br><span class="line">    this.setState(&#123;name: event.target.value&#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;div&gt;&#123;this.state.name&#125;&lt;&#x2F;div&gt;</span><br><span class="line">        &lt;Person name&#x3D;&#123;this.state.name&#125; changed&#x3D;&#123;this.nameChanged&#125;&#x2F;&gt;</span><br><span class="line">      &lt;&#x2F;div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">const Person &#x3D; props &#x3D;&gt; &#123;</span><br><span class="line">	return &lt;input type&#x3D;&quot;text&quot; value&#x3D;&#123;props.name&#125; onChange&#x3D;&#123;props.changed&#125;&#x2F;&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-组件回顾-二"><a href="#5-组件回顾-二" class="headerlink" title="5.组件回顾(二)"></a>5.组件回顾(二)</h3><blockquote>
<p>类组件生命周期函数</p>
</blockquote>
<p>在组件完成更新之前需要做某种逻辑或者计算，就需要用到快照</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">componentDidUpdate(prevProps, prevState, snapshot) &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>getSnapshotBeforeUpdate 方法会在组件完成更新之前执行，用于执行某种逻辑或计算，返回值可以在 componentDidUpdate 方法中的第三个参数中获取，就是说在组件更新之后可以拿到这个值再去做其他事情。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">getSnapshotBeforeUpdate(prevProps, prevState) &#123;</span><br><span class="line">  return &#39;snapshot&#39;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Context </p>
</blockquote>
<p>通过 Context 可以跨层级传递数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; userContext.js</span><br><span class="line">import React from &quot;react&quot;</span><br><span class="line"></span><br><span class="line">const userContext &#x3D; React.createContext(&quot;default value&quot;)</span><br><span class="line">const UserProvider &#x3D; userContext.Provider</span><br><span class="line">const UserConsumer &#x3D; userContext.Consumer</span><br><span class="line"></span><br><span class="line">export &#123; UserProvider, UserConsumer &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; App.js</span><br><span class="line">import &#123; UserProvider &#125; from &quot;.&#x2F;userContext&quot;</span><br><span class="line">class App extends Component &#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;UserProvider value&#x3D;&quot;Hello React Context&quot;&gt;</span><br><span class="line">        &lt;A &#x2F;&gt;</span><br><span class="line">      &lt;&#x2F;UserProvider&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; C.js</span><br><span class="line">import &#123; UserConsumer &#125; from &quot;.&#x2F;userContext&quot;</span><br><span class="line"></span><br><span class="line">export class C extends Component &#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;UserConsumer&gt;</span><br><span class="line">          &#123;username &#x3D;&gt; &#123;</span><br><span class="line">            return &lt;div&gt;&#123;username&#125;&lt;&#x2F;div&gt;</span><br><span class="line">          &#125;&#125;</span><br><span class="line">        &lt;&#x2F;UserConsumer&gt;</span><br><span class="line">      &lt;&#x2F;div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>context 的另一种用法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; userContext.js</span><br><span class="line">export default userContext</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; C.js</span><br><span class="line">import userContext from &quot;.&#x2F;userContext&quot;</span><br><span class="line"></span><br><span class="line">export class C extends Component &#123;</span><br><span class="line">  static contextType &#x3D; userContext</span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &#123;this.context&#125;</span><br><span class="line">      &lt;&#x2F;div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="6-表单回顾"><a href="#6-表单回顾" class="headerlink" title="6.表单回顾"></a>6.表单回顾</h3><blockquote>
<p>表单</p>
</blockquote>
<ul>
<li>受控表单</li>
</ul>
<p>表单控件中的值由组件的 state 对象来管理，state对象中存储的值和表单控件中的值时同步状态的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">class App extends Component &#123;</span><br><span class="line">  constructor () &#123;</span><br><span class="line">    this.state &#x3D; &#123; username: &quot;&quot; &#125;</span><br><span class="line">    this.nameChanged &#x3D; this.nameChanged.bind(this)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  nameChanged (e) &#123;</span><br><span class="line">    this.setState(&#123;username: e.target.value&#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;form&gt;</span><br><span class="line">        &lt;p&gt;&#123;this.state.username&#125;&lt;&#x2F;p&gt;</span><br><span class="line">        &lt;input type&#x3D;&quot;text&quot; value&#x3D;&#123;this.state.username&#125; onChange&#x3D;&#123;this.nameChanged&#125;&#x2F;&gt;</span><br><span class="line">      &lt;&#x2F;form&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>非受控表单</li>
</ul>
<p>表单元素的值由 DOM 元素本身管理。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">class App extends Component &#123;</span><br><span class="line">  constructor () &#123;</span><br><span class="line">    this.onSubmit &#x3D; this.onSubmit.bind(this)</span><br><span class="line">  &#125;</span><br><span class="line">  onSubmit(e) &#123;</span><br><span class="line">    console.log(this.username.value)</span><br><span class="line">    e.preventDefault();</span><br><span class="line">  &#125;</span><br><span class="line">  render(</span><br><span class="line">    &lt;form onSubmit&#x3D;&#123;this.onSubmit&#125;&gt;</span><br><span class="line">      &lt;input type&#x3D;&quot;text&quot; ref&#x3D;&#123;username &#x3D;&gt; this.username &#x3D; username&#125;&#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;form&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="7-路由回顾"><a href="#7-路由回顾" class="headerlink" title="7.路由回顾"></a>7.路由回顾</h3><blockquote>
<p>路由</p>
</blockquote>
<p>url地址与组件之间的对应关系，访问不同的url地址显示不同的组件。</p>
<p>下载：<code>npm install react-router-dom</code></p>
<ul>
<li>路由基本使用</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; App.js</span><br><span class="line">import React from &#39;react&#39;;</span><br><span class="line">import &#123; BrowserRouter as Router, Route, Link &#125; from &#39;react-router-dom&#39;;</span><br><span class="line">function Index() &#123;</span><br><span class="line">	return &lt;div&gt;首页&lt;&#x2F;div&gt;;</span><br><span class="line">&#125;</span><br><span class="line">function News() &#123;</span><br><span class="line">	return &lt;div&gt;新闻&lt;&#x2F;div&gt;;</span><br><span class="line">&#125;</span><br><span class="line">function App() &#123;</span><br><span class="line">  return (</span><br><span class="line">    &lt;Router&gt;</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;Link to&#x3D;&quot;&#x2F;index&quot;&gt;首页&lt;&#x2F;Link&gt;</span><br><span class="line">        &lt;Link to&#x3D;&quot;&#x2F;news&quot;&gt;新闻&lt;&#x2F;Link&gt;</span><br><span class="line">      &lt;&#x2F;div&gt;</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;Route path&#x3D;&quot;&#x2F;index&quot; component&#x3D;&#123;Index&#125;&#x2F;&gt;</span><br><span class="line">        &lt;Route path&#x3D;&quot;&#x2F;news&quot; component&#x3D;&#123;News&#125;&#x2F;&gt;</span><br><span class="line">      &lt;&#x2F;div&gt;</span><br><span class="line">    &lt;&#x2F;Router&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>路由嵌套</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">function News(props) &#123;</span><br><span class="line">  return (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;Link to&#x3D;&#123;&#96;$&#123;props.match.url&#125;&#x2F;company&#96;&#125;&gt;公司新闻&lt;&#x2F;Link&gt;</span><br><span class="line">        &lt;Link to&#x3D;&#123;&#96;$&#123;props.match.url&#125;&#x2F;industry&#96;&#125;&gt;行业新闻&lt;&#x2F;Link&gt;</span><br><span class="line">      &lt;&#x2F;div&gt;</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;Route path&#x3D;&#123;&#96;$&#123;props.match.path&#125;&#x2F;company&#96;&#125; component&#x3D;&#123;CompanyNews&#125; &#x2F;&gt;</span><br><span class="line">        &lt;Route path&#x3D;&#123;&#96;$&#123;props.match.path&#125;&#x2F;industry&#96;&#125; component&#x3D;&#123;IndustryNews&#125;&#x2F;&gt;  </span><br><span class="line">      &lt;&#x2F;div&gt;	</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function CompanyNews() &#123;</span><br><span class="line">	return &lt;div&gt;公司新闻&lt;&#x2F;div&gt;</span><br><span class="line">&#125;</span><br><span class="line">function IndustryNews() &#123;</span><br><span class="line">	return &lt;div&gt;行业新闻&lt;&#x2F;div&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>路由传参</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">import url from &#39;url&#39;;</span><br><span class="line">class News extends Component &#123;</span><br><span class="line">  constructor(props) &#123;</span><br><span class="line">    super(props);</span><br><span class="line">    this.state &#x3D; &#123;</span><br><span class="line">      list: [&#123;</span><br><span class="line">        id: 1,</span><br><span class="line">        title: &#39;新闻1&#39;</span><br><span class="line">      &#125;, &#123;</span><br><span class="line">        id: 2,</span><br><span class="line">        title: &#39;新闻2&#39;</span><br><span class="line">      &#125;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;div&gt;新闻列表组件&lt;&#x2F;div&gt;</span><br><span class="line">        &lt;ul&gt;</span><br><span class="line">          this.state.list.map((item, index) &#x3D;&gt; &#123;</span><br><span class="line">            return (</span><br><span class="line">              &lt;li key&#x3D;&#123;index&#125;&gt;</span><br><span class="line">                &lt;Link to&#x3D;&#123;&#96;&#x2F;detail?id&#x3D;$&#123;item.id&#125;&#96;&#125;&gt;&#123;item.title&#125;&lt;&#x2F;Link&gt;</span><br><span class="line">              &lt;&#x2F;li&gt;</span><br><span class="line">            );</span><br><span class="line">          &#125;)</span><br><span class="line">        &lt;&#x2F;ul&gt;</span><br><span class="line">      &lt;&#x2F;div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">class Detail extends Component &#123;</span><br><span class="line">  constructor(props) &#123;</span><br><span class="line">    super(props);</span><br><span class="line">  &#125;</span><br><span class="line">	const &#123; query &#125; &#x3D; url.parse(this.props.location.search, true);</span><br><span class="line">	console.log(query); &#x2F;&#x2F; &#123;id: 1&#125;</span><br><span class="line">  render() &#123;</span><br><span class="line">    return &lt;div&gt;新闻详情&lt;&#x2F;div&gt;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>路由重定向</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import &#123; Redirect &#125; from &#39;react-router-dom&#39;;</span><br><span class="line"></span><br><span class="line">class Login extends Component &#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    if (this.state.isLogin) &#123;</span><br><span class="line">      return &lt;Redirect to&#x3D;&quot;&#x2F;&quot;&#x2F;&gt;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="任务二：VirtualDOM-及-Diff-算法"><a href="#任务二：VirtualDOM-及-Diff-算法" class="headerlink" title="任务二：VirtualDOM 及 Diff 算法"></a>任务二：VirtualDOM 及 Diff 算法</h2><h3 id="1-课程介绍"><a href="#1-课程介绍" class="headerlink" title="1.课程介绍"></a>1.课程介绍</h3><p>略</p>
<h3 id="2-JSX-到底是什么"><a href="#2-JSX-到底是什么" class="headerlink" title="2.JSX 到底是什么"></a>2.JSX 到底是什么</h3><p>使用 React 就一定会写 JSX，JSX 到底是什么呢？它是一种 JavaScript 语法的扩展，React 使用它来描述用户界面长成什么样子。虽然它看起来非常像 HTML，但它确实是 JavaScript 。在 React 代码执行之前，Babel 会对将 JSX 编译为 React API.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;div className&#x3D;&quot;container&quot;&gt;</span><br><span class="line">  &lt;h3&gt;Hello React&lt;&#x2F;h3&gt;</span><br><span class="line">  &lt;p&gt;React is great &lt;&#x2F;p&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">React.createElement(</span><br><span class="line">  &quot;div&quot;,</span><br><span class="line">  &#123;</span><br><span class="line">    className: &quot;container&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  React.createElement(&quot;h3&quot;, null, &quot;Hello React&quot;),</span><br><span class="line">  React.createElement(&quot;p&quot;, null, &quot;React is great&quot;)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>从两种语法对比来看，JSX 语法的出现是为了让 React 开发人员编写用户界面代码更加轻松。</p>
<p><a href="https://babeljs.io/repl" target="_blank" rel="noopener">Babel REPL</a></p>
<h3 id="3-VirtualDOM-介绍"><a href="#3-VirtualDOM-介绍" class="headerlink" title="3.VirtualDOM 介绍"></a>3.VirtualDOM 介绍</h3><blockquote>
<p>DOM 操作问题</p>
</blockquote>
<p>在现代 web 应用程序中使用 JavaScript 操作 DOM 是必不可少的，但遗憾的是它比其他大多数 JavaScript 操作要慢的多。</p>
<p>大多数 JavaScript 框架对于 DOM 的更新远远超过其必须进行的更新，从而使得这种缓慢操作变得更糟。</p>
<p>例如假设你有包含十个项目的列表，你仅仅更改了列表中的第一项，大多数 JavaScript 框架会重建整个列表，这比必要的工作要多十倍。</p>
<p>更新效率低下已经成为严重问题，为了解决这个问题，React 普及了一种叫做 Virtual DOM 的东西，Virtual DOM 出现的目的就是为了提高 JavaScript 操作 DOM 对象的效率。</p>
<blockquote>
<p>什么是 Virtual DOM</p>
</blockquote>
<p>在 React 中，每个 DOM 对象都有一个对应的 Virtual DOM 对象，它是 DOM 对象的 JavaScript 对象表现形式，其实就是使用 JavaScript 对象来描述 DOM 对象信息，比如 DOM 对象的类型是什么，它身上有哪些属性，它拥有哪些子元素。</p>
<p>可以把 Virtual DOM 对象理解为 DOM 对象的副本，但是它不能直接显示在屏幕上。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;div className&#x3D;&quot;container&quot;&gt;</span><br><span class="line">  &lt;h3&gt;Hello React&lt;&#x2F;h3&gt;</span><br><span class="line">  &lt;p&gt;React is great &lt;&#x2F;p&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  type: &quot;div&quot;,</span><br><span class="line">  props: &#123; className: &quot;container&quot; &#125;,</span><br><span class="line">  children: [</span><br><span class="line">    &#123;</span><br><span class="line">      type: &quot;h3&quot;,</span><br><span class="line">      props: null,</span><br><span class="line">      children: [</span><br><span class="line">        &#123;</span><br><span class="line">          type: &quot;text&quot;,</span><br><span class="line">          props: &#123;</span><br><span class="line">            textContent: &quot;Hello React&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      type: &quot;p&quot;,</span><br><span class="line">      props: null,</span><br><span class="line">      children: [</span><br><span class="line">        &#123;</span><br><span class="line">          type: &quot;text&quot;,</span><br><span class="line">          props: &#123;</span><br><span class="line">            textContent: &quot;React is great&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Virtual DOM 如何提升效率</p>
</blockquote>
<p>精准找出发生变化的 DOM 对象，只更新发生变化的部分。</p>
<p>在 React 第一次创建 DOM 对象后，会为每个 DOM 对象创建其对应的 Virtual DOM 对象，在 DOM 对象发生更新之前，React 会先更新所有的 Virtual DOM 对象，然后 React 会将更新后的 Virtual DOM 和 更新前的 Virtual DOM 进行比较，从而找出发生变化的部分，React 会将发生变化的部分更新到真实的 DOM 对象中，React 仅更新必要更新的部分。</p>
<p>Virtual DOM 对象的更新和比较仅发生在内存中，不会在视图中渲染任何内容，所以这一部分的性能损耗成本是微不足道的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id&#x3D;&quot;container&quot;&gt;</span><br><span class="line">	&lt;p&gt;Hello React&lt;&#x2F;p&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id&#x3D;&quot;container&quot;&gt;</span><br><span class="line">	&lt;p&gt;Hello Angular&lt;&#x2F;p&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">const before &#x3D; &#123;</span><br><span class="line">  type: &quot;div&quot;,</span><br><span class="line">  props: &#123; id: &quot;container&quot; &#125;,</span><br><span class="line">  children: [</span><br><span class="line">    &#123;</span><br><span class="line">      type: &quot;p&quot;,</span><br><span class="line">      props: null,</span><br><span class="line">      children: [</span><br><span class="line">        &#123; type: &quot;text&quot;, props: &#123; textContent: &quot;Hello React&quot; &#125; &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">const after &#x3D; &#123;</span><br><span class="line">  type: &quot;div&quot;,</span><br><span class="line">  props: &#123; id: &quot;container&quot; &#125;,</span><br><span class="line">  children: [</span><br><span class="line">    &#123;</span><br><span class="line">      type: &quot;p&quot;,</span><br><span class="line">      props: null,</span><br><span class="line">      children: [</span><br><span class="line">        &#123; type: &quot;text&quot;, props: &#123; textContent: &quot;Hello Angular&quot; &#125; &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-创建-VirtualDOM-对象-一"><a href="#4-创建-VirtualDOM-对象-一" class="headerlink" title="4.创建 VirtualDOM 对象(一)"></a>4.创建 VirtualDOM 对象(一)</h3><p>略</p>
<h3 id="5-创建-VirtualDOM-对象-二"><a href="#5-创建-VirtualDOM-对象-二" class="headerlink" title="5.创建 VirtualDOM 对象(二)"></a>5.创建 VirtualDOM 对象(二)</h3><p>在 React 代码执行前，JSX 会被 Babel 转换为 React.createElement 方法的调用，在调用 createElement 方法时会传入元素的类型，元素的属性，以及元素的子元素，createElement 方法的返回值为构建好的 Virtual DOM 对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  type: &quot;div&quot;,</span><br><span class="line">  props: null,</span><br><span class="line">  children: [&#123;type: &quot;text&quot;, props: &#123;textContent: &quot;Hello&quot;&#125;&#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 创建 Virtual DOM</span><br><span class="line"> * @param &#123;string&#125; type 类型</span><br><span class="line"> * @param &#123;object | null&#125; props 属性</span><br><span class="line"> * @param  &#123;createElement[]&#125; children 子元素</span><br><span class="line"> * @return &#123;object&#125; Virtual DOM</span><br><span class="line"> *&#x2F;</span><br><span class="line">function createElement (type, props, ...children) &#123;</span><br><span class="line">	return &#123;</span><br><span class="line">    type,</span><br><span class="line">    props,</span><br><span class="line">    children</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从 createElement 方法的第三个参数开始就都是子元素了，在定义 createElement 方法时，通过 <code>...children</code> 将所有的子元素放置到 children 数组中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">const virtualDOM &#x3D; (</span><br><span class="line">  &lt;div className&#x3D;&quot;container&quot;&gt;</span><br><span class="line">    &lt;h1&gt;你好 Tiny React&lt;&#x2F;h1&gt;</span><br><span class="line">    &lt;h2&gt;(编码必杀技)&lt;&#x2F;h2&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      嵌套1 &lt;div&gt;嵌套 1.1&lt;&#x2F;div&gt;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">    &lt;h3&gt;(观察: 这个将会被改变)&lt;&#x2F;h3&gt;</span><br><span class="line">    &#123;2 &#x3D;&#x3D; 1 &amp;&amp; &lt;div&gt;如果2和1相等渲染当前内容&lt;&#x2F;div&gt;&#125;</span><br><span class="line">    &#123;2 &#x3D;&#x3D; 2 &amp;&amp; &lt;div&gt;2&lt;&#x2F;div&gt;&#125;</span><br><span class="line">    &lt;span&gt;这是一段内容&lt;&#x2F;span&gt;</span><br><span class="line">    &lt;button onClick&#x3D;&#123;() &#x3D;&gt; alert(&quot;你好&quot;)&#125;&gt;点击我&lt;&#x2F;button&gt;</span><br><span class="line">    &lt;h3&gt;这个将会被删除&lt;&#x2F;h3&gt;</span><br><span class="line">    2, 3</span><br><span class="line">  &lt;&#x2F;div&gt;</span><br><span class="line">)</span><br><span class="line">console.log(virtualDOM)</span><br></pre></td></tr></table></figure>

<p>通过以上代码测试，发现返回的 Virtual DOM 存在一些问题，第一个问题是文本节点被直接放入到了数组中</p>
<p>而我们期望是文本节点应该是这样的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">children: [</span><br><span class="line">  &#123;</span><br><span class="line">    type: &quot;text&quot;,</span><br><span class="line">    props: &#123;</span><br><span class="line">      textContent: &quot;React is great&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>通过以下代码对 Virtual DOM 进行改造，重新构建 Virtual DOM。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将原有 children 拷贝一份 不要在原有数组上进行操作</span></span><br><span class="line"><span class="keyword">const</span> childElements = [].concat(...children).map(<span class="function"><span class="params">child</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 判断 child 是否是对象类型</span></span><br><span class="line">  <span class="keyword">if</span> (child <span class="keyword">instanceof</span> <span class="built_in">Object</span>) &#123;</span><br><span class="line">    <span class="comment">// 如果是 什么都不需要做 直接返回即可</span></span><br><span class="line">    <span class="keyword">return</span> child</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 如果不是对象就是文本 手动调用 createElement 方法将文本转换为 Virtual DOM</span></span><br><span class="line">    <span class="keyword">return</span> createElement(<span class="string">"text"</span>, &#123; <span class="attr">textContent</span>: child &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  type,</span><br><span class="line">  props,</span><br><span class="line">  children: childElements</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过观察返回的 Virtual DOM，文本节点已经被转化成了对象类型的 Virtual DOM，但是布尔值也被当做文本节点被转化了，在 JSX 中，如果 Virtual DOM 被转化为了布尔值或者null，是不应该被更新到真实 DOM 中的，所以接下来要做的事情就是清除 Virtual DOM 中的布尔值和null。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 由于 map 方法无法从数据中刨除元素, 所以此处将 map 方法更改为 reduce 方法</span><br><span class="line">const childElements &#x3D; [].concat(...children).reduce((result, child) &#x3D;&gt; &#123;</span><br><span class="line">  &#x2F;&#x2F; 判断子元素类型 刨除 null true false</span><br><span class="line">  if (child !&#x3D; null &amp;&amp; child !&#x3D; false &amp;&amp; child !&#x3D; true) &#123;</span><br><span class="line">    if (child instanceof Object) &#123;</span><br><span class="line">      result.push(child)</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      result.push(createElement(&quot;text&quot;, &#123; textContent: child &#125;))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; 将需要保留的 Virtual DOM 放入 result 数组</span><br><span class="line">  return result</span><br><span class="line">&#125;, [])</span><br></pre></td></tr></table></figure>

<p>在 React 组件中，可以通过 props.children 获取子元素，所以还需要将子元素存储在 props 对象中。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  type,</span><br><span class="line">  props: <span class="built_in">Object</span>.assign(&#123; <span class="attr">children</span>: childElements &#125;, props),</span><br><span class="line">  children: childElements</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-普通-VirtualDOM-对象转化为真实-DOM-对象"><a href="#6-普通-VirtualDOM-对象转化为真实-DOM-对象" class="headerlink" title="6.普通 VirtualDOM 对象转化为真实 DOM 对象"></a>6.普通 VirtualDOM 对象转化为真实 DOM 对象</h3><p>通过调用 render 方法可以将 Virtual DOM 对象更新为真实 DOM 对象。</p>
<p>在更新之前需要确定是否存在旧的 Virtual DOM，如果存在需要比对差异，如果不存在可以直接将 Virtual DOM 转换为 DOM 对象。 </p>
<p>目前先只考虑不存在旧的 Virtual DOM 的情况，就是说先直接将 Virtual DOM 对象更新为真实 DOM 对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; render.js</span><br><span class="line">export default function render(virtualDOM, container, oldDOM &#x3D; container.firstChild) &#123;</span><br><span class="line">  &#x2F;&#x2F; 在 diff 方法内部判断是否需要对比 对比也好 不对比也好 都在 diff 方法中进行操作  </span><br><span class="line">  diff(virtualDOM, container, oldDOM)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; diff.js</span><br><span class="line">import mountElement from &quot;.&#x2F;mountElement&quot;</span><br><span class="line"></span><br><span class="line">export default function diff(virtualDOM, container, oldDOM) &#123;</span><br><span class="line">  &#x2F;&#x2F; 判断 oldDOM 是否存在</span><br><span class="line">  if (!oldDOM) &#123;</span><br><span class="line">    &#x2F;&#x2F; 如果不存在 不需要对比 直接将 Virtual DOM 转换为真实 DOM</span><br><span class="line">    mountElement(virtualDOM, container)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在进行 virtual DOM 转换之前还需要确定 Virtual DOM 的类 Component VS Native Element。</p>
<p>类型不同需要做不同的处理 如果是 Native Element 直接转换。</p>
<p>如果是组件 还需要得到组件实例对象 通过组件实例对象获取组件返回的 virtual DOM 然后再进行转换。</p>
<p>目前先只考虑 Native Element 的情况。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; mountElement.js</span><br><span class="line">import mountNativeElement from &quot;.&#x2F;mountNativeElement&quot;</span><br><span class="line"></span><br><span class="line">export default function mountElement(virtualDOM, container) &#123;</span><br><span class="line">  &#x2F;&#x2F; 通过调用 mountNativeElement 方法转换 Native Element</span><br><span class="line">  mountNativeElement(virtualDOM, container)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; mountNativeElement.js</span><br><span class="line">import createDOMElement from &quot;.&#x2F;createDOMElement&quot;</span><br><span class="line"></span><br><span class="line">export default function mountNativeElement(virtualDOM, container) &#123;</span><br><span class="line">  const newElement &#x3D; createDOMElement(virtualDOM)</span><br><span class="line">  container.appendChild(newElement)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; createDOMElement.js</span><br><span class="line">import mountElement from &quot;.&#x2F;mountElement&quot;</span><br><span class="line">import updateElementNode from &quot;.&#x2F;updateElementNode&quot;</span><br><span class="line"></span><br><span class="line">export default function createDOMElement(virtualDOM) &#123;</span><br><span class="line">  let newElement &#x3D; null</span><br><span class="line">  if (virtualDOM.type &#x3D;&#x3D;&#x3D; &quot;text&quot;) &#123;</span><br><span class="line">    &#x2F;&#x2F; 创建文本节点</span><br><span class="line">    newElement &#x3D; document.createTextNode(virtualDOM.props.textContent)</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    &#x2F;&#x2F; 创建元素节点</span><br><span class="line">    newElement &#x3D; document.createElement(virtualDOM.type)</span><br><span class="line">    &#x2F;&#x2F; 更新元素属性</span><br><span class="line">    updateElementNode(newElement, virtualDOM)</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; 递归渲染子节点</span><br><span class="line">  virtualDOM.children.forEach(child &#x3D;&gt; &#123;</span><br><span class="line">    &#x2F;&#x2F; 因为不确定子元素是 NativeElement 还是 Component 所以调用 mountElement 方法进行确定</span><br><span class="line">    mountElement(child, newElement)</span><br><span class="line">  &#125;)</span><br><span class="line">  return newElement</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-为-DOM-对象添加属性"><a href="#7-为-DOM-对象添加属性" class="headerlink" title="7.为 DOM 对象添加属性"></a>7.为 DOM 对象添加属性</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; createDOMElement.js</span><br><span class="line">&#x2F;&#x2F; 看看节点类型是文本类型还是元素类型</span><br><span class="line">if (virtualDOM.type &#x3D;&#x3D;&#x3D; &quot;text&quot;) &#123;</span><br><span class="line">  &#x2F;&#x2F; 创建文本节点 设置节点内容</span><br><span class="line">  newElement &#x3D; document.createTextNode(virtualDOM.props.textContent)</span><br><span class="line">&#125; else &#123;</span><br><span class="line">  &#x2F;&#x2F; 根据 Virtual DOM type 属性值创建 DOM 元素</span><br><span class="line">  newElement &#x3D; document.createElement(virtualDOM.type)</span><br><span class="line">  &#x2F;&#x2F; 为元素设置属性</span><br><span class="line">  updateElementNode(newElement, virtualDOM)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">export default function updateElementNode(element, virtualDOM) &#123;</span><br><span class="line">  &#x2F;&#x2F; 获取要解析的 VirtualDOM 对象中的属性对象</span><br><span class="line">  const newProps &#x3D; virtualDOM.props</span><br><span class="line">  &#x2F;&#x2F; 将属性对象中的属性名称放到一个数组中并循环数组</span><br><span class="line">  Object.keys(newProps).forEach(propName &#x3D;&gt; &#123;</span><br><span class="line">    const newPropsValue &#x3D; newProps[propName]</span><br><span class="line">    &#x2F;&#x2F; 考虑属性名称是否以 on 开头 如果是就表示是个事件属性 onClick -&gt; click</span><br><span class="line">    if (propName.slice(0, 2) &#x3D;&#x3D;&#x3D; &quot;on&quot;) &#123;</span><br><span class="line">      const eventName &#x3D; propName.toLowerCase().slice(2)</span><br><span class="line">      element.addEventListener(eventName, newPropsValue)</span><br><span class="line">      &#x2F;&#x2F; 如果属性名称是 value 或者 checked 需要通过 [] 的形式添加</span><br><span class="line">    &#125; else if (propName &#x3D;&#x3D;&#x3D; &quot;value&quot; || propName &#x3D;&#x3D;&#x3D; &quot;checked&quot;) &#123;</span><br><span class="line">      element[propName] &#x3D; newPropsValue</span><br><span class="line">      &#x2F;&#x2F; 刨除 children 因为它是子元素 不是属性</span><br><span class="line">    &#125; else if (propName !&#x3D;&#x3D; &quot;children&quot;) &#123;</span><br><span class="line">      &#x2F;&#x2F; className 属性单独处理 不直接在元素上添加 class 属性是因为 class 是 JavaScript 中的关键字</span><br><span class="line">      if (propName &#x3D;&#x3D;&#x3D; &quot;className&quot;) &#123;</span><br><span class="line">        element.setAttribute(&quot;class&quot;, newPropsValue)</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        &#x2F;&#x2F; 普通属性</span><br><span class="line">        element.setAttribute(propName, newPropsValue)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-组件渲染之区分函数组件和类组件"><a href="#8-组件渲染之区分函数组件和类组件" class="headerlink" title="8.组件渲染之区分函数组件和类组件"></a>8.组件渲染之区分函数组件和类组件</h3><blockquote>
<p>函数组件</p>
</blockquote>
<p>在渲染组件之前首先要明确的是，组件的 Virtual DOM 类型值为函数，函数组件和类组件都是这样的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 原始组件</span><br><span class="line">const Heart &#x3D; () &#x3D;&gt; &lt;span&gt;&amp;hearts;&lt;&#x2F;span&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Heart &#x2F;&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 组件的 Virtual DOM</span><br><span class="line">&#123;</span><br><span class="line">  type: f function() &#123;&#125;,</span><br><span class="line">  props: &#123;&#125;</span><br><span class="line">  children: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在渲染组件时，要先将 Component 与 Native Element 区分开，如果是 Native Element 可以直接开始渲染，如果是组件，特别处理。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; mountElement.js</span><br><span class="line">export default function mountElement(virtualDOM, container) &#123;</span><br><span class="line">  &#x2F;&#x2F; 无论是类组件还是函数组件 其实本质上都是函数 </span><br><span class="line">  &#x2F;&#x2F; 如果 Virtual DOM 的 type 属性值为函数 就说明当前这个 Virtual DOM 为组件</span><br><span class="line">  if (isFunction(virtualDOM)) &#123;</span><br><span class="line">    &#x2F;&#x2F; 如果是组件 调用 mountComponent 方法进行组件渲染</span><br><span class="line">    mountComponent(virtualDOM, container)</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    mountNativeElement(virtualDOM, container)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Virtual DOM 是否为函数类型</span><br><span class="line">export function isFunction(virtualDOM) &#123;</span><br><span class="line">  return virtualDOM &amp;&amp; typeof virtualDOM.type &#x3D;&#x3D;&#x3D; &quot;function&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 mountComponent 方法中再进行函数组件和类型的区分，然后再分别进行处理。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; mountComponent.js</span><br><span class="line">import mountNativeElement from &quot;.&#x2F;mountNativeElement&quot;</span><br><span class="line"></span><br><span class="line">export default function mountComponent(virtualDOM, container) &#123;</span><br><span class="line">  &#x2F;&#x2F; 存放组件调用后返回的 Virtual DOM 的容器</span><br><span class="line">  let nextVirtualDOM &#x3D; null</span><br><span class="line">  &#x2F;&#x2F; 区分函数型组件和类组件</span><br><span class="line">  if (isFunctionalComponent(virtualDOM)) &#123;</span><br><span class="line">    &#x2F;&#x2F; 函数组件 调用 buildFunctionalComponent 方法处理函数组件</span><br><span class="line">    nextVirtualDOM &#x3D; buildFunctionalComponent(virtualDOM)</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    &#x2F;&#x2F; 类组件</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; 判断得到的 Virtual Dom 是否是组件</span><br><span class="line">  if (isFunction(nextVirtualDOM)) &#123;</span><br><span class="line">    &#x2F;&#x2F; 如果是组件 继续调用 mountComponent 解剖组件</span><br><span class="line">    mountComponent(nextVirtualDOM, container)</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    &#x2F;&#x2F; 如果是 Navtive Element 就去渲染</span><br><span class="line">    mountNativeElement(nextVirtualDOM, container)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Virtual DOM 是否为函数型组件</span><br><span class="line">&#x2F;&#x2F; 条件有两个: 1. Virtual DOM 的 type 属性值为函数 2. 函数的原型对象中不能有render方法</span><br><span class="line">&#x2F;&#x2F; 只有类组件的原型对象中有render方法 </span><br><span class="line">export function isFunctionalComponent(virtualDOM) &#123;</span><br><span class="line">  const type &#x3D; virtualDOM &amp;&amp; virtualDOM.type</span><br><span class="line">  return (</span><br><span class="line">    type &amp;&amp; isFunction(virtualDOM) &amp;&amp; !(type.prototype &amp;&amp; type.prototype.render)</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 函数组件处理 </span><br><span class="line">function buildFunctionalComponent(virtualDOM) &#123;</span><br><span class="line">  &#x2F;&#x2F; 通过 Virtual DOM 中的 type 属性获取到组件函数并调用</span><br><span class="line">  &#x2F;&#x2F; 调用组件函数时将 Virtual DOM 对象中的 props 属性传递给组件函数 这样在组件中就可以通过 props 属性获取数据了</span><br><span class="line">  &#x2F;&#x2F; 组件返回要渲染的 Virtual DOM</span><br><span class="line">  return virtualDOM &amp;&amp; virtualDOM.type(virtualDOM.props || &#123;&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>类组件</p>
</blockquote>
<p>类组件本身也是 Virtual DOM，可以通过 Virtual DOM 中的 type 属性值确定当前要渲染的组件是类组件还是函数组件。</p>
<p>在确定当前要渲染的组件为类组件以后，需要实例化类组件得到类组件实例对象，通过类组件实例对象调用类组件中的 render 方法，获取组件要渲染的 Virtual DOM。</p>
<p>类组件需要继承 Component 父类，子类需要通过 super 方法将自身的 props 属性传递给 Component 父类，父类会将 props 属性挂载为父类属性，子类继承了父类，自己本身也就自然拥有props属性了。这样做的好处是当 props 发生更新后，父类可以根据更新后的 props 帮助子类更新视图。</p>
<p>假设以下代码就是我们要渲染的类组件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">class Alert extends TinyReact.Component &#123;</span><br><span class="line">  constructor(props) &#123;</span><br><span class="line">    &#x2F;&#x2F; 将 props 传递给父类 子类继承父类的 props 子类自然就有 props 数据了</span><br><span class="line">    &#x2F;&#x2F; 否则 props 仅仅是 constructor 函数的参数而已</span><br><span class="line">    &#x2F;&#x2F; 将 props 传递给父类的好处是 当 props 发生更改时 父类可以帮助更新 props 更新组件视图</span><br><span class="line">    super(props)</span><br><span class="line">    this.state &#x3D; &#123;</span><br><span class="line">      title: &quot;default title&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h2&gt;&#123;this.state.title&#125;&lt;&#x2F;h2&gt;</span><br><span class="line">        &lt;p&gt;&#123;this.props.message&#125;&lt;&#x2F;p&gt;</span><br><span class="line">      &lt;&#x2F;div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TinyReact.render(&lt;Alert message&#x3D;&quot;Hello React&quot; &#x2F;&gt;, root)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Component.js 父类 Component 实现</span><br><span class="line">export default class Component &#123;</span><br><span class="line">  constructor(props) &#123;</span><br><span class="line">    this.props &#x3D; props</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 mountComponent 方法中通过调用 buildStatefulComponent 方法得到类组件要渲染的 Virtual DOM</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; mountComponent.js</span><br><span class="line">export default function mountComponent(virtualDOM, container) &#123;</span><br><span class="line">  let nextVirtualDOM &#x3D; null</span><br><span class="line">  &#x2F;&#x2F; 区分函数型组件和类组件</span><br><span class="line">  if (isFunctionalComponent(virtualDOM)) &#123;</span><br><span class="line">    &#x2F;&#x2F; 函数组件</span><br><span class="line">    nextVirtualDOM &#x3D; buildFunctionalComponent(virtualDOM)</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    &#x2F;&#x2F; 类组件</span><br><span class="line">    nextVirtualDOM &#x3D; buildStatefulComponent(virtualDOM)</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; 判断得到的 Virtual Dom 是否是组件</span><br><span class="line">  if (isFunction(nextVirtualDOM)) &#123;</span><br><span class="line">    mountComponent(nextVirtualDOM, container)</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    mountNativeElement(nextVirtualDOM, container)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 处理类组件</span><br><span class="line">function buildStatefulComponent(virtualDOM) &#123;</span><br><span class="line">  &#x2F;&#x2F; 实例化类组件 得到类组件实例对象 并将 props 属性传递进类组件</span><br><span class="line">  const component &#x3D; new virtualDOM.type(virtualDOM.props)</span><br><span class="line">  &#x2F;&#x2F; 调用类组件中的render方法得到要渲染的 Virtual DOM</span><br><span class="line">  const nextVirtualDOM &#x3D; component.render()</span><br><span class="line">  &#x2F;&#x2F; 返回要渲染的 Virtual DOM</span><br><span class="line">  return nextVirtualDOM</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="9-组件渲染之函数组件"><a href="#9-组件渲染之函数组件" class="headerlink" title="9.组件渲染之函数组件"></a>9.组件渲染之函数组件</h3><p>略</p>
<h3 id="10-组件渲染之函数组件-prop-参数处理"><a href="#10-组件渲染之函数组件-prop-参数处理" class="headerlink" title="10.组件渲染之函数组件 prop 参数处理"></a>10.组件渲染之函数组件 prop 参数处理</h3><p>略</p>
<h3 id="11-组件渲染之类组件"><a href="#11-组件渲染之类组件" class="headerlink" title="11.组件渲染之类组件"></a>11.组件渲染之类组件</h3><p>略</p>
<h3 id="12-组件渲染之类组件-props-处理"><a href="#12-组件渲染之类组件-props-处理" class="headerlink" title="12.组件渲染之类组件 props 处理"></a>12.组件渲染之类组件 props 处理</h3><p>略</p>
<h3 id="13-更新-DOM-元素之-VirtualDOM-对比-节点类型相同的情况-一"><a href="#13-更新-DOM-元素之-VirtualDOM-对比-节点类型相同的情况-一" class="headerlink" title="13.更新 DOM 元素之 VirtualDOM 对比(节点类型相同的情况)(一)"></a>13.更新 DOM 元素之 VirtualDOM 对比(节点类型相同的情况)(一)</h3><p>在进行 Virtual DOM 比对时，需要用到更新后的 Virtual DOM 和更新前的 Virtual DOM，更新后的 Virtual DOM 目前我们可以通过 render 方法进行传递，现在的问题是更新前的 Virtual DOM 要如何获取呢？</p>
<p>对于更新前的 Virtual DOM，对应的其实就是已经在页面中显示的真实 DOM 对象。既然是这样，那么我们在创建真实DOM对象时，就可以将 Virtual DOM 添加到真实 DOM 对象的属性中。在进行 Virtual DOM 对比之前，就可以通过真实 DOM 对象获取其对应的 Virtual DOM 对象了，其实就是通过render方法的第三个参数获取的，container.firstChild。</p>
<p>在创建真实 DOM 对象时为其添加对应的 Virtual DOM 对象</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; mountElement.js</span><br><span class="line">import mountElement from &quot;.&#x2F;mountElement&quot;</span><br><span class="line"></span><br><span class="line">export default function mountNativeElement(virtualDOM, container) &#123;</span><br><span class="line">  &#x2F;&#x2F; 将 Virtual DOM 挂载到真实 DOM 对象的属性中 方便在对比时获取其 Virtual DOM</span><br><span class="line">  newElement._virtualDOM &#x3D; virtualDOM</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> Virtual DOM 类型相同，如果是元素节点，就对比元素节点属性是否发生变化，如果是文本节点就对比文本节点内容是否发生变化</p>
<p>要实现对比，需要先从已存在 DOM 对象中获取其对应的 Virtual DOM 对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; diff.js</span><br><span class="line">&#x2F;&#x2F; 获取未更新前的 Virtual DOM</span><br><span class="line">const oldVirtualDOM &#x3D; oldDOM &amp;&amp; oldDOM._virtualDOM</span><br></pre></td></tr></table></figure>

<p>判断 oldVirtualDOM 是否存在， 如果存在则继续判断要对比的 Virtual DOM 类型是否相同，如果类型相同判断节点类型是否是文本，如果是文本节点对比，就调用 updateTextNode 方法，如果是元素节点对比就调用 setAttributeForElement 方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; diff.js</span><br><span class="line">else if (oldVirtualDOM &amp;&amp; virtualDOM.type &#x3D;&#x3D;&#x3D; oldVirtualDOM.type) &#123;</span><br><span class="line">  if (virtualDOM.type &#x3D;&#x3D;&#x3D; &quot;text&quot;) &#123;</span><br><span class="line">    &#x2F;&#x2F; 文本节点 对比文本内容是否发生变化</span><br><span class="line">    updateTextNode(virtualDOM, oldVirtualDOM, oldDOM)</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    &#x2F;&#x2F; 元素节点 对比元素属性是否发生变化</span><br><span class="line">    setAttributeForElement(oldDOM, virtualDOM, oldVirtualDOM)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>updateTextNode 方法用于对比文本节点内容是否发生变化，如果发生变化则更新真实 DOM 对象中的内容，既然真实 DOM 对象发生了变化，还要将最新的 Virtual DOM 同步给真实 DOM 对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">function updateTextNode(virtualDOM, oldVirtualDOM, oldDOM) &#123;</span><br><span class="line">  &#x2F;&#x2F; 如果文本节点内容不同</span><br><span class="line">  if (virtualDOM.props.textContent !&#x3D;&#x3D; oldVirtualDOM.props.textContent) &#123;</span><br><span class="line">    &#x2F;&#x2F; 更新真实 DOM 对象中的内容</span><br><span class="line">    oldDOM.textContent &#x3D; virtualDOM.props.textContent</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; 同步真实 DOM 对应的 Virtual DOM</span><br><span class="line">  oldDOM._virtualDOM &#x3D; virtualDOM</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>setAttributeForElement 方法用于设置/更新元素节点属性</p>
<p>思路是先分别获取更新后的和更新前的 Virtual DOM 中的 props 属性，循环新 Virtual DOM 中的 props 属性，通过对比看一下新 Virtual DOM 中的属性值是否发生了变化，如果发生变化 需要将变化的值更新到真实 DOM 对象中</p>
<p>再循环未更新前的 Virtual DOM 对象，通过对比看看新的 Virtual DOM 中是否有被删除的属性，如果存在删除的属性 需要将 DOM 对象中对应的属性也删除掉</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; updateNodeElement.js</span><br><span class="line">export default function updateNodeElement(</span><br><span class="line">  newElement,</span><br><span class="line">  virtualDOM,</span><br><span class="line">  oldVirtualDOM &#x3D; &#123;&#125;</span><br><span class="line">) &#123;</span><br><span class="line">  &#x2F;&#x2F; 获取节点对应的属性对象</span><br><span class="line">  const newProps &#x3D; virtualDOM.props || &#123;&#125;</span><br><span class="line">  const oldProps &#x3D; oldVirtualDOM.props || &#123;&#125;</span><br><span class="line">  Object.keys(newProps).forEach(propName &#x3D;&gt; &#123;</span><br><span class="line">    &#x2F;&#x2F; 获取属性值</span><br><span class="line">    const newPropsValue &#x3D; newProps[propName]</span><br><span class="line">    const oldPropsValue &#x3D; oldProps[propName]</span><br><span class="line">    if (newPropsValue !&#x3D;&#x3D; oldPropsValue) &#123;</span><br><span class="line">      &#x2F;&#x2F; 判断属性是否是否事件属性 onClick -&gt; click</span><br><span class="line">      if (propName.slice(0, 2) &#x3D;&#x3D;&#x3D; &quot;on&quot;) &#123;</span><br><span class="line">        &#x2F;&#x2F; 事件名称</span><br><span class="line">        const eventName &#x3D; propName.toLowerCase().slice(2)</span><br><span class="line">        &#x2F;&#x2F; 为元素添加事件</span><br><span class="line">        newElement.addEventListener(eventName, newPropsValue)</span><br><span class="line">        &#x2F;&#x2F; 删除原有的事件的事件处理函数</span><br><span class="line">        if (oldPropsValue) &#123;</span><br><span class="line">          newElement.removeEventListener(eventName, oldPropsValue)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; else if (propName &#x3D;&#x3D;&#x3D; &quot;value&quot; || propName &#x3D;&#x3D;&#x3D; &quot;checked&quot;) &#123;</span><br><span class="line">        newElement[propName] &#x3D; newPropsValue</span><br><span class="line">      &#125; else if (propName !&#x3D;&#x3D; &quot;children&quot;) &#123;</span><br><span class="line">        if (propName &#x3D;&#x3D;&#x3D; &quot;className&quot;) &#123;</span><br><span class="line">          newElement.setAttribute(&quot;class&quot;, newPropsValue)</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          newElement.setAttribute(propName, newPropsValue)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  &#x2F;&#x2F; 判断属性被删除的情况</span><br><span class="line">  Object.keys(oldProps).forEach(propName &#x3D;&gt; &#123;</span><br><span class="line">    const newPropsValue &#x3D; newProps[propName]</span><br><span class="line">    const oldPropsValue &#x3D; oldProps[propName]</span><br><span class="line">    if (!newPropsValue) &#123;</span><br><span class="line">      &#x2F;&#x2F; 属性被删除了</span><br><span class="line">      if (propName.slice(0, 2) &#x3D;&#x3D;&#x3D; &quot;on&quot;) &#123;</span><br><span class="line">        const eventName &#x3D; propName.toLowerCase().slice(2)</span><br><span class="line">        newElement.removeEventListener(eventName, oldPropsValue)</span><br><span class="line">      &#125; else if (propName !&#x3D;&#x3D; &quot;children&quot;) &#123;</span><br><span class="line">        newElement.removeAttribute(propName)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上对比的仅仅是最上层元素，上层元素对比完成以后还需要递归对比子元素</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">else if (oldVirtualDOM &amp;&amp; virtualDOM.type &#x3D;&#x3D;&#x3D; oldVirtualDOM.type) &#123;</span><br><span class="line">    &#x2F;&#x2F; 递归对比 Virtual DOM 的子元素</span><br><span class="line">    virtualDOM.children.forEach((child, i) &#x3D;&gt; &#123;</span><br><span class="line">      diff(child, oldDOM, oldDOM.childNodes[i])</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="14-更新-DOM-元素之-VirtualDOM-对比-节点类型相同的情况-二"><a href="#14-更新-DOM-元素之-VirtualDOM-对比-节点类型相同的情况-二" class="headerlink" title="14.更新 DOM 元素之 VirtualDOM 对比(节点类型相同的情况)(二)"></a>14.更新 DOM 元素之 VirtualDOM 对比(节点类型相同的情况)(二)</h3><p>略</p>
<h3 id="15-图示-VirtualDOM-比对"><a href="#15-图示-VirtualDOM-比对" class="headerlink" title="15.图示 VirtualDOM 比对"></a>15.图示 VirtualDOM 比对</h3><p>略</p>
<h3 id="16-更新-DOM-元素之-VirtualDOM-对比-节点类型不相同的情况"><a href="#16-更新-DOM-元素之-VirtualDOM-对比-节点类型不相同的情况" class="headerlink" title="16.更新 DOM 元素之 VirtualDOM 对比(节点类型不相同的情况)"></a>16.更新 DOM 元素之 VirtualDOM 对比(节点类型不相同的情况)</h3><p>当对比的元素节点类型不同时，就不需要继续对比了，直接使用新的 Virtual DOM 创建 DOM 对象，用新的 DOM 对象直接替换旧的 DOM 对象。当前这种情况要将组件刨除，组件要被单独处理。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; diff.js</span><br><span class="line">else if (</span><br><span class="line">  &#x2F;&#x2F; 如果 Virtual DOM 类型不一样</span><br><span class="line">  virtualDOM.type !&#x3D;&#x3D; oldVirtualDOM.type &amp;&amp;</span><br><span class="line">  &#x2F;&#x2F; 并且 Virtual DOM 不是组件 因为组件要单独进行处理</span><br><span class="line">  typeof virtualDOM.type !&#x3D;&#x3D; &quot;function&quot;</span><br><span class="line">) &#123;</span><br><span class="line">  &#x2F;&#x2F; 根据 Virtual DOM 创建真实 DOM 元素</span><br><span class="line">  const newDOMElement &#x3D; createDOMElement(virtualDOM)</span><br><span class="line">  &#x2F;&#x2F; 用创建出来的真实 DOM 元素 替换旧的 DOM 元素</span><br><span class="line">  oldDOM.parentNode.replaceChild(newDOMElement, oldDOM)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="17-更新-DOM-元素之删除节点"><a href="#17-更新-DOM-元素之删除节点" class="headerlink" title="17.更新 DOM 元素之删除节点"></a>17.更新 DOM 元素之删除节点</h3><p>删除节点发生在节点更新以后并且发生在同一个父节点下的所有子节点身上。</p>
<p>在节点更新完成以后，如果旧节点对象的数量多于新 VirtualDOM 节点的数量，就说明有节点需要被删除。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 获取就节点的数量</span><br><span class="line">let oldChildNodes &#x3D; oldDOM.childNodes</span><br><span class="line">&#x2F;&#x2F; 如果旧节点的数量多于要渲染的新节点的长度</span><br><span class="line">if (oldChildNodes.length &gt; virtualDOM.children.length) &#123;</span><br><span class="line">  for (</span><br><span class="line">    let i &#x3D; oldChildNodes.length - 1;</span><br><span class="line">    i &gt; virtualDOM.children.length - 1;</span><br><span class="line">    i--</span><br><span class="line">  ) &#123;</span><br><span class="line">    oldDOM.removeChild(oldChildNodes[i])</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="18-setState-方法实现类组件更新-一"><a href="#18-setState-方法实现类组件更新-一" class="headerlink" title="18.setState 方法实现类组件更新(一)"></a>18.setState 方法实现类组件更新(一)</h3><p>以下代码是要更新状态的类组件，在类组件的 state 对象中有默认的 title 状态，点击 change title 按钮调用 handleChange 方法，在 handleChange 方法中调用 this.setState 方法更改 title 的状态值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">class Alert extends TinyReact.Component &#123;</span><br><span class="line">  constructor(props) &#123;</span><br><span class="line">    super(props)</span><br><span class="line">    this.state &#x3D; &#123;</span><br><span class="line">      title: &quot;default title&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 更改 handleChange 方法中的 this 指向 让 this 指向类实例对象</span><br><span class="line">    this.handleChange &#x3D; this.handleChange.bind(this)</span><br><span class="line">  &#125;</span><br><span class="line">  handleChange() &#123;</span><br><span class="line">    &#x2F;&#x2F; 调用父类中的 setState 方法更改状态</span><br><span class="line">    this.setState(&#123;</span><br><span class="line">      title: &quot;changed title&quot;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h2&gt;&#123;this.state.title&#125;&lt;&#x2F;h2&gt;</span><br><span class="line">        &lt;p&gt;&#123;this.props.message&#125;&lt;&#x2F;p&gt;</span><br><span class="line">        &lt;button onClick&#x3D;&#123;this.handleChange&#125;&gt;change title&lt;&#x2F;button&gt;</span><br><span class="line">      &lt;&#x2F;div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>setState 方法是定义在父类 Component 中的，该方法的作用是更改子类的 state，产生一个全新的 state 对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Component.js</span><br><span class="line">export default class Component &#123;</span><br><span class="line">  constructor(props) &#123;</span><br><span class="line">    this.props &#x3D; props</span><br><span class="line">  &#125;</span><br><span class="line">  setState (state) &#123;</span><br><span class="line">    &#x2F;&#x2F; setState 方法被子类调用 此处this指向子类实例对象</span><br><span class="line">    &#x2F;&#x2F; 所以改变的是子类的 state 对象</span><br><span class="line">    this.state &#x3D; Object.assign(&#123;&#125;, this.state, state)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在子类已经可以调用父类的 setState 方法更改状态值了，当组件的 state 对象发生更改时，要调用 render 方法更新组件视图。</p>
<p>在更新组件之前，要使用更新的 Virtual DOM 对象和未更新的 Virtual DOM 进行对比找出更新的部分，达到 DOM 最小化操作的目的。</p>
<p>在 setState 方法中可以通过调用 this.render 方法获取更新后的 Virtual DOM，由于 setState 方法被子类调用，this 指向子类，所以此处调用的是子类的 render 方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Component.js</span><br><span class="line">setState(state) &#123;</span><br><span class="line">  &#x2F;&#x2F; setState 方法被子类调用 此处this指向子类</span><br><span class="line">  &#x2F;&#x2F; 所以改变的是子类的 state</span><br><span class="line">  this.state &#x3D; Object.assign(&#123;&#125;, this.state, state)</span><br><span class="line">  &#x2F;&#x2F; 通过调用 render 方法获取最新的 Virtual DOM</span><br><span class="line">  let virtualDOM &#x3D; this.render()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要实现对比，还需要获取未更新前的 Virtual DOM，按照之前的经验，我们可以从 DOM 对象中获取其对应的 Virtual  DOM 对象，未更新前的 DOM 对象实际上就是现在在页面中显示的 DOM 对象，我们只要能获取到这个 DOM 对象就可以获取到其对应的 Virtual DOM 对象了。</p>
<p>页面中的 DOM 对象要怎样获取呢？页面中的 DOM 对象是通过 mountNativeElement 方法挂载到页面中的，所以我们只需要在这个方法中调用 Component 类中的方法就可以将 DOM 对象保存在 Component 类中了。在子类调用 setState 方法的时候，在 setState 方法中再调用另一个获取 DOM 对象的方法就可以获取到之前保存的 DOM 对象了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Component.js</span><br><span class="line">&#x2F;&#x2F; 保存 DOM 对象的方法</span><br><span class="line">setDOM(dom) &#123;</span><br><span class="line">  this._dom &#x3D; dom</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; 获取 DOM 对象的方法</span><br><span class="line">getDOM() &#123;</span><br><span class="line">  return this._dom</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来我们要研究一下在 mountNativeElement 方法中如何才能调用到 setDOM 方法，要调用 setDOM 方法，必须要得到类的实例对象，所以目前的问题就是如何在 mountNativeElement 方法中得到类的实例对象，这个类指的不是Component类，因为我们在代码中并不是直接实例化的Component类，而是实例化的它的子类，由于子类继承了父类，所以在子类的实例对象中也是可以调用到 setDOM 方法的。</p>
<p>mountNativeElement 方法接收最新的 Virtual DOM 对象，如果这个 Virtual DOM 对象是类组件产生的，在产生这个 Virtual DOM 对象时一定会先得到这个类的实例对象，然后再调用实例对象下面的 render 方法进行获取。我们可以在那个时候将类组件实例对象添加到 Virtual DOM 对象的属性中，而这个 Virtual DOM 对象最终会传递给 mountNativeElement  方法，这样我们就可以在 mountNativeElement 方法中获取到组件的实例对象了，既然类组件的实例对象获取到了，我们就可以调用 setDOM 方法了。</p>
<p>在 buildClassComponent 方法中为 Virtual DOM 对象添加 component 属性， 值为类组件的实例对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">function buildClassComponent(virtualDOM) &#123;</span><br><span class="line">  const component &#x3D; new virtualDOM.type(virtualDOM.props)</span><br><span class="line">  const nextVirtualDOM &#x3D; component.render()</span><br><span class="line">  nextVirtualDOM.component &#x3D; component</span><br><span class="line">  return nextVirtualDOM</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 mountNativeElement 方法中获取组件实例对象，通过实例调用调用 setDOM 方法保存 DOM 对象，方便在对比时通过它获取它的 Virtual DOM 对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">export default function mountNativeElement(virtualDOM, container) &#123;</span><br><span class="line">  &#x2F;&#x2F; 获取组件实例对象</span><br><span class="line">  const component &#x3D; virtualDOM.component</span><br><span class="line">  &#x2F;&#x2F; 如果组件实例对象存在</span><br><span class="line">  if (component) &#123;</span><br><span class="line">    &#x2F;&#x2F; 保存 DOM 对象</span><br><span class="line">    component.setDOM(newElement)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来在 setState 方法中就可以调用 getDOM 方法获取 DOM 对象了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">setState(state) &#123;</span><br><span class="line">  this.state &#x3D; Object.assign(&#123;&#125;, this.state, state)</span><br><span class="line">  let virtualDOM &#x3D; this.render()</span><br><span class="line">  &#x2F;&#x2F; 获取页面中正在显示的 DOM 对象 通过它可以获取其对象的 Virtual DOM 对象</span><br><span class="line">  let oldDOM &#x3D; this.getDOM()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在更新前的 Virtual DOM 对象和更新后的 Virtual DOM 对象就都已经获取到了，接下来还要获取到真实 DOM 对象父级容器对象，因为在调用 diff 方法进行对比的时候需要用到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">setState(state) &#123;</span><br><span class="line">  this.state &#x3D; Object.assign(&#123;&#125;, this.state, state)</span><br><span class="line">  let virtualDOM &#x3D; this.render()</span><br><span class="line">  let oldDOM &#x3D; this.getDOM()</span><br><span class="line">  &#x2F;&#x2F; 获取真实 DOM 对象父级容器对象</span><br><span class="line">  let container &#x3D; oldDOM.parentNode</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来就可以调用 diff 方法进行比对了，比对后会按照我们之前写好的逻辑进行 DOM 对象更新，我们就可以在页面中看到效果了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">setState(state) &#123;</span><br><span class="line">    this.state &#x3D; Object.assign(&#123;&#125;, this.state, state)</span><br><span class="line">    let virtualDOM &#x3D; this.render()</span><br><span class="line">    let oldDOM &#x3D; this.getDOM()</span><br><span class="line">    let container &#x3D; oldDOM.parentNode</span><br><span class="line">    &#x2F;&#x2F; 比对</span><br><span class="line">    diff(virtualDOM, container, oldDOM)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="19-setState-方法实现类组件更新-二"><a href="#19-setState-方法实现类组件更新-二" class="headerlink" title="19.setState 方法实现类组件更新(二)"></a>19.setState 方法实现类组件更新(二)</h3><p>略</p>
<h3 id="20-组件更新之不是同一个组件的情况"><a href="#20-组件更新之不是同一个组件的情况" class="headerlink" title="20.组件更新之不是同一个组件的情况"></a>20.组件更新之不是同一个组件的情况</h3><p>在 diff 方法中判断要更新的 Virtual DOM 是否是组件。</p>
<p>如果是组件再判断要更新的组件和未更新前的组件是否是同一个组件，如果不是同一个组件就不需要做组件更新操作，直接调用 mountElement 方法将组件返回的 Virtual DOM 添加到页面中。</p>
<p>如果是同一个组件，就执行更新组件操作，其实就是将最新的 props 传递到组件中，再调用组件的render方法获取组件返回的最新的 Virtual DOM 对象，再将 Virtual DOM 对象传递给 diff 方法，让 diff 方法找出差异，从而将差异更新到真实 DOM 对象中。</p>
<p>在更新组件的过程中还要在不同阶段调用其不同的组件生命周期函数。</p>
<p>在 diff 方法中判断要更新的 Virtual DOM 是否是组件，如果是组件又分为多种情况，新增 diffComponent 方法进行处理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">else if (typeof virtualDOM.type &#x3D;&#x3D;&#x3D; &quot;function&quot;) &#123;</span><br><span class="line">  &#x2F;&#x2F; 要更新的是组件</span><br><span class="line">  &#x2F;&#x2F; 1) 组件本身的 virtualDOM 对象 通过它可以获取到组件最新的 props</span><br><span class="line">  &#x2F;&#x2F; 2) 要更新的组件的实例对象 通过它可以调用组件的生命周期函数 可以更新组件的 props 属性 可以获取到组件返回的最新的 Virtual DOM</span><br><span class="line">  &#x2F;&#x2F; 3) 要更新的 DOM 象 在更新组件时 需要在已有DOM对象的身上进行修改 实现DOM最小化操作 获取旧的 Virtual DOM 对象</span><br><span class="line">  &#x2F;&#x2F; 4) 如果要更新的组件和旧组件不是同一个组件 要直接将组件返回的 Virtual DOM 显示在页面中 此时需要 container 做为父级容器</span><br><span class="line">  diffComponent(virtualDOM, oldComponent, oldDOM, container)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 diffComponent 方法中判断要更新的组件是未更新前的组件是否是同一个组件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; diffComponent.js</span><br><span class="line">export default function diffComponent(virtualDOM, oldComponent, oldDOM, container) &#123;</span><br><span class="line">  &#x2F;&#x2F; 判断要更新的组件和未更新的组件是否是同一个组件 只需要确定两者使用的是否是同一个构造函数就可以了</span><br><span class="line">  if (isSameComponent(virtualDOM, oldComponent)) &#123;</span><br><span class="line">    &#x2F;&#x2F; 属同一个组件 做组件更新  </span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    &#x2F;&#x2F; 不是同一个组件 直接将组件内容显示在页面中</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; virtualDOM.type 更新后的组件构造函数</span><br><span class="line">&#x2F;&#x2F; oldComponent.constructor 未更新前的组件构造函数</span><br><span class="line">&#x2F;&#x2F; 两者等价就表示是同一组件</span><br><span class="line">function isSameComponent(virtualDOM, oldComponent) &#123;</span><br><span class="line">  return oldComponent &amp;&amp; virtualDOM.type &#x3D;&#x3D;&#x3D; oldComponent.constructor</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果不是同一个组件的话，就不需要执行更新组件的操作，直接将组件内容显示在页面中，替换原有内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; diffComponent.js</span><br><span class="line">else &#123;</span><br><span class="line">  &#x2F;&#x2F; 不是同一个组件 直接将组件内容显示在页面中</span><br><span class="line">  &#x2F;&#x2F; 这里为 mountElement 方法新增了一个参数 oldDOM </span><br><span class="line">  &#x2F;&#x2F; 作用是在将 DOM 对象插入到页面前 将页面中已存在的 DOM 对象删除 否则无论是旧DOM对象还是新DOM对象都会显示在页面中</span><br><span class="line">  mountElement(virtualDOM, container, oldDOM)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 mountNativeElement 方法中删除原有的旧 DOM 对象</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mountNavtiveElement.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">mountNativeElement</span>(<span class="params">virtualDOM, container, oldDOM</span>) </span>&#123;</span><br><span class="line"> <span class="comment">// 如果旧的DOM对象存在 删除</span></span><br><span class="line">  <span class="keyword">if</span> (oldDOM) &#123;</span><br><span class="line">    unmount(oldDOM)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; unmount.js</span><br><span class="line">export default function unmount(node) &#123;</span><br><span class="line">  node.remove()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果是同一个组件的话，需要执行组件更新操作，需要调用组件生命周期函数</p>
<p>先在 Component 类中添加生命周期函数，子类要使用的话直接覆盖就可以</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Component.js</span><br><span class="line">export default class Component &#123;</span><br><span class="line">  &#x2F;&#x2F; 生命周期函数</span><br><span class="line">  componentWillMount() &#123;&#125;</span><br><span class="line">  componentDidMount() &#123;&#125;</span><br><span class="line">  componentWillReceiveProps(nextProps) &#123;&#125;</span><br><span class="line">  shouldComponentUpdate(nextProps, nextState) &#123;</span><br><span class="line">    return nextProps !&#x3D; this.props || nextState !&#x3D; this.state</span><br><span class="line">  &#125;</span><br><span class="line">  componentWillUpdate(nextProps, nextState) &#123;&#125;</span><br><span class="line">  componentDidUpdate(prevProps, preState) &#123;&#125;</span><br><span class="line">  componentWillUnmount() &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新建 updateComponent 方法用于更新组件操作，并在 if 成立后调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; diffComponent.js</span><br><span class="line">if (isSameComponent(virtualDOM, oldComponent)) &#123;</span><br><span class="line">  &#x2F;&#x2F; 属同一个组件 做组件更新</span><br><span class="line">  updateComponent(virtualDOM, oldComponent, oldDOM, container)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 updateComponent 方法中调用组件的生命周期函数，更新组件获取最新 Virtual DOM，最终调用 diff 方法进行更新</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">import diff from &quot;.&#x2F;diff&quot;</span><br><span class="line"></span><br><span class="line">export default function updateComponent(</span><br><span class="line">  virtualDOM,</span><br><span class="line">  oldComponent,</span><br><span class="line">  oldDOM,</span><br><span class="line">  container</span><br><span class="line">) &#123;</span><br><span class="line">  &#x2F;&#x2F; 生命周期函数</span><br><span class="line">  oldComponent.componentWillReceiveProps(virtualDOM.props)</span><br><span class="line">  if (</span><br><span class="line">    &#x2F;&#x2F; 调用 shouldComponentUpdate 生命周期函数判断是否要执行更新操作</span><br><span class="line">    oldComponent.shouldComponentUpdate(virtualDOM.props)</span><br><span class="line">  ) &#123;</span><br><span class="line">    &#x2F;&#x2F; 将未更新的 props 保存一份</span><br><span class="line">    let prevProps &#x3D; oldComponent.props</span><br><span class="line">    &#x2F;&#x2F; 生命周期函数</span><br><span class="line">    oldComponent.componentWillUpdate(virtualDOM.props)</span><br><span class="line">    &#x2F;&#x2F; 更新组件的 props 属性 updateProps 方法定义在 Component 类型</span><br><span class="line">    oldComponent.updateProps(virtualDOM.props)</span><br><span class="line">    &#x2F;&#x2F; 因为组件的 props 已经更新 所以调用 render 方法获取最新的 Virtual DOM</span><br><span class="line">    const nextVirtualDOM &#x3D; oldComponent.render()</span><br><span class="line">    &#x2F;&#x2F; 将组件实例对象挂载到 Virtual DOM 身上</span><br><span class="line">    nextVirtualDOM.component &#x3D; oldComponent</span><br><span class="line">    &#x2F;&#x2F; 调用diff方法更新视图</span><br><span class="line">    diff(nextVirtualDOM, container, oldDOM)</span><br><span class="line">    &#x2F;&#x2F; 生命周期函数</span><br><span class="line">    oldComponent.componentDidUpdate(prevProps)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Component.js</span><br><span class="line">export default class Component &#123;</span><br><span class="line">  updateProps(props) &#123;</span><br><span class="line">    this.props &#x3D; props</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="21-组件更新之更新组件和旧组件是同一个组件的情况"><a href="#21-组件更新之更新组件和旧组件是同一个组件的情况" class="headerlink" title="21.组件更新之更新组件和旧组件是同一个组件的情况"></a>21.组件更新之更新组件和旧组件是同一个组件的情况</h3><p>略</p>
<h3 id="22-实现-ref-属性获取元素-DOM-对象获取组件实例对象"><a href="#22-实现-ref-属性获取元素-DOM-对象获取组件实例对象" class="headerlink" title="22.实现 ref 属性获取元素 DOM 对象获取组件实例对象"></a>22.实现 ref 属性获取元素 DOM 对象获取组件实例对象</h3><p>为节点添加 ref 属性可以获取到这个节点的 DOM 对象，比如在 DemoRef 类中，为 input 元素添加了 ref 属性，目的是获取 input DOM 元素对象，在点击按钮时获取用户在文本框中输入的内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">class DemoRef extends TinyReact.Component &#123;</span><br><span class="line">  handle() &#123;</span><br><span class="line">    let value &#x3D; this.input.value</span><br><span class="line">    console.log(value)</span><br><span class="line">  &#125;</span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;input type&#x3D;&quot;text&quot; ref&#x3D;&#123;input &#x3D;&gt; (this.input &#x3D; input)&#125; &#x2F;&gt;</span><br><span class="line">        &lt;button onClick&#x3D;&#123;this.handle.bind(this)&#125;&gt;按钮&lt;&#x2F;button&gt;</span><br><span class="line">      &lt;&#x2F;div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实现思路是在创建节点时判断其 Virtual DOM 对象中是否有 ref 属性，如果有就调用 ref 属性中所存储的方法并且将创建出来的DOM对象作为参数传递给 ref 方法，这样在渲染组件节点的时候就可以拿到元素对象并将元素对象存储为组件属性了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; createDOMElement.js</span><br><span class="line">if (virtualDOM.props &amp;&amp; virtualDOM.props.ref) &#123;</span><br><span class="line">  virtualDOM.props.ref(newElement)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在类组件的身上也可以添加 ref 属性，目的是获取组件的实例对象，比如下列代码中，在 DemoRef 组件中渲染了 Alert 组件，在 Alert 组件中添加了 ref 属性，目的是在 DemoRef 组件中获取 Alert 组件实例对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">class DemoRef extends TinyReact.Component &#123;</span><br><span class="line">  handle() &#123;</span><br><span class="line">    let value &#x3D; this.input.value</span><br><span class="line">    console.log(value)</span><br><span class="line">    console.log(this.alert)</span><br><span class="line">  &#125;</span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    console.log(&quot;componentDidMount&quot;)</span><br><span class="line">  &#125;</span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;input type&#x3D;&quot;text&quot; ref&#x3D;&#123;input &#x3D;&gt; (this.input &#x3D; input)&#125; &#x2F;&gt;</span><br><span class="line">        &lt;button onClick&#x3D;&#123;this.handle.bind(this)&#125;&gt;按钮&lt;&#x2F;button&gt;</span><br><span class="line">        &lt;Alert ref&#x3D;&#123;alert &#x3D;&gt; (this.alert &#x3D; alert)&#125; &#x2F;&gt;</span><br><span class="line">      &lt;&#x2F;div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实现思路是在 mountComponent 方法中，如果判断了当前处理的是类组件，就通过类组件返回的 Virtual DOM 对象中获取组件实例对象，判断组件实例对象中的 props 属性中是否存在 ref 属性，如果存在就调用 ref 方法并且将组件实例对象传递给 ref 方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; mountComponent.js</span><br><span class="line">let component &#x3D; null</span><br><span class="line">  if (isFunctionalComponent(virtualDOM)) &#123;&#125;</span><br><span class="line">	else &#123;</span><br><span class="line">    &#x2F;&#x2F; 类组件</span><br><span class="line">    nextVirtualDOM &#x3D; buildStatefulComponent(virtualDOM)</span><br><span class="line">    &#x2F;&#x2F; 获取组件实例对象</span><br><span class="line">    component &#x3D; nextVirtualDOM.component</span><br><span class="line">  &#125;</span><br><span class="line">	&#x2F;&#x2F; 如果组件实例对象存在的话</span><br><span class="line">	if (component) &#123;</span><br><span class="line">   	&#x2F;&#x2F; 判断组件实例对象身上是否有 props 属性 props 属性中是否有 ref 属性</span><br><span class="line">    if (component.props &amp;&amp; component.props.ref) &#123;</span><br><span class="line">      &#x2F;&#x2F; 调用 ref 方法并传递组件实例对象</span><br><span class="line">      component.props.ref(component)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>代码走到这，顺便处理一下组件挂载完成的生命周期函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 如果组件实例对象存在的话</span><br><span class="line">if (component) &#123;</span><br><span class="line">  component.componentDidMount()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="23-使用-key-属性进行节点对比-一"><a href="#23-使用-key-属性进行节点对比-一" class="headerlink" title="23.使用 key 属性进行节点对比(一)"></a>23.使用 key 属性进行节点对比(一)</h3><p>在 React 中，渲染列表数据时通常会在被渲染的列表元素上添加 key 属性，key 属性就是数据的唯一标识，帮助 React 识别哪些数据被修改或者删除了，从而达到 DOM 最小化操作的目的。</p>
<p>key 属性不需要全局唯一，但是在同一个父节点下的兄弟节点之间必须是唯一的。</p>
<p>也就是说，在比对同一个父节点下类型相同的子节点时需要用到 key 属性。</p>
<h3 id="24-使用-key-属性进行节点对比-二"><a href="#24-使用-key-属性进行节点对比-二" class="headerlink" title="24.使用 key 属性进行节点对比(二)"></a>24.使用 key 属性进行节点对比(二)</h3><p>略</p>
<h3 id="25-删除节点-一"><a href="#25-删除节点-一" class="headerlink" title="25.删除节点(一)"></a>25.删除节点(一)</h3><p>实现思路是在两个元素进行比对时，如果类型相同，就循环旧的 DOM 对象的子元素，查看其身上是否有key 属性，如果有就将这个子元素的 DOM 对象存储在一个 JavaScript 对象中，接着循环要渲染的 Virtual DOM 对象的子元素，在循环过程中获取到这个子元素的 key 属性，然后使用这个 key 属性到 JavaScript 对象中查找 DOM 对象，如果能够找到就说明这个元素是已经存在的，是不需要重新渲染的。如果通过key属性找不到这个元素，就说明这个元素是新增的是需要渲染的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; diff.js</span><br><span class="line">else if (oldVirtualDOM &amp;&amp; virtualDOM.type &#x3D;&#x3D;&#x3D; oldVirtualDOM.type) &#123;</span><br><span class="line">  &#x2F;&#x2F; 将拥有key属性的元素放入 keyedElements 对象中</span><br><span class="line">  let keyedElements &#x3D; &#123;&#125;</span><br><span class="line">  for (let i &#x3D; 0, len &#x3D; oldDOM.childNodes.length; i &lt; len; i++) &#123;</span><br><span class="line">    let domElement &#x3D; oldDOM.childNodes[i]</span><br><span class="line">    if (domElement.nodeType &#x3D;&#x3D;&#x3D; 1) &#123;</span><br><span class="line">      let key &#x3D; domElement.getAttribute(&quot;key&quot;)</span><br><span class="line">      if (key) &#123;</span><br><span class="line">        keyedElements[key] &#x3D; domElement</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; diff.js</span><br><span class="line">&#x2F;&#x2F; 看一看是否有找到了拥有 key 属性的元素</span><br><span class="line">let hasNoKey &#x3D; Object.keys(keyedElements).length &#x3D;&#x3D;&#x3D; 0</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 如果没有找到拥有 key 属性的元素 就按照索引进行比较</span><br><span class="line">if (hasNoKey) &#123;</span><br><span class="line">  &#x2F;&#x2F; 递归对比 Virtual DOM 的子元素</span><br><span class="line">  virtualDOM.children.forEach((child, i) &#x3D;&gt; &#123;</span><br><span class="line">    diff(child, oldDOM, oldDOM.childNodes[i])</span><br><span class="line">  &#125;)</span><br><span class="line">&#125; else &#123;</span><br><span class="line">  &#x2F;&#x2F; 使用key属性进行元素比较</span><br><span class="line">  virtualDOM.children.forEach((child, i) &#x3D;&gt; &#123;</span><br><span class="line">    &#x2F;&#x2F; 获取要进行比对的元素的 key 属性</span><br><span class="line">    let key &#x3D; child.props.key</span><br><span class="line">    &#x2F;&#x2F; 如果 key 属性存在</span><br><span class="line">    if (key) &#123;</span><br><span class="line">      &#x2F;&#x2F; 到已存在的 DOM 元素对象中查找对应的 DOM 元素</span><br><span class="line">      let domElement &#x3D; keyedElements[key]</span><br><span class="line">      &#x2F;&#x2F; 如果找到元素就说明该元素已经存在 不需要重新渲染</span><br><span class="line">      if (domElement) &#123;</span><br><span class="line">        &#x2F;&#x2F; 虽然 DOM 元素不需要重新渲染 但是不能确定元素的位置就一定没有发生变化</span><br><span class="line">        &#x2F;&#x2F; 所以还要查看一下元素的位置</span><br><span class="line">        &#x2F;&#x2F; 看一下 oldDOM 对应的(i)子元素和 domElement 是否是同一个元素 如果不是就说明元素位置发生了变化</span><br><span class="line">        if (oldDOM.childNodes[i] &amp;&amp; oldDOM.childNodes[i] !&#x3D;&#x3D; domElement) &#123;</span><br><span class="line">          &#x2F;&#x2F; 元素位置发生了变化</span><br><span class="line">          &#x2F;&#x2F; 将 domElement 插入到当前元素位置的前面 oldDOM.childNodes[i] 就是当前位置</span><br><span class="line">          &#x2F;&#x2F; domElement 就被放入了当前位置</span><br><span class="line">          oldDOM.insertBefore(domElement, oldDOM.childNodes[i])</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        mountElement(child, oldDOM, oldDOM.childNodes[i])</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; mountNativeElement.js</span><br><span class="line">if (oldDOM) &#123;</span><br><span class="line">  container.insertBefore(newElement, oldDOM)</span><br><span class="line">&#125; else &#123;</span><br><span class="line">  &#x2F;&#x2F; 将转换之后的DOM对象放置在页面中</span><br><span class="line">  container.appendChild(newElement)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="26-删除节点-二"><a href="#26-删除节点-二" class="headerlink" title="26.删除节点(二)"></a>26.删除节点(二)</h3><p>在比对节点的过程中，如果旧节点的数量多于要渲染的新节点的数量就说明有节点被删除了，继续判断 keyedElements 对象中是否有元素，如果没有就使用索引方式删除，如果有就要使用 key 属性比对的方式进行删除。</p>
<p>实现思路是循环旧节点，在循环旧节点的过程中获取旧节点对应的 key 属性，然后根据 key 属性在新节点中查找这个旧节点，如果找到就说明这个节点没有被删除，如果没有找到，就说明节点被删除了，调用卸载节点的方法卸载节点即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 获取就节点的数量</span><br><span class="line">let oldChildNodes &#x3D; oldDOM.childNodes</span><br><span class="line">&#x2F;&#x2F; 如果旧节点的数量多于要渲染的新节点的长度</span><br><span class="line">if (oldChildNodes.length &gt; virtualDOM.children.length) &#123;</span><br><span class="line">  if (hasNoKey) &#123;</span><br><span class="line">    for (</span><br><span class="line">      let i &#x3D; oldChildNodes.length - 1;</span><br><span class="line">      i &gt;&#x3D; virtualDOM.children.length;</span><br><span class="line">      i--</span><br><span class="line">    ) &#123;</span><br><span class="line">      oldDOM.removeChild(oldChildNodes[i])</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    for (let i &#x3D; 0; i &lt; oldChildNodes.length; i++) &#123;</span><br><span class="line">      let oldChild &#x3D; oldChildNodes[i]</span><br><span class="line">      let oldChildKey &#x3D; oldChild._virtualDOM.props.key</span><br><span class="line">      let found &#x3D; false</span><br><span class="line">      for (let n &#x3D; 0; n &lt; virtualDOM.children.length; n++) &#123;</span><br><span class="line">        if (oldChildKey &#x3D;&#x3D;&#x3D; virtualDOM.children[n].props.key) &#123;</span><br><span class="line">          found &#x3D; true</span><br><span class="line">          break</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      if (!found) &#123;</span><br><span class="line">        unmount(oldChild)</span><br><span class="line">        i--</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>卸载节点并不是说将节点直接删除就可以了，还需要考虑以下几种情况</p>
<ol>
<li>如果要删除的节点是文本节点的话可以直接删除</li>
<li>如果要删除的节点由组件生成，需要调用组件卸载生命周期函数</li>
<li>如果要删除的节点中包含了其他组件生成的节点，需要调用其他组件的卸载生命周期函数</li>
<li>如果要删除的节点身上有 ref 属性，还需要删除通过 ref 属性传递给组件的 DOM 节点对象</li>
<li>如果要删除的节点身上有事件，需要删除事件对应的事件处理函数</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">export default function unmount(dom) &#123;</span><br><span class="line">  &#x2F;&#x2F; 获取节点对应的 virtualDOM 对象</span><br><span class="line">  const virtualDOM &#x3D; dom._virtualDOM</span><br><span class="line">  &#x2F;&#x2F; 如果要删除的节点时文本</span><br><span class="line">  if (virtualDOM.type &#x3D;&#x3D;&#x3D; &quot;text&quot;) &#123;</span><br><span class="line">    &#x2F;&#x2F; 直接删除节点</span><br><span class="line">    dom.remove()</span><br><span class="line">    &#x2F;&#x2F; 阻止程序向下运行</span><br><span class="line">    return</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; 查看节点是否由组件生成</span><br><span class="line">  let component &#x3D; virtualDOM.component</span><br><span class="line">  &#x2F;&#x2F; 如果由组件生成</span><br><span class="line">  if (component) &#123;</span><br><span class="line">    &#x2F;&#x2F; 调用组件卸载生命周期函数</span><br><span class="line">    component.componentWillUnmount()</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  &#x2F;&#x2F; 如果节点具有 ref 属性 通过再次调用 ref 方法 将传递给组件的DOM对象删除</span><br><span class="line">  if (virtualDOM.props &amp;&amp; virtualDOM.props.ref) &#123;</span><br><span class="line">    virtualDOM.props.ref(null)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 事件处理</span><br><span class="line">  Object.keys(virtualDOM.props).forEach(propName &#x3D;&gt; &#123;</span><br><span class="line">    if (propName.slice(0, 2) &#x3D;&#x3D;&#x3D; &quot;on&quot;) &#123;</span><br><span class="line">      const eventName &#x3D; propName.toLowerCase().slice(2)</span><br><span class="line">      const eventHandler &#x3D; virtualDOM.props[propName]</span><br><span class="line">      dom.removeEventListener(eventName, eventHandler)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">	</span><br><span class="line">  &#x2F;&#x2F; 递归删除子节点</span><br><span class="line">  if (dom.childNodes.length &gt; 0) &#123;</span><br><span class="line">    for (let i &#x3D; 0; i &lt; dom.childNodes.length; i++) &#123;</span><br><span class="line">      unmount(dom.childNodes[i])</span><br><span class="line">      i--</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  	</span><br><span class="line">  dom.remove()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="任务三：Fiber"><a href="#任务三：Fiber" class="headerlink" title="任务三：Fiber"></a>任务三：Fiber</h2><h3 id="1-开发环境配置-一"><a href="#1-开发环境配置-一" class="headerlink" title="1.开发环境配置(一)"></a>1.开发环境配置(一)</h3><blockquote>
<p>文件夹结构</p>
</blockquote>
<table>
<thead>
<tr>
<th>文件 / 文件夹</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>src</td>
<td>存储源文件</td>
</tr>
<tr>
<td>dist</td>
<td>存储客户端代码打包文件</td>
</tr>
<tr>
<td>build</td>
<td>存储服务端代码打包文件</td>
</tr>
<tr>
<td>server.js</td>
<td>存储服务器端代码</td>
</tr>
<tr>
<td>webpack.config.server.js</td>
<td>服务端 webpack 配置文件</td>
</tr>
<tr>
<td>webpack.config.client.js</td>
<td>客户端 webpack 配置文件</td>
</tr>
<tr>
<td>babel.config.json</td>
<td>babel 配置文件</td>
</tr>
<tr>
<td>package.json</td>
<td>项目工程文件</td>
</tr>
</tbody></table>
<p>创建 package.json 文件：<code>npm init -y</code></p>
<blockquote>
<p>安装项目依赖</p>
</blockquote>
<p>开发依赖：<code>npm install webpack webpack-cli webpack-node-externals @babel/core @babel/preset-env @babel/preset-react babel-loader nodemon npm-run-all -D</code></p>
<p>项目依赖：<code>npm install express</code></p>
<table>
<thead>
<tr>
<th>依赖项</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>webpack</td>
<td>模块打包工具</td>
</tr>
<tr>
<td>webpack-cli</td>
<td>打包命令</td>
</tr>
<tr>
<td>webpack-node-externals</td>
<td>打包服务器端模块时剔除 node_modules 文件夹中的模块</td>
</tr>
<tr>
<td>@babel/core</td>
<td>JavaScript 代码转换工具</td>
</tr>
<tr>
<td>@babel/preset-env</td>
<td>babel 预置，转换高级 JavaScript 语法</td>
</tr>
<tr>
<td>@babel/preset-react</td>
<td>babel 预置，转换 JSX 语法</td>
</tr>
<tr>
<td>babel-loader</td>
<td>webpack 中的 babel 工具加载器</td>
</tr>
<tr>
<td>nodemon</td>
<td>监控服务端文件变化，重启应用</td>
</tr>
<tr>
<td>npm-run-all</td>
<td>命令行工具，可以同时执行多个命令</td>
</tr>
<tr>
<td>express</td>
<td>基于 node 平台的 web 开发框架</td>
</tr>
</tbody></table>
<h3 id="2-开发环境配置-二"><a href="#2-开发环境配置-二" class="headerlink" title="2.开发环境配置(二)"></a>2.开发环境配置(二)</h3><blockquote>
<p>创建 web 服务器</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server.js</span></span><br><span class="line"><span class="keyword">import</span> express <span class="keyword">from</span> <span class="string">"express"</span></span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line">app.use(express.static(<span class="string">"dist"</span>))</span><br><span class="line"><span class="keyword">const</span> template = <span class="string">`</span></span><br><span class="line"><span class="string">  &lt;html&gt;</span></span><br><span class="line"><span class="string">    &lt;head&gt;</span></span><br><span class="line"><span class="string">      &lt;title&gt;React Fiber&lt;/title&gt;</span></span><br><span class="line"><span class="string">    &lt;/head&gt;</span></span><br><span class="line"><span class="string">    &lt;body&gt;</span></span><br><span class="line"><span class="string">      &lt;div id="root"&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">			&lt;script src="bundle.js"&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">    &lt;/body&gt;</span></span><br><span class="line"><span class="string">  &lt;/html&gt;</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line">app.get(<span class="string">"*"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send(template)</span><br><span class="line">&#125;)</span><br><span class="line">app.listen(<span class="number">3000</span>, () =&gt; <span class="built_in">console</span>.log(<span class="string">"server is running"</span>))</span><br></pre></td></tr></table></figure>

<blockquote>
<p>服务端 webpack 配置</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.server.js</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>)</span><br><span class="line"><span class="keyword">const</span> nodeExternals = <span class="built_in">require</span>(<span class="string">"webpack-node-externals"</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  target: <span class="string">"node"</span>,</span><br><span class="line">  mode: <span class="string">"development"</span>,</span><br><span class="line">  entry: <span class="string">"./server.js"</span>,</span><br><span class="line">  output: &#123;</span><br><span class="line">    filename: <span class="string">"server.js"</span>,</span><br><span class="line">    path: path.resolve(__dirname, <span class="string">"build"</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">        exclude: <span class="regexp">/node_modules/</span>,</span><br><span class="line">        use: &#123;</span><br><span class="line">          loader: <span class="string">"babel-loader"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  externals: [nodeExternals()]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>babel 配置</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"presets"</span>: [<span class="string">"@babel/preset-env"</span>, <span class="string">"@babel/preset-react"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-开发环境配置-三"><a href="#3-开发环境配置-三" class="headerlink" title="3.开发环境配置(三)"></a>3.开发环境配置(三)</h3><blockquote>
<p>客户端 webpack 配置</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  target: <span class="string">"web"</span>,</span><br><span class="line">  mode: <span class="string">"development"</span>,</span><br><span class="line">  entry: <span class="string">"./src/index.js"</span>,</span><br><span class="line">  output: &#123;</span><br><span class="line">    filename: <span class="string">"bundle.js"</span>,</span><br><span class="line">    path: path.resolve(__dirname, <span class="string">"dist"</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  devtool: <span class="string">"source-map"</span>,</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">        exclude: <span class="regexp">/node_modules/</span>,</span><br><span class="line">        use: &#123;</span><br><span class="line">          loader: <span class="string">"babel-loader"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>启动命令</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">"scripts": &#123;</span><br><span class="line">  "start": "npm-run-all --parallel dev:*",</span><br><span class="line">  "dev:server-compile": "webpack --config webpack.config.server.js --watch",</span><br><span class="line">  "dev:server": "nodemon ./build/server.js",</span><br><span class="line">  "dev:client-compile": "webpack --config webpack.config.client.js --watch"</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<h3 id="4-requestIdleCallback-API-介绍及浏览器空余时间说明"><a href="#4-requestIdleCallback-API-介绍及浏览器空余时间说明" class="headerlink" title="4.requestIdleCallback API 介绍及浏览器空余时间说明"></a>4.requestIdleCallback API 介绍及浏览器空余时间说明</h3><blockquote>
<p>核心 API 功能介绍</p>
</blockquote>
<p>利用浏览器的空余时间执行任务，如果有更高优先级的任务要执行时，当前执行的任务可以被终止，优先执行高级别任务。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">requestIdleCallback(<span class="function"><span class="keyword">function</span>(<span class="params">deadline</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// deadline.timeRemaining() 获取浏览器的空余时间</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>浏览器空余时间</p>
</blockquote>
<p>页面是一帧一帧绘制出来的，当每秒绘制的帧数达到 60 时，页面是流畅的，小于这个值时， 用户会感觉到卡顿</p>
<p>1s 60帧，每一帧分到的时间是 1000/60 ≈ 16 ms，如果每一帧执行的时间小于16ms，就说明浏览器有空余时间</p>
<p>如果任务在剩余的时间内没有完成则会停止任务执行，继续优先执行主任务，也就是说 requestIdleCallback 总是利用浏览器的空余时间执行任务</p>
<h3 id="5-requestIdleCallback使用方法"><a href="#5-requestIdleCallback使用方法" class="headerlink" title="5.requestIdleCallback使用方法"></a>5.requestIdleCallback使用方法</h3><p>页面中有两个按钮和一个DIV，点击第一个按钮执行一项昂贵的计算，使其长期占用主线程，当计算任务执行的时候去点击第二个按钮更改页面中 DIV 的背景颜色。</p>
<p>使用 requestIdleCallback 就可以完美解决这个卡顿问题。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"playground"</span> <span class="attr">id</span>=<span class="string">"play"</span>&gt;</span>playground<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"work"</span>&gt;</span>start work<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"interaction"</span>&gt;</span>handle some user interaction<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="selector-tag">style</span>&gt;</span><br><span class="line">  <span class="selector-class">.playground</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: palevioletred;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">10px</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> play = <span class="built_in">document</span>.getElementById(<span class="string">"play"</span>)</span><br><span class="line"><span class="keyword">var</span> workBtn = <span class="built_in">document</span>.getElementById(<span class="string">"work"</span>)</span><br><span class="line"><span class="keyword">var</span> interactionBtn = <span class="built_in">document</span>.getElementById(<span class="string">"interaction"</span>)</span><br><span class="line"><span class="keyword">var</span> iterationCount = <span class="number">100000000</span></span><br><span class="line"><span class="keyword">var</span> value = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> expensiveCalculation = <span class="function"><span class="keyword">function</span> (<span class="params">IdleDeadline</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (iterationCount &gt; <span class="number">0</span> &amp;&amp; IdleDeadline.timeRemaining() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">    value =</span><br><span class="line">      <span class="built_in">Math</span>.random() &lt; <span class="number">0.5</span> ? value + <span class="built_in">Math</span>.random() : value + <span class="built_in">Math</span>.random()</span><br><span class="line">    iterationCount = iterationCount - <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">  requestIdleCallback(expensiveCalculation)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">workBtn.addEventListener(<span class="string">"click"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  requestIdleCallback(expensiveCalculation)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">interactionBtn.addEventListener(<span class="string">"click"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  play.style.background = <span class="string">"palegreen"</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="6-旧版Stack算法存在的问题以及新版Fiber解决方案介绍"><a href="#6-旧版Stack算法存在的问题以及新版Fiber解决方案介绍" class="headerlink" title="6.旧版Stack算法存在的问题以及新版Fiber解决方案介绍"></a>6.旧版Stack算法存在的问题以及新版Fiber解决方案介绍</h3><blockquote>
<p>问题</p>
</blockquote>
<p>React 16 之前的版本比对更新 VirtualDOM 的过程是采用循环加递归实现的，这种比对方式有一个问题，就是一旦任务开始进行就无法中断，如果应用中组件数量庞大，主线程被长期占用，直到整棵 VirtualDOM 树比对更新完成之后主线程才能被释放，主线程才能执行其他任务。这就会导致一些用户交互，动画等任务无法立即得到执行，页面就会产生卡顿, 非常的影响用户体验。 </p>
<p>核心问题：递归无法中断，执行重任务耗时长。 JavaScript 又是单线程，无法同时执行其他任务，导致任务延迟页面卡顿，用户体验差。</p>
<blockquote>
<p>解决方案</p>
</blockquote>
<ol>
<li>利用浏览器空闲时间执行任务，拒绝长时间占用主线程</li>
<li>放弃递归只采用循环，因为循环可以被中断</li>
<li>任务拆分，将任务拆分成一个个的小任务</li>
</ol>
<h3 id="7-fiber算法实现思路以及fiber对象结构预览"><a href="#7-fiber算法实现思路以及fiber对象结构预览" class="headerlink" title="7.fiber算法实现思路以及fiber对象结构预览"></a>7.fiber算法实现思路以及fiber对象结构预览</h3><blockquote>
<p>实现思路</p>
</blockquote>
<p>在 Fiber 方案中，为了实现任务的终止再继续，DOM比对算法被分成了两部分：</p>
<ol>
<li>构建 Fiber        (可中断)</li>
<li>提交 Commit   (不可中断)</li>
</ol>
<p>DOM 初始渲染: virtualDOM -&gt; Fiber -&gt; Fiber[] -&gt; DOM</p>
<p>DOM 更新操作: newFiber vs oldFiber -&gt; Fiber[] -&gt; DOM</p>
<blockquote>
<p>Fiber 对象</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  type         节点类型 (元素, 文本, 组件)(具体的类型)</span><br><span class="line">  props        节点属性</span><br><span class="line">  stateNode    节点 DOM 对象 | 组件实例对象</span><br><span class="line">  tag          节点标记 (对具体类型的分类 hostRoot || hostComponent || classComponent || functionComponent)</span><br><span class="line">  effects      数组, 存储需要更改的 fiber 对象</span><br><span class="line">  effectTag    当前 Fiber 要被执行的操作 (新增, 删除, 修改)</span><br><span class="line">  parent       当前 Fiber 的父级 Fiber</span><br><span class="line">  child        当前 Fiber 的子级 Fiber</span><br><span class="line">  sibling      当前 Fiber 的下一个兄弟 Fiber</span><br><span class="line">  alternate    Fiber 备份 fiber 比对时使用</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-创建任务队列并添加任务"><a href="#8-创建任务队列并添加任务" class="headerlink" title="8.创建任务队列并添加任务"></a>8.创建任务队列并添加任务</h3><h3 id="9-实现任务的调度逻辑"><a href="#9-实现任务的调度逻辑" class="headerlink" title="9.实现任务的调度逻辑"></a>9.实现任务的调度逻辑</h3><h3 id="10-构建根节点Fiber对象"><a href="#10-构建根节点Fiber对象" class="headerlink" title="10.构建根节点Fiber对象"></a>10.构建根节点Fiber对象</h3><h3 id="11-构建子级节点Fiber对象"><a href="#11-构建子级节点Fiber对象" class="headerlink" title="11.构建子级节点Fiber对象"></a>11.构建子级节点Fiber对象</h3><h3 id="12-完善fiber对象-stateNode属性"><a href="#12-完善fiber对象-stateNode属性" class="headerlink" title="12.完善fiber对象-stateNode属性"></a>12.完善fiber对象-stateNode属性</h3><h3 id="13-完善fiber对象-tag属性"><a href="#13-完善fiber对象-tag属性" class="headerlink" title="13.完善fiber对象-tag属性"></a>13.完善fiber对象-tag属性</h3><h3 id="14-构建左侧节点树中的剩余子级节点Fiber对象"><a href="#14-构建左侧节点树中的剩余子级节点Fiber对象" class="headerlink" title="14.构建左侧节点树中的剩余子级节点Fiber对象"></a>14.构建左侧节点树中的剩余子级节点Fiber对象</h3><h3 id="15-构建剩余节点的fiber对象"><a href="#15-构建剩余节点的fiber对象" class="headerlink" title="15.构建剩余节点的fiber对象"></a>15.构建剩余节点的fiber对象</h3><h3 id="16-构建effects数组"><a href="#16-构建effects数组" class="headerlink" title="16.构建effects数组"></a>16.构建effects数组</h3><h3 id="17-fiber第二阶段-实现初始渲染"><a href="#17-fiber第二阶段-实现初始渲染" class="headerlink" title="17.fiber第二阶段-实现初始渲染"></a>17.fiber第二阶段-实现初始渲染</h3><h3 id="18-类组件处理"><a href="#18-类组件处理" class="headerlink" title="18.类组件处理"></a>18.类组件处理</h3><h3 id="19-处理函数组件"><a href="#19-处理函数组件" class="headerlink" title="19.处理函数组件"></a>19.处理函数组件</h3><h3 id="20-实现更新节点"><a href="#20-实现更新节点" class="headerlink" title="20.实现更新节点"></a>20.实现更新节点</h3><h3 id="21-扩展更新节点的方法"><a href="#21-扩展更新节点的方法" class="headerlink" title="21.扩展更新节点的方法"></a>21.扩展更新节点的方法</h3><h3 id="22-实现节点删除操作"><a href="#22-实现节点删除操作" class="headerlink" title="22.实现节点删除操作"></a>22.实现节点删除操作</h3><h3 id="23-实现类组件状态更新功能"><a href="#23-实现类组件状态更新功能" class="headerlink" title="23.实现类组件状态更新功能"></a>23.实现类组件状态更新功能</h3><h2 id="任务四：React-核心源码解读"><a href="#任务四：React-核心源码解读" class="headerlink" title="任务四：React 核心源码解读"></a>任务四：React 核心源码解读</h2><h3 id="1-搭建React源码本地调试环境"><a href="#1-搭建React源码本地调试环境" class="headerlink" title="1.搭建React源码本地调试环境"></a>1.搭建React源码本地调试环境</h3><ol>
<li><p>使用 create-react-app 脚手架创建项目</p>
<p><code>npx create-react-app react-test</code></p>
</li>
<li><p>弹射 create-react-app 脚手架内部配置</p>
<p><code>npm run eject</code></p>
</li>
<li><p>克隆 react 官方源码 (在项目的根目录下进行克隆)</p>
<p><code>git clone --branch v16.13.1 --depth=1 https://github.com/facebook/react.git src/react</code></p>
</li>
<li><p>链接本地源码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件位置: react-test/config/webpack.config.js</span></span><br><span class="line">resolve: &#123;</span><br><span class="line">  alias: &#123;</span><br><span class="line">    <span class="string">"react-native"</span>: <span class="string">"react-native-web"</span>,</span><br><span class="line">    <span class="string">"react"</span>: path.resolve(__dirname, <span class="string">"../src/react/packages/react"</span>),</span><br><span class="line">    <span class="string">"react-dom"</span>: path.resolve(__dirname, <span class="string">"../src/react/packages/react-dom"</span>),</span><br><span class="line">    <span class="string">"shared"</span>: path.resolve(__dirname, <span class="string">"../src/react/packages/shared"</span>),</span><br><span class="line">    <span class="string">"react-reconciler"</span>: path.resolve(__dirname, <span class="string">"../src/react/packages/react-reconciler"</span>),</span><br><span class="line">    <span class="string">"legacy-events"</span>: path.resolve(__dirname, <span class="string">"../src/react/packages/legacy-events"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改环境变量</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件位置: react-test/config/env.js</span></span><br><span class="line"><span class="keyword">const</span> stringified = &#123;</span><br><span class="line">	<span class="string">"process.env"</span>: <span class="built_in">Object</span>.keys(raw).reduce(<span class="function">(<span class="params">env, key</span>) =&gt;</span> &#123;</span><br><span class="line">   	env[key] = <span class="built_in">JSON</span>.stringify(raw[key])</span><br><span class="line">      <span class="keyword">return</span> env</span><br><span class="line">   &#125;, &#123;&#125;),</span><br><span class="line">   __DEV__: <span class="literal">true</span>,</span><br><span class="line">   SharedArrayBuffer: <span class="literal">true</span>,</span><br><span class="line">   spyOnDev: <span class="literal">true</span>,</span><br><span class="line">   spyOnDevAndProd: <span class="literal">true</span>,</span><br><span class="line">   spyOnProd: <span class="literal">true</span>,</span><br><span class="line">   __PROFILE__: <span class="literal">true</span>,</span><br><span class="line">   __UMD__: <span class="literal">true</span>,</span><br><span class="line">   __EXPERIMENTAL__: <span class="literal">true</span>,</span><br><span class="line">   __VARIANT__: <span class="literal">true</span>,</span><br><span class="line">   gate: <span class="literal">true</span>,</span><br><span class="line">   trustedTypes: <span class="literal">true</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>告诉 babel 在转换代码时忽略类型检查</p>
<p><code>npm install @babel/plugin-transform-flow-strip-types -D</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件位置: react-test/config/webpack.config.js [babel-loader]</span></span><br><span class="line">plugins: [</span><br><span class="line">  <span class="built_in">require</span>.resolve(<span class="string">"@babel/plugin-transform-flow-strip-types"</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>导出 HostConfig</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件位置: /react/packages/react-reconciler/src/ReactFiberHostConfig.js</span></span><br><span class="line">+ <span class="keyword">export</span> * <span class="keyword">from</span> <span class="string">'./forks/ReactFiberHostConfig.dom'</span>;</span><br><span class="line">- invariant(<span class="literal">false</span>, <span class="string">'This module must be shimmed by a specific renderer.'</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改 ReactSharedInternals.js 文件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件位置: /react/packages/shared/ReactSharedInternals.js</span></span><br><span class="line">- <span class="keyword">import</span> * <span class="keyword">as</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line">- <span class="keyword">const</span> ReactSharedInternals = React.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;</span><br><span class="line">+ <span class="keyword">import</span> ReactSharedInternals <span class="keyword">from</span> <span class="string">'../react/src/ReactSharedInternals'</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>关闭 eslint 扩展</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件位置: react/.eslingrc.js [module.exports]</span></span><br><span class="line"><span class="comment">// 删除 extends</span></span><br><span class="line">extends: [</span><br><span class="line">  <span class="string">'fbjs'</span>,</span><br><span class="line">  <span class="string">'prettier'</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>禁止 invariant 报错</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件位置: /react/packages/shared/invariant.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">invariant</span>(<span class="params">condition, format, a, b, c, d, e, f</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (condition) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">    <span class="string">'Internal React error: invariant() is meant to be replaced at compile '</span> +</span><br><span class="line">      <span class="string">'time. There is no runtime version.'</span>,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>eslint 配置</p>
<p>在 react 源码文件夹中新建 .eslintrc.json 并添加如下配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;extends&quot;: &quot;react-app&quot;,</span><br><span class="line">  &quot;globals&quot;: &#123;</span><br><span class="line">    &quot;SharedArrayBuffer&quot;: true,</span><br><span class="line">    &quot;spyOnDev&quot;: true,</span><br><span class="line">    &quot;spyOnDevAndProd&quot;: true,</span><br><span class="line">    &quot;spyOnProd&quot;: true,</span><br><span class="line">    &quot;__PROFILE__&quot;: true,</span><br><span class="line">    &quot;__UMD__&quot;: true,</span><br><span class="line">    &quot;__EXPERIMENTAL__&quot;: true,</span><br><span class="line">    &quot;__VARIANT__&quot;: true,</span><br><span class="line">    &quot;gate&quot;: true,</span><br><span class="line">    &quot;trustedTypes&quot;: true</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改 react react-dom 引入方式</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> React <span class="keyword">from</span> <span class="string">"react"</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> ReactDOM <span class="keyword">from</span> <span class="string">"react-dom"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>解决 vsCode 中 flow 报错</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"javascript.validate.enable"</span>: <span class="literal">false</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>可选项配置</p>
<p>如果你的 vscode 编辑器安装了 prettier 插件并且在保存 react 源码文件时右下角出现如下错误，按照如下步骤解决</p>
<ol>
<li><p>全局安装 prettier</p>
<p><code>npm i prettier -g</code></p>
</li>
<li><p>配置 prettier path</p>
<p>Settings &gt; Extensions &gt; Prettier &gt; Prettier path</p>
</li>
</ol>
</li>
</ol>
<ol start="15">
<li><p>__DEV__ 报错</p>
<p>删除 node_modules 文件夹，执行 npm install</p>
</li>
</ol>
<h3 id="2-JSX转换为ReactElement的过程"><a href="#2-JSX转换为ReactElement的过程" class="headerlink" title="2.JSX转换为ReactElement的过程"></a>2.JSX转换为ReactElement的过程</h3><p>JSX 被 Babel 编译为 React.createElement 方法的调用，createElement 方法在调用后返回的就是 ReactElement，就是 virtualDOM。</p>
<blockquote>
<p>createElement</p>
</blockquote>
<p><code>文件位置：packages/react/src/ReactElement.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 创建 React Element</span><br><span class="line"> * type      元素类型</span><br><span class="line"> * config    配置属性</span><br><span class="line"> * children  子元素</span><br><span class="line"> * 1. 分离 props 属性和特殊属性</span><br><span class="line"> * 2. 将子元素挂载到 props.children 中</span><br><span class="line"> * 3. 为 props 属性赋默认值 (defaultProps)</span><br><span class="line"> * 4. 创建并返回 ReactElement</span><br><span class="line"> *&#x2F;</span><br><span class="line">export function createElement(type, config, children) &#123;</span><br><span class="line">  &#x2F;**</span><br><span class="line">   * propName -&gt; 属性名称</span><br><span class="line">   * 用于后面的 for 循环</span><br><span class="line">   *&#x2F;</span><br><span class="line">  let propName;</span><br><span class="line"></span><br><span class="line">  &#x2F;**</span><br><span class="line">   * 存储 React Element 中的普通元素属性 即不包含 key ref self source</span><br><span class="line">   *&#x2F;</span><br><span class="line">  const props &#x3D; &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  &#x2F;**</span><br><span class="line">   * 待提取属性</span><br><span class="line">   * React 内部为了实现某些功能而存在的属性</span><br><span class="line">   *&#x2F;</span><br><span class="line">  let key &#x3D; null;</span><br><span class="line">  let ref &#x3D; null;</span><br><span class="line">  let self &#x3D; null;</span><br><span class="line">  let source &#x3D; null;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 如果 config 不为 null</span><br><span class="line">  if (config !&#x3D; null) &#123;</span><br><span class="line">    &#x2F;&#x2F; 如果 config 对象中有合法的 ref 属性</span><br><span class="line">    if (hasValidRef(config)) &#123;</span><br><span class="line">      &#x2F;&#x2F; 将 config.ref 属性提取到 ref 变量中</span><br><span class="line">      ref &#x3D; config.ref;</span><br><span class="line">      &#x2F;&#x2F; 在开发环境中</span><br><span class="line">      if (__DEV__) &#123;</span><br><span class="line">        &#x2F;&#x2F; 如果 ref 属性的值被设置成了字符串形式就报一个提示</span><br><span class="line">        &#x2F;&#x2F; 说明此用法在将来的版本中会被删除</span><br><span class="line">        warnIfStringRefCannotBeAutoConverted(config);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 如果在 config 对象中拥有合法的 key 属性</span><br><span class="line">    if (hasValidKey(config)) &#123;</span><br><span class="line">      &#x2F;&#x2F; 将 config.key 属性中的值提取到 key 变量中</span><br><span class="line">      key &#x3D; &#39;&#39; + config.key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    self &#x3D; config.__self &#x3D;&#x3D;&#x3D; undefined ? null : config.__self;</span><br><span class="line">    source &#x3D; config.__source &#x3D;&#x3D;&#x3D; undefined ? null : config.__source;</span><br><span class="line">    &#x2F;&#x2F; 遍历 config 对象</span><br><span class="line">    for (propName in config) &#123;</span><br><span class="line">      &#x2F;&#x2F; 如果当前遍历到的属性是对象自身属性</span><br><span class="line">      &#x2F;&#x2F; 并且在 RESERVED_PROPS 对象中不存在该属性</span><br><span class="line">      if (</span><br><span class="line">        hasOwnProperty.call(config, propName) &amp;&amp;</span><br><span class="line">        !RESERVED_PROPS.hasOwnProperty(propName)</span><br><span class="line">      ) &#123;</span><br><span class="line">        &#x2F;&#x2F; 将满足条件的属性添加到 props 对象中 (普通属性)</span><br><span class="line">        props[propName] &#x3D; config[propName];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;**</span><br><span class="line">   * 将第三个及之后的参数挂载到 props.children 属性中</span><br><span class="line">   * 如果子元素是多个 props.children 是数组</span><br><span class="line">   * 如果子元素是一个 props.children 是对象</span><br><span class="line">   *&#x2F;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 由于从第三个参数开始及以后都表示子元素</span><br><span class="line">  &#x2F;&#x2F; 所以减去前两个参数的结果就是子元素的数量</span><br><span class="line">  const childrenLength &#x3D; arguments.length - 2;</span><br><span class="line">  &#x2F;&#x2F; 如果子元素的数量是 1</span><br><span class="line">  if (childrenLength &#x3D;&#x3D;&#x3D; 1) &#123;</span><br><span class="line">    &#x2F;&#x2F; 直接将子元素挂载到到 props.children 属性上</span><br><span class="line">    &#x2F;&#x2F; 此时 children 是对象类型</span><br><span class="line">    props.children &#x3D; children;</span><br><span class="line">    &#x2F;&#x2F; 如果子元素的数量大于 1</span><br><span class="line">  &#125; else if (childrenLength &gt; 1) &#123;</span><br><span class="line">    &#x2F;&#x2F; 创建数组, 数组中元素的数量等于子元素的数量</span><br><span class="line">    const childArray &#x3D; Array(childrenLength);</span><br><span class="line">    &#x2F;&#x2F; 开启循环 循环次匹配子元素的数量</span><br><span class="line">    for (let i &#x3D; 0; i &lt; childrenLength; i++) &#123;</span><br><span class="line">      &#x2F;&#x2F; 将子元素添加到 childArray 数组中</span><br><span class="line">      &#x2F;&#x2F; i + 2 的原因是实参集合的前两个参数不是子元素</span><br><span class="line">      childArray[i] &#x3D; arguments[i + 2];</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 如果是开发环境</span><br><span class="line">    if (__DEV__) &#123;</span><br><span class="line">      &#x2F;&#x2F; 如果 Object 对象中存在 freeze 方法</span><br><span class="line">      if (Object.freeze) &#123;</span><br><span class="line">        &#x2F;&#x2F; 调用 freeze 方法 冻结 childArray 数组</span><br><span class="line">        &#x2F;&#x2F; 防止 React 核心对象被修改 冻结对象提高性能</span><br><span class="line">        Object.freeze(childArray);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 将子元素数组挂载到 props.children 属性中</span><br><span class="line">    props.children &#x3D; childArray;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;**</span><br><span class="line">   * 如果当前处理是组件</span><br><span class="line">   * 看组件身上是否有 defaultProps 属性</span><br><span class="line">   * 这个属性中存储的是 props 对象中属性的默认值</span><br><span class="line">   * 遍历 defaultProps 对象 查看对应的 props 属性的值是否为 undefined</span><br><span class="line">   * 如果为undefined 就将默认值赋值给对应的 props 属性值</span><br><span class="line">   *&#x2F;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 将 type 属性值视为函数 查看其中是否具有 defaultProps 属性</span><br><span class="line">  if (type &amp;&amp; type.defaultProps) &#123;</span><br><span class="line">    &#x2F;&#x2F; 将 type 函数下的 defaultProps 属性赋值给 defaultProps 变量</span><br><span class="line">    const defaultProps &#x3D; type.defaultProps;</span><br><span class="line">    &#x2F;&#x2F; 遍历 defaultProps 对象中的属性 将属性名称赋值给 propName 变量</span><br><span class="line">    for (propName in defaultProps) &#123;</span><br><span class="line">      &#x2F;&#x2F; 如果 props 对象中的该属性的值为 undefined</span><br><span class="line">      if (props[propName] &#x3D;&#x3D;&#x3D; undefined) &#123;</span><br><span class="line">        &#x2F;&#x2F; 将 defaultProps 对象中的对应属性的值赋值给 props 对象中的对应属性的值</span><br><span class="line">        props[propName] &#x3D; defaultProps[propName];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;**</span><br><span class="line">   * 在开发环境中 如果元素的 key 属性 或者 ref 属性存在</span><br><span class="line">   * 监测开发者是否在组件内部通过 props 对象获取了 key 属性或者 ref 属性</span><br><span class="line">   * 如果获取了 就报错</span><br><span class="line">   *&#x2F;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 如果处于开发环境</span><br><span class="line">  if (__DEV__) &#123;</span><br><span class="line">    &#x2F;&#x2F; 元素具有 key 属性或者 ref 属性</span><br><span class="line">    if (key || ref) &#123;</span><br><span class="line">      &#x2F;&#x2F; 看一下 type 属性中存储的是否是函数 如果是函数就表示当前元素是组件</span><br><span class="line">      &#x2F;&#x2F; 如果元素不是组件 就直接返回元素类型字符串</span><br><span class="line">      &#x2F;&#x2F; displayName 用于在报错过程中显示是哪一个组件报错了</span><br><span class="line">      &#x2F;&#x2F; 如果开发者显式定义了 displayName 属性 就显示开发者定义的</span><br><span class="line">      &#x2F;&#x2F; 否者就显示组件名称 如果组件也没有名称 就显示 &#39;Unknown&#39;</span><br><span class="line">      const displayName &#x3D;</span><br><span class="line">        typeof type &#x3D;&#x3D;&#x3D; &#39;function&#39;</span><br><span class="line">          ? type.displayName || type.name || &#39;Unknown&#39;</span><br><span class="line">          : type;</span><br><span class="line">      &#x2F;&#x2F; 如果 key 属性存在</span><br><span class="line">      if (key) &#123;</span><br><span class="line">        &#x2F;&#x2F; 为 props 对象添加key 属性</span><br><span class="line">        &#x2F;&#x2F; 并指定当通过 props 对象获取 key 属性时报错</span><br><span class="line">        defineKeyPropWarningGetter(props, displayName);</span><br><span class="line">      &#125;</span><br><span class="line">      &#x2F;&#x2F; 如果 ref 属性存在</span><br><span class="line">      if (ref) &#123;</span><br><span class="line">        &#x2F;&#x2F; 为 props 对象添加 ref 属性</span><br><span class="line">        &#x2F;&#x2F; 并指定当通过 props 对象获取 ref 属性时报错</span><br><span class="line">        defineRefPropWarningGetter(props, displayName);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; 返回 ReactElement</span><br><span class="line">  return ReactElement(</span><br><span class="line">    type,</span><br><span class="line">    key,</span><br><span class="line">    ref,</span><br><span class="line">    self,</span><br><span class="line">    source,</span><br><span class="line">    &#x2F;&#x2F; 在 Virtual DOM 中用于识别自定义组件</span><br><span class="line">    ReactCurrentOwner.current,</span><br><span class="line">    props,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-React检测开发者是否错误的使用了props属性"><a href="#3-React检测开发者是否错误的使用了props属性" class="headerlink" title="3.React检测开发者是否错误的使用了props属性"></a>3.React检测开发者是否错误的使用了props属性</h3><blockquote>
<p>ReactElement</p>
</blockquote>
<p><code>文件位置：packages/react/src/ReactElement.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 接收参数 返回 ReactElement</span><br><span class="line"> *&#x2F;</span><br><span class="line">const ReactElement &#x3D; function (type, key, ref, self, source, owner, props) &#123;</span><br><span class="line">  const element &#x3D; &#123;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 组件的类型, 十六进制数值或者 Symbol 值</span><br><span class="line">     * React 在最终在渲染 DOM 的时候, 需要确保元素的类型是 REACT_ELEMENT_TYPE</span><br><span class="line">     * 需要此属性作为判断的依据</span><br><span class="line">     *&#x2F;</span><br><span class="line">    $$typeof: REACT_ELEMENT_TYPE,</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 元素具体的类型值 如果是元素节点 type 属性中存储的就是 div span 等等</span><br><span class="line">     * 如果元素是组件 type 属性中存储的就是组件的构造函数</span><br><span class="line">     *&#x2F;</span><br><span class="line">    type: type,</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 元素的唯一标识</span><br><span class="line">     * 用作内部 vdom 比对 提升 DOM 操作性能</span><br><span class="line">     *&#x2F;</span><br><span class="line">    key: key,</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 存储元素 DOM 对象或者组件 实例对象</span><br><span class="line">     *&#x2F;</span><br><span class="line">    ref: ref,</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 存储向组件内部传递的数据</span><br><span class="line">     *&#x2F;</span><br><span class="line">    props: props,</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 记录当前元素所属组件 (记录当前元素是哪个组件创建的)</span><br><span class="line">     *&#x2F;</span><br><span class="line">    _owner: owner,</span><br><span class="line">  &#125;;</span><br><span class="line">  &#x2F;&#x2F; 返回 ReactElement</span><br><span class="line">  return element;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>hasValidRef</p>
</blockquote>
<p><code>文件位置：packages/react/src/ReactElement.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 查看参数对象中是否有合法的 ref 属性</span><br><span class="line"> * 返回布尔值</span><br><span class="line"> *&#x2F;</span><br><span class="line">function hasValidRef(config) &#123;</span><br><span class="line">  return config.ref !&#x3D;&#x3D; undefined;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>hasValidKey</p>
</blockquote>
<p><code>文件位置：packages/react/src/ReactElement.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 查看参数对象中是否有合法的 key 属性</span><br><span class="line"> * 返回布尔值</span><br><span class="line"> *&#x2F;</span><br><span class="line">function hasValidKey(config) &#123;</span><br><span class="line">  return config.key !&#x3D;&#x3D; undefined;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-isValidElement方法的内部实现"><a href="#4-isValidElement方法的内部实现" class="headerlink" title="4.isValidElement方法的内部实现"></a>4.isValidElement方法的内部实现</h3><blockquote>
<p>isValidElement</p>
</blockquote>
<p><code>文件位置：packages/react/src/ReactElement.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 验证 object 参数是否是 ReactElement. 返回布尔值</span><br><span class="line"> * 验证成功的条件:</span><br><span class="line"> * object 是对象</span><br><span class="line"> * object 不为null</span><br><span class="line"> * object对象中的 $$typeof 属性值为 REACT_ELEMENT_TYPE</span><br><span class="line"> *&#x2F;</span><br><span class="line">export function isValidElement(object) &#123;</span><br><span class="line">  return (</span><br><span class="line">    typeof object &#x3D;&#x3D;&#x3D; &#39;object&#39; &amp;&amp;</span><br><span class="line">    object !&#x3D;&#x3D; null &amp;&amp;</span><br><span class="line">    object.$$typeof &#x3D;&#x3D;&#x3D; REACT_ELEMENT_TYPE</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>defineKeyPropWarningGetter</p>
</blockquote>
<p><code>文件位置：packages/react/src/ReactElement.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> *  指定当通过 props 对象获取 key 属性时报错</span><br><span class="line"> *  props        组件中的 props 对象</span><br><span class="line"> *  displayName  组件名称标识</span><br><span class="line"> *&#x2F;</span><br><span class="line">function defineKeyPropWarningGetter(props, displayName) &#123;</span><br><span class="line">  &#x2F;&#x2F; 通过 props 对象获取 key 属性报错</span><br><span class="line">  const warnAboutAccessingKey &#x3D; function () &#123;</span><br><span class="line">    &#x2F;&#x2F; 在开发环境中</span><br><span class="line">    if (__DEV__) &#123;</span><br><span class="line">      &#x2F;&#x2F; specialPropKeyWarningShown 控制错误只输出一次的变量</span><br><span class="line">      if (!specialPropKeyWarningShown) &#123;</span><br><span class="line">        &#x2F;&#x2F; 通过 specialPropKeyWarningShown 变量锁住判断条件</span><br><span class="line">        specialPropKeyWarningShown &#x3D; true;</span><br><span class="line">        &#x2F;&#x2F; 指定报错信息和组件名称</span><br><span class="line">        console.error(</span><br><span class="line">          &#39;%s: &#96;key&#96; is not a prop. Trying to access it will result &#39; +</span><br><span class="line">            &#39;in &#96;undefined&#96; being returned. If you need to access the same &#39; +</span><br><span class="line">            &#39;value within the child component, you should pass it as a different &#39; +</span><br><span class="line">            &#39;prop. (https:&#x2F;&#x2F;reactjs.org&#x2F;link&#x2F;special-props)&#39;,</span><br><span class="line">          displayName,</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  warnAboutAccessingKey.isReactWarning &#x3D; true;</span><br><span class="line">  &#x2F;&#x2F; 为 props 对象添加 key 属性</span><br><span class="line">  Object.defineProperty(props, &#39;key&#39;, &#123;</span><br><span class="line">    &#x2F;&#x2F; 当获取 key 属性时调用 warnAboutAccessingKey 方法进行报错</span><br><span class="line">    get: warnAboutAccessingKey,</span><br><span class="line">    configurable: true,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>defineRefPropWarningGetter</p>
</blockquote>
<p><code>文件位置：packages/react/src/ReactElement.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> *  指定当通过 props 对象获取 ref 属性时报错</span><br><span class="line"> *  props        组件中的 props 对象</span><br><span class="line"> *  displayName  组件名称标识</span><br><span class="line"> *&#x2F;</span><br><span class="line">function defineRefPropWarningGetter(props, displayName) &#123;</span><br><span class="line">  &#x2F;&#x2F; 通过 props 对象获取 ref 属性报错</span><br><span class="line">  const warnAboutAccessingRef &#x3D; function () &#123;</span><br><span class="line">    if (__DEV__) &#123;</span><br><span class="line">      &#x2F;&#x2F; specialPropRefWarningShown 控制错误只输出一次的变量</span><br><span class="line">      if (!specialPropRefWarningShown) &#123;</span><br><span class="line">        &#x2F;&#x2F; 通过 specialPropRefWarningShown 变量锁住判断条件</span><br><span class="line">        specialPropRefWarningShown &#x3D; true;</span><br><span class="line">        &#x2F;&#x2F; 指定报错信息和组件名称</span><br><span class="line">        console.error(</span><br><span class="line">          &#39;%s: &#96;ref&#96; is not a prop. Trying to access it will result &#39; +</span><br><span class="line">            &#39;in &#96;undefined&#96; being returned. If you need to access the same &#39; +</span><br><span class="line">            &#39;value within the child component, you should pass it as a different &#39; +</span><br><span class="line">            &#39;prop. (https:&#x2F;&#x2F;reactjs.org&#x2F;link&#x2F;special-props)&#39;,</span><br><span class="line">          displayName,</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  warnAboutAccessingRef.isReactWarning &#x3D; true;</span><br><span class="line">  &#x2F;&#x2F; 为 props 对象添加 key 属性</span><br><span class="line">  Object.defineProperty(props, &#39;ref&#39;, &#123;</span><br><span class="line">    get: warnAboutAccessingRef,</span><br><span class="line">    configurable: true,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-React16版本所采用的架构"><a href="#5-React16版本所采用的架构" class="headerlink" title="5.React16版本所采用的架构"></a>5.React16版本所采用的架构</h3><blockquote>
<p>React 架构</p>
</blockquote>
<p>React 16 版本的架构可以分为三层：调度层、协调层、渲染层。</p>
<ul>
<li>Scheduler (调度层)：调度任务的优先级，高优任务优先进入协调器</li>
<li>Reconciler (协调层)：构建 Fiber 数据结构，比对 Fiber 对象找出差异, 记录 Fiber 对象要进行的 DOM 操作</li>
<li>Renderer (渲染层)：负责将发生变化的部分渲染到页面上</li>
</ul>
<blockquote>
<p>Scheduler 调度层</p>
</blockquote>
<p>在 React 15 的版本中，采用了循环加递归的方式进行了 virtualDOM 的比对，由于递归使用 JavaScript 自身的执行栈，一旦开始就无法停止，直到任务执行完成。如果 VirtualDOM 树的层级比较深，virtualDOM 的比对就会长期占用 JavaScript 主线程，由于 JavaScript 又是单线程的无法同时执行其他任务，所以在比对的过程中无法响应用户操作，无法即时执行元素动画，造成了页面卡顿的现象。</p>
<p>在 React 16 的版本中，放弃了 JavaScript 递归的方式进行 virtualDOM 的比对，而是采用循环模拟递归。而且比对的过程是利用浏览器的空闲时间完成的，不会长期占用主线程，这就解决了 virtualDOM 比对造成页面卡顿的问题。</p>
<p>在 window 对象中提供了 requestIdleCallback API，它可以利用浏览器的空闲时间执行任务，但是它自身也存在一些问题，比如说并不是所有的浏览器都支持它，而且它的触发频率也不是很稳定，所以 React 最终放弃了 requestIdleCallback 的使用。</p>
<p>在 React 中，官方实现了自己的任务调度库，这个库就叫做 Scheduler。它也可以实现在浏览器空闲时执行任务，而且还可以设置任务的优先级，高优先级任务先执行，低优先级任务后执行。</p>
<p>Scheduler 存储在 <code>packages/scheduler</code> 文件夹中。</p>
<blockquote>
<p>Reconciler 协调层</p>
</blockquote>
<p>在 React 15 的版本中，协调器和渲染器交替执行，即找到了差异就直接更新差异。在 React 16 的版本中，这种情况发生了变化，协调器和渲染器不再交替执行。协调器负责找出差异，在所有差异找出之后，统一交给渲染器进行 DOM 的更新。也就是说协调器的主要任务就是找出差异部分，并为差异打上标记。</p>
<blockquote>
<p>Renderer 渲染层</p>
</blockquote>
<p>渲染器根据协调器为 Fiber 节点打的标记，同步执行对应的DOM操作。</p>
<p>既然比对的过程从递归变成了可以中断的循环，那么 React 是如何解决中断更新时 DOM 渲染不完全的问题呢？</p>
<p>其实根本就不存在这个问题，因为在整个过程中，调度器和协调器的工作是在内存中完成的是可以被打断的，渲染器的工作被设定成不可以被打断，所以不存在DOM 渲染不完全的问题。</p>
<h3 id="6-Fiber数据结构介绍"><a href="#6-Fiber数据结构介绍" class="headerlink" title="6.Fiber数据结构介绍"></a>6.Fiber数据结构介绍</h3><blockquote>
<p>Fiber</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">type Fiber &#x3D; &#123;</span><br><span class="line">  &#x2F;************************  DOM 实例相关  *****************************&#x2F;</span><br><span class="line">  </span><br><span class="line">  &#x2F;&#x2F; 标记不同的组件类型, 值详见 WorkTag</span><br><span class="line">  tag: WorkTag,</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 组件类型 div、span、组件构造函数</span><br><span class="line">  type: any,</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 实例对象, 如类组件的实例、原生 dom 实例, 而 function 组件没有实例, 因此该属性是空</span><br><span class="line">  stateNode: any,</span><br><span class="line"> </span><br><span class="line">	&#x2F;************************  构建 Fiber 树相关  ***************************&#x2F;</span><br><span class="line">  </span><br><span class="line">  &#x2F;&#x2F; 指向自己的父级 Fiber 对象</span><br><span class="line">  return: Fiber | null,</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 指向自己的第一个子级 Fiber 对象</span><br><span class="line">  child: Fiber | null,</span><br><span class="line">  </span><br><span class="line">  &#x2F;&#x2F; 指向自己的下一个兄弟 iber 对象</span><br><span class="line">  sibling: Fiber | null,</span><br><span class="line">  </span><br><span class="line">  &#x2F;&#x2F; 在 Fiber 树更新的过程中，每个 Fiber 都会有一个跟其对应的 Fiber</span><br><span class="line">  &#x2F;&#x2F; 我们称他为 current &lt;&#x3D;&#x3D;&gt; workInProgress</span><br><span class="line">  &#x2F;&#x2F; 在渲染完成之后他们会交换位置</span><br><span class="line">  &#x2F;&#x2F; alternate 指向当前 Fiber 在 workInProgress 树中的对应 Fiber</span><br><span class="line">	alternate: Fiber | null,</span><br><span class="line">		</span><br><span class="line">  &#x2F;************************  状态数据相关  ********************************&#x2F;</span><br><span class="line">  </span><br><span class="line">  &#x2F;&#x2F; 即将更新的 props</span><br><span class="line">  pendingProps: any, </span><br><span class="line">  &#x2F;&#x2F; 旧的 props</span><br><span class="line">  memoizedProps: any,</span><br><span class="line">  &#x2F;&#x2F; 旧的 state</span><br><span class="line">  memoizedState: any,</span><br><span class="line">		</span><br><span class="line">  &#x2F;************************  副作用相关 ******************************&#x2F;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 该 Fiber 对应的组件产生的状态更新会存放在这个队列里面 </span><br><span class="line">  updateQueue: UpdateQueue&lt;any&gt; | null,</span><br><span class="line">  </span><br><span class="line">  &#x2F;&#x2F; 用来记录当前 Fiber 要执行的 DOM 操作</span><br><span class="line">  effectTag: SideEffectTag,</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 存储要执行的 DOM 操作</span><br><span class="line">  firstEffect: Fiber | null,</span><br><span class="line">  </span><br><span class="line">  &#x2F;&#x2F; 单链表用来快速查找下一个 side effect</span><br><span class="line">  nextEffect: Fiber | null,</span><br><span class="line">  </span><br><span class="line">  &#x2F;&#x2F; 存储 DOM 操作完后的副租用 比如调用生命周期函数或者钩子函数的调用</span><br><span class="line">  lastEffect: Fiber | null,</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 任务的过期时间</span><br><span class="line">  expirationTime: ExpirationTime,</span><br><span class="line">  </span><br><span class="line">	&#x2F;&#x2F; 当前组件及子组件处于何种渲染模式 详见 TypeOfMode</span><br><span class="line">  mode: TypeOfMode,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>WorkTag</p>
</blockquote>
<p><code>文件位置：packages/shared/ReactWorkTags.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">type WorkTag &#x3D;</span><br><span class="line">  | 0</span><br><span class="line">  | 1</span><br><span class="line">  | 2</span><br><span class="line">  | 3</span><br><span class="line">  | 4</span><br><span class="line">  | 5</span><br><span class="line">  | 6</span><br><span class="line">  | 7</span><br><span class="line">  | 8</span><br><span class="line">  | 9</span><br><span class="line">  | 10</span><br><span class="line">  | 11</span><br><span class="line">  | 12</span><br><span class="line">  | 13</span><br><span class="line">  | 14</span><br><span class="line">  | 15</span><br><span class="line">  | 16</span><br><span class="line">  | 17</span><br><span class="line">  | 18</span><br><span class="line">  | 19</span><br><span class="line">  | 20</span><br><span class="line">  | 21</span><br><span class="line">  | 22;</span><br><span class="line"></span><br><span class="line">export const FunctionComponent &#x3D; 0;</span><br><span class="line">export const ClassComponent &#x3D; 1;</span><br><span class="line">export const IndeterminateComponent &#x3D; 2;</span><br><span class="line">export const HostRoot &#x3D; 3;</span><br><span class="line">export const HostPortal &#x3D; 4;</span><br><span class="line">export const HostComponent &#x3D; 5;</span><br><span class="line">export const HostText &#x3D; 6;</span><br><span class="line">export const Fragment &#x3D; 7;</span><br><span class="line">export const Mode &#x3D; 8;</span><br><span class="line">export const ContextConsumer &#x3D; 9;</span><br><span class="line">export const ContextProvider &#x3D; 10;</span><br><span class="line">export const ForwardRef &#x3D; 11;</span><br><span class="line">export const Profiler &#x3D; 12;</span><br><span class="line">export const SuspenseComponent &#x3D; 13;</span><br><span class="line">export const MemoComponent &#x3D; 14;</span><br><span class="line">export const SimpleMemoComponent &#x3D; 15;</span><br><span class="line">export const LazyComponent &#x3D; 16;</span><br><span class="line">export const IncompleteClassComponent &#x3D; 17;</span><br><span class="line">export const DehydratedFragment &#x3D; 18;</span><br><span class="line">export const SuspenseListComponent &#x3D; 19;</span><br><span class="line">export const FundamentalComponent &#x3D; 20;</span><br><span class="line">export const ScopeComponent &#x3D; 21;</span><br><span class="line">export const Block &#x3D; 22;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>TypeOfMode</p>
</blockquote>
<p><code>文件位置: packages/react-reconciler/src/ReactTypeOfMode.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">export type TypeOfMode &#x3D; number;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 0 同步渲染模式</span><br><span class="line">export const NoMode &#x3D; 0b0000;</span><br><span class="line">&#x2F;&#x2F; 1 严格模式</span><br><span class="line">export const StrictMode &#x3D; 0b0001;</span><br><span class="line">&#x2F;&#x2F; 10 异步渲染过渡模式</span><br><span class="line">export const BlockingMode &#x3D; 0b0010;</span><br><span class="line">&#x2F;&#x2F; 100 异步渲染模式</span><br><span class="line">export const ConcurrentMode &#x3D; 0b0100;</span><br><span class="line">&#x2F;&#x2F; 1000 性能测试模式</span><br><span class="line">export const ProfileMode &#x3D; 0b1000;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>SideEffectTag</p>
</blockquote>
<p><code>文件位置：packages/shared/ReactSideEffectTags.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">export type SideEffectTag &#x3D; number;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Don&#39;t change these two values. They&#39;re used by React Dev Tools.</span><br><span class="line">export const NoEffect &#x3D; &#x2F;*              *&#x2F; 0b0000000000000; &#x2F;&#x2F; 0</span><br><span class="line">export const PerformedWork &#x3D; &#x2F;*         *&#x2F; 0b0000000000001; &#x2F;&#x2F; 1</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; You can change the rest (and add more).</span><br><span class="line">export const Placement &#x3D; &#x2F;*             *&#x2F; 0b0000000000010; &#x2F;&#x2F; 2</span><br><span class="line">export const Update &#x3D; &#x2F;*                *&#x2F; 0b0000000000100; &#x2F;&#x2F; 4</span><br><span class="line">export const PlacementAndUpdate &#x3D; &#x2F;*    *&#x2F; 0b0000000000110; &#x2F;&#x2F; 6</span><br><span class="line">export const Deletion &#x3D; &#x2F;*              *&#x2F; 0b0000000001000; &#x2F;&#x2F; 8</span><br><span class="line">export const ContentReset &#x3D; &#x2F;*          *&#x2F; 0b0000000010000; &#x2F;&#x2F; 16</span><br><span class="line">export const Callback &#x3D; &#x2F;*              *&#x2F; 0b0000000100000; &#x2F;&#x2F; 32</span><br><span class="line">export const DidCapture &#x3D; &#x2F;*            *&#x2F; 0b0000001000000; &#x2F;&#x2F; 64</span><br><span class="line">export const Ref &#x3D; &#x2F;*                   *&#x2F; 0b0000010000000; &#x2F;&#x2F; 128</span><br><span class="line">export const Snapshot &#x3D; &#x2F;*              *&#x2F; 0b0000100000000; &#x2F;&#x2F; 256</span><br><span class="line">export const Passive &#x3D; &#x2F;*               *&#x2F; 0b0001000000000; &#x2F;&#x2F; 512</span><br><span class="line">export const Hydrating &#x3D; &#x2F;*             *&#x2F; 0b0010000000000; &#x2F;&#x2F; 1024</span><br><span class="line">export const HydratingAndUpdate &#x3D; &#x2F;*    *&#x2F; 0b0010000000100; &#x2F;&#x2F; 1028</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Passive &amp; Update &amp; Callback &amp; Ref &amp; Snapshot</span><br><span class="line">export const LifecycleEffectMask &#x3D; &#x2F;*   *&#x2F; 0b0001110100100; &#x2F;&#x2F; 932</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Union of all host effects</span><br><span class="line">export const HostEffectMask &#x3D; &#x2F;*        *&#x2F; 0b0011111111111; &#x2F;&#x2F; 2047</span><br><span class="line"></span><br><span class="line">export const Incomplete &#x3D; &#x2F;*            *&#x2F; 0b0100000000000; &#x2F;&#x2F; 2048</span><br><span class="line">export const ShouldCapture &#x3D; &#x2F;*         *&#x2F; 0b1000000000000; &#x2F;&#x2F; 4096</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Update</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">let update: Update&lt;*&gt; &#x3D; &#123;</span><br><span class="line">  expirationTime,</span><br><span class="line">  suspenseConfig,</span><br><span class="line"></span><br><span class="line">  tag: UpdateState,</span><br><span class="line">  payload: null,</span><br><span class="line">  callback: null,</span><br><span class="line"></span><br><span class="line">  next: (null: any),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>UpdateQueue</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">const queue: &lt;State&gt; &#x3D; &#123;</span><br><span class="line">  &#x2F;&#x2F; 上一次更新之后的 state, 作为下一次更新的基础</span><br><span class="line">  baseState: fiber.memoizedState,</span><br><span class="line">  baseQueue: null,</span><br><span class="line">  shared: &#123;</span><br><span class="line">    pending: null,</span><br><span class="line">  &#125;,</span><br><span class="line">  effects: null,</span><br><span class="line">&#125;</span><br><span class="line">fiber.updateQueue &#x3D; queue;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>RootTag</p>
</blockquote>
<p><code>文件位置：packages/shared/ReactRootTags.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">export type RootTag &#x3D; 0 | 1 | 2;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; ReactDOM.render</span><br><span class="line">export const LegacyRoot &#x3D; 0;</span><br><span class="line">&#x2F;&#x2F; ReactDOM.createBlockingRoot</span><br><span class="line">export const BlockingRoot &#x3D; 1;</span><br><span class="line">&#x2F;&#x2F; ReactDOM.createRoot</span><br><span class="line">export const ConcurrentRoot &#x3D; 2;</span><br></pre></td></tr></table></figure>

<h3 id="7-双缓存技术介绍"><a href="#7-双缓存技术介绍" class="headerlink" title="7.双缓存技术介绍"></a>7.双缓存技术介绍</h3><p>在 React 中，DOM 的更新采用了双缓存技术，双缓存技术致力于更快速的 DOM 更新。</p>
<p>什么是双缓存？举个例子，使用 canvas 绘制动画时，在绘制每一帧前都会清除上一帧的画面，清除上一帧需要花费时间，如果当前帧画面计算量又比较大，又需要花费比较长的时间，这就导致上一帧清除到下一帧显示中间会有较长的间隙，就会出现白屏。</p>
<p>为了解决这个问题，我们可以在内存中绘制当前帧动画，绘制完毕后直接用当前帧替换上一帧画面，这样的话在帧画面替换的过程中就会节约非常多的时间，就不会出现白屏问题。这种在内存中构建并直接替换的技术叫做双缓存。</p>
<p>React 使用双缓存技术完成 Fiber 树的构建与替换，实现DOM对象的快速更新。</p>
<p>在 React 中最多会同时存在两棵 Fiber 树，当前在屏幕中显示的内容对应的 Fiber 树叫做 current Fiber 树，当发生更新时，React 会在内存中重新构建一颗新的 Fiber 树，这颗正在构建的 Fiber 树叫做 workInProgress Fiber 树。在双缓存技术中，workInProgress Fiber 树就是即将要显示在页面中的 Fiber 树，当这颗 Fiber 树构建完成后，React 会使用它直接替换 current Fiber 树达到快速更新 DOM 的目的，因为 workInProgress Fiber 树是在内存中构建的所以构建它的速度是非常快的。</p>
<p>一旦 workInProgress Fiber 树在屏幕上呈现，它就会变成 current Fiber 树。</p>
<p>在 current Fiber 节点对象中有一个 alternate 属性指向对应的 workInProgress Fiber 节点对象，在 workInProgress Fiber 节点中有一个 alternate 属性也指向对应的 current Fiber 节点对象。</p>
<h3 id="8-区分fiberRoot和rootFiber"><a href="#8-区分fiberRoot和rootFiber" class="headerlink" title="8.区分fiberRoot和rootFiber"></a>8.区分fiberRoot和rootFiber</h3><p>fiberRoot 表示 Fiber 数据结构对象，是 Fiber 数据结构中的最外层对象</p>
<p>rootFiber 表示组件挂载点对应的 Fiber 对象，比如 React 应用中默认的组件挂载点就是 id 为 root 的 div</p>
<p>fiberRoot 包含 rootFiber，在 fiberRoot 对象中有一个 current 属性，存储 rootFiber</p>
<p>rootFiber 指向 fiberRoot，在 rootFiber 对象中有一个 stateNode 属性，指向 fiberRoot</p>
<p>在 React 应用中 FiberRoot 只有一个，而 rootFiber 可以有多个，因为 render 方法是可以调用多次的</p>
<p>fiberRoot 会记录应用的更新信息，比如协调器在完成工作后，会将工作成果存储在 fiberRoot 中。</p>
<h3 id="9-render方法解析"><a href="#9-render方法解析" class="headerlink" title="9.render方法解析"></a>9.render方法解析</h3><p>要将 React 元素渲染到页面中，分为两个阶段，render 阶段和 commit 阶段。</p>
<p>render 阶段负责创建 Fiber 数据结构并为 Fiber 节点打标记，标记当前 Fiber 节点要进行的 DOM 操作。</p>
<p>commit 阶段负责根据 Fiber 节点标记 ( effectTag ) 进行相应的 DOM 操作。</p>
<blockquote>
<p>render</p>
</blockquote>
<p><code>文件位置：packages/react-dom/src/client/ReactDOMLegacy.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 渲染入口</span><br><span class="line"> * element 要进行渲染的 ReactElement, createElement 方法的返回值</span><br><span class="line"> * container 渲染容器 &lt;div id&#x3D;&quot;root&quot;&gt;&lt;&#x2F;div&gt;</span><br><span class="line"> * callback 渲染完成后执行的回调函数</span><br><span class="line"> *&#x2F;</span><br><span class="line">export function render(</span><br><span class="line">  element: React$Element&lt;any&gt;,</span><br><span class="line">  container: Container,</span><br><span class="line">  callback: ?Function,</span><br><span class="line">) &#123;</span><br><span class="line">  &#x2F;&#x2F; 检测 container 是否是符合要求的渲染容器</span><br><span class="line">  &#x2F;&#x2F; 即检测 container 是否是真实的DOM对象</span><br><span class="line">  &#x2F;&#x2F; 如果不符合要求就报错</span><br><span class="line">  invariant(</span><br><span class="line">    isValidContainer(container),</span><br><span class="line">    &#39;Target container is not a DOM element.&#39;,</span><br><span class="line">  );</span><br><span class="line">  return legacyRenderSubtreeIntoContainer(</span><br><span class="line">    &#x2F;&#x2F; 父组件 初始渲染没有父组件 传递 null 占位</span><br><span class="line">    null,</span><br><span class="line">    element,</span><br><span class="line">    container,</span><br><span class="line">    &#x2F;&#x2F; 是否为服务器端渲染 false 不是服务器端渲染 true 是服务器端渲染</span><br><span class="line">    false,</span><br><span class="line">    callback,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>isValidContainer</p>
</blockquote>
<p><code>文件位置：packages/react-dom/src/client/ReactDOMRoot.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 判断 node 是否是符合要求的 DOM 节点</span><br><span class="line"> * 1. node 可以是元素节点</span><br><span class="line"> * 2. node 可以是 document 节点</span><br><span class="line"> * 3. node 可以是 文档碎片节点</span><br><span class="line"> * 4. node 可以是注释节点但注释内容必须是 react-mount-point-unstable</span><br><span class="line"> * 		react 内部会找到注释节点的父级 通过调用父级元素的 insertBefore 方法, 将 element 插入到注释节点的前面</span><br><span class="line"> *&#x2F;</span><br><span class="line">export function isValidContainer(node: mixed): boolean &#123;</span><br><span class="line">  return !!(</span><br><span class="line">    node &amp;&amp;</span><br><span class="line">    (node.nodeType &#x3D;&#x3D;&#x3D; ELEMENT_NODE ||</span><br><span class="line">      node.nodeType &#x3D;&#x3D;&#x3D; DOCUMENT_NODE ||</span><br><span class="line">      node.nodeType &#x3D;&#x3D;&#x3D; DOCUMENT_FRAGMENT_NODE ||</span><br><span class="line">      (node.nodeType &#x3D;&#x3D;&#x3D; COMMENT_NODE &amp;&amp;</span><br><span class="line">        (node: any).nodeValue &#x3D;&#x3D;&#x3D; &#39; react-mount-point-unstable &#39;))</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="10-创建fiberRoot对象和rootFiber对象"><a href="#10-创建fiberRoot对象和rootFiber对象" class="headerlink" title="10.创建fiberRoot对象和rootFiber对象"></a>10.创建fiberRoot对象和rootFiber对象</h3><blockquote>
<p>legacyRenderSubtreeIntoContainer</p>
</blockquote>
<p><code>文件位置: packages/react-dom/src/client/ReactDOMLegacy.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 将子树渲染到容器中 (初始化 Fiber 数据结构: 创建 fiberRoot 及 rootFiber)</span><br><span class="line"> * parentComponent: 父组件, 初始渲染传入了 null</span><br><span class="line"> * children: render 方法中的第一个参数, 要渲染的 ReactElement</span><br><span class="line"> * container: 渲染容器</span><br><span class="line"> * forceHydrate: true 为服务端渲染, false 为客户端渲染</span><br><span class="line"> * callback: 组件渲染完成后需要执行的回调函数</span><br><span class="line"> **&#x2F;</span><br><span class="line">function legacyRenderSubtreeIntoContainer(</span><br><span class="line">  parentComponent: ?React$Component&lt;any, any&gt;,</span><br><span class="line">  children: ReactNodeList,</span><br><span class="line">  container: Container,</span><br><span class="line">  forceHydrate: boolean,</span><br><span class="line">  callback: ?Function,</span><br><span class="line">) &#123;</span><br><span class="line">  &#x2F;**</span><br><span class="line">   * 检测 container 是否已经是初始化过的渲染容器</span><br><span class="line">   * react 在初始渲染时会为最外层容器添加 _reactRootContainer 属性</span><br><span class="line">   * react 会根据此属性进行不同的渲染方式</span><br><span class="line">   * root 不存在 表示初始渲染</span><br><span class="line">   * root 存在 表示更新</span><br><span class="line">   *&#x2F;</span><br><span class="line">  &#x2F;&#x2F; 获取 container 容器对象下是否有 _reactRootContainer 属性</span><br><span class="line">  let root: RootType &#x3D; (container._reactRootContainer: any);</span><br><span class="line">  &#x2F;&#x2F; 即将存储根 Fiber 对象</span><br><span class="line">  let fiberRoot;</span><br><span class="line">  if (!root) &#123;</span><br><span class="line">    &#x2F;&#x2F; 初始渲染</span><br><span class="line">    &#x2F;&#x2F; 初始化根 Fiber 数据结构</span><br><span class="line">    &#x2F;&#x2F; 为 container 容器添加 _reactRootContainer 属性</span><br><span class="line">    &#x2F;&#x2F; 在 _reactRootContainer 对象中有一个属性叫做 _internalRoot</span><br><span class="line">    &#x2F;&#x2F; _internalRoot 属性值即为 FiberRoot 表示根节点 Fiber 数据结构</span><br><span class="line">    &#x2F;&#x2F; legacyCreateRootFromDOMContainer</span><br><span class="line">    &#x2F;&#x2F; createLegacyRoot</span><br><span class="line">    &#x2F;&#x2F; new ReactDOMBlockingRoot -&gt; this._internalRoot</span><br><span class="line">    &#x2F;&#x2F; createRootImpl</span><br><span class="line">    root &#x3D; container._reactRootContainer &#x3D; legacyCreateRootFromDOMContainer(</span><br><span class="line">      container,</span><br><span class="line">      forceHydrate,</span><br><span class="line">    );</span><br><span class="line">    &#x2F;&#x2F; 获取 Fiber Root 对象</span><br><span class="line">    fiberRoot &#x3D; root._internalRoot;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 改变 callback 函数中的 this 指向</span><br><span class="line">     * 使其指向 render 方法第一个参数的真实 DOM 对象</span><br><span class="line">     *&#x2F;</span><br><span class="line">    &#x2F;&#x2F; 如果 callback 参数是函数类型</span><br><span class="line">    if (typeof callback &#x3D;&#x3D;&#x3D; &#39;function&#39;) &#123;</span><br><span class="line">      &#x2F;&#x2F; 使用 originalCallback 存储 callback 函数</span><br><span class="line">      const originalCallback &#x3D; callback;</span><br><span class="line">      &#x2F;&#x2F; 为 callback 参数重新赋值</span><br><span class="line">      callback &#x3D; function () &#123;</span><br><span class="line">        &#x2F;&#x2F; 获取 render 方法第一个参数的真实 DOM 对象</span><br><span class="line">        &#x2F;&#x2F; 实际上就是 id&#x3D;&quot;root&quot; 的 div 的子元素</span><br><span class="line">        &#x2F;&#x2F; rootFiber.child.stateNode</span><br><span class="line">        &#x2F;&#x2F; rootFiber 就是 id&#x3D;&quot;root&quot; 的 div</span><br><span class="line">        const instance &#x3D; getPublicRootInstance(fiberRoot);</span><br><span class="line">        &#x2F;&#x2F; 调用 callback 函数并改变函数内部 this 指向</span><br><span class="line">        originalCallback.call(instance);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 初始化渲染不执行批量更新</span><br><span class="line">    &#x2F;&#x2F; 因为批量更新是异步的是可以被打断的, 但是初始化渲染应该尽快完成不能被打断</span><br><span class="line">    &#x2F;&#x2F; 所以不执行批量更新</span><br><span class="line">    unbatchedUpdates(() &#x3D;&gt; &#123;</span><br><span class="line">      updateContainer(children, fiberRoot, parentComponent, callback);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    &#x2F;&#x2F; 非初始化渲染 即更新</span><br><span class="line">    fiberRoot &#x3D; root._internalRoot;</span><br><span class="line">    if (typeof callback &#x3D;&#x3D;&#x3D; &#39;function&#39;) &#123;</span><br><span class="line">      const originalCallback &#x3D; callback;</span><br><span class="line">      callback &#x3D; function () &#123;</span><br><span class="line">        const instance &#x3D; getPublicRootInstance(fiberRoot);</span><br><span class="line">        originalCallback.call(instance);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; Update</span><br><span class="line">    updateContainer(children, fiberRoot, parentComponent, callback);</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; 返回 render 方法第一个参数的真实 DOM 对象作为 render 方法的返回值</span><br><span class="line">  &#x2F;&#x2F; 就是说渲染谁 返回谁的真实 DOM 对象</span><br><span class="line">  return getPublicRootInstance(fiberRoot);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>legacyCreateRootFromDOMContainer</p>
</blockquote>
<p><code>文件位置: packages/react-dom/src/client/ReactDOMLegacy.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 判断是否为服务器端渲染 如果不是服务器端渲染</span><br><span class="line"> * 清空 container 容器中的节点</span><br><span class="line"> *&#x2F;</span><br><span class="line">function legacyCreateRootFromDOMContainer(</span><br><span class="line">  container: Container,</span><br><span class="line">  forceHydrate: boolean,</span><br><span class="line">): RootType &#123;</span><br><span class="line">  &#x2F;&#x2F; container &#x3D;&gt; &lt;div id&#x3D;&quot;root&quot;&gt;&lt;&#x2F;div&gt;</span><br><span class="line">  &#x2F;&#x2F; 检测是否为服务器端渲染</span><br><span class="line">  const shouldHydrate &#x3D;</span><br><span class="line">    forceHydrate || shouldHydrateDueToLegacyHeuristic(container);</span><br><span class="line">  &#x2F;&#x2F; 如果不是服务器端渲染</span><br><span class="line">  if (!shouldHydrate) &#123;</span><br><span class="line">    let rootSibling;</span><br><span class="line">    &#x2F;&#x2F; 开启循环 删除 container 容器中的节点</span><br><span class="line">    while ((rootSibling &#x3D; container.lastChild)) &#123;</span><br><span class="line">      &#x2F;&#x2F; 删除 container 容器中的节点</span><br><span class="line">      container.removeChild(rootSibling);</span><br><span class="line">      &#x2F;**</span><br><span class="line">       * 为什么要清除 container 中的元素 ?</span><br><span class="line">       * 为提供首屏加载的用户体验, 有时需要在 container 中放置一些占位图或者 loading 图</span><br><span class="line">       * 就无可避免的要向 container 中加入 html 标记.</span><br><span class="line">       * 在将 ReactElement 渲染到 container 之前, 必然要先清空 container</span><br><span class="line">       * 因为占位图和 ReactElement 不能同时显示</span><br><span class="line">       *</span><br><span class="line">       * 在加入占位代码时, 最好只有一个父级元素, 可以减少内部代码的循环次数以提高性能</span><br><span class="line">       * &lt;div&gt;</span><br><span class="line">       *  &lt;p&gt;placement&lt;p&gt;</span><br><span class="line">       *  &lt;p&gt;placement&lt;p&gt;</span><br><span class="line">       *  &lt;p&gt;placement&lt;p&gt;</span><br><span class="line">       * &lt;&#x2F;div&gt;</span><br><span class="line">       *&#x2F;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return createLegacyRoot(</span><br><span class="line">    container,</span><br><span class="line">    shouldHydrate</span><br><span class="line">      ? &#123;</span><br><span class="line">          hydrate: true,</span><br><span class="line">        &#125;</span><br><span class="line">      : undefined,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>createLegacyRoot</p>
</blockquote>
<p><code>文件位置: packages/react-dom/src/client/ReactDOMRoot.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 通过实例化 ReactDOMBlockingRoot 类创建 LegacyRoot</span><br><span class="line"> *&#x2F;</span><br><span class="line">export function createLegacyRoot(</span><br><span class="line">  container: Container,</span><br><span class="line">  options?: RootOptions,</span><br><span class="line">): RootType &#123;</span><br><span class="line">  &#x2F;&#x2F; container &#x3D;&gt; &lt;div id&#x3D;&quot;root&quot;&gt;&lt;&#x2F;div&gt;</span><br><span class="line">  &#x2F;&#x2F; LegacyRoot 常量, 值为 0,</span><br><span class="line">  &#x2F;&#x2F; 通过 render 方法创建的 container 就是 LegacyRoot</span><br><span class="line">  return new ReactDOMBlockingRoot(container, LegacyRoot, options);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ReactDOMBlockingRoot</p>
</blockquote>
<p><code>文件位置: packages/react-dom/src/client/ReactDOMRoot.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 类, 通过它可以创建 LegacyRoot 的 Fiber 数据结构</span><br><span class="line"> *&#x2F;</span><br><span class="line">function ReactDOMBlockingRoot(</span><br><span class="line">  container: Container,</span><br><span class="line">  tag: RootTag,</span><br><span class="line">  options: void | RootOptions,</span><br><span class="line">) &#123;</span><br><span class="line">  &#x2F;&#x2F; tag &#x3D;&gt; 0 &#x3D;&gt; legacyRoot</span><br><span class="line">  &#x2F;&#x2F; container &#x3D;&gt; &lt;div id&#x3D;&quot;root&quot;&gt;&lt;&#x2F;div&gt;</span><br><span class="line">  &#x2F;&#x2F; container._reactRootContainer &#x3D; &#123;_internalRoot: &#123;&#125;&#125;</span><br><span class="line">  this._internalRoot &#x3D; createRootImpl(container, tag, options);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>createRootImpl</p>
</blockquote>
<p><code>文件位置: packages/react-dom/src/client/ReactDOMRoot.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">function createRootImpl(</span><br><span class="line">  container: Container,</span><br><span class="line">  tag: RootTag,</span><br><span class="line">  options: void | RootOptions,</span><br><span class="line">) &#123;</span><br><span class="line">  &#x2F;&#x2F; container &#x3D;&gt; &lt;div id&#x3D;&quot;root&quot;&gt;&lt;&#x2F;div&gt;</span><br><span class="line">  &#x2F;&#x2F; tag &#x3D;&gt; 0</span><br><span class="line">  &#x2F;&#x2F; options &#x3D;&gt; undefined</span><br><span class="line">  const root &#x3D; createContainer(container, tag, hydrate, hydrationCallbacks);</span><br><span class="line">  markContainerAsRoot(root.current, container);</span><br><span class="line">  return root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>createContainer</p>
</blockquote>
<p><code>文件位置: packages/react-reconciler/src/ReactFiberReconciler.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 创建 container</span><br><span class="line">export function createContainer(</span><br><span class="line">  containerInfo: Container,</span><br><span class="line">  tag: RootTag,</span><br><span class="line">  hydrate: boolean,</span><br><span class="line">  hydrationCallbacks: null | SuspenseHydrationCallbacks,</span><br><span class="line">): OpaqueRoot &#123;</span><br><span class="line">  &#x2F;&#x2F; containerInfo &#x3D;&gt; &lt;div id&#x3D;&quot;root&quot;&gt;&lt;&#x2F;div&gt;</span><br><span class="line">  &#x2F;&#x2F; tag: 0</span><br><span class="line">  &#x2F;&#x2F; hydrate: false</span><br><span class="line">  &#x2F;&#x2F; hydrationCallbacks: null</span><br><span class="line">  &#x2F;&#x2F; 忽略了和服务器端渲染相关的内容</span><br><span class="line">  return createFiberRoot(containerInfo, tag, hydrate, hydrationCallbacks);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>createFiberRoot</p>
</blockquote>
<p><code>文件位置: packages/react-reconciler/src/ReactFiberRoot.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 创建根节点对应的 fiber 对象</span><br><span class="line">export function createFiberRoot(</span><br><span class="line">  containerInfo: any,</span><br><span class="line">  tag: RootTag,</span><br><span class="line">  hydrate: boolean,</span><br><span class="line">  hydrationCallbacks: null | SuspenseHydrationCallbacks,</span><br><span class="line">): FiberRoot &#123;</span><br><span class="line">  &#x2F;&#x2F; 创建 FiberRoot</span><br><span class="line">  const root: FiberRoot &#x3D; (new FiberRootNode(containerInfo, tag, hydrate): any);</span><br><span class="line">  &#x2F;&#x2F; 创建根节点对应的 rootFiber</span><br><span class="line">  const uninitializedFiber &#x3D; createHostRootFiber(tag);</span><br><span class="line">  &#x2F;&#x2F; 为 fiberRoot 添加 current 属性 值为 rootFiber</span><br><span class="line">  root.current &#x3D; uninitializedFiber;</span><br><span class="line">  &#x2F;&#x2F; 为 rootFiber 添加 stateNode 属性 值为 fiberRoot</span><br><span class="line">  uninitializedFiber.stateNode &#x3D; root;</span><br><span class="line">  &#x2F;&#x2F; 为 fiber 对象添加 updateQueue 属性, 初始化 updateQueue 对象</span><br><span class="line">  &#x2F;&#x2F; updateQueue 用于存放 Update 对象</span><br><span class="line">  &#x2F;&#x2F; Update 对象用于记录组件状态的改变</span><br><span class="line">  initializeUpdateQueue(uninitializedFiber);</span><br><span class="line">  &#x2F;&#x2F; 返回 root</span><br><span class="line">  return root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>FiberRootNode</p>
</blockquote>
<p><code>文件位置: packages/react-reconciler/src/ReactFiberRoot.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">function FiberRootNode(containerInfo, tag, hydrate) &#123;</span><br><span class="line">  this.tag &#x3D; tag;</span><br><span class="line">  this.current &#x3D; null;</span><br><span class="line">  this.containerInfo &#x3D; containerInfo;</span><br><span class="line">  this.pendingChildren &#x3D; null;</span><br><span class="line">  this.pingCache &#x3D; null;</span><br><span class="line">  this.finishedExpirationTime &#x3D; NoWork;</span><br><span class="line">  this.finishedWork &#x3D; null;</span><br><span class="line">  this.timeoutHandle &#x3D; noTimeout;</span><br><span class="line">  this.context &#x3D; null;</span><br><span class="line">  this.pendingContext &#x3D; null;</span><br><span class="line">  this.hydrate &#x3D; hydrate;</span><br><span class="line">  this.callbackNode &#x3D; null;</span><br><span class="line">  this.callbackPriority &#x3D; NoPriority;</span><br><span class="line">  this.firstPendingTime &#x3D; NoWork;</span><br><span class="line">  this.firstSuspendedTime &#x3D; NoWork;</span><br><span class="line">  this.lastSuspendedTime &#x3D; NoWork;</span><br><span class="line">  this.nextKnownPendingLevel &#x3D; NoWork;</span><br><span class="line">  this.lastPingedTime &#x3D; NoWork;</span><br><span class="line">  this.lastExpiredTime &#x3D; NoWork;</span><br><span class="line">  if (enableSchedulerTracing) &#123;</span><br><span class="line">    this.interactionThreadID &#x3D; unstable_getThreadID();</span><br><span class="line">    this.memoizedInteractions &#x3D; new Set();</span><br><span class="line">    this.pendingInteractionMap &#x3D; new Map();</span><br><span class="line">  &#125;</span><br><span class="line">  if (enableSuspenseCallback) &#123;</span><br><span class="line">    this.hydrationCallbacks &#x3D; null;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>initializeUpdateQueue</p>
</blockquote>
<p><code>文件位置: packages/react-reconciler/src/ReactFiberRoot.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">export function initializeUpdateQueue&lt;State&gt;(fiber: Fiber): void &#123;</span><br><span class="line">  const queue: UpdateQueue&lt;State&gt; &#x3D; &#123;</span><br><span class="line">    baseState: fiber.memoizedState,</span><br><span class="line">    baseQueue: null,</span><br><span class="line">    shared: &#123;</span><br><span class="line">      pending: null,</span><br><span class="line">    &#125;,</span><br><span class="line">    effects: null,</span><br><span class="line">  &#125;;</span><br><span class="line">  fiber.updateQueue &#x3D; queue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="11-更改-callback-函数内部-this-指向"><a href="#11-更改-callback-函数内部-this-指向" class="headerlink" title="11.更改 callback 函数内部 this 指向"></a>11.更改 callback 函数内部 this 指向</h3><blockquote>
<p> getPublicRootInstance</p>
</blockquote>
<p><code>文件位置: packages/react-reconciler/src/ReactFiberReconciler.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 获取 container 的第一个子元素的实例对象</span><br><span class="line"> *&#x2F;</span><br><span class="line">export function getPublicRootInstance(</span><br><span class="line">  &#x2F;&#x2F; FiberRoot</span><br><span class="line">  container: OpaqueRoot,</span><br><span class="line">): React$Component&lt;any, any&gt; | PublicInstance | null &#123;</span><br><span class="line">  &#x2F;&#x2F; 获取 rootFiber</span><br><span class="line">  const containerFiber &#x3D; container.current;</span><br><span class="line">  &#x2F;&#x2F; 如果 rootFiber 没有子元素</span><br><span class="line">  &#x2F;&#x2F; 指的就是 id&#x3D;&quot;root&quot; 的 div 没有子元素</span><br><span class="line">  if (!containerFiber.child) &#123;</span><br><span class="line">    &#x2F;&#x2F; 返回 null</span><br><span class="line">    return null;</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; 匹配子元素的类型</span><br><span class="line">  switch (containerFiber.child.tag) &#123;</span><br><span class="line">    &#x2F;&#x2F; 普通</span><br><span class="line">    case HostComponent:</span><br><span class="line">      return getPublicInstance(containerFiber.child.stateNode);</span><br><span class="line">    default:</span><br><span class="line">      &#x2F;&#x2F; 返回子元素的真实 DOM 对象</span><br><span class="line">      return containerFiber.child.stateNode;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>getPublicInstance</p>
</blockquote>
<p><code>文件位置: packages/react-dom/src/client/ReactDOMHostConfig.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export function getPublicInstance(instance: Instance): * &#123;</span><br><span class="line">  return instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="12-创建任务并存放于任务队列"><a href="#12-创建任务并存放于任务队列" class="headerlink" title="12.创建任务并存放于任务队列"></a>12.创建任务并存放于任务队列</h3><blockquote>
<p>updateContainer</p>
</blockquote>
<p><code>文件位置: packages/react-reconciler/src/ReactFiberReconciler.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 计算任务的过期时间</span><br><span class="line"> * 再根据任务过期时间创建 Update 任务</span><br><span class="line"> *&#x2F;</span><br><span class="line">export function updateContainer(</span><br><span class="line">	&#x2F;&#x2F; element 要渲染的 ReactElement</span><br><span class="line">  element: ReactNodeList,</span><br><span class="line">  &#x2F;&#x2F; container Fiber Root 对象</span><br><span class="line">  container: OpaqueRoot,</span><br><span class="line">  &#x2F;&#x2F; parentComponent 父组件 初始渲染为 null</span><br><span class="line">  parentComponent: ?React$Component&lt;any, any&gt;,</span><br><span class="line">  &#x2F;&#x2F; ReactElement 渲染完成执行的回调函数</span><br><span class="line">  callback: ?Function,</span><br><span class="line">): ExpirationTime &#123;  </span><br><span class="line">  &#x2F;&#x2F; container 获取 rootFiber</span><br><span class="line">  const current &#x3D; container.current;</span><br><span class="line">  &#x2F;&#x2F; 获取当前距离 react 应用初始化的时间 1073741805</span><br><span class="line">  const currentTime &#x3D; requestCurrentTimeForUpdate();</span><br><span class="line">  &#x2F;&#x2F; 异步加载设置</span><br><span class="line">  const suspenseConfig &#x3D; requestCurrentSuspenseConfig();</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 计算过期时间</span><br><span class="line">  &#x2F;&#x2F; 为防止任务因为优先级的原因一直被打断而未能执行</span><br><span class="line">  &#x2F;&#x2F; react 会设置一个过期时间, 当时间到了过期时间的时候</span><br><span class="line">  &#x2F;&#x2F; 如果任务还未执行的话, react 将会强制执行该任务</span><br><span class="line">  &#x2F;&#x2F; 初始化渲染时, 任务同步执行不涉及被打断的问题 1073741823</span><br><span class="line">  const expirationTime &#x3D; computeExpirationForFiber(</span><br><span class="line">    currentTime,</span><br><span class="line">    current,</span><br><span class="line">    suspenseConfig,</span><br><span class="line">  );</span><br><span class="line">  &#x2F;&#x2F; 设置FiberRoot.context, 首次执行返回一个emptyContext, 是一个 &#123;&#125;</span><br><span class="line">  const context &#x3D; getContextForSubtree(parentComponent);</span><br><span class="line">  &#x2F;&#x2F; 初始渲染时 Fiber Root 对象中的 context 属性值为 null</span><br><span class="line">  &#x2F;&#x2F; 所以会进入到 if 中</span><br><span class="line">  if (container.context &#x3D;&#x3D;&#x3D; null) &#123;</span><br><span class="line">    &#x2F;&#x2F; 初始渲染时将 context 属性值设置为 &#123;&#125;</span><br><span class="line">    container.context &#x3D; context;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    container.pendingContext &#x3D; context;</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; 创建一个待执行任务</span><br><span class="line">  const update &#x3D; createUpdate(expirationTime, suspenseConfig);</span><br><span class="line">  &#x2F;&#x2F; 将要更新的内容挂载到更新对象中的 payload 中</span><br><span class="line">  &#x2F;&#x2F; 将要更新的组件存储在 payload 对象中, 方便后期获取</span><br><span class="line">  update.payload &#x3D; &#123;element&#125;;</span><br><span class="line">  &#x2F;&#x2F; 判断 callback 是否存在</span><br><span class="line">  callback &#x3D; callback &#x3D;&#x3D;&#x3D; undefined ? null : callback;</span><br><span class="line">  &#x2F;&#x2F; 如果 callback 存在</span><br><span class="line">  if (callback !&#x3D;&#x3D; null) &#123;</span><br><span class="line">    &#x2F;&#x2F; 将 callback 挂载到 update 对象中</span><br><span class="line">    &#x2F;&#x2F; 其实就是一层层传递 方便 ReactElement 元素渲染完成调用</span><br><span class="line">    &#x2F;&#x2F; 回调函数执行完成后会被清除 可以在代码的后面加上 return 进行验证</span><br><span class="line">    update.callback &#x3D; callback;</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; 将 update 对象加入到当前 Fiber 的更新队列当中 (updateQueue)</span><br><span class="line">  enqueueUpdate(current, update);</span><br><span class="line">  &#x2F;&#x2F; 调度和更新 current 对象</span><br><span class="line">  scheduleWork(current, expirationTime);</span><br><span class="line">  &#x2F;&#x2F; 返回过期时间</span><br><span class="line">  return expirationTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>enqueueUpdate</p>
</blockquote>
<p><code>文件位置: packages/react-reconciler/src/ReactUpdateQueue.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 将任务(Update)存放于任务队列(updateQueue)中</span><br><span class="line">&#x2F;&#x2F; 创建单向链表结构存放 update, next 用来串联 update</span><br><span class="line">export function enqueueUpdate&lt;State&gt;(fiber: Fiber, update: Update&lt;State&gt;) &#123;</span><br><span class="line">  &#x2F;&#x2F; 获取当前 Fiber 的 更新队列</span><br><span class="line">  const updateQueue &#x3D; fiber.updateQueue;</span><br><span class="line">  &#x2F;&#x2F; 如果更新队列不存在 就返回 null</span><br><span class="line">  if (updateQueue &#x3D;&#x3D;&#x3D; null) &#123;</span><br><span class="line">    &#x2F;&#x2F; 仅发生在 fiber 已经被卸载</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; 获取待执行的 Update 任务</span><br><span class="line">  &#x2F;&#x2F; 初始渲染时没有待执行的任务</span><br><span class="line">  const sharedQueue &#x3D; updateQueue.shared;</span><br><span class="line">  const pending &#x3D; sharedQueue.pending;</span><br><span class="line">  &#x2F;&#x2F; 如果没有待执行的 Update 任务</span><br><span class="line">  if (pending &#x3D;&#x3D;&#x3D; null) &#123;</span><br><span class="line">    &#x2F;&#x2F; 这是第一次更新, 创建一个循环列表.</span><br><span class="line">    update.next &#x3D; update;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    update.next &#x3D; pending.next;</span><br><span class="line">    pending.next &#x3D; update;</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; 将 Update 任务存储在 pending 属性中</span><br><span class="line">  sharedQueue.pending &#x3D; update;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="13-任务执行前的准备工作"><a href="#13-任务执行前的准备工作" class="headerlink" title="13.任务执行前的准备工作"></a>13.任务执行前的准备工作</h3><blockquote>
<p>scheduleUpdateOnFiber</p>
</blockquote>
<p><code>文件位置: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 判断任务是否为同步 调用同步任务入口</span><br><span class="line"> *&#x2F;</span><br><span class="line">export function scheduleUpdateOnFiber(</span><br><span class="line">  &#x2F;&#x2F; rootFiber</span><br><span class="line">  fiber: Fiber,</span><br><span class="line">  expirationTime: ExpirationTime,</span><br><span class="line">) &#123;</span><br><span class="line">  &#x2F;**</span><br><span class="line">   * fiber: 初始化渲染时为 rootFiber, 即 &lt;div id&#x3D;&quot;root&quot;&gt;&lt;&#x2F;div&gt; 对应的 Fiber 对象</span><br><span class="line">   * expirationTime: 任务过期时间 &#x3D;&gt;1073741823</span><br><span class="line">   *&#x2F;</span><br><span class="line">  &#x2F;**</span><br><span class="line">   * 判断是否是无限循环的 update 如果是就报错</span><br><span class="line">   * 在 componentWillUpdate 或者 componentDidUpdate 生命周期函数中重复调用</span><br><span class="line">   * setState 方法时, 可能会发生这种情况, React 限制了嵌套更新的数量以防止无限循环</span><br><span class="line">   * 限制的嵌套更新数量为 50, 可通过 NESTED_UPDATE_LIMIT 全局变量获取</span><br><span class="line">   *&#x2F;</span><br><span class="line">  checkForNestedUpdates();</span><br><span class="line">  &#x2F;&#x2F; 判断任务是否是同步任务 Sync的值为: 1073741823</span><br><span class="line">  if (expirationTime &#x3D;&#x3D;&#x3D; Sync) &#123;</span><br><span class="line">    if (</span><br><span class="line">      &#x2F;&#x2F; 检查是否处于非批量更新模式</span><br><span class="line">      (executionContext &amp; LegacyUnbatchedContext) !&#x3D;&#x3D; NoContext &amp;&amp;</span><br><span class="line">      &#x2F;&#x2F; 检查是否没有处于正在进行渲染的任务</span><br><span class="line">      (executionContext &amp; (RenderContext | CommitContext)) &#x3D;&#x3D;&#x3D; NoContext</span><br><span class="line">    ) &#123;</span><br><span class="line">      &#x2F;&#x2F; 同步任务入口点</span><br><span class="line">      performSyncWorkOnRoot(root);</span><br><span class="line">    &#125;</span><br><span class="line">  &#x2F;&#x2F; 忽略了一些初始化渲染不会得到执行的代码</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="14-构建workInProgress-Fiber-树中的rootFiber"><a href="#14-构建workInProgress-Fiber-树中的rootFiber" class="headerlink" title="14.构建workInProgress Fiber 树中的rootFiber"></a>14.构建workInProgress Fiber 树中的rootFiber</h3><blockquote>
<p>performSyncWorkOnRoot</p>
</blockquote>
<p><code>文件位置: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 进入 render 阶段, 构建 workInProgress Fiber 树</span><br><span class="line">function performSyncWorkOnRoot(root) &#123;</span><br><span class="line">  &#x2F;&#x2F; 参数 root 为 fiberRoot 对象</span><br><span class="line">  &#x2F;&#x2F; 检查是否有过期的任务</span><br><span class="line">  &#x2F;&#x2F; 如果没有过期的任务 值为 0</span><br><span class="line">  &#x2F;&#x2F; 初始化渲染没有过期的任务待执行</span><br><span class="line">  const lastExpiredTime &#x3D; root.lastExpiredTime;</span><br><span class="line">  &#x2F;&#x2F; NoWork 值为 0</span><br><span class="line">  &#x2F;&#x2F; 如果有过期的任务 将过期时间设置为 lastExpiredTime 否则将过期时间设置为 Sync</span><br><span class="line">  &#x2F;&#x2F; 初始渲染过期时间被设置成了 Sync</span><br><span class="line">  const expirationTime &#x3D; lastExpiredTime !&#x3D;&#x3D; NoWork ? lastExpiredTime : Sync;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 如果 root 和 workInProgressRoot 不相等</span><br><span class="line">  &#x2F;&#x2F; 说明 workInProgressRoot 不存在, 说明还没有构建 workInProgress Fiber 树</span><br><span class="line">  &#x2F;&#x2F; workInProgressRoot 为全局变量 默认值为 null, 初始渲染时值为 null</span><br><span class="line">  &#x2F;&#x2F; expirationTime &#x3D;&gt; 1073741823</span><br><span class="line">  &#x2F;&#x2F; renderExpirationTime &#x3D;&gt; 0</span><br><span class="line">  &#x2F;&#x2F; true</span><br><span class="line">  if (root !&#x3D;&#x3D; workInProgressRoot || expirationTime !&#x3D;&#x3D; renderExpirationTime) &#123;</span><br><span class="line">    &#x2F;&#x2F; 构建 workInProgressFiber 树及rootFiber</span><br><span class="line">    prepareFreshStack(root, expirationTime);</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; workInProgress 如果不为 null</span><br><span class="line">  if (workInProgress !&#x3D;&#x3D; null) &#123;</span><br><span class="line">    do &#123;</span><br><span class="line">      try &#123;</span><br><span class="line">        &#x2F;&#x2F; 以同步的方式开始构建 Fiber 对象</span><br><span class="line">        workLoopSync();</span><br><span class="line">        &#x2F;&#x2F; 跳出 while 循环</span><br><span class="line">        break;</span><br><span class="line">      &#125; catch (thrownValue) &#123;</span><br><span class="line">        handleError(root, thrownValue);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; while (true);</span><br><span class="line">    </span><br><span class="line">    if (workInProgress !&#x3D;&#x3D; null) &#123;</span><br><span class="line">      &#x2F;&#x2F; 这是一个同步渲染, 所以我们应该完成整棵树.</span><br><span class="line">      &#x2F;&#x2F; 无法提交不完整的 root, 此错误可能是由于React中的错误所致. 请提出问题.</span><br><span class="line">      invariant(</span><br><span class="line">        false,</span><br><span class="line">        &#39;Cannot commit an incomplete root. This error is likely caused by a &#39; +</span><br><span class="line">          &#39;bug in React. Please file an issue.&#39;,</span><br><span class="line">      );</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      &#x2F;&#x2F; 将构建好的新 Fiber 对象存储在 finishedWork 属性中</span><br><span class="line">      &#x2F;&#x2F; 提交阶段使用</span><br><span class="line">      root.finishedWork &#x3D; (root.current.alternate: any);</span><br><span class="line">      root.finishedExpirationTime &#x3D; expirationTime;</span><br><span class="line">      &#x2F;&#x2F; 结束 render 阶段</span><br><span class="line">      &#x2F;&#x2F; 进入 commit 阶段</span><br><span class="line">      finishSyncRender(root);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>prepareFreshStack</p>
</blockquote>
<p><code>文件位置: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 根据 currentFiber 树中的 rootFiber</span><br><span class="line"> * 构建 workInProgressFiber 树中的 rootFiber</span><br><span class="line"> *&#x2F;</span><br><span class="line">function prepareFreshStack(root, expirationTime) &#123;</span><br><span class="line">  &#x2F;&#x2F; 为 FiberRoot 对象添加 finishedWork 属性</span><br><span class="line">  &#x2F;&#x2F; finishedWork 表示 render 阶段执行完成后构建的待提交的 Fiber 对象</span><br><span class="line">  root.finishedWork &#x3D; null;</span><br><span class="line">  &#x2F;&#x2F; 初始化 finishedExpirationTime 值为 0</span><br><span class="line">  root.finishedExpirationTime &#x3D; NoWork;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 建构 workInProgress Fiber 树的 Fiber 对象</span><br><span class="line">  workInProgressRoot &#x3D; root;</span><br><span class="line">  &#x2F;&#x2F; 构建 workInProgress Fiber 树中的 rootFiber</span><br><span class="line">  workInProgress &#x3D; createWorkInProgress(root.current, null);</span><br><span class="line">  renderExpirationTime &#x3D; expirationTime;</span><br><span class="line">  workInProgressRootExitStatus &#x3D; RootIncomplete;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>createWorkInProgress</p>
</blockquote>
<p><code>文件位置: packages/react-reconciler/src/ReactFiber.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 构建 workInProgress Fiber 树中的 rootFiber</span><br><span class="line">&#x2F;&#x2F; 构建完成后会替换 current fiber</span><br><span class="line">&#x2F;&#x2F; 初始渲染 pendingProps 为 null</span><br><span class="line">export function createWorkInProgress(current: Fiber, pendingProps: any): Fiber &#123;</span><br><span class="line">  &#x2F;&#x2F; current: current Fiber 中的 rootFiber</span><br><span class="line">  &#x2F;&#x2F; 获取 current Fiber 中对应的 workInProgress Fiber</span><br><span class="line">  let workInProgress &#x3D; current.alternate;</span><br><span class="line">  &#x2F;&#x2F; 如果 workInProgress 不存在</span><br><span class="line">  if (workInProgress &#x3D;&#x3D;&#x3D; null) &#123;</span><br><span class="line">    &#x2F;&#x2F; 创建 fiber 对象</span><br><span class="line">    workInProgress &#x3D; createFiber(</span><br><span class="line">      current.tag,</span><br><span class="line">      pendingProps,</span><br><span class="line">      current.key,</span><br><span class="line">      current.mode,</span><br><span class="line">    );</span><br><span class="line">    &#x2F;&#x2F; 属性复用</span><br><span class="line">    workInProgress.elementType &#x3D; current.elementType;</span><br><span class="line">    workInProgress.type &#x3D; current.type;</span><br><span class="line">    workInProgress.stateNode &#x3D; current.stateNode;</span><br><span class="line">    &#x2F;&#x2F; 使用 alternate 存储 current</span><br><span class="line">    workInProgress.alternate &#x3D; current;</span><br><span class="line">    &#x2F;&#x2F; 使用 alternate 存储 workInProgress</span><br><span class="line">    current.alternate &#x3D; workInProgress;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  workInProgress.childExpirationTime &#x3D; current.childExpirationTime;</span><br><span class="line">  workInProgress.expirationTime &#x3D; current.expirationTime;</span><br><span class="line">  workInProgress.child &#x3D; current.child;</span><br><span class="line">  workInProgress.memoizedProps &#x3D; current.memoizedProps;</span><br><span class="line">  workInProgress.memoizedState &#x3D; current.memoizedState;</span><br><span class="line">  workInProgress.updateQueue &#x3D; current.updateQueue;</span><br><span class="line">  workInProgress.sibling &#x3D; current.sibling;</span><br><span class="line">  workInProgress.index &#x3D; current.index;</span><br><span class="line">  workInProgress.ref &#x3D; current.ref;</span><br><span class="line">	</span><br><span class="line">  &#x2F;&#x2F; 返回创建好的 workInProgress Fiber 对象</span><br><span class="line">  return workInProgress;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="15-workLoopSync方法解析"><a href="#15-workLoopSync方法解析" class="headerlink" title="15.workLoopSync方法解析"></a>15.workLoopSync方法解析</h3><blockquote>
<p>workLoopSync</p>
</blockquote>
<p><code>文件位置: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 以同步的方式构建 workInProgress Fiber 对象</span><br><span class="line">function workLoopSync() &#123;</span><br><span class="line">  &#x2F;&#x2F; workInProgress 是一个 fiber 对象</span><br><span class="line">  &#x2F;&#x2F; 它的值不为 null 意味着该 fiber 对象上仍然有更新要执行</span><br><span class="line">  while (workInProgress !&#x3D;&#x3D; null) &#123;</span><br><span class="line">    workInProgress &#x3D; performUnitOfWork(workInProgress);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="16-performUnitOfWork方法解析"><a href="#16-performUnitOfWork方法解析" class="headerlink" title="16.performUnitOfWork方法解析"></a>16.performUnitOfWork方法解析</h3><blockquote>
<p>performUnitOfWork</p>
</blockquote>
<p><code>文件位置: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">function performUnitOfWork(unitOfWork: Fiber): Fiber | null &#123;</span><br><span class="line">  &#x2F;&#x2F; unitOfWork &#x3D;&gt; workInProgress Fiber 树中的 rootFiber</span><br><span class="line">  &#x2F;&#x2F; current &#x3D;&gt; currentFiber 树中的 rootFiber</span><br><span class="line">  const current &#x3D; unitOfWork.alternate;</span><br><span class="line">  &#x2F;&#x2F; 存储下一个要构建的子级 Fiber 对象</span><br><span class="line">  let next;</span><br><span class="line">  &#x2F;&#x2F; false</span><br><span class="line">  if (enableProfilerTimer &amp;&amp; (unitOfWork.mode &amp; ProfileMode) !&#x3D;&#x3D; NoMode) &#123;</span><br><span class="line">    &#x2F;&#x2F; 初始渲染 不执行</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    &#x2F;&#x2F; beginWork: 从父到子, 构建 Fiber 节点对象</span><br><span class="line">    &#x2F;&#x2F; 返回值 next 为当前节点的子节点</span><br><span class="line">    next &#x3D; beginWork(current, unitOfWork, renderExpirationTime);</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; 为旧的 props 属性赋值</span><br><span class="line">  &#x2F;&#x2F; 此次更新后 pendingProps 变为 memoizedProps</span><br><span class="line">  unitOfWork.memoizedProps &#x3D; unitOfWork.pendingProps;</span><br><span class="line">  &#x2F;&#x2F; 如果子节点不存在说明当前节点向下遍历子节点已经到底了</span><br><span class="line">  &#x2F;&#x2F; 继续向上返回 遇到兄弟节点 构建兄弟节点的子 Fiber 对象 直到返回到根 Fiber 对象</span><br><span class="line">  if (next &#x3D;&#x3D;&#x3D; null) &#123;</span><br><span class="line">    &#x2F;&#x2F; 从子到父, 构建其余节点 Fiber 对象</span><br><span class="line">    next &#x3D; completeUnitOfWork(unitOfWork);</span><br><span class="line">  &#125;</span><br><span class="line">  return next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="17-构建单个子级Fiber对象的情况"><a href="#17-构建单个子级Fiber对象的情况" class="headerlink" title="17.构建单个子级Fiber对象的情况"></a>17.构建单个子级Fiber对象的情况</h3><blockquote>
<p>reconcileChildren</p>
</blockquote>
<p><code>文件位置: packages/react-reconciler/src/ReactFiberBeginWork.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">export function reconcileChildren(</span><br><span class="line">  &#x2F;&#x2F; 旧 Fiber</span><br><span class="line">  current: Fiber | null,</span><br><span class="line">  &#x2F;&#x2F; 父级 Fiber</span><br><span class="line">  workInProgress: Fiber,</span><br><span class="line">  &#x2F;&#x2F; 子级 vdom 对象</span><br><span class="line">  nextChildren: any,</span><br><span class="line">  &#x2F;&#x2F; 初始渲染 整型最大值 代表同步任务</span><br><span class="line">  renderExpirationTime: ExpirationTime,</span><br><span class="line">) &#123;</span><br><span class="line">  &#x2F;**</span><br><span class="line">   * 为什么要传递 current ?</span><br><span class="line">   * 如果不是初始渲染的情况, 要进行新旧 Fiber 对比</span><br><span class="line">   * 初始渲染时则用不到 current</span><br><span class="line">   *&#x2F;</span><br><span class="line">  &#x2F;&#x2F; 如果就 Fiber 为 null 表示初始渲染</span><br><span class="line">  if (current &#x3D;&#x3D;&#x3D; null) &#123;</span><br><span class="line">    &#x2F;&#x2F; 为当前构建的 Fiber 对象添加子级 Fiber 对象</span><br><span class="line">    workInProgress.child &#x3D; mountChildFibers(</span><br><span class="line">      workInProgress,</span><br><span class="line">      null,</span><br><span class="line">      nextChildren,</span><br><span class="line">      renderExpirationTime,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; 忽略了 else 的情况</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ChildReconciler</p>
</blockquote>
<p><code>文件位置: packages/react-reconciler/src/ReactChildFiber.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * shouldTrackSideEffects 标识, 是否为 Fiber 对象添加 effectTag</span><br><span class="line"> * true 添加 false 不添加</span><br><span class="line"> * 对于初始渲染来说, 只有根组件需要添加, 其他元素不需要添加, 防止过多的 DOM 操作</span><br><span class="line"> *&#x2F;</span><br><span class="line">&#x2F;&#x2F; 用于初始渲染</span><br><span class="line">export const mountChildFibers &#x3D; ChildReconciler(false);</span><br><span class="line"></span><br><span class="line">function ChildReconciler(shouldTrackSideEffects) &#123;</span><br><span class="line"> </span><br><span class="line">  function placeChild(</span><br><span class="line">    newFiber: Fiber,</span><br><span class="line">    lastPlacedIndex: number,</span><br><span class="line">    newIndex: number,</span><br><span class="line">  ): number &#123;</span><br><span class="line">    newFiber.index &#x3D; newIndex;</span><br><span class="line">    if (!shouldTrackSideEffects) &#123;</span><br><span class="line">      return lastPlacedIndex;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 忽略了一部分初始化渲染不执行的代码</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function placeSingleChild(newFiber: Fiber): Fiber &#123;</span><br><span class="line">    &#x2F;&#x2F; 如果是初始渲染 会在根组件(App)上设置 effectTag 属性为 Placement 值为 1</span><br><span class="line">    &#x2F;&#x2F; 其他子级节点具有默认值为 0 防止在 commit 阶段反复操作真实DOM</span><br><span class="line">    &#x2F;&#x2F; 初始渲染时如果当前处理的是根组件 true 其他组件 false</span><br><span class="line">    if (shouldTrackSideEffects &amp;&amp; newFiber.alternate &#x3D;&#x3D;&#x3D; null) &#123;</span><br><span class="line">      &#x2F;&#x2F; Placement 表示新创建的节点</span><br><span class="line">      newFiber.effectTag &#x3D; Placement;</span><br><span class="line">    &#125;</span><br><span class="line">    return newFiber;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  &#x2F;&#x2F; 处理子元素是数组的情况</span><br><span class="line">  function reconcileChildrenArray(</span><br><span class="line">    &#x2F;&#x2F; 父级 Fiber</span><br><span class="line">    returnFiber: Fiber,</span><br><span class="line">    currentFirstChild: Fiber | null,</span><br><span class="line">    &#x2F;&#x2F; 子级 vdom 数组</span><br><span class="line">    newChildren: Array&lt;*&gt;,</span><br><span class="line">    expirationTime: ExpirationTime,</span><br><span class="line">  ): Fiber | null &#123;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 存储第一个子节点 Fiber 对象</span><br><span class="line">     * 方法返回的也是第一个子节点 Fiber 对象</span><br><span class="line">     * 因为其他子节点 Fiber 对象都存储在上一个子 Fiber 节点对象的 sibling 属性中</span><br><span class="line">     *&#x2F;</span><br><span class="line">    let resultingFirstChild: Fiber | null &#x3D; null;</span><br><span class="line">    &#x2F;&#x2F; 上一次创建的 Fiber 对象</span><br><span class="line">    let previousNewFiber: Fiber | null &#x3D; null;</span><br><span class="line">    &#x2F;&#x2F; 初始渲染没有旧的子级 所以为 null</span><br><span class="line">    let oldFiber &#x3D; currentFirstChild;</span><br><span class="line"></span><br><span class="line">    let lastPlacedIndex &#x3D; 0;</span><br><span class="line">    let newIdx &#x3D; 0;</span><br><span class="line">    let nextOldFiber &#x3D; null;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; oldFiber 为空 说明是初始渲染</span><br><span class="line">    if (oldFiber &#x3D;&#x3D;&#x3D; null) &#123;</span><br><span class="line">      &#x2F;&#x2F; 遍历子 vdom 对象</span><br><span class="line">      for (; newIdx &lt; newChildren.length; newIdx++) &#123;</span><br><span class="line">        &#x2F;&#x2F; 创建子 vdom 对应的 fiber 对象</span><br><span class="line">        const newFiber &#x3D; createChild(</span><br><span class="line">          returnFiber,</span><br><span class="line">          newChildren[newIdx],</span><br><span class="line">          expirationTime,</span><br><span class="line">        );</span><br><span class="line">        &#x2F;&#x2F; 如果 newFiber 为 null</span><br><span class="line">        if (newFiber &#x3D;&#x3D;&#x3D; null) &#123;</span><br><span class="line">          &#x2F;&#x2F; 进入下次循环</span><br><span class="line">          continue;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 初始渲染时只为 newFiber 添加了 index 属性,</span><br><span class="line">        &#x2F;&#x2F; 其他事没干. lastPlacedIndex 被原封不动的返回了</span><br><span class="line">        lastPlacedIndex &#x3D; placeChild(newFiber, lastPlacedIndex, newIdx);</span><br><span class="line">        &#x2F;&#x2F; 为当前节点设置下一个兄弟节点</span><br><span class="line">        if (previousNewFiber &#x3D;&#x3D;&#x3D; null) &#123;</span><br><span class="line">          &#x2F;&#x2F; 存储第一个子 Fiber 发生在第一次循环时</span><br><span class="line">          resultingFirstChild &#x3D; newFiber;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          &#x2F;&#x2F; 为节点设置下一个兄弟 Fiber</span><br><span class="line">          previousNewFiber.sibling &#x3D; newFiber;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 在循环的过程中更新上一个创建的Fiber 对象</span><br><span class="line">        previousNewFiber &#x3D; newFiber;</span><br><span class="line">      &#125;</span><br><span class="line">      &#x2F;&#x2F; 返回创建好的子 Fiber</span><br><span class="line">      &#x2F;&#x2F; 其他 Fiber 都作为 sibling 存在</span><br><span class="line">      return resultingFirstChild;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 返回第一个子元素 Fiber 对象</span><br><span class="line">    return resultingFirstChild;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 处理子元素是文本或者数值的情况</span><br><span class="line">  function reconcileSingleTextNode(</span><br><span class="line">    returnFiber: Fiber,</span><br><span class="line">    currentFirstChild: Fiber | null,</span><br><span class="line">    textContent: string,</span><br><span class="line">    expirationTime: ExpirationTime,</span><br><span class="line">  ): Fiber &#123;</span><br><span class="line">    &#x2F;&#x2F; 初始渲染不执行</span><br><span class="line">    if (currentFirstChild !&#x3D;&#x3D; null &amp;&amp; currentFirstChild.tag &#x3D;&#x3D;&#x3D; HostText) &#123;</span><br><span class="line">      &#x2F;&#x2F; We already have an existing node so let&#39;s just update it and delete</span><br><span class="line">      &#x2F;&#x2F; the rest.</span><br><span class="line">      deleteRemainingChildren(returnFiber, currentFirstChild.sibling);</span><br><span class="line">      const existing &#x3D; useFiber(currentFirstChild, textContent);</span><br><span class="line">      existing.return &#x3D; returnFiber;</span><br><span class="line">      return existing;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 现有的第一个子节点不是文本节点，因此我们需要创建一个并删除现有的.</span><br><span class="line">    &#x2F;&#x2F; 初始渲染不执行</span><br><span class="line">    deleteRemainingChildren(returnFiber, currentFirstChild);</span><br><span class="line">    &#x2F;&#x2F; 根据文本创建 Fiber 对象</span><br><span class="line">    const created &#x3D; createFiberFromText(</span><br><span class="line">      textContent,</span><br><span class="line">      returnFiber.mode,</span><br><span class="line">      expirationTime,</span><br><span class="line">    );</span><br><span class="line">    &#x2F;&#x2F; 设置父 Fiber 对象</span><br><span class="line">    created.return &#x3D; returnFiber;</span><br><span class="line">    &#x2F;&#x2F; 返回创建好的 Fiber 对象</span><br><span class="line">    return created;</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; 处理子元素是单个对象的情况</span><br><span class="line">  function reconcileSingleElement(</span><br><span class="line">    &#x2F;&#x2F; 父 Fiber 对象</span><br><span class="line">    returnFiber: Fiber,</span><br><span class="line">    &#x2F;&#x2F; 备份子 fiber</span><br><span class="line">    currentFirstChild: Fiber | null,</span><br><span class="line">    &#x2F;&#x2F; 子 vdom 对象</span><br><span class="line">    element: ReactElement,</span><br><span class="line">    expirationTime: ExpirationTime,</span><br><span class="line">  ): Fiber &#123;</span><br><span class="line">    &#x2F;&#x2F; 查看子 vdom 对象是否表示 fragment</span><br><span class="line">    if (element.type &#x3D;&#x3D;&#x3D; REACT_FRAGMENT_TYPE) &#123;</span><br><span class="line">      &#x2F;&#x2F; false</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      &#x2F;&#x2F; 根据 React Element 创建 Fiber 对象</span><br><span class="line">      &#x2F;&#x2F; 返回创建好的 Fiber 对象</span><br><span class="line">      const created &#x3D; createFiberFromElement(</span><br><span class="line">        element,</span><br><span class="line">        &#x2F;&#x2F; 用来表示当前组件下的所有子组件要用处于何种渲染模式</span><br><span class="line">        &#x2F;&#x2F; 文件位置: .&#x2F;ReactTypeOfMode.js</span><br><span class="line">        &#x2F;&#x2F; 0    同步渲染模式</span><br><span class="line">        &#x2F;&#x2F; 100  异步渲染模式</span><br><span class="line">        returnFiber.mode,</span><br><span class="line">        expirationTime,</span><br><span class="line">      );</span><br><span class="line">      &#x2F;&#x2F; 添加 ref 属性 &#123; current: DOM &#125;</span><br><span class="line">      created.ref &#x3D; coerceRef(returnFiber, currentFirstChild, element);</span><br><span class="line">      &#x2F;&#x2F; 添加父级 Fiber 对象</span><br><span class="line">      created.return &#x3D; returnFiber;</span><br><span class="line">      &#x2F;&#x2F; 返回创建好的子 Fiber</span><br><span class="line">      return created;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function reconcileChildFibers(</span><br><span class="line">    &#x2F;&#x2F; 父 Fiber 对象</span><br><span class="line">    returnFiber: Fiber,</span><br><span class="line">    &#x2F;&#x2F; 旧的第一个子 Fiber 初始渲染 null</span><br><span class="line">    currentFirstChild: Fiber | null,</span><br><span class="line">    &#x2F;&#x2F; 新的子 vdom 对象</span><br><span class="line">    newChild: any,</span><br><span class="line">    &#x2F;&#x2F; 初始渲染 整型最大值 代表同步任务</span><br><span class="line">    expirationTime: ExpirationTime,</span><br><span class="line">  ): Fiber | null &#123;</span><br><span class="line">    &#x2F;&#x2F; 这是入口方法, 根据 newChild 类型进行对应处理</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 判断新的子 vdom 是否为占位组件 比如 &lt;&gt;&lt;&#x2F;&gt;</span><br><span class="line">    &#x2F;&#x2F; false</span><br><span class="line">    const isUnkeyedTopLevelFragment &#x3D;</span><br><span class="line">      typeof newChild &#x3D;&#x3D;&#x3D; &#39;object&#39; &amp;&amp;</span><br><span class="line">      newChild !&#x3D;&#x3D; null &amp;&amp;</span><br><span class="line">      newChild.type &#x3D;&#x3D;&#x3D; REACT_FRAGMENT_TYPE &amp;&amp;</span><br><span class="line">      newChild.key &#x3D;&#x3D;&#x3D; null;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 如果 newChild 为占位符, 使用 占位符组件的子元素作为 newChild</span><br><span class="line">    if (isUnkeyedTopLevelFragment) &#123;</span><br><span class="line">      newChild &#x3D; newChild.props.children;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 检测 newChild 是否为对象类型</span><br><span class="line">    const isObject &#x3D; typeof newChild &#x3D;&#x3D;&#x3D; &#39;object&#39; &amp;&amp; newChild !&#x3D;&#x3D; null;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; newChild 是单个对象的情况</span><br><span class="line">    if (isObject) &#123;</span><br><span class="line">      &#x2F;&#x2F; 匹配子元素的类型</span><br><span class="line">      switch (newChild.$$typeof) &#123;</span><br><span class="line">        &#x2F;&#x2F; 子元素为 ReactElement</span><br><span class="line">        case REACT_ELEMENT_TYPE:</span><br><span class="line">          &#x2F;&#x2F; 为 Fiber 对象设置 effectTag 属性</span><br><span class="line">          &#x2F;&#x2F; 返回创建好的子 Fiber</span><br><span class="line">          return placeSingleChild(</span><br><span class="line">            &#x2F;&#x2F; 处理单个 React Element 的情况</span><br><span class="line">            &#x2F;&#x2F; 内部会调用其他方法创建对应的 Fiber 对象</span><br><span class="line">            reconcileSingleElement(</span><br><span class="line">              returnFiber,</span><br><span class="line">              currentFirstChild,</span><br><span class="line">              newChild,</span><br><span class="line">              expirationTime,</span><br><span class="line">            ),</span><br><span class="line">          );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">      </span><br><span class="line">    &#x2F;&#x2F; 处理 children 为文本和数值的情况 return &quot;App works&quot;</span><br><span class="line">    if (typeof newChild &#x3D;&#x3D;&#x3D; &#39;string&#39; || typeof newChild &#x3D;&#x3D;&#x3D; &#39;number&#39;) &#123;</span><br><span class="line">      return placeSingleChild(</span><br><span class="line">        reconcileSingleTextNode(</span><br><span class="line">          returnFiber,</span><br><span class="line">          currentFirstChild,</span><br><span class="line">          &#x2F;&#x2F; 如果 newChild 是数值, 转换为字符串</span><br><span class="line">          &#39;&#39; + newChild,</span><br><span class="line">          expirationTime,</span><br><span class="line">        ),</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; children 是数组的情况</span><br><span class="line">    if (isArray(newChild)) &#123;</span><br><span class="line">      &#x2F;&#x2F; 返回创建好的子 Fiber</span><br><span class="line">      return reconcileChildrenArray(</span><br><span class="line">        returnFiber,</span><br><span class="line">        currentFirstChild,</span><br><span class="line">        newChild,</span><br><span class="line">        expirationTime,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="18-构建多个子级Fiber对象"><a href="#18-构建多个子级Fiber对象" class="headerlink" title="18.构建多个子级Fiber对象"></a>18.构建多个子级Fiber对象</h3><h3 id="19-子级节点Fiber对象的构建流程"><a href="#19-子级节点Fiber对象的构建流程" class="headerlink" title="19.子级节点Fiber对象的构建流程"></a>19.子级节点Fiber对象的构建流程</h3><blockquote>
<p>beginWork</p>
</blockquote>
<p><code>文件位置: packages/react-reconciler/src/ReactFiberBeginWork.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 从父到子, 构建 Fiber 节点对象</span><br><span class="line">function beginWork(</span><br><span class="line">  current: Fiber | null,</span><br><span class="line">  workInProgress: Fiber,</span><br><span class="line">  renderExpirationTime: ExpirationTime,</span><br><span class="line">): Fiber | null &#123;</span><br><span class="line">  &#x2F;&#x2F; NoWork 常量 值为0 清空过期时间</span><br><span class="line">  workInProgress.expirationTime &#x3D; NoWork;</span><br><span class="line">  &#x2F;&#x2F; 根据当前 Fiber 的类型决定如何构建起子级 Fiber 对象</span><br><span class="line">  &#x2F;&#x2F; 文件位置: shared&#x2F;ReactWorkTags.js</span><br><span class="line">  switch (workInProgress.tag) &#123;</span><br><span class="line">    &#x2F;&#x2F; 2</span><br><span class="line">    &#x2F;&#x2F; 函数型组件在第一次渲染组件时使用</span><br><span class="line">    case IndeterminateComponent: &#123;</span><br><span class="line">      return mountIndeterminateComponent(</span><br><span class="line">        &#x2F;&#x2F; 旧 Fiber</span><br><span class="line">        current,</span><br><span class="line">        &#x2F;&#x2F; 新 Fiber</span><br><span class="line">        workInProgress,</span><br><span class="line">        &#x2F;&#x2F; 新 Fiber 的 type 值 初始渲染时是App组件函数</span><br><span class="line">        workInProgress.type,</span><br><span class="line">        &#x2F;&#x2F; 同步 整数最大值 1073741823</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 0</span><br><span class="line">    case FunctionComponent: &#123;</span><br><span class="line">      const Component &#x3D; workInProgress.type;</span><br><span class="line">      const unresolvedProps &#x3D; workInProgress.pendingProps;</span><br><span class="line">      const resolvedProps &#x3D;</span><br><span class="line">        workInProgress.elementType &#x3D;&#x3D;&#x3D; Component</span><br><span class="line">          ? unresolvedProps</span><br><span class="line">          : resolveDefaultProps(Component, unresolvedProps);</span><br><span class="line">      return updateFunctionComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        Component,</span><br><span class="line">        resolvedProps,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 1</span><br><span class="line">    case ClassComponent: &#123;</span><br><span class="line">      const Component &#x3D; workInProgress.type;</span><br><span class="line">      const unresolvedProps &#x3D; workInProgress.pendingProps;</span><br><span class="line">      const resolvedProps &#x3D;</span><br><span class="line">        workInProgress.elementType &#x3D;&#x3D;&#x3D; Component</span><br><span class="line">          ? unresolvedProps</span><br><span class="line">          : resolveDefaultProps(Component, unresolvedProps);</span><br><span class="line">      return updateClassComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        Component,</span><br><span class="line">        resolvedProps,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 3</span><br><span class="line">    case HostRoot:</span><br><span class="line">      return updateHostRoot(current, workInProgress, renderExpirationTime);</span><br><span class="line">    &#x2F;&#x2F; 5</span><br><span class="line">    case HostComponent:</span><br><span class="line">      return updateHostComponent(current, workInProgress, renderExpirationTime);</span><br><span class="line">    &#x2F;&#x2F; 6</span><br><span class="line">    case HostText:</span><br><span class="line">      return updateHostText(current, workInProgress);</span><br><span class="line">  &#x2F;&#x2F; 组件类型未知 报错</span><br><span class="line">  invariant(</span><br><span class="line">    false,</span><br><span class="line">    &#39;Unknown unit of work tag (%s). This error is likely caused by a bug in &#39; +</span><br><span class="line">      &#39;React. Please file an issue.&#39;,</span><br><span class="line">    workInProgress.tag,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>updateHostRoot</p>
</blockquote>
<p><code>文件位置: packages/react-reconciler/src/ReactFiberBeginWork.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; HostRoot &#x3D;&gt; &lt;div id&#x3D;&quot;root&quot;&gt;&lt;&#x2F;div&gt; 对应的 Fiber 对象</span><br><span class="line">&#x2F;&#x2F; 找出 HostRoot 的子 ReactElement 并为其构建 Fiber 对象</span><br><span class="line">function updateHostRoot(current, workInProgress, renderExpirationTime) &#123;</span><br><span class="line">  &#x2F;&#x2F; 获取更新队列</span><br><span class="line">  const updateQueue &#x3D; workInProgress.updateQueue;</span><br><span class="line">  &#x2F;&#x2F; 获取新的 props 对象 null</span><br><span class="line">  const nextProps &#x3D; workInProgress.pendingProps;</span><br><span class="line">  &#x2F;&#x2F; 获取上一次渲染使用的 state null</span><br><span class="line">  const prevState &#x3D; workInProgress.memoizedState;</span><br><span class="line">  &#x2F;&#x2F; 获取上一次渲染使用的 children null</span><br><span class="line">  const prevChildren &#x3D; prevState !&#x3D;&#x3D; null ? prevState.element : null;</span><br><span class="line">  &#x2F;&#x2F; 浅复制更新队列, 防止引用属性互相影响</span><br><span class="line">  &#x2F;&#x2F; workInProgress.updateQueue 浅拷贝 current.updateQueue</span><br><span class="line">  cloneUpdateQueue(current, workInProgress);</span><br><span class="line">  &#x2F;&#x2F; 获取 updateQueue.payload 并赋值到 workInProgress.memoizedState</span><br><span class="line">  &#x2F;&#x2F; 要更新的内容就是 element 就是 rootFiber 的子元素</span><br><span class="line">  processUpdateQueue(workInProgress, nextProps, null, renderExpirationTime);</span><br><span class="line">  &#x2F;&#x2F; 获取 element 所在对象</span><br><span class="line">  const nextState &#x3D; workInProgress.memoizedState;</span><br><span class="line">  &#x2F;&#x2F; 从对象中获取 element</span><br><span class="line">  const nextChildren &#x3D; nextState.element;</span><br><span class="line">  &#x2F;&#x2F; 获取 fiberRoot 对象</span><br><span class="line">  const root: FiberRoot &#x3D; workInProgress.stateNode;</span><br><span class="line">  &#x2F;&#x2F; 服务器端渲染走 if</span><br><span class="line">  if (root.hydrate &amp;&amp; enterHydrationState(workInProgress)) &#123;</span><br><span class="line">    &#x2F;&#x2F; 忽略</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    &#x2F;&#x2F; 客户端渲染走 else</span><br><span class="line">    &#x2F;&#x2F; 构建子节点 fiber 对象</span><br><span class="line">    reconcileChildren(</span><br><span class="line">      current,</span><br><span class="line">      workInProgress,</span><br><span class="line">      nextChildren,</span><br><span class="line">      renderExpirationTime,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; 返回子节点 fiber 对象</span><br><span class="line">  return workInProgress.child;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="20-completeUnitOfWork方法解析"><a href="#20-completeUnitOfWork方法解析" class="headerlink" title="20.completeUnitOfWork方法解析"></a>20.completeUnitOfWork方法解析</h3><blockquote>
<p>completeUnitOfWork</p>
</blockquote>
<p><code>文件位置: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> *</span><br><span class="line"> * 从下至上移动到该节点的兄弟节点, 如果一直往上没有兄弟节点就返回父节点, 最终会到达 root 节点</span><br><span class="line"> * 1. 创建其他节点的 Fiber 对象</span><br><span class="line"> * 2. 创建每一个节点的真实 DOM 对象并将其添加到 stateNode 属性中</span><br><span class="line"> * 3. 构建 effect 链表结构</span><br><span class="line"> *&#x2F;</span><br><span class="line">function completeUnitOfWork(unitOfWork: Fiber): Fiber | null &#123;</span><br><span class="line">  &#x2F;&#x2F; 为 workInProgress 全局变量重新赋值</span><br><span class="line">  workInProgress &#x3D; unitOfWork;</span><br><span class="line">  do &#123;</span><br><span class="line">    &#x2F;&#x2F; 获取备份节点</span><br><span class="line">    &#x2F;&#x2F; 初始化渲染 非根 Fiber 对象没有备份节点 所以 current 为 null</span><br><span class="line">    const current &#x3D; workInProgress.alternate;</span><br><span class="line">    &#x2F;&#x2F; 父级 Fiber 对象, 非根 Fiber 对象都有父级</span><br><span class="line">    const returnFiber &#x3D; workInProgress.return;</span><br><span class="line">    &#x2F;&#x2F; 判断传入的 Fiber 对象是否构建完成, 任务调度相关</span><br><span class="line">    &#x2F;&#x2F; &amp; 是表示位的与运算, 把左右两边的数字转化为二进制</span><br><span class="line">    &#x2F;&#x2F; 然后每一位分别进行比较, 如果相等就为1, 不相等即为0</span><br><span class="line">    &#x2F;&#x2F; 此处应用&quot;位与&quot;运算符的目的是&quot;清零&quot;</span><br><span class="line">    &#x2F;&#x2F; true</span><br><span class="line">    if ((workInProgress.effectTag &amp; Incomplete) &#x3D;&#x3D;&#x3D; NoEffect) &#123;</span><br><span class="line">      let next;</span><br><span class="line">      &#x2F;&#x2F; 如果不能使用分析器的 timer, 直接执行 completeWork</span><br><span class="line">      &#x2F;&#x2F; enableProfilerTimer &#x3D;&gt; true</span><br><span class="line">      &#x2F;&#x2F; 但此处无论条件是否成立都会执行 completeWork</span><br><span class="line">      if (</span><br><span class="line">        !enableProfilerTimer ||</span><br><span class="line">        (workInProgress.mode &amp; ProfileMode) &#x3D;&#x3D;&#x3D; NoMode</span><br><span class="line">      ) &#123;</span><br><span class="line">        &#x2F;&#x2F; 重点代码(二)</span><br><span class="line">        &#x2F;&#x2F; 创建节点真实 DOM 对象并将其添加到 stateNode 属性中</span><br><span class="line">        next &#x3D; completeWork(current, workInProgress, renderExpirationTime);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        &#x2F;&#x2F; 创建节点真实 DOM 对象并将其添加到 stateNode 属性中</span><br><span class="line">        next &#x3D; completeWork(current, workInProgress, renderExpirationTime);</span><br><span class="line">      &#125;</span><br><span class="line">      &#x2F;&#x2F; 重点代码(一)</span><br><span class="line">      &#x2F;&#x2F; 如果子级存在</span><br><span class="line">      if (next !&#x3D;&#x3D; null) &#123;</span><br><span class="line">        &#x2F;&#x2F; 返回子级 一直返回到 workLoopSync</span><br><span class="line">        &#x2F;&#x2F; 再重新执行 performUnitOfWork 构建子级 Fiber 节点对象</span><br><span class="line">        return next;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      &#x2F;&#x2F; 构建 effect 链表结构</span><br><span class="line">      &#x2F;&#x2F; 如果不是根 Fiber 就是 true 否则就是 false</span><br><span class="line">      &#x2F;&#x2F; 将子树和此 Fiber 的所有 effect 附加到父级的 effect 列表中</span><br><span class="line">      if (</span><br><span class="line">        &#x2F;&#x2F; 如果父 Fiber 存在 并且</span><br><span class="line">        returnFiber !&#x3D;&#x3D; null &amp;&amp;</span><br><span class="line">        &#x2F;&#x2F; 父 Fiber 对象中的 effectTag 为 0</span><br><span class="line">        (returnFiber.effectTag &amp; Incomplete) &#x3D;&#x3D;&#x3D; NoEffect</span><br><span class="line">      ) &#123;</span><br><span class="line">        &#x2F;&#x2F; 将子树和此 Fiber 的所有副作用附加到父级的 effect 列表上</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 以下两个判断的作用是搜集子 Fiber的 effect 到父 Fiber</span><br><span class="line">        if (returnFiber.firstEffect &#x3D;&#x3D;&#x3D; null) &#123;</span><br><span class="line">          &#x2F;&#x2F; first</span><br><span class="line">          returnFiber.firstEffect &#x3D; workInProgress.firstEffect;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (workInProgress.lastEffect !&#x3D;&#x3D; null) &#123;</span><br><span class="line">          if (returnFiber.lastEffect !&#x3D;&#x3D; null) &#123;</span><br><span class="line">            &#x2F;&#x2F; next</span><br><span class="line">            returnFiber.lastEffect.nextEffect &#x3D; workInProgress.firstEffect;</span><br><span class="line">          &#125;</span><br><span class="line">          &#x2F;&#x2F; last</span><br><span class="line">          returnFiber.lastEffect &#x3D; workInProgress.lastEffect;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 获取副作用标记</span><br><span class="line">        &#x2F;&#x2F; 初始渲染时除[根组件]以外的 Fiber, effectTag 值都为 0, 即不需要执行任何真实DOM操作</span><br><span class="line">        &#x2F;&#x2F; 根组件的 effectTag 值为 3, 即需要将此节点对应的真实DOM对象添加到页面中</span><br><span class="line">        const effectTag &#x3D; workInProgress.effectTag;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 创建 effect 列表时跳过 NoWork(0) 和 PerformedWork(1) 标记</span><br><span class="line">        &#x2F;&#x2F; PerformedWork 由 React DevTools 读取, 不提交</span><br><span class="line">        &#x2F;&#x2F; 初始渲染时 只有遍历到了根组件 判断条件才能成立, 将 effect 链表添加到 rootFiber</span><br><span class="line">        &#x2F;&#x2F; 初始渲染 FiberRoot 对象中的 firstEffect 和 lastEffect 都是 App 组件</span><br><span class="line">        &#x2F;&#x2F; 因为当所有节点在内存中构建完成后, 只需要一次将所有 DOM 添加到页面中</span><br><span class="line">        if (effectTag &gt; PerformedWork) &#123;</span><br><span class="line">          &#x2F;&#x2F; false</span><br><span class="line">          if (returnFiber.lastEffect !&#x3D;&#x3D; null) &#123;</span><br><span class="line">            returnFiber.lastEffect.nextEffect &#x3D; workInProgress;</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">            &#x2F;&#x2F; 为 fiberRoot 添加 firstEffect</span><br><span class="line">            returnFiber.firstEffect &#x3D; workInProgress;</span><br><span class="line">          &#125;</span><br><span class="line">          &#x2F;&#x2F; 为 fiberRoot 添加 lastEffect</span><br><span class="line">          returnFiber.lastEffect &#x3D; workInProgress;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">    	&#x2F;&#x2F; 忽略了初始渲染不执行的代码      </span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 获取下一个同级 Fiber 对象</span><br><span class="line">    const siblingFiber &#x3D; workInProgress.sibling;</span><br><span class="line">    &#x2F;&#x2F; 如果下一个同级 Fiber 对象存在</span><br><span class="line">    if (siblingFiber !&#x3D;&#x3D; null) &#123;</span><br><span class="line">      &#x2F;&#x2F; 返回下一个同级 Fiber 对象</span><br><span class="line">      return siblingFiber;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 否则退回父级</span><br><span class="line">    workInProgress &#x3D; returnFiber;</span><br><span class="line">  &#125; while (workInProgress !&#x3D;&#x3D; null);</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 当执行到这里的时候, 说明遍历到了 root 节点, 已完成遍历</span><br><span class="line">  &#x2F;&#x2F; 更新 workInProgressRootExitStatus 的状态为 已完成</span><br><span class="line">  if (workInProgressRootExitStatus &#x3D;&#x3D;&#x3D; RootIncomplete) &#123;</span><br><span class="line">    workInProgressRootExitStatus &#x3D; RootCompleted;</span><br><span class="line">  &#125;</span><br><span class="line">  return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>completeWork</p>
</blockquote>
<p><code>文件位置: packages/react-reconciler/src/ReactFiberCompleteWork.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">function completeWork(</span><br><span class="line">  current: Fiber | null,</span><br><span class="line">  workInProgress: Fiber,</span><br><span class="line">  renderExpirationTime: ExpirationTime,</span><br><span class="line">): Fiber | null &#123;</span><br><span class="line">  &#x2F;&#x2F; 获取待更新 props</span><br><span class="line">  const newProps &#x3D; workInProgress.pendingProps;</span><br><span class="line">  switch (workInProgress.tag) &#123;</span><br><span class="line">    &#x2F;&#x2F; 0</span><br><span class="line">    case FunctionComponent:</span><br><span class="line">      return null;</span><br><span class="line">    &#x2F;&#x2F; 3</span><br><span class="line">    case HostRoot: &#123;</span><br><span class="line">      updateHostContainer(workInProgress);</span><br><span class="line">      return null;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 5</span><br><span class="line">    case HostComponent: &#123;</span><br><span class="line">      &#x2F;&#x2F; 获取 rootDOM 节点 &lt;div id&#x3D;&quot;root&quot;&gt;&lt;&#x2F;div&gt;</span><br><span class="line">      const rootContainerInstance &#x3D; getRootHostContainer();</span><br><span class="line">      &#x2F;&#x2F; 节点的具体的类型 div span ...</span><br><span class="line">      const type &#x3D; workInProgress.type;</span><br><span class="line">      &#x2F;&#x2F; false current &#x3D; null</span><br><span class="line">      if (current !&#x3D;&#x3D; null &amp;&amp; workInProgress.stateNode !&#x3D; null) &#123;</span><br><span class="line">       &#x2F;&#x2F; 初始渲染不执行</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">				&#x2F;&#x2F; false</span><br><span class="line">        if (wasHydrated) &#123;</span><br><span class="line">         &#x2F;&#x2F; 初始渲染不执行</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          &#x2F;&#x2F; 创建节点实例对象 &lt;div&gt;&lt;&#x2F;div&gt; &lt;span&gt;&lt;&#x2F;span&gt;</span><br><span class="line">          let instance &#x3D; createInstance(</span><br><span class="line">            type,</span><br><span class="line">            newProps,</span><br><span class="line">            rootContainerInstance,</span><br><span class="line">            currentHostContext,</span><br><span class="line">            workInProgress,</span><br><span class="line">          );</span><br><span class="line">          &#x2F;**</span><br><span class="line">           * 将所有的子级追加到父级中</span><br><span class="line">           * instance 为父级</span><br><span class="line">           * workInProgress.child 为子级</span><br><span class="line">           *&#x2F;</span><br><span class="line">          appendAllChildren(instance, workInProgress, false, false);</span><br><span class="line">          &#x2F;&#x2F; 为 Fiber 对象添加 stateNode 属性</span><br><span class="line">          workInProgress.stateNode &#x3D; instance;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 处理 ref DOM 引用</span><br><span class="line">        if (workInProgress.ref !&#x3D;&#x3D; null) &#123;</span><br><span class="line">          markRef(workInProgress);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      return null;</span><br><span class="line">    &#125; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>appendAllChildren</p>
</blockquote>
<p><code>文件位置: packages/react-reconciler/src/ReactFiberCompleteWork.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">appendAllChildren &#x3D; function (</span><br><span class="line">    parent: Instance,</span><br><span class="line">    workInProgress: Fiber,</span><br><span class="line">    needsVisibilityToggle: boolean,</span><br><span class="line">    isHidden: boolean,</span><br><span class="line">  ) &#123;</span><br><span class="line">    &#x2F;&#x2F; 获取子级</span><br><span class="line">    let node &#x3D; workInProgress.child;</span><br><span class="line">    &#x2F;&#x2F; 如果子级不为空 执行循环</span><br><span class="line">    while (node !&#x3D;&#x3D; null) &#123;</span><br><span class="line">      &#x2F;&#x2F; 如果 node 是普通 ReactElement 或者为文本</span><br><span class="line">      if (node.tag &#x3D;&#x3D;&#x3D; HostComponent || node.tag &#x3D;&#x3D;&#x3D; HostText) &#123;</span><br><span class="line">        &#x2F;&#x2F; 将子级追加到父级中</span><br><span class="line">        appendInitialChild(parent, node.stateNode);</span><br><span class="line">      &#125; else if (node.child !&#x3D;&#x3D; null) &#123;</span><br><span class="line">        &#x2F;&#x2F; 如果 node 不是普通 ReactElement 又不是文本</span><br><span class="line">        &#x2F;&#x2F; 将 node 视为组件, 组件本身不能转换为真实 DOM 元素</span><br><span class="line">        &#x2F;&#x2F; 获取到组件的第一个子元素, 继续执行循环</span><br><span class="line">        node.child.return &#x3D; node;</span><br><span class="line">        node &#x3D; node.child;</span><br><span class="line">        continue;</span><br><span class="line">      &#125;</span><br><span class="line">      &#x2F;&#x2F; 如果 node 和 workInProgress 是同一个节点</span><br><span class="line">      &#x2F;&#x2F; 说明 node 已经退回到父级 终止循环</span><br><span class="line">      &#x2F;&#x2F; 说明此时所有子级都已经追加到父级中了</span><br><span class="line">      if (node &#x3D;&#x3D;&#x3D; workInProgress) &#123;</span><br><span class="line">        return;</span><br><span class="line">      &#125;</span><br><span class="line">      &#x2F;&#x2F; 处理子级节点的兄弟节点</span><br><span class="line">      while (node.sibling &#x3D;&#x3D;&#x3D; null) &#123;</span><br><span class="line">        &#x2F;&#x2F; 如果节点没有父级或者节点的父级是自己, 退出循环</span><br><span class="line">        &#x2F;&#x2F; 说明此时所有子级都已经追加到父级中了</span><br><span class="line">        if (node.return &#x3D;&#x3D;&#x3D; null || node.return &#x3D;&#x3D;&#x3D; workInProgress) &#123;</span><br><span class="line">          return;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 更新 node</span><br><span class="line">        node &#x3D; node.return;</span><br><span class="line">      &#125;</span><br><span class="line">      &#x2F;&#x2F; 更新父级 方便回退</span><br><span class="line">      node.sibling.return &#x3D; node.return;</span><br><span class="line">      &#x2F;&#x2F; 将 node 更新为下一个兄弟节点</span><br><span class="line">      node &#x3D; node.sibling;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<h3 id="21-从render阶段进入commit阶段"><a href="#21-从render阶段进入commit阶段" class="headerlink" title="21.从render阶段进入commit阶段"></a>21.从render阶段进入commit阶段</h3><blockquote>
<p>finishSyncRender</p>
</blockquote>
<p><code>文件位置: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">function finishSyncRender(root) &#123;</span><br><span class="line">  &#x2F;&#x2F; 销毁 workInProgress Fiber 树</span><br><span class="line">  &#x2F;&#x2F; 因为待提交 Fiber 对象已经被存储在了 root.finishedWork 中</span><br><span class="line">  workInProgressRoot &#x3D; null;</span><br><span class="line">  &#x2F;&#x2F; 进入 commit 阶段</span><br><span class="line">  commitRoot(root);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>commitRoot</p>
</blockquote>
<p><code>文件位置: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function commitRoot(root) &#123;</span><br><span class="line">  &#x2F;&#x2F; 获取任务优先级 97 &#x3D;&gt; 普通优先级</span><br><span class="line">  const renderPriorityLevel &#x3D; getCurrentPriorityLevel();</span><br><span class="line">  &#x2F;&#x2F; 使用最高优先级执行当前任务, 因为 commit 阶段不可以被打断</span><br><span class="line">  &#x2F;&#x2F; ImmediatePriority, 优先级为 99, 最高优先级</span><br><span class="line">  runWithPriority(</span><br><span class="line">    ImmediatePriority,</span><br><span class="line">    commitRootImpl.bind(null, root, renderPriorityLevel),</span><br><span class="line">  );</span><br><span class="line">  return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>commitRootImpl</p>
</blockquote>
<p>commit 阶段可以分为三个子阶段：</p>
<ul>
<li>before mutation 阶段（执行 DOM 操作前）</li>
<li>mutation 阶段（执行 DOM 操作）</li>
<li>layout 阶段（执行 DOM 操作后）</li>
</ul>
<p><code>文件位置: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">function commitRootImpl(root, renderPriorityLevel) &#123;</span><br><span class="line">  &#x2F;&#x2F; 获取待提交 Fiber 对象 rootFiber</span><br><span class="line">  const finishedWork &#x3D; root.finishedWork;</span><br><span class="line">  &#x2F;&#x2F; 如果没有任务要执行</span><br><span class="line">  if (finishedWork &#x3D;&#x3D;&#x3D; null) &#123;</span><br><span class="line">    &#x2F;&#x2F; 阻止程序继续向下执行</span><br><span class="line">    return null;</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; 重置为默认值</span><br><span class="line">  root.finishedWork &#x3D; null;</span><br><span class="line">  root.callbackNode &#x3D; null;</span><br><span class="line">  root.callbackExpirationTime &#x3D; NoWork;</span><br><span class="line">  root.callbackPriority &#x3D; NoPriority;</span><br><span class="line">  root.nextKnownPendingLevel &#x3D; NoWork;</span><br><span class="line">  </span><br><span class="line">  &#x2F;&#x2F; 获取要执行 DOM 操作的副作用列表</span><br><span class="line">  let firstEffect &#x3D; finishedWork.firstEffect;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; true</span><br><span class="line">  if (firstEffect !&#x3D;&#x3D; null) &#123;</span><br><span class="line">    &#x2F;&#x2F; commit 第一个子阶段</span><br><span class="line">    nextEffect &#x3D; firstEffect;</span><br><span class="line">    &#x2F;&#x2F; 处理类组件的 getSnapShotBeforeUpdate 生命周期函数</span><br><span class="line">    do &#123;</span><br><span class="line">      invokeGuardedCallback(null, commitBeforeMutationEffects, null);</span><br><span class="line">    &#125; while (nextEffect !&#x3D;&#x3D; null);</span><br><span class="line">    </span><br><span class="line">		&#x2F;&#x2F; commit 第二个子阶段</span><br><span class="line">    nextEffect &#x3D; firstEffect;</span><br><span class="line">    do &#123;</span><br><span class="line">      invokeGuardedCallback(null, commitMutationEffects, null, root, renderPriorityLevel);</span><br><span class="line">    &#125; while (nextEffect !&#x3D;&#x3D; null);</span><br><span class="line">    &#x2F;&#x2F; 将 workInProgress Fiber 树变成 current Fiber 树</span><br><span class="line">    root.current &#x3D; finishedWork;</span><br><span class="line">    </span><br><span class="line">		&#x2F;&#x2F; commit 第三个子阶段</span><br><span class="line">    nextEffect &#x3D; firstEffect;</span><br><span class="line">    do &#123;</span><br><span class="line">      invokeGuardedCallback(null, commitLayoutEffects, null, root,expirationTime);</span><br><span class="line">    &#125; while (nextEffect !&#x3D;&#x3D; null);</span><br><span class="line">		</span><br><span class="line">    &#x2F;&#x2F; 重置 nextEffect</span><br><span class="line">    nextEffect &#x3D; null;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="22-commit阶段的第一个子阶段"><a href="#22-commit阶段的第一个子阶段" class="headerlink" title="22.commit阶段的第一个子阶段"></a>22.commit阶段的第一个子阶段</h3><blockquote>
<p>commitBeforeMutationEffects</p>
</blockquote>
<p><code>文件位置: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; commit 阶段的第一个子阶段</span><br><span class="line">&#x2F;&#x2F; 调用类组件的 getSnapshotBeforeUpdate 生命周期函数</span><br><span class="line">function commitBeforeMutationEffects() &#123;</span><br><span class="line">  &#x2F;&#x2F; 循环 effect 链</span><br><span class="line">  while (nextEffect !&#x3D;&#x3D; null) &#123;</span><br><span class="line">    &#x2F;&#x2F; nextEffect 是 effect 链上从 firstEffect 到 lastEffec 的每一个需要commit的 fiber 对象</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 初始化渲染第一个 nextEffect 为 App 组件</span><br><span class="line">    &#x2F;&#x2F; effectTag &#x3D;&gt; 3</span><br><span class="line">    const effectTag &#x3D; nextEffect.effectTag;</span><br><span class="line">    &#x2F;&#x2F; console.log(effectTag);</span><br><span class="line">    &#x2F;&#x2F; nextEffect &#x3D; null;</span><br><span class="line">    &#x2F;&#x2F; return;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 如果 fiber 对象中里有 Snapshot 这个 effectTag 的话</span><br><span class="line">    &#x2F;&#x2F; Snapshot 和更新有关系 初始化渲染 不执行</span><br><span class="line">    &#x2F;&#x2F; false</span><br><span class="line">    if ((effectTag &amp; Snapshot) !&#x3D;&#x3D; NoEffect) &#123;</span><br><span class="line">      &#x2F;&#x2F; 获取当前 fiber 节点</span><br><span class="line">      const current &#x3D; nextEffect.alternate;</span><br><span class="line">      &#x2F;&#x2F; 当 nextEffect 上有 Snapshot 这个 effectTag 时</span><br><span class="line">      &#x2F;&#x2F; 执行以下方法, 主要是类组件调用 getSnapshotBeforeUpdate 生命周期函数</span><br><span class="line">      commitBeforeMutationEffectOnFiber(current, nextEffect);</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 更新循环条件</span><br><span class="line">    nextEffect &#x3D; nextEffect.nextEffect;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>commitBeforeMutationLifeCycles</p>
</blockquote>
<p><code>文件位置: packages/react-reconciler/src/ReactFiberCommitWork.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">function commitBeforeMutationLifeCycles(</span><br><span class="line">  current: Fiber | null,</span><br><span class="line">  finishedWork: Fiber,</span><br><span class="line">): void &#123;</span><br><span class="line">  switch (finishedWork.tag) &#123;</span><br><span class="line">    case FunctionComponent:</span><br><span class="line">    case ForwardRef:</span><br><span class="line">    case SimpleMemoComponent:</span><br><span class="line">    case Block: &#123;</span><br><span class="line">      return;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 如果该 fiber 类型是 ClassComponent</span><br><span class="line">    case ClassComponent: &#123;</span><br><span class="line">      if (finishedWork.effectTag &amp; Snapshot) &#123;</span><br><span class="line">        if (current !&#x3D;&#x3D; null) &#123;</span><br><span class="line">          &#x2F;&#x2F; 旧的 props</span><br><span class="line">          const prevProps &#x3D; current.memoizedProps;</span><br><span class="line">          &#x2F;&#x2F; 旧的 state</span><br><span class="line">          const prevState &#x3D; current.memoizedState;</span><br><span class="line">          &#x2F;&#x2F; 获取 classComponent 组件的实例对象</span><br><span class="line">          const instance &#x3D; finishedWork.stateNode;</span><br><span class="line">          &#x2F;&#x2F; 执行 getSnapshotBeforeUpdate 生命周期函数</span><br><span class="line">          &#x2F;&#x2F; 在组件更新前捕获一些 DOM 信息</span><br><span class="line">          &#x2F;&#x2F; 返回自定义的值或 null, 统称为 snapshot</span><br><span class="line">          const snapshot &#x3D; instance.getSnapshotBeforeUpdate(</span><br><span class="line">            finishedWork.elementType &#x3D;&#x3D;&#x3D; finishedWork.type</span><br><span class="line">              ? prevProps</span><br><span class="line">              : resolveDefaultProps(finishedWork.type, prevProps),</span><br><span class="line">            prevState,</span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      return;</span><br><span class="line">    &#125;</span><br><span class="line">    case HostRoot:</span><br><span class="line">    case HostComponent:</span><br><span class="line">    case HostText:</span><br><span class="line">    case HostPortal:</span><br><span class="line">    case IncompleteClassComponent:</span><br><span class="line">      &#x2F;&#x2F; Nothing to do for these component types</span><br><span class="line">      return;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="23-commit阶段的第二个子阶段"><a href="#23-commit阶段的第二个子阶段" class="headerlink" title="23.commit阶段的第二个子阶段"></a>23.commit阶段的第二个子阶段</h3><blockquote>
<p>commitMutationEffects</p>
</blockquote>
<p><code>文件位置: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; commit 阶段的第二个子阶段</span><br><span class="line">&#x2F;&#x2F; 根据 effectTag 执行 DOM 操作</span><br><span class="line">function commitMutationEffects(root: FiberRoot, renderPriorityLevel) &#123;</span><br><span class="line">  &#x2F;&#x2F; 循环 effect 链</span><br><span class="line">  while (nextEffect !&#x3D;&#x3D; null) &#123;</span><br><span class="line">    &#x2F;&#x2F; 获取 effectTag</span><br><span class="line">    &#x2F;&#x2F; 初始渲染第一次循环为 App 组件</span><br><span class="line">    &#x2F;&#x2F; 即将根组件及内部所有内容一次性添加到页面中</span><br><span class="line">    const effectTag &#x3D; nextEffect.effectTag;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 根据 effectTag 分别处理</span><br><span class="line">    let primaryEffectTag &#x3D;</span><br><span class="line">      effectTag &amp; (Placement | Update | Deletion | Hydrating);</span><br><span class="line">    &#x2F;&#x2F; 匹配 effectTag</span><br><span class="line">    &#x2F;&#x2F; 初始渲染 primaryEffectTag 为 2 匹配到 Placement</span><br><span class="line">    switch (primaryEffectTag) &#123;</span><br><span class="line">      &#x2F;&#x2F; 针对该节点及子节点进行插入操作</span><br><span class="line">      case Placement: &#123;</span><br><span class="line">        commitPlacement(nextEffect);</span><br><span class="line">        &#x2F;&#x2F; effectTag 从 3 变为 1</span><br><span class="line">        &#x2F;&#x2F; 从 effect 标签中清除 &quot;placement&quot; 重置 effectTag 值</span><br><span class="line">        &#x2F;&#x2F; 以便我们知道在调用诸如componentDidMount之类的任何生命周期之前已将其插入。</span><br><span class="line">        nextEffect.effectTag &amp;&#x3D; ~Placement;</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line">      &#x2F;&#x2F; 插入并更新 DOM</span><br><span class="line">      case PlacementAndUpdate: &#123;</span><br><span class="line">        &#x2F;&#x2F; 插入</span><br><span class="line">        commitPlacement(nextEffect);</span><br><span class="line">        nextEffect.effectTag &amp;&#x3D; ~Placement;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 更新</span><br><span class="line">        const current &#x3D; nextEffect.alternate;</span><br><span class="line">        commitWork(current, nextEffect);</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line">      &#x2F;&#x2F; 服务器端渲染</span><br><span class="line">      case Hydrating: &#123;</span><br><span class="line">        nextEffect.effectTag &amp;&#x3D; ~Hydrating;</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line">      &#x2F;&#x2F; 服务器端渲染</span><br><span class="line">      case HydratingAndUpdate: &#123;</span><br><span class="line">        nextEffect.effectTag &amp;&#x3D; ~Hydrating;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Update</span><br><span class="line">        const current &#x3D; nextEffect.alternate;</span><br><span class="line">        commitWork(current, nextEffect);</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line">      &#x2F;&#x2F; 更新 DOM</span><br><span class="line">      case Update: &#123;</span><br><span class="line">        const current &#x3D; nextEffect.alternate;</span><br><span class="line">        commitWork(current, nextEffect);</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line">      &#x2F;&#x2F; 删除 DOM</span><br><span class="line">      case Deletion: &#123;</span><br><span class="line">        commitDeletion(root, nextEffect, renderPriorityLevel);</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    nextEffect &#x3D; nextEffect.nextEffect;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>commitPlacement</p>
</blockquote>
<p><code>文件位置: packages/react-reconciler/src/ReactFiberCommitWork.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 挂载 DOM 元素</span><br><span class="line">function commitPlacement(finishedWork: Fiber): void &#123;</span><br><span class="line">  &#x2F;&#x2F; finishedWork 初始化渲染时为根组件 Fiber 对象</span><br><span class="line">  &#x2F;&#x2F; 获取非组件父级 Fiber 对象</span><br><span class="line">  &#x2F;&#x2F; 初始渲染时为 &lt;div id&#x3D;&quot;root&quot;&gt;&lt;&#x2F;div&gt;</span><br><span class="line">  const parentFiber &#x3D; getHostParentFiber(finishedWork);</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 存储真正的父级 DOM 节点对象</span><br><span class="line">  let parent;</span><br><span class="line">  &#x2F;&#x2F; 是否为渲染容器</span><br><span class="line">  &#x2F;&#x2F; 渲染容器和普通react元素的主要区别在于是否需要特殊处理注释节点</span><br><span class="line">  let isContainer;</span><br><span class="line">  &#x2F;&#x2F; 获取父级 DOM 节点对象</span><br><span class="line">  &#x2F;&#x2F; 但是初始渲染时 rootFiber 对象中的 stateNode 存储的是 FiberRoot</span><br><span class="line">  const parentStateNode &#x3D; parentFiber.stateNode;</span><br><span class="line">  &#x2F;&#x2F; 判断父节点的类型</span><br><span class="line">  &#x2F;&#x2F; 初始渲染时是 hostRoot 3</span><br><span class="line">  switch (parentFiber.tag) &#123;</span><br><span class="line">    case HostComponent:</span><br><span class="line">      parent &#x3D; parentStateNode;</span><br><span class="line">      isContainer &#x3D; false;</span><br><span class="line">      break;</span><br><span class="line">    case HostRoot:</span><br><span class="line">      &#x2F;&#x2F; 获取真正的 DOM 节点对象</span><br><span class="line">      &#x2F;&#x2F; &lt;div id&#x3D;&quot;root&quot;&gt;&lt;&#x2F;div&gt;</span><br><span class="line">      parent &#x3D; parentStateNode.containerInfo;</span><br><span class="line">      &#x2F;&#x2F; 是 container 容器</span><br><span class="line">      isContainer &#x3D; true;</span><br><span class="line">      break;</span><br><span class="line">    case HostPortal:</span><br><span class="line">      parent &#x3D; parentStateNode.containerInfo;</span><br><span class="line">      isContainer &#x3D; true;</span><br><span class="line">      break;</span><br><span class="line">    case FundamentalComponent:</span><br><span class="line">      if (enableFundamentalAPI) &#123;</span><br><span class="line">        parent &#x3D; parentStateNode.instance;</span><br><span class="line">        isContainer &#x3D; false;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; 查看当前节点是否有下一个兄弟节点</span><br><span class="line">  &#x2F;&#x2F; 有, 执行 insertBefore</span><br><span class="line">  &#x2F;&#x2F; 没有, 执行 appendChild</span><br><span class="line">  const before &#x3D; getHostSibling(finishedWork);</span><br><span class="line">	&#x2F;&#x2F; 渲染容器</span><br><span class="line">  if (isContainer) &#123;</span><br><span class="line">    &#x2F;&#x2F; 向父节点中追加节点 或者 将子节点插入到 before 节点的前面</span><br><span class="line">    insertOrAppendPlacementNodeIntoContainer(finishedWork, before, parent);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    &#x2F;&#x2F; 非渲染容器</span><br><span class="line">    &#x2F;&#x2F; 向父节点中追加节点 或者 将子节点插入到 before 节点的前面</span><br><span class="line">    insertOrAppendPlacementNode(finishedWork, before, parent);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>getHostParentFiber</p>
</blockquote>
<p><code>文件位置: packages/react-reconciler/src/ReactFiberCommitWork.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 获取 HostRootFiber 对象</span><br><span class="line">function getHostParentFiber(fiber: Fiber): Fiber &#123;</span><br><span class="line">  &#x2F;&#x2F; 获取当前 Fiber 父级</span><br><span class="line">  let parent &#x3D; fiber.return;</span><br><span class="line">  &#x2F;&#x2F; 查看父级是否为 null</span><br><span class="line">  while (parent !&#x3D;&#x3D; null) &#123;</span><br><span class="line">    &#x2F;&#x2F; 查看父级是否为 hostRoot</span><br><span class="line">    if (isHostParent(parent)) &#123;</span><br><span class="line">      &#x2F;&#x2F; 返回</span><br><span class="line">      return parent;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 继续向上查找</span><br><span class="line">    parent &#x3D; parent.return;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>insertOrAppendPlacementNodeIntoContainer</p>
</blockquote>
<p><code>文件位置: packages/react-reconciler/src/ReactFiberCommitWork.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 向容器中追加 | 插入到某一个节点的前面</span><br><span class="line">function insertOrAppendPlacementNodeIntoContainer(</span><br><span class="line">  node: Fiber,</span><br><span class="line">  before: ?Instance,</span><br><span class="line">  parent: Container,</span><br><span class="line">): void &#123;</span><br><span class="line">  const &#123;tag&#125; &#x3D; node;</span><br><span class="line">  &#x2F;&#x2F; 如果待插入的节点是一个 DOM 元素或者文本的话</span><br><span class="line">  &#x2F;&#x2F; 比如 组件fiber &#x3D;&gt; false div &#x3D;&gt; true</span><br><span class="line">  const isHost &#x3D; tag &#x3D;&#x3D;&#x3D; HostComponent || tag &#x3D;&#x3D;&#x3D; HostText;</span><br><span class="line"></span><br><span class="line">  if (isHost || (enableFundamentalAPI &amp;&amp; tag &#x3D;&#x3D;&#x3D; FundamentalComponent)) &#123;</span><br><span class="line">    &#x2F;&#x2F; 获取 DOM 节点</span><br><span class="line">    const stateNode &#x3D; isHost ? node.stateNode : node.stateNode.instance;</span><br><span class="line">    &#x2F;&#x2F; 如果 before 存在</span><br><span class="line">    if (before) &#123;</span><br><span class="line">      &#x2F;&#x2F; 插入到 before 前面</span><br><span class="line">      insertInContainerBefore(parent, stateNode, before);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      &#x2F;&#x2F; 追加到父容器中</span><br><span class="line">      appendChildToContainer(parent, stateNode);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    &#x2F;&#x2F; 如果是组件节点, 比如 ClassComponent, 则找它的第一个子节点(DOM 元素)</span><br><span class="line">    &#x2F;&#x2F; 进行插入操作</span><br><span class="line">    const child &#x3D; node.child;</span><br><span class="line">    if (child !&#x3D;&#x3D; null) &#123;</span><br><span class="line">      &#x2F;&#x2F; 向父级中追加子节点或者将子节点插入到 before 的前面</span><br><span class="line">      insertOrAppendPlacementNodeIntoContainer(child, before, parent);</span><br><span class="line">      &#x2F;&#x2F; 获取下一个兄弟节点</span><br><span class="line">      let sibling &#x3D; child.sibling;</span><br><span class="line">      &#x2F;&#x2F; 如果兄弟节点存在</span><br><span class="line">      while (sibling !&#x3D;&#x3D; null) &#123;</span><br><span class="line">        &#x2F;&#x2F; 向父级中追加子节点或者将子节点插入到 before 的前面</span><br><span class="line">        insertOrAppendPlacementNodeIntoContainer(sibling, before, parent);</span><br><span class="line">        &#x2F;&#x2F; 同步兄弟节点</span><br><span class="line">        sibling &#x3D; sibling.sibling;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>insertInContainerBefore</p>
</blockquote>
<p><code>文件位置: packages/react-dom/src/client/ReactDOMHostConfig.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">export function insertInContainerBefore(</span><br><span class="line">  container: Container,</span><br><span class="line">  child: Instance | TextInstance,</span><br><span class="line">  beforeChild: Instance | TextInstance | SuspenseInstance,</span><br><span class="line">): void &#123;</span><br><span class="line">  &#x2F;&#x2F; 如果父容器是注释节点</span><br><span class="line">  if (container.nodeType &#x3D;&#x3D;&#x3D; COMMENT_NODE) &#123;</span><br><span class="line">    &#x2F;&#x2F; 找到注释节点的父级节点 因为注释节点没法调用 insertBefore</span><br><span class="line">    (container.parentNode: any).insertBefore(child, beforeChild);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    &#x2F;&#x2F; 将 child 插入到 beforeChild 的前面</span><br><span class="line">    container.insertBefore(child, beforeChild);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>appendChildToContainer</p>
</blockquote>
<p><code>文件位置: packages/react-dom/src/client/ReactDOMHostConfig.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">export function appendChildToContainer(</span><br><span class="line">  container: Container,</span><br><span class="line">  child: Instance | TextInstance,</span><br><span class="line">): void &#123;</span><br><span class="line">  &#x2F;&#x2F; 监测 container 是否注释节点</span><br><span class="line">  if (container.nodeType &#x3D;&#x3D;&#x3D; COMMENT_NODE) &#123;</span><br><span class="line">    &#x2F;&#x2F; 获取父级的父级</span><br><span class="line">    parentNode &#x3D; (container.parentNode: any);</span><br><span class="line">    &#x2F;&#x2F; 将子级节点插入到注释节点的前面</span><br><span class="line">    parentNode.insertBefore(child, container);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    &#x2F;&#x2F; 直接将 child 插入到父级中</span><br><span class="line">    parentNode &#x3D; container;</span><br><span class="line">    parentNode.appendChild(child);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="24-commit阶段的第三个子阶段-一"><a href="#24-commit阶段的第三个子阶段-一" class="headerlink" title="24.commit阶段的第三个子阶段(一)"></a>24.commit阶段的第三个子阶段(一)</h3><blockquote>
<p>commitLayoutEffects</p>
</blockquote>
<p><code>文件位置: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; commit 阶段的第三个子阶段</span><br><span class="line">function commitLayoutEffects(</span><br><span class="line">  root: FiberRoot,</span><br><span class="line">  committedExpirationTime: ExpirationTime,</span><br><span class="line">) &#123;</span><br><span class="line">  while (nextEffect !&#x3D;&#x3D; null) &#123;</span><br><span class="line">    &#x2F;&#x2F; 此时 effectTag 已经被重置为 1, 表示 DOM 操作已经完成</span><br><span class="line">    const effectTag &#x3D; nextEffect.effectTag;</span><br><span class="line">    &#x2F;&#x2F; 调用生命周期函数和钩子函数</span><br><span class="line">    &#x2F;&#x2F; 前提是类组件中调用了生命周期函数 或者函数组件中调用了 useEffect</span><br><span class="line">    if (effectTag &amp; (Update | Callback)) &#123;</span><br><span class="line">      &#x2F;&#x2F; 类组件处理生命周期函数</span><br><span class="line">      &#x2F;&#x2F; 函数组件处理钩子函数</span><br><span class="line">      commitLayoutEffectOnFiber(root, current,nextEffect, committedExpirationTime);</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 更新循环条件</span><br><span class="line">    nextEffect &#x3D; nextEffect.nextEffect;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>commitLifeCycles</p>
</blockquote>
<p><code>文件位置: packages/react-reconciler/src/ReactFiberCommitWork.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">function commitLifeCycles(</span><br><span class="line">  finishedRoot: FiberRoot,</span><br><span class="line">  current: Fiber | null,</span><br><span class="line">  finishedWork: Fiber,</span><br><span class="line">  committedExpirationTime: ExpirationTime,</span><br><span class="line">): void &#123;</span><br><span class="line">  switch (finishedWork.tag) &#123;</span><br><span class="line">    case FunctionComponent: &#123;</span><br><span class="line">      &#x2F;&#x2F; 处理钩子函数</span><br><span class="line">      commitHookEffectListMount(HookLayout | HookHasEffect, finishedWork);</span><br><span class="line">      return;</span><br><span class="line">    &#125;</span><br><span class="line">    case ClassComponent: &#123;</span><br><span class="line">      &#x2F;&#x2F; 获取类组件实例对象</span><br><span class="line">      const instance &#x3D; finishedWork.stateNode;</span><br><span class="line">      &#x2F;&#x2F; 如果在类组件中存在生命周期函数判断条件就会成立</span><br><span class="line">      if (finishedWork.effectTag &amp; Update) &#123;</span><br><span class="line">        &#x2F;&#x2F; 初始渲染阶段</span><br><span class="line">        if (current &#x3D;&#x3D;&#x3D; null) &#123;</span><br><span class="line">          &#x2F;&#x2F; 调用 componentDidMount 生命周期函数</span><br><span class="line">          instance.componentDidMount();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          &#x2F;&#x2F; 更新阶段</span><br><span class="line">          &#x2F;&#x2F; 获取旧的 props</span><br><span class="line">          const prevProps &#x3D; finishedWork.elementType &#x3D;&#x3D;&#x3D; finishedWork.type</span><br><span class="line">              ? current.memoizedProps</span><br><span class="line">              : resolveDefaultProps(finishedWork.type, current.memoizedProps);</span><br><span class="line">          &#x2F;&#x2F; 获取旧的 state</span><br><span class="line">          const prevState &#x3D; current.memoizedState;</span><br><span class="line">          &#x2F;&#x2F; 调用 componentDidUpdate 生命周期函数</span><br><span class="line">          &#x2F;&#x2F; instance.__reactInternalSnapshotBeforeUpdate 快照 getSnapShotBeforeUpdate 方法的返回值</span><br><span class="line">          instance.componentDidUpdate(prevProps, prevState, instance.__reactInternalSnapshotBeforeUpdate);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      &#x2F;&#x2F; 获取任务队列</span><br><span class="line">      const updateQueue &#x3D; finishedWork.updateQueue;</span><br><span class="line">      &#x2F;&#x2F; 如果任务队列存在</span><br><span class="line">      if (updateQueue !&#x3D;&#x3D; null) &#123;</span><br><span class="line">        &#x2F;**</span><br><span class="line">         * 调用 ReactElement 渲染完成之后的回调函数</span><br><span class="line">         * 即 render 方法的第三个参数</span><br><span class="line">         *&#x2F;</span><br><span class="line">        commitUpdateQueue(finishedWork, updateQueue, instance);</span><br><span class="line">      &#125;</span><br><span class="line">      return;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>commitUpdateQueue</p>
</blockquote>
<p><code>文件位置: packages/react-reconciler/src/ReactUpdateQueue.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 执行渲染完成之后的回调函数</span><br><span class="line"> *&#x2F;</span><br><span class="line">export function commitUpdateQueue&lt;State&gt;(</span><br><span class="line">  finishedWork: Fiber,</span><br><span class="line">  finishedQueue: UpdateQueue&lt;State&gt;,</span><br><span class="line">  instance: any,</span><br><span class="line">): void &#123;</span><br><span class="line">  &#x2F;&#x2F; effects 为数组, 存储任务对象 (Update 对象)</span><br><span class="line">  &#x2F;&#x2F; 但前提是在调用 render 方法时传递了回调函数, 就是 render 方法的第三个参数</span><br><span class="line">  const effects &#x3D; finishedQueue.effects;</span><br><span class="line">  &#x2F;&#x2F; 重置 finishedQueue.effects 数组</span><br><span class="line">  finishedQueue.effects &#x3D; null;</span><br><span class="line">  &#x2F;&#x2F; 如果传递了 render 方法的第三个参数, effect 数组就不会为 null</span><br><span class="line">  if (effects !&#x3D;&#x3D; null) &#123;</span><br><span class="line">    &#x2F;&#x2F; 遍历 effect 数组</span><br><span class="line">    for (let i &#x3D; 0; i &lt; effects.length; i++) &#123;</span><br><span class="line">      &#x2F;&#x2F; 获取数组中的第 i 个需要执行的 effect</span><br><span class="line">      const effect &#x3D; effects[i];</span><br><span class="line">      &#x2F;&#x2F; 获取 callback 回调函数</span><br><span class="line">      const callback &#x3D; effect.callback;</span><br><span class="line">      &#x2F;&#x2F; 如果回调函数不为 null</span><br><span class="line">      if (callback !&#x3D;&#x3D; null) &#123;</span><br><span class="line">        &#x2F;&#x2F; 清空 effect 中的 callback</span><br><span class="line">        effect.callback &#x3D; null;</span><br><span class="line">        &#x2F;&#x2F; 执行回调函数</span><br><span class="line">        callCallback(callback, instance);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>commitHookEffectListMount</p>
</blockquote>
<p><code>文件位置: packages/react-reconciler/src/ReactFiberCommitWork.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * useEffect 回调函数调用</span><br><span class="line"> *&#x2F;</span><br><span class="line">function commitHookEffectListMount(tag: number, finishedWork: Fiber) &#123;</span><br><span class="line">  &#x2F;&#x2F; 获取任务队列</span><br><span class="line">  const updateQueue: FunctionComponentUpdateQueue | null &#x3D; (finishedWork.updateQueue: any);</span><br><span class="line">  &#x2F;&#x2F; 获取 lastEffect</span><br><span class="line">  let lastEffect &#x3D; updateQueue !&#x3D;&#x3D; null ? updateQueue.lastEffect : null;</span><br><span class="line">  &#x2F;&#x2F; 如果 lastEffect 不为 null</span><br><span class="line">  if (lastEffect !&#x3D;&#x3D; null) &#123;</span><br><span class="line">    &#x2F;&#x2F; 获取要执行的副作用</span><br><span class="line">    const firstEffect &#x3D; lastEffect.next;</span><br><span class="line">    let effect &#x3D; firstEffect;</span><br><span class="line">    &#x2F;&#x2F; 通过遍历的方式调用 useEffect 中的回调函数</span><br><span class="line">    &#x2F;&#x2F; 在组件中定义了调用了几次 useEffect 遍历就会执行几次</span><br><span class="line">    do &#123;</span><br><span class="line">      if ((effect.tag &amp; tag) &#x3D;&#x3D;&#x3D; tag) &#123;</span><br><span class="line">        &#x2F;&#x2F; Mount</span><br><span class="line">        const create &#x3D; effect.create;</span><br><span class="line">        &#x2F;&#x2F; create 就是 useEffect 方法的第一个参数</span><br><span class="line">        &#x2F;&#x2F; 返回值就是清理函数</span><br><span class="line">        effect.destroy &#x3D; create();</span><br><span class="line">      &#125;</span><br><span class="line">      &#x2F;&#x2F; 更新循环条件</span><br><span class="line">      effect &#x3D; effect.next;</span><br><span class="line">    &#125; while (effect !&#x3D;&#x3D; firstEffect);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="25-commit阶段的第三个子阶段-二"><a href="#25-commit阶段的第三个子阶段-二" class="headerlink" title="25.commit阶段的第三个子阶段(二)"></a>25.commit阶段的第三个子阶段(二)</h3>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="accessibility.next_page"></i></a>
  </nav>

          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="FY" />
            
              <p class="site-author-name" itemprop="name">FY</p>
              <p class="site-description motion-element" itemprop="description">Just Be Yourself</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">47</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">16</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/xuanfeiyu" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">FY</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
