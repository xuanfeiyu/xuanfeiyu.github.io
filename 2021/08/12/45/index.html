<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Node," />










<meta name="description" content="作者：FY引用请标明出处  Part 5 · Node.js 全栈开发模块一 · Node.js 高级编程（核心模块、模块加载机制）node 基础1.课程概述大前端开发的必备技能  Nodejs 可以做什么？   轻量级、高性能的Web服务 前后端 JavaScript 同构开发 便捷高效的前端工程化  Nodejs的架构和运行过程Nodejs异步IO和事件驱动Nodejs单线程Nodejs实现">
<meta property="og:type" content="article">
<meta property="og:title" content="学习笔记 ----- 【Node.js 全栈开发】Node.js 高级编程（核心模块、模块加载机制）">
<meta property="og:url" content="http://yoursite.com/2021/08/12/45/index.html">
<meta property="og:site_name" content="旋の飞羽">
<meta property="og:description" content="作者：FY引用请标明出处  Part 5 · Node.js 全栈开发模块一 · Node.js 高级编程（核心模块、模块加载机制）node 基础1.课程概述大前端开发的必备技能  Nodejs 可以做什么？   轻量级、高性能的Web服务 前后端 JavaScript 同构开发 便捷高效的前端工程化  Nodejs的架构和运行过程Nodejs异步IO和事件驱动Nodejs单线程Nodejs实现">
<meta property="article:published_time" content="2021-08-11T16:00:00.000Z">
<meta property="article:modified_time" content="2021-08-12T00:59:04.363Z">
<meta property="article:author" content="FY">
<meta property="article:tag" content="Node">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2021/08/12/45/"/>





  <title>学习笔记 ----- 【Node.js 全栈开发】Node.js 高级编程（核心模块、模块加载机制） | 旋の飞羽</title>
  








<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">旋の飞羽</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">人间值得，未来可期。</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/08/12/45/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="FY">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="旋の飞羽">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">学习笔记 ----- 【Node.js 全栈开发】Node.js 高级编程（核心模块、模块加载机制）</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-08-12T00:00:00+08:00">
                2021-08-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index">
                    <span itemprop="name">前端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>作者：FY<br>引用请标明出处</p>
</blockquote>
<h1 id="Part-5-·-Node-js-全栈开发"><a href="#Part-5-·-Node-js-全栈开发" class="headerlink" title="Part 5 · Node.js 全栈开发"></a>Part 5 · Node.js 全栈开发</h1><h2 id="模块一-·-Node-js-高级编程（核心模块、模块加载机制）"><a href="#模块一-·-Node-js-高级编程（核心模块、模块加载机制）" class="headerlink" title="模块一 · Node.js 高级编程（核心模块、模块加载机制）"></a>模块一 · Node.js 高级编程（核心模块、模块加载机制）</h2><h2 id="node-基础"><a href="#node-基础" class="headerlink" title="node 基础"></a>node 基础</h2><h3 id="1-课程概述"><a href="#1-课程概述" class="headerlink" title="1.课程概述"></a>1.课程概述</h3><p>大前端开发的必备技能</p>
<blockquote>
<p>Nodejs 可以做什么？</p>
</blockquote>
<ul>
<li>轻量级、高性能的Web服务</li>
<li>前后端 JavaScript 同构开发</li>
<li>便捷高效的前端工程化</li>
</ul>
<p>Nodejs的架构和运行过程<br>Nodejs异步IO和事件驱动<br>Nodejs单线程<br>Nodejs实现API服务<br>Nodejs核心模块及API使用</p>
<h3 id="2-Nodejs-架构"><a href="#2-Nodejs-架构" class="headerlink" title="2.Nodejs 架构"></a>2.Nodejs 架构</h3><blockquote>
<p>Natives modules</p>
</blockquote>
<ul>
<li>当前层内容由 JS 实现</li>
<li>提供应用程序可直接调用库，例如fs、path、http等</li>
<li>JS 语言无法直接操作底层硬件设置</li>
</ul>
<blockquote>
<p>Bulitin modules “胶水层”</p>
</blockquote>
<blockquote>
<p>底层</p>
</blockquote>
<ul>
<li>v8：执行 JS 代码，提供桥梁接口</li>
<li>Libuv：事件循环、事件队列、异步IO</li>
</ul>
<h3 id="3-为什么是Nodejs"><a href="#3-为什么是Nodejs" class="headerlink" title="3.为什么是Nodejs"></a>3.为什么是Nodejs</h3><p>Reactor模式，单线程完成多线程工作<br>Reactor模式下实现异步IO、事件驱动<br>Nodejs更适用于IO密集型高并发请求</p>
<h3 id="4-Nodejs异步IO"><a href="#4-Nodejs异步IO" class="headerlink" title="4.Nodejs异步IO"></a>4.Nodejs异步IO</h3><p>期望实现无须主动判断的非阻塞IO</p>
<blockquote>
<p>异步IO总结</p>
</blockquote>
<ul>
<li>IO是应用程序的瓶颈所在</li>
<li>异步IO提高性能无须原地等待结果返回</li>
<li>IO操作属于操作系统级别，平台都有对应实现</li>
<li>Nodejs 单线程配合事件驱动架构及libbuv实现了异步IO</li>
</ul>
<h3 id="5-事件驱动架构"><a href="#5-事件驱动架构" class="headerlink" title="5.事件驱动架构"></a>5.事件驱动架构</h3><p>事件驱动架构是软件开发中的通用模式<br>主体发布消息，其它实例接收消息</p>
<h3 id="6-Nodejs单线程"><a href="#6-Nodejs单线程" class="headerlink" title="6.Nodejs单线程"></a>6.Nodejs单线程</h3><blockquote>
<p>单线程如何实现高并发？</p>
</blockquote>
<p>异步非阻塞IO配合事件回调通知</p>
<blockquote>
<p>Nodejs主线程是单线程</p>
</blockquote>
<h3 id="7-Nodejs应用场景"><a href="#7-Nodejs应用场景" class="headerlink" title="7.Nodejs应用场景"></a>7.Nodejs应用场景</h3><ul>
<li>IO密集型高并发请求</li>
<li>操作数据库提供API服务</li>
<li>实时聊天应用程序</li>
<li>Nodejs更加适合IO密集型任务</li>
</ul>
<h3 id="8-Nodejs实现API服务"><a href="#8-Nodejs实现API服务" class="headerlink" title="8.Nodejs实现API服务"></a>8.Nodejs实现API服务</h3><ul>
<li>npm init -y</li>
<li>npm i typescript -g</li>
<li>tsc –init</li>
<li>npm i ts-node</li>
<li>npm i express</li>
<li>npm i @types/express -D</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        'name':'zce',</span><br><span class="line">        'age':'38',</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        'name':'syy',</span><br><span class="line">        'age':'18',</span><br><span class="line">    &#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// data.ts</span></span><br><span class="line"><span class="comment">// tsconfig.json   resolveJsonModule: true</span></span><br><span class="line"><span class="keyword">import</span> list <span class="keyword">from</span> <span class="string">'./list.json'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> DataStore&#123;</span><br><span class="line">    <span class="keyword">static</span> list = list</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// require 在ts不支持</span></span><br><span class="line"><span class="keyword">import</span> express <span class="keyword">from</span> <span class="string">'express'</span></span><br><span class="line"><span class="keyword">import</span> &#123;DataStore&#125; <span class="keyword">from</span> <span class="string">'./data'</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(DataStore.list)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>,<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;</span><br><span class="line"><span class="comment">//   res.end('1122')</span></span><br><span class="line">res.json(DataStore.list)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">8080</span>,<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'服务已经开启了'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="9-Nodejs全局对象"><a href="#9-Nodejs全局对象" class="headerlink" title="9.Nodejs全局对象"></a>9.Nodejs全局对象</h3><blockquote>
<p>Nodejs全局对象</p>
</blockquote>
<ul>
<li>与浏览器平台的 window 不完全相同</li>
<li>Nodejs全局对象上挂载许多属性</li>
</ul>
<p>全局对象是Javascript中的特殊对象，Nodejs 中全局对象是 global。<br>Global的根本作用就是作为宿主。<br>全局对象可以看做是全局变量的宿主。</p>
<blockquote>
<p>Nodejs 常见的全局变量</p>
</blockquote>
<ul>
<li>__filName: 返回正在执行脚本文件的绝对路径</li>
<li>__dirName: 返回正在执行脚本所在目录</li>
<li>timer类函数: 执行顺序与事件循环间的关系</li>
<li>process: 提供与当前进程互动的接口</li>
<li>require: 实现模块的加载</li>
<li>module、exports: 处理模块的导出</li>
</ul>
<p>** 默认情况 this 是空对象，和 global 并不是一样的 **</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="keyword">this</span> == global) <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>==global)  <span class="comment">// true</span></span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<h3 id="10-全局变量-process-1"><a href="#10-全局变量-process-1" class="headerlink" title="10.全局变量-process-1"></a>10.全局变量-process-1</h3><ul>
<li>无须 require 可直接使用</li>
<li>获取进程信息</li>
<li>执行进程操作</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.资源：cpu 内存</span></span><br><span class="line"><span class="comment">// console.log(process.memoryUsage())</span></span><br><span class="line"><span class="comment">// console.log(process.cpuUsage())</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2 运行环境：运行目录、node环境、cpu架构、用户环境、系统平台</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(process.cwd())</span><br><span class="line"><span class="built_in">console</span>.log(process.version)</span><br><span class="line"><span class="built_in">console</span>.log(process.versions)</span><br><span class="line"><span class="built_in">console</span>.log(process.arch)  <span class="comment">// x64</span></span><br><span class="line"><span class="built_in">console</span>.log(process.env.NODE_ENV)</span><br><span class="line"><span class="built_in">console</span>.log(process.env.PATH)</span><br><span class="line"><span class="built_in">console</span>.log(process.env.USERPROFILE) <span class="comment">// 管理员目录 mac =&gt; HOME</span></span><br><span class="line"><span class="built_in">console</span>.log(process.platform) <span class="comment">// win32</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3 运行状态：启动参数、PID、运行时间</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(process.argv)</span><br><span class="line"><span class="built_in">console</span>.log(process.argv0) <span class="comment">// 注意：没有 argv1</span></span><br><span class="line"><span class="built_in">console</span>.log(process.pid)</span><br><span class="line"><span class="built_in">console</span>.log(process.uptime())</span><br></pre></td></tr></table></figure>

<h3 id="11-全局变量-process-2"><a href="#11-全局变量-process-2" class="headerlink" title="11.全局变量-process-2"></a>11.全局变量-process-2</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 4 事件</span></span><br><span class="line">process.on(<span class="string">'exit'</span>,(code)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'exit'</span> + code)</span><br><span class="line">    <span class="comment">// 只能写同步代码</span></span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="number">123</span>)</span><br><span class="line">    &#125;,<span class="number">1000</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">process.on(<span class="string">'beoforeExit'</span>,(code)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'beofore exit'</span> + code)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">process.exit()</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'代码执行完了'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5 标准输出 输入 错误</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log = <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    process.stdout.write(<span class="string">'----'</span> + data + <span class="string">'\n'</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line">fs.createReadStream(<span class="string">'test.txt'</span>).pipe(process.stdout)</span><br><span class="line"></span><br><span class="line">process.stdin.pipe(process.stdout)</span><br><span class="line"></span><br><span class="line">process.stdin.setEncoding(<span class="string">'utf-8'</span>)</span><br><span class="line">process.stdin.on(<span class="string">'readable'</span>,()=&gt;&#123;</span><br><span class="line">    <span class="keyword">let</span> chunk = process.stdin.read()</span><br><span class="line">    <span class="keyword">if</span>(chunk!=<span class="literal">null</span>)&#123;</span><br><span class="line">        process.stdout.write(<span class="string">'data'</span> + chunk)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="模块二-·-核心模块"><a href="#模块二-·-核心模块" class="headerlink" title="模块二 · 核心模块"></a>模块二 · 核心模块</h2><h3 id="1-核心模块-path-1"><a href="#1-核心模块-path-1" class="headerlink" title="1.核心模块-path-1"></a>1.核心模块-path-1</h3><p>内置模块，require 之后直接使用<br>用于处理文件/目录的路径</p>
<blockquote>
<p>path 模块常用 API</p>
</blockquote>
<ul>
<li>basename() 获取路径中基础名称</li>
<li>dirname() 获取路径中目录名称</li>
<li>extname() 获取路径中扩展名称</li>
<li>isAbsolute() 获取路径是否为绝对路径</li>
<li>join() 拼接多个路径片段</li>
<li>resolve() 返回绝对路径</li>
<li>pasre() 解析路径</li>
<li>format() 序列化路径</li>
<li>normalize() 规范化路径</li>
</ul>
<h3 id="2-核心模块-path-2"><a href="#2-核心模块-path-2" class="headerlink" title="2.核心模块-path-2"></a>2.核心模块-path-2</h3><p>略</p>
<h3 id="3-全局变量之Buffer"><a href="#3-全局变量之Buffer" class="headerlink" title="3.全局变量之Buffer"></a>3.全局变量之Buffer</h3><p>Buffer 缓冲区<br>Buffer 让 Javascript 可以操作二进制<br>Javascript 语言起初服务于浏览器平台<br>Nodejs 平台下 Javascript 可实现 IO<br>IO 行为操作的就是二进制数据<br>Stream 流操作并非 Nodejs 独创<br>流操作配合管道实现数据分段传输<br>数据的端到端传输会有生产者和消费者<br>生产和消费的过程往往存在等待<br>产生等待时数据存放在哪？<br>Nodejs 中 Buffer 是一片内存空间</p>
<blockquote>
<p>Buffer 总结</p>
</blockquote>
<ul>
<li>无须 require 的一个全局变量</li>
<li>实现 Nodejs 平台下的二进制数据操作</li>
<li>不占据 V8 堆内存大小的内存空间</li>
<li>内存的使用由 Node 来控制，由 V8 的 GC 回收</li>
<li>一般配合 Stream 流使用，充当数据缓冲区</li>
</ul>
<h3 id="4-创建Buffer"><a href="#4-创建Buffer" class="headerlink" title="4.创建Buffer"></a>4.创建Buffer</h3><p>Buffer 是 Nodejs 的内置类<br>了解如何创建 Buffer 实例</p>
<blockquote>
<p>创建 Buffer 实例</p>
</blockquote>
<ul>
<li>alloc: 创建指定字节大小的 buffer</li>
<li>allocUnsafe: 创建指定大小的 buffer （不安全）</li>
<li>from: 接收数据，创建 buffer</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> b1 = Buffer.alloc(<span class="number">10</span>)</span><br><span class="line"><span class="keyword">const</span> b2 = Buffer.allocUnsafe(<span class="number">10</span>)</span><br><span class="line"><span class="built_in">console</span>.log(b1)</span><br><span class="line"><span class="built_in">console</span>.log(b2)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> b3 = Buffer.from(<span class="string">'1'</span>,<span class="string">'utf-8'</span>)</span><br><span class="line"><span class="built_in">console</span>.log(b3)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> b4 = Buffer.from([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>])</span><br><span class="line"><span class="built_in">console</span>.log(b4)</span><br></pre></td></tr></table></figure>

<h3 id="5-Buffer实例方法"><a href="#5-Buffer实例方法" class="headerlink" title="5.Buffer实例方法"></a>5.Buffer实例方法</h3><ul>
<li>fill: 使用数据填充 buffer</li>
<li>write: 向 buffer 中写入数据</li>
<li>toString: 从 buffer 中提取数据</li>
<li>slice: 截取 buffer</li>
<li>indexOf: 在 buffer 中查找数据</li>
<li>copy: 拷贝 buffer 中的数据</li>
</ul>
<h3 id="6-Buffer静态方法"><a href="#6-Buffer静态方法" class="headerlink" title="6.Buffer静态方法"></a>6.Buffer静态方法</h3><ul>
<li>concat: 将多个 buffer 拼接成一个新的 buffer</li>
<li>isBuffer: 判断当前数据是否为 buffer</li>
</ul>
<h3 id="7-Buffer-split实现"><a href="#7-Buffer-split实现" class="headerlink" title="7.Buffer-split实现"></a>7.Buffer-split实现</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ArrayBuffer</span>.proptoype.split = <span class="function"><span class="keyword">function</span>(<span class="params">sep</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> len = Buffer.from(sep).length</span><br><span class="line">    <span class="keyword">let</span> ret = []</span><br><span class="line">    <span class="keyword">let</span> start = <span class="number">0</span></span><br><span class="line">    <span class="keyword">let</span> offset = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(offset = <span class="keyword">this</span>.indexOf(sep,start)!==<span class="number">-1</span>)&#123;</span><br><span class="line">        ret.push(<span class="keyword">this</span>.slice(start,offset))</span><br><span class="line">        start = offset + len</span><br><span class="line">    &#125;</span><br><span class="line">    ret.push(<span class="keyword">this</span>.slice(start))</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-核心模块之FS"><a href="#8-核心模块之FS" class="headerlink" title="8.核心模块之FS"></a>8.核心模块之FS</h3><p>FS 是内置核心模块，提供文件系统操作的 API</p>
<blockquote>
<p>FS 模块结构</p>
</blockquote>
<ul>
<li>FS 基本操作类</li>
<li>FS 常用API</li>
</ul>
<p>权限位、标识符、文件描述符</p>
<p>用户对于文件所具备的操作权限<br>Nodejs 中 flag 表示对文件操作方式</p>
<blockquote>
<p>常见 flag 操作符</p>
</blockquote>
<ul>
<li>r: 表示可读</li>
<li>w: 表示可写</li>
<li>s: 表示同步</li>
<li>+: 表示执行相反操作</li>
<li>x: 表示排它操作</li>
<li>a: 表示追加操作</li>
</ul>
<p>fd 就是操作系统分配给被打开文件的标识</p>
<h3 id="9-文件操作API"><a href="#9-文件操作API" class="headerlink" title="9.文件操作API"></a>9.文件操作API</h3><ul>
<li>readFile: 从指定文件中读取数据</li>
<li>writeFile: 向指定文件中写入数据</li>
<li>appendFile: 追加的方式向指定文件中写入数据</li>
<li>copyFile: 将谋个文件中的数据拷贝至另一文件</li>
<li>watchFile: 对指定文件进行监控</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>) </span><br><span class="line"><span class="comment">// readFile</span></span><br><span class="line">fs.readFile(path.resolve(<span class="string">'data.txt'</span>),<span class="string">'utf-8'</span>,(err,data)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err)</span><br><span class="line">  <span class="keyword">if</span>(!<span class="literal">null</span>)&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(data)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// writeFile</span></span><br><span class="line">fs.writeFile(<span class="string">'data.txt'</span>, <span class="string">'hello node.js'</span>,&#123;</span><br><span class="line">    mode: <span class="number">438</span>,</span><br><span class="line">    flag: <span class="string">'r+'</span>,</span><br><span class="line">    encoding: <span class="string">'utf-8'</span>,</span><br><span class="line">&#125;,(err)=&gt;&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span>(!err)&#123;</span><br><span class="line">        fs.readFile(<span class="string">'data.txt'</span>,<span class="string">'utf-8'</span>,(err,data)=&gt;&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(data)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// watchFile</span></span><br><span class="line">fs.watchFile(<span class="string">'data.txt'</span>,&#123;<span class="attr">interval</span>: <span class="number">20</span>&#125;,(curr,prev)=&gt;&#123;</span><br><span class="line">    <span class="keyword">if</span>(curr.mtime !=== prev.mtime)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'文件被修改了'</span>)</span><br><span class="line">        fs.unwatchFile(<span class="string">'data.txt'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="10-md转html实现"><a href="#10-md转html实现" class="headerlink" title="10.md转html实现"></a>10.md转html实现</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> marked = <span class="built_in">require</span>(<span class="string">'marked'</span>)</span><br><span class="line"><span class="keyword">const</span> browserSync = <span class="built_in">require</span>(<span class="string">'browser-sync'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*  01 读取 md 和 css 内容</span></span><br><span class="line"><span class="comment">*  02 将上述读取出的内容替换占位符，生成一个最终需要的 Html 字符串</span></span><br><span class="line"><span class="comment">*  03 将上述的 Html 字符写入到指定的 Html 文件中</span></span><br><span class="line"><span class="comment">*  04 监听 md 文档内容的化，然后更新 html 内容</span></span><br><span class="line"><span class="comment">*  05 使用 browser-sync 来实时显示 Html 内容</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> mdPath = path.join(__dirname,process.argv[<span class="number">2</span>])</span><br><span class="line"><span class="keyword">let</span> cssPath = path.resolve(<span class="string">'github.css'</span>)</span><br><span class="line"><span class="keyword">let</span> htmlPath = mdPath.replace(path.extname(mdpath),<span class="string">'.html'</span>)</span><br><span class="line"></span><br><span class="line">fs.watchFile(mdPath,(curr,prev)=&gt;&#123;</span><br><span class="line">    <span class="keyword">if</span>(curr.mtime !=== prev.mtime)&#123;</span><br><span class="line">        fs.readFile(mdPath,<span class="string">'utf-8'</span>,(err,data)=&gt;&#123;</span><br><span class="line">           <span class="keyword">let</span> htmlStr = marked(data)</span><br><span class="line">           fs.readFile(cssPath,<span class="string">'utf-8'</span>,(err,data)=&gt;&#123;</span><br><span class="line">               <span class="keyword">let</span> retHtml = temp.repalce(<span class="string">'&#123;&#123;conteent&#125;&#125;'</span>,htmlStr).replace(<span class="string">'&#123;&#123;style&#125;&#125;'</span>,data)</span><br><span class="line">               fs.writeFile(htmlPath,retHtml,(err)=&gt;&#123;</span><br><span class="line">                   <span class="built_in">console</span>.log(<span class="string">'html 生成成功了'</span>)</span><br><span class="line">               &#125;)</span><br><span class="line">           &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">browserSync.init(&#123;</span><br><span class="line">    browser: <span class="string">''</span>,</span><br><span class="line">    server: __dirname,</span><br><span class="line">    watch: <span class="literal">true</span>,</span><br><span class="line">    index: path.basename(htmlPath)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="11-文件打开与关闭"><a href="#11-文件打开与关闭" class="headerlink" title="11.文件打开与关闭"></a>11.文件打开与关闭</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"></span><br><span class="line">fs.open(path.resolve(<span class="string">'data.txt'</span>),<span class="string">'r'</span>,(err,fd)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'fd'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">fs.open(path.resolve(<span class="string">'data.txt'</span>),<span class="string">'r'</span>,(err,fd) =&gt; &#123;</span><br><span class="line">   <span class="built_in">console</span>.log(<span class="string">'fd'</span>)</span><br><span class="line">   fs.close(fd, err =&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'关闭成功'</span>)</span><br><span class="line">   &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="12-大文件读写操作"><a href="#12-大文件读写操作" class="headerlink" title="12.大文件读写操作"></a>12.大文件读写操作</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// read: 所谓的读操作就是将数据从磁盘文件写入到 buffer 中</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> buf = Buffer.alloc(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* rfd 定位当前被打开的文件</span></span><br><span class="line"><span class="comment">* buf 用于表示当前缓冲区</span></span><br><span class="line"><span class="comment">* offset 表示当前从 buf 的哪个位置开始执行写入</span></span><br><span class="line"><span class="comment">* length 表示当前次写入的长度</span></span><br><span class="line"><span class="comment">* position 表示当前从文件的哪个位置开始读取</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">fs.open(<span class="string">'data.txt'</span>,<span class="string">'r'</span>,(err,rfd)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(rfd)</span><br><span class="line">    fs.read(rfd, buf, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, (err,readBytes,data)=&gt;&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(readBytes)</span><br><span class="line">        <span class="built_in">console</span>.log(data)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// write 将缓冲区里的内容写入到磁盘文件中</span></span><br><span class="line"></span><br><span class="line">buf = Buffer.from(<span class="string">'1234567890'</span>)</span><br><span class="line">fs.open(<span class="string">'b.txt'</span>,<span class="string">'w'</span>,(err,wfd)=&gt;&#123;</span><br><span class="line">    fs.write(wfd, buf, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, (err, written, buffer) =&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(written)</span><br><span class="line">        <span class="built_in">console</span>.log(buffer)</span><br><span class="line">        <span class="built_in">console</span>.log(buffer.toString())</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="13-文件拷贝自定义实现"><a href="#13-文件拷贝自定义实现" class="headerlink" title="13.文件拷贝自定义实现"></a>13.文件拷贝自定义实现</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 01 打开 a 文件，利用 read 将数据保存到 buffer 暂存起来</span></span><br><span class="line"><span class="comment">* 02 打开 b 文件，利用 write 将 buffer 中数据写入到 b 文件中</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> buf = Buffer.alloc(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 01 打开指定的文件</span></span><br><span class="line">fs.open(<span class="string">'a.txt'</span>, <span class="string">'r'</span>, (err,rfd) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 03 打开 b 文件，用于执行数据写入操作</span></span><br><span class="line">    fs.open(<span class="string">'b.txt'</span>, <span class="string">'w'</span>, (err, wfd) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 02 从打开的文件中读取数据</span></span><br><span class="line">        fs.read(rfd, buf, <span class="number">0</span>, <span class="number">10</span>, <span class="number">0</span>, (err, readBytes,buffer) =&gt; &#123;</span><br><span class="line">          <span class="comment">// 04 将 buffer 中的数据写入到 b.txt 当中</span></span><br><span class="line">          fs.write(wfd, buf, <span class="number">0</span>, <span class="number">10</span>, <span class="number">0</span>, (err, written) =&gt; &#123;</span><br><span class="line">              <span class="built_in">console</span>.log(<span class="string">'写入成功'</span>)</span><br><span class="line">          &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 02 数据的完全拷贝</span></span><br><span class="line">fs.open(<span class="string">'a.txt'</span>, <span class="string">'r'</span>, (err,rfd) =&gt; &#123;</span><br><span class="line">    fs.open(<span class="string">'b.txt'</span>, <span class="string">'a+'</span>, (err, wfd) =&gt; &#123;</span><br><span class="line">        fs.read(rfd, buf, <span class="number">0</span>, <span class="number">10</span>, <span class="number">0</span>, (err, readBytes) =&gt; &#123;</span><br><span class="line">           fs.write(wfd, buf, <span class="number">0</span>, <span class="number">10</span>, <span class="number">0</span>, (err, written) =&gt; &#123;</span><br><span class="line">                fs.read(rfd, buf, <span class="number">0</span>, <span class="number">5</span>, <span class="number">0</span>, (err, readBytes) =&gt; &#123;</span><br><span class="line">                    fs.write(wfd, buf, <span class="number">0</span>, <span class="number">5</span>, <span class="number">10</span>, (err, written) =&gt; &#123;</span><br><span class="line">                        <span class="built_in">console</span>.log(<span class="string">'写入成功'</span>)</span><br><span class="line">                   &#125;)</span><br><span class="line">               &#125;)</span><br><span class="line">          &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> BUFFER_SIZE = buf.length</span><br><span class="line"><span class="keyword">let</span> readOffset = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">fs.open(<span class="string">'a.txt'</span>, <span class="string">'r'</span>, (err,rfd) =&gt; &#123;</span><br><span class="line">  fs.open(<span class="string">'b.txt'</span>, <span class="string">'a+'</span>, (err, wfd) =&gt; &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        fs.read(rfd, buf, <span class="number">0</span>, BUFFER_SIZE, readOffset, (err, readBytes) =&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span>(!readBytes)&#123;</span><br><span class="line">                <span class="comment">// 如果条件成立，说明内容已经读取完毕</span></span><br><span class="line">                fs.close(rfd,() =&gt; &#123;&#125;)</span><br><span class="line">                fs.close(wfd,() =&gt; &#123;&#125;)</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">'拷贝完成'</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            readOffset += readBytes</span><br><span class="line">            fs.write(wfd, buf, <span class="number">0</span>, readBytes, (err, written) =&gt; &#123;</span><br><span class="line">                next()</span><br><span class="line">           &#125;)</span><br><span class="line">       &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">     next()</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="14-目录操作API"><a href="#14-目录操作API" class="headerlink" title="14.目录操作API"></a>14.目录操作API</h3><blockquote>
<p>常见目录操作 API</p>
</blockquote>
<ul>
<li>access: 判断文件或目录是否具有操作权限</li>
<li>stat: 获取目录及文件信息</li>
<li>mkdir: 创建目录</li>
<li>rmdir: 删除目录</li>
<li>readdir: 读取目录中内容</li>
<li>unlink: 删除指定而文件</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 01 access</span></span><br><span class="line">fs.access(<span class="string">'a.txt'</span>, (err) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span>(err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'有操作权限'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 02 stat</span></span><br><span class="line">fs.stat(<span class="string">'a.txt'</span>, (err,statObj) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(statObj.size)</span><br><span class="line">    <span class="built_in">console</span>.log(statObj.isFile())</span><br><span class="line">    <span class="built_in">console</span>.log(statObj.isDirectory())</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 03 mkdir</span></span><br><span class="line">fs.mkdir(<span class="string">'a/b/c'</span>, &#123;<span class="attr">recursive</span>: <span class="literal">true</span>&#125;, (err) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span>(!err)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'创建成功'</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 04 rmdir</span></span><br><span class="line">fs.rmdir(<span class="string">'a'</span>, &#123;<span class="attr">recursive</span>: <span class="literal">true</span>&#125;, (err) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span>(!err)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'删除成功'</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 05 readdir</span></span><br><span class="line">fs.readdir(<span class="string">'a'</span>, (err,files) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(files)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 05 unlink</span></span><br><span class="line">fs.unlink(<span class="string">'a/a.txt'</span>, (err) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span>(!err)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'删除成功'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="15-目录创建之同步实现"><a href="#15-目录创建之同步实现" class="headerlink" title="15.目录创建之同步实现"></a>15.目录创建之同步实现</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 01 将来调用需要接收类似于 a/b/c，这样的路径，它们之间是采用 / 进行链接</span></span><br><span class="line"><span class="comment">* 02 利用 / 分割符将路径进行拆分，将每一项放入一个数组中进行管理 ['a','b','c']</span></span><br><span class="line"><span class="comment">* 03 对上述的数组进行遍历，我们需要拿到每一项，然后与前一项进行拼接 /</span></span><br><span class="line"><span class="comment">* 04 判断一个当前对拼接之后的路径是否具有可操作的权限，如果有则证明存在，否则的话就需要执行创建</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeDirSync</span>(<span class="params">dirPath</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> items = dirPath.split(path.sep)</span><br><span class="line">    <span class="built_in">console</span>.log(path.sep)</span><br><span class="line">    <span class="built_in">console</span>.log(items)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">1</span>; i &lt;= items.length; i++)&#123;</span><br><span class="line">        <span class="keyword">let</span> dir = items.slice(<span class="number">0</span>, <span class="number">1</span>).join(path.sep)</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            fs.accessSync(dir)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            fs.mkdirSync(dir)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">makeDirSync(<span class="string">'a\\b\\c'</span>)</span><br></pre></td></tr></table></figure>

<h3 id="16-目录创建之异步实现"><a href="#16-目录创建之异步实现" class="headerlink" title="16.目录创建之异步实现"></a>16.目录创建之异步实现</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mkDir</span>(<span class="params">dirPath, cb</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> parts = dirPath.split(<span class="string">'/'</span>)</span><br><span class="line">    <span class="keyword">let</span> index = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(index &gt; parts.length) <span class="keyword">return</span> cb &amp;&amp; cb()</span><br><span class="line">        <span class="keyword">let</span> current = parts.slice(<span class="number">0</span>, index++).join(<span class="string">'/'</span>)</span><br><span class="line"></span><br><span class="line">        fs.access(current, (err) =&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span>(err) &#123;</span><br><span class="line">                fs.mkdir(current, next)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                next()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    next()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mkDir(<span class="string">'a/b/c'</span>,()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'创建成功'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 将 access 与 mkdir 处理成 async... 风格</span></span><br><span class="line"><span class="keyword">const</span> access = promisify(fs.access)</span><br><span class="line"><span class="keyword">const</span> mkdir = promisify(fs.mkdir)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">myMkdir</span>(<span class="params">dirPath,cb</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> parts = dirPath.split(<span class="string">'/'</span>)</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">let</span> index = <span class="number">1</span>; index &lt;= parts.length; index++) &#123;</span><br><span class="line">     <span class="keyword">let</span> current = parts.slice(<span class="number">0</span>, index).join(<span class="string">'/'</span>)</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="keyword">await</span> acccess(current)</span><br><span class="line">     &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">         <span class="keyword">await</span> mkDir(current)</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  cb &amp;&amp; cb()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="17-目录删除之异步实现"><a href="#17-目录删除之异步实现" class="headerlink" title="17.目录删除之异步实现"></a>17.目录删除之异步实现</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 需求: 自定义一个函数，接收一个路径，然后执行删除</span></span><br><span class="line"><span class="comment">* 01 判断当前传入的路径是否为一个文件，直接删除当前文件即可</span></span><br><span class="line"><span class="comment">* 02 如果当前传入的是一个目录，我们需要继续读取目录中的内容，然后再执行删除操作</span></span><br><span class="line"><span class="comment">* 03 将删除行为定义成一个函数，然后通过递归地方式进行复用</span></span><br><span class="line"><span class="comment">* 04 将当前的名称拼接成在删除时可使用的路径</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myRmdir</span>(<span class="params">dirPath,cb</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 判断当前 dirPath 的类型</span></span><br><span class="line">    fs.stat(dirPath,(err,statObj) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span>(statObj.isDirectory())&#123;</span><br><span class="line">            <span class="comment">// 目录 ---&gt; 继续读取</span></span><br><span class="line">            fs.readdir(dirPath,(err,files) =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> dirs = files.map(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> path.join(dirPath, item)</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="built_in">console</span>.log(dirs)</span><br><span class="line">                <span class="keyword">let</span> index = <span class="number">0</span></span><br><span class="line">                <span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                    <span class="keyword">if</span>(index === dirs.length) <span class="keyword">return</span> fs.rmdir(dirPatn, cb)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">let</span> current = dirs[index++]</span><br><span class="line"></span><br><span class="line">                    myRmdir(current,next)</span><br><span class="line">                &#125;</span><br><span class="line">                next()</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 文件 ---&gt; 直接删除</span></span><br><span class="line">            fs.unlink(dirPath,cb)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">myRmdir(<span class="string">'data1.txt'</span>,() =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'删除成功了'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="18-模块化历程"><a href="#18-模块化历程" class="headerlink" title="18.模块化历程"></a>18.模块化历程</h3><blockquote>
<p>传统开发常见问题</p>
</blockquote>
<ul>
<li>命名冲突和污染</li>
<li>代码冗余，无效请求多</li>
<li>文件间的依赖关系复杂</li>
</ul>
<blockquote>
<p>常见模块化规范</p>
</blockquote>
<ul>
<li>Commonjs 规范</li>
<li>AMD 规范</li>
<li>CMD 规范</li>
<li>ES modules 规范</li>
</ul>
<blockquote>
<p>模块化规范</p>
</blockquote>
<ul>
<li>模块化是前端走向工程化的重要一环</li>
<li>早期 JavaScript 语言层面没有模块化规范</li>
<li>Commonjs、AMD、CMD 都是模块化规范</li>
<li>ES6 中将模块化纳入标准规范</li>
<li>当下常用规范是 Commonjs 与 ESM</li>
</ul>
<h3 id="19-CommonJS规范"><a href="#19-CommonJS规范" class="headerlink" title="19.CommonJS规范"></a>19.CommonJS规范</h3><blockquote>
<p>CommonJs 规范</p>
</blockquote>
<ul>
<li>模块引用</li>
<li>模块定义</li>
<li>模块标识</li>
</ul>
<blockquote>
<p>Nodejs与CommonJs</p>
</blockquote>
<ul>
<li>任意一个文件就是一模块，具有独立作用域</li>
<li>使用 require 导入其它模块</li>
<li>将模块ID传入 require 实现目标模块定位</li>
</ul>
<blockquote>
<p>module 属性</p>
</blockquote>
<ul>
<li>任意js文件就是一个模块，可以直接使用module属性</li>
<li>id: 返回模块标识符，一般是一个绝对路径</li>
<li>filename: 返回文件模块的绝对路径</li>
<li>loaded: 返回布尔值，表示模块是否完成加载</li>
<li>parent: 返回对象存放调用当前模块的模块</li>
<li>children: 返回数组，存放当前模块调用的其它模块</li>
<li>exports: 返回当前模块需要暴露的内容</li>
<li>paths: 返回数组，存放不同目录下的node_modules位置</li>
</ul>
<blockquote>
<p>require 属性</p>
</blockquote>
<ul>
<li>基本功能是读入并且执行一个模块文件</li>
<li>resolve: 返回模块文件绝对路径</li>
<li>extentions: 依据不同后缀名执行解析操作</li>
<li>main: 返回主模块对象</li>
</ul>
<blockquote>
<p>CommonJs 规范</p>
</blockquote>
<ul>
<li>CommonJs 规范起初是为了弥补 JS 语言模块化缺陷</li>
<li>CommonJs 是语言层面的规范，当前主要用于Node.js</li>
<li>CommonJs 规定模块化分为引入、定义、标识符三个部分</li>
<li>Module 在任意模块中可直接使用包含模块信息</li>
<li>Require 接收标识符，加载目标模块</li>
<li>Exports 与 module.exports 都能导出模块数据</li>
<li>CommonJs 规范定义模块的加载是同步完成</li>
</ul>
<h3 id="20-Nodejs与CommonJS"><a href="#20-Nodejs与CommonJS" class="headerlink" title="20.Nodejs与CommonJS"></a>20.Nodejs与CommonJS</h3><ul>
<li>使用 module.exports 与 require 实现模块导入与导出</li>
<li>module 属性及其常见信息获取</li>
<li>exports 导出数据及其与 module.exports 区别</li>
<li>CommonJs 规范下的模块同步加载</li>
</ul>
<h3 id="21-模块分类及加载流程"><a href="#21-模块分类及加载流程" class="headerlink" title="21.模块分类及加载流程"></a>21.模块分类及加载流程</h3><blockquote>
<p>模块分类</p>
</blockquote>
<ul>
<li>内置模块</li>
<li>文件模块</li>
</ul>
<blockquote>
<p>模块加载速度</p>
</blockquote>
<ul>
<li>核心模块: Node 源码编译时写入到二进制文件中</li>
<li>文件模块: 代码运行时，动态加载</li>
</ul>
<blockquote>
<p>加载流程</p>
</blockquote>
<ul>
<li>路径分析: 依据标识符确定模块位置</li>
<li>文件定位: 确定目标模块中具体的文件及文件类型</li>
<li>编译执行: 采用对应的方式完成文件的编译执行</li>
</ul>
<blockquote>
<p>文件定位</p>
</blockquote>
<ul>
<li>项目下存在m1.js模块，导入时使用require(‘m1’)语法</li>
<li>m1.js -&gt; m1.json -&gt; m1.node</li>
<li>查找 pakage.json 文件，使用 JSON.parse() 解析</li>
<li>main.js -&gt; main.json -&gt; main.node</li>
<li>将 index 作为目标模块中的具体文件名称</li>
</ul>
<blockquote>
<p>编译执行</p>
</blockquote>
<ul>
<li>将某个具体类型的文件按照相应的方式进行编译和执行</li>
<li>创建新对象，按路径载入，完成编译执行</li>
</ul>
<blockquote>
<p>JS 文件的编译执行</p>
</blockquote>
<ul>
<li>使用 fs 模块同步读入目标文件内容</li>
<li>对内容进行语法包装，生成可执行 JS 函数</li>
<li>调用函数时传入 exports、module、reuire 等属性值</li>
</ul>
<blockquote>
<p>JSON 文件编译执行</p>
</blockquote>
<ul>
<li>将读取到的内容通过 JSON.parse() 进行解析</li>
</ul>
<blockquote>
<p>缓存化原则</p>
</blockquote>
<ul>
<li>提高模块加载速度</li>
<li>当前模块不存在，则经历一次完整加载流程</li>
<li>模块加载完成后，使用路径作为索引进行缓存</li>
</ul>
<blockquote>
<p>加载流程总结</p>
</blockquote>
<ul>
<li>路径分析: 确实目标模块位置</li>
<li>文件定位: 确定目标模块中的具体文件</li>
<li>编译执行: 对模块内容进行编译，返回可用 exports 对象</li>
</ul>
<h3 id="22-模块加载源码分析"><a href="#22-模块加载源码分析" class="headerlink" title="22.模块加载源码分析"></a>22.模块加载源码分析</h3><p>略</p>
<h3 id="23-VM模块使用"><a href="#23-VM模块使用" class="headerlink" title="23.VM模块使用"></a>23.VM模块使用</h3><p>创建独立运行的沙箱环境</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">'vm'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> age = <span class="number">33</span></span><br><span class="line"><span class="keyword">let</span> content = fs.readFileSync(<span class="string">'test.txt'</span>,<span class="string">'utf-8'</span>)</span><br><span class="line"></span><br><span class="line">vm.runInThisContext(<span class="string">"age += 10"</span>)</span><br><span class="line"><span class="built_in">console</span>.log(age)</span><br></pre></td></tr></table></figure>

<h3 id="24-模块加载模拟实现-1"><a href="#24-模块加载模拟实现-1" class="headerlink" title="24.模块加载模拟实现-1"></a>24.模块加载模拟实现-1</h3><blockquote>
<p>核心逻辑</p>
</blockquote>
<ul>
<li>路径分析</li>
<li>缓存优化</li>
<li>文件定位</li>
<li>编译执行</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span>   = <span class="built_in">require</span>(<span class="string">'vm'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Module</span>(<span class="params">id</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.id = id</span><br><span class="line">    <span class="keyword">this</span>.exports = &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Module._resolveFilename = funciton(filename)&#123;</span><br><span class="line">    <span class="comment">// 利用 Path 将 filename 转为绝对路径</span></span><br><span class="line">    <span class="keyword">let</span> absPath = path.resolve(__dirname,filename)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断当前路径对应的内容是否存在</span></span><br><span class="line">    <span class="keyword">if</span>(fs.existsSync(absPath)) &#123;</span><br><span class="line">        <span class="comment">// 如果条件成立则说明 absPath 对应的内容是存在的</span></span><br><span class="line">        <span class="keyword">return</span> absPath</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 文件定位</span></span><br><span class="line">      <span class="keyword">let</span> suffix = <span class="built_in">Object</span>.keys(Module._extentions)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; suffix.length;i++)&#123;</span><br><span class="line">          <span class="keyword">let</span> newPath = absPath + suffix[i]</span><br><span class="line">          <span class="keyword">if</span>(fs.existsSync(newPath)) &#123;</span><br><span class="line">              <span class="keyword">return</span> newPath</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`<span class="subst">$&#123;filename&#125;</span> is not exists`</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Module._extensions = &#123;</span><br><span class="line">    <span class="string">'.js'</span>(<span class="built_in">module</span>)&#123;</span><br><span class="line">        <span class="comment">// 读取</span></span><br><span class="line">        <span class="keyword">let</span> content = fs.readFileSync(<span class="built_in">module</span>.id,<span class="string">'utf-8'</span>)</span><br><span class="line">        <span class="built_in">console</span>.log(content)</span><br><span class="line">        <span class="comment">// 包装</span></span><br><span class="line">        content = Module.wrapper[<span class="number">0</span>] + content + Module.wrapper[<span class="number">1</span>]</span><br><span class="line">        <span class="built_in">console</span>.log(content)</span><br><span class="line">        <span class="comment">// VM</span></span><br><span class="line">        <span class="keyword">let</span> compileFn = vm.runInThisContext(content)</span><br><span class="line">        <span class="built_in">console</span>.log(compileFn)</span><br><span class="line">        <span class="comment">// 准备参数值</span></span><br><span class="line">        <span class="keyword">let</span> exports = <span class="built_in">module</span>.exports</span><br><span class="line">        <span class="keyword">let</span> dirname = path.dirname(<span class="built_in">module</span>.id)</span><br><span class="line">        <span class="keyword">let</span> filename = <span class="built_in">module</span>.id</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用</span></span><br><span class="line">        compileFn.call(exports,exports,myRequire,<span class="built_in">module</span>,__filename,__dirname)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'.json'</span>(<span class="built_in">module</span>)&#123;</span><br><span class="line">        <span class="keyword">let</span> content = <span class="built_in">JSON</span>.parse(fs.readFileSync(moduleid,<span class="string">'utf-8'</span>))</span><br><span class="line">        <span class="built_in">module</span>.exports = content</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Module.wrapper = [</span><br><span class="line">    <span class="string">"(function(exports,require,module,__filename,__dirname)&#123;"</span>,</span><br><span class="line">    <span class="string">"&#125;)"</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">Module._cache = &#123;&#125;</span><br><span class="line"></span><br><span class="line">Module.prototype.load = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> extname = path.extname(<span class="keyword">this</span>.id)</span><br><span class="line">  <span class="built_in">console</span>.log(extname)</span><br><span class="line">  Module._extensions[extname](<span class="keyword">this</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myRequire</span>(<span class="params">filename</span>) </span>&#123;</span><br><span class="line"><span class="comment">// 1 绝对路径</span></span><br><span class="line"><span class="keyword">let</span> mPath = Module._resolveFilename(filename)</span><br><span class="line"><span class="built_in">console</span>.log(mPath)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2 缓存优先</span></span><br><span class="line"><span class="keyword">let</span> cacheModule = Module._cache[mPath]</span><br><span class="line"><span class="keyword">if</span>(cacheModule) <span class="keyword">return</span> cacheModule.exports</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3 创建空对象加载目录模块</span></span><br><span class="line"><span class="keyword">let</span> <span class="built_in">module</span> = <span class="keyword">new</span> Module(mPath)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4 缓存已加载过的模块</span></span><br><span class="line">Module._cache[mPath] = <span class="built_in">module</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 5 执行加载（编译执行）</span></span><br><span class="line"><span class="built_in">module</span>.load()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6 返回数据</span></span><br><span class="line"><span class="keyword">return</span> <span class="built_in">module</span>.exports</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> obj = myRequire(<span class="string">'./v'</span>)</span><br><span class="line"><span class="built_in">console</span>.log(obj.age)</span><br></pre></td></tr></table></figure>

<h3 id="25-模块加载模拟实现-2"><a href="#25-模块加载模拟实现-2" class="headerlink" title="25.模块加载模拟实现-2"></a>25.模块加载模拟实现-2</h3><p>略</p>
<h3 id="26-事件模块"><a href="#26-事件模块" class="headerlink" title="26.事件模块"></a>26.事件模块</h3><p>通过 EventEmitter 类实现事件统一管理</p>
<blockquote>
<p>events 与 EventEmitter</p>
</blockquote>
<ul>
<li>node.js 是基于事件驱动的异步操作架构，内置 events 模块</li>
<li>events 模块提供了 EventEmitter 类</li>
<li>node.js 中很多内置核心模块继承 EventEmitter</li>
</ul>
<blockquote>
<p>EventEmitter 常见 API</p>
</blockquote>
<ul>
<li>on: 添加当事件被触发时调用的回到函数</li>
<li>emit: 触发事件，按照注册的顺序同步调用每个事件监听器</li>
<li>once: 添加当事件在注册之后首次被触发时调用的回调函数</li>
<li>off: 移除特定的监听器</li>
</ul>
<h3 id="27-发布订阅"><a href="#27-发布订阅" class="headerlink" title="27.发布订阅"></a>27.发布订阅</h3><p>定义对象间一对多的依赖关系</p>
<blockquote>
<p>发布订阅要素</p>
</blockquote>
<ul>
<li>缓存对列，存放订阅者信息</li>
<li>具有增加、删除订阅的能力</li>
<li>状态改变时通知所有订阅者执行监听</li>
</ul>
<p>发布订阅中存在调度中心<br>状态发生改变时，发布订阅无须主动通知</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PubSub</span></span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>()&#123;</span><br><span class="line">        <span class="keyword">this</span>._events = &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册</span></span><br><span class="line">    subscribe(event,callback) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>._events[event]) &#123;</span><br><span class="line">            <span class="keyword">this</span>._events[event].push(callback)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>._event[event] = [callback]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发布</span></span><br><span class="line">    publish(event,...args) &#123;</span><br><span class="line">       <span class="keyword">const</span> items = <span class="keyword">this</span>._events[event]</span><br><span class="line">       <span class="keyword">if</span>(items &amp;&amp; items.length) &#123;</span><br><span class="line">           items.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">callback</span>)</span>&#123;</span><br><span class="line">               callback.call(<span class="keyword">this</span>,...args)</span><br><span class="line">           &#125;)</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> ps = <span class="keyword">new</span> Pubsub()</span><br><span class="line">ps.subscribe(<span class="string">'事件1'</span>,()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'事件1执行了'</span>)</span><br><span class="line">&#125;)</span><br><span class="line">ps.publish(<span class="string">'事件1'</span>)</span><br></pre></td></tr></table></figure>

<h3 id="28-EventEmitter源码调试"><a href="#28-EventEmitter源码调试" class="headerlink" title="28.EventEmitter源码调试"></a>28.EventEmitter源码调试</h3><p>略</p>
<h3 id="29-EventEmitter模拟"><a href="#29-EventEmitter模拟" class="headerlink" title="29.EventEmitter模拟"></a>29.EventEmitter模拟</h3><p>略</p>
<h3 id="30-浏览器中的事件环"><a href="#30-浏览器中的事件环" class="headerlink" title="30.浏览器中的事件环"></a>30.浏览器中的事件环</h3><blockquote>
<p>完整事件环执行顺序</p>
</blockquote>
<ul>
<li>从上至下执行所有的同步代码</li>
<li>执行过程中将遇到的宏任务与微任务添加至相应的队列</li>
<li>同步代码执行完毕后，执行满足条件的微任务回调</li>
<li>微任务队列执行完毕执行所有满足需求的宏任务回调</li>
<li>循环事件环操作</li>
<li>注意: 每执行一个宏任务之后会立刻检查微任务队列</li>
</ul>
<h3 id="31-Nodejs中的事件环"><a href="#31-Nodejs中的事件环" class="headerlink" title="31.Nodejs中的事件环"></a>31.Nodejs中的事件环</h3><blockquote>
<p>对列说明</p>
</blockquote>
<ul>
<li>timers: 执行 setTimeout 与 setInterval 回调</li>
<li>pending callbacks: 执行系统操作的回调，例如 tcp udp</li>
<li>idle，prepare: 只在系统内部进行使用</li>
<li>poll: 执行与 I/O 相关的回调</li>
<li>check: 执行 setImmediate 中的回调</li>
<li>close callbacks: 执行 close 事件的回调</li>
</ul>
<blockquote>
<p>Nodejs 完整事件环</p>
</blockquote>
<ul>
<li>执行同步代码，将不同的任务添加至相应的队列</li>
<li>所有同步代码执行后会去执行满足条件微任务</li>
<li>所有微任务代码执行后会执行 timer 队列中满足的宏任务</li>
<li>timer 中的所有宏任务执行完后就会依次切换队列</li>
<li>注意: 在完成队列切换之前会先清空微任务代码</li>
</ul>
<h3 id="32-Nodejs事件环理解"><a href="#32-Nodejs事件环理解" class="headerlink" title="32.Nodejs事件环理解"></a>32.Nodejs事件环理解</h3><p>** 新版本有变化 **</p>
<h3 id="33-Nodejs与浏览器事件环区别"><a href="#33-Nodejs与浏览器事件环区别" class="headerlink" title="33.Nodejs与浏览器事件环区别"></a>33.Nodejs与浏览器事件环区别</h3><ul>
<li><p>任务队列数不同</p>
<ul>
<li>浏览器中只有两个任务队列</li>
<li>Nodejs 中有6个事件队列</li>
</ul>
</li>
<li><p>Nodejs 微任务执行时机不同</p>
<ul>
<li>两者都会在同步代码执行完毕后执行微任务</li>
<li>浏览器平台下每当一个宏任务执行完毕后就清空微任务</li>
<li>Nodejs 平台在事件队列切换时会去清空微任务</li>
</ul>
</li>
<li><p>微任务优先级不同</p>
<ul>
<li>浏览器事件环中，微任务存放于事件队列，先进先出</li>
<li>Nodejs 中的 process.nextTick 先于 promise.then</li>
</ul>
</li>
</ul>
<h3 id="34-Nodejs事件环常见问题"><a href="#34-Nodejs事件环常见问题" class="headerlink" title="34.Nodejs事件环常见问题"></a>34.Nodejs事件环常见问题</h3><p>默认 setTimeout 和 setImmdieate 顺序是随机的，但在I/O操作里面是 setImmdieate 优先</p>
<h3 id="35-核心模块之stream"><a href="#35-核心模块之stream" class="headerlink" title="35.核心模块之stream"></a>35.核心模块之stream</h3><p>ls|grep*.js</p>
<p>Node.js诞生之初就是为了提高IO性能</p>
<p>文件操作系统和网络模块实现了流接口</p>
<p>Node.js 中的流就是处理流式数据的抽象接口</p>
<p>应用程序中为什么使用流来处理数据？</p>
<blockquote>
<p>常见问题</p>
</blockquote>
<ul>
<li>同步读取资源文件，用户需要等待数据读取完成</li>
<li>资源文件最终一次性加载至内存，开销较大</li>
</ul>
<blockquote>
<p>流处理数据的优势</p>
</blockquote>
<ul>
<li>时间效率: 流的分段处理可以同时操作多个数据 chunk</li>
<li>空间效率: 同一时间流无须占据大内存空间</li>
<li>使用方便: 流配合管理，扩展程序变得简单</li>
</ul>
<p>Node.js 内置了 stream，它实现了流操作对象</p>
<blockquote>
<p>Node.js 中流的分类</p>
</blockquote>
<ul>
<li>Readable: 可读流，能够实现数据的读取</li>
<li>Writeable: 可写流，能够实现数据的写操作</li>
<li>Duplex: 双工流，既可读又可写</li>
<li>Tranform: 转换流，可读可写，还能实现数据转换</li>
</ul>
<blockquote>
<p>Node.js 流特点</p>
</blockquote>
<ul>
<li>Stream 模块实现了四个具体的抽象</li>
<li>所有流都继承自 EventEmitter</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> rs = fs.createReadStream(<span class="string">'./test.txt'</span>)</span><br><span class="line"><span class="keyword">let</span> ws = fs.createWriteStream(<span class="string">'./test1.txt'</span>)</span><br><span class="line"></span><br><span class="line">rs.pipe(ws)</span><br></pre></td></tr></table></figure>

<h3 id="36-stream之可读流"><a href="#36-stream之可读流" class="headerlink" title="36.stream之可读流"></a>36.stream之可读流</h3><p>“生产供程序消费数据的流”</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> rs = fs.createReadStream(<span class="string">'0-node.txt'</span>)</span><br><span class="line"></span><br><span class="line">rs.pipe(process.stdout)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>自定义可读流</p>
</blockquote>
<ul>
<li>继承 stream 里的 Readable</li>
<li>重写 _read 方法调用push产出数据</li>
</ul>
<h3 id="37-stream之可写流"><a href="#37-stream之可写流" class="headerlink" title="37.stream之可写流"></a>37.stream之可写流</h3><p>“用于消费数据的流”</p>
<blockquote>
<p>自定义可写流</p>
</blockquote>
<ul>
<li>继承 stream 模块的 Writeable</li>
<li>重写 _write 方法，调用 write 执行写入</li>
</ul>
<h3 id="38-stream之双工和转换流"><a href="#38-stream之双工和转换流" class="headerlink" title="38.stream之双工和转换流"></a>38.stream之双工和转换流</h3><p>Duplex 是双工流，既能生产又能消费</p>
<blockquote>
<p>自定义双工流</p>
</blockquote>
<ul>
<li>继承 Duplex 类</li>
<li>重写 _read 方法，调用 push 生产数据</li>
<li>重写 _write 方法，调用 write 消费数据</li>
</ul>
<p>Transform 也是一个双工流</p>
<blockquote>
<p>自定义转换流</p>
</blockquote>
<ul>
<li>继承 Transform 类</li>
<li>重写 _transform 方法，调用 push 和 callback</li>
<li>重写 _flush 方法，处理剩余数据</li>
</ul>
<h3 id="39-文件可读流创建和消费"><a href="#39-文件可读流创建和消费" class="headerlink" title="39.文件可读流创建和消费"></a>39.文件可读流创建和消费</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> rs = fs.createReadStream(<span class="string">'test.txt'</span>, &#123;</span><br><span class="line">    flags: <span class="string">'r'</span>,</span><br><span class="line">    encoding: <span class="literal">null</span>,</span><br><span class="line">    fd: <span class="literal">null</span>,</span><br><span class="line">    mode: <span class="number">438</span>, </span><br><span class="line">    autoClose: <span class="literal">true</span>,</span><br><span class="line">    start: <span class="number">0</span>,</span><br><span class="line">    <span class="comment">// end: 3,</span></span><br><span class="line">    highWaterMark: <span class="number">2</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">rs.on(<span class="string">'data'</span>, (chunk) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(chunk.toString())</span><br><span class="line">    rs.pause()</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">        rs.resume()</span><br><span class="line">    &#125;,<span class="number">1000</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">rs.on(<span class="string">'readable'</span>,()=&gt;&#123;</span><br><span class="line">    <span class="keyword">let</span> data</span><br><span class="line">    <span class="keyword">while</span>((data = rs.read(<span class="number">2</span>))!==<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(data.toString())</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'------'</span>,rs._readableState.length)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="40-文件可读流事件与应用"><a href="#40-文件可读流事件与应用" class="headerlink" title="40.文件可读流事件与应用"></a>40.文件可读流事件与应用</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> rs = fs.createReadStream(<span class="string">'test.txt'</span>, &#123;</span><br><span class="line">    flags: <span class="string">'r'</span>,</span><br><span class="line">    encoding: <span class="literal">null</span>,</span><br><span class="line">    fd: <span class="literal">null</span>,</span><br><span class="line">    mode: <span class="number">438</span>, </span><br><span class="line">    autoClose: <span class="literal">true</span>,</span><br><span class="line">    start: <span class="number">0</span>,</span><br><span class="line">    <span class="comment">// end: 3,</span></span><br><span class="line">    highWaterMark: <span class="number">2</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">rs.on(<span class="string">'open'</span>, (fd) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(fd, <span class="string">'文件打开了'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">rs.on(<span class="string">'close'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(fd, <span class="string">'文件关闭了'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">let</span> bufferArr = []</span><br><span class="line">rs.on(<span class="string">'data'</span>, (chunk) =&gt; &#123;</span><br><span class="line">    bufferArr.push(chunk)</span><br><span class="line">    <span class="built_in">console</span>.log(chunk)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">rs.on(<span class="string">'end'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(Buffer.concat(bufferArr).toString)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'当数据被清空之后'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">rs.on(<span class="string">'error'</span>, (err) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'出错了'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="41-文件可写流"><a href="#41-文件可写流" class="headerlink" title="41.文件可写流"></a>41.文件可写流</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ws = fs.createWriteStream(<span class="string">'test.txt'</span>,&#123;</span><br><span class="line">    flags: <span class="string">'w'</span>,</span><br><span class="line">    mode: <span class="number">438</span>,</span><br><span class="line">    fd: <span class="literal">null</span>,</span><br><span class="line">    encoding: <span class="string">'utf-8'</span>,</span><br><span class="line">    start: <span class="number">0</span>,</span><br><span class="line">    highWaterMark: <span class="number">3</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">ws.write(<span class="string">'拉勾教育'</span>,()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'数据写完了'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">ws.on(<span class="string">'open'</span>,(fd)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'open'</span>,fd)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">ws.write(<span class="string">'1'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// close 是在数据写入操作全部完成之后再执行</span></span><br><span class="line">ws.on(<span class="string">'close'</span>,()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'文件关闭了'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// end 执行之后就意味着数据写入操作完成</span></span><br><span class="line">ws.end()</span><br><span class="line"></span><br><span class="line">ws.on(<span class="string">'error'</span>,(err)=&gt;&#123;</span><br><span class="line">   <span class="built_in">console</span>.log(<span class="string">'出错了'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="42-write执行流程"><a href="#42-write执行流程" class="headerlink" title="42.write执行流程"></a>42.write执行流程</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ws = fs.createWriteStream(<span class="string">'test.txt'</span>,&#123;</span><br><span class="line">    highWaterMark: <span class="number">3</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> flag = ws.write(<span class="string">'1'</span>)</span><br><span class="line"><span class="built_in">console</span>.log(flag) <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line">flag = ws.write(<span class="string">'1'</span>)</span><br><span class="line"><span class="built_in">console</span>.log(flag) <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line">flag = ws.write(<span class="string">'1'</span>)</span><br><span class="line"><span class="built_in">console</span>.log(flag) <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line">ws.on(<span class="string">'drain'</span>,()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'11'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 01 第一次调用 write 方法时是将数据直接写入到文件中</span></span><br><span class="line"><span class="comment"> * 02 第二次开始 write 方法就是将数据写入至缓存中</span></span><br><span class="line"><span class="comment"> * 03 生产速度和消费速度是不一样的，一般情况下生产速度要比消费速度快很多</span></span><br><span class="line"><span class="comment"> * 04 当 flag 为 false 之后并不是意味着当前次的数据不能被写入了。但是我们应该告知数据的生产者，当前的消费速度已经跟不上生产速度了，所以这个时候，一般我们会将可读流的模块修改为暂停模式。</span></span><br><span class="line"><span class="comment"> * 05 当数据生产者暂停之后，消费者会慢慢的消化它内部缓存中的数据，直到可以再次被执行写入操作</span></span><br><span class="line"><span class="comment"> * 06 当缓冲区可以继续写入数据时如何让生产者知道？ drain 事件</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="43-控制写入速度"><a href="#43-控制写入速度" class="headerlink" title="43.控制写入速度"></a>43.控制写入速度</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 需求: “拉勾教育”写入指定文件</span></span><br><span class="line"><span class="comment"> * 01 一次写入</span></span><br><span class="line"><span class="comment"> * 02 分批写入</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">let</span> ws = fs.createWriteStream(<span class="string">'test.txt'</span>,&#123;</span><br><span class="line">    highWaterMark: <span class="number">3</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// ws.write('拉勾教育')</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> source = <span class="string">'拉勾教育'</span>.split(<span class="string">''</span>)</span><br><span class="line"><span class="keyword">let</span> num = <span class="number">0</span></span><br><span class="line"><span class="keyword">let</span> flag = <span class="literal">true</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">executeWrite</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    flag = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">while</span>(num !== <span class="number">4</span> &amp;&amp; flag)&#123;</span><br><span class="line">       flag = ws.write(source[num])</span><br><span class="line">       num++</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">executeWrite()</span><br><span class="line"></span><br><span class="line">ws.on(<span class="string">'drain'</span>,()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'drain 执行了'</span>)</span><br><span class="line">    executeWrite()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="44-背压机制"><a href="#44-背压机制" class="headerlink" title="44.背压机制"></a>44.背压机制</h3><p>Node.js 的 stream 已实现了背压机制</p>
<blockquote>
<p>数据读写时可能存在的问题</p>
</blockquote>
<ul>
<li>内存溢出、GC频繁调用、其它进程变慢</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> rs = fs.createReadStream(<span class="string">'test.txt'</span>, &#123;</span><br><span class="line">    highWaterMark: <span class="number">4</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> ws = fs.createWriteStream(<span class="string">'test1.txt'</span>,&#123;</span><br><span class="line">    highWaterMark: <span class="number">1</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// let flag = true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// rs.on('data',(chunk)=&gt;&#123;</span></span><br><span class="line"><span class="comment">//     flag = ws.write(chunk,()=&gt;&#123;</span></span><br><span class="line"><span class="comment">//         console.log('写完了')</span></span><br><span class="line"><span class="comment">//     &#125;)</span></span><br><span class="line"><span class="comment">//     if(!flag)&#123;</span></span><br><span class="line"><span class="comment">//         rs.pause()</span></span><br><span class="line"><span class="comment">//     &#125;</span></span><br><span class="line"><span class="comment">// &#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// rs.on('drain',()=&gt;&#123;</span></span><br><span class="line"><span class="comment">//    rs.resume()</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">rs.pipe(ws)</span><br></pre></td></tr></table></figure>

<h3 id="45-模拟文件可读流01"><a href="#45-模拟文件可读流01" class="headerlink" title="45.模拟文件可读流01"></a>45.模拟文件可读流01</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> EventEmitter = <span class="built_in">require</span>(<span class="string">'events'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyFileReadStream</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;</span><br><span class="line">   <span class="keyword">constructor</span>(path, options = &#123;&#125;) &#123;</span><br><span class="line">       <span class="keyword">super</span>()</span><br><span class="line">       <span class="keyword">this</span>.path = path</span><br><span class="line">       <span class="keyword">this</span>.flags = options.flags || <span class="string">'r'</span></span><br><span class="line">       <span class="keyword">this</span>.mode = options.mode || <span class="number">438</span></span><br><span class="line">       <span class="keyword">this</span>.autoClose = options.autoClose || <span class="literal">true</span></span><br><span class="line">       <span class="keyword">this</span>.start = options.start || <span class="number">0</span></span><br><span class="line">       <span class="keyword">this</span>.end = options.start</span><br><span class="line">       <span class="keyword">this</span>.highWaterMark = options.highWaterMark || <span class="number">64</span>*<span class="number">1024</span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">this</span>.open()</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   open() &#123;</span><br><span class="line">       fs.open(<span class="keyword">this</span>.path,<span class="keyword">this</span>.flags,<span class="keyword">this</span>.mode,(err, fd) =&gt; &#123;</span><br><span class="line">           <span class="keyword">if</span>(err)&#123;</span><br><span class="line">               <span class="keyword">this</span>.emit(<span class="string">'error'</span>, err)</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">this</span>.fd = fd</span><br><span class="line">           <span class="keyword">this</span>.emit(<span class="string">'open'</span>,fd)</span><br><span class="line">       &#125;)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> rs = <span class="keyword">new</span> MyFileReadStream(<span class="string">'test.txt'</span>)</span><br><span class="line"></span><br><span class="line">rs.on(<span class="string">'open'</span>, (fd)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'open'</span>,fd)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">rs.on(<span class="string">'error'</span>, (err)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="46-模拟文件可读流02"><a href="#46-模拟文件可读流02" class="headerlink" title="46.模拟文件可读流02"></a>46.模拟文件可读流02</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> EventEmitter = <span class="built_in">require</span>(<span class="string">'events'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyFileReadStream</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;</span><br><span class="line">   <span class="keyword">constructor</span>(path, options = &#123;&#125;) &#123;</span><br><span class="line">       <span class="keyword">super</span>()</span><br><span class="line">       <span class="keyword">this</span>.path = path</span><br><span class="line">       <span class="keyword">this</span>.flags = options.flags || <span class="string">'r'</span></span><br><span class="line">       <span class="keyword">this</span>.mode = options.mode || <span class="number">438</span></span><br><span class="line">       <span class="keyword">this</span>.autoClose = options.autoClose || <span class="literal">true</span></span><br><span class="line">       <span class="keyword">this</span>.start = options.start || <span class="number">0</span></span><br><span class="line">       <span class="keyword">this</span>.end = options.end</span><br><span class="line">       <span class="keyword">this</span>.highWaterMark = options.highWaterMark || <span class="number">64</span>*<span class="number">1024</span></span><br><span class="line">       <span class="keyword">this</span>.readOffset = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">this</span>.open()</span><br><span class="line">       <span class="keyword">this</span>.on(<span class="string">'newListener'</span>, (type) =&gt; &#123;</span><br><span class="line">           <span class="built_in">console</span>.log(type)</span><br><span class="line">           <span class="keyword">if</span>(type === <span class="string">'data'</span>) &#123;</span><br><span class="line">               <span class="keyword">this</span>.read()</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   open() &#123;</span><br><span class="line">       fs.open(<span class="keyword">this</span>.path,<span class="keyword">this</span>.flags,<span class="keyword">this</span>.mode,(err, fd) =&gt; &#123;</span><br><span class="line">           <span class="keyword">if</span>(err)&#123;</span><br><span class="line">               <span class="keyword">this</span>.emit(<span class="string">'error'</span>, err)</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">this</span>.fd = fd</span><br><span class="line">           <span class="keyword">this</span>.emit(<span class="string">'open'</span>,fd)</span><br><span class="line">       &#125;)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">    read() &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">typeof</span> <span class="keyword">this</span>.fd !== <span class="string">'number'</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.once(<span class="string">'open'</span>,<span class="keyword">this</span>.read)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="keyword">this</span>.fd)</span><br><span class="line">        <span class="keyword">let</span> buf = Buffer.alloc(<span class="keyword">this</span>.highWaterMark)</span><br><span class="line">        fs.read(<span class="keyword">this</span>.fd,buf,<span class="number">0</span>,<span class="keyword">this</span>.highWaterMark,<span class="keyword">this</span>.readOffset,(err,readBytes)=&gt;&#123;</span><br><span class="line">           <span class="keyword">if</span>(readBytes)&#123;</span><br><span class="line">             <span class="keyword">this</span>.readOffset = readBytes</span><br><span class="line">             <span class="keyword">this</span>.emit(<span class="string">'data'</span>,buf)</span><br><span class="line">             <span class="keyword">this</span>.read()</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="keyword">this</span>.emit(<span class="string">'end'</span>)</span><br><span class="line">             <span class="keyword">this</span>.close()</span><br><span class="line">           &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close() &#123;</span><br><span class="line">        fs.close(<span class="keyword">this</span>.fd,()=&gt;&#123;</span><br><span class="line">            <span class="keyword">this</span>.emit(<span class="string">'close'</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> rs = <span class="keyword">new</span> MyFileReadStream(<span class="string">'test.txt'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// rs.on('open', (fd)=&gt;&#123;</span></span><br><span class="line"><span class="comment">//     console.log('open',fd)</span></span><br><span class="line"><span class="comment">// &#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// rs.on('error', (err)=&gt;&#123;</span></span><br><span class="line"><span class="comment">//     console.log(err)</span></span><br><span class="line"><span class="comment">// &#125;)</span></span><br><span class="line"></span><br><span class="line">rs.on(<span class="string">'data'</span>, (chunk)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(chunk)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">rs.on(<span class="string">'end'</span>, ()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'end'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">rs.on(<span class="string">'close'</span>, ()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'close'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="47-模拟文件可读流03"><a href="#47-模拟文件可读流03" class="headerlink" title="47.模拟文件可读流03"></a>47.模拟文件可读流03</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> EventEmitter = <span class="built_in">require</span>(<span class="string">'events'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyFileReadStream</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;</span><br><span class="line">   <span class="keyword">constructor</span>(path, options = &#123;&#125;) &#123;</span><br><span class="line">       <span class="keyword">super</span>()</span><br><span class="line">       <span class="keyword">this</span>.path = path</span><br><span class="line">       <span class="keyword">this</span>.flags = options.flags || <span class="string">'r'</span></span><br><span class="line">       <span class="keyword">this</span>.mode = options.mode || <span class="number">438</span></span><br><span class="line">       <span class="keyword">this</span>.autoClose = options.autoClose || <span class="literal">true</span></span><br><span class="line">       <span class="keyword">this</span>.start = options.start || <span class="number">0</span></span><br><span class="line">       <span class="keyword">this</span>.end = options.end</span><br><span class="line">       <span class="keyword">this</span>.highWaterMark = options.highWaterMark || <span class="number">64</span>*<span class="number">1024</span></span><br><span class="line">       <span class="keyword">this</span>.readOffset = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">this</span>.open()</span><br><span class="line">       <span class="keyword">this</span>.on(<span class="string">'newListener'</span>, (type) =&gt; &#123;</span><br><span class="line">           <span class="built_in">console</span>.log(type)</span><br><span class="line">           <span class="keyword">if</span>(type === <span class="string">'data'</span>) &#123;</span><br><span class="line">               <span class="keyword">this</span>.read()</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   open() &#123;</span><br><span class="line">       fs.open(<span class="keyword">this</span>.path,<span class="keyword">this</span>.flags,<span class="keyword">this</span>.mode,(err, fd) =&gt; &#123;</span><br><span class="line">           <span class="keyword">if</span>(err)&#123;</span><br><span class="line">               <span class="keyword">this</span>.emit(<span class="string">'error'</span>, err)</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">this</span>.fd = fd</span><br><span class="line">           <span class="keyword">this</span>.emit(<span class="string">'open'</span>,fd)</span><br><span class="line">       &#125;)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">    read() &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">typeof</span> <span class="keyword">this</span>.fd !== <span class="string">'number'</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.once(<span class="string">'open'</span>,<span class="keyword">this</span>.read)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="keyword">this</span>.fd)</span><br><span class="line">        <span class="keyword">let</span> buf = Buffer.alloc(<span class="keyword">this</span>.highWaterMark)</span><br><span class="line">        <span class="keyword">let</span> howMuchToRead</span><br><span class="line">        <span class="comment">// if(this.end)&#123;</span></span><br><span class="line">        <span class="comment">//     howMuchToRead = Math.min(this.end-this.readOffset+1,this.highWaterMark)</span></span><br><span class="line">        <span class="comment">// &#125; else &#123;</span></span><br><span class="line">        <span class="comment">//     howMuchToRead = this.highWaterMark</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        howMuchToRead = <span class="keyword">this</span>.end ? <span class="built_in">Math</span>.min(<span class="keyword">this</span>.end-<span class="keyword">this</span>.readOffset+<span class="number">1</span>,<span class="keyword">this</span>.highWaterMark) : <span class="keyword">this</span>.highWaterMark</span><br><span class="line">        fs.read(<span class="keyword">this</span>.fd,buf,<span class="number">0</span>,<span class="keyword">this</span>.howMuchToRead,<span class="keyword">this</span>.readOffset,(err,readBytes)=&gt;&#123;</span><br><span class="line">           <span class="keyword">if</span>(readBytes)&#123;</span><br><span class="line">             <span class="keyword">this</span>.readOffset = readBytes</span><br><span class="line">             <span class="keyword">this</span>.emit(<span class="string">'data'</span>,buf.slice(<span class="number">0</span>, readBytes))</span><br><span class="line">             <span class="keyword">this</span>.read()</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="keyword">this</span>.emit(<span class="string">'end'</span>)</span><br><span class="line">             <span class="keyword">this</span>.close()</span><br><span class="line">           &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close() &#123;</span><br><span class="line">        fs.close(<span class="keyword">this</span>.fd,()=&gt;&#123;</span><br><span class="line">            <span class="keyword">this</span>.emit(<span class="string">'close'</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> rs = <span class="keyword">new</span> MyFileReadStream(<span class="string">'test.txt'</span>,&#123;</span><br><span class="line">    end: <span class="number">7</span>,</span><br><span class="line">    highWaterMark: <span class="number">3</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">rs.on(<span class="string">'data'</span>, (chunk)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(chunk)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="48-链表结构"><a href="#48-链表结构" class="headerlink" title="48.链表结构"></a>48.链表结构</h3><blockquote>
<p>数组缺点</p>
</blockquote>
<ul>
<li>数组存储数据的长度具有上限</li>
<li>数组存在塌陷问题</li>
</ul>
<p>链表是一系列节点的集合<br>每个节点都具有指向下一个节点的属性</p>
<blockquote>
<p>链表分类</p>
</blockquote>
<ul>
<li>双向链表</li>
<li>单向链表</li>
<li>循环链表</li>
</ul>
<h3 id="49-单向链表实现-1"><a href="#49-单向链表实现-1" class="headerlink" title="49.单向链表实现-1"></a>49.单向链表实现-1</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 01 node * head * null</span></span><br><span class="line"><span class="comment"> * 02 head --&gt; null</span></span><br><span class="line"><span class="comment"> * 03 size</span></span><br><span class="line"><span class="comment"> * 04 next element</span></span><br><span class="line"><span class="comment"> * 05 增加 删除 修改 查询 清空</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(element, next) &#123;</span><br><span class="line">        <span class="keyword">this</span>.element = element</span><br><span class="line">        <span class="keyword">this</span>.next = next</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LinkedList</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(head, size) &#123;</span><br><span class="line">        <span class="keyword">this</span>.head = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">this</span>.size = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    add(index, element) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">arguments</span>.length === <span class="number">1</span>) &#123;</span><br><span class="line">            element = index</span><br><span class="line">            index = <span class="keyword">this</span>.size</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(index &lt; <span class="number">0</span> || index &gt; <span class="keyword">this</span>.size) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'cross the border'</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(index===<span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> head = <span class="keyword">this</span>.head</span><br><span class="line">            <span class="keyword">this</span>.head = <span class="keyword">new</span> Node(element, head)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> prevNode = <span class="keyword">this</span>._getNode(index - <span class="number">1</span>)</span><br><span class="line">            prevNode.next = <span class="keyword">new</span> Node(element, prevNode.next)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> l1 = <span class="keyword">new</span> LinkedList()</span><br><span class="line">l1.add(index,<span class="string">'node1'</span>)</span><br><span class="line"><span class="built_in">console</span>.log(l1)</span><br></pre></td></tr></table></figure>

<h3 id="50-单向链表实现-2"><a href="#50-单向链表实现-2" class="headerlink" title="50.单向链表实现-2"></a>50.单向链表实现-2</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 01 node * head * null</span></span><br><span class="line"><span class="comment"> * 02 head --&gt; null</span></span><br><span class="line"><span class="comment"> * 03 size</span></span><br><span class="line"><span class="comment"> * 04 next element</span></span><br><span class="line"><span class="comment"> * 05 增加 删除 修改 查询 清空</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(element, next) &#123;</span><br><span class="line">        <span class="keyword">this</span>.element = element</span><br><span class="line">        <span class="keyword">this</span>.next = next</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LinkedList</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(head, size) &#123;</span><br><span class="line">        <span class="keyword">this</span>.head = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">this</span>.size = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    _getNode(index) &#123;</span><br><span class="line">        <span class="keyword">if</span>(index &lt; <span class="number">0</span> || index &gt;= <span class="keyword">this</span>.size) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'越界了'</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> currentNode = <span class="keyword">this</span>.head</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; index; i++) &#123;</span><br><span class="line">            currentNode = currentNode.next</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> currentNode</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    add(index, element) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">arguments</span>.length === <span class="number">1</span>) &#123;</span><br><span class="line">            element = index</span><br><span class="line">            index = <span class="keyword">this</span>.size</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(index &lt; <span class="number">0</span> || index &gt; <span class="keyword">this</span>.size) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'cross the border'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(index===<span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> head = <span class="keyword">this</span>.head</span><br><span class="line">            <span class="keyword">this</span>.head = <span class="keyword">new</span> Node(element, head)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> prevNode = <span class="keyword">this</span>._getNode(index - <span class="number">1</span>)</span><br><span class="line">            prevNode.next = <span class="keyword">new</span> Node(element, prevNode.next)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    remove(index) &#123;</span><br><span class="line">        <span class="keyword">if</span>(index === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> head = <span class="keyword">this</span>.head</span><br><span class="line">            <span class="keyword">this</span>.head = head.next</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> prevNode = <span class="keyword">this</span>._getNode(index - <span class="number">1</span>)</span><br><span class="line">            prevNode.next = prevNode.next.next</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.size--</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> l1 = <span class="keyword">new</span> LinkedList()</span><br><span class="line">l1.add(<span class="string">'node1'</span>)</span><br><span class="line">l1.add(<span class="string">'node2'</span>)</span><br><span class="line">l1.add(<span class="number">1</span>,<span class="string">'node3'</span>)</span><br><span class="line">l1.remove(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">console</span>.log(l1)</span><br></pre></td></tr></table></figure>

<h3 id="51-单向链表实现-3"><a href="#51-单向链表实现-3" class="headerlink" title="51.单向链表实现-3"></a>51.单向链表实现-3</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 01 node * head * null</span></span><br><span class="line"><span class="comment"> * 02 head --&gt; null</span></span><br><span class="line"><span class="comment"> * 03 size</span></span><br><span class="line"><span class="comment"> * 04 next element</span></span><br><span class="line"><span class="comment"> * 05 增加 删除 修改 查询 清空</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(element, next) &#123;</span><br><span class="line">        <span class="keyword">this</span>.element = element</span><br><span class="line">        <span class="keyword">this</span>.next = next</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LinkedList</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(head, size) &#123;</span><br><span class="line">        <span class="keyword">this</span>.head = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">this</span>.size = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    _getNode(index) &#123;</span><br><span class="line">        <span class="keyword">if</span>(index &lt; <span class="number">0</span> || index &gt;= <span class="keyword">this</span>.size) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'越界了'</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> currentNode = <span class="keyword">this</span>.head</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; index; i++) &#123;</span><br><span class="line">            currentNode = currentNode.next</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> currentNode</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    add(index, element) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">arguments</span>.length === <span class="number">1</span>) &#123;</span><br><span class="line">            element = index</span><br><span class="line">            index = <span class="keyword">this</span>.size</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(index &lt; <span class="number">0</span> || index &gt; <span class="keyword">this</span>.size) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'cross the border'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(index===<span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> head = <span class="keyword">this</span>.head</span><br><span class="line">            <span class="keyword">this</span>.head = <span class="keyword">new</span> Node(element, head)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> prevNode = <span class="keyword">this</span>._getNode(index - <span class="number">1</span>)</span><br><span class="line">            prevNode.next = <span class="keyword">new</span> Node(element, prevNode.next)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    remove(index) &#123;</span><br><span class="line">        <span class="keyword">if</span>(index === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> head = <span class="keyword">this</span>.head</span><br><span class="line">            <span class="keyword">this</span>.head = head.next</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> prevNode = <span class="keyword">this</span>._getNode(index - <span class="number">1</span>)</span><br><span class="line">            prevNode.next = prevNode.next.next</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.size--</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">set</span>(index, element) &#123;</span><br><span class="line">        <span class="keyword">let</span> node = <span class="keyword">this</span>._getNode(index)</span><br><span class="line">        node.element = element</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">get</span>(index) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>._getNode(index)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    clear() &#123;</span><br><span class="line">        <span class="keyword">this</span>.head = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">this</span>.size = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> l1 = <span class="keyword">new</span> LinkedList()</span><br><span class="line">l1.add(<span class="string">'node1'</span>)</span><br><span class="line">l1.add(<span class="string">'node2'</span>)</span><br><span class="line">l1.add(<span class="number">1</span>,<span class="string">'node3'</span>)</span><br><span class="line"><span class="comment">// l1.remove(1)</span></span><br><span class="line">l1.set(<span class="number">1</span>,<span class="string">'node3-3'</span>)</span><br><span class="line"><span class="built_in">console</span>.log(l1)</span><br></pre></td></tr></table></figure>

<h3 id="52-单向链表实现队列"><a href="#52-单向链表实现队列" class="headerlink" title="52.单向链表实现队列"></a>52.单向链表实现队列</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 01 node * head * null</span></span><br><span class="line"><span class="comment"> * 02 head --&gt; null</span></span><br><span class="line"><span class="comment"> * 03 size</span></span><br><span class="line"><span class="comment"> * 04 next element</span></span><br><span class="line"><span class="comment"> * 05 增加 删除 修改 查询 清空</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(element, next) &#123;</span><br><span class="line">        <span class="keyword">this</span>.element = element</span><br><span class="line">        <span class="keyword">this</span>.next = next</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LinkedList</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(head, size) &#123;</span><br><span class="line">        <span class="keyword">this</span>.head = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">this</span>.size = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    _getNode(index) &#123;</span><br><span class="line">        <span class="keyword">if</span>(index &lt; <span class="number">0</span> || index &gt;= <span class="keyword">this</span>.size) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'越界了'</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> currentNode = <span class="keyword">this</span>.head</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; index; i++) &#123;</span><br><span class="line">            currentNode = currentNode.next</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> currentNode</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    add(index, element) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">arguments</span>.length === <span class="number">1</span>) &#123;</span><br><span class="line">            element = index</span><br><span class="line">            index = <span class="keyword">this</span>.size</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(index &lt; <span class="number">0</span> || index &gt; <span class="keyword">this</span>.size) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'cross the border'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(index===<span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> head = <span class="keyword">this</span>.head</span><br><span class="line">            <span class="keyword">this</span>.head = <span class="keyword">new</span> Node(element, head)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> prevNode = <span class="keyword">this</span>._getNode(index - <span class="number">1</span>)</span><br><span class="line">            prevNode.next = <span class="keyword">new</span> Node(element, prevNode.next)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    remove(index) &#123;</span><br><span class="line">        <span class="keyword">let</span> rmNode = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">if</span>(index === <span class="number">0</span>) &#123;</span><br><span class="line">            rmNode = <span class="keyword">this</span>.head</span><br><span class="line">            <span class="keyword">if</span>(!rmNode) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">undefined</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.head = rmNode.next</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> prevNode = <span class="keyword">this</span>._getNode(index - <span class="number">1</span>)</span><br><span class="line">            rmNode = prevNode.next</span><br><span class="line">            prevNode.next = rmNode.next</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.size--</span><br><span class="line">        <span class="keyword">return</span> rmNode</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">set</span>(index, element) &#123;</span><br><span class="line">        <span class="keyword">let</span> node = <span class="keyword">this</span>._getNode(index)</span><br><span class="line">        node.element = element</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">get</span>(index) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>._getNode(index)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    clear() &#123;</span><br><span class="line">        <span class="keyword">this</span>.head = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">this</span>.size = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Queue</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>()&#123;</span><br><span class="line">        <span class="keyword">this</span>.linkedList = <span class="keyword">new</span> LinkedList()</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    enQueue(data) &#123;</span><br><span class="line">        <span class="keyword">this</span>.linkedList.add(data)</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    deQueue() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.LinkedList.remove(<span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> q = <span class="keyword">new</span> Queue()</span><br><span class="line">q.enQueue(<span class="string">'node1'</span>)</span><br><span class="line">q.enQueue(<span class="string">'node2'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(q)</span><br><span class="line"><span class="keyword">let</span> a = q.deQueue()</span><br><span class="line"><span class="built_in">console</span>.log(a)</span><br></pre></td></tr></table></figure>

<h3 id="53-文件可写流实现-1"><a href="#53-文件可写流实现-1" class="headerlink" title="53.文件可写流实现-1"></a>53.文件可写流实现-1</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> EventsEmitter = <span class="built_in">require</span>(<span class="string">'events'</span>)</span><br><span class="line"><span class="keyword">const</span> Queue = <span class="built_in">require</span>(<span class="string">'./linkedList'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyWriteStream</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span></span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(path, options = &#123;&#125;)&#123;</span><br><span class="line">        <span class="keyword">super</span>()</span><br><span class="line">        <span class="keyword">this</span>.path = path</span><br><span class="line">        <span class="keyword">this</span>.flags = options.flags || <span class="string">'w'</span></span><br><span class="line">        <span class="keyword">this</span>.mode = options.mode || <span class="number">438</span></span><br><span class="line">        <span class="keyword">this</span>.autoClose = options.autoClose || <span class="literal">true</span></span><br><span class="line">        <span class="keyword">this</span>.start = options.start || <span class="number">0</span></span><br><span class="line">        <span class="keyword">this</span>.encoding = options.encoding || <span class="string">'utf-8'</span></span><br><span class="line">        <span class="keyword">this</span>.highWaterMark = options.highWaterMark || <span class="number">16</span>*<span class="number">1024</span></span><br><span class="line">        <span class="keyword">this</span>.open()</span><br><span class="line">    &#125;</span><br><span class="line">    open()&#123;</span><br><span class="line">        fs.open(<span class="keyword">this</span>.path,<span class="keyword">this</span>.flags,(err,fd)=&gt;&#123;</span><br><span class="line">            <span class="keyword">if</span>(err) &#123;</span><br><span class="line">                <span class="keyword">this</span>.emit(<span class="string">'error'</span>, err)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.fd = fd</span><br><span class="line">            <span class="keyword">this</span>.emit(<span class="string">'open'</span>, fd)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ws = <span class="keyword">new</span> MyWriteStream(<span class="string">'./f9.txt'</span>,&#123;&#125;)</span><br><span class="line">ws.on(<span class="string">'open'</span>,(fd)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'open----&gt;'</span>, fd)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="54-文件可写流实现-2"><a href="#54-文件可写流实现-2" class="headerlink" title="54.文件可写流实现-2"></a>54.文件可写流实现-2</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> EventsEmitter = <span class="built_in">require</span>(<span class="string">'events'</span>)</span><br><span class="line"><span class="keyword">const</span> Queue = <span class="built_in">require</span>(<span class="string">'./linkedList'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyWriteStream</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span></span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(path, options = &#123;&#125;)&#123;</span><br><span class="line">        <span class="keyword">super</span>()</span><br><span class="line">        <span class="keyword">this</span>.path = path</span><br><span class="line">        <span class="keyword">this</span>.flags = options.flags || <span class="string">'w'</span></span><br><span class="line">        <span class="keyword">this</span>.mode = options.mode || <span class="number">438</span></span><br><span class="line">        <span class="keyword">this</span>.autoClose = options.autoClose || <span class="literal">true</span></span><br><span class="line">        <span class="keyword">this</span>.start = options.start || <span class="number">0</span></span><br><span class="line">        <span class="keyword">this</span>.encoding = options.encoding || <span class="string">'utf-8'</span></span><br><span class="line">        <span class="keyword">this</span>.highWaterMark = options.highWaterMark || <span class="number">16</span>*<span class="number">1024</span></span><br><span class="line">        <span class="keyword">this</span>.open()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.writeoffset = <span class="keyword">this</span>.start</span><br><span class="line">        <span class="keyword">this</span>.writing = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">this</span>.writeLen = <span class="number">0</span></span><br><span class="line">        <span class="keyword">this</span>.needDrain = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">this</span>.cache = <span class="keyword">new</span> Queue()</span><br><span class="line">    &#125;</span><br><span class="line">    open()&#123;</span><br><span class="line">        fs.open(<span class="keyword">this</span>.path,<span class="keyword">this</span>.flags,(err,fd)=&gt;&#123;</span><br><span class="line">            <span class="keyword">if</span>(err) &#123;</span><br><span class="line">                <span class="keyword">this</span>.emit(<span class="string">'error'</span>, err)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.fd = fd</span><br><span class="line">            <span class="keyword">this</span>.emit(<span class="string">'open'</span>, fd)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    write(chunk, encoding, cb)&#123;</span><br><span class="line">       chunk = Buffer.isBuffer(chunk) ? chunk : Buffer.from(chunk)</span><br><span class="line">       <span class="keyword">this</span>.writeLen += chunk.length</span><br><span class="line">       <span class="keyword">let</span> flag = <span class="keyword">this</span>.written &lt; <span class="keyword">this</span>.highWaterMark</span><br><span class="line">       <span class="keyword">this</span>.needDrain = !flag</span><br><span class="line">       <span class="keyword">if</span>(<span class="keyword">this</span>.writing)&#123;</span><br><span class="line">           <span class="comment">// 当前正在执行写入，所以内容应该排队</span></span><br><span class="line">           <span class="comment">// this.cache.enQueue()</span></span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">           <span class="comment">// 当前不是正在写入那么执行写入</span></span><br><span class="line">           <span class="keyword">this</span>._write(chunk, encoding, cb)</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> flag</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _write(chunk, encoding, cb)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'正在执行第一次写入'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ws = <span class="keyword">new</span> MyWriteStream(<span class="string">'./f9.txt'</span>,&#123;&#125;)</span><br><span class="line">ws.on(<span class="string">'open'</span>,(fd)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'open----&gt;'</span>, fd)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">let</span> flag = ws.write(<span class="string">'1'</span>, <span class="string">'utf8'</span>, () =&gt; &#123;</span><br><span class="line">     <span class="built_in">console</span>.log(<span class="string">'ok1'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">console</span>.log(flag)</span><br></pre></td></tr></table></figure>

<h3 id="55-文件可写流实现-3"><a href="#55-文件可写流实现-3" class="headerlink" title="55.文件可写流实现-3"></a>55.文件可写流实现-3</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> EventsEmitter = <span class="built_in">require</span>(<span class="string">'events'</span>)</span><br><span class="line"><span class="keyword">const</span> Queue = <span class="built_in">require</span>(<span class="string">'./linkedList'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyWriteStream</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span></span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(path, options = &#123;&#125;)&#123;</span><br><span class="line">        <span class="keyword">super</span>()</span><br><span class="line">        <span class="keyword">this</span>.path = path</span><br><span class="line">        <span class="keyword">this</span>.flags = options.flags || <span class="string">'w'</span></span><br><span class="line">        <span class="keyword">this</span>.mode = options.mode || <span class="number">438</span></span><br><span class="line">        <span class="keyword">this</span>.autoClose = options.autoClose || <span class="literal">true</span></span><br><span class="line">        <span class="keyword">this</span>.start = options.start || <span class="number">0</span></span><br><span class="line">        <span class="keyword">this</span>.encoding = options.encoding || <span class="string">'utf-8'</span></span><br><span class="line">        <span class="keyword">this</span>.highWaterMark = options.highWaterMark || <span class="number">16</span>*<span class="number">1024</span></span><br><span class="line">        <span class="keyword">this</span>.open()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.writeoffset = <span class="keyword">this</span>.start</span><br><span class="line">        <span class="keyword">this</span>.writing = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">this</span>.writeLen = <span class="number">0</span></span><br><span class="line">        <span class="keyword">this</span>.needDrain = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">this</span>.cache = <span class="keyword">new</span> Queue()</span><br><span class="line">    &#125;</span><br><span class="line">    open()&#123;</span><br><span class="line">        fs.open(<span class="keyword">this</span>.path,<span class="keyword">this</span>.flags,(err,fd)=&gt;&#123;</span><br><span class="line">            <span class="keyword">if</span>(err) &#123;</span><br><span class="line">                <span class="keyword">this</span>.emit(<span class="string">'error'</span>, err)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.fd = fd</span><br><span class="line">            <span class="keyword">this</span>.emit(<span class="string">'open'</span>, fd)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    write(chunk, encoding, cb)&#123;</span><br><span class="line">       chunk = Buffer.isBuffer(chunk) ? chunk : Buffer.from(chunk)</span><br><span class="line">       <span class="keyword">this</span>.writeLen += chunk.length</span><br><span class="line">       <span class="keyword">let</span> flag = <span class="keyword">this</span>.written &lt; <span class="keyword">this</span>.highWaterMark</span><br><span class="line">       <span class="keyword">this</span>.needDrain = !flag</span><br><span class="line">       <span class="keyword">if</span>(<span class="keyword">this</span>.writing)&#123;</span><br><span class="line">           <span class="comment">// 当前正在执行写入，所以内容应该排队</span></span><br><span class="line">           <span class="keyword">this</span>.cache.enQueue(&#123;chunk,encoding,cb&#125;)</span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">           <span class="keyword">this</span>.writing = <span class="literal">true</span></span><br><span class="line">           <span class="comment">// 当前不是正在写入那么执行写入</span></span><br><span class="line">           <span class="keyword">this</span>._write(chunk, encoding, ()=&gt;&#123;</span><br><span class="line">               cb()</span><br><span class="line">               <span class="comment">// 清空排队的内容</span></span><br><span class="line">               <span class="keyword">this</span>._clearBuffer()</span><br><span class="line">           &#125;)</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> flag</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _write(chunk, encoding, cb)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'正在执行第一次写入'</span>)</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">typeof</span> <span class="keyword">this</span>.fd !== <span class="string">'number'</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.once(<span class="string">'open'</span>, ()=&gt;&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>._write(chunk, encoding, cb)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        fs.write(<span class="keyword">this</span>.fd, chunk, <span class="keyword">this</span>.start,chunk.length,<span class="keyword">this</span>.writeoffset, (err, written)=&gt;&#123;</span><br><span class="line">            <span class="keyword">this</span>.writeoffset += written</span><br><span class="line">            <span class="keyword">this</span>.writeLen -= written</span><br><span class="line">            cb &amp;&amp; cb()</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'ok1111111'</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _clearBuffer()&#123;</span><br><span class="line">        <span class="keyword">let</span> data = <span class="keyword">this</span>.cache.deQueue()</span><br><span class="line">        <span class="keyword">if</span>(data)&#123;</span><br><span class="line">            <span class="keyword">this</span>._write(data.element.chunk, data.element.encoding, ()=&gt; &#123;</span><br><span class="line">                data.element.cb &amp;&amp; data.element.cb()</span><br><span class="line">                <span class="keyword">this</span>._clearBuffer()</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">this</span>.needDrain) &#123;</span><br><span class="line">                <span class="keyword">this</span>.needDrain = <span class="literal">false</span></span><br><span class="line">                <span class="keyword">this</span>.emit(<span class="string">'drain'</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">console</span>.log(data)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ws = <span class="keyword">new</span> MyWriteStream(<span class="string">'./f9.txt'</span>,&#123;&#125;)</span><br><span class="line">ws.on(<span class="string">'open'</span>,(fd)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'open----&gt;'</span>, fd)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">let</span> flag = ws.write(<span class="string">'1'</span>, <span class="string">'utf8'</span>, () =&gt; &#123;</span><br><span class="line">     <span class="built_in">console</span>.log(<span class="string">'ok1'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">console</span>.log(flag)</span><br></pre></td></tr></table></figure>

<h3 id="56-pipe方法使用"><a href="#56-pipe方法使用" class="headerlink" title="56.pipe方法使用"></a>56.pipe方法使用</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> EventEmitter = <span class="built_in">require</span>(<span class="string">'events'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyFileReadStream</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;</span><br><span class="line">   <span class="keyword">constructor</span>(path, options = &#123;&#125;) &#123;</span><br><span class="line">       <span class="keyword">super</span>()</span><br><span class="line">       <span class="keyword">this</span>.path = path</span><br><span class="line">       <span class="keyword">this</span>.flags = options.flags || <span class="string">'r'</span></span><br><span class="line">       <span class="keyword">this</span>.mode = options.mode || <span class="number">438</span></span><br><span class="line">       <span class="keyword">this</span>.autoClose = options.autoClose || <span class="literal">true</span></span><br><span class="line">       <span class="keyword">this</span>.start = options.start || <span class="number">0</span></span><br><span class="line">       <span class="keyword">this</span>.end = options.end</span><br><span class="line">       <span class="keyword">this</span>.highWaterMark = options.highWaterMark || <span class="number">64</span>*<span class="number">1024</span></span><br><span class="line">       <span class="keyword">this</span>.readOffset = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">this</span>.open()</span><br><span class="line">       <span class="keyword">this</span>.on(<span class="string">'newListener'</span>, (type) =&gt; &#123;</span><br><span class="line">           <span class="built_in">console</span>.log(type)</span><br><span class="line">           <span class="keyword">if</span>(type === <span class="string">'data'</span>) &#123;</span><br><span class="line">               <span class="keyword">this</span>.read()</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   open() &#123;</span><br><span class="line">       fs.open(<span class="keyword">this</span>.path,<span class="keyword">this</span>.flags,<span class="keyword">this</span>.mode,(err, fd) =&gt; &#123;</span><br><span class="line">           <span class="keyword">if</span>(err)&#123;</span><br><span class="line">               <span class="keyword">this</span>.emit(<span class="string">'error'</span>, err)</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">this</span>.fd = fd</span><br><span class="line">           <span class="keyword">this</span>.emit(<span class="string">'open'</span>,fd)</span><br><span class="line">       &#125;)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">    read() &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">typeof</span> <span class="keyword">this</span>.fd !== <span class="string">'number'</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.once(<span class="string">'open'</span>,<span class="keyword">this</span>.read)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="keyword">this</span>.fd)</span><br><span class="line">        <span class="keyword">let</span> buf = Buffer.alloc(<span class="keyword">this</span>.highWaterMark)</span><br><span class="line">        <span class="keyword">let</span> howMuchToRead</span><br><span class="line">        <span class="comment">// if(this.end)&#123;</span></span><br><span class="line">        <span class="comment">//     howMuchToRead = Math.min(this.end-this.readOffset+1,this.highWaterMark)</span></span><br><span class="line">        <span class="comment">// &#125; else &#123;</span></span><br><span class="line">        <span class="comment">//     howMuchToRead = this.highWaterMark</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        howMuchToRead = <span class="keyword">this</span>.end ? <span class="built_in">Math</span>.min(<span class="keyword">this</span>.end-<span class="keyword">this</span>.readOffset+<span class="number">1</span>,<span class="keyword">this</span>.highWaterMark) : <span class="keyword">this</span>.highWaterMark</span><br><span class="line">        fs.read(<span class="keyword">this</span>.fd,buf,<span class="number">0</span>,<span class="keyword">this</span>.howMuchToRead,<span class="keyword">this</span>.readOffset,(err,readBytes)=&gt;&#123;</span><br><span class="line">           <span class="keyword">if</span>(readBytes)&#123;</span><br><span class="line">             <span class="keyword">this</span>.readOffset = readBytes</span><br><span class="line">             <span class="keyword">this</span>.emit(<span class="string">'data'</span>,buf.slice(<span class="number">0</span>, readBytes))</span><br><span class="line">             <span class="keyword">this</span>.read()</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="keyword">this</span>.emit(<span class="string">'end'</span>)</span><br><span class="line">             <span class="keyword">this</span>.close()</span><br><span class="line">           &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close() &#123;</span><br><span class="line">        fs.close(<span class="keyword">this</span>.fd,()=&gt;&#123;</span><br><span class="line">            <span class="keyword">this</span>.emit(<span class="string">'close'</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pipe(ws) &#123;</span><br><span class="line">        <span class="keyword">this</span>.on(<span class="string">'data'</span>,(data) =&gt; &#123;</span><br><span class="line">            <span class="keyword">let</span> flag = ws.write(data)</span><br><span class="line">            <span class="keyword">if</span>(!flag) &#123;</span><br><span class="line">                <span class="keyword">this</span>.pause()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        ws.on(<span class="string">'drain'</span>,()=&gt;&#123;</span><br><span class="line">            <span class="keyword">this</span>.resume()</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = MyFileReadStream</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> MyFileReadStream = <span class="built_in">require</span>(<span class="string">'./ReadStream'</span>)</span><br><span class="line"><span class="keyword">const</span> rs = <span class="keyword">new</span> MyFileReadStream(<span class="string">'./f9.txt'</span>)</span><br><span class="line"><span class="keyword">const</span> ws = fs.createWriteStream(<span class="string">'./f10.txt'</span>, &#123;</span><br><span class="line">    highWaterStream: <span class="number">1</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">rs.pipe(ws)</span><br></pre></td></tr></table></figure>

<h2 id="模块三-·-通信"><a href="#模块三-·-通信" class="headerlink" title="模块三 · 通信"></a>模块三 · 通信</h2><h3 id="1-通信基本原理"><a href="#1-通信基本原理" class="headerlink" title="1.通信基本原理"></a>1.通信基本原理</h3><blockquote>
<p>通信必要条件</p>
</blockquote>
<ul>
<li>主机之前需要有传输介质</li>
<li>主机上必须有网卡设备</li>
<li>主机之间需要协商网络速率</li>
</ul>
<h3 id="2-网络通讯方式"><a href="#2-网络通讯方式" class="headerlink" title="2.网络通讯方式"></a>2.网络通讯方式</h3><blockquote>
<p>常见通讯方式</p>
</blockquote>
<ul>
<li>交换机通讯</li>
<li>路由器通讯</li>
</ul>
<p>交换机的接口数量有上限<br>局域网存在大量主机会造成广播风暴</p>
<h3 id="3-网络层次模型"><a href="#3-网络层次模型" class="headerlink" title="3.网络层次模型"></a>3.网络层次模型</h3><blockquote>
<p>OSI 七层模型</p>
</blockquote>
<ul>
<li>应用层：用户与网络的接口</li>
<li>表示层：数据加密、转换、压缩</li>
<li>会话层：控制网络连接建立与终止</li>
<li>传输层：控制数据传输可靠性</li>
<li>网络层：确定目标网络</li>
<li>数据链路层：确定目标主机</li>
<li>物理层：各种物理设备和标准</li>
</ul>
<p>数据从A至B，先封装再解封</p>
<h3 id="4-数据封装与解封装"><a href="#4-数据封装与解封装" class="headerlink" title="4.数据封装与解封装"></a>4.数据封装与解封装</h3><p>略</p>
<h3 id="5-TCP三次握手与四次挥手"><a href="#5-TCP三次握手与四次挥手" class="headerlink" title="5.TCP三次握手与四次挥手"></a>5.TCP三次握手与四次挥手</h3><blockquote>
<p>TCP 协议</p>
</blockquote>
<ul>
<li>TCP 属于传输层协议</li>
<li>TCP 是面向连接的协议</li>
<li>TCP 用于处理实时通信</li>
</ul>
<blockquote>
<p>常见控制字段</p>
</blockquote>
<ul>
<li>SYN = 1 表示请求建立连接</li>
<li>FIN = 1 表示请求断开连接</li>
<li>ACK = 1 表示数据信息确认</li>
</ul>
<p>一个服务端会服务于多个客户端</p>
<ul>
<li>TCP 处于传输层，基于端口，面向连接</li>
<li>主机之间要想通信需要先建立双向数据通道</li>
<li>TCP 的握手和挥手本质上都是四次</li>
</ul>
<h3 id="6-创建TCP通信"><a href="#6-创建TCP通信" class="headerlink" title="6.创建TCP通信"></a>6.创建TCP通信</h3><p>Net 模块实现了底层通信接口</p>
<blockquote>
<p>通信过程</p>
</blockquote>
<ul>
<li>创建服务端：接收和回写客户端数据</li>
<li>创建客户端：发送和接收服务端数据</li>
<li>数据传输：内置服务事件和方法读写数据</li>
</ul>
<blockquote>
<p>通信事件</p>
</blockquote>
<ul>
<li>listening 事件：调用 server.listen 方法之后触发</li>
<li>connection 事件：新的连接建立时触发</li>
<li>close 事件：当 server 关闭时触发</li>
<li>error 事件：当错误出现的时候触发</li>
</ul>
<blockquote>
<p>通信事件&amp;方法</p>
</blockquote>
<ul>
<li>data 事件：当接收到数据的时候触发改事件</li>
<li>write 方法：在 socket 上发送数据，默认是UTF8编码</li>
<li>end 操作：当 socket 的一端发送 FIN 包时触发，结束可读端</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server.js</span></span><br><span class="line"><span class="keyword">const</span> net = <span class="built_in">require</span>(<span class="string">'net'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = net.createServer()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> PORT = <span class="number">1234</span></span><br><span class="line"><span class="keyword">const</span> HOST = <span class="string">'localhost'</span></span><br><span class="line"></span><br><span class="line">server.listen(PORT, HOST)</span><br><span class="line"></span><br><span class="line">server.on(<span class="string">'listening'</span>, ()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`服务端已经开启在 <span class="subst">$&#123;HOST&#125;</span>:<span class="subst">$&#123;PORT&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.on(<span class="string">'connection'</span>, (socket) =&gt; &#123;</span><br><span class="line">   socket.on(<span class="string">'data'</span>,(chunk) =&gt; &#123;</span><br><span class="line">       <span class="keyword">const</span> msg = chunk.toString()</span><br><span class="line">       <span class="built_in">console</span>.log(msg)</span><br><span class="line"></span><br><span class="line">       socket.write(Buffer.from(<span class="string">'您好'</span>+msg))</span><br><span class="line">   &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.on(<span class="string">'close'</span>, ()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'服务端关闭了'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.on(<span class="string">'error'</span>, (err)=&gt;&#123;</span><br><span class="line">    <span class="keyword">if</span>(err.code === <span class="string">'EADDRINUSE'</span>)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'地址正在被使用'</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// client.js</span></span><br><span class="line"><span class="keyword">const</span> net = <span class="built_in">require</span>(<span class="string">'net'</span>)</span><br><span class="line"><span class="keyword">const</span> client = net.createConnection(&#123;</span><br><span class="line">    port: <span class="number">1234</span>,</span><br><span class="line">    host: <span class="string">'127.0.0.1'</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">client.on(<span class="string">'connect'</span>, ()=&gt;&#123;</span><br><span class="line">    client.write(<span class="string">'拉勾教育'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">client.on(<span class="string">'data'</span>, (chunk)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(chunk.toString())</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">client.on(<span class="string">'error'</span>, (err)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">client.on(<span class="string">'close'</span>, ()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'客户端断开连接'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="7-TCP粘包及解决"><a href="#7-TCP粘包及解决" class="headerlink" title="7.TCP粘包及解决"></a>7.TCP粘包及解决</h3><p>通信包含数据发送端和接收端<br>发送端累积数据统一发送<br>接收端缓冲数据之后再消费</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server.js</span></span><br><span class="line"><span class="keyword">const</span> net = <span class="built_in">require</span>(<span class="string">'net'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = net.createServer()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> PORT = <span class="number">1234</span></span><br><span class="line"><span class="keyword">const</span> HOST = <span class="string">'localhost'</span></span><br><span class="line"></span><br><span class="line">server.listen(PORT, HOST)</span><br><span class="line"></span><br><span class="line">server.on(<span class="string">'listening'</span>, ()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`服务端已经开启在 <span class="subst">$&#123;HOST&#125;</span>:<span class="subst">$&#123;PORT&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.on(<span class="string">'connection'</span>, (socket) =&gt; &#123;</span><br><span class="line">   socket.on(<span class="string">'data'</span>,(chunk) =&gt; &#123;</span><br><span class="line">       <span class="keyword">const</span> msg = chunk.toString()</span><br><span class="line">       <span class="built_in">console</span>.log(msg)</span><br><span class="line"></span><br><span class="line">       socket.write(Buffer.from(<span class="string">'您好'</span>+msg))</span><br><span class="line">   &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.on(<span class="string">'close'</span>, ()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'服务端关闭了'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.on(<span class="string">'error'</span>, (err)=&gt;&#123;</span><br><span class="line">    <span class="keyword">if</span>(err.code === <span class="string">'EADDRINUSE'</span>)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'地址正在被使用'</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// client.js</span></span><br><span class="line"><span class="keyword">const</span> net = <span class="built_in">require</span>(<span class="string">'net'</span>)</span><br><span class="line"><span class="keyword">const</span> client = net.createConnection(&#123;</span><br><span class="line">    port: <span class="number">1234</span>,</span><br><span class="line">    host: <span class="string">'127.0.0.1'</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> dataArr = [</span><br><span class="line">    <span class="string">'拉勾教育2'</span>,</span><br><span class="line">    <span class="string">'拉勾教育3'</span>,</span><br><span class="line">    <span class="string">'拉勾教育4'</span>,</span><br><span class="line">    <span class="string">'拉勾教育5'</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">client.on(<span class="string">'connect'</span>, ()=&gt;&#123;</span><br><span class="line">    client.write(<span class="string">'拉勾教育1'</span>)</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;dataArr.length;i++)&#123;</span><br><span class="line">        (<span class="function"><span class="keyword">function</span>(<span class="params">val,index</span>)</span>&#123;</span><br><span class="line">            setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">                client.write(val)</span><br><span class="line">            &#125;,<span class="number">1000</span>*(index+<span class="number">1</span>))</span><br><span class="line">        &#125;)(dataArr[i],i)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">client.on(<span class="string">'data'</span>, (chunk)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(chunk.toString())</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">client.on(<span class="string">'error'</span>, (err)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">client.on(<span class="string">'close'</span>, ()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'客户端断开连接'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="8-封包拆包实现"><a href="#8-封包拆包实现" class="headerlink" title="8.封包拆包实现"></a>8.封包拆包实现</h3><blockquote>
<p>数据传输过程</p>
</blockquote>
<ul>
<li>进行数据编码，获取二进制数据包</li>
<li>按规则拆解数据，获取指定长度的数据</li>
</ul>
<p>Buffer 数据读写</p>
<ul>
<li>writeInt16BE：将 value 从指定位置写入</li>
<li>readInt16BE：从指定位置开始读取数据</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTransformCode</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>()&#123;</span><br><span class="line">        <span class="keyword">this</span>.pakageHeaderLen = <span class="number">4</span></span><br><span class="line">        <span class="keyword">this</span>.serialNum = <span class="number">0</span></span><br><span class="line">        <span class="keyword">this</span>.serialLen = <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    encode(data, serialNum) &#123;</span><br><span class="line">        <span class="keyword">const</span> body = Buffer.from(data)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 01 先按照指定的长度来申请一片内存空间作为 header 来使用</span></span><br><span class="line">        <span class="keyword">const</span> headerBuf = Buffer.alloc(<span class="keyword">this</span>.pakageHeaderLen)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 02 </span></span><br><span class="line">        headerBuf.writeInt16EB(serialNum || <span class="keyword">this</span>.serialNum)</span><br><span class="line"></span><br><span class="line">        headerBuf.writeInt16EB(body.length, <span class="keyword">this</span>.serialLen)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(serialNum === <span class="literal">undefined</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.serialNum++</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Buffer.concat([headerBuf,body])</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    decode(buffer) &#123;</span><br><span class="line">       <span class="keyword">const</span> headerBuf = buffer.slice(<span class="number">0</span>,<span class="keyword">this</span>.pakageHeaderLen)</span><br><span class="line">       <span class="keyword">const</span> bodyBuf = buffer.slice(<span class="keyword">this</span>.pakageHeaderLen)</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> &#123;</span><br><span class="line">           serialNum: headerBuf.readInt16EB(),</span><br><span class="line">           bodyLength: headerBuf.readInt16EB(<span class="keyword">this</span>.serialLen),</span><br><span class="line">           body: bodyBuf.toString()</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    getPackageLen(buffer) &#123;</span><br><span class="line">        <span class="keyword">if</span>(buffer.length &lt; <span class="keyword">this</span>.packageHeaderLen) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.packageHeaderLen + buffer.readInt16EB(<span class="keyword">this</span>.seriaLen)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = MyTransformCode</span><br></pre></td></tr></table></figure>

<h3 id="9-封包解决粘包"><a href="#9-封包解决粘包" class="headerlink" title="9.封包解决粘包"></a>9.封包解决粘包</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server.js</span></span><br><span class="line"><span class="keyword">const</span> net = <span class="built_in">require</span>(<span class="string">'net'</span>)</span><br><span class="line"><span class="keyword">const</span> MyTransform = <span class="built_in">require</span>(<span class="string">'./myTransform.js'</span>)</span><br><span class="line"><span class="keyword">const</span> server = net.createServer()</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> overageBuffer = <span class="literal">null</span></span><br><span class="line"><span class="keyword">let</span> ts = <span class="keyword">new</span> MyTransform()</span><br><span class="line"></span><br><span class="line">server.listen(<span class="string">'1234'</span>, <span class="string">'localhost'</span>)</span><br><span class="line"></span><br><span class="line">server.on(<span class="string">'listening'</span>,()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'服务端运行在 localhost:1234'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.on(<span class="string">'connection'</span>, (socket) =&gt; &#123;</span><br><span class="line">    socket.on(<span class="string">'data'</span>, (chunk) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span>(overageBuffer) &#123;</span><br><span class="line">            chunk = Buffer.concat([overageBuffer, chunk])</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> packageLen = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span>(packageLen = ts.getPakageLen(chunk))&#123;</span><br><span class="line">            <span class="keyword">const</span> packageCon = chunk.slice(<span class="number">0</span>, packageLen)</span><br><span class="line">            chunk = chunk.slice(packageLen)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> ret = ts.decode(packageCon)</span><br><span class="line">            <span class="built_in">console</span>.log(ret)</span><br><span class="line"></span><br><span class="line">            socket.write(ts.encode(ret.body, ret.serialNum))</span><br><span class="line">        &#125;</span><br><span class="line">        overageBuffer = chunk</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// client.js</span></span><br><span class="line"><span class="keyword">const</span> net = <span class="built_in">require</span>(<span class="string">'net'</span>)</span><br><span class="line"><span class="keyword">const</span> MyTransform = <span class="built_in">require</span>(<span class="string">'./myTransform.js'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> overageBuffer = <span class="literal">null</span></span><br><span class="line"><span class="keyword">let</span> ts = <span class="keyword">new</span> MyTransform()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> client = net.createConnection(&#123;</span><br><span class="line">    host: <span class="string">'localhost'</span>,</span><br><span class="line">    port: <span class="number">1234</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">client.write(ts.encode(<span class="string">'拉勾教育1'</span>))</span><br><span class="line">client.write(ts.encode(<span class="string">'拉勾教育2'</span>))</span><br><span class="line">client.write(ts.encode(<span class="string">'拉勾教育3'</span>))</span><br><span class="line">client.write(ts.encode(<span class="string">'拉勾教育4'</span>))</span><br><span class="line">client.write(ts.encode(<span class="string">'拉勾教育5'</span>))</span><br><span class="line">client.on(<span class="string">'data'</span>, (chunk) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span>(overageBuffer) &#123;</span><br><span class="line">            chunk = Buffer.concat([overageBuffer, chunk])</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> packageLen = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span>(packageLen = ts.getPakageLen(chunk))&#123;</span><br><span class="line">            <span class="keyword">const</span> packageCon = chunk.slice(<span class="number">0</span>, packageLen)</span><br><span class="line">            chunk = chunk.slice(packageLen)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> ret = ts.decode(packageCon)</span><br><span class="line">            <span class="built_in">console</span>.log(ret)</span><br><span class="line">        &#125;</span><br><span class="line">        overageBuffer = chunk</span><br><span class="line">    <span class="comment">// console.log(chunk.toString())</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="10-http-协议"><a href="#10-http-协议" class="headerlink" title="10.http 协议"></a>10.http 协议</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> net = <span class="built_in">require</span>(<span class="string">'net'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> server = net.createServer()</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">1234</span>, ()=&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'服务端启动了...'</span>)</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.on(<span class="string">'connection'</span>, (socket) =&gt; &#123;</span><br><span class="line">    socket.on(<span class="string">'data'</span>, (data)=&gt;&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(data.toString())</span><br><span class="line">    &#125;)</span><br><span class="line">    socket.end(<span class="string">'test http request'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> server = http.createServer(<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'111'</span>)</span><br><span class="line">&#125;)</span><br><span class="line">server.listen(<span class="number">1234</span>,()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'server is running'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="11-获取-http-请求信息"><a href="#11-获取-http-请求信息" class="headerlink" title="11.获取 http 请求信息"></a>11.获取 http 请求信息</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = requrie(<span class="string">'http'</span>)</span><br><span class="line"><span class="keyword">const</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = http.createServer(<span class="function">(<span class="params">req,res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// console.log('请求进来了')</span></span><br><span class="line">    <span class="keyword">let</span> &#123;pathname, query&#125; = url.parse(req.url, <span class="literal">true</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(pathname,<span class="string">'----'</span>,query)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 请求方式</span></span><br><span class="line">    <span class="built_in">console</span>.log(req.methed)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 版本号</span></span><br><span class="line">    <span class="built_in">console</span>.log(req.httpVersion)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 请求头</span></span><br><span class="line">    <span class="built_in">console</span>.log(req.headers)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 请求体数据获取</span></span><br><span class="line">    <span class="comment">// curl -v -x POST -d "'name':'lg'" http:localhost:1234/</span></span><br><span class="line">    <span class="keyword">let</span> arr =[]</span><br><span class="line">    req.on(<span class="string">'data'</span>, (data) =&gt; &#123;</span><br><span class="line">        arr.push(data)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    req.on(<span class="string">'end'</span>, ()=&gt;&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(Buffer.concat(arr).toString())</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">1234</span>, ()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'server is start...'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="12-设置-http-响应"><a href="#12-设置-http-响应" class="headerlink" title="12.设置 http 响应"></a>12.设置 http 响应</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = requrie(<span class="string">'http'</span>)</span><br><span class="line"><span class="keyword">const</span> server = http.createServer(<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'有请求进来了'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// res.end('test ok')</span></span><br><span class="line">    res.statusCode = <span class="number">302</span></span><br><span class="line">    res.setHeaders(<span class="string">'Content-type'</span>, <span class="string">'text/html;charset=utf-8'</span>)</span><br><span class="line">    res.end(<span class="string">'拉勾教育'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">1234</span>, ()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'server is start...'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="13-代理客户端"><a href="#13-代理客户端" class="headerlink" title="13.代理客户端"></a>13.代理客户端</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"><span class="keyword">const</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>)</span><br><span class="line"><span class="keyword">const</span> querystring = <span class="built_in">require</span>(<span class="string">'querystring'</span>)</span><br><span class="line"><span class="keyword">const</span> server = http.createServer(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// console.log('请求进来了')</span></span><br><span class="line">    <span class="keyword">let</span> &#123;pathname, query&#125; = url.parse(req.url)</span><br><span class="line">    <span class="built_in">console</span>.log(pathname,<span class="string">'-----'</span>,query)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// post</span></span><br><span class="line">    <span class="keyword">let</span> arr = []</span><br><span class="line">    req.on(<span class="string">'data'</span>, (data) =&gt; &#123;</span><br><span class="line">        arr.push(data)</span><br><span class="line">    &#125;)</span><br><span class="line">    req.on(<span class="string">'end'</span>,()=&gt;&#123;</span><br><span class="line">        <span class="keyword">let</span> obj = Buffer.concat(arr).toString()</span><br><span class="line">        <span class="comment">// console.log(Buffer.cancat(arr).toString())</span></span><br><span class="line">        <span class="comment">// console.log(req.headers['content-type'])</span></span><br><span class="line">        <span class="keyword">if</span>(req.headers[<span class="string">'content-type'</span>] === <span class="string">'application/json'</span>)&#123;</span><br><span class="line">            <span class="keyword">let</span> a = <span class="built_in">JSON</span>.parse(obj)</span><br><span class="line">            a.add = <span class="string">'互联网人的大学'</span></span><br><span class="line">            res.end(<span class="built_in">JSON</span>.stringify(a))</span><br><span class="line">            <span class="comment">// console.log(a)</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(req.headers[<span class="string">'content-type'</span>] === <span class="string">'application/x-www-form-urlencoded'</span>)&#123;</span><br><span class="line">            <span class="keyword">let</span> ret = querystring.parse(obj)</span><br><span class="line">            res.end(<span class="built_in">JSON</span>.stringify(ret))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">1234</span>, () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'server is running'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"><span class="keyword">let</span> options = &#123;</span><br><span class="line">    host: <span class="string">'localhost'</span>,</span><br><span class="line">    port: <span class="number">1234</span>,</span><br><span class="line">    path: <span class="string">'/?a=1'</span>,</span><br><span class="line">    method: <span class="string">'POST'</span>,</span><br><span class="line">    headers: &#123;</span><br><span class="line">        <span class="comment">// 'Content-type': 'application/json'</span></span><br><span class="line">        <span class="string">'Content-type'</span>: <span class="string">'application/x-www-form-urlencoded'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> req = http.request(options,()=&gt;&#123;</span><br><span class="line">    <span class="keyword">let</span> arr = []</span><br><span class="line">    res.on(<span class="string">'data'</span>, (data)=&gt;&#123;</span><br><span class="line">        arr.push(data)</span><br><span class="line">    &#125;)</span><br><span class="line">    res.on(<span class="string">'end'</span>, ()=&gt;&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(Buffer.concat(arr).toString())</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// req.end('拉勾教育')</span></span><br><span class="line"><span class="comment">// req.end('&#123;"name":"lg"&#125;')</span></span><br><span class="line">req.end(<span class="string">'a=1&amp;b=2'</span>)</span><br></pre></td></tr></table></figure>

<h3 id="14-代理客户端解决跨域"><a href="#14-代理客户端解决跨域" class="headerlink" title="14.代理客户端解决跨域"></a>14.代理客户端解决跨域</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = http.createServer(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// console.log('请求进来了')</span></span><br><span class="line">    <span class="keyword">let</span> arr = []</span><br><span class="line">    req.on(<span class="string">'data'</span>, (data)=&gt;&#123;</span><br><span class="line">        arr.push(data)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    req.on(<span class="string">'end'</span>, ()=&gt;&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(Buffer.concat(arr).toString())</span><br><span class="line">        res.end(<span class="string">'拿到了客户端的数据'</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">1234</span>, () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'server is start'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"><span class="keyword">let</span> options = &#123;</span><br><span class="line">    host: <span class="string">'localhost'</span>,</span><br><span class="line">    port: <span class="number">1234</span>,</span><br><span class="line">    path: <span class="string">'/'</span>,</span><br><span class="line">    method: <span class="string">'POST'</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> server = http.createServer(<span class="function">(<span class="params">request, reaponse</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> req = http.request(options,()=&gt;&#123;</span><br><span class="line">    <span class="keyword">let</span> arr = []</span><br><span class="line">    res.on(<span class="string">'data'</span>, (data)=&gt;&#123;</span><br><span class="line">        arr.push(data)</span><br><span class="line">    &#125;)</span><br><span class="line">    res.on(<span class="string">'end'</span>, ()=&gt;&#123;</span><br><span class="line">        <span class="comment">// console.log(Buffer.concat(arr).toString())</span></span><br><span class="line">        <span class="keyword">let</span> ret = Buffer.concat(arr).toString()</span><br><span class="line">        response.setHeaders(<span class="string">'Content-type'</span>,<span class="string">'text/html;charset=utf-8'</span>)</span><br><span class="line">        response.end(ret)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line">req.end(<span class="string">'拉勾教育'</span>)</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">2345</span>,()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'本地的服务器启动了'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="15-Http-静态服务"><a href="#15-Http-静态服务" class="headerlink" title="15.Http 静态服务"></a>15.Http 静态服务</h3><ul>
<li>npm install mime</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"><span class="keyword">const</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> mime = <span class="built_in">require</span>(<span class="string">'mime'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = http.createServer(<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> &#123;pathname,query&#125; = url.parse(req.url)</span><br><span class="line">    pathname = <span class="built_in">decodeURIComponent</span>(pathname)</span><br><span class="line">    <span class="keyword">let</span> absPath = path.join(_dirname,pathname)</span><br><span class="line">    fs.stat(absPath,(err,statObj)=&gt;&#123;</span><br><span class="line">        <span class="keyword">if</span>(err) &#123;</span><br><span class="line">            res.statusCode = <span class="number">404</span></span><br><span class="line">            res.end(<span class="string">'Not Found'</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(statObj.isFile()) &#123;</span><br><span class="line">            fs.readFile(absPath, (err, data) =&gt; &#123;</span><br><span class="line">                res.setHeaders(<span class="string">'Content-type'</span>,mime.getType(absPath)+<span class="string">';charset=utf-8'</span>)</span><br><span class="line">                res.end(data)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            fs.readFile(path.join(absPath,<span class="string">'index.html'</span>),(err,data)=&gt;&#123;</span><br><span class="line">                res.setHeaders(<span class="string">'Content-type'</span>,mime.getType(absPath)+<span class="string">';charset=utf-8'</span>)</span><br><span class="line">                res.end(data)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">1234</span>, ()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'server is start...'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="16-lgserve-命令行配置"><a href="#16-lgserve-命令行配置" class="headerlink" title="16.lgserve 命令行配置"></a>16.lgserve 命令行配置</h3><p>|-bin<br>  |-<a href="http://www.js" target="_blank" rel="noopener">www.js</a><br>|-main.js<br>|-package.json</p>
<ul>
<li>npm install commander</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// www.js</span></span><br><span class="line"><span class="keyword">const</span> &#123;program&#125; = <span class="built_in">require</span>(<span class="string">'commmander'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// program.option(-p --port, 'set server port')</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> options = &#123;</span><br><span class="line">    <span class="string">'-p --port &lt;dir&gt;'</span>: &#123;</span><br><span class="line">        <span class="string">'description'</span>: <span class="string">'init server port'</span>,</span><br><span class="line">        <span class="string">'example'</span>: <span class="string">'lgserve -p 3306'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'-d --directory &lt;dir&gt;'</span>: &#123;</span><br><span class="line">        <span class="string">'description'</span>: <span class="string">'init server directory'</span>,</span><br><span class="line">        <span class="string">'example'</span>: <span class="string">'lgserve -d c:'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">formatConfig</span>(<span class="params">configs, cb</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">Object</span>.entries(configs).forEach(<span class="function">(<span class="params">[key,val]</span>)=&gt;</span>&#123;</span><br><span class="line">        cb(key, val)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">formatConfig(options, (cmd,val) =&gt; &#123;</span><br><span class="line">    program.option(cmd,val,description)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">program.on(<span class="string">'--help'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Examples:'</span>)</span><br><span class="line">    formatConfig(options, (cmd, val) =&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(val.example)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">program.name(<span class="string">'lgserve'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> version = <span class="built_in">require</span>(<span class="string">'../package.json'</span>).version</span><br><span class="line">program.version(version)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> cmdConfig = program.parse(process.argv)</span><br><span class="line"><span class="built_in">console</span>.log(cmdConfig)</span><br></pre></td></tr></table></figure>

<h3 id="17-lgserve-启动web服务"><a href="#17-lgserve-启动web服务" class="headerlink" title="17.lgserve 启动web服务"></a>17.lgserve 启动web服务</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// www.js</span></span><br><span class="line"><span class="keyword">const</span> &#123;program&#125; = <span class="built_in">require</span>(<span class="string">'commmander'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// program.option(-p --port, 'set server port')</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> options = &#123;</span><br><span class="line">    <span class="string">'-p --port &lt;dir&gt;'</span>: &#123;</span><br><span class="line">        <span class="string">'description'</span>: <span class="string">'init server port'</span>,</span><br><span class="line">        <span class="string">'example'</span>: <span class="string">'lgserve -p 3306'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'-d --directory &lt;dir&gt;'</span>: &#123;</span><br><span class="line">        <span class="string">'description'</span>: <span class="string">'init server directory'</span>,</span><br><span class="line">        <span class="string">'example'</span>: <span class="string">'lgserve -d c:'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">formatConfig</span>(<span class="params">configs, cb</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">Object</span>.entries(configs).forEach(<span class="function">(<span class="params">[key,val]</span>)=&gt;</span>&#123;</span><br><span class="line">        cb(key, val)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">formatConfig(options, (cmd,val) =&gt; &#123;</span><br><span class="line">    program.option(cmd,val,description)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">program.on(<span class="string">'--help'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Examples:'</span>)</span><br><span class="line">    formatConfig(options, (cmd, val) =&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(val.example)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">program.name(<span class="string">'lgserve'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> version = <span class="built_in">require</span>(<span class="string">'../package.json'</span>).version</span><br><span class="line">program.version(version)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> cmdConfig = program.parse(process.argv)</span><br><span class="line"><span class="built_in">console</span>.log(cmdConfig)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> Server = rerquire(<span class="string">'../main.js'</span>)</span><br><span class="line"><span class="keyword">new</span> Serever(cmdConfig).start()</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.js</span></span><br><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mergeConfig</span>(<span class="params">config</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        port: <span class="number">1234</span>,</span><br><span class="line">        directory: process.cwd(),</span><br><span class="line">        ...config</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(config)&#123;</span><br><span class="line">       <span class="keyword">this</span>.config = mergeConfig(config)</span><br><span class="line">    &#125;</span><br><span class="line">    start()&#123;</span><br><span class="line">        <span class="keyword">let</span> server = http.createServer(<span class="keyword">this</span>.serverHandle.bind(<span class="keyword">this</span>))</span><br><span class="line">        server.listen(<span class="keyword">this</span>.config.port,()=&gt;&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'服务端已经启动了...'</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    serverHandle(req,res) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'有请求进来了'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = Server</span><br></pre></td></tr></table></figure>

<h3 id="18-lgserve-处理文件资源"><a href="#18-lgserve-处理文件资源" class="headerlink" title="18.lgserve 处理文件资源"></a>18.lgserve 处理文件资源</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.js</span></span><br><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"><span class="keyword">const</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>).promise</span><br><span class="line"><span class="keyword">const</span> &#123;createReadStream&#125; = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> mime = requrie(<span class="string">'mime'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mergeConfig</span>(<span class="params">config</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        port: <span class="number">1234</span>,</span><br><span class="line">        directory: process.cwd(),</span><br><span class="line">        ...config</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(config)&#123;</span><br><span class="line">       <span class="keyword">this</span>.config = mergeConfig(config)</span><br><span class="line">    &#125;</span><br><span class="line">    start()&#123;</span><br><span class="line">        <span class="keyword">let</span> server = http.createServer(<span class="keyword">this</span>.serverHandle.bind(<span class="keyword">this</span>))</span><br><span class="line">        server.listen(<span class="keyword">this</span>.config.port,()=&gt;&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'服务端已经启动了...'</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">async</span> serverHandle(req,res) &#123;</span><br><span class="line">        <span class="keyword">let</span> pathname = url.parse(req.url)</span><br><span class="line">        pathname = <span class="built_in">decodeURIComponent</span>(pathname)</span><br><span class="line">        <span class="keyword">let</span> abspath = path.join(<span class="keyword">this</span>.config.directory, pathname)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> statObj = <span class="keyword">await</span> fs.stat(abspath)</span><br><span class="line">            <span class="keyword">if</span>(statObj.isFile())&#123;</span><br><span class="line">                <span class="keyword">this</span>.fileHandle(req,res,abspath)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">            <span class="keyword">this</span>.errorHandle(req, res, err)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    errorHandle(req, res, err)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err)</span><br><span class="line">        res.statusCode = <span class="number">404</span></span><br><span class="line">        res.setHeader(<span class="string">'Content-type'</span>,<span class="string">'text/html;charset=utf-8'</span>)</span><br><span class="line">        res.end(<span class="string">'Not Found'</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fileHandle(req,res,abspath)&#123;</span><br><span class="line">        res.statusCode = <span class="number">200</span></span><br><span class="line">        res.setHeader(<span class="string">'Content-type'</span>,mime.getType(abspath) + <span class="string">';charset=utf-8'</span>)</span><br><span class="line">        createReadStream(abspath).pipe(res)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = Server</span><br></pre></td></tr></table></figure>

<h3 id="19-lgserve-处理目录资源"><a href="#19-lgserve-处理目录资源" class="headerlink" title="19.lgserve 处理目录资源"></a>19.lgserve 处理目录资源</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.js</span></span><br><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"><span class="keyword">const</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>).promise</span><br><span class="line"><span class="keyword">const</span> &#123;createReadStream&#125; = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> mime = requrie(<span class="string">'mime'</span>)</span><br><span class="line"><span class="keyword">const</span> ejs = <span class="built_in">require</span>(<span class="string">'ejs'</span>)</span><br><span class="line"><span class="keyword">const</span> &#123;promisify&#125; = <span class="built_in">require</span>(<span class="string">'url'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mergeConfig</span>(<span class="params">config</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        port: <span class="number">1234</span>,</span><br><span class="line">        directory: process.cwd(),</span><br><span class="line">        ...config</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(config)&#123;</span><br><span class="line">       <span class="keyword">this</span>.config = mergeConfig(config)</span><br><span class="line">    &#125;</span><br><span class="line">    start()&#123;</span><br><span class="line">        <span class="keyword">let</span> server = http.createServer(<span class="keyword">this</span>.serverHandle.bind(<span class="keyword">this</span>))</span><br><span class="line">        server.listen(<span class="keyword">this</span>.config.port,()=&gt;&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'服务端已经启动了...'</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">async</span> serverHandle(req,res) &#123;</span><br><span class="line">        <span class="keyword">let</span> pathname = url.parse(req.url)</span><br><span class="line">        pathname = <span class="built_in">decodeURIComponent</span>(pathname)</span><br><span class="line">        <span class="keyword">let</span> abspath = path.join(<span class="keyword">this</span>.config.directory, pathname)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> statObj = <span class="keyword">await</span> fs.stat(abspath)</span><br><span class="line">            <span class="keyword">if</span>(statObj.isFile())&#123;</span><br><span class="line">                <span class="keyword">this</span>.fileHandle(req,res,abspath)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> dirs = <span class="keyword">await</span> fs.readdir(abspath)</span><br><span class="line">                <span class="comment">// console.log(dirs)</span></span><br><span class="line">                <span class="keyword">let</span> renderFile = promisify(ejs.renderFile)</span><br><span class="line">                <span class="keyword">let</span> ret = <span class="keyword">await</span> renderFile(path.resolve(__dirname, <span class="string">'template.html'</span>),&#123;<span class="attr">arr</span>:dirs&#125;)</span><br><span class="line">                res.end(ret)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">            <span class="keyword">this</span>.errorHandle(req, res, err)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    errorHandle(req, res, err)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err)</span><br><span class="line">        res.statusCode = <span class="number">404</span></span><br><span class="line">        res.setHeader(<span class="string">'Content-type'</span>,<span class="string">'text/html;charset=utf-8'</span>)</span><br><span class="line">        res.end(<span class="string">'Not Found'</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fileHandle(req,res,abspath)&#123;</span><br><span class="line">        res.statusCode = <span class="number">200</span></span><br><span class="line">        res.setHeader(<span class="string">'Content-type'</span>,mime.getType(abspath) + <span class="string">';charset=utf-8'</span>)</span><br><span class="line">        createReadStream(abspath).pipe(res)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = Server</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    &lt;%for(let i = 0; i &lt; arr.length; i++)&#123;%&gt;</span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span><span class="tag">&lt;<span class="name">%=arr[i]%</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">%&#125;%</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="20-lgserve-模板数据渲染"><a href="#20-lgserve-模板数据渲染" class="headerlink" title="20.lgserve 模板数据渲染"></a>20.lgserve 模板数据渲染</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>IndexOf <span class="tag">&lt;<span class="name">%=title%</span>&gt;</span><span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">%if(parent)&#123;%</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&lt;%=parentpath%&gt;"</span>&gt;</span>上一层<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">%&#125;%</span>&gt;</span><span class="tag">&lt;<span class="name">%=arr[i].path%</span>&gt;</span></span><br><span class="line">    &lt;%for(let i = 0; i &lt; arr.length; i++)&#123;%&gt;</span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span><span class="tag">&lt;<span class="name">%=arr[i]%</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">%&#125;%</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.js</span></span><br><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"><span class="keyword">const</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>).promise</span><br><span class="line"><span class="keyword">const</span> &#123;createReadStream&#125; = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> mime = requrie(<span class="string">'mime'</span>)</span><br><span class="line"><span class="keyword">const</span> ejs = <span class="built_in">require</span>(<span class="string">'ejs'</span>)</span><br><span class="line"><span class="keyword">const</span> &#123;promisify&#125; = <span class="built_in">require</span>(<span class="string">'url'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mergeConfig</span>(<span class="params">config</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        port: <span class="number">1234</span>,</span><br><span class="line">        directory: process.cwd(),</span><br><span class="line">        ...config</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(config)&#123;</span><br><span class="line">       <span class="keyword">this</span>.config = mergeConfig(config)</span><br><span class="line">    &#125;</span><br><span class="line">    start()&#123;</span><br><span class="line">        <span class="keyword">let</span> server = http.createServer(<span class="keyword">this</span>.serverHandle.bind(<span class="keyword">this</span>))</span><br><span class="line">        server.listen(<span class="keyword">this</span>.config.port,()=&gt;&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'服务端已经启动了...'</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">async</span> serverHandle(req,res) &#123;</span><br><span class="line">        <span class="keyword">let</span> pathname = url.parse(req.url)</span><br><span class="line">        pathname = <span class="built_in">decodeURIComponent</span>(pathname)</span><br><span class="line">        <span class="keyword">let</span> abspath = path.join(<span class="keyword">this</span>.config.directory, pathname)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> statObj = <span class="keyword">await</span> fs.stat(abspath)</span><br><span class="line">            <span class="keyword">if</span>(statObj.isFile())&#123;</span><br><span class="line">                <span class="keyword">this</span>.fileHandle(req,res,abspath)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> dirs = <span class="keyword">await</span> fs.readdir(abspath)</span><br><span class="line">                <span class="comment">// console.log(dirs)</span></span><br><span class="line">                dirs = dirs.map(<span class="function">(<span class="params">item</span>)=&gt;</span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> &#123;</span><br><span class="line">                        path: path.join(pathname,item),</span><br><span class="line">                        dirs: item</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="keyword">let</span> renderFile = promisify(ejs.renderFile)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">let</span> parentpath = path.dirname(pathname)</span><br><span class="line">                <span class="keyword">let</span> ret = <span class="keyword">await</span> renderFile(path.resolve(__dirname, <span class="string">'template.html'</span>),</span><br><span class="line">                &#123;</span><br><span class="line">                    arr:dirs,</span><br><span class="line">                    parent: pathname === <span class="string">'/'</span> ? <span class="literal">false</span> : <span class="literal">true</span>,</span><br><span class="line">                    parentpath: parentpath,</span><br><span class="line">                    title: path.basename(abspath)</span><br><span class="line">                &#125;)</span><br><span class="line">                res.end(ret)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">            <span class="keyword">this</span>.errorHandle(req, res, err)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    errorHandle(req, res, err)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err)</span><br><span class="line">        res.statusCode = <span class="number">404</span></span><br><span class="line">        res.setHeader(<span class="string">'Content-type'</span>,<span class="string">'text/html;charset=utf-8'</span>)</span><br><span class="line">        res.end(<span class="string">'Not Found'</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fileHandle(req,res,abspath)&#123;</span><br><span class="line">        res.statusCode = <span class="number">200</span></span><br><span class="line">        res.setHeader(<span class="string">'Content-type'</span>,mime.getType(abspath) + <span class="string">';charset=utf-8'</span>)</span><br><span class="line">        createReadStream(abspath).pipe(res)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = Server</span><br></pre></td></tr></table></figure>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Node/" rel="tag"># Node</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/07/20/44/" rel="next" title="表达一些观点">
                <i class="fa fa-chevron-left"></i> 表达一些观点
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="FY" />
            
              <p class="site-author-name" itemprop="name">FY</p>
              <p class="site-description motion-element" itemprop="description">Just Be Yourself</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">46</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">15</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/xuanfeiyu" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Part-5-·-Node-js-全栈开发"><span class="nav-number">1.</span> <span class="nav-text">Part 5 · Node.js 全栈开发</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#模块一-·-Node-js-高级编程（核心模块、模块加载机制）"><span class="nav-number">1.1.</span> <span class="nav-text">模块一 · Node.js 高级编程（核心模块、模块加载机制）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#node-基础"><span class="nav-number">1.2.</span> <span class="nav-text">node 基础</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-课程概述"><span class="nav-number">1.2.1.</span> <span class="nav-text">1.课程概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Nodejs-架构"><span class="nav-number">1.2.2.</span> <span class="nav-text">2.Nodejs 架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-为什么是Nodejs"><span class="nav-number">1.2.3.</span> <span class="nav-text">3.为什么是Nodejs</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-Nodejs异步IO"><span class="nav-number">1.2.4.</span> <span class="nav-text">4.Nodejs异步IO</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-事件驱动架构"><span class="nav-number">1.2.5.</span> <span class="nav-text">5.事件驱动架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-Nodejs单线程"><span class="nav-number">1.2.6.</span> <span class="nav-text">6.Nodejs单线程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-Nodejs应用场景"><span class="nav-number">1.2.7.</span> <span class="nav-text">7.Nodejs应用场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-Nodejs实现API服务"><span class="nav-number">1.2.8.</span> <span class="nav-text">8.Nodejs实现API服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-Nodejs全局对象"><span class="nav-number">1.2.9.</span> <span class="nav-text">9.Nodejs全局对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-全局变量-process-1"><span class="nav-number">1.2.10.</span> <span class="nav-text">10.全局变量-process-1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-全局变量-process-2"><span class="nav-number">1.2.11.</span> <span class="nav-text">11.全局变量-process-2</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#模块二-·-核心模块"><span class="nav-number">1.3.</span> <span class="nav-text">模块二 · 核心模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-核心模块-path-1"><span class="nav-number">1.3.1.</span> <span class="nav-text">1.核心模块-path-1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-核心模块-path-2"><span class="nav-number">1.3.2.</span> <span class="nav-text">2.核心模块-path-2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-全局变量之Buffer"><span class="nav-number">1.3.3.</span> <span class="nav-text">3.全局变量之Buffer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-创建Buffer"><span class="nav-number">1.3.4.</span> <span class="nav-text">4.创建Buffer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-Buffer实例方法"><span class="nav-number">1.3.5.</span> <span class="nav-text">5.Buffer实例方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-Buffer静态方法"><span class="nav-number">1.3.6.</span> <span class="nav-text">6.Buffer静态方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-Buffer-split实现"><span class="nav-number">1.3.7.</span> <span class="nav-text">7.Buffer-split实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-核心模块之FS"><span class="nav-number">1.3.8.</span> <span class="nav-text">8.核心模块之FS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-文件操作API"><span class="nav-number">1.3.9.</span> <span class="nav-text">9.文件操作API</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-md转html实现"><span class="nav-number">1.3.10.</span> <span class="nav-text">10.md转html实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-文件打开与关闭"><span class="nav-number">1.3.11.</span> <span class="nav-text">11.文件打开与关闭</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-大文件读写操作"><span class="nav-number">1.3.12.</span> <span class="nav-text">12.大文件读写操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-文件拷贝自定义实现"><span class="nav-number">1.3.13.</span> <span class="nav-text">13.文件拷贝自定义实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-目录操作API"><span class="nav-number">1.3.14.</span> <span class="nav-text">14.目录操作API</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#15-目录创建之同步实现"><span class="nav-number">1.3.15.</span> <span class="nav-text">15.目录创建之同步实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#16-目录创建之异步实现"><span class="nav-number">1.3.16.</span> <span class="nav-text">16.目录创建之异步实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#17-目录删除之异步实现"><span class="nav-number">1.3.17.</span> <span class="nav-text">17.目录删除之异步实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#18-模块化历程"><span class="nav-number">1.3.18.</span> <span class="nav-text">18.模块化历程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#19-CommonJS规范"><span class="nav-number">1.3.19.</span> <span class="nav-text">19.CommonJS规范</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#20-Nodejs与CommonJS"><span class="nav-number">1.3.20.</span> <span class="nav-text">20.Nodejs与CommonJS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#21-模块分类及加载流程"><span class="nav-number">1.3.21.</span> <span class="nav-text">21.模块分类及加载流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#22-模块加载源码分析"><span class="nav-number">1.3.22.</span> <span class="nav-text">22.模块加载源码分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#23-VM模块使用"><span class="nav-number">1.3.23.</span> <span class="nav-text">23.VM模块使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#24-模块加载模拟实现-1"><span class="nav-number">1.3.24.</span> <span class="nav-text">24.模块加载模拟实现-1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#25-模块加载模拟实现-2"><span class="nav-number">1.3.25.</span> <span class="nav-text">25.模块加载模拟实现-2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#26-事件模块"><span class="nav-number">1.3.26.</span> <span class="nav-text">26.事件模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#27-发布订阅"><span class="nav-number">1.3.27.</span> <span class="nav-text">27.发布订阅</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#28-EventEmitter源码调试"><span class="nav-number">1.3.28.</span> <span class="nav-text">28.EventEmitter源码调试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#29-EventEmitter模拟"><span class="nav-number">1.3.29.</span> <span class="nav-text">29.EventEmitter模拟</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#30-浏览器中的事件环"><span class="nav-number">1.3.30.</span> <span class="nav-text">30.浏览器中的事件环</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#31-Nodejs中的事件环"><span class="nav-number">1.3.31.</span> <span class="nav-text">31.Nodejs中的事件环</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#32-Nodejs事件环理解"><span class="nav-number">1.3.32.</span> <span class="nav-text">32.Nodejs事件环理解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#33-Nodejs与浏览器事件环区别"><span class="nav-number">1.3.33.</span> <span class="nav-text">33.Nodejs与浏览器事件环区别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#34-Nodejs事件环常见问题"><span class="nav-number">1.3.34.</span> <span class="nav-text">34.Nodejs事件环常见问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#35-核心模块之stream"><span class="nav-number">1.3.35.</span> <span class="nav-text">35.核心模块之stream</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#36-stream之可读流"><span class="nav-number">1.3.36.</span> <span class="nav-text">36.stream之可读流</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#37-stream之可写流"><span class="nav-number">1.3.37.</span> <span class="nav-text">37.stream之可写流</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#38-stream之双工和转换流"><span class="nav-number">1.3.38.</span> <span class="nav-text">38.stream之双工和转换流</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#39-文件可读流创建和消费"><span class="nav-number">1.3.39.</span> <span class="nav-text">39.文件可读流创建和消费</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#40-文件可读流事件与应用"><span class="nav-number">1.3.40.</span> <span class="nav-text">40.文件可读流事件与应用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#41-文件可写流"><span class="nav-number">1.3.41.</span> <span class="nav-text">41.文件可写流</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#42-write执行流程"><span class="nav-number">1.3.42.</span> <span class="nav-text">42.write执行流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#43-控制写入速度"><span class="nav-number">1.3.43.</span> <span class="nav-text">43.控制写入速度</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#44-背压机制"><span class="nav-number">1.3.44.</span> <span class="nav-text">44.背压机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#45-模拟文件可读流01"><span class="nav-number">1.3.45.</span> <span class="nav-text">45.模拟文件可读流01</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#46-模拟文件可读流02"><span class="nav-number">1.3.46.</span> <span class="nav-text">46.模拟文件可读流02</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#47-模拟文件可读流03"><span class="nav-number">1.3.47.</span> <span class="nav-text">47.模拟文件可读流03</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#48-链表结构"><span class="nav-number">1.3.48.</span> <span class="nav-text">48.链表结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#49-单向链表实现-1"><span class="nav-number">1.3.49.</span> <span class="nav-text">49.单向链表实现-1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#50-单向链表实现-2"><span class="nav-number">1.3.50.</span> <span class="nav-text">50.单向链表实现-2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#51-单向链表实现-3"><span class="nav-number">1.3.51.</span> <span class="nav-text">51.单向链表实现-3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#52-单向链表实现队列"><span class="nav-number">1.3.52.</span> <span class="nav-text">52.单向链表实现队列</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#53-文件可写流实现-1"><span class="nav-number">1.3.53.</span> <span class="nav-text">53.文件可写流实现-1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#54-文件可写流实现-2"><span class="nav-number">1.3.54.</span> <span class="nav-text">54.文件可写流实现-2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#55-文件可写流实现-3"><span class="nav-number">1.3.55.</span> <span class="nav-text">55.文件可写流实现-3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#56-pipe方法使用"><span class="nav-number">1.3.56.</span> <span class="nav-text">56.pipe方法使用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#模块三-·-通信"><span class="nav-number">1.4.</span> <span class="nav-text">模块三 · 通信</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-通信基本原理"><span class="nav-number">1.4.1.</span> <span class="nav-text">1.通信基本原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-网络通讯方式"><span class="nav-number">1.4.2.</span> <span class="nav-text">2.网络通讯方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-网络层次模型"><span class="nav-number">1.4.3.</span> <span class="nav-text">3.网络层次模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-数据封装与解封装"><span class="nav-number">1.4.4.</span> <span class="nav-text">4.数据封装与解封装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-TCP三次握手与四次挥手"><span class="nav-number">1.4.5.</span> <span class="nav-text">5.TCP三次握手与四次挥手</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-创建TCP通信"><span class="nav-number">1.4.6.</span> <span class="nav-text">6.创建TCP通信</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-TCP粘包及解决"><span class="nav-number">1.4.7.</span> <span class="nav-text">7.TCP粘包及解决</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-封包拆包实现"><span class="nav-number">1.4.8.</span> <span class="nav-text">8.封包拆包实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-封包解决粘包"><span class="nav-number">1.4.9.</span> <span class="nav-text">9.封包解决粘包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-http-协议"><span class="nav-number">1.4.10.</span> <span class="nav-text">10.http 协议</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-获取-http-请求信息"><span class="nav-number">1.4.11.</span> <span class="nav-text">11.获取 http 请求信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-设置-http-响应"><span class="nav-number">1.4.12.</span> <span class="nav-text">12.设置 http 响应</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-代理客户端"><span class="nav-number">1.4.13.</span> <span class="nav-text">13.代理客户端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-代理客户端解决跨域"><span class="nav-number">1.4.14.</span> <span class="nav-text">14.代理客户端解决跨域</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#15-Http-静态服务"><span class="nav-number">1.4.15.</span> <span class="nav-text">15.Http 静态服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#16-lgserve-命令行配置"><span class="nav-number">1.4.16.</span> <span class="nav-text">16.lgserve 命令行配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#17-lgserve-启动web服务"><span class="nav-number">1.4.17.</span> <span class="nav-text">17.lgserve 启动web服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#18-lgserve-处理文件资源"><span class="nav-number">1.4.18.</span> <span class="nav-text">18.lgserve 处理文件资源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#19-lgserve-处理目录资源"><span class="nav-number">1.4.19.</span> <span class="nav-text">19.lgserve 处理目录资源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#20-lgserve-模板数据渲染"><span class="nav-number">1.4.20.</span> <span class="nav-text">20.lgserve 模板数据渲染</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">FY</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
